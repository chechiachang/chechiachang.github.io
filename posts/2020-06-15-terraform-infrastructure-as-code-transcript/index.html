<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform Infrastructure as Code Transcript | Che-Chia Chang</title><meta name=keywords content="kubernetes,terraform,devops,iac"><meta name=description content="This article is part of 從零開始的 Infrastructu as Code: Terraform

Get-started examples / SOP on Github
Introducation to Terraform Iac: Speaker transcript
Presentation

Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)

各位好
About this presentation
開始之前，先分享一些資源

投影片
講稿
程式碼
SOP 範本
Facebook 粉專

都放在這裡，因為有附逐字稿，所以如果很忙的朋友，掃了 QR code 就可以回家自己看了，不用客氣。
然後有興趣在追這系列文章的，可以幫我 facebook 粉專按個讚跟追蹤，每周新文章出來，會推播通知。
文章在 chechia.net 上，新文章通知靠 facebook 粉專這樣。也可以只追蹤不按讚。我自己看別人技術 blog 也很常這樣(XD
需求
好，今天來講得這個 Terraform"><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Terraform Infrastructure as Code Transcript"><meta property="og:description" content="This article is part of 從零開始的 Infrastructu as Code: Terraform
Get-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)
各位好
About this presentation 開始之前，先分享一些資源
投影片 講稿 程式碼 SOP 範本 Facebook 粉專 都放在這裡，因為有附逐字稿，所以如果很忙的朋友，掃了 QR code 就可以回家自己看了，不用客氣。
然後有興趣在追這系列文章的，可以幫我 facebook 粉專按個讚跟追蹤，每周新文章出來，會推播通知。
文章在 chechia.net 上，新文章通知靠 facebook 粉專這樣。也可以只追蹤不按讚。我自己看別人技術 blog 也很常這樣(XD
需求 好，今天來講得這個 Terraform"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-15T10:58:56+08:00"><meta property="article:modified_time" content="2020-07-15T10:58:56+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Devops"><meta property="article:tag" content="Iac"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Terraform Infrastructure as Code Transcript"><meta name=twitter:description content="This article is part of 從零開始的 Infrastructu as Code: Terraform

Get-started examples / SOP on Github
Introducation to Terraform Iac: Speaker transcript
Presentation

Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)

各位好
About this presentation
開始之前，先分享一些資源

投影片
講稿
程式碼
SOP 範本
Facebook 粉專

都放在這裡，因為有附逐字稿，所以如果很忙的朋友，掃了 QR code 就可以回家自己看了，不用客氣。
然後有興趣在追這系列文章的，可以幫我 facebook 粉專按個讚跟追蹤，每周新文章出來，會推播通知。
文章在 chechia.net 上，新文章通知靠 facebook 粉專這樣。也可以只追蹤不按讚。我自己看別人技術 blog 也很常這樣(XD
需求
好，今天來講得這個 Terraform"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Terraform Infrastructure as Code Transcript","item":"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform Infrastructure as Code Transcript","name":"Terraform Infrastructure as Code Transcript","description":"This article is part of 從零開始的 Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\n各位好\nAbout this presentation 開始之前，先分享一些資源\n投影片 講稿 程式碼 SOP 範本 Facebook 粉專 都放在這裡，因為有附逐字稿，所以如果很忙的朋友，掃了 QR code 就可以回家自己看了，不用客氣。\n然後有興趣在追這系列文章的，可以幫我 facebook 粉專按個讚跟追蹤，每周新文章出來，會推播通知。\n文章在 chechia.net 上，新文章通知靠 facebook 粉專這樣。也可以只追蹤不按讚。我自己看別人技術 blog 也很常這樣(XD\n需求 好，今天來講得這個 Terraform\n","keywords":["kubernetes","terraform","devops","iac"],"articleBody":"This article is part of 從零開始的 Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\n各位好\nAbout this presentation 開始之前，先分享一些資源\n投影片 講稿 程式碼 SOP 範本 Facebook 粉專 都放在這裡，因為有附逐字稿，所以如果很忙的朋友，掃了 QR code 就可以回家自己看了，不用客氣。\n然後有興趣在追這系列文章的，可以幫我 facebook 粉專按個讚跟追蹤，每周新文章出來，會推播通知。\n文章在 chechia.net 上，新文章通知靠 facebook 粉專這樣。也可以只追蹤不按讚。我自己看別人技術 blog 也很常這樣(XD\n需求 好，今天來講得這個 Terraform\n我會實際分享我們公司為雲團隊導入的經驗，前半部會有點像購物頻道的廣告\n以下的對話是不是常出現在日常工作中？\n以下這段對話很耳熟？ 「是誰改了這個設定？」\nby 週一上班的 DevOps 與週六值班的維運團隊 對啟用的環境的掌握如何 環境的變更能否永久保存 「這個環境怎麼少一個設定？」\n網站噴錯後，整個團隊一步步釐清問題，不是 code，不是變數config，是 infra 有一個小地方沒設定 環境複雜，以我們的例子是複雜得多雲網路，常出這種問題 環境設定的除錯很費時 完全可以避免 「會動就好，沒事不要改環境（抖）」\nLegacy site 調整 production 環境是否有信心 我們看不慣無人整理的舊架構，導入 terraform 後，（很不要命的）把 production site 搬過一遍 我有十成的信心跟你說新舊兩個 site 完全一樣 Our stories 我們是思華科技(ＸＤ) 開發團隊大概 100+ 個左右 專案很多，而且老闆很喜歡開新專案測試商業模型 環境也越開越多，大大小小幾百台 vm，幾十個資料庫，都是不同專案在跑，規模大概這樣 每週都有新環境要交付 交接缺口 我們公司東西多，但東西多不是問題，問題是什麼呢?\n問題 手動部屬本來不是問題，但漸漸成為問題 開 infrastructure 的方法，跟著 SOP 上去 GCP GUI 介面，點一點，填一填。公有雲開機器很方便。 可是不同人開的環境漸漸出現一些不同，可能差一個設定、一個參數、或是命名規則差一點。這些細節的不同，差一個 config 有時候就會雷到人。「這機器誰建的阿，根本有問題啊」，而且這種雷很多時候都是跑下去出事了，才發現「阿靠原來設定不一樣」 命名差一點不影響功能，但看久了就很煩，「阿就對不齊阿」，有強迫症就很痛苦。然後你維運的自動化腳本就爆掉，命名差一個字，regex 就要大改。突然增加維運成本 生產環境大家都不太敢動。架構調整很沒信心 誰知道當初環境設定了那些東西，開機器的人離職了，也不知道他為啥設定，「你知道他當初為什麼要設定這個嗎?」，你問我我是要去擲茭喔。 我們這一季把所有現有環境都搬到新的架構上，因為我們對舊架構不爽很久了(XD)，這個能做到當然有作法，後面細講 有實際需求才找解決方案，沒有需求就不用衝動導入新技術，導入過程中還是蠻累的\n需求 從維運的角度，需求大概長這樣\n提升穩定度\ninfra 交付標準化 交付自動化 測試環境 infra 提交要能夠 review\n提升效率\n老闆要的。超快部屬，腳本跑下去要快，還要更快 次要目標\n成本，效能最佳化，希望能在整理過程中，找到最適合的可行架構 新人好上手，Junior 同事也能「安全」的操作，看到這個安全兩個字了嗎? 安全第一，在訓練新的 op 時要注意安全，不然他上去 GUI 點一點，一個手起刀落 DB 就不見了，整個維運團隊一周不用睡覺。安全第一吼。 權限控管，IAM 也用 terraform 管理，權限管理人多手雜越用越亂，可以考慮使用 IaC，一覽無遺 Programatical approach for infra 啊不就是 Infrastructure as code XD\n導入前，大家都有聽過，大家都覺得很想導入，但沒人有經驗，每個人都超怕，但又不知道在怕三小 這表明了一件事，大家都知道要做對的事情，但不是每個人都能改變現況，讓團隊導向對的事情 計畫\n確定需求 開始 survey 「小心」導入 有經驗領頭羊很棒，但不是必須 技術細節 先簡單講一下 IaC (Yeah 終於要講技術了)\nIaC 上面都講概念跟心法，現在實際講用到的技術。\n首先是 Infrastructure as Code，這個概念很久了，但導入的公司好像不是那麼多。所以我今天要來傳教，洗腦大家(XD，跟你推薦這個配方保證快又有效(XD)\n簡單來說就是用程式來操作 infrastructure，今天主講的 terraform 是 IaC 工具中的一個 IaC 工具可以是宣告式，或是命令式，或是兩種都支援 一個是我告訴你結果，步驟我不管，請你幫我生出這樣的結果。 一個是我告訴你步驟，你一步一步幫我做完，就會得到我要的結果 terraform 是宣告式，說明邏輯跟結果，例如我要 1 2 3 台機器，terraform 自己去幫我打 Google API 這樣，把機器生出來 ansible 是命令式，我把步驟寫成一堆命令腳本 playbook ，ansible 幫我照著跑下去，理論上跑完後我的機器也準備好 Terraform 官網在這邊，自己看 https://www.terraform.io/ 宣告式的 Iac 工具 單一語法描述各家 API 透過 provider 轉換 tf 成為 API call Terraform Core Workflow https://www.terraform.io/guides/core-workflow.html\nWrite 撰寫期待狀態 tf file plan 計畫試算結果 apply 用期待狀態去更新遠端 tf file，就是宣告式的表達 infra ，描述期待的infra長這樣，ex. tf file 裡有這些機器 1 2 3 台這樣 resource 一個一個物件描述，後面可能是對映 provider 的 API Endpoint (ex. GCP GKE API) remote resources，是真實存在遠端的機器，例如 GCP 雲端實際上只有 1 2 兩台這樣。 terraform diff tf vs remote，算出 plan，少的生出來，多的上去砍掉 Demo 1 (empty project)\nadd my-gce.tf\ngit diff\nstate\ncheck GUI remote\nexisting my-gce\nremove my-gce.tf\nplan\n這邊不 apply 我 demo 還要用\n這邊這樣有理解 terraform 的基本流程嗎？編寫，計畫，apply 三步驟 很單純 然後講一點細節\nstate\nremove (out of scope)\nplan -\u003e addd\napply (deplicated ID)\nmv state (Danger)\nrename state with the same ID -\u003e destroy and recreate (Danger)\nState terraform 經手(apply) 過的 resource 會納入 state (scope)\n不在 scope 裡的 resource 不會納入 plan，不會被 destroy，但可能會 create duplicated ID\nterraform 允許直接操作 state\nimport remove 但我不允許XD 注意是 diff state 喔，所以每次 plan 時候會自動 refresh state\nstate 又是什麼? remote 是一個動態環境，可能會多會少，這樣沒辦法 diff，state 是把我執行當下，遠端相關資源的狀態快照存起來，然後根據這個 snapshop 去 diff\napply 只是拿你的期待去 diff state，terraform 幫你算出來差多少，例如我們這邊就是遠端少一台。terraform 透過 provider 去知道，喔這一台要去打那些 GCP API，把這台生出來。\nState，是核心概念，我當初自己卡觀念是卡這邊，所以我特別拉出來講\n雲端空蕩蕩，refresh state 也是空的，tf file 多加一個 VM，plan 覺得要 create 雲端有東西，refresh state 未必會 refresh 到 相同 ID 的資源之前 import 在 state 中，refresh state，tf file 沒東西，plan 覺得要 destroy 相同 ID 的資源不在 state 中，這些 resource 不在當前 state 的 scopor 中，refresh state 是空的，tf file 沒東西，plan 覺得沒增沒減 相同 ID 的資源不在 state 中，這些 resource 不在當前 state 的 scopor 中，refresh state 是空的，tf file 有相同 ID 的資源，plan 覺得要 create，但實際 apply，API error 遠端已經有相同 ID 的資源存在 小結 Write -\u003e Plan -\u003e Apply State 大家都會 terraform 惹 初步使用感想 IaC 地端跟雲端都能做，但雲端做起來效果超級好 完全展現雲端運算的特性，迅速、彈性、隨用隨叫，調度大量的虛擬化資源 新增東西很快，不要的資源，要刪掉也很快 不小心刪錯也很快(大誤)，所以我說新人一個手起刀落公司整個雲弄不見也是有可能的，「啊我的雲勒」「被 terraform 砍了」。不要笑，那個新人就是我，我自己剛學的時候就有把整個 db 變不見過，差點一到職就引咎辭職(XD。用這些技術還是有很多安全要注意，稍後會細講注意的安全事項。 總之，Iac 就是用程式化的語法，精準的描述雲端的狀態或是步驟，完全沒有模糊的地帶。帶來的好處，降低維運的錯誤風險，加快維運效率，最佳化節省成本。\n新手 state 的雷 多人協作，同時變更 state 會造成不可預期的錯誤 避免直接操作 state state 可能有 sensitive 資料 推薦使用外部帶有 lock 的 state storage 導入 導入工具之後 新工具導入時要做好風險評估，每個人都是第一次用 terraform ，用起來很快很爽的同時也要不斷宣導安全概念，雷在哪裡坑在哪裡。\n使用 terraform 的風險\n打 DELET API 超快，砍起來很方便，但很多時候方便 = 危險。眼看小明一個手起刀落，談笑間，公有雲灰飛煙滅(XD，通通變不見。現在在講故事很開心，實際發生的話大家都笑不出來，全公司 RD 都跑來維運部門排隊盯著你看，就算修好也要懲處。壓力超大。但小明砍錯東西不是小明的錯，是大環境的錯是 SOP 的錯(XD。認真的，團隊沒有提供 SOP，新人砍錯東西當然是團隊負責。所以我們 SOP 第一行就寫得很清楚。 看見 destroy 就雙手離開鍵盤，直接求救，這樣還能出事嗎 再來，給予特殊的 IAM 權限，例如只能新增不能刪除的權限 進一步導入 git-flow，push、review、PR，讓他連犯錯的機會都沒有 根本還是要給予新人足夠的訓練，然後同時保障公司安全。 給新人過大權限砍錯東西，或是工作流程一堆坑，根本是在誘導新人犯錯，團隊的資深成員要檢討。 逐漸導入 導入的過程不斷檢討跟修改，最後找出適合我們公司的流程 檢討透明，有錯就修 SOP，修工作流程。讓你的工作流程跟工作環境，固若金湯，成員很難在裡面犯錯，這才是 DevOps 在做這的事。 官方建議的最佳實作 https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html 至於我們是如何逐漸導入 IaC 到公司的開發流程中？具體的導入步驟如下 Introduction: IaC 舊架構保存。先把雲端上已經有的機器，terraform 裡面叫資源，import 成代碼 檢查舊架構。所有設定都變成代碼了，跟你看程式碼一樣，一拍兩瞪眼沒有任何模稜兩可。整理過程中找出合理跟不合理的設定。有可能會發現一些雷，只是還沒爆炸，也趁機修一修。 然後，依照這些現行的資源，去整理一份適合公司的環境範本，之後所有的新環境都這這個範本部屬，確定新的環境都有合理的規劃。 到此，所有新環境都是同一份範本生出來的，環境已經標準化了。不會再有零碎的小錯誤。聽起來超讚，但有時候出錯就是一起全錯，超慘(XD。當然有錯就修範本，修 SOP。同樣的錯永不再犯，不用再修第二次。 Introduction: Git-flow 然後，導入版本控管，整合 git-flow 的開發流程。寫 SOP，之後所有變更都要 先把 master 封起來，所有人都不准直接改架構 開新 branch，commit 開 PR 大家 review，大家都看過了吼，再 merge 進去，這樣有錯就不是一個人的鍋而是大家一起背鍋(XD。不是拉，review 能大幅降低錯誤，分享團隊經驗加速新人訓練，並且讓所有人 on the same page，不會再有「阿靠這機器誰開的」有人不知情的事情。 永遠只使用 master 來部屬雲端資源，也是確定所有架構都經過多人 review。 Introduction: Pipeline Automation 最後，整合 CICD，讓架構的部屬完全自動化。把人工降到最低，同時也把人工錯誤的機率降到最低，當然這個也是沒錯都沒錯，要錯一起錯的狀態(XD，使用時還是要注意。但如果執行的很穩定的話，自動化絕對是值得投資的。因為現在把架構當作產品做，部屬完要測試功能，網路設定是否正確，監控是否完整，proxy 是不是要打看看。這些都整合進 infra 自動 pipeline。部屬完就是測試，然後交付給其他團隊。 之後就是不斷調整 SOP，跟 CI/CD pipeline。把維運步驟轉成程式維護。 犯錯過一次，永不再犯。這個對於長期團隊經營非常重要，讓經驗跟知識累積，團隊質量才會成長。IaC 在這點幫助很大。\nDemo 2 NAME=terraform-devops make gke redis sql module git commit Review on github Merge request Repo 我使用的原碼都開源在 github 上，因為是真的拿來導入我們公司的架構，保證可以用。阿不能用的話，幫我發 issue 給我，或是你人更好發個 PR 給我都可以(XD。把 repo 拉下來，這邊有 gcp / azure / aws，雖然有三個但我們公司主要是用 gcp，剩下兩個我自己做興趣的。裡面 templates 跟 modules ，但你不用管，我 makefile 都寫好了\n我這邊要新增一個 kubernetes 集群 我直接進來我的專案， NAME=my-new-k8s make gke，東西就生出來，具體做的事情就是新增兩個程式區塊，每個區塊描述一個機器 git diff 看多了什麼，這邊多一個 k8s 跟多一個 node-pool 然後我 plan，讓 terraform 預測一下試跑結果，我們依據結果好好 review，例如這邊 2 to add 0 to destroy 我的想像是不是真的跟 terraform 計畫一樣。 然後 terraform apply，這邊要看清楚，我們是 2 to add 0 to destroy，如果看到有 destroy 就要雙手離開鍵盤，大家不要衝動，看清楚，因為她真的會上去把東西砍掉 P.S. 專案可以按照公司需求分，資源太多太擠就拆分成幾個資料夾好管理，然後分權責管理，例如館 iam 的、管網路、管應用機器的可以分開來\nGit-flow 然後因為我後面會講 git-flow 工作流程整合，所以我順便做完。\n新的變更 commit ，plan 但是還沒 apply。我要求所有新的 commit 推上去 發 PR，其他團隊成員來幫我 review。PR 用的 template ，描述一下新架構的目的，變更的地方，有沒有雷，然後幾個 checklist 檢查 其他隊員 review 都 lgtm 才 merge 回 master apply 永遠在最新的 master 上 apply，確保所有推到雲端的架構都是多人 review 過的。 有 review 才有品質可言，code 都要 review，infra 自然也需要 review。IaC + git-flow 是必要的。\nDemo 2 工具 + 流程 導入的成功與否，不是最佳實踐，而是各個階段，都給予團隊適合的挑戰與協助\nGit-flow SOP 範例 中文版，超長，上面操作過了，這邊不細講，大家自己上去看 但如果團隊是第一次導入 terraform，我強烈建議要有類似的東西 Provide template demo 時不是有 makefile，makefile 裡面寫的小腳本跟本身 IaC 沒有關係，提供一些而外的小腳本輔助，可以進一步降低人工操作，提升效率，又增加安全。工具不一定完全適合團隊吧，這時候就需要補足團隊文化跟工具間的落差，潤滑一下。\n再說一次，新人做錯，不是他做錯，而是團隊沒有提供他足夠的協助。如何讓新人也能有高產出同時又顧及安全，資深工程師是這邊在資深。提供一些一用性工具是必要的。\nTerraform module 又是一個 terraform 的功能\n簡單來說，GKE 也許定義了 2 個子物件(ex. Cluster，Node-pool)，總共有 30 個參數\n你其實不需要那麼多參數 XD 建立一個 my-gke-module，一個物件，5 個必填參數，5 個有預設值的選填參數 也許寫錯的機會只剩 5 個，也許工時只需要 5/30 需求變更就改 module，讓你的操作物件本身就是符合實際需求的 能手動改的地方就是能犯錯的地方，黑箱封裝可以保護整體架構，並提高易用性\n雜項 其他 上面是 IaC 在我們公司的流程 我們選 terraformㄨ 如果是用 terraform 以外的工具，可以參考流程，也許殊途同歸 https://www.terraform.io/intro/vs/index.html\n優缺點 好，跟團隊一步一步溝通改進，花了一兩個月，成功導入。是否有解決當初的問題？\n降低人工操作\n避免人工失誤 infra 交付標準化，沒有奇怪的設定，再也沒有「啊我機器開錯了」這回事 快，真低快。開一個機器就是我剛剛 demo 這樣，而且保證會動。這樣開出來的機器，對她超有信心，要複製完全一模一樣的環境也超有信心。如果再加上自動化測試就更敢保證。 準確\n大家都 review 過，比較不會有「啊我當時沒想到」的狀況，infra 出這種萬萬沒想到的問題，很有機率要幹掉重來。菜鳥跟著 review ，試著發 PR，這樣新人訓練才會有效率，他之後才能自己操作，資深工程師只要 review 就好。要給新人足夠的訓練，又要顧慮安全， review 花的時間非常值得。 保證開發、測試、staging、production 環境長的一模一樣。terraform 程式保證的不是我保證的(XD)。但他的保證是有根據的，讓團隊從開發到上限保重相同環境。「阿在我的機器上會跑怎麼上 production 就壞掉」不好意思沒這回事，壞掉就是你扣寫錯(兇。認真地說，排除一些 infra 的問題，可以大幅增加除錯的效率，只要檢查還沒自動化的地方就好。 自動化測試，扣要測試環境也要測試，這邊直接整進去，環境交出去保證是好的 生產環境變動\n因為已經轉成程式碼，要有什麼改動都很精確，大家也比較敢動環境，特別是 production 環境。再來因為保留所有環境產生的程式碼，要複製環境也很容易，而且有信心保證一樣。我們就把就架構的 production 複製，然後搬家。安全下庄沒出事。後面就搬上癮，整個公司服務大搬家，搬成團隊理想的架構。搬家已經上線的服務，這個需要多少信心跟勇氣你們知道嗎，維運真的是愛與勇氣的冒險。新架構我們也很滿意。 自動化\n自動化就是讓你用零倍的時間做十倍的事情嘛。聽起來怪怪的蛋是是真的。 因為我們目標是維運躺著上班嘛(XD)，我們才能把時間拿去做改進，不然以光是開機器，測試環境可用性，維運就飽了，根本沒時間改進跟提升。這樣對公司長期非常不好。 可讀性\nGUI 沒辦法打 comment 阿，誰知道這個機器當初為什是這個設定。IaC 後到處都可以寫 comment，怕你不寫而已。然後 code 的表達性還是很強大，比起 GUI，資深工程師可以把握整個公司的架構狀況，比起去雲平台下一堆搜索，手動比對，程式碼的可維護性真的超高。而 GCP 已經是 GUI 做得很好的公有雲了。 降低人工，快速，準確，自動化，有信心\nQ\u0026A 還有空我們再來講 terraform 的細節\n有事歡迎透過粉專私敲，因為我也需要人討論\n還有時間再聊 terraform validate 既然是 code，這邊幫你做 lint、語法檢測、type check，過濾第一層錯誤 import 可以把遠端的資源匯入成 state，一個點讚 follow 追蹤的概念(XD)，不是所有的遠端資源都需要追蹤到 state，我們只需要在對的 scope 裡面關注需要的機器 module 可以自由撰寫，把有相依性的資源打包，依照團隊使用習慣調整使用 cloud 可以管理 state，terraform cloud 幫你維護全域同一份 state，有人在使用時會 lock state，避免多人同時修改，打亂 API 造成資源錯誤 state conflicts 如果有多份 state，你電腦上一份 local state，我電腦上一份 local state，其實會造成衝突 更怕同時多人憶起 apply，GCP API 直接被打亂，會有不可預期的錯誤 解法是使用 terraform remote backend，不要用 local state，使用 DB 、storage 或是 terraform cloud，透過一隻 lock 來保證 synchronized state 間接理解 API ex. GCP Load Balancer\n這個講下去就太多了，基本上透過爬 terraform google provider 的文件，然後去比對\n因為去點 GUI 其實感受不到 GCP API 的調用，但是使用 terraform 轉寫資源時候就很有感，打這個 API 跟打這個 API，tf 檔案上其實看得出來。 進一步去查，才發現 GCP Load Balancer 內網或外網、http 或 tcp、全球或區域，使用的 Load Balancer 行為不一樣，因為底下的實作不一樣。但之前使用 GUI 時其實不會去想為啥設定不一樣，使用 terraform 就會被迫去了解，強迫學習XD。 垃圾話 最佳實踐不是問題 ，如何導入才是問題 可以不用躺著上班，但是不能跪著上班 願意多幾個人來看我粉專比較實在 ","wordCount":"915","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2020-06-15T10:58:56+08:00","dateModified":"2020-07-15T10:58:56+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=categories><span>categories</span></a></li><li><a href=https://chechia.net/tags/ title=tags><span>tags</span></a></li><li><a href=https://chechia.net/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Terraform Infrastructure as Code Transcript</h1><div class=post-meta><span title='2020-06-15 10:58:56 +0800 CST'>June 15, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;915 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2020-06-15-terraform-infrastructure-as-code-transcript.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#需求>需求</a></li></ul><ul><li><a href=#技術細節>技術細節</a></li></ul><ul><li><a href=#terraform>Terraform</a></li></ul><ul><li><a href=#導入>導入</a></li></ul><ul><li><a href=#demo-2>Demo 2</a></li></ul><ul><li><a href=#雜項>雜項</a></li></ul><ul><li><a href=#qa>Q&amp;A</a></li><li><a href=#還有時間再聊>還有時間再聊</a></li></ul></nav></div></details></div><div class=post-content><p>This article is part of <a href=https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/>從零開始的 Infrastructu as Code: Terraform</a></p><ul><li><a href=https://github.com/chechiachang/terraform-playground>Get-started examples / SOP on Github</a></li><li><a href=https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/>Introducation to Terraform Iac: Speaker transcript</a></li><li><a href=https://slides.com/chechiachang/terraform-introduction/edit>Presentation</a></li></ul><p>Check my website <a href=https://chechia.net>chechia.net</a> for other blog. <a href=https://www.facebook.com/engineer.from.scratch>Follow my page to get notification</a>. Like my page if you really like it :)</p><hr><p>各位好</p><h1 id=about-this-presentation>About this presentation<a hidden class=anchor aria-hidden=true href=#about-this-presentation>#</a></h1><p>開始之前，先分享一些資源</p><ul><li><a href=https://slides.com/chechiachang/terraform-introduction/edit>投影片</a></li><li><a href=https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/>講稿</a></li><li><a href=https://github.com/chechiachang/terraform-playground>程式碼</a></li><li><a href=https://github.com/chechiachang/terraform-playground/blob/master/SOP.md>SOP 範本</a></li><li><a href=https://www.facebook.com/engineer.from.scratch/>Facebook 粉專</a></li></ul><p>都放在這裡，因為有附逐字稿，所以如果很忙的朋友，掃了 QR code 就可以回家自己看了，不用客氣。</p><p>然後有興趣在追這系列文章的，可以幫我 facebook 粉專按個讚跟追蹤，每周新文章出來，會推播通知。</p><p>文章在 chechia.net 上，新文章通知靠 facebook 粉專這樣。也可以只追蹤不按讚。我自己看別人技術 blog 也很常這樣(XD</p><h2 id=需求>需求<a hidden class=anchor aria-hidden=true href=#需求>#</a></h2><p>好，今天來講得這個 Terraform</p><p>我會實際分享我們公司為雲團隊導入的經驗，前半部會有點像購物頻道的廣告</p><p>以下的對話是不是常出現在日常工作中？</p><h1 id=以下這段對話很耳熟>以下這段對話很耳熟？<a hidden class=anchor aria-hidden=true href=#以下這段對話很耳熟>#</a></h1><p>「是誰改了這個設定？」</p><ul><li>by 週一上班的 DevOps 與週六值班的維運團隊</li><li>對啟用的環境的掌握如何</li><li>環境的變更能否永久保存</li></ul><p>「這個環境怎麼少一個設定？」</p><ul><li>網站噴錯後，整個團隊一步步釐清問題，不是 code，不是變數config，是 infra 有一個小地方沒設定</li><li>環境複雜，以我們的例子是複雜得多雲網路，常出這種問題</li><li>環境設定的除錯很費時</li><li>完全可以避免</li></ul><p>「會動就好，沒事不要改環境（抖）」</p><ul><li>Legacy site</li><li>調整 production 環境是否有信心</li><li>我們看不慣無人整理的舊架構，導入 terraform 後，（很不要命的）把 production site 搬過一遍</li><li>我有十成的信心跟你說新舊兩個 site 完全一樣</li></ul><h1 id=our-stories>Our stories<a hidden class=anchor aria-hidden=true href=#our-stories>#</a></h1><ul><li>我們是思華科技(ＸＤ)</li><li>開發團隊大概 100+ 個左右</li><li>專案很多，而且老闆很喜歡開新專案測試商業模型</li><li>環境也越開越多，大大小小幾百台 vm，幾十個資料庫，都是不同專案在跑，規模大概這樣</li><li>每週都有新環境要交付</li><li>交接缺口</li></ul><p>我們公司東西多，但東西多不是問題，問題是什麼呢?</p><h1 id=問題>問題<a hidden class=anchor aria-hidden=true href=#問題>#</a></h1><ul><li>手動部屬本來不是問題，但漸漸成為問題<ul><li>開 infrastructure 的方法，跟著 SOP 上去 GCP GUI 介面，點一點，填一填。公有雲開機器很方便。</li><li>可是不同人開的環境漸漸出現一些不同，可能差一個設定、一個參數、或是命名規則差一點。這些細節的不同，差一個 config 有時候就會雷到人。「這機器誰建的阿，根本有問題啊」，而且這種雷很多時候都是跑下去出事了，才發現「阿靠原來設定不一樣」</li><li>命名差一點不影響功能，但看久了就很煩，「阿就對不齊阿」，有強迫症就很痛苦。然後你維運的自動化腳本就爆掉，命名差一個字，regex 就要大改。突然增加維運成本</li></ul></li><li>生產環境大家都不太敢動。架構調整很沒信心<ul><li>誰知道當初環境設定了那些東西，開機器的人離職了，也不知道他為啥設定，「你知道他當初為什麼要設定這個嗎?」，你問我我是要去擲茭喔。<ul><li>我們這一季把所有現有環境都搬到新的架構上，因為我們對舊架構不爽很久了(XD)，這個能做到當然有作法，後面細講</li></ul></li></ul></li></ul><p>有實際需求才找解決方案，沒有需求就不用衝動導入新技術，導入過程中還是蠻累的</p><h1 id=需求-1>需求<a hidden class=anchor aria-hidden=true href=#需求-1>#</a></h1><p>從維運的角度，需求大概長這樣</p><ul><li><p>提升穩定度</p><ul><li>infra 交付標準化</li><li>交付自動化</li><li>測試環境</li></ul></li><li><p>infra 提交要能夠 review</p></li><li><p>提升效率</p><ul><li>老闆要的。超快部屬，腳本跑下去要快，還要更快</li></ul></li><li><p>次要目標</p><ul><li>成本，效能最佳化，希望能在整理過程中，找到最適合的可行架構</li><li>新人好上手，Junior 同事也能「安全」的操作，看到這個安全兩個字了嗎? 安全第一，在訓練新的 op 時要注意安全，不然他上去 GUI 點一點，一個手起刀落 DB 就不見了，整個維運團隊一周不用睡覺。安全第一吼。</li><li>權限控管，IAM 也用 terraform 管理，權限管理人多手雜越用越亂，可以考慮使用 IaC，一覽無遺</li></ul></li></ul><h1 id=programatical-approach-for-infra>Programatical approach for infra<a hidden class=anchor aria-hidden=true href=#programatical-approach-for-infra>#</a></h1><p>啊不就是 Infrastructure as code XD</p><ul><li>導入前，大家都有聽過，大家都覺得很想導入，但沒人有經驗，每個人都超怕，但又不知道在怕三小</li><li>這表明了一件事，大家都知道要做對的事情，但不是每個人都能改變現況，讓團隊導向對的事情</li></ul><p>計畫</p><ul><li>確定需求</li><li>開始 survey</li><li>「小心」導入</li><li>有經驗領頭羊很棒，但不是必須</li></ul><h2 id=技術細節>技術細節<a hidden class=anchor aria-hidden=true href=#技術細節>#</a></h2><p>先簡單講一下 IaC (Yeah 終於要講技術了)</p><h1 id=iac>IaC<a hidden class=anchor aria-hidden=true href=#iac>#</a></h1><p>上面都講概念跟心法，現在實際講用到的技術。</p><p>首先是 Infrastructure as Code，這個概念很久了，但導入的公司好像不是那麼多。所以我今天要來傳教，洗腦大家(XD，跟你推薦這個配方保證快又有效(XD)</p><ul><li>簡單來說就是用程式來操作 infrastructure，今天主講的 terraform 是 IaC 工具中的一個</li><li>IaC 工具可以是宣告式，或是命令式，或是兩種都支援<ul><li>一個是我告訴你結果，步驟我不管，請你幫我生出這樣的結果。</li><li>一個是我告訴你步驟，你一步一步幫我做完，就會得到我要的結果</li><li>terraform 是宣告式，說明邏輯跟結果，例如我要 1 2 3 台機器，terraform 自己去幫我打 Google API 這樣，把機器生出來</li><li>ansible 是命令式，我把步驟寫成一堆命令腳本 playbook ，ansible 幫我照著跑下去，理論上跑完後我的機器也準備好</li></ul></li></ul><h2 id=terraform>Terraform<a hidden class=anchor aria-hidden=true href=#terraform>#</a></h2><ul><li>官網在這邊，自己看 <a href=https://www.terraform.io/>https://www.terraform.io/</a></li><li>宣告式的 Iac 工具</li><li>單一語法描述各家 API</li><li>透過 provider 轉換 tf 成為 API call</li></ul><h1 id=terraform-core-workflow>Terraform Core Workflow<a hidden class=anchor aria-hidden=true href=#terraform-core-workflow>#</a></h1><p><a href=https://www.terraform.io/guides/core-workflow.html>https://www.terraform.io/guides/core-workflow.html</a></p><ul><li>Write 撰寫期待狀態 tf file</li><li>plan 計畫試算結果</li><li>apply 用期待狀態去更新遠端<ul><li>tf file，就是宣告式的表達 infra ，描述期待的infra長這樣，ex. tf file 裡有這些機器 1 2 3 台這樣<ul><li>resource 一個一個物件描述，後面可能是對映 provider 的 API Endpoint (ex. GCP GKE API)</li></ul></li><li>remote resources，是真實存在遠端的機器，例如 GCP 雲端實際上只有 1 2 兩台這樣。</li><li>terraform diff tf vs remote，算出 plan，少的生出來，多的上去砍掉</li></ul></li></ul><h1 id=demo-1>Demo 1<a hidden class=anchor aria-hidden=true href=#demo-1>#</a></h1><ul><li><p>(empty project)</p></li><li><p>add my-gce.tf</p></li><li><p>git diff</p></li><li><p>state</p></li><li><p>check GUI remote</p></li><li><p>existing my-gce</p></li><li><p>remove my-gce.tf</p></li><li><p>plan</p></li><li><p>這邊不 apply 我 demo 還要用</p></li></ul><p>這邊這樣有理解 terraform 的基本流程嗎？編寫，計畫，apply 三步驟
很單純
然後講一點細節</p><ul><li><p>state</p></li><li><p>remove (out of scope)</p></li><li><p>plan -> addd</p></li><li><p>apply (deplicated ID)</p></li><li><p>mv state (Danger)</p></li><li><p>rename state with the same ID -> destroy and recreate (Danger)</p></li></ul><h1 id=state>State<a hidden class=anchor aria-hidden=true href=#state>#</a></h1><ul><li><p>terraform 經手(apply) 過的 resource 會納入 state (scope)</p></li><li><p>不在 scope 裡的 resource 不會納入 plan，不會被 destroy，但可能會 create duplicated ID</p></li><li><p>terraform 允許直接操作 state</p><ul><li>import</li><li>remove</li><li>但我不允許XD</li></ul></li><li><p>注意是 diff state 喔，所以每次 plan 時候會自動 refresh state</p></li><li><p>state 又是什麼? remote 是一個動態環境，可能會多會少，這樣沒辦法 diff，state 是把我執行當下，遠端相關資源的狀態快照存起來，然後根據這個 snapshop 去 diff</p></li><li><p>apply 只是拿你的期待去 diff state，terraform 幫你算出來差多少，例如我們這邊就是遠端少一台。terraform 透過 provider 去知道，喔這一台要去打那些 GCP API，把這台生出來。</p></li></ul><p>State，是核心概念，我當初自己卡觀念是卡這邊，所以我特別拉出來講</p><ul><li>雲端空蕩蕩，refresh state 也是空的，tf file 多加一個 VM，plan 覺得要 create</li><li>雲端有東西，refresh state 未必會 refresh 到<ul><li>相同 ID 的資源之前 import 在 state 中，refresh state，tf file 沒東西，plan 覺得要 destroy</li><li>相同 ID 的資源不在 state 中，這些 resource 不在當前 state 的 scopor 中，refresh state 是空的，tf file 沒東西，plan 覺得沒增沒減</li><li>相同 ID 的資源不在 state 中，這些 resource 不在當前 state 的 scopor 中，refresh state 是空的，tf file 有相同 ID 的資源，plan 覺得要 create，但實際 apply，API error 遠端已經有相同 ID 的資源存在</li></ul></li></ul><h1 id=小結>小結<a hidden class=anchor aria-hidden=true href=#小結>#</a></h1><ul><li>Write -> Plan -> Apply</li><li>State</li><li>大家都會 terraform 惹</li></ul><hr><h1 id=初步使用感想>初步使用感想<a hidden class=anchor aria-hidden=true href=#初步使用感想>#</a></h1><ul><li>IaC 地端跟雲端都能做，但雲端做起來效果超級好<ul><li>完全展現雲端運算的特性，迅速、彈性、隨用隨叫，調度大量的虛擬化資源</li><li>新增東西很快，不要的資源，要刪掉也很快<ul><li>不小心刪錯也很快(大誤)，所以我說新人一個手起刀落公司整個雲弄不見也是有可能的，「啊我的雲勒」「被 terraform 砍了」。不要笑，那個新人就是我，我自己剛學的時候就有把整個 db 變不見過，差點一到職就引咎辭職(XD。用這些技術還是有很多安全要注意，稍後會細講注意的安全事項。</li></ul></li></ul></li></ul><p>總之，Iac 就是用程式化的語法，精準的描述雲端的狀態或是步驟，完全沒有模糊的地帶。帶來的好處，降低維運的錯誤風險，加快維運效率，最佳化節省成本。</p><h1 id=新手-state-的雷>新手 state 的雷<a hidden class=anchor aria-hidden=true href=#新手-state-的雷>#</a></h1><ul><li>多人協作，同時變更 state 會造成不可預期的錯誤<ul><li>避免直接操作 state</li></ul></li><li>state 可能有 sensitive 資料</li><li>推薦使用外部帶有 lock 的 state storage</li></ul><h2 id=導入>導入<a hidden class=anchor aria-hidden=true href=#導入>#</a></h2><h1 id=導入工具之後>導入工具之後<a hidden class=anchor aria-hidden=true href=#導入工具之後>#</a></h1><p>新工具導入時要做好風險評估，每個人都是第一次用 terraform ，用起來很快很爽的同時也要不斷宣導安全概念，雷在哪裡坑在哪裡。</p><p>使用 terraform 的風險</p><ul><li>打 DELET API 超快，砍起來很方便，但很多時候方便 = 危險。眼看小明一個手起刀落，談笑間，公有雲灰飛煙滅(XD，通通變不見。現在在講故事很開心，實際發生的話大家都笑不出來，全公司 RD 都跑來維運部門排隊盯著你看，就算修好也要懲處。壓力超大。但小明砍錯東西不是小明的錯，是大環境的錯是 SOP 的錯(XD。認真的，團隊沒有提供 SOP，新人砍錯東西當然是團隊負責。所以我們 SOP 第一行就寫得很清楚。</li><li>看見 destroy 就雙手離開鍵盤，直接求救，這樣還能出事嗎</li><li>再來，給予特殊的 IAM 權限，例如只能新增不能刪除的權限</li><li>進一步導入 git-flow，push、review、PR，讓他連犯錯的機會都沒有</li><li>根本還是要給予新人足夠的訓練，然後同時保障公司安全。<ul><li>給新人過大權限砍錯東西，或是工作流程一堆坑，根本是在誘導新人犯錯，團隊的資深成員要檢討。</li></ul></li></ul><h1 id=逐漸導入>逐漸導入<a hidden class=anchor aria-hidden=true href=#逐漸導入>#</a></h1><ul><li>導入的過程不斷檢討跟修改，最後找出適合我們公司的流程</li><li>檢討透明，有錯就修 SOP，修工作流程。讓你的工作流程跟工作環境，固若金湯，成員很難在裡面犯錯，這才是 DevOps 在做這的事。</li><li>官方建議的最佳實作 <a href=https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html>https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html</a></li><li>至於我們是如何逐漸導入 IaC 到公司的開發流程中？具體的導入步驟如下</li></ul><h1 id=introduction-iac>Introduction: IaC<a hidden class=anchor aria-hidden=true href=#introduction-iac>#</a></h1><ol><li>舊架構保存。先把雲端上已經有的機器，terraform 裡面叫資源，import 成代碼</li><li>檢查舊架構。所有設定都變成代碼了，跟你看程式碼一樣，一拍兩瞪眼沒有任何模稜兩可。整理過程中找出合理跟不合理的設定。有可能會發現一些雷，只是還沒爆炸，也趁機修一修。</li><li>然後，依照這些現行的資源，去整理一份適合公司的環境範本，之後所有的新環境都這這個範本部屬，確定新的環境都有合理的規劃。</li><li>到此，所有新環境都是同一份範本生出來的，環境已經標準化了。不會再有零碎的小錯誤。聽起來超讚，但有時候出錯就是一起全錯，超慘(XD。當然有錯就修範本，修 SOP。同樣的錯永不再犯，不用再修第二次。</li></ol><h1 id=introduction-git-flow>Introduction: Git-flow<a hidden class=anchor aria-hidden=true href=#introduction-git-flow>#</a></h1><ol><li>然後，導入版本控管，整合 git-flow 的開發流程。寫 SOP，之後所有變更都要</li><li>先把 master 封起來，所有人都不准直接改架構</li><li>開新 branch，commit</li><li>開 PR 大家 review，大家都看過了吼，再 merge 進去，這樣有錯就不是一個人的鍋而是大家一起背鍋(XD。不是拉，review 能大幅降低錯誤，分享團隊經驗加速新人訓練，並且讓所有人 on the same page，不會再有「阿靠這機器誰開的」有人不知情的事情。</li><li>永遠只使用 master 來部屬雲端資源，也是確定所有架構都經過多人 review。</li></ol><h1 id=introduction-pipeline-automation>Introduction: Pipeline Automation<a hidden class=anchor aria-hidden=true href=#introduction-pipeline-automation>#</a></h1><ol><li>最後，整合 CICD，讓架構的部屬完全自動化。把人工降到最低，同時也把人工錯誤的機率降到最低，當然這個也是沒錯都沒錯，要錯一起錯的狀態(XD，使用時還是要注意。但如果執行的很穩定的話，自動化絕對是值得投資的。因為現在把架構當作產品做，部屬完要測試功能，網路設定是否正確，監控是否完整，proxy 是不是要打看看。這些都整合進 infra 自動 pipeline。部屬完就是測試，然後交付給其他團隊。</li><li>之後就是不斷調整 SOP，跟 CI/CD pipeline。把維運步驟轉成程式維護。</li></ol><p>犯錯過一次，永不再犯。這個對於長期團隊經營非常重要，讓經驗跟知識累積，團隊質量才會成長。IaC 在這點幫助很大。</p><h2 id=demo-2>Demo 2<a hidden class=anchor aria-hidden=true href=#demo-2>#</a></h2><ul><li>NAME=terraform-devops make gke redis sql</li><li>module</li><li>git commit</li><li>Review on github</li><li>Merge request</li></ul><h1 id=repo>Repo<a hidden class=anchor aria-hidden=true href=#repo>#</a></h1><p>我使用的原碼都開源在 github 上，因為是真的拿來導入我們公司的架構，保證可以用。阿不能用的話，幫我發 issue 給我，或是你人更好發個 PR 給我都可以(XD。把 repo 拉下來，這邊有 gcp / azure / aws，雖然有三個但我們公司主要是用 gcp，剩下兩個我自己做興趣的。裡面 templates 跟 modules ，但你不用管，我 makefile 都寫好了</p><ul><li>我這邊要新增一個 kubernetes 集群</li><li>我直接進來我的專案， NAME=my-new-k8s make gke，東西就生出來，具體做的事情就是新增兩個程式區塊，每個區塊描述一個機器</li><li>git diff 看多了什麼，這邊多一個 k8s 跟多一個 node-pool</li><li>然後我 plan，讓 terraform 預測一下試跑結果，我們依據結果好好 review，例如這邊 2 to add 0 to destroy 我的想像是不是真的跟 terraform 計畫一樣。</li><li>然後 terraform apply，這邊要看清楚，我們是 2 to add 0 to destroy，如果看到有 destroy 就要雙手離開鍵盤，大家不要衝動，看清楚，因為她真的會上去把東西砍掉</li></ul><p>P.S. 專案可以按照公司需求分，資源太多太擠就拆分成幾個資料夾好管理，然後分權責管理，例如館 iam 的、管網路、管應用機器的可以分開來</p><h1 id=git-flow>Git-flow<a hidden class=anchor aria-hidden=true href=#git-flow>#</a></h1><p>然後因為我後面會講 git-flow 工作流程整合，所以我順便做完。</p><ul><li>新的變更 commit ，plan 但是還沒 apply。我要求所有新的 commit 推上去</li><li>發 PR，其他團隊成員來幫我 review。PR 用的 template ，描述一下新架構的目的，變更的地方，有沒有雷，然後幾個 checklist 檢查</li><li>其他隊員 review 都 lgtm 才 merge 回 master</li><li>apply 永遠在最新的 master 上 apply，確保所有推到雲端的架構都是多人 review 過的。</li></ul><p>有 review 才有品質可言，code 都要 review，infra 自然也需要 review。IaC + git-flow 是必要的。</p><h1 id=demo-2-1>Demo 2<a hidden class=anchor aria-hidden=true href=#demo-2-1>#</a></h1><h1 id=工具--流程>工具 + 流程<a hidden class=anchor aria-hidden=true href=#工具--流程>#</a></h1><p>導入的成功與否，不是最佳實踐，而是各個階段，都給予團隊適合的挑戰與協助</p><ul><li>Git-flow SOP 範例<ul><li>中文版，超長，上面操作過了，這邊不細講，大家自己上去看</li><li>但如果團隊是第一次導入 terraform，我強烈建議要有類似的東西</li></ul></li><li>Provide template</li></ul><p>demo 時不是有 makefile，makefile 裡面寫的小腳本跟本身 IaC 沒有關係，提供一些而外的小腳本輔助，可以進一步降低人工操作，提升效率，又增加安全。工具不一定完全適合團隊吧，這時候就需要補足團隊文化跟工具間的落差，潤滑一下。</p><p>再說一次，新人做錯，不是他做錯，而是團隊沒有提供他足夠的協助。如何讓新人也能有高產出同時又顧及安全，資深工程師是這邊在資深。提供一些一用性工具是必要的。</p><ul><li>Terraform module</li></ul><p>又是一個 terraform 的功能</p><p>簡單來說，GKE 也許定義了 2 個子物件(ex. Cluster，Node-pool)，總共有 30 個參數</p><ul><li>你其實不需要那麼多參數 XD</li><li>建立一個 my-gke-module，一個物件，5 個必填參數，5 個有預設值的選填參數</li><li>也許寫錯的機會只剩 5 個，也許工時只需要 5/30</li><li>需求變更就改 module，讓你的操作物件本身就是符合實際需求的</li></ul><p>能手動改的地方就是能犯錯的地方，黑箱封裝可以保護整體架構，並提高易用性</p><h2 id=雜項>雜項<a hidden class=anchor aria-hidden=true href=#雜項>#</a></h2><h1 id=其他>其他<a hidden class=anchor aria-hidden=true href=#其他>#</a></h1><ul><li>上面是 IaC 在我們公司的流程</li><li>我們選 terraformㄨ</li><li>如果是用 terraform 以外的工具，可以參考流程，也許殊途同歸</li></ul><p><a href=https://www.terraform.io/intro/vs/index.html>https://www.terraform.io/intro/vs/index.html</a></p><h1 id=優缺點>優缺點<a hidden class=anchor aria-hidden=true href=#優缺點>#</a></h1><p>好，跟團隊一步一步溝通改進，花了一兩個月，成功導入。是否有解決當初的問題？</p><ul><li><p>降低人工操作</p><ul><li>避免人工失誤</li><li>infra 交付標準化，沒有奇怪的設定，再也沒有「啊我機器開錯了」這回事</li><li>快，真低快。開一個機器就是我剛剛 demo 這樣，而且保證會動。這樣開出來的機器，對她超有信心，要複製完全一模一樣的環境也超有信心。如果再加上自動化測試就更敢保證。</li></ul></li><li><p>準確</p><ul><li>大家都 review 過，比較不會有「啊我當時沒想到」的狀況，infra 出這種萬萬沒想到的問題，很有機率要幹掉重來。菜鳥跟著 review ，試著發 PR，這樣新人訓練才會有效率，他之後才能自己操作，資深工程師只要 review 就好。要給新人足夠的訓練，又要顧慮安全， review 花的時間非常值得。</li><li>保證開發、測試、staging、production 環境長的一模一樣。terraform 程式保證的不是我保證的(XD)。但他的保證是有根據的，讓團隊從開發到上限保重相同環境。「阿在我的機器上會跑怎麼上 production 就壞掉」不好意思沒這回事，壞掉就是你扣寫錯(兇。認真地說，排除一些 infra 的問題，可以大幅增加除錯的效率，只要檢查還沒自動化的地方就好。</li><li>自動化測試，扣要測試環境也要測試，這邊直接整進去，環境交出去保證是好的</li></ul></li><li><p>生產環境變動</p><ul><li>因為已經轉成程式碼，要有什麼改動都很精確，大家也比較敢動環境，特別是 production 環境。再來因為保留所有環境產生的程式碼，要複製環境也很容易，而且有信心保證一樣。我們就把就架構的 production 複製，然後搬家。安全下庄沒出事。後面就搬上癮，整個公司服務大搬家，搬成團隊理想的架構。搬家已經上線的服務，這個需要多少信心跟勇氣你們知道嗎，維運真的是愛與勇氣的冒險。新架構我們也很滿意。</li></ul></li><li><p>自動化</p><ul><li>自動化就是讓你用零倍的時間做十倍的事情嘛。聽起來怪怪的蛋是是真的。</li><li>因為我們目標是維運躺著上班嘛(XD)，我們才能把時間拿去做改進，不然以光是開機器，測試環境可用性，維運就飽了，根本沒時間改進跟提升。這樣對公司長期非常不好。</li></ul></li><li><p>可讀性</p><ul><li>GUI 沒辦法打 comment 阿，誰知道這個機器當初為什是這個設定。IaC 後到處都可以寫 comment，怕你不寫而已。然後 code 的表達性還是很強大，比起 GUI，資深工程師可以把握整個公司的架構狀況，比起去雲平台下一堆搜索，手動比對，程式碼的可維護性真的超高。而 GCP 已經是 GUI 做得很好的公有雲了。</li></ul></li></ul><p>降低人工，快速，準確，自動化，有信心</p><h2 id=qa>Q&amp;A<a hidden class=anchor aria-hidden=true href=#qa>#</a></h2><p>還有空我們再來講 terraform 的細節</p><p>有事歡迎透過粉專私敲，因為我也需要人討論</p><h2 id=還有時間再聊>還有時間再聊<a hidden class=anchor aria-hidden=true href=#還有時間再聊>#</a></h2><h1 id=terraform-1>terraform<a hidden class=anchor aria-hidden=true href=#terraform-1>#</a></h1><ul><li>validate 既然是 code，這邊幫你做 lint、語法檢測、type check，過濾第一層錯誤</li><li>import 可以把遠端的資源匯入成 state，一個點讚 follow 追蹤的概念(XD)，不是所有的遠端資源都需要追蹤到 state，我們只需要在對的 scope 裡面關注需要的機器</li><li>module 可以自由撰寫，把有相依性的資源打包，依照團隊使用習慣調整使用</li><li>cloud 可以管理 state，terraform cloud 幫你維護全域同一份 state，有人在使用時會 lock state，避免多人同時修改，打亂 API 造成資源錯誤</li></ul><h1 id=state-conflicts>state conflicts<a hidden class=anchor aria-hidden=true href=#state-conflicts>#</a></h1><ul><li>如果有多份 state，你電腦上一份 local state，我電腦上一份 local state，其實會造成衝突</li><li>更怕同時多人憶起 apply，GCP API 直接被打亂，會有不可預期的錯誤</li><li>解法是使用 terraform remote backend，不要用 local state，使用 DB 、storage 或是 terraform cloud，透過一隻 lock 來保證 synchronized state</li></ul><h1 id=間接理解-api>間接理解 API<a hidden class=anchor aria-hidden=true href=#間接理解-api>#</a></h1><p>ex. GCP Load Balancer</p><p>這個講下去就太多了，基本上透過爬 terraform google provider 的文件，然後去比對</p><ul><li>因為去點 GUI 其實感受不到 GCP API 的調用，但是使用 terraform 轉寫資源時候就很有感，打這個 API 跟打這個 API，tf 檔案上其實看得出來。</li><li>進一步去查，才發現 GCP Load Balancer 內網或外網、http 或 tcp、全球或區域，使用的 Load Balancer 行為不一樣，因為底下的實作不一樣。但之前使用 GUI 時其實不會去想為啥設定不一樣，使用 terraform 就會被迫去了解，強迫學習XD。</li></ul><h1 id=垃圾話>垃圾話<a hidden class=anchor aria-hidden=true href=#垃圾話>#</a></h1><ul><li>最佳實踐不是問題 ，如何導入才是問題</li><li>可以不用躺著上班，但是不能跪著上班</li><li>願意多幾個人來看我粉專比較實在</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/kubernetes/>Kubernetes</a></li><li><a href=https://chechia.net/tags/terraform/>Terraform</a></li><li><a href=https://chechia.net/tags/devops/>Devops</a></li><li><a href=https://chechia.net/tags/iac/>Iac</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2020-08-19-season-review/><span class=title>« Prev</span><br><span>2020 08 Season Review</span>
</a><a class=next href=https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/><span class=title>Next »</span><br><span>從零開始的 Infrastructure as Code: Terraform - 01</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on x" href="https://x.com/intent/tweet/?text=Terraform%20Infrastructure%20as%20Code%20Transcript&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f&amp;hashtags=kubernetes%2cterraform%2cdevops%2ciac"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f&amp;title=Terraform%20Infrastructure%20as%20Code%20Transcript&amp;summary=Terraform%20Infrastructure%20as%20Code%20Transcript&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f&title=Terraform%20Infrastructure%20as%20Code%20Transcript"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on whatsapp" href="https://api.whatsapp.com/send?text=Terraform%20Infrastructure%20as%20Code%20Transcript%20-%20https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on telegram" href="https://telegram.me/share/url?text=Terraform%20Infrastructure%20as%20Code%20Transcript&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code Transcript on ycombinator" href="https://news.ycombinator.com/submitlink?t=Terraform%20Infrastructure%20as%20Code%20Transcript&u=https%3a%2f%2fchechia.net%2fposts%2f2020-06-15-terraform-infrastructure-as-code-transcript%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>