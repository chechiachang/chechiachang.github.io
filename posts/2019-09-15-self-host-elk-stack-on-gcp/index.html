<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Self-host ELK stack - Installation | Che-Chia Chang</title><meta name=keywords content="鐵人賽2019,gcp,tls,elasticsearch,devops,logstash"><meta name=description content="2020 It邦幫忙鐵人賽 系列文章

Self-host ELK stack on GCP
Secure ELK Stask
監測 Google Compute Engine 上服務的各項數據
監測 Google Kubernetes Engine 的各項數據
是否選擇 ELK 作為解決方案
使用 logstash pipeline 做數據前處理
Elasticsearch 日常維護：數據清理，效能調校，永久儲存
Debug ELK stack on GCP

作為範例的 ELK 的版本是當前的 stable release 7.3.1。
由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。
對我的文章有興趣，歡迎到我的網站上 https://chechia.net 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。
&ndash;
簡介 ELK stack
官方說明文件
ELK 的元件

Elasticsearch: 基於 Lucene 的分散式全文搜索引擎
Logstash: 數據處理 pipeline
Kibana: ELK stack 的管理後台與數據視覺化工具
Beats: 輕量級的應用端數據收集器，會從被監控端收集 log 與監控數據(metrics)

ELK 的工作流程
beats -> (logstash) -> elasticsearch -> kibana"><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Self-host ELK stack - Installation"><meta property="og:description" content="2020 It邦幫忙鐵人賽 系列文章
Self-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP 作為範例的 ELK 的版本是當前的 stable release 7.3.1。
由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。
對我的文章有興趣，歡迎到我的網站上 https://chechia.net 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。
–
簡介 ELK stack 官方說明文件
ELK 的元件 Elasticsearch: 基於 Lucene 的分散式全文搜索引擎 Logstash: 數據處理 pipeline Kibana: ELK stack 的管理後台與數據視覺化工具 Beats: 輕量級的應用端數據收集器，會從被監控端收集 log 與監控數據(metrics) ELK 的工作流程 beats -> (logstash) -> elasticsearch -> kibana"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-15T11:43:03+08:00"><meta property="article:modified_time" content="2019-09-15T11:43:03+08:00"><meta property="article:tag" content="鐵人賽2019"><meta property="article:tag" content="Gcp"><meta property="article:tag" content="Tls"><meta property="article:tag" content="Elasticsearch"><meta property="article:tag" content="Devops"><meta property="article:tag" content="Logstash"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Self-host ELK stack - Installation"><meta name=twitter:description content="2020 It邦幫忙鐵人賽 系列文章

Self-host ELK stack on GCP
Secure ELK Stask
監測 Google Compute Engine 上服務的各項數據
監測 Google Kubernetes Engine 的各項數據
是否選擇 ELK 作為解決方案
使用 logstash pipeline 做數據前處理
Elasticsearch 日常維護：數據清理，效能調校，永久儲存
Debug ELK stack on GCP

作為範例的 ELK 的版本是當前的 stable release 7.3.1。
由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。
對我的文章有興趣，歡迎到我的網站上 https://chechia.net 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。
&ndash;
簡介 ELK stack
官方說明文件
ELK 的元件

Elasticsearch: 基於 Lucene 的分散式全文搜索引擎
Logstash: 數據處理 pipeline
Kibana: ELK stack 的管理後台與數據視覺化工具
Beats: 輕量級的應用端數據收集器，會從被監控端收集 log 與監控數據(metrics)

ELK 的工作流程
beats -> (logstash) -> elasticsearch -> kibana"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Self-host ELK stack - Installation","item":"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Self-host ELK stack - Installation","name":"Self-host ELK stack - Installation","description":"2020 It邦幫忙鐵人賽 系列文章\nSelf-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP 作為範例的 ELK 的版本是當前的 stable release 7.3.1。\n由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。\n對我的文章有興趣，歡迎到我的網站上 https://chechia.net 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。\n\u0026ndash;\n簡介 ELK stack 官方說明文件\nELK 的元件 Elasticsearch: 基於 Lucene 的分散式全文搜索引擎 Logstash: 數據處理 pipeline Kibana: ELK stack 的管理後台與數據視覺化工具 Beats: 輕量級的應用端數據收集器，會從被監控端收集 log 與監控數據(metrics) ELK 的工作流程 beats -\u0026gt; (logstash) -\u0026gt; elasticsearch -\u0026gt; kibana\n","keywords":["鐵人賽2019","gcp","tls","elasticsearch","devops","logstash"],"articleBody":"2020 It邦幫忙鐵人賽 系列文章\nSelf-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP 作為範例的 ELK 的版本是當前的 stable release 7.3.1。\n由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。\n對我的文章有興趣，歡迎到我的網站上 https://chechia.net 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。\n–\n簡介 ELK stack 官方說明文件\nELK 的元件 Elasticsearch: 基於 Lucene 的分散式全文搜索引擎 Logstash: 數據處理 pipeline Kibana: ELK stack 的管理後台與數據視覺化工具 Beats: 輕量級的應用端數據收集器，會從被監控端收集 log 與監控數據(metrics) ELK 的工作流程 beats -\u003e (logstash) -\u003e elasticsearch -\u003e kibana\n將 beats 放在應用端的主機上，或是在容器化環境種作為 sidecar，跟應用放在一起 設定 beats 從指定的路徑收集 log 與 metrics 設定 beats 向後輸出的遠端目標 (Optional) beats 輸出到 logstash ，先進行數據的變更、格式整理，在後送到 elasticsearch beats 向後輸出到 elasticsearch，儲存數據文件(document)，並依照樣式(template)與索引(index)儲存，便可在 elasticsearch 上全文搜索數據 透過 Kibana，將 elasticsearch 上的 log 顯示 官方不是有出文件嗎 Elastic 官方準備了大量的文件，理論上要跟著文件一步一步架設這整套工具應該是十分容易。然而實際照著做卻遇上很多困難。由於缺乏 get-started 的範例文件，不熟悉 ELK 設定的使用者，常常需要停下來除錯，甚至因為漏掉某個步驟，而需要回頭重做一遍。\n說穿了本篇的技術含量不高，就只是一個踩雷過程。\nLets get our hands dirty.\nWARNING 這篇安裝過程沒有做安全性設定，由於 ELK stack 的安全性功能模組，在v6.3.0 以前的版本是不包含安全性模組的，官方的安裝說明文件將安全性設定另成一篇。我第一次安裝，全部安裝完後，才發現裏頭沒有任何安全性設定，包含帳號密碼登入、api secret token、https/tls 通通沒有，整組 elk 裸奔。\n我這邊分開的目的，不是讓大家都跟我一樣被雷(XD)，而是因為\n另起一篇對安全性設定多加說明 在安全的內網中，沒有安全性設定，可以大幅加速開發與除錯 雖然沒有安全性設定，但仍然有完整的功能，如果只是在測試環境，或是想要評估試用 self-hosted ELK，這篇的說明已足夠。但千萬不要用這篇上 public network 或是用在 production 環境喔。\n如果希望第一次安裝就有完整的 security 設定，請等待下篇 Secure ELK Stask\n討論需求與規格 這邊只是帶大家過一下基礎安裝流程，我們在私有網路中搭建一台 standalone 的 ELK stack，通通放在一台節點(node)上。\nelk-node-standalone 10.140.0.10 app-node-1 10.140.0.11 ... ... 本機的 ELK stack 元件，彼此透過 localhost 連線\nElasticsearch: localhost:9200 Kibana: localhost:5601 Apm-server: localhost:8200 Self Monitoring Services 私有網路中的外部服務透過 10.140.0.10\nbeats 從其他 node 輸出到 Elasticsearch: 10.140.0.10:9200 beats 從其他 node 輸出到 Apm-server: 10.140.0.10:8200 在內部網路中 透過 browser 存取 Kibana: 10.140.0.10:5601 standalone 的好處:\n方便 (再次強調這篇只是示範，實務上不要貪一時方便，維運崩潰) 最簡化設定，ELK 有非常大量的設定可以調整，這篇簡化了大部分 Standalone可能造成的問題:\nNo High Availablity: 沒有任何容錯備援可以 failover，這台掛就全掛 外部服務多的話，很容易就超過 node 上對於網路存取的限制，造成 tcp drop 或 delay。需要調整 ulimit 來增加網路，當然這在雲端上會給維運帶來更多麻煩，不是一個好解法。 如果要有 production ready 的 ELK\nHA 開起來 把服務分散到不同 node 上, 方便之後 scale out 多開幾台 elasticsearch-1, elasticsearch-2, elasticsearch-3… kibana-1 apm-server-1, apm-server-2, … 如果應用在已經容器化, 這些服務元件也可以上 Kubernetes 做容器自動化，這個部份蠻好玩，如果有時間我們來聊這篇 主機設定 Elasticsearch 儲存數據會佔用不少硬碟空間，我個人的習慣是只要有額外占用儲存空間，都要另外掛載硬碟，不要占用 root，所以這邊會需要另外掛載硬碟。\nGCP 上使用 Google Compote Engine 的朋友，可以照 Google 官方操作步驟操作\n完成後接近這樣\n$ df -h $ df --human-readable Filesystem Size Used Avail Use% Mounted on /dev/sda1 9.6G 8.9G 682M 93% / /dev/sdb 492G 63G 429G 13% /mnt/disks/elk $ ls /mnt/disks/elk /mnt/disks/elk/elasticsearch /mnt/disks/elk/apm-server /mnt/disks/elk/kibana 至於需要多少容量，取決收集數據的數量，落差非常大，可以先上個 100Gb ，試跑一段時間，再視情況 scale storage disk。\n開防火牆 需要開放 10.140.0.10 這台機器的幾個 port\nelasticsearch :9200 來源只開放私有網路其他 ip 10.140.0.0/9 apm-server :8200 (同上) kibana :5601 (同上)，如果想從外部透過 browser開，需要 whitelist ip GCP 上有 default 的防火牆允許規則，私有網路可以彼此連線\ndefault-allow-internal: :all :10.140.0.0/9 tcp:0-65535 Install Elasticsearch Install Elasticsearch 官方文件 7.3\n我們這邊直接在 ubuntu 18.04 上使用 apt 作為安裝\nsudo apt-get install apt-transport-https wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - add-apt-repository \"deb https://artifacts.elastic.co/packages/7.x/apt stable main\" sudo apt-get update sudo apt-get install elasticsearch 安裝完後路徑長這樣\n/etc/elasticsearch /etc/elasticsearch/elasticsearch.yml /etc/elasticsearch/jvm.options # Utility /usr/share/elasticsearch/bin/ # Log /var/log/elasticsearch/elasticsearch.log 有需要也可以複寫設定檔，把 log 也移到 /mnt/disks/elk/elasticsearch/logs\n服務控制 透過 systemd 管理，我們可以用 systemctl 控制， 用戶 elasticsearch:elasticsearch，操作時會需要 sudo 權限。\n但在啟動前要先調整數據儲存路徑，並把權限移轉給使用者。\nmkdir -p /mnt/disks/elk/elasticsearch chown elasticsearch:elasticsearch /mnt/disks/elk/elasticsearch 設定檔案 ELK 提供了許多可設定調整的設定,但龐大的設定檔案也十分難上手。我們這邊先簡單更改以下設定檔案\nsudo vim /etc/elasticsearch/elasticsearch.yml # Change Network network.host: 0.0.0.0 # Change data path path.data: /mnt/disks/elk/elasticsearch vim /etc/elasticsearch/jvm-options # Adjust heap to 4G -Xms4g -Xmx4g # Enable xpack.security discovery.seed_hosts: [\"10.140.0.10\"] discovery.type: \"single-node\" xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.license.self_generated.type: basic 6.3.0 後的版本已經附上安全性模組 xpack，這邊順便開起來。關於 xpack 的安全性設定，這邊先略過不提。\n有啟用 xpack ，可以讓我們透過 elasticsearch 附帶的工具，產生使用者與帳號密碼。\n/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto # Keep your passwords safe 然後把啟動 Elasticsearch\nsudo systemctl enable elasticsearch.service sudo systemctl start elasticsearch.service sudo systemctl status elasticsearch.service 看一下 log，確定服務有在正常工作\ntail -f /var/log/elasticsearch/elasticsearch.log 在 node 上試打 Elasticsearch API\n$ curl localhost:9200 { \"name\" : \"elk\", \"cluster_name\" : \"elasticsearch\", \"cluster_uuid\" : \"uiMZe7VETo-H6JLFLF4SZg\", \"version\" : { \"number\" : \"7.3.1\", \"build_flavor\" : \"default\", \"build_type\" : \"deb\", \"build_hash\" : \"4749ba6\", \"build_date\" : \"2019-08-19T20:19:25.651794Z\", \"build_snapshot\" : false, \"lucene_version\" : \"8.1.0\", \"minimum_wire_compatibility_version\" : \"6.8.0\", \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" }, \"tagline\" : \"You Know, for Search\" } Kibana 有了正常工作的 Elasticsearch，接下來要安裝 kibana，由於 apt repository 已經匯入，這邊直接\nsudo apt-get update sudo apt-get install kibana 一樣快速設定一下\n$ vim /etc/kibana/kinana.yml # change server.host from localhost to 0.0.0.0 to allow outside requests server.host: \"0.0.0.0\" # Add elasticsearch password elasticsearch.username: \"kibana\" elasticsearch.password: sudo systemctl enable kibana.service sudo systemctl start kibana.service sudo systemctl status kibana.service 檢查 log 並試打一下\nsudo systemctl status kibana $ curl localhost:5601 透過內網 ip 也可以用 browser 存取 使用 elastic 這組帳號密碼登入，可以有管理員權限 可以檢視一下 kibana 的頁面，看一下是否系統功能都上常上線 http://10.140.0.10/app/monitoring#\nFilebeat 以上是 ELK 最基本架構: elasticsearch 引擎與前端視覺化管理工具 Kibana。當然現在進去 kibana 是沒有數據的，所以我們現在來安裝第一個 beat，收集第一筆數據。\n你可能會覺得奇怪: 我現在沒有任何需要監控的應用，去哪收集數據?\nELK 提供的自我監測 (self-monitoring) 的功能，也就是在 node 上部屬 filebeat 並啟用 modules，便可以把這台 node 上的 elasticsearch 運行的狀況，包含cpu 狀況、記憶體用量、儲存空間用量、安全性告警、…都做為數據，傳到 elasticsearch 中，並在 Kibana monitoring 頁面製圖顯示。\n這邊也剛好做為我們 ELK stack 的第一筆數據收集。\nWARNING: 這邊一樣要提醒， production 環境多半會使用另外一組的 elasticsearch 來監控主要的這組 elastic stack，以維持 elk stack 的穩定性，才不會自己 monitoring 自己，結果 elastic 掛了，metrics 跟錯誤訊息都看不到。\n官方安裝文件\nsudo apt-get update sudo apt-get install filebeat 預設的 filebeat.yml 設定檔案不是完整的，請到官網下載完整版，但官網沒給檔案連結(慘)，只有網頁版 https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html\n我們上 github 把她載下來\n$ wget https://raw.githubusercontent.com/elastic/beats/v7.3.1/filebeat/filebeat.reference.yml $ sudo mv filebeat-reference-y $ sudo vim /etc/filebeat/filebeat.yml # Enable elasticsearch module and kibana module to process metrics of localhost elasticsearch \u0026 kibana filebeat.modules: - module: elasticsearch # Server log server: enabled: true - module: kibana # All logs log: enabled: true # The name will be added to metadata name: filebeat-elk fields: env: elk # Add additional cloud_metadata since we're on GCP processors: - add_cloud_metadata: ~ # Output to elasticsearch output.elasticsearch: enabled: true hosts: [\"localhost:9200\"] protocol: \"http\" username: \"elastic\" password: # Configure kibana with filebeat: add template, dashboards, etc... setup.kibana: host: \"localhost:5601\" protocol: \"http\" username: \"elastic\" password: 啟動 filebeat\nsudo systemctl start filebeat 看一下 log，filebeat 會開始收集 elasticsearch 的 log 與 metrics，可以在 log 上看到收集的狀況。\n$ sudo journalctl -fu filebeat Sep 15 06:28:50 elk filebeat[9143]: 2019-09-15T06:28:50.176Z INFO [monitoring] log/log.go:145 Non-zero metrics in the last 30s {\"monitoring\": {\"metrics\": {\"beat\":{\"cpu\":{\"system\":{\"ticks\":1670860,\"time\":{\"ms\":66}},\"total\":{\"ticks\":6964660,\"time\":{\"ms\":336},\"value\":6964660},\"user\":{\"ticks\":5293800,\"time\":{\"ms\":270}}},\"handles\":{\"limit\":{\"hard\":4096,\"soft\":1024},\"open\":11},\"info\":{\"ephemeral_id\":\"62fd4bfa-1949-4356-9615-338ca6a95075\",\"uptime\":{\"ms\":786150373}},\"memstats\":{\"gc_next\":7681520,\"memory_alloc\":4672576,\"memory_total\":457564560376,\"rss\":-32768},\"runtime\":{\"goroutines\":98}},\"filebeat\":{\"events\":{\"active\":-29,\"added\":1026,\"done\":1055},\"harvester\":{\"open_files\":4,\"running\":4}},\"libbeat\":{\"config\":{\"module\":{\"running\":0}},\"output\":{\"events\":{\"acked\":1055,\"active\":-50,\"batches\":34,\"total\":1005},\"read\":{\"bytes\":248606},\"write\":{\"bytes\":945393}},\"pipeline\":{\"clients\":9,\"events\":{\"active\":32,\"published\":1026,\"total\":1026},\"queue\":{\"acked\":1055}}},\"registrar\":{\"states\":{\"current\":34,\"update\":1055},\"writes\":{\"success\":35,\"total\":35}},\"system\":{\"load\":{\"1\":1.49,\"15\":0.94,\"5\":1.15,\"norm\":{\"1\":0.745,\"15\":0.47,\"5\":0.575}}}}}} 如果數據都有送出，就可以回到 kibana 的頁面，看一下目前這個 elasticsearch 集群，有開啟 monitoring 功能的元件們，是否都有正常工作。\nhttp://10.140.0.10/app/monitoring#\n頁面長得像這樣\nStandalone cluster 中的 filebeat，是還未跟 elasticsearch 配對完成的數據，會顯示在另外一個集群中，配對完後會歸到 elk cluster 中，就是我們的主要 cluster。\n點進去可以看各個元件的服務情形。\n小結 簡單思考 self-host ELK stack 搭建的架構 在單一 node 上安裝最簡易的 elastic stack 設定元件的 output 位置 設定 self-monitoring 恭喜各位獲得一個裸奔但是功能完整的 ELK, 我們下篇再向安全性邁進。\n","wordCount":"839","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2019-09-15T11:43:03+08:00","dateModified":"2019-09-15T11:43:03+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=categories><span>categories</span></a></li><li><a href=https://chechia.net/tags/ title=tags><span>tags</span></a></li><li><a href=https://chechia.net/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Self-host ELK stack - Installation</h1><div class=post-meta><span title='2019-09-15 11:43:03 +0800 CST'>September 15, 2019</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;839 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2019-09-15-self-host-elk-stack-on-gcp.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#elk-的元件>ELK 的元件</a></li><li><a href=#elk-的工作流程>ELK 的工作流程</a></li></ul></li></ul><ul><li><ul><li><a href=#服務控制>服務控制</a></li><li><a href=#設定檔案>設定檔案</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p><a href=https://ithelp.ithome.com.tw/2020ironman>2020 It邦幫忙鐵人賽</a> 系列文章</p><ul><li><a href=https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/>Self-host ELK stack on GCP</a></li><li><a href=https://chechia.net/posts/2019-09-15-secure-elk-stack/>Secure ELK Stask</a></li><li><a href=https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/>監測 Google Compute Engine 上服務的各項數據</a></li><li><a href=https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/>監測 Google Kubernetes Engine 的各項數據</a></li><li><a href=https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/>是否選擇 ELK 作為解決方案</a></li><li><a href=https://chechia.net/posts/2019-09-21-logstash-on-gke/>使用 logstash pipeline 做數據前處理</a></li><li>Elasticsearch 日常維護：數據清理，效能調校，永久儲存</li><li>Debug ELK stack on GCP</li></ul><p>作為範例的 ELK 的版本是當前的 stable release 7.3.1。</p><p>由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。</p><p>對我的文章有興趣，歡迎到我的網站上 <a href=https://chechia.net>https://chechia.net</a> 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。</p><p>&ndash;</p><h1 id=簡介-elk-stack>簡介 ELK stack<a hidden class=anchor aria-hidden=true href=#簡介-elk-stack>#</a></h1><p><a href=https://www.elastic.co/guide/index.html>官方說明文件</a></p><h3 id=elk-的元件>ELK 的元件<a hidden class=anchor aria-hidden=true href=#elk-的元件>#</a></h3><ul><li>Elasticsearch: 基於 Lucene 的分散式全文搜索引擎</li><li>Logstash: 數據處理 pipeline</li><li>Kibana: ELK stack 的管理後台與數據視覺化工具</li><li>Beats: 輕量級的應用端數據收集器，會從被監控端收集 log 與監控數據(metrics)</li></ul><h3 id=elk-的工作流程>ELK 的工作流程<a hidden class=anchor aria-hidden=true href=#elk-的工作流程>#</a></h3><p>beats -> (logstash) -> elasticsearch -> kibana</p><ol><li>將 beats 放在應用端的主機上，或是在容器化環境種作為 sidecar，跟應用放在一起</li><li>設定 beats 從指定的路徑收集 log 與 metrics</li><li>設定 beats 向後輸出的遠端目標</li><li>(Optional) beats 輸出到 logstash ，先進行數據的變更、格式整理，在後送到 elasticsearch</li><li>beats 向後輸出到 elasticsearch，儲存數據文件(document)，並依照樣式(template)與索引(index)儲存，便可在 elasticsearch 上全文搜索數據</li><li>透過 Kibana，將 elasticsearch 上的 log 顯示</li></ol><h1 id=官方不是有出文件嗎>官方不是有出文件嗎<a hidden class=anchor aria-hidden=true href=#官方不是有出文件嗎>#</a></h1><p>Elastic 官方準備了大量的文件，理論上要跟著文件一步一步架設這整套工具應該是十分容易。然而實際照著做卻遇上很多困難。由於缺乏 get-started 的範例文件，不熟悉 ELK 設定的使用者，常常需要停下來除錯，甚至因為漏掉某個步驟，而需要回頭重做一遍。</p><p>說穿了本篇的技術含量不高，就只是一個踩雷過程。</p><p>Lets get our hands dirty.</p><h1 id=warning>WARNING<a hidden class=anchor aria-hidden=true href=#warning>#</a></h1><p>這篇安裝過程沒有做安全性設定，由於 ELK stack 的安全性功能模組，在<a href=https://www.elastic.co/what-is/open-x-pack>v6.3.0 以前的版本是不包含安全性模組的</a>，官方的安裝說明文件將安全性設定另成一篇。我第一次安裝，全部安裝完後，才發現裏頭沒有任何安全性設定，包含帳號密碼登入、api secret token、https/tls 通通沒有，整組 elk 裸奔。</p><p>我這邊分開的目的，不是讓大家都跟我一樣被雷(XD)，而是因為</p><ul><li>另起一篇對安全性設定多加說明</li><li>在安全的內網中，沒有安全性設定，可以大幅加速開發與除錯</li></ul><p>雖然沒有安全性設定，但仍然有完整的功能，如果只是在測試環境，或是想要評估試用 self-hosted ELK，這篇的說明已足夠。但千萬不要用這篇上 public network 或是用在 production 環境喔。</p><p>如果希望第一次安裝就有完整的 security 設定，請等待下篇 <a href=/posts/2019-09-15-self-host-elk-stack-on-gcp/#secure-elk-stack>Secure ELK Stask</a></p><h1 id=討論需求與規格>討論需求與規格<a hidden class=anchor aria-hidden=true href=#討論需求與規格>#</a></h1><p>這邊只是帶大家過一下基礎安裝流程，我們在私有網路中搭建一台 standalone 的 ELK stack，通通放在一台節點(node)上。</p><pre><code>elk-node-standalone 10.140.0.10
app-node-1          10.140.0.11
...                 ...
</code></pre><p>本機的 ELK stack 元件，彼此透過 localhost 連線</p><ul><li>Elasticsearch: localhost:9200</li><li>Kibana: localhost:5601</li><li>Apm-server: localhost:8200</li><li>Self Monitoring Services</li></ul><p>私有網路中的外部服務透過 10.140.0.10</p><ul><li>beats 從其他 node 輸出到 Elasticsearch: 10.140.0.10:9200</li><li>beats 從其他 node 輸出到 Apm-server: 10.140.0.10:8200</li><li>在內部網路中 透過 browser 存取 Kibana: 10.140.0.10:5601</li></ul><p>standalone 的好處:</p><ul><li>方便 (再次強調這篇只是示範，實務上不要貪一時方便，維運崩潰)</li><li>最簡化設定，ELK 有非常大量的設定可以調整，這篇簡化了大部分</li></ul><p>Standalone可能造成的問題:</p><ul><li>No High Availablity: 沒有任何容錯備援可以 failover，這台掛就全掛</li><li>外部服務多的話，很容易就超過 node 上對於網路存取的限制，造成 tcp drop 或 delay。需要調整 ulimit 來增加網路，當然這在雲端上會給維運帶來更多麻煩，不是一個好解法。</li></ul><p>如果要有 production ready 的 ELK</p><ul><li>HA 開起來</li><li>把服務分散到不同 node 上, 方便之後 scale out 多開幾台<ul><li>elasticsearch-1, elasticsearch-2, elasticsearch-3&mldr;</li><li>kibana-1</li><li>apm-server-1, apm-server-2, &mldr;</li></ul></li><li>如果應用在已經容器化, 這些服務元件也可以上 Kubernetes 做容器自動化，這個部份蠻好玩，如果有時間我們來聊這篇</li></ul><h1 id=主機設定>主機設定<a hidden class=anchor aria-hidden=true href=#主機設定>#</a></h1><p>Elasticsearch 儲存數據會佔用不少硬碟空間，我個人的習慣是只要有額外占用儲存空間，都要另外掛載硬碟，不要占用 root，所以這邊會需要另外掛載硬碟。</p><p>GCP 上使用 Google Compote Engine 的朋友，可以照 <a href="https://cloud.google.com/compute/docs/disks/add-persistent-disk?hl=zh-tw">Google 官方操作步驟操作</a></p><p>完成後接近這樣</p><pre><code>$ df -h
$ df --human-readable

Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       9.6G  8.9G  682M  93% /
/dev/sdb        492G   63G  429G  13% /mnt/disks/elk

$ ls /mnt/disks/elk

/mnt/disks/elk/elasticsearch
/mnt/disks/elk/apm-server
/mnt/disks/elk/kibana
</code></pre><p>至於需要多少容量，取決收集數據的數量，落差非常大，可以先上個 100Gb ，試跑一段時間，再視情況 scale storage disk。</p><h1 id=開防火牆>開防火牆<a hidden class=anchor aria-hidden=true href=#開防火牆>#</a></h1><p>需要開放 10.140.0.10 這台機器的幾個 port</p><ul><li>elasticsearch :9200 來源只開放私有網路其他 ip 10.140.0.0/9</li><li>apm-server :8200 (同上)</li><li>kibana :5601 (同上)，如果想從外部透過 browser開，需要 whitelist ip</li></ul><p>GCP 上有 default 的防火牆允許規則，私有網路可以彼此連線</p><ul><li>default-allow-internal: :all :10.140.0.0/9 tcp:0-65535</li></ul><h1 id=install-elasticsearch>Install Elasticsearch<a hidden class=anchor aria-hidden=true href=#install-elasticsearch>#</a></h1><p><a href=https://www.elastic.co/guide/en/elasticsearch/reference/7.3/install-elasticsearch.html>Install Elasticsearch 官方文件 7.3</a></p><p>我們這邊直接在 ubuntu 18.04 上使用 apt 作為安裝</p><pre><code>sudo apt-get install apt-transport-https
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
add-apt-repository &quot;deb https://artifacts.elastic.co/packages/7.x/apt stable main&quot;
sudo apt-get update
sudo apt-get install elasticsearch
</code></pre><p>安裝完後路徑長這樣</p><pre><code>/etc/elasticsearch
/etc/elasticsearch/elasticsearch.yml
/etc/elasticsearch/jvm.options

# Utility
/usr/share/elasticsearch/bin/

# Log
/var/log/elasticsearch/elasticsearch.log
</code></pre><p>有需要也可以複寫設定檔，把 log 也移到 /mnt/disks/elk/elasticsearch/logs</p><h3 id=服務控制>服務控制<a hidden class=anchor aria-hidden=true href=#服務控制>#</a></h3><p>透過 systemd 管理，我們可以用 systemctl 控制，
用戶 elasticsearch:elasticsearch，操作時會需要 sudo 權限。</p><p>但在啟動前要先調整數據儲存路徑，並把權限移轉給使用者。</p><pre><code>mkdir -p /mnt/disks/elk/elasticsearch
chown elasticsearch:elasticsearch /mnt/disks/elk/elasticsearch
</code></pre><h3 id=設定檔案>設定檔案<a hidden class=anchor aria-hidden=true href=#設定檔案>#</a></h3><p>ELK 提供了許多可設定調整的設定,但龐大的設定檔案也十分難上手。我們這邊先簡單更改以下設定檔案</p><pre><code>sudo vim /etc/elasticsearch/elasticsearch.yml

# Change Network
network.host: 0.0.0.0
# Change data path
path.data: /mnt/disks/elk/elasticsearch

vim /etc/elasticsearch/jvm-options
# Adjust heap to 4G
-Xms4g
-Xmx4g

# Enable xpack.security
discovery.seed_hosts: [&quot;10.140.0.10&quot;]
discovery.type: &quot;single-node&quot;
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.license.self_generated.type: basic
</code></pre><p>6.3.0 後的版本已經附上安全性模組 xpack，這邊順便開起來。關於 xpack 的安全性設定，這邊先略過不提。</p><p>有啟用 xpack ，可以讓我們透過 elasticsearch 附帶的工具，產生使用者與帳號密碼。</p><pre><code>/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto

# Keep your passwords safe
</code></pre><p>然後把啟動 Elasticsearch</p><pre><code>sudo systemctl enable elasticsearch.service
sudo systemctl start elasticsearch.service
sudo systemctl status elasticsearch.service
</code></pre><p>看一下 log，確定服務有在正常工作</p><pre><code>tail -f /var/log/elasticsearch/elasticsearch.log
</code></pre><p>在 node 上試打 Elasticsearch API</p><pre><code>$ curl localhost:9200

{
  &quot;name&quot; : &quot;elk&quot;,
  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,
  &quot;cluster_uuid&quot; : &quot;uiMZe7VETo-H6JLFLF4SZg&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;7.3.1&quot;,
    &quot;build_flavor&quot; : &quot;default&quot;,
    &quot;build_type&quot; : &quot;deb&quot;,
    &quot;build_hash&quot; : &quot;4749ba6&quot;,
    &quot;build_date&quot; : &quot;2019-08-19T20:19:25.651794Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;8.1.0&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
</code></pre><h1 id=kibana>Kibana<a hidden class=anchor aria-hidden=true href=#kibana>#</a></h1><p>有了正常工作的 Elasticsearch，接下來要安裝 kibana，由於 apt repository 已經匯入，這邊直接</p><pre><code>sudo apt-get update
sudo apt-get install kibana
</code></pre><p>一樣快速設定一下</p><pre><code>$ vim /etc/kibana/kinana.yml

# change server.host from localhost to 0.0.0.0 to allow outside requests
server.host: &quot;0.0.0.0&quot;

# Add elasticsearch password
elasticsearch.username: &quot;kibana&quot;
elasticsearch.password:

sudo systemctl enable kibana.service
sudo systemctl start kibana.service
sudo systemctl status kibana.service
</code></pre><p>檢查 log 並試打一下</p><pre><code>sudo systemctl status kibana

$ curl localhost:5601
</code></pre><p>透過內網 ip 也可以用 browser 存取
使用 elastic 這組帳號密碼登入，可以有管理員權限
可以檢視一下 kibana 的頁面，看一下是否系統功能都上常上線
http://10.140.0.10/app/monitoring#</p><h1 id=filebeat>Filebeat<a hidden class=anchor aria-hidden=true href=#filebeat>#</a></h1><p>以上是 ELK 最基本架構: elasticsearch 引擎與前端視覺化管理工具 Kibana。當然現在進去 kibana 是沒有數據的，所以我們現在來安裝第一個 beat，收集第一筆數據。</p><p>你可能會覺得奇怪: 我現在沒有任何需要監控的應用，去哪收集數據?</p><p>ELK 提供的自我監測 (self-monitoring) 的功能，也就是在 node 上部屬 filebeat 並啟用 modules，便可以把這台 node 上的 elasticsearch 運行的狀況，包含cpu 狀況、記憶體用量、儲存空間用量、安全性告警、&mldr;都做為數據，傳到 elasticsearch 中，並在 Kibana monitoring 頁面製圖顯示。</p><p>這邊也剛好做為我們 ELK stack 的第一筆數據收集。</p><p>WARNING: 這邊一樣要提醒， production 環境多半會使用另外一組的 elasticsearch 來監控主要的這組 elastic stack，以維持 elk stack 的穩定性，才不會自己 monitoring 自己，結果 elastic 掛了，metrics 跟錯誤訊息都看不到。</p><p><a href=https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-installation.html>官方安裝文件</a></p><pre><code>sudo apt-get update
sudo apt-get install filebeat
</code></pre><p>預設的 filebeat.yml 設定檔案不是完整的，請到官網下載完整版，但官網沒給檔案連結(慘)，只有網頁版 <a href=https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html>https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html</a></p><p>我們上 github 把她載下來</p><pre><code>$ wget https://raw.githubusercontent.com/elastic/beats/v7.3.1/filebeat/filebeat.reference.yml
$ sudo mv filebeat-reference-y
$ sudo vim /etc/filebeat/filebeat.yml

# Enable elasticsearch module and kibana module to process metrics of localhost elasticsearch &amp; kibana
filebeat.modules:
- module: elasticsearch
  # Server log
  server:
    enabled: true

- module: kibana
  # All logs
  log:
    enabled: true

# The name will be added to metadata
name: filebeat-elk
fields:
  env: elk

# Add additional cloud_metadata since we're on GCP
processors:
- add_cloud_metadata: ~

# Output to elasticsearch
output.elasticsearch:
  enabled: true
  hosts: [&quot;localhost:9200&quot;]
  protocol: &quot;http&quot;
  username: &quot;elastic&quot;
  password: 

# Configure kibana with filebeat: add template, dashboards, etc...
setup.kibana:
  host: &quot;localhost:5601&quot;
  protocol: &quot;http&quot;
  username: &quot;elastic&quot;
  password: 
</code></pre><p>啟動 filebeat</p><pre><code>sudo systemctl start filebeat
</code></pre><p>看一下 log，filebeat 會開始收集 elasticsearch 的 log 與 metrics，可以在 log 上看到收集的狀況。</p><pre><code>$ sudo journalctl -fu filebeat

Sep 15 06:28:50 elk filebeat[9143]: 2019-09-15T06:28:50.176Z        INFO        [monitoring]        log/log.go:145        Non-zero metrics in the last 30s        {&quot;monitoring&quot;: {&quot;metrics&quot;: {&quot;beat&quot;:{&quot;cpu&quot;:{&quot;system&quot;:{&quot;ticks&quot;:1670860,&quot;time&quot;:{&quot;ms&quot;:66}},&quot;total&quot;:{&quot;ticks&quot;:6964660,&quot;time&quot;:{&quot;ms&quot;:336},&quot;value&quot;:6964660},&quot;user&quot;:{&quot;ticks&quot;:5293800,&quot;time&quot;:{&quot;ms&quot;:270}}},&quot;handles&quot;:{&quot;limit&quot;:{&quot;hard&quot;:4096,&quot;soft&quot;:1024},&quot;open&quot;:11},&quot;info&quot;:{&quot;ephemeral_id&quot;:&quot;62fd4bfa-1949-4356-9615-338ca6a95075&quot;,&quot;uptime&quot;:{&quot;ms&quot;:786150373}},&quot;memstats&quot;:{&quot;gc_next&quot;:7681520,&quot;memory_alloc&quot;:4672576,&quot;memory_total&quot;:457564560376,&quot;rss&quot;:-32768},&quot;runtime&quot;:{&quot;goroutines&quot;:98}},&quot;filebeat&quot;:{&quot;events&quot;:{&quot;active&quot;:-29,&quot;added&quot;:1026,&quot;done&quot;:1055},&quot;harvester&quot;:{&quot;open_files&quot;:4,&quot;running&quot;:4}},&quot;libbeat&quot;:{&quot;config&quot;:{&quot;module&quot;:{&quot;running&quot;:0}},&quot;output&quot;:{&quot;events&quot;:{&quot;acked&quot;:1055,&quot;active&quot;:-50,&quot;batches&quot;:34,&quot;total&quot;:1005},&quot;read&quot;:{&quot;bytes&quot;:248606},&quot;write&quot;:{&quot;bytes&quot;:945393}},&quot;pipeline&quot;:{&quot;clients&quot;:9,&quot;events&quot;:{&quot;active&quot;:32,&quot;published&quot;:1026,&quot;total&quot;:1026},&quot;queue&quot;:{&quot;acked&quot;:1055}}},&quot;registrar&quot;:{&quot;states&quot;:{&quot;current&quot;:34,&quot;update&quot;:1055},&quot;writes&quot;:{&quot;success&quot;:35,&quot;total&quot;:35}},&quot;system&quot;:{&quot;load&quot;:{&quot;1&quot;:1.49,&quot;15&quot;:0.94,&quot;5&quot;:1.15,&quot;norm&quot;:{&quot;1&quot;:0.745,&quot;15&quot;:0.47,&quot;5&quot;:0.575}}}}}}
</code></pre><p>如果數據都有送出，就可以回到 kibana 的頁面，看一下目前這個 elasticsearch 集群，有開啟 monitoring 功能的元件們，是否都有正常工作。</p><p>http://10.140.0.10/app/monitoring#</p><p>頁面長得像這樣</p><figure><img loading=lazy src=elk/kibana-monitoring.png width=100% height=100%></figure><p>Standalone cluster 中的 filebeat，是還未跟 elasticsearch 配對完成的數據，會顯示在另外一個集群中，配對完後會歸到 elk cluster 中，就是我們的主要 cluster。</p><p>點進去可以看各個元件的服務情形。</p><h1 id=小結>小結<a hidden class=anchor aria-hidden=true href=#小結>#</a></h1><ul><li>簡單思考 self-host ELK stack 搭建的架構</li><li>在單一 node 上安裝最簡易的 elastic stack</li><li>設定元件的 output 位置</li><li>設定 self-monitoring</li></ul><p>恭喜各位獲得一個裸奔但是功能完整的 ELK, 我們下篇再向安全性邁進。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2019/>鐵人賽2019</a></li><li><a href=https://chechia.net/tags/gcp/>Gcp</a></li><li><a href=https://chechia.net/tags/tls/>Tls</a></li><li><a href=https://chechia.net/tags/elasticsearch/>Elasticsearch</a></li><li><a href=https://chechia.net/tags/devops/>Devops</a></li><li><a href=https://chechia.net/tags/logstash/>Logstash</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2019-09-15-secure-elk-stack/><span class=title>« Prev</span><br><span>Secure Elk Stack</span>
</a><a class=next href=https://chechia.net/posts/2019-09-09-ithome-ironman-challenge/><span class=title>Next »</span><br><span>2019 IT邦幫忙鐵人賽</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on x" href="https://x.com/intent/tweet/?text=Self-host%20ELK%20stack%20-%20Installation&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f&amp;hashtags=%e9%90%b5%e4%ba%ba%e8%b3%bd2019%2cgcp%2ctls%2celasticsearch%2cdevops%2clogstash"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f&amp;title=Self-host%20ELK%20stack%20-%20Installation&amp;summary=Self-host%20ELK%20stack%20-%20Installation&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f&title=Self-host%20ELK%20stack%20-%20Installation"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on whatsapp" href="https://api.whatsapp.com/send?text=Self-host%20ELK%20stack%20-%20Installation%20-%20https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on telegram" href="https://telegram.me/share/url?text=Self-host%20ELK%20stack%20-%20Installation&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Self-host ELK stack - Installation on ycombinator" href="https://news.ycombinator.com/submitlink?t=Self-host%20ELK%20stack%20-%20Installation&u=https%3a%2f%2fchechia.net%2fposts%2f2019-09-15-self-host-elk-stack-on-gcp%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>