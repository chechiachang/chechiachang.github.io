<!DOCTYPE html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: 2025年6月1日 --><html lang="zh-Hant" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Hugo Blox Builder 5.9.7" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.f6689966c0a10712f95f034011917db0.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  






<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYR8JCDGM9"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'G-QYR8JCDGM9', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>




<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NSBJFRS');
</script>





















  
  
  






  <meta name="author" content="張哲嘉" />





  

<meta name="description" content="如果你希望追蹤最新的草稿，請見鐵人賽2023
本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證
整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground
Day 08: Vault in Docker and Initialization Vault in container 前幾天我們使用 vault dev Server 來啟用測試用的 Vault server。
在 production 環境我們不會使用 dev Server。Vault 提供許多安裝方法" />



<link rel="alternate" hreflang="zh-Hant" href="https://chechia.net/zh-hant/post/2023-09-19-vault-workshop-docker-and-initialization/" />
<link rel="canonical" href="https://chechia.net/zh-hant/post/2023-09-19-vault-workshop-docker-and-initialization/" />



  <link rel="manifest" href="/zh-hant/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png" />

<meta name="theme-color" content="#1565c0" />










  
  






<meta property="twitter:card" content="summary" />

  <meta property="twitter:site" content="@chechiachang" />
  <meta property="twitter:creator" content="@chechiachang" />
<meta property="twitter:image" content="https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" />



  

<meta property="og:type" content="article" />
<meta property="og:site_name" content="Che-Chia Chang" />
<meta property="og:url" content="https://chechia.net/zh-hant/post/2023-09-19-vault-workshop-docker-and-initialization/" />
<meta property="og:title" content="Vault Workshop 08: Vault in Docker and Initialization | Che-Chia Chang" />
<meta property="og:description" content="如果你希望追蹤最新的草稿，請見鐵人賽2023
本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證
整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground
Day 08: Vault in Docker and Initialization Vault in container 前幾天我們使用 vault dev Server 來啟用測試用的 Vault server。
在 production 環境我們不會使用 dev Server。Vault 提供許多安裝方法" /><meta property="og:image" content="https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="zh-Hant" />

  
    <meta
      property="article:published_time"
      content="2023-09-14T04:42:26&#43;08:00"
    />
  
  
    <meta property="article:modified_time" content="2023-09-20T23:48:57&#43;08:00">
  






    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chechia.net/zh-hant/post/2023-09-19-vault-workshop-docker-and-initialization/"
  },
  "headline": "Vault Workshop 08: Vault in Docker and Initialization",
  
  "datePublished": "2023-09-14T04:42:26+08:00",
  "dateModified": "2023-09-20T23:48:57+08:00",
  
  "author": {
    "@type": "Person",
    "name": "張哲嘉"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "chechia-net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "如果你希望追蹤最新的草稿，請見鐵人賽2023\n本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證\n整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground\nDay 08: Vault in Docker and Initialization Vault in container 前幾天我們使用 vault dev Server 來啟用測試用的 Vault server。\n在 production 環境我們不會使用 dev Server。Vault 提供許多安裝方法"
}
</script>

  

  




  
  
  

  
  

  


  
  <title>Vault Workshop 08: Vault in Docker and Initialization | Che-Chia Chang</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="59374be8f87e0b492479a15fb6977f17" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>搜尋</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="關閉"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜尋..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜尋...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header header--fixed">
  
  
  
  
  












<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/zh-hant/">Che-Chia Chang</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切換導航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/zh-hant/">Che-Chia Chang</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#talks"><span>演講</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#posts"><span>發文</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#projects"><span>專案</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://www.instagram.com/c.c.leather/" target="_blank" rel="noopener"><span>皮件</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://www.instagram.com/dive.with.cat.coach/" target="_blank" rel="noopener"><span>水肺</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5" target="_blank" rel="noopener"><span>微軟MVP</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/chechiachang" data-toggle="tooltip" data-placement="bottom" title="查看我的Github" target="_blank" rel="noopener" aria-label="查看我的Github">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.facebook.com/engineer.from.scratch" data-toggle="tooltip" data-placement="bottom" title="追蹤我的Facebook粉絲專頁" target="_blank" rel="noopener" aria-label="追蹤我的Facebook粉絲專頁">
                <i class="fab fa-facebook" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="搜尋"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="顯示選項">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>明亮</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>暗黑</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>自動</span>
            </a>
          </div>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  













  

  
  
  
<div class="article-container pt-3">
  <h1>Vault Workshop 08: Vault in Docker and Initialization</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
          最近更新於
      
    
    9月 20, 2023
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    8 閱讀時間（分鐘）
  </span>
  

  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/zh-hant/category/vault/">vault</a>, <a href="/zh-hant/category/docker/">docker</a></span>
  

</div>

    





  
</div>



  <div class="article-container">

    <div class="article-style">
      <p>如果你希望追蹤最新的草稿，請見<a href="https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/" target="_blank" rel="noopener">鐵人賽2023</a></p>
<p>本 workshop 也接受網友的許願清單，<a href="https://ithelp.ithome.com.tw/articles/10317378" target="_blank" rel="noopener">如果有興趣的題目可於第一篇底下留言</a>，筆者會盡力實現，但不做任何保證</p>
<p>整篇 Workshop 會使用的範例與原始碼，放在 <a href="http://chechia.net/zh-hant/#projects" target="_blank" rel="noopener">Github Repository: vault-playground</a></p>
<h1 id="day-08-vault-in-docker-and-initialization">Day 08: Vault in Docker and Initialization</h1>
<h3 id="vault-in-container">Vault in container</h3>
<p>前幾天我們使用 vault dev Server 來啟用測試用的 Vault server。</p>
<p>在 production 環境我們不會使用 dev Server。Vault 提供許多安裝方法</p>
<ul>
<li>可以使用 binary 直接安裝在VM上</li>
<li>也可以透過 hashicorp/vault official docker image，在container 環境中執行</li>
<li>或是使用 hashicorp official helm chart，安裝在kuberntes上</li>
</ul>
<h3 id="使用範例-repository">使用範例 repository</h3>
<p>你可以使用筆者準備的範例 repository <a href="https://github.com/chechiachang/vault-playground" target="_blank" rel="noopener">https://github.com/chechiachang/vault-playground</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone git@github.com:chechiachang/vault-playground.git
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> deploy/00-docker-dev/
</span></span></code></pre></div><p>你可以使用下列指令啟動 vault in docker</p>
<ul>
<li>並使用 -v flag 來掛載 ./config/ volume 到 container 中的 /vault/config.d/</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run --cap-add<span class="o">=</span>IPC_LOCK <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume ./vault/config/:/vault/config.d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume ./vault/file/:/vault/file <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --volume ./vault/logs/:/vault/logs <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 8200:8200 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --name vault_1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  hashicorp/vault:1.14.3 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  vault server -config<span class="o">=</span>/vault/config.d/vault.hcl
</span></span></code></pre></div><p>然後使用 docker logs 指令檢視 vault server log</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker logs -f vault_1
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">==</span>&gt; Vault server configuration:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Administrative Namespace:
</span></span><span class="line"><span class="cl">             Api Address: https://0.0.0.0:8200
</span></span><span class="line"><span class="cl">                     Cgo: disabled
</span></span><span class="line"><span class="cl">         Cluster Address: https://0.0.0.0:8201
</span></span><span class="line"><span class="cl">   Environment Variables: GODEBUG, GOTRACEBACK, HOME, HOSTNAME, NAME, PATH, PWD, SHLVL, VERSION
</span></span><span class="line"><span class="cl">              Go Version: go1.20.8
</span></span><span class="line"><span class="cl">              Listener 1: tcp <span class="o">(</span>addr: <span class="s2">&#34;0.0.0.0:8200&#34;</span>, cluster address: <span class="s2">&#34;0.0.0.0:8201&#34;</span>, max_request_duration: <span class="s2">&#34;1m30s&#34;</span>, max_request_size: <span class="s2">&#34;33554432&#34;</span>, tls: <span class="s2">&#34;disabled&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">               Log Level:
</span></span><span class="line"><span class="cl">                   Mlock: supported: true, enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">           Recovery Mode: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">                 Storage: file
</span></span><span class="line"><span class="cl">                 Version: Vault v1.14.3, built 2023-09-11T21:23:55Z
</span></span><span class="line"><span class="cl">             Version Sha: <span class="nv">56debfa71653e72433345f23cd26276bc90629ce</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; Vault server started! Log data will stream in below:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2023-09-20T13:38:25.914Z <span class="o">[</span>INFO<span class="o">]</span>  proxy environment: <span class="nv">http_proxy</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">no_proxy</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T13:38:25.920Z <span class="o">[</span>INFO<span class="o">]</span>  core: Initializing version <span class="nb">history</span> cache <span class="k">for</span> core
</span></span></code></pre></div><p>你會發現，vault server 不是以 dev server 的狀態啟動的，需要進行額外的初始化設定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s1">&#39;http://127.0.0.1:8200&#39;</span>
</span></span></code></pre></div><p>檢查 vault status</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault status
</span></span></code></pre></div><p>output，顯示一個上未初始化的 vault server 與其 storage backend &ldquo;filesyste&rdquo;</p>
<ul>
<li>可以在 ./vault/config/vault.hcl 上看到我們使用新的 Storage Backend &ldquo;file&rdquo; 設定</li>
<li>vault server 的 storage backend 目前是 sealed 狀態
<ul>
<li>不是 vault server sealed，而是沒有提供 vault server 初始化設定 / unseal keys，所以 vault server 無法解密 storage backend</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Key                Value
</span></span><span class="line"><span class="cl">---                -----
</span></span><span class="line"><span class="cl">Seal Type          shamir
</span></span><span class="line"><span class="cl">Initialized        <span class="nb">false</span>
</span></span><span class="line"><span class="cl">Sealed             <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Total Shares       <span class="m">0</span>
</span></span><span class="line"><span class="cl">Threshold          <span class="m">0</span>
</span></span><span class="line"><span class="cl">Unseal Progress    0/0
</span></span><span class="line"><span class="cl">Unseal Nonce       n/a
</span></span><span class="line"><span class="cl">Version            1.14.3
</span></span><span class="line"><span class="cl">Build Date         2023-09-11T21:23:55Z
</span></span><span class="line"><span class="cl">Storage Type       file
</span></span><span class="line"><span class="cl">HA Enabled         <span class="nb">false</span>
</span></span></code></pre></div><h3 id="storage-backend-filesystem">Storage Backend: filesystem</h3>
<p><a href="https://developer.hashicorp.com/vault/docs/configuration/storage/filesystem" target="_blank" rel="noopener">https://developer.hashicorp.com/vault/docs/configuration/storage/filesystem</a></p>
<p>filesystem storage backend將 Vault 的資料存儲在文件系統上，使用標準的目錄結構。</p>
<p>它可以用於持久的Single Server情況，或者在本地開發時，耐久性不是關鍵問題的情況下使用。</p>
<p>filesystem storage backend 不支援高可用性 - 檔案系統後端不支援高可用性。</p>
<p>filesystem storage backend 由HashiCorp 官方支援 - 檔案系統後端是由 HashiCorp 官方支援維護的。</p>
<h3 id="初始化-vault">初始化 Vault</h3>
<p>初始化是配置 Vault 的過程。僅對第一次使用在 Vault server 上的 Backend 上執行一次。在高可用(HA)模式下運行時，這僅在每個叢集(Vault Cluster)中執行一次，而不是每台Server。</p>
<p>在初始化期間，將生成加密金鑰、創建 unseal keys，並創建 init root token。</p>
<p>初始化不需身份驗證，僅適用於全新的 Vault，有資料存在的 Storage Backend 無法用初始化解鎖。</p>
<p>要初始化 Vault，使用以下命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault operator init
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Unseal Key 1: 9AYJ...kNCn
</span></span><span class="line"><span class="cl">Unseal Key 2: RqDx...odRU
</span></span><span class="line"><span class="cl">Unseal Key 3: uHUv...lws4
</span></span><span class="line"><span class="cl">Unseal Key 4: f+KD...aHgL
</span></span><span class="line"><span class="cl">Unseal Key 5: AKyF...e6vd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Initial Root Token: hvs.8yU3...7esX
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Vault initialized with <span class="m">5</span> key shares and a key threshold of 3. Please securely
</span></span><span class="line"><span class="cl">distribute the key shares printed above. When the Vault is re-sealed,
</span></span><span class="line"><span class="cl">restarted, or stopped, you must supply at least <span class="m">3</span> of these keys to unseal it
</span></span><span class="line"><span class="cl">before it can start servicing requests.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Vault 使用了 5 個金鑰份額encryption key share和 3 的 key threshold 進行初始化。請安全地分發上面的金鑰份額。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 當 Vault 被重新密封、重新啟動或停止時，你必須提供至少 3 個這些金鑰來對其進行解封，然後它才能開始處理請求。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Vault does not store the generated root key. Without at least <span class="m">3</span> keys to
</span></span><span class="line"><span class="cl">reconstruct the root key, Vault will remain permanently sealed!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Vault 不存儲生成的根金鑰。如果沒有至少 3 個金鑰來重建根金鑰，Vault 將保持永久密封！</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">It is possible to generate new unseal keys, provided you have a quorum of
</span></span><span class="line"><span class="cl">existing unseal keys shares. See <span class="s2">&#34;vault operator rekey&#34;</span> <span class="k">for</span> more information.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果你有足夠的現有解封金鑰份額，則可以生成新的解封金鑰。有關更多信息，請參閱 &#34;vault operator rekey&#34;。</span>
</span></span></code></pre></div><p>初始化過程輸出了兩個非常重要的信息：解封金鑰和 init root token。這是唯一一次 Vault 顯示這些資料。</p>
<p>為了這個入門課程，請將這些金鑰保存在某個地方，然後繼續進行操作。</p>
<ul>
<li>Vault backend storage 認 key 不認人，請收好這五隻 unseal key，放置在五個不同安全的地方</li>
<li>有 3/5 的 unseal key 就能重建 encryption key，也就是能夠解密 storage backend</li>
<li>可以用 3/5 unseal key 產生 root token <code>vault operator generate-root</code>
<ul>
<li>換句話說，unseal key 是比 root 還大的超級管理員 key</li>
</ul>
</li>
<li>在實際的部署情況下，你永遠不應該將這些金鑰保存在一起。
<ul>
<li>你可能會使用 Vault 的 PGP 和 Keybase.io 支援，使用使用者的 PGP 金鑰加密每個解封金鑰。</li>
<li>這可以防止單個人擁有所有的解封金鑰。</li>
</ul>
</li>
</ul>
<p>vault server log，可以看到 vault server 開始進行初始化流程</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2023-09-20T13:47:05.113Z <span class="o">[</span>INFO<span class="o">]</span>  core: security barrier not initialized
</span></span><span class="line"><span class="cl">2023-09-20T13:47:05.117Z <span class="o">[</span>INFO<span class="o">]</span>  core: seal configuration missing, not initialized
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.506Z <span class="o">[</span>INFO<span class="o">]</span>  core: security barrier not initialized
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.512Z <span class="o">[</span>INFO<span class="o">]</span>  core: seal configuration missing, not initialized
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.521Z <span class="o">[</span>INFO<span class="o">]</span>  core: security barrier not initialized
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.557Z <span class="o">[</span>INFO<span class="o">]</span>  core: security barrier initialized: <span class="nv">stored</span><span class="o">=</span><span class="m">1</span> <span class="nv">shares</span><span class="o">=</span><span class="m">5</span> <span class="nv">threshold</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.589Z <span class="o">[</span>INFO<span class="o">]</span>  core: post-unseal setup starting
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.609Z <span class="o">[</span>INFO<span class="o">]</span>  core: loaded wrapping token key
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.609Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully setup plugin catalog: plugin-directory<span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.613Z <span class="o">[</span>INFO<span class="o">]</span>  core: no mounts<span class="p">;</span> adding default mount table
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.629Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>cubbyhole <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>cubbyhole/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.631Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>system <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>sys/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.631Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>identity <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>identity/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.686Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>token <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>token/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.696Z <span class="o">[</span>INFO<span class="o">]</span>  rollback: starting rollback manager
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.697Z <span class="o">[</span>INFO<span class="o">]</span>  core: restoring leases
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.698Z <span class="o">[</span>INFO<span class="o">]</span>  expiration: lease restore <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.713Z <span class="o">[</span>INFO<span class="o">]</span>  identity: entities restored
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.714Z <span class="o">[</span>INFO<span class="o">]</span>  identity: groups restored
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.720Z <span class="o">[</span>INFO<span class="o">]</span>  core: usage gauge collection is disabled
</span></span><span class="line"><span class="cl">2023-09-20T14:03:28.733Z <span class="o">[</span>INFO<span class="o">]</span>  core: Recorded vault version: vault <span class="nv">version</span><span class="o">=</span>1.14.3 upgrade <span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2023-09-20 14:03:28.720230178 +0000 UTC&#34;</span> build <span class="nv">date</span><span class="o">=</span>2023-09-11T21:23:55Z
</span></span><span class="line"><span class="cl">2023-09-20T14:03:29.120Z <span class="o">[</span>INFO<span class="o">]</span>  core: post-unseal setup <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:03:29.146Z <span class="o">[</span>INFO<span class="o">]</span>  core: root token generated
</span></span><span class="line"><span class="cl">2023-09-20T14:03:29.146Z <span class="o">[</span>INFO<span class="o">]</span>  core: pre-seal teardown starting
</span></span><span class="line"><span class="cl">2023-09-20T14:03:29.146Z <span class="o">[</span>INFO<span class="o">]</span>  rollback: stopping rollback manager
</span></span><span class="line"><span class="cl">2023-09-20T14:03:29.146Z <span class="o">[</span>INFO<span class="o">]</span>  core: pre-seal teardown <span class="nb">complete</span>
</span></span></code></pre></div><p>你可以在這時檢視 ./vault/file 裡面的內容，./vault/file 在 <code>vault operator init</code> 前是空白的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ls -al ./vault/file
</span></span></code></pre></div><p>output，可以看到 ./vault/file 內已經初始化 filesystem storage backend 的內容</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">core
</span></span><span class="line"><span class="cl">logical
</span></span><span class="line"><span class="cl">sys
</span></span></code></pre></div><p>你可以檢視 ./vault/file/* 內的檔案內容，會發現內容都是 json 相容格式，而且都經過加密</p>
<ul>
<li>在正常的條件下，沒有 unseal key 的人，是無法在有效時間內解鎖這些 filesystem 中的內容，內容還是受到保護</li>
<li>這並不代表你可以隨意放置 filesystem storage backend 的內容
<ul>
<li>例如將他 commit 到 repository 中(vault-playground 已經添加 .gitignore)</li>
</ul>
</li>
<li>請選擇安全，經過 vault 資安團隊測試過的 backend，來保障資料安全與可用程度</li>
</ul>
<h3 id="unseal">Unseal</h3>
<p>每個初始化的 Vault Server 都始於密封狀態。根據配置，Vault 可以訪問 storage backend，但它無法讀取其中的任何資料，因為它不知道如何解密它。教會 Vault 如何解密數據稱為解封(unseal) Vault。</p>
<p>每次 Vault 開始運行時都必須進行解封。可以通過 API 和命令行來執行解封操作。</p>
<p>要解封 Vault，你必須擁有解封金鑰的閾值數量(threshold)。在上面的輸出中，請注意 &ldquo;key threshold&rdquo; 是 3。這意味著要解封 Vault，你需要 5 個生成的金鑰中的 3 個。</p>
<p>注意</p>
<p>Vault 不存儲任何解封金鑰片段(key share)。Vault 使用一種稱為 Shamir&rsquo;s Secret Sharing 的算法來將 root encryption key 分成片段(share)。只有擁有threshold數量的金鑰，才能將其重建，最終訪問你的資料。</p>
<p>開始解封 Vault：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault operator unseal
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Unseal Key <span class="o">(</span>will be hidden<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Key                Value
</span></span><span class="line"><span class="cl">---                -----
</span></span><span class="line"><span class="cl">Seal Type          shamir
</span></span><span class="line"><span class="cl">Initialized        <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Sealed             <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Total Shares       <span class="m">5</span>
</span></span><span class="line"><span class="cl">Threshold          <span class="m">3</span>
</span></span><span class="line"><span class="cl">Unseal Progress    1/3
</span></span><span class="line"><span class="cl">Unseal Nonce       9d03a4e0-bb4f-cfd5-326b-5afb55fdce53
</span></span><span class="line"><span class="cl">Version            1.14.3
</span></span><span class="line"><span class="cl">Build Date         2023-09-11T21:23:55Z
</span></span><span class="line"><span class="cl">Storage Type       file
</span></span><span class="line"><span class="cl">HA Enabled         <span class="nb">false</span>
</span></span></code></pre></div><p>繼續操作，輸入3/5把 unseal key 就可順利解封 storage backend</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Unseal Key <span class="o">(</span>will be hidden<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Key             Value
</span></span><span class="line"><span class="cl">---             -----
</span></span><span class="line"><span class="cl">Seal Type       shamir
</span></span><span class="line"><span class="cl">Initialized     <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Sealed          <span class="nb">false</span>
</span></span><span class="line"><span class="cl">Total Shares    <span class="m">5</span>
</span></span><span class="line"><span class="cl">Threshold       <span class="m">3</span>
</span></span><span class="line"><span class="cl">Version         1.14.3
</span></span><span class="line"><span class="cl">Build Date      2023-09-11T21:23:55Z
</span></span><span class="line"><span class="cl">Storage Type    file
</span></span><span class="line"><span class="cl">Cluster Name    vault-cluster-f90273e8
</span></span><span class="line"><span class="cl">Cluster ID      5ecc63c9-11eb-c384-355d-dffea2dd6484
</span></span><span class="line"><span class="cl">HA Enabled      <span class="nb">false</span>
</span></span></code></pre></div><p>vault server log，成功解封後</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2023-09-20T14:57:17.077Z <span class="o">[</span>INFO<span class="o">]</span>  core.cluster-listener.tcp: starting listener: <span class="nv">listener_address</span><span class="o">=</span>0.0.0.0:8201
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.078Z <span class="o">[</span>INFO<span class="o">]</span>  core.cluster-listener: serving cluster requests: <span class="nv">cluster_listen_address</span><span class="o">=[</span>::<span class="o">]</span>:8201
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.089Z <span class="o">[</span>INFO<span class="o">]</span>  core: post-unseal setup starting
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.115Z <span class="o">[</span>INFO<span class="o">]</span>  core: loaded wrapping token key
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.115Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully setup plugin catalog: plugin-directory<span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.127Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>system <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>sys/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.128Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>identity <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>identity/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.128Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>cubbyhole <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>cubbyhole/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.148Z <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted: <span class="nv">type</span><span class="o">=</span>token <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;v1.14.3+builtin.vault&#34;</span> <span class="nv">path</span><span class="o">=</span>token/ <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;ID: root. Path: &#34;</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.154Z <span class="o">[</span>INFO<span class="o">]</span>  rollback: starting rollback manager
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.154Z <span class="o">[</span>INFO<span class="o">]</span>  core: restoring leases
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.156Z <span class="o">[</span>INFO<span class="o">]</span>  expiration: lease restore <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.158Z <span class="o">[</span>INFO<span class="o">]</span>  identity: entities restored
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.159Z <span class="o">[</span>INFO<span class="o">]</span>  identity: groups restored
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.166Z <span class="o">[</span>INFO<span class="o">]</span>  core: usage gauge collection is disabled
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.178Z <span class="o">[</span>INFO<span class="o">]</span>  core: post-unseal setup <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">2023-09-20T14:57:17.178Z <span class="o">[</span>INFO<span class="o">]</span>  core: vault is unsealed
</span></span></code></pre></div><h3 id="hashicorp-vault-docker">Hashicorp Vault docker</h3>
<p>使用容器(container) 前需要查閱 image 的官方說明 <a href="https://hub.docker.com/r/hashicorp/vault" target="_blank" rel="noopener">https://hub.docker.com/r/hashicorp/vault</a>，幾件事情要注意</p>
<p>Base Image 是選擇使用 Alpine，比起其他 linux distributions 具有相對較小的安全風險，但功能足夠用於開發和測試。</p>
<p>Vault 始終在 dumb-init 下運行，將 process 與 SIG 傳遞給容器中運行的所有process。</p>
<p>使用的 Binary 由 HashiCorp 構建，並使用 GPG 金鑰簽名，因此你可以驗證Binary。</p>
<p>在不帶任何參數的情況下運行 Vault，容器將為你提供一個處於dev mode的 Vault Server。</p>
<p>容器公開了兩個可選的volume：</p>
<p>/vault/logs，用於寫入 audit log。預設情況下，這裡不會寫入任何內容；必須在Vault config 中啟用文件audit backend。</p>
<p>/vault/file，用於在使用資料storage plugin時，將資料寫入persistency。預設情況下，這裡不寫入任何內容（dev mode使用 in-memory storage）；在啟動容器之前，必須在 Vault 的配置中啟用文件 data storagebackend。</p>
<p>容器在 /vault/config 設置了一個 Vault 配置目錄，Server 將通過volume，載入這裡放置的任何 hcl 或 json config file。或者，也可以通過通過環境變數 <code>VAULT_LOCAL_CONFIG</code> 傳遞配置 json 來添加config。</p>
<h3 id="vault-configuration">Vault configuration</h3>
<p>如同前面說明，透過 <code>--volume ./config/:/vault/config.d</code> flag 將 ./config/vault.hcl 設定檔案掛載進容器中</p>
<p>你可以檢視目前的 vault server configuration，是以 vault.hcl 格式表示</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat ./config/vault.hcl
</span></span></code></pre></div><p>output，在這裡可以設置 vault server 的啟動參數</p>
<ul>
<li>配置一個 listener &ldquo;tcp&rdquo;，監聽容器內 0.0.0.0:8200 進來的 request</li>
<li>由於 <code>docker run</code> 也設定 <code>-p 8200:8200</code> 將主機網路的 8200 port bind 到容器的 8200 port，讓我們可以在主機網路中存取 vault。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">ui</span>            <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">disable_mlock</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">api_addr</span>      <span class="o">=</span> <span class="s2">&#34;https://0.0.0.0:8200&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">default_lease_ttl</span> <span class="o">=</span> <span class="s2">&#34;168h&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_lease_ttl</span>     <span class="o">=</span> <span class="s2">&#34;720h&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">storage <span class="s2">&#34;file&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">path</span> <span class="o">=</span> <span class="s2">&#34;/vault/file&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">listener <span class="s2">&#34;tcp&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">address</span>     <span class="o">=</span> <span class="s2">&#34;0.0.0.0:8200&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">tls_disable</span> <span class="o">=</span> <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="操作-vault">操作 Vault</h3>
<p>Vault in Docker 使用起來與透過 binary 執行的 dev server 一樣。</p>
<p>你可以參照前幾天文章的內容，對 vault server 進行操做，也算是做個練習</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault login
</span></span><span class="line"><span class="cl">vault secrets list
</span></span><span class="line"><span class="cl">vault secrets <span class="nb">enable</span> -version<span class="o">=</span><span class="m">2</span> -path<span class="o">=</span>chechia-net kv
</span></span></code></pre></div><p>在後面的內容，我們會用更有效率的方式管理，設定 vault</p>
<h3 id="關閉-vault-container">關閉 vault container</h3>
<p>你可以使用以下指令關閉 vault容器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker stop vault_1
</span></span></code></pre></div><p>output，server 接受到後會進行 docker 封鎖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">==</span>&gt; Vault shutdown triggered
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.627Z <span class="o">[</span>INFO<span class="o">]</span>  core: marked as sealed
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.627Z <span class="o">[</span>INFO<span class="o">]</span>  core: pre-seal teardown starting
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.627Z <span class="o">[</span>INFO<span class="o">]</span>  rollback: stopping rollback manager
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.628Z <span class="o">[</span>INFO<span class="o">]</span>  core: pre-seal teardown <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.628Z <span class="o">[</span>INFO<span class="o">]</span>  core: stopping cluster listeners
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.628Z <span class="o">[</span>INFO<span class="o">]</span>  core.cluster-listener: forwarding rpc listeners stopped
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.641Z <span class="o">[</span>INFO<span class="o">]</span>  core.cluster-listener: rpc listeners successfully shut down
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.641Z <span class="o">[</span>INFO<span class="o">]</span>  core: cluster listeners successfully shut down
</span></span><span class="line"><span class="cl">2023-09-20T13:06:28.641Z <span class="o">[</span>INFO<span class="o">]</span>  core: vault is sealed
</span></span></code></pre></div><p>如果有啟用 storage backend 的話，vault 資料或留存在 storage &ldquo;file&rdquo; 上，重啟不會如 dev server in-memory storage 一樣，被清空</p>
<h3 id="vault-operator">vault operator</h3>
<p>你可以使用 vault operator 指令來做更多 vault cluster 相關的操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault operator -h
</span></span></code></pre></div><p>你可以使用下列指令產生新的 root token</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault operator generate-root -generate-otp
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">A One-Time-Password has been generated <span class="k">for</span> you and is shown in the OTP field.
</span></span><span class="line"><span class="cl">You will need this value to decode the resulting root token, so keep it safe.
</span></span><span class="line"><span class="cl">Nonce         13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span><span class="line"><span class="cl">Started       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Progress      0/3
</span></span><span class="line"><span class="cl">Complete      <span class="nb">false</span>
</span></span><span class="line"><span class="cl">OTP           eYr...cMqx
</span></span><span class="line"><span class="cl">OTP Length    <span class="m">28</span>
</span></span></code></pre></div><p>vault server log 顯示開始產生 root</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2023-09-20T15:12:08.633Z <span class="o">[</span>INFO<span class="o">]</span>  core: root generation initialized: <span class="nv">nonce</span><span class="o">=</span>13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span></code></pre></div><p>使用 -otp flag，並輸入 unseal key</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault operator generate-root -otp<span class="o">=</span><span class="s2">&#34;...&#34;</span>
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Operation nonce: 13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Unseal Key <span class="o">(</span>will be hidden<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nonce       13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span><span class="line"><span class="cl">Started     <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Progress    1/3
</span></span><span class="line"><span class="cl">Complete    <span class="nb">false</span>
</span></span></code></pre></div><p>持續輸入 3/5 unseal keys，直到取得 encoded token</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Operation nonce: 13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span><span class="line"><span class="cl">Unseal Key <span class="o">(</span>will be hidden<span class="o">)</span>:
</span></span><span class="line"><span class="cl">Nonce            13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span><span class="line"><span class="cl">Started          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Progress         3/3
</span></span><span class="line"><span class="cl">Complete         <span class="nb">true</span>
</span></span><span class="line"><span class="cl">Encoded Token    DS8B...MdGw
</span></span></code></pre></div><p>使用 otp + encoded token 來進行 decode</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vault operator generate-root <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -decode<span class="o">=</span><span class="s2">&#34;DS8B...MdGw&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -otp<span class="o">=</span><span class="s2">&#34;eYr1...cMqx&#34;</span>
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hvs.bDKG...Pnlc
</span></span></code></pre></div><p>vault server log 顯示逞生 root 完成</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">2023-09-20T15:15:40.541Z <span class="o">[</span>INFO<span class="o">]</span>  core: root generation finished: <span class="nv">nonce</span><span class="o">=</span>13ed8986-7b01-323c-0d06-2c32536fb8c1
</span></span></code></pre></div><p>NOTE: 第一把 init root token 還是有效，加上後來生成的第二把，現在有兩把常效期的 root token</p>
<h3 id="清空">清空</h3>
<p>你可以刪除 ./vault/file/，完全清除 vault server 使用的 filesystem storage backend</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">rm -rf ./vault/file/*
</span></span></code></pre></div><p>vault server 本身幾乎是無狀態，清除 storage backend 後就什麼也不剩了</p>
<h3 id="chatgpt">chatGPT</h3>
<p>本段部分內容使用 chatGPT-3.5 翻譯
<a href="https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-deploy" target="_blank" rel="noopener">https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-deploy</a>
<a href="https://hub.docker.com/r/hashicorp/vault" target="_blank" rel="noopener">https://hub.docker.com/r/hashicorp/vault</a>
內容，並由筆者人工校驗</p>
<p>base context</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">我希望你能充當一名繁體中文翻譯，拼寫修正者和改進者。我將用英文與程式語言與你對話，你將翻譯它，並以已糾正且改進的版本回答，以繁體中文表達。我希望你能用更美麗和優雅、高級的繁體中文詞語和句子替換我簡化的詞語和句子。保持意義不變。我只希望你回答糾正和改進，不要寫解釋。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">很重要：不要使用敬語，翻譯結果中若出現&#34;您&#34;，請用&#34;你&#34;取代&#34;您&#34;。
</span></span></code></pre></div><p>result correction</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">部分英文內容為專有名詞，產生的繁體中文翻譯結果中，這些名詞維持英文，不需要翻譯成中文：key，value，certificate，token，policy，policy rule，path，path-based，key rolling，audit，audit trail，plain text，key value，Consul，S3 bucket，Leasing，Renewal，binary，prefix，instance，metadata。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">修正下列翻譯：將 &#34;數據&#34; 改為 &#34;資料&#34;，將 &#34;數據庫&#34; 改為 &#34;資料庫&#34;，將 &#34;數據&#34; 改為 &#34;資料&#34;，將 &#34;訪問&#34; 改為 &#34;存取&#34;，將 &#34;源代碼&#34; 改為 &#34;原始碼&#34;，將 &#34;信息&#34; 改為 &#34;資訊&#34;，將 &#34;命令&#34; 改為 &#34;指令&#34;，將 &#34;禁用&#34; 改為 &#34;停用&#34;，將 &#34;默認&#34; 改為 &#34;預設&#34;。
</span></span></code></pre></div>
    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/zh-hant/tag/vault/">vault</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/iac/">iac</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/workshop/">workshop</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/docker/">docker</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/terraform/">terraform</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/">鐵人賽2023</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/chatgpt/">chatgpt</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2023-09-19-vault-workshop-docker-and-initialization%2F&amp;text=Vault&#43;Workshop&#43;08%3A&#43;Vault&#43;in&#43;Docker&#43;and&#43;Initialization" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2023-09-19-vault-workshop-docker-and-initialization%2F&amp;t=Vault&#43;Workshop&#43;08%3A&#43;Vault&#43;in&#43;Docker&#43;and&#43;Initialization" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=Vault%20Workshop%2008%3A%20Vault%20in%20Docker%20and%20Initialization&amp;body=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2023-09-19-vault-workshop-docker-and-initialization%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2023-09-19-vault-workshop-docker-and-initialization%2F&amp;title=Vault&#43;Workshop&#43;08%3A&#43;Vault&#43;in&#43;Docker&#43;and&#43;Initialization" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=Vault&#43;Workshop&#43;08%3A&#43;Vault&#43;in&#43;Docker&#43;and&#43;Initialization%20https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2023-09-19-vault-workshop-docker-and-initialization%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2023-09-19-vault-workshop-docker-and-initialization%2F&amp;title=Vault&#43;Workshop&#43;08%3A&#43;Vault&#43;in&#43;Docker&#43;and&#43;Initialization" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      <a href="https://chechia.net/"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/e56eaaf62e2112055827c197b938d620?s=200" alt="張哲嘉"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://chechia.net/">張哲嘉</a></h5>
      <h6 class="card-subtitle">Site Reliability Engineer</h6>
      <p class="card-text">我的研究領域包括網站可靠性工程、DevOps、Container和Kubernetes。</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/zh-hant/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/chechiachang" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/chechiachang" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.facebook.com/engineer.from.scratch" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/che-chia-chang-92194a4a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2025 Me. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      由<a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a>支持發布——免費<a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">開源</a>網站，為創作者賦能。
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.f64289d8217e08e3afcd597d60836062.js"></script>




  

  
  

  













  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  

















<script id="page-data" type="application/json">{"use_headroom":true}</script>


  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>









  
  


<script src="/zh-hant/js/wowchemy.min.f5ce063f9bd2e47fdb1e51b445b2fb48.js"></script>







  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">引用</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> 複製
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> 下載
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.9137013a66774049159934c29c3f0205.js" type="module"></script>


















</body>
</html>
