
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    [{"authors":null,"categories":null,"content":"Che-Chia Chang æ˜¯ä¸€ä½å°ˆæ”»æ–¼DevOpsã€å®¹å™¨å’ŒKubernetesé‹ç¶­çš„SREï¼ˆSite Reliability Engineerï¼‰å°ˆå®¶ã€‚ä»–æ˜¯CNTUGï¼ˆContainer Native Taiwan User Groupï¼‰ã€DevOps Taipeiã€GDS Taipeiä»¥åŠGolang Taiwan Meetupçš„ç©æ¥µæˆå“¡ã€‚\nè‡ª2020å¹´èµ·ï¼Œä»–ç²å¾—äº†Microsoftæœ€æœ‰åƒ¹å€¼å°ˆå®¶ï¼ˆMVPï¼‰çš„ç¨±è™Ÿã€‚\n","date":-62135596800,"expirydate":-62135596800,"kind":"term","lang":"zh-hant","lastmod":1694442834,"objectID":"2525497d367e79493fd32b198b28f040","permalink":"","publishdate":"0001-01-01T00:00:00Z","relpermalink":"","section":"authors","summary":"Che-Chia Chang æ˜¯ä¸€ä½å°ˆæ”»æ–¼DevOpsã€å®¹å™¨å’ŒKubernetesé‹ç¶­çš„SREï¼ˆSite Reliability Engineerï¼‰å°ˆå®¶ã€‚ä»–æ˜¯CNTUGï¼ˆContainer Native Taiwan User Groupï¼‰ã€DevOps Taipeiã€GDS Taipeiä»¥åŠGolang Taiwan Meetupçš„ç©æ¥µæˆå“¡ã€‚\nè‡ª2020å¹´èµ·ï¼Œä»–ç²å¾—äº†Microsoftæœ€æœ‰åƒ¹å€¼å°ˆå®¶ï¼ˆMVPï¼‰çš„ç¨±è™Ÿã€‚","tags":null,"title":"å¼µå“²å˜‰","type":"authors"},{"authors":[],"categories":["generative","ai"],"content":" RAG workshop è¡Œå‰é€šçŸ¥ æœ¬æ¬¡ workshop ä»¥ hands-on çš„æ–¹å¼é€²è¡Œï¼Œç´¯ç©æ“ä½œç¶“é©—ç‚ºä¸»ï¼Œè¬›è§£èˆ‡èªªæ˜ç‚ºè¼”ã€‚è§€å¿µå…§å®¹æœ‰æº–å‚™æ•™æï¼Œéœ€è¦åƒèˆ‡è€…è‡ªè¡Œé–±è®€ã€‚è¬›å¸«æœƒå…è²»æä¾›\nAzure OpenAI models API key (gpt-4.1, gpt-4.1-mini, text-embedding-3, text-embedding-ada-002â€¦) Azure VM ä¾›åŒå­¸é ç«¯æ“ä½œä½¿ç”¨ â€“\u0026gt; æŠ•å½±ç‰‡èˆ‡æ•™æ \u0026lt;â€“ Workshop åŸºæœ¬éœ€æ±‚ æœ‰è‡ªå·±çš„é›»è…¦ï¼Œå¯ä»¥ä¸Šç¶² é¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ï¼Œåœ¨ docker å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ é¸é …2: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ï¼Œé ç«¯é€£ç·šè¬›å¸«æä¾›çš„ VMï¼Œåœ¨VM ä¸­å•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒ æœƒä½¿ç”¨ docker æœƒä½¿ç”¨ python èˆ‡ jupyter notebook æœƒä½¿ç”¨ chatgpt.com å”åŠ©é™¤éŒ¯ é¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ åœ¨ workshop é–‹å§‹å‰ï¼Œåœ¨è‡ªå·±çš„é›»è…¦ä¸Š\nå®‰è£ docker git clone github repository å•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒï¼Œä¸‹è¼‰ docker images é–‹å•Ÿç€è¦½å™¨ï¼Œé€£ç·šåˆ° Jupyter Notebookï¼Œtoken workshop1234! åœ¨ Jupyter Notebook ä¸­ï¼Œå®‰è£æ‰€éœ€çš„ Python å¥—ä»¶ git clone https://github.com/chechiachang/rag-workshop.git cd rag-workshop docker compose up -d docker exec -it notebook pip install pandas openai qdrant_client tqdm tenacity wget tenacity unstructured markdown ragas sacrebleu langchain_qdrant langchain-openai langchain_openai langchain_community tiktoken é¸é …2: ä½¿ç”¨é ç«¯ VM å»ºè­°ä½¿ç”¨å€‹äººé›»è…¦ï¼Œç•¢ç«Ÿå…è²» VM åé¡ç¾å ´æœ‰é™ éœ€è¦æœ‰è‡ªå·±çš„é›»è…¦ï¼Œæœ‰ç©©å®šçš„ç¶²è·¯ï¼Œå¯ä»¥é€£ç·šåˆ°é ç«¯ VM éœ€è¦è¨»å†Š tunnel å·¥å…·ï¼ˆæ²’æœ‰æ¥­é…ï¼‰ngrok ç™»å…¥ Login -\u0026gt; å·¦æ‰‹é‚Š Identity \u0026amp; Access -\u0026gt; Authtokens -\u0026gt; Add Tunnel authtoken -\u0026gt; è¨˜åœ¨å®‰å…¨çš„åœ°æ–¹ ä¹Ÿå¯ä»¥ä½¿ç”¨ pinggyï¼Œä½†å…è²»æœ‰é™æ™‚ æŠ•å½±ç‰‡èˆ‡æ•™ææœƒæ”¾åœ¨ç¶²ç«™ä¸Š https://chechia.net/zh-hant/slides/2025-06-05-devops-rag-internal-ai/\nå¦‚ä½•å­˜å– VM ä¹Ÿæœƒæ”¾åœ¨æ•¨å½±ç‰‡è£¡\nRAG workshop è¡Œå‰é€šçŸ¥å®Œï¼Œå¤§å®¶ç•¶å¤©ç¾å ´è¦‹ Info é–‹ç™¼åœ˜éšŠéœ€è¦å°‡ç¶“é©—èˆ‡çŸ¥è­˜ï¼Œé€éæ–‡ä»¶åŒ–çš„æ–¹å¼ä¿å­˜ä¸‹ä¾†ï¼Œä»¥ä¾¿æœªä¾†æŸ¥è©¢èˆ‡å­¸ç¿’ã€‚ç„¶è€Œï¼Œä¼æ¥­å…§éƒ¨æ–‡ä»¶å¾€å¾€åˆ†æ•£æ–¼ Confluenceã€Google Driveã€Notion ç­‰å¹³å°ï¼Œå‚³çµ±é—œéµå­—æœå°‹é›£ä»¥å¿«é€Ÿç²å–æº–ç¢ºè³‡è¨Šï¼Œå°è‡´æºé€šæˆæœ¬é«˜ã€é–‹ç™¼æµç¨‹å—é˜»ã€‚åˆæˆ–æ˜¯ï¼Œç•¶é–‹ç™¼åœ˜éšŠéœ€è¦æŸ¥è©¢ç‰¹å®šçŸ¥è­˜æ™‚ï¼Œå¾€å¾€éœ€è¦é€é Slackã€Email ç­‰æ–¹å¼è©¢å•åŒäº‹ï¼Œé€™æ¨£çš„æºé€šæˆæœ¬ä¸åƒ…æµªè²»æ™‚é–“ï¼Œä¹Ÿå®¹æ˜“é€ æˆè³‡è¨Šä¸å°ç¨±ã€‚\nå­¸å“¡å°‡å­¸æœƒå¦‚ä½•åˆ©ç”¨ RAG æŠ€è¡“ï¼Œçµåˆ OpenAIã€LangChainã€Qdrant å‘é‡æ•¸æ“šåº«ï¼Œæ§‹å»ºä¼æ¥­å…§éƒ¨æ–‡æª”çš„æ™ºèƒ½çŸ¥è­˜åº«ï¼Œä¸¦èƒ½è¨­è¨ˆèˆ‡å¯¦ä½œä¸€å€‹åŸºæ–¼è‡ªç„¶èªè¨€è™•ç†ï¼ˆNLPï¼‰çš„æŸ¥è©¢ç³»çµ±ï¼Œä¾†æå‡é–‹ç™¼åœ˜éšŠçš„æ•ˆç‡èˆ‡çŸ¥è­˜ç®¡ç†èƒ½åŠ›ã€‚\nä»€éº¼æ˜¯ RAGï¼Ÿ ä»‹ç´¹ RAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€è¡“å¦‚ä½•çµåˆæª¢ç´¢èˆ‡ç”Ÿæˆæå‡å•ç­”æº–ç¢ºæ€§ã€‚ ç‚ºä»€éº¼ä¼æ¥­éœ€è¦æ™ºèƒ½çŸ¥è­˜åº«ï¼Ÿ RAG çš„æ‡‰ç”¨å ´æ™¯ï¼šçŸ¥è­˜åº«å»ºç«‹ã€é–‹ç™¼æ”¯æ´ã€æŠ€è¡“æ±ºç­–ç­‰ã€‚ Python èˆ‡ OpenAIï¼š ä½¿ç”¨ OpenAI API æ¶æ§‹èˆ‡èªè¨€æ¨¡å‹ï¼Œå¿«é€Ÿæ§‹å»ºç”Ÿæˆæ¨¡å‹ LangChainï¼šä»‹ç´¹ LangChain æ¡†æ¶å¦‚ä½•ç°¡åŒ– RAG å¯¦ç¾ å¦‚ä½•åˆ©ç”¨ LangChain æ•´åˆå¤šç¨®æ•¸æ“šæºèˆ‡ç”Ÿæˆæ¨¡å‹ Qdrant å‘é‡æ•¸æ“šåº«ï¼š å‘é‡æ•¸æ“šåº«çš„æ¦‚å¿µèˆ‡ä½œç”¨ å¦‚ä½•åˆ©ç”¨ Qdrant å„²å­˜èˆ‡æª¢ç´¢å…§éƒ¨æ–‡æª”çš„åµŒå…¥å‘é‡ æ§‹å»º RAG ç³»çµ±ï¼šå¯¦ä½œæ­¥é©Ÿèˆ‡æ¼”ç¤º æ•¸æ“šé è™•ç†èˆ‡æ–‡æª”è½‰æ› å°‡è™•ç†å¾Œçš„æ–‡æœ¬è½‰æ›ç‚ºå‘é‡è¡¨ç¤ºï¼ˆembeddingï¼‰ åˆ©ç”¨ Qdrant å‘é‡æ•¸æ“šåº«å„²å­˜é€™äº›åµŒå…¥ä¸¦åŸ·è¡Œæª¢ç´¢ ä½¿ç”¨ LangChain çµåˆ OpenAI æ¨¡å‹èˆ‡ Qdrantï¼Œè£½ä½œè‡ªå‹•åŒ–å•ç­”ç³»çµ± Target group æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†å¯¦ä½œåŸºæœ¬ RAG AI Agentã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\nå¿…å‚™çŸ¥è­˜ï¼šLinux æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼ŒDocker æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼Œæœƒä½¿ç”¨ SSH é€£ç·š / Bash / dockerã€‚\nå·¥ä½œåŠçµæŸå¾Œï¼Œå­¸å“¡å°‡èƒ½å¤ ï¼š\nç†è§£ä¸¦å¯¦ä½œ RAG æŠ€è¡“ï¼Œå°‡å…§éƒ¨æ–‡æª”è½‰åŒ–ç‚ºæ™ºèƒ½çŸ¥è­˜åº« ä½¿ç”¨ Pythonã€LangChain å’Œ OpenAI æ§‹å»ºåŸºæ–¼æª¢ç´¢çš„å•ç­”ç³»çµ± åˆ©ç”¨ Qdrant å‘é‡æ•¸æ“šåº«é€²è¡Œé«˜æ•ˆæª¢ç´¢ï¼Œæå‡é–‹ç™¼æµç¨‹ä¸­çš„çŸ¥è­˜ç®¡ç†æ•ˆç‡ã€‚ é€™æ¨£çš„å·¥ä½œåŠçµæ§‹èƒ½å¤ å¹³è¡¡ç†è«–èˆ‡å¯¦è¸ï¼Œä¸¦ç‚ºå­¸å“¡æä¾›å¯¦éš›å‹•æ‰‹æ“ä½œçš„æ©Ÿæœƒã€‚ Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n2024 Ithome Kubernetes Summit 2024 Ithome Cloud Summit 2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","date":1749127500,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1748791844,"objectID":"c9ec59f2b96e2a58ae8efef1a4a0913d","permalink":"https://chechia.net/zh-hant/talk/workshop-rag%E6%89%93%E9%80%A0%E4%BC%81%E6%A5%ADai%E7%9F%A5%E8%AD%98%E5%BA%AB%E6%8A%8A%E4%B8%80%E7%94%B2%E5%AD%90%E5%8A%9F%E5%8A%9B%E5%82%B3%E7%B5%A6%E6%96%B0%E4%BA%BA/","publishdate":"2025-05-01T00:00:00Z","relpermalink":"/zh-hant/talk/workshop-rag%E6%89%93%E9%80%A0%E4%BC%81%E6%A5%ADai%E7%9F%A5%E8%AD%98%E5%BA%AB%E6%8A%8A%E4%B8%80%E7%94%B2%E5%AD%90%E5%8A%9F%E5%8A%9B%E5%82%B3%E7%B5%A6%E6%96%B0%E4%BA%BA/","section":"event","summary":"å­¸å“¡å°‡å­¸æœƒå¦‚ä½•åˆ©ç”¨ RAG æŠ€è¡“ï¼Œçµåˆ OpenAIã€LangChainã€Qdrant å‘é‡æ•¸æ“šåº«ï¼Œæ§‹å»ºä¼æ¥­å…§éƒ¨æ–‡æª”çš„æ™ºèƒ½çŸ¥è­˜åº«ï¼Œä¸¦èƒ½è¨­è¨ˆèˆ‡å¯¦ä½œä¸€å€‹åŸºæ–¼è‡ªç„¶èªè¨€è™•ç†ï¼ˆNLPï¼‰çš„æŸ¥è©¢ç³»çµ±ï¼Œä¾†æå‡é–‹ç™¼åœ˜éšŠçš„æ•ˆç‡èˆ‡çŸ¥è­˜ç®¡ç†èƒ½åŠ›ã€‚","tags":["openai","generative","ai","kubernetes","devops"],"title":"Workshop: RAGæ‰“é€ ä¼æ¥­AIçŸ¥è­˜åº«ï¼šæŠŠä¸€ç”²å­åŠŸåŠ›å‚³çµ¦æ–°äºº","type":"event"},{"authors":[],"categories":["devops"],"content":"RAG workshop è¡Œå‰é€šçŸ¥ï¼šåŸºæœ¬éœ€æ±‚ ç•¶å¤©å¸¶è‡ªå·±çš„é›»è…¦ã€‚ç•¶å¤©å»ºè­°è‡ªå‚™æ‰‹æ©Ÿç¶²è·¯ é¸é …1: ç”¨é›»è…¦åœ¨ docker é‹è¡Œé–‹ç™¼ç’°å¢ƒ é¸é …2: ç”¨é›»è…¦é ç«¯é€£ç·šè¬›å¸«æä¾›çš„ VMï¼Œåœ¨é ç«¯VM ä¸­é‹è¡Œ docker é–‹ç™¼ç’°å¢ƒ æœƒä½¿ç”¨ docker æœƒä½¿ç”¨ python èˆ‡ jupyter notebook é¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ ğŸ’» åœ¨ workshop é–‹å§‹å‰ï¼Œåœ¨è‡ªå·±çš„é›»è…¦ä¸Š å®‰è£ docker git clone æ•™æ å•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒï¼Œä¸‹è¼‰ docker images å®‰è£æ‰€éœ€çš„ Python å¥—ä»¶ é–‹å•Ÿç€è¦½å™¨ï¼Œé€£ç·šåˆ°http://localhost:8888 git clone https://github.com/chechiachang/rag-workshop.git cd rag-workshop docker compose up -d docker exec -it notebook pip install pandas openai qdrant_client tqdm tenacity wget tenacity unstructured markdown ragas sacrebleu langchain_qdrant langchain-openai langchain_openai langchain_community tiktoken ipywidgets ç™»å…¥token=\u0026#34;workshop1234!\u0026#34; é¸é …2: ä½¿ç”¨é ç«¯ VM æœ‰è‡ªå·±çš„é›»è…¦ï¼Œç•¶å¤©å»ºè­°è‡ªå‚™æ‰‹æ©Ÿç¶²è·¯ï¼Œé€£ç·šåˆ°é ç«¯ VM æå‰è¨»å†Š tunnel å·¥å…·ï¼ˆæ²’æœ‰æ¥­é…ï¼‰ Ngrok ç™»å…¥ Login -\u0026gt; å·¦æ‰‹é‚Š Identity \u0026amp; Access -\u0026gt; Authtokens -\u0026gt; Add Tunnel authtoken -\u0026gt; è¨˜åœ¨å®‰å…¨çš„åœ°æ–¹ ä¹Ÿå¯ä»¥ä½¿ç”¨ Pinggyï¼Œä½†å…è²»æœ‰é™æ™‚ å»ºè­° å„ªå…ˆä½¿ç”¨å€‹äººé›»è…¦ã€‚æœƒç›¡é‡æä¾›å…è²» VM åé¡ï¼Œä½†ä¾åƒèˆ‡äººæ•¸ä¸ä¿è­‰ç¾å ´æœ‰ åœ¨å®¶å…ˆè©¦è·‘ä¸€éï¼ŒæŠŠ docker image è·Ÿ pip å¥—ä»¶éƒ½ä¸‹è¼‰å¥½ï¼Œç¾å ´è¦è¼‰å¾ˆä¹… è©¦å®Œå¾Œè¨˜å¾—é—œæ‰ ngrokï¼Œä»¥å…ç”¨å®Œæ¯æœˆçš„å…è²»é¡åº¦ äº‹å…ˆçœ‹å®Œå…§å®¹è¦ºå¾—å¤ªç°¡å–®å¯ä»¥ä¸ç”¨ä¾†ï¼Œä½†æ­¡è¿æœƒå¾Œæ‰¾æˆ‘èŠå¤©ï¼¸ï¼¤ æŠ•å½±ç‰‡èˆ‡æ•™æèˆ‡å®Œæ•´ç¨‹å¼ç¢¼æ”¾åœ¨ç¶²ç«™ä¸Š https://chechia.net https://chechia.net/zh-hant/slides/2025-06-05-devops-rag-internal-ai/ ğŸ“ Github æŠ•å½±ç‰‡åŸå§‹ç¢¼èˆ‡è¬›ç¨¿ ä»¥ä¸‹æ˜¯ RAG Workshop ç•¶å¤©å…§å®¹ å¯ä»¥å…ˆçœ‹ï¼Œä¹Ÿå¯ä»¥ç•¶å¤©å†çœ‹\nRAG Workshop é—œæ–¼æˆ‘ Che Chia Chang SRE @ Maicoin Microsoft MVP å€‹äººéƒ¨è½æ ¼chechia.net æŠ•å½±ç‰‡è¬›ç¨¿ï¼Œéµäººè³½ (Terraform / Vault æ‰‹æŠŠæ‰‹å…¥é–€ / Etcd Workshop) ğŸ“ ä»Šå¤©çš„æŠ•å½±ç‰‡åŸå§‹ç¢¼èˆ‡è¬›ç¨¿ RAG Workshop æµç¨‹ 10min - ç’°å¢ƒè¨­å®šï¼šç¢ºå®šåƒèˆ‡è€…éƒ½æœ‰è¨­å®šå¥½é–‹ç™¼ç’°å¢ƒ 10min - ç‚ºä»€éº¼éœ€è¦ RAGï¼ˆRetrieval-Augmented Generationï¼‰ 10min - Notebook 2 Embedding èˆ‡å‘é‡æ•¸æ“šåº« 10min - Notebook 3 Embedding Search 10min - Notebook 4 DIY 10min - Notebook 5 Evaluation 10min - Notebook 6 k8s RAG QA 20min - DIY + Q\u0026amp;A é¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ æœ‰åœ¨å®¶å…ˆè©¦è·‘ä¸€éï¼Œæ‡‰è©²å¯ä»¥åœ¨æœ¬åœ°å­˜å– Notebook http://localhost:8888 åˆ° workshop.chechia.net å–å¾— OpenAI Key å¯ä»¥è©¦è‘—è·‘ notebook 2-5 å¿˜è¨˜æ€éº¼å•Ÿå‹•ï¼Œå¯ä»¥å›åˆ°æŠ•å½±ç‰‡æœ€é–‹å§‹ notebook token: workshop1234! AZURE_OPENAI_API_KEY=\u0026#34;\u0026#34; AZURE_OPENAI_ENDPOINT=\u0026#34;\u0026#34; é¸é …2: ä½¿ç”¨é ç«¯ VM è‡³workshop.chechia.net é ˜å–ä¸€å° VM ä¸¦ç°½å googel sheet å·¦é‚Š urlï¼Œé–‹å•Ÿ bastion é€£ç·š Protocol: SSHï¼Œport 22ï¼Œauthentication type: password å¸³è™Ÿå¯†ç¢¼åœ¨workshop.chechia.net é¸é …2: ä½¿ç”¨ ngrok é€£ç·šåˆ° jupyter notebook é€²å…¥ VM å¾Œï¼Œä¿®æ”¹ä¸‹é¢ ngrok authtokenã€‚æŒ‡ä»¤ä¸€è¡Œä¸€è¡Œè²¼ä¸Šï¼ˆå³éµï¼‰åˆ° bastion ä¸­åŸ·è¡Œ é€é https://4d11-52-230-24-207.ngrok-free.app/ å°±å¯ä»¥ä½¿ç”¨ notebook (æ¯å€‹äººä¸ä¸€æ¨£) cd rag-workshop NGROK_AUTHTOKEN=\u0026lt;æ”¹æˆä½ çš„token\u0026gt; sed -i \u0026#34;s/your-token/$NGROK_AUTHTOKEN/\u0026#34; docker-compose.yaml docker compose up -d docker logs ngrok t=2025-06-02T06:17:41+0000 lvl=info msg=\u0026#34;started tunnel\u0026#34; obj=tunnels name=command_line addr=http://notebook:8888 url=https://4d11-52-230-24-207.ngrok-free.app ä»¥ä¸Šæ˜¯ Workshop ç’°å¢ƒè¨­å®š å¾Œé¢ä¸Šèª²éƒ½é€éé€™å€‹ç¶²å€æ“ä½œ é‚„æ²’æœ‰çœ‹åˆ° jupyter notebook çš„äººï¼Œè«‹èˆ‰æ‰‹ RAG Workshop æµç¨‹ ç’°å¢ƒè¨­å®šï¼šç¢ºå®šåƒèˆ‡è€…éƒ½æœ‰è¨­å®šå¥½é–‹ç™¼ç’°å¢ƒ ç‚ºä»€éº¼éœ€è¦ RAGï¼ˆRetrieval-Augmented Generationï¼‰ Embedding èˆ‡å‘é‡æ•¸æ“šåº« Embedding Search DIY Evaluation å¯¦éš›æ‡‰ç”¨: ä»¥ k8s official docs ç‚ºä¾‹ DIY + Q\u0026amp;A ä»€éº¼æ˜¯ RAG RAGï¼ˆRetrieval-Augmented Generation æª¢ç´¢å¢å¼·ç”Ÿæˆï¼‰çµåˆæª¢ç´¢ç³»çµ±èˆ‡ç”Ÿæˆå¼æ¨¡å‹ï¼ˆå¦‚ GPTï¼‰çš„è‡ªç„¶èªè¨€è™•ç†æ¶æ§‹ï¼Œåœ¨ç”Ÿæˆç­”æ¡ˆæ™‚å¼•ç”¨å¤–éƒ¨çŸ¥è­˜ï¼Œä½¿æ¨¡å‹å›ç­”æ›´æº–ç¢ºä¸”å…·äº‹å¯¦æ ¹æ“š Retrievalï¼ˆæª¢ç´¢ï¼‰ï¼š å¾ä¸€å€‹å¤–éƒ¨çŸ¥è­˜åº«ï¼ˆå¦‚æ–‡ä»¶ã€å‘é‡è³‡æ–™åº«ç­‰ï¼‰ä¸­æ‰¾åˆ°èˆ‡å•é¡Œç›¸é—œçš„è³‡è¨Šã€‚é€šå¸¸æœƒç”¨èªæ„å‘é‡ï¼ˆembeddingsï¼‰åšç›¸ä¼¼åº¦æœå°‹ã€‚ Generationï¼ˆç”Ÿæˆï¼‰ï¼š æŠŠæª¢ç´¢åˆ°çš„å…§å®¹èˆ‡ä½¿ç”¨è€…å•é¡Œä¸€èµ·ä¸Ÿçµ¦ LLMï¼ˆå¦‚ GPTã€Claude ç­‰ï¼‰å»ç”Ÿæˆç­”æ¡ˆã€‚ç”Ÿæˆçš„å…§å®¹æœƒæ›´å…·äº‹å¯¦æ ¹æ“šï¼Œä¸¦èƒ½å¼•ç”¨å…·é«”è³‡æ–™ã€‚ https://cookbook.openai.com/images/llamaindex_rag_overview.png\nçŸ¥è­˜ç²å–æ•ˆç‡åœ¨ DevOps çš„é›£é¡Œ åœ¨å¿«é€Ÿè®Šå‹•ã€è³‡è¨Šåˆ†æ•£çš„ç’°å¢ƒä¸­ï¼Œé›£ä»¥å³æ™‚å–å¾—éœ€è¦çš„çŸ¥è­˜ã€‚ã€Œæœ‰ä½†æ‰¾ä¸åˆ°ã€çœ‹ä¸æ‡‚ã€ç”¨ä¸èµ·ä¾†ã€\nçŸ¥è­˜åˆ†æ•£åœ¨å¤šå€‹ç³»çµ±ã€æ ¼å¼èˆ‡å·¥å…·ä¸­ çŸ¥è­˜å¤šç‚ºã€Œéœæ…‹æ–‡ä»¶ã€ï¼Œé›£ä»¥äº’å‹•å•ç­”ï¼Œèˆ‰ä¾‹ï¼Œæˆ–æ˜¯æ›å¥è©±èªª éš±æ€§çŸ¥è­˜æœªè¢«ç³»çµ±åŒ–å„²å­˜(ä¾‹å¦‚ï¼šå£é ­å‚³æ‰¿ã€slack è¨è«–ã€æœƒè­°ç´€éŒ„ç­‰) æŸ¥è©¢æµç¨‹èˆ‡é–‹ç™¼æµç¨‹è„«ç¯€ æƒ…å¢ƒï¼šæ–°äººå·¥ç¨‹å¸«è¦å¦‚ä½•åˆ° k8s doc æŸ¥åˆ°æƒ³è¦çš„å…§å®¹ï¼Ÿ æœ‰å•é¡Œå» google / stack overflow éœ€è¦æœå°‹å¼•æ“(k8s doc æœ‰æä¾›ï¼Œä½†å…§éƒ¨æ–‡ä»¶ç³»çµ±ä¸ä¸€å®šæœ‰) éœ€è¦é—œéµå­—(æ–°äººæ€éº¼çŸ¥é“è¦æŸ¥ Dynamic Persistent Volume Resizing) å”åŠ©ç†è§£ï¼ˆèˆ‰ä¾‹ï¼Œæ›å¥è©±èªªï¼‰ è·¨èªè¨€é–€æª» k8s doc æœ‰æä¾›é—œéµå­—æœå°‹ï¼Œé€™å€‹æœå°‹åŠŸèƒ½æ˜¯æ€éº¼åšçš„ï¼Ÿ Programmable Search Engineï¼ˆPSEï¼‰https://developers.google.com/custom-search/docs/tutorial/introduction Fulltext Search Engine ä¾‹å¦‚ elasticsearch ä½¿ç”¨ Lucene https://kubernetes.io/search/\næƒ…å¢ƒï¼šSenior å·¥ç¨‹å¸«è¦å¦‚ä½•åˆ†äº«çŸ¥è­˜ï¼Ÿ ã€æˆ‘æœ‰å¯«ä¸€ç¯‡æ–‡ä»¶åœ¨æŸå€‹åœ°æ–¹ï¼Œä½ æ‰¾ä¸€ä¸‹ã€ ã€æˆ‘å¿˜è¨˜å»å¹´ç‚ºä»€éº¼é€™æ¨£åšäº†ã€ ã€æˆ‘å» Slack ä¸Šæ‰¾ä¸€ä¸‹ã€ ã€ä½ è¦ä¸è¦å…ˆå»å• ChatGPTï¼Ÿã€ æˆ‘å€‘ä¸æ˜¯æ‡¶ï¼Œè€Œæ˜¯ç¾åœ¨è¦è§£ç­”è¨±å¤šåŸºæœ¬å•é¡Œï¼ŒLLM å›ç­”å¾—æ¯”äººå¥½ RAG è®“ DevOps æ›´æ™ºæ…§çš„å³æ™‚åæ‡‰ æå‡çŸ¥è­˜ç²å–æ•ˆç‡: å…§éƒ¨æ–‡æª”çŸ¥è­˜AIåŠ©æ‰‹ çŸ¥è­˜ç•™å­˜èˆ‡æ–°äºº Onboarding åŠ é€Ÿæ•…éšœæ’æŸ¥: æ ¹æ“šéŒ¯èª¤è¨Šæ¯è‡ªå‹•å¾ Runbook ä¸­æª¢ç´¢è™•ç†æ–¹å¼ å„ªåŒ–æµç¨‹è‡ªå‹•åŒ–èˆ‡æå‡æ±ºç­–å“è³ª: é€šè¨Šè»Ÿé«”å°è©± botï¼Œè‡ªå‹•ç”Ÿæˆå»ºè­° DevOps AI Copilot ä¸æ‡‰è©²åƒåœ–æ›¸é¤¨å®ˆé–€å“¡ç­‰äººä¾†å€Ÿæ›¸ï¼Œ è€Œæ‡‰è©²åƒå°èˆªç³»çµ±ï¼Œåœ¨ä½ é–‹è»Šæ™‚ä¸»å‹•å‘Šè¨´ä½ ï¼šå‰æ–¹æœ‰å½é“ã€‚\nRAG + Context-Aware Knowledge Copilot\nåŸºæœ¬ä¸Šæˆ‘å€‘æœŸå¾…çš„è§£æ±ºæ–¹æ¡ˆæ˜¯é€™æ¨£ RAG vs å…¶ä»–å·¥å…· éœ€è¦å·¥å…·æå‡çŸ¥è­˜ç²å–æ•ˆç‡ï¼Œå¦‚ä½•é¸æ“‡ RAG æˆ–æ˜¯å…¶ä»– non-LLM å·¥å…·ï¼Ÿä¾‹å¦‚ search engine / fulltext search engine / search algorithm ç‰¹å®šä»»å‹™çš„æ•ˆèƒ½æ˜¯å¦å„ªæ–¼äººé¡ å“ªè£¡é©åˆç”¨ RAGï¼Œå“ªè£¡é©åˆç”¨ non-LLM å·¥å…· ä¾‹å¦‚ google search engine ä½†ç•¶ç„¶æˆ‘å€‘ä¸çŸ¥é“ä»–èƒŒå¾Œçš„å¯¦ä½œ elasticsearch / lucene / fulltext search engine GNU grep çš„ Boyerâ€“Moore string-search algorithm é©åˆç”¨ RAG çš„æƒ…å¢ƒï¼šå®¢æœå•ç­”ã€æŠ€è¡“æœå°‹ã€çŸ¥è­˜å‹ Chatbotã€å…§éƒ¨çŸ¥è­˜å°èˆªã€‚ é©åˆç”¨å‚³çµ±ç¨‹å¼çš„æƒ…å¢ƒï¼šé‡‘æµæ§åˆ¶ã€æµç¨‹å¼•æ“ã€å¸³å‹™ç³»çµ±ã€å®‰å…¨æ§åˆ¶ã€‚ æœ‰äº†å¤§èªè¨€æ¨¡å‹å¾Œ å» google -\u0026gt; å…ˆå• chatgptï¼Œåˆæ­¥å•ç­”ç†è§£å•é¡Œï¼Œæ‰¾åˆ°é—œéµå­— éœ€è¦æœå°‹å¼•æ“ -\u0026gt; chatgpt æ•´åˆï¼Œç›´æ¥ä¸Šç¶²æœå°‹ éœ€è¦é—œéµå­— -\u0026gt; chatgpt å¹«ä½ æ‰¾åˆ°é—œéµå­— å”åŠ©ç†è§£ -\u0026gt; chatgpt èˆ‰ä¾‹ï¼Œæ›å¥è©±èªª è·¨èªè¨€é–€æª» -\u0026gt; chatgpt ç¿»è­¯ chatgpt æœƒç”¨é€šé †çš„èªè¨€å›ç­”å•é¡Œï¼ˆå„ªæ–¼å¹³å‡å·¥ç¨‹å¸«ï¼‰ chatgpt æœƒç”¨é€šé †çš„èªè¨€ï¼Œå¿«é€Ÿï¼ˆæ•¸ç§’å…§ï¼‰ä¸Šç¶²æœå°‹ï¼Œå›ç­”å•é¡Œ éç¨‹ä¸­ä¸å­å…¶ç…©åœ°å•ç­”ï¼Œæ›å¥è©±èªª å›ç­”çš„æ ¼å¼é«˜åº¦å®¢è£½åŒ– LLM ä¸å…·å‚™å°ˆæ¥­çŸ¥è­˜ã€‚ç¼ºä¹å…§å®¹æ ¹æ“šæ™‚ï¼Œå®¹æ˜“ç”¢ç”Ÿå¹»è¦º(hallucination) LLMï¼ˆå¤§å‹èªè¨€æ¨¡å‹ï¼‰æœ¬èº«ä¸¦ä¸å…·å‚™äº‹å¯¦çŸ¥è­˜ï¼Œè€Œæ˜¯ä¾è³´è¨“ç·´æ™‚çš„èªæ–™èˆ‡æç¤ºè¼¸å…¥ä¾†ç”Ÿæˆå›ç­”ã€‚ç•¶ç¼ºä¹æ˜ç¢ºä¸Šä¸‹æ–‡æˆ–å…§å®¹æ ¹æ“šæ™‚ï¼ŒLLM å®¹æ˜“å‡ºç¾ã€Œå¹»è¦ºã€ç¾è±¡ï¼Œå³ç”Ÿæˆçœ‹ä¼¼åˆç†ä½†å¯¦éš›ä¸æ­£ç¢ºçš„è³‡è¨Šã€‚å°ˆæ¥­é ˜åŸŸå•é¡Œè‹¥æœªæä¾›æº–ç¢ºè³‡æ–™æ”¯æ’ï¼Œä¹Ÿå®¹æ˜“å°è‡´éŒ¯èª¤å›ç­”ã€‚ RAG Workshop æµç¨‹ ç’°å¢ƒè¨­å®šï¼šç¢ºå®šåƒèˆ‡è€…éƒ½æœ‰è¨­å®šå¥½é–‹ç™¼ç’°å¢ƒ ç‚ºä»€éº¼éœ€è¦ RAGï¼ˆRetrieval-Augmented Generationï¼‰ RAG åœ¨ã€Œæ–‡ä»¶æª¢ç´¢èˆ‡æç¤ºã€ä¸Šå„ªæ–¼äººé¡ LLM è£œå¼·å·¥ç¨‹å¸«çš„èªè¨€èƒ½åŠ› Embedding èˆ‡å‘é‡æ•¸æ“šåº« Embedding Search DIY Evaluation k8s RAG QA.ipynb RAG Workshop æµç¨‹ ç¢ºå®šåƒèˆ‡è€…éƒ½æœ‰è·‘ä¸€å¥—RAGèµ·ä¾† Evaluation k8s RAG QA.ipynb å¦‚ä½•è©•ä¼° RAG ç³»çµ±çš„å“è³ª? äººäººéƒ½æœƒä¸‹ promptï¼Œä½†æ˜¯èª°çš„ prompt æ›´å¥½ï¼Ÿæˆ–æ˜¯æ²’å·®åˆ¥ï¼Ÿ å¦‚ä½•é¸æ“‡ vector store çš„ chunking ç­–ç•¥ï¼Ÿ å“ªå€‹ retriever æ›´å¥½ï¼Ÿ è¦å¦‚ä½•æŒçºŒæ”¹å–„ RAG ç³»çµ±ï¼Ÿä¸‹å€‹è¿­ä»£çš„æ”¹å–„æ–¹å‘æ˜¯ä»€éº¼ï¼Ÿ æ˜¯å¦ç¬¦åˆ production criteriaï¼Ÿ è©•ä¼°ï¼šç¢ºä¿å›ç­”å“è³ªå¯é æ€§èˆ‡å¯æ§æ€§ ä¿è­‰æ­£ç¢ºæ€§ï¼šæª¢ç´¢å‡ºçš„è³‡è¨Šæ˜¯æ­£ç¢ºçš„ï¼Œ â€¦","date":1748738700,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1749022306,"objectID":"e3d0f4cf5337633903d4bd2c8ee7ca49","permalink":"https://chechia.net/zh-hant/slides/2025-06-05-devops-rag-internal-ai/","publishdate":"2025-06-01T00:45:00Z","relpermalink":"/zh-hant/slides/2025-06-05-devops-rag-internal-ai/","section":"slides","summary":"å­¸å“¡å°‡å­¸æœƒå¦‚ä½•åˆ©ç”¨ RAG æŠ€è¡“ï¼Œçµåˆ OpenAIã€LangChainã€Qdrant å‘é‡æ•¸æ“šåº«ï¼Œæ§‹å»ºä¼æ¥­å…§éƒ¨æ–‡æª”çš„æ™ºèƒ½çŸ¥è­˜åº«ï¼Œä¸¦èƒ½è¨­è¨ˆèˆ‡å¯¦ä½œä¸€å€‹åŸºæ–¼è‡ªç„¶èªè¨€è™•ç†ï¼ˆNLPï¼‰çš„æŸ¥è©¢ç³»çµ±ï¼Œä¾†æå‡é–‹ç™¼åœ˜éšŠçš„æ•ˆç‡èˆ‡çŸ¥è­˜ç®¡ç†èƒ½åŠ›ã€‚","tags":["rag","devops"],"title":"Workshop: RAGæ‰“é€ ä¼æ¥­AIçŸ¥è­˜åº«ï¼šæŠŠä¸€ç”²å­åŠŸåŠ›å‚³çµ¦æ–°äºº","type":"slides"},{"authors":[],"categories":["kubernetes","workshop"],"content":"å·¥ä½œåŠå…§å®¹ å…©å€‹å ´æ¬¡\n2024-10-23T13:20-14:50 @ 603+604 2024-10-24T13:20-14:50 @ 605 Get Started è«‹é»æ“Šæœ¬é ä¸Šæ–¹æŠ•å½±ç‰‡é€£çµ Git clone æœ¬æ¬¡ workshop è³‡æº https://github.com/chechiachang/etcd-playground æ´»å‹•ç•¶å¤©ç¾å ´ï¼Œæœƒæä¾›ä¸€å° Linux VM åšä½¿ç”¨ Workshop Get started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s\nOutline Etcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ Etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ Etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚\né è¨ˆå…§å®¹ï¼šç’°å¢ƒè¨­å®šï¼ŒEtcd è¨­å®šèˆ‡éƒ¨ç½²ï¼ŒEtcd åŸºç¤æ“ä½œï¼Œéƒ¨ç½² kube-apiserver / kube-controller-manager / kube-schedulerï¼Œä½¿ç”¨ kubectl æ“ä½œ Kubernetes Clusterã€‚è®“åƒèˆ‡è€…é€éæœ¬æ¬¡å·¥ä½œåŠï¼Œå¯ä»¥æœ‰æ“ä½œ k8s control plane çš„ç¶“é©—ï¼Œæ›´äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œï¼Œä»¥åŠäº†è§£ Kubernetes çš„åŸºæœ¬æ¶æ§‹ã€‚\nï¼ˆè¦åŠƒä¸­ï¼‰æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\nå¿…å‚™çŸ¥è­˜ï¼šLinux æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼ŒDocker æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼Œæœƒä½¿ç”¨ SSH é€£ç·š / Bash / dockerã€‚ å·¥ä½œåŠæ™‚é–“ä¸å¤šï¼Œç¾å ´ä¸æœƒç´°è¬›æ¦‚å¿µå•é¡Œï¼Œåƒèˆ‡è€…éœ€è¦äº‹å‰é ç¿’åŸºæœ¬æ¦‚å¿µ https://etcd.io/ èˆ‡ http://play.etcd.io/play\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2024 Cloud Summit 2024 SRE Conference 2023 DevOpsDay Taipei 2023 Kubernetes Summit 2022 COSCUP 2022 Cloud Summit 2021 Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Cloud Summit 2019 Cloud Summit 2018 Cloud Summit 2018 Kubernetes Summit ","date":1729689600,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1729081879,"objectID":"0d720b793d241501cfc4809d7abec1e9","permalink":"https://chechia.net/zh-hant/talk/kubernetes-summit-get-started-with-etcd-kubernetes/","publishdate":"2024-08-05T00:00:00Z","relpermalink":"/zh-hant/talk/kubernetes-summit-get-started-with-etcd-kubernetes/","section":"event","summary":"Etcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ Etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ Etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚å·¥ä½œåŠå…§å®¹è«‹è¦‹æŠ•å½±ç‰‡","tags":["iac","aws","terraform","kubernetes","etcd"],"title":"Kubernetes Summit: Get started with Etcd \u0026 Kubernetes","type":"event"},{"authors":[],"categories":["kubernetes"],"content":"Presentation Upgrade A VM Based Clustermin\nTarget group æ”¶ç©« æœ¬æ¬¡æ¼”è¬›æœƒè¬›è§£å‡ç´šæ“ä½œï¼Œä½†ä¸ä¾·é™åœ¨å…·é«”æ­¥é©Ÿï¼Œè€Œæ˜¯å¸Œæœ›èƒ½è¬›è§£æ›´å¤š k8s æ¶æ§‹èˆ‡è¨­è¨ˆï¼Œè®“è§€çœ¾æœ‰ä»¥ä¸‹æ”¶ç©«ï¼šå¦‚ä½•å‡ç´š Kubernetes Cluster çš„ç‰ˆæœ¬ï¼Œå‡ç´šæ™‚æ‡‰è€ƒé‡çš„äº‹é …æœ‰å“ªäº›ï¼Œæœ‰ä»€éº¼å·¥å…·å¯ä»¥å”åŠ©å‡ç´šæµç¨‹ï¼Œé€éå‡ç´šæ›´äº†è§£ Kubernetes çš„æ¶æ§‹\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2024 Cloud Summit 2024 SRE Conference 2023 DevOpsDay Taipei 2023 Kubernetes Summit 2022 COSCUP 2022 Cloud Summit 2021 Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Cloud Summit 2019 Cloud Summit 2018 Cloud Summit 2018 Kubernetes Summit ","date":1729689600,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1722842897,"objectID":"27b54e0c923bff104f9b030c5cb95429","permalink":"https://chechia.net/zh-hant/talk/kubernetes-summit-upgrade-a-vm-based-cluster/","publishdate":"2024-08-04T00:00:00Z","relpermalink":"/zh-hant/talk/kubernetes-summit-upgrade-a-vm-based-cluster/","section":"event","summary":"åˆ†äº«å¦‚ä½•å‡ç´š VM-based Kubernetes Cluster çš„ç‰ˆæœ¬ï¼ŒåŒ…å« etcdï¼Œcontrol planeï¼Œèˆ‡ nodeã€‚å‡ç´šå‰å¦‚ä½•è¦åŠƒï¼Œå‡ç´šæ­¥é©Ÿè©²å¦‚ä½•æ“ä½œï¼Œå‡ç´šå¾Œæ‡‰è©²å¦‚ä½•æª¢æŸ¥ã€‚","tags":["iac","aws","terraform","kubernetes","vault"],"title":"Kubernetes Summit: Upgrade A VM Based Cluster","type":"event"},{"authors":[],"categories":["kubernetes","vault"],"content":"Info è³‡æ–™åº«ç®¡ç†æ˜¯ä¸€å€‹å¾ˆå¤§çš„è­°é¡Œï¼šå¦‚ä½•ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œå¦‚ä½•ç²¾ç¢ºçš„ç”¨æˆ¶è¨­å®šæ¬Šé™ï¼Œå‚³éå¯†ç¢¼çµ¦ç”¨æˆ¶ï¼Œä¸¦è‡ªå‹•åŒ–å®šæœŸæ›´æ–°å¯†ç¢¼ã€‚æœ¬å ´æ¼”è¬›å°‡åˆ†äº«å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œå¦‚ä½•å®‰å…¨çš„å‚³éå¯†ç¢¼ï¼Œä¸¦å®‰å…¨åœ°é€£ç·šåˆ°è³‡æ–™åº«\næ¶µè“‹ä»¥ä¸‹å…§å®¹ï¼š\ndatabase å¸³è™Ÿå¯†ç¢¼ç®¡ç†çš„é›£é¡Œ ç°¡ä»‹ Vault èˆ‡ database secret engine åœ¨ vault ä¸­è¨­å®š database secret engine vault åœ¨éœ€è¦æ™‚è‡ªå‹•ç”¢ç”Ÿè³‡æ–™åº«å¸³è™Ÿå¯†ç¢¼ vault é€éå®‰å…¨ä¾†æºèªè­‰ app èº«ä»½(ä½¿ç”¨ k8s service account èˆ‡ public cloud èªè­‰(aws iam role)) å®Œæˆ app é€£ç·šè‡³ database çš„å·¥ä½œé€±æœŸ monitoring / auditï¼švault audit log + prometheus / grafana dashboard / alert manager ç¯„ä¾‹ï¼šå¦‚ä½•ä½¿ç”¨ terraform è¨­å®š vault èˆ‡ database secret engine Target group æœ‰è³‡æ–™åº«ç®¡ç†éœ€æ±‚çš„å·¥ç¨‹å¸«ï¼Œæƒ³è¦å­¸ç¿’å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œå¦‚ä½•å®‰å…¨çš„å‚³éå¯†ç¢¼ï¼Œä¸¦å®‰å…¨åœ°é€£ç·šåˆ°è³‡æ–™åº«ã€‚\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","date":1724842800,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1724336959,"objectID":"d6e0424b910925b3c85229cbabc5a102","permalink":"https://chechia.net/zh-hant/talk/hashicorp-managed-database-credentials-with-hashicorp-vault/","publishdate":"2024-07-09T00:00:00Z","relpermalink":"/zh-hant/talk/hashicorp-managed-database-credentials-with-hashicorp-vault/","section":"event","summary":"åˆ†äº«å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œä»¥åŠå¦‚ä½•é€£ç·šåˆ°è³‡æ–™åº«ï¼Œç›£æ§èˆ‡å¯©æŸ¥ã€‚","tags":["iac","aws","terraform","kubernetes","vault"],"title":"Hashicorp: managed database credentials with Hashicorp Vault","type":"event"},{"authors":[],"categories":["kubernetes"],"content":" æŠ•å½±ç‰‡è·Ÿè¬›ç¨¿æˆ‘éƒ½æ”¾åœ¨æˆ‘çš„ç¶²ç«™ä¸Šï¼Œå¦‚æœæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒ Vault: Managed Database Credentials\nwith Hashicorp Vault\nChe Chia Chang\nAbout Me\nChe Chia Chang SRE @ Maicoin Microsoft MVP chechia.net ç›¸é—œè³‡æº\nDemo ç¯„ä¾‹ç¨‹å¼ç¢¼ https://github.com/chechiachang/vault-playground Demo ç”¨é€”ï¼Œè«‹å……åˆ†ç†è§£å¾Œå†ä½¿ç”¨ ä»Šæ—¥æŠ•å½±ç‰‡èˆ‡è¬›ç¨¿èˆ‡å…¶ä»–è³‡æº chechia.net 2023 Vault é›²ç«¯çš„ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å° å¾é›¶é–‹å§‹å­¸Terraformæ‰‹æŠŠæ‰‹å…¥é–€ å¤§ç¶±\nDB å¸³è™Ÿå¯†ç¢¼ç®¡ç†çš„é›£é¡Œ Vault DB secret engine Demo 1 éœ€è¦æ™‚è‡ªå‹•ç”¢ç”Ÿè³‡æ–™åº«å¸³è™Ÿå¯†ç¢¼ Vault auth method ç¬¬ä¸‰æ–¹èªè­‰èº«ä»½ Demo 2 github login and auth ç¨‹å¼åŒ–æ¬Šé™ç®¡ç†èˆ‡ç¨½æŸ¥ Demo 3 terraform è¨­å®š vault èˆ‡ DB secret engine (çœ‹æ™‚é–“) monitoring / audit DB å¸³è™Ÿå¯†ç¢¼ç®¡ç†çš„é›£é¡Œ\nèªè­‰(Authentication) å¯†ç¢¼ä¿ç®¡èˆ‡æš´éœ² æˆæ¬Š(Authorization) å¯†ç¢¼æ›´æ–° èªè­‰å¯ä»¥æ›´å¥½ æˆæ¬Šå¯ä»¥æ›´å½ˆæ€§æ–¹ä¾¿ å¯†ç¢¼æ›´æ–°å¯ä»¥æ›´é »ç¹ å¯†ç¢¼æš´éœ²é¢¨éšªå¯ä»¥è¢«å‹•æ§åˆ¶\né‡è¦ç¨‹åº¦ç¬¬ä¸€è€ƒé‡æ˜¯è³‡è¨Šå®‰å…¨ ç¬¬äºŒæ˜¯ç®¡ç†æ–¹ä¾¿åº¦ï¼Œæœ‰æ²’æœ‰ utility å¯ä»¥å¹«æˆ‘å€‘ç®¡ç†\nåº•ä¸‹é€éä¸€å€‹ user story ä¾†èªªæ˜é€™äº›é›£é¡Œ\nAuthentication èªè­‰\nyou are who you say you are\nAuthorization æˆæ¬Š\nyou are allowed to do what you are trying to do\nåè©è§£é‡‹ User Story\nä¸€å€‹appï¼Œç‚ºappè¨­å®šäº†ä¸€å€‹è³‡æ–™åº« è³‡æ–™åº«å­˜æ”¾appè³‡æ–™ï¼Œåªæœ‰appèƒ½å­˜å–è³‡æ–™ ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼èªè­‰ï¼Œappå¯ä»¥å­˜å–è³‡æ–™åº« app(username=app, password) \u0026gt; DB\nDB \u0026gt; hi, app!\nå¸‚é¢ä¸Šæœ‰å¾ˆå¤šè³‡æ–™åº«ï¼Œéƒ½æ˜¯ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ä¾†èªè­‰appçš„èº«ä»½ ç”¢ç”Ÿç¬¬ä¸€å€‹é›£é¡Œï¼Œå°±æ˜¯å¸³è™Ÿå¯†ç¢¼çš„å­˜æ”¾èˆ‡ç®¡ç† é›£é¡Œ/èªè­‰\nå°æ–¼è³‡æ–™åº«ä¾†èªªï¼Œusername=appçš„äººï¼Œå°±æ˜¯app\næœ‰å¸³è™Ÿå¯†ç¢¼æ˜¯å¦å°±ç›¸ä¿¡ä»–æ˜¯appï¼Ÿ æœ‰æ²’æœ‰è³¬è™Ÿå¯†ç¢¼ä»¥å¤–çš„æ–¹å¼ç¢ºèªappçš„èº«ä»½ï¼Ÿ ç„¶è€Œé€™è·Ÿæˆ‘å€‘çš„ user story é‚„æ˜¯æœ‰è½å·® å…¶ä¸­ä¹Ÿéš±è—è³‡å®‰é¢¨éšª æˆ‘å€‘å¾ˆç¿’æ…£ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ä¾†èªè­‰èº«ä»½ï¼Œä½†æ˜¯éš¨è‘—æ™‚ä»£æ¼”é€²ï¼Œé§­å®¢æœ‰æ›´å¤šæ–¹æ³•å–å¾—å¸³è™Ÿå¯†ç¢¼ é›£é¡Œ/èªè­‰/å¯†ç¢¼ä¿ç®¡èˆ‡æš´éœ²\ndba éœ€è¦é–‹ç™¼dbï¼Œæ‰‹ä¸Šæœ‰adminå¸³è™Ÿå¯†ç¢¼ è³‡å®‰é¢¨éšª é–‹ç™¼æ©Ÿå™¨å®‰è£æƒ¡æ„è»Ÿé«”/å´éŒ„å¯†ç¢¼ å¸³è™Ÿå¯†ç¢¼è¢«ç«Šå– å“¡å·¥åˆ†é–‹ç§äººèˆ‡å…¬å¸é›»è…¦ é§­å®¢å°‡é–‹æºçš„å·¥å…·ä¿®æ”¹ï¼Œå¢åŠ å¾Œé–€ï¼Œç„¶å¾Œ release çµ¦ admin å¤ éç¤¾äº¤å·¥ç¨‹ï¼Œè®“ admin ä¸çŸ¥ä¸è¦ºå®‰è£äº†æƒ¡æ„è»Ÿé«” å¾ˆé–‹å¿ƒæ‹¿ä¾†ç”¨ï¼Œä½†æ˜¯é€™å€‹å·¥å…·å´éŒ„äº† admin çš„å¸³è™Ÿå¯†ç¢¼ é›£é¡Œ/èªè­‰/å¯†ç¢¼æš´éœ²\næ›´åš´è¬¹çš„èº«ä»½ç¢ºèªï¼Œæ›´é›£è¢«ç ´è§£ ex Client Certificate Authentication å®‰å…¨çš„å­˜æ”¾å¯†ç¢¼ï¼Œé¿å…å¯†ç¢¼æš´éœ² æ›´å¥½çš„åšæ³• ä¸è¦å­˜æ”¾å¯†ç¢¼ï¼Œå»èƒ½ä½¿ç”¨å¯†ç¢¼?? æ”¾åœ¨ Vault è£¡é¢ ä»¥å¾€æˆ‘å€‘æ²’æœ‰æ›´å¥½çš„æ–¹å¼ä¾†ç¢ºèªappçš„èº«ä»½ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ é‡å°å¯†ç¢¼å¼·åº¦ï¼Œç¾åœ¨æœ‰æ›´å¥½çš„æ–¹å¼ä¾†ç¢ºèªappçš„èº«ä»½ï¼Œä¾‹å¦‚ Client Certificate Authentication æä¾›æ›´åš´è¬¹çš„èº«ä»½ç¢ºèªï¼Œç¾åœ¨è¨±å¤šè³‡æ–™åº«éƒ½æ”¯æ´ tlsï¼Œå¯ä»¥é€étlsä¾†ç¢ºèªappçš„èº«ä»½ å®Œæ•´çš„èªè­‰ï¼Œå…¬æ­£çš„ ca ç°½ç™¼ï¼Œcerts å¾ˆé›£è¢«æš´åŠ›ç ´è§£\næˆ‘å€‘è¦é¢å°çš„æ˜¯å¦å¤–ä¸€å±¤çš„é¢¨éšªï¼Œå°±æ˜¯å¯†ç¢¼æš´éœ² å°±ç®—ä½ æ‰‹ä¸Šæ˜¯æœ‰ä¸€å€‹å¾ˆå¼·çš„å¯†ç¢¼ï¼Œä½†æ˜¯ä½ çš„é–‹ç™¼æ©Ÿå™¨è¢«é§­ï¼Œå¯†ç¢¼å°±è¢«ç«Šå–äº† dba æ‰‹ä¸Šæœ‰å­˜ admin å¸³è™Ÿå¯†ç¢¼çš„ æœ‰ç”¨å¯†ç¢¼ç®¡ç†å™¨ 1password ï¼Œæœ‰æ¯”è¼ƒå¥½ï¼Œå› ç‚ºä»–å¹«ä½ åšåŠ å¯†èˆ‡å„²å­˜ï¼Œä½†ä¹Ÿä¸èƒ½æœŸå¾… 1password æ°¸ä¸è¢«é§­ å¦‚æœä½ æ‰‹ä¸Šçš„å¯†ç¢¼é‡è¦ç¨‹åº¦éå¸¸é«˜ï¼Œé«˜éå¯†ç¢¼å·¥å…·å¯ä»¥æ‰¿æ“”çš„é¢¨éšªï¼Œé‚£ä½ å°±è¦è€ƒæ…®ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ä¾†ç®¡ç†å¯†ç¢¼\næœ‰æ²’æœ‰å¯èƒ½ dba/sre æ‰‹ä¸Šä¸è¦æœ‰å¸³è™Ÿå¯†ç¢¼ï¼Œè€Œæ˜¯ç”±å…§ç¶²çš„ vault ä¾†ç®¡ç†å¸³è™Ÿå¯†ç¢¼\nVault DB secret engine\nVault DB secret engine\nVault DB secret engine\néœ€è¦æ™‚è‡ªå‹•ç”¢ç”ŸDBä½¿ç”¨è€…å¯†ç¢¼ çŸ­æ•ˆæœŸä½¿ç”¨è€…èˆ‡å¯†ç¢¼ ex 1hr ä¸å»¶å±•è‡ªå‹•åˆ°æœŸï¼Œåˆªé™¤ä½¿ç”¨è€… æœªå®Œæˆå·¥ä½œå¯ä»¥è‡ªå‹•å»¶å±• appå¯ä»¥ä¸€ç›´å–å¾—æ–°ä½¿ç”¨è€…èˆ‡å¯†ç¢¼ User Story (v2)\nåªæœ‰ vault æœ‰ admin å¯†ç¢¼ user éœ€è¦æ™‚ï¼Œvault å‹•æ…‹ç”¢ç”ŸçŸ­æ•ˆæœŸä½¿ç”¨è€…èˆ‡å¯†ç¢¼ æ•ˆæœŸåˆ°è‡ªå‹•åˆªé™¤ ä½¿ç”¨ vault library ç¨‹å¼åŒ–é€£ç·š db ä¸åœ¨é–‹ç™¼æ©Ÿå™¨ä¸Šå­˜å¯†ç¢¼ ä¸æ‰‹å‹•è¼¸å…¥å¯†ç¢¼ Vault DB secret engine æ”¯æ´ï¼Œæ²’æ”¯æ´å¯ä»¥è‡ªå·±å¯« plugin\nDemo 1: Vault DB secret engine\nSetup\ngit clone git@github.com:chechiachang/vault-playground.git cd vault-playground/deploy/04-docker-and-db/ docker-compose up -d docker ps docker exec -it 04-docker-and-db-mariadb_1-1 bash docker exec -it 04-docker-and-db-vault_1-1 sh apk update \u0026amp;\u0026amp; apk add mysql-client mysql -h mariadb_1 -u root -p Demo 1: Vault DB secret engine\n// Connect to docker vault export VAULT_ADDR=http://127.0.0.1:8200 vault status vault login vault secrets list // Configure secret engine database (terraform) vault secrets list vault policy list cd usage/03-terraform-lives terragrunt init terragrunt apply Demo 1: Vault DB secret engine\nUse database secret engine\n// root configure (already done by terraform) vault secrets list vault list localhost_mariadb/config vault read localhost_mariadb/config/localhost_mariadb vault list localhost_mariadb/roles vault read localhost_mariadb/roles/database_admin vault policy list vault policy read dba // create token for dba (will automatically done in Demo 2) vault token create -policy=dba -display-name=dba \\ -ttl=1h -use-limit=5 Demo 1: Vault DB secret engine\n// auth as dba vault login vault policy list vault read localhost_mariadb/creds/database_admin mysql --sql -h localhost -u \u0026lt;username\u0026gt; -p // do dba things show databases; select user from mysql.user; ... exit è§£æ±ºå­˜æ”¾èˆ‡å–ç”¨ï¼Œå›åˆ°é›£é¡Œ/èªè­‰\nå°æ–¼è³‡æ–™åº«ä¾†èªªï¼Œusername=appçš„äººï¼Œå°±æ˜¯app\næœ‰å¸³è™Ÿå¯†ç¢¼æ˜¯å¦å°±ç›¸ä¿¡ä»–æ˜¯appï¼Ÿ æœ‰æ²’æœ‰è³¬è™Ÿå¯†ç¢¼ä»¥å¤–çš„æ–¹å¼ç¢ºèªappçš„èº«ä»½ï¼Ÿ Vault çš„è§£æ±ºæ–¹æ¡ˆ\né›£é¡Œ/èªè­‰/Vault Auth method\nVault ä»°è³´å¤–éƒ¨å¯ä¿¡ç¬¬ä¸‰æ–¹(trusted authority)\nuser/app é€éç¬¬ä¸‰æ–¹å‹•æ…‹å–å¾—åˆæ³•çš„èº«ä»½ aws / azure / gcp iam role / github / saml / LDAP â€¦ é–‹ç™¼æ©Ÿå™¨ä¸Šæ²’æœ‰å¯†ç¢¼ï¼Œå°±ä¸æœƒå› ç‚ºæ©Ÿå™¨è¢«é§­/å´éŒ„ï¼Œé€ æˆå¯†ç¢¼æ´©æ¼\nVault ä»°è³´å¤–éƒ¨å¯ä¿¡ç¬¬ä¸‰æ–¹(trusted authority) æŠŠlocalé–‹ç™¼æ©Ÿå™¨è¢«é§­çš„é¢¨éšªï¼Œè½‰ç§»åˆ°å…¶ä»–æ›´å®‰å…¨çš„åœ°æ–¹ aws / azure / gcp iam role / github / saml å…§ç¶²çš„Vault LDAP é›£é¡Œ/èªè­‰/Vault Auth method/AWS\nIAM auth method EC2 auth method é€é AWS API å»ç¢ºèªèº«ä»½ ç™»å…¥çš„ aws user / åˆæ³•çš„ iam role vault é€é aws api å»æ ¸å°èº«ä»½ æ ¸å°æ­£ç¢ºï¼Œvault æä¾›çŸ­æœŸ database credential çµ¦ user / app app è·‘åœ¨ Ec2 ä¸Šï¼Œä½¿ç”¨ Ec2 åšèªè­‰ EC2 auth method å¦‚æœä½ æœ‰ä½¿ç”¨ aws ec2ï¼Œå¯ä»¥é€é aws api ä¾†å–å¾— iam role / ec2 metadata\nç”±æ–¼ database æœ¬èº«çš„èªè­‰æ©Ÿåˆ¶æœ‰é™ï¼Œæˆ‘å€‘å¯ä»¥é€é vault ä¾†ç®¡ç†å¸³è™Ÿå¯†ç¢¼ å°‡ç™»å…¥çš„è³‡å®‰ç®¡ç†äº¤çµ¦æ›´åš´è¬¹çš„ç¬¬ä¸‰æ–¹\naws login æ¯”å–®ç´” mysql login å®‰å…¨ï¼Œå› ç‚ºå¤šäº†æ›´å¤šèªè­‰æª¢æŸ¥ access key / password / MFA ip ä¾†æºæª¢æŸ¥ ratelimit DDOS protection æœ‰å•é¡Œæ™‚æœƒæœ‰ audit log\nauth method æ··æ­ å¯ä»¥é¢å°ä¸åŒçš„è³‡å®‰é¢¨éšª\napp è·‘åœ¨ Kubernetes ä¸Šï¼Œä½¿ç”¨ Service Account åšèªè­‰\nä½¿ç”¨ Vault auth methodï¼Œä¿¡ä»»ç¬¬ä¸‰æ–¹å–å¾—èº«ä»½ å¾é›™æ–¹æŸ¥æ ¸ï¼Œè®Šæˆä¸‰æ–¹æŸ¥æ ¸\næœ‰æ”¯æ´çš„ auth methodï¼Œå¯ä»¥è‡ªå·±æ­é… user auth method aws/gcp/azure iam role, github, saml, LDAP Login MFA appä½¿ç”¨auth methodèªè­‰ aws/gcp/azure iam role (ec2 role) kubernetes api server (pod service account) User Story (v3)\nåªåšä¸€æ¬¡ï¼šVault è¨­å®š DB secret engine user æœ¬æ©Ÿä¸å­˜æ”¾ DB å¸³è™Ÿå¯†ç¢¼ user/app é€é Vault auth method user aws iam role app k8s service account user/appå¯ä»¥å­˜å–vaultä¸­çš„dbå¸³è™Ÿå¯†ç¢¼ app \u0026gt; trusted authority\napp \u0026lt; (identity) \u0026lt; trusted authority\napp \u0026gt; (identity) \u0026gt; vault \u0026gt; trusted authority\napp \u0026lt; (DB credential) \u0026lt; vault\u0026gt;\nDemo 2: Auth method\nhttps://developer.hashicorp.com/vault/docs/auth/github\n// root vault policy list vault policy read sre vault â€¦","date":1724151600,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1724811279,"objectID":"87d78709df150c864240220112223357","permalink":"https://chechia.net/zh-hant/slides/2024-08-28-hashicorp-vault-database/","publishdate":"2024-08-20T11:00:00Z","relpermalink":"/zh-hant/slides/2024-08-28-hashicorp-vault-database/","section":"slides","summary":"åˆ†äº«å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œä»¥åŠå¦‚ä½•é€£ç·šåˆ°è³‡æ–™åº«ï¼Œç›£æ§èˆ‡å¯©æŸ¥ã€‚","tags":["kubernetes"],"title":"Hashicorp: managed database credentials with Hashicorp Vault","type":"slides"},{"authors":[],"categories":["kubernetes"],"content":"etcd Workshop æœ¬æ¬¡ workshop ä»¥ hands-on çš„æ–¹å¼é€²è¡Œï¼Œç´¯ç©æ“ä½œç¶“é©—ç‚ºä¸»ï¼Œè¬›è§£èˆ‡èªªæ˜ç‚ºè¼”ã€‚è§€å¿µå…§å®¹æœ‰æº–å‚™æ•™æï¼Œéœ€è¦åƒèˆ‡è€…è‡ªè¡Œé–±è®€ docker å•Ÿå‹• etcd etcdctl å­˜å– etcd docker å•Ÿå‹• etcd cluster docker å•Ÿå‹• k8s control plane kubectl å­˜å– k8s control plane ç¶­é‹ k8s æ‰€éœ€çš„ etcd operation åƒèˆ‡è€…éœ€è¦ä¸€å°é›»è…¦ï¼Œå¯ä»¥ä¸Šç¶²ï¼Œèƒ½å¤ é»æ»‘é¼ å³éµ etcd Workshop æ‰‹æŠŠæ‰‹æ­å»º etcd èˆ‡ K8s å·¥ä½œåŠ Che Chia Chang https://chechia.net/\né—œæ–¼æˆ‘ Che Chia Chang SRE @ Maicoin Microsoft MVP å€‹äººéƒ¨è½æ ¼chechia.net presentation and speaker notes éµäººè³½ (Terraform / Vault æ‰‹æŠŠæ‰‹å…¥é–€) Weâ€™re hiring! https://www.cake.me/companies/maicoin/jobs\nå¤§ç¶± docker å•Ÿå‹• etcd etcdctl å­˜å– etcd docker å•Ÿå‹• etcd cluster docker å•Ÿå‹• k8s control plane ç¶­é‹ k8s æ‰€éœ€çš„ etcd operation (Optional) æ­å»º Worker Node å¦‚ä½•é€²è¡Œ workshop è¬›å¸«æœƒåœ¨å°ä¸Šå¸¶é ­å½±ç‰‡çš„å…§å®¹ åƒèˆ‡è€…åœ¨è‡ªå·±çš„æ©Ÿå™¨ä¸Šæ“ä½œ åƒèˆ‡è€…å¯ä»¥è·Ÿå°ä¸Šçš„é€²åº¦ï¼Œä¹Ÿå¯ä»¥è¶…å‰é€²åº¦å‘å¾Œæ“ä½œ é€²åº¦è½å¾Œä¸å¤ªæœƒå½±éŸ¿å¾ŒçºŒæ“ä½œï¼Œä¸å¿…æ“”å¿ƒ åŠ åˆ†é¡Œæ˜¯é‡è¦ï¼Œä½†æ²’æ™‚é–“æ–¼ä»Šæ—¥å®Œæˆçš„å…§å®¹ï¼Œè«‹è‡ªè¡Œåƒè€ƒ æœ‰å¾ˆå¤šå•é¡Œä¹Ÿå¾ˆæ­£å¸¸ï¼Œç”¢ç”Ÿç–‘å•ä¹Ÿæ˜¯å·¥ä½œåŠçš„ç›®çš„ å¦‚ä½•å­˜å–é ç«¯VM è‡³workshop.chechia.net é ˜å–ä¸€å° VM ä¸¦ç°½å å¾è¬›å¸«å–å¾—ä½¿ç”¨è€…åç¨±èˆ‡å¯†ç¢¼ ä½¿ç”¨ç€è¦½å™¨ï¼Œé€é url é€£ç·šè‡³ä½ çš„ VMï¼Œè¼¸å…¥ä½¿ç”¨è€…åç¨±èˆ‡å¯†ç¢¼ç™»å…¥ Protocol: SSHï¼Œport 22ï¼Œauthentication type: password ä¸‹è¼‰æ•™æï¼ˆæ»‘é¼ è¤‡è£½åº•ä¸‹æŒ‡ä»¤ï¼Œæ»‘é¼ å³éµå°±èƒ½è²¼åˆ° terminal ä¸­ï¼‰ git clone https://github.com/chechiachang/etcd-playground.git å›å®¶å¦‚ä½•è‡ªå»º workshop ç’°å¢ƒ workshop æä¾›çš„æ©Ÿå™¨\nubuntu å®‰è£é€™äº›æ±è¥¿ github.com/chechiachang/terraform-azure mac å®‰è£ä»¥ä¸‹å·¥å…· docker https://docs.docker.com/desktop/install/mac-install/ å®‰è£ jq èˆ‡ yq å›å®¶å¦‚ä½•è‡ªå»º workshop ç’°å¢ƒ VERSION=v4.44.3 BINARY=yq_darwin_amd64 wget https://github.com/mikefarah/yq/releases/download/${VERSION}/${BINARY} -O yq chmod +x yq sudo mv yq /usr/bin/yq etcd åŸºç¤æ“ä½œ: å•Ÿå‹•ä¸€å° etcd ä¸€è¡Œä¸€è¡ŒåŸ·è¡Œåº•ä¸‹æŒ‡ä»¤ï¼Œä¾†å•Ÿå‹•ä¸€å° etcd\ncd etcd-playground ls cd 00-prerequsites/ cat docker-compose.yaml docker compose up -d docker ps docker logs -f etcd-0 å¡ä½æ™‚ ctrl + c to exit\nåªé ˜æ‰“ä¸€åŠå¯ä»¥æŒ‰ tab auto complete\netcd åŸºç¤æ“ä½œ: etcdctl https://etcd.io/docs/v3.5/tutorials/ ä¸­çš„å¹¾å€‹ç¯„ä¾‹\nReading from etcd Writing to etcd etcdctl get foo etcdctl put foo \u0026#34;Hello World\u0026#34; etcdctl get foo etcd åŸºç¤æ“ä½œ: etcdctl https://etcd.io/docs/v3.5/tutorials/ ä¸­çš„å¹¾å€‹ç¯„ä¾‹\nHow to get keys by prefix etcdctl get --prefix \u0026#34;\u0026#34; etcdctl get \u0026#34;\u0026#34; --prefix --keys-only etcdctl put foo2 2 etcdctl put foo5 5 etcdctl put foo4 4 etcdctl put foo3 3 etcdctl get foo --prefix --keys-only etcdctl get foo --prefix --keys-only --sort-by=KEY --limit=5 etcdctl get foo --prefix --keys-only --sort-by=MODIFY --limit=5 etcd åŸºç¤æ“ä½œ: etcdctl è«‹å˜—è©¦æ“ä½œ https://etcd.io/docs/v3.5/tutorials/ ä¸­çš„å¹¾å€‹ç¯„ä¾‹\nHow to delete keys How to watch keys How to check Cluster status etcdctl del foo etcdctl put k1 value1 etcdctl put k2 value2 etcdctl del --prefix k etcd åŸºç¤æ“ä½œ: é‡å•Ÿ etcd é€éä»¥ä¸‹ command é‡å•Ÿ etcd\ndocker ps ç¢ºèª etcd æ˜¯å¦é‚„åœ¨é‹è¡Œ docker ps docker compose down docker ps docker compose up -d etcd åŸºç¤æ“ä½œ: Quiz é‡å•Ÿ etcd å¾Œï¼Œæ˜¯å¦é‚„èƒ½è®€å–åˆ° foo çš„å€¼ï¼Ÿç‚ºä»€éº¼ï¼Ÿ è«‹ç”¨50å€‹å­—ï¼Œæè¿°ä½ ç›®å‰è¦ºå¾— etcd æ˜¯ä»€éº¼ï¼Ÿ æŠŠç­”æ¡ˆå¡«åˆ° workshop.chechia.net ä¸æ˜¯è€ƒè©¦ï¼Œéš¨æ„ç™¼æ®ï¼Œé‡é»åœ¨ä¿ƒé€²å¤§å®¶æ€è€ƒ etcdctl put foo bar docker compose down docker compose up -d etcdctl get foo etcd åŸºç¤æ“ä½œ: Answer æœ¬ workshop çš„ docker-compose.yml ä¸­ï¼Œetcd çš„è³‡æ–™æ˜¯å­˜æ”¾åœ¨æœ¬åœ°çš„ etcd0 è³‡æ–™å¤¾ä¸­ï¼Œå› æ­¤é‡å•Ÿå¾Œï¼Œè³‡æ–™ä¸æœƒéºå¤±ã€‚é€éä»¥ä¸‹æŒ‡ä»¤å¯ä»¥æ¸…é™¤ etcd0 è³‡æ–™å¤¾ä¸­çš„è³‡æ–™ https://etcd.io/docs/v3.5/learning/why/ cd 00-prerequsites/ sudo ls etcd0 sudo ls etcd0/member docker compose down --volumes sudo rm -rf etcd0/* # æ–°çš„ etcd docker compose up -d ls etcd0 é–±è®€è³‡æ–™ https://etcd.io/docs/v3.5/learning/why/ https://github.com/chechiachang/etcd-playground/blob/main/00-prerequsites/README.md åŠ åˆ†é¡Œç‚ºè‡ªå·±åŠ åˆ†ï¼šauthentication å•Ÿç”¨ etcd çš„ authentication\nä½¿ç”¨ userA ç™»å…¥ etcd ä½¿ç”¨ userA å¯«å…¥è³‡æ–™ ä½¿ç”¨ userB è®€å–è³‡æ–™ é—œé–‰åŒ¿åå­˜å– https://etcd.io/docs/v3.5/op-guide/authentication/ å¡ä½ä¹ƒå…µå®¶å¸¸äº‹ï¼Œå¤§ä¿ è«‹é‡æ–°ä¾†éå³å¯ docker compose down --volumes sudo rm -rf etcd0/* åŠ åˆ†é¡Œç‚ºè‡ªå·±åŠ åˆ†ï¼šauthentication # å¯èƒ½æœƒç”¨åˆ°çš„ cmd etcdctl role add etcdctl role grant-permission etcdctl user add etcdctl user list etcdctl auth status etcdctl auth enable etcd Clusters: ç§»é™¤èˆŠçš„ etcd å…ˆé—œé–‰ 01-prerequsites çš„ etcd é€é --volumes åˆªé™¤ docker volume åˆªé™¤ etcd local volume è³‡æ–™å¤¾ docker compose down --volumes sudo rm -rf etcd0/* etcd Clusters: å•Ÿå‹•å¤šå° etcd cd ../ cd 01-cluster/ cat docker-compose.yaml docker compose up -d docker ps etcd Clusters: æª¢è¦–ç‹€æ…‹ é è¨­ etcdctl æœƒé€£ç·šåˆ° â€“endpoints=[127.0.0.1:2379] ä½¿ç”¨ â€“endpoints æŒ‡å®šè¦é€£ç·šåˆ°çš„ etcd ä½¿ç”¨ export ETCDCTL_ENDPOINTS æŒ‡å®šè¦é€£ç·šåˆ°çš„ etcd etcdctl endpoint status etcdctl --endpoints \u0026#34;http://127.0.0.1:2379,http://127.0.0.1:2380\u0026#34; endpoint status etcdctl --endpoints \u0026#34;http://127.0.0.1:2379,http://127.0.0.1:2380,http://127.0.0.1:2381\u0026#34; endpoint status export ETCDCTL_ENDPOINTS=\u0026#34;http://127.0.0.1:2379,http://127.0.0.1:2380,http://127.0.0.1:2381\u0026#34; etcdctl --endpoints $ETCDCTL_ENDPOINTS endpoint status etcdctl endpoint status etcd Clusters: æª¢è¦–ç‹€æ…‹ https://etcd.io/docs/v3.5/tutorials/\nHow to check Cluster status é€é --help æª¢æŸ¥æ¯å€‹æ¬„ä½çš„æ„ç¾© etcdctl endpoint status etcdctl endpoint status --help etcdctl endpoint health etcdctl endpoint health --help etcdctl endpoint hashkv etcdctl endpoint hashkv --help etcd Clusters: æ“ä½œ Member member æ˜¯ etcd cluster ä¸­çš„ä¸€å€‹ç¯€é» leader æ˜¯ etcd cluster ä¸­çš„ä¸€å€‹ member é€é move-leader æŒ‡ä»¤ï¼Œå¯ä»¥äº¤æ¥ leader etcdctl --write-out=table endpoint status docker exec -it etcd-1 etcdctl move-leader 88d11e2649dad027 etcdctl --write-out=table endpoint status etcd Clusters: Member https://etcd.io/docs/v3.5/tutorials/\nHow to Add and Remove Members ç§»é™¤ä¸€å€‹ memberï¼Œname: etcd-3 id: c3697a4fd7a20dcd â€¦","date":1722818700,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1729829824,"objectID":"0a3ef2843b40bfb0a308a7f2c536e6dc","permalink":"https://chechia.net/zh-hant/slides/2024-10-24-etcd-workshop/","publishdate":"2024-08-05T00:45:00Z","relpermalink":"/zh-hant/slides/2024-10-24-etcd-workshop/","section":"slides","summary":"etcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚","tags":["etcd","kubernetes"],"title":"Kubernetes Summit: Get started with etcd \u0026 Kubernetes","type":"slides"},{"authors":[],"categories":["kubernetes"],"content":"Upgrade A VM Based Cluster Che Chia Chang\né—œæ–¼æˆ‘ Che Chia Chang SRE @ Maicoin Microsoft MVP æŠ•å½±ç‰‡èˆ‡è¬›ç¨¿éƒ½åœ¨ chechia.net Etcd Workshop éµäººè³½ (Terraform / Vault æ‰‹æŠŠæ‰‹å…¥é–€) ä»Šå¤©çš„ä¸»é¡Œ ç‚ºä½•è¦ AWS è‡ªæ¶ K8s å‡ç´šäº‹å‰é–±è®€æ–‡ä»¶èˆ‡è¦åŠƒ éœ€è¦å‡ç´šçš„å…ƒä»¶ å¯¦éš›å‡ç´šçš„æ­¥é©Ÿ è‡ªå‹•åŒ– k8s å‡ç´š ä»Šå¤©çš„ç›®çš„ çµ±æ•´æ•£è½çš„è³‡è¨Š å‡ç´šéœ€è¦è€ƒæ…®çš„äº‹æƒ… å¯èƒ½å“ªäº›åœ°æ–¹æœ‰é›·ï¼Œå°è‡´å‡ç´šå‡ºéŒ¯ ç”¢ç”Ÿè‡ªå·±åœ˜éšŠçš„å‡ç´š SOP èƒŒæ™¯ï¼šä»€éº¼æ˜¯ VM-based Cluster Managed Kubernetes Service (GKE, EKS, AKS) å…¬æœ‰é›²è¨—ç®¡ control planeï¼Œé€éé›²æä¾›çš„ä»‹é¢æ§åˆ¶ self-hosted Kubernetes cloud formation template ec2 node ä»€éº¼æ˜¯ VM-based Cluster å…¬æœ‰é›²åªæä¾› VMï¼Œè‡ªå·±ç”¨å…¶å®ƒå·¥å…·æ­ K8s Components\nkubeadm, kops, kubespray / docker, containerd, cri-o / container or systemd / â€¦ è‡ªå·±ç®¡ç† control planeï¼ŒåŒ…å« etcd, apiserver, controller-manager, scheduler ä¾éœ€æ±‚é¸ç”¨å…¬æœ‰é›²æä¾›çš„æ¶æ§‹ï¼Œex VPC, ELB, EBS, S3, RDS, IAM, Route53, CloudWatch, CloudTrailâ€¦ Self-hosted control plane\næ‰€ä»¥ç‚ºä½•è¦åœ¨AWSä¸Šè‡ªæ¶ K8sï¼Ÿ å› ç‚º 2016 å¹´çš„æ™‚å€™æ²’æœ‰ eks 2015- å¹´æœ‰å¾ˆå¤š self-hosted k8s è§£æ±ºæ–¹æ¡ˆ 2014/10/15 kubernetes v0.4 github 2014/11/04 GKE release for 0.4.2 ç•¶æ™‚æœ‰å¾ˆå¤šè§£æ±ºæ–¹æ¡ˆå†æä¾› self-hosted k8sï¼ŒåŸºæ–¼é€™äº›æ–¹æ¡ˆï¼Œç”¢ç”Ÿ VM-based k8s github.com/getamis/vishwakarma 2017/10/24 AKS generally available 2018/06/05 EKS generally available Self-hosted control plane self-hosted control plane å…¶å¯¦ä¸é›£ï¼Œé‚£æ™‚æœ‰å¾ˆå¤šæˆç†Ÿçš„è§£æ±ºæ–¹æ¡ˆ\nk8s summit Etcd Workshop é™ä½æœå‹™å•†ä¾è³´ å¯ä»¥è·¨é›²ï¼Œè·¨åœ°ç«¯ï¼Œæ··åˆé›² è‡ªè¨‚åŒ–ï¼Œæ› VM disk imageï¼ŒCNIï¼ŒCSIï¼ŒIngress Controller æˆæœ¬æ§åˆ¶ Self-hosted control plane: å£è™• åœ˜éšŠå¤šåšä¸€äº›äº‹æƒ… å·¥ç¨‹å¸«å€‹äººå¯ä»¥(å¿…é ˆ)å­¸åˆ°å¾ˆå¤šæ±è¥¿ cloud managed k8s è¶Šåšè¶Šå¥½ï¼Œè‡ªå·±æ¶çš„ç†ç”±è¶Šä¾†è¶Šå°‘ Self-hosted å¤šäº†è¦å‡ç´šçš„æ±è¥¿ VM: based image / package / CVEs (ä¸åœ¨ä»Šå¤©çš„ç¯„åœ) k8s doc å»ºè­°çš„å‡ç´šé †åº Etcd Cluster Control Plane apiserver controller manager scheduler cloud controller manager å¯¦éš›ä¾†çœ‹å‡ç´šçš„æ­¥é©Ÿ å¯¦éš›å‡ç´šçš„é †åº ç ”ç©¶æ±ºå®šå‡ç‰ˆç›®æ¨™ å¿…è®€ K8s CHANGELOG / Urgent Upgrade Notes æª¢æŸ¥ app çš„ç‰ˆæœ¬ä¾è³´ (i.e å‡ k8s æœƒå£çš„ app) K8s resource API Deprecated App Controllers Etcd Cluster Apiserver Controller Manager Scheduler Node (kubelet, kube-proxy, CNI agent) äº‹å‰ç ”ç©¶è·Ÿè¦åŠƒ ç¢ºèªç›®å‰ç‰ˆæœ¬ ç›®æ¨™ç‰ˆæœ¬ å‡ç‰ˆçš„ç›®çš„ï¼š(feature, EOL, â€¦) å…ƒä»¶å½¼æ­¤ç›¸å®¹çš„ç‰ˆæœ¬ æ¯å€‹å°ç‰ˆè™Ÿ Release Cycle ~ 4 months æœ‰é‡ç–Šæ™‚é–“ï¼Œæ‰€ä»¥å¤§æ¦‚æ˜¯ 3 å€‹æœˆå‡ºä¸€ç‰ˆæ–°çš„ path release ~ 8 months K8s Release Cycle ~ 4 months åŠ ä¸Š ~ 8 months patch release\nå¤šä¹…å‡ç´šä¸€æ¬¡ k8s æ¯å­£æ›´æ–°ä¸€æ¬¡ è·Ÿ featureï¼Œæ¯æ¬¡å‡ N+1 ç‰ˆ è·Ÿ EOLï¼Œæ¯æ¬¡å‡ N+1 ç‰ˆ æ¯å¹´æ›´ï¼Œç¶­æŒåœ¨ EOL å‰ï¼Œæ¯æ¬¡å‡ N+3 ç‰ˆ å‡ç´šè®Šæˆ routine æ›´æ–° k8s ä¹Ÿä¸æ˜¯çŸ­çŸ­å¹¾å¤©çš„å·¥ä½œï¼Œè¦æœ‰æ™‚é–“è¦åŠƒï¼Œæ¸¬è©¦ï¼Œæª¢æŸ¥\né™¤äº†ç‰ˆæœ¬ä¸åŒï¼Œæ¯æ¬¡è¦åšçš„æµç¨‹é¡ä¼¼ èˆ‡å…¶æ˜¯ä¸€å€‹ task æ›´åƒæ˜¯ä¸€å€‹ routine çš„å·¥ä½œ é‡é»è®Šæˆä¸æ˜¯å¤šä¹…æ›´æ–°ä¸€æ¬¡ è€Œæ˜¯å¹¾ç„¶éœ€è¦å¸¸åšï¼Œè©²å¦‚ä½•æœ‰æ•ˆç‡(è‡ªå‹•åŒ–)çš„å®Œæˆå‡ç´š å¿…è®€æ–‡ä»¶ K8s CHANGELOG Urgent Upgrade Notes (No, really, you MUST read this before you upgrade)\nCHANGELOG-1.31.md æœ€å°‘è¦çœ‹ Urgent Upgrade Notes è·Ÿ action required ä¸çœ‹ CHANGELOG çœŸçš„ä¸è¡Œå—ï¼Ÿ å¯ä»¥ï¼Œæµç¨‹æœƒè®Šæˆ\nk8s å‡ç´šä¸Šå» ç™¼ç¾æœ‰æ±è¥¿å£æ‰ï¼Œé–‹å§‹ debug ä¸€è·¯å¾ app, infra, k8s resource, æŸ¥åˆ° k8s ä¸Šçš„å•é¡Œ æœ€å¾Œé‚„æ˜¯çœ‹äº† CHANGELOG ä½ ä»¥å¾Œå°±æœƒä¹–ä¹–çš„æŠŠ CHANGELOG çœ‹å®Œ å‡ç´šäº‹å‰ç ”ç©¶è·Ÿè¦åŠƒ äº†è§£ k8s release lifecycle ä¾æ“šåœ˜éšŠæ”¿ç­–ï¼Œè¨­å®šæ›´æ–°é€±æœŸ äº†è§£ç›®å‰ç‰ˆæœ¬èˆ‡ç›®æ¨™ç‰ˆæœ¬çš„å·®ç•° ä¸Šè¿°å·¥ä½œè½‰ç‚ºé€±æœŸæ€§çš„å¸¸æ…‹å·¥ä½œ åŠ é€Ÿå‡ç´šçš„é€Ÿåº¦ éœ€è¦å‡ç´šçš„ K8s Components Etcd Upgrade å®˜æ–¹æ–‡ä»¶ https://etcd.io/ åˆ†æ•£å¼ key-value store å¯ä»¥ zero downtime rolling upgrade å¯ä»¥ zero downtime rolling downgrade Etcd Upgrade æ­¥é©Ÿ https://etcd.io/docs/v3.5/upgrades/upgrade_3_5/\netcd åœ¨ minor version å‡ç´šæ™‚ï¼Œå¯ä»¥ zero downtime rolling upgrade ç¶­æŒ etcd cluster quorum delete then add member (ç¶­æŒ quorum å…ˆæ¸›å¾Œå¢ï¼‰ ä¿ç•™ etcd data èˆ‡ endpoint ipï¼Œé–‹å›å¾Œç›´æ¥ä¸Šç·š åªéœ€ sync delete -\u0026gt; add ä¸­é–“çš„è³‡æ–™å·® terraform for IaC è¦æ›çš„ etcd VM å¯ä»¥æ‹†è§£æˆ terraform module\nVM -\u0026gt; EC2 base os -\u0026gt; AMI data disk (etcd data) -\u0026gt; EBS ip (etcd endpoint) -\u0026gt; ENI etcd binary -\u0026gt; S3 etcd config / flags -\u0026gt; launch template / cloud init terraform gitflow PR æ”¹ binary etcd:v3.4.34 -\u0026gt; etcd:v3.5.4 PR review -\u0026gt; è‡ªå‹• trigger terraform plan PR merge -\u0026gt; è‡ªå‹• apply dev / stag è‡ªå‹•åŒ–åŸ·è¡Œæ¸¬è©¦ Monitoring ç›£æ¸¬ä¸€ç›´éƒ½åœ¨ æœ‰å•é¡Œ: revert PR è‡ªå‹• rollback æ²’å•é¡Œ: äººå·¥ç¢ºèªä¸Šè¿°æ­¥é©Ÿï¼Œé–‹å‡º prod PR -\u0026gt; è‡ªå‹• apply prod æœ‰å•é¡Œ: revert PR è‡ªå‹• rollback å¾å°ˆæ³¨å®Œæˆå‡ç´šï¼Œè®Šæˆå°ˆæ³¨åœ¨è‡ªå‹•åŒ–æµç¨‹ å…¶ä»– k8s å…ƒä»¶çš„ç®¡ç†ä¹Ÿæ˜¯åŒæ¨£æ–¹å¼ï¼Œå°‡äººå·¥é™åˆ°æœ€ä½\nEtcd Upgrade è©²æ³¨æ„ https://etcd.io/docs/v3.5/op-guide/failures/\nMajority of members are unreachable Network partition éµå®ˆ SOP å…ˆæ¸›å¾Œå¢ kube-apiserver apiserver doc https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/#manual-deployments\nå…ˆå‡ç´š kubectl apiserver å°ç‰ˆè™Ÿ rolling upgrade zero downtime å¦‚æœå»ºç«‹ k8s æ™‚æœ‰ç”¨å·¥å…·/å¹³å°ï¼Œex kubeadm, kops, kubesprayï¼Œæœƒæœ‰å°æ‡‰çš„å‡ç´šæŒ‡ä»¤ terraform ç›´æ¥æ›´æ› apiserver ç¯€é» Supported Version Skew https://kubernetes.io/releases/version-skew-policy/\nkube-apiserver å½¼æ­¤æœ€å¤šå·® 1 å€‹å°ç‰ˆè™Ÿ 1.30 å‡ 1.31 éç¨‹å¯ä»¥ç„¡ç—› controller manager, scheduler, cloud controller manager (vs apiserver) æœ€å¤šå·® 1 å€‹å°ç‰ˆè™Ÿ å‡ç´š apiserver å¾Œï¼Œè·Ÿè‘—å‡ç´šåŒæ¿ kubelet, kube-proxy (vs apiserver) æœ€å¤šå·® 3 å€‹å°ç‰ˆè™Ÿ apiserver 1.30 å‡ 1.31 æ™‚ï¼Œnode 1.28, 1.29, 1.30 å¯ä»¥ç„¡ç—› api deprecated Deprecated API Migration Guide Deprecation policy ä½¿ç”¨å·¥å…·æƒæ k8s resource å¦‚ä½•ç¢ºèª app çš„ k8s resource æœ‰æ²’æœ‰ä½¿ç”¨åˆ° deprecated API https://github.com/doitintl/kube-no-trouble åŠ å…¥åˆ°å‡ç´šæµç¨‹ï¼Œè‡ªå‹•åŒ– ï¼ˆæ²’å‡ç´šçš„æ™‚å€™ï¼‰é€±æœŸæ€§çš„æƒæ app é–‹ç™¼çš„ CI æ‡‰è©²å°å…¥ lint --kube-version å¦‚æœæœ‰ app ä½¿ç”¨åˆ° deprecated APIï¼Œé€šçŸ¥ app owner ææ—©æ›´æ–° å‡ç´šå‰å†æƒæä¸€æ¬¡ kube-no-trouble ç”¢ç”Ÿæ–°ç‰ˆ apiserver VM è¦æ›çš„ apiserver VM\nVM -\u0026gt; EC2 base os -\u0026gt; AMI Auto Scaling Group + Load balancer æ›´æ–°apiserver binary -\u0026gt; S3 launch template / cloud formation apiserver config / flags -\u0026gt; launch template / cloud init ç§»é™¤èˆŠç‰ˆ apiserver graceful shutdown load balancer -\u0026gt; auto scaling group -\u0026gt; EC2 instance\né€é load balancer çš„è¨­å®šï¼Œç¢ºä¿ apiserver æœ‰è¶³å¤ çš„æ™‚é–“é›¢ç·š request éƒ½å·²è™•ç†å®Œ load balancer é—œé–‰é€£å…¥ ç­‰å¾… graceful periodï¼Œç¢ºèªæ²’æœ‰ request é—œé–‰æœå‹™ï¼Œé—œé–‰ EC2 instance ç›£æ¸¬ apiserver çš„ metricsï¼ŒéŒ¯èª¤ç‡æé«˜è‡ªå‹•å‘Šè­¦ scheduler and controller manager å¦‚æœæ˜¯ master VM (api-server, scheduler, controller manager, cloud controller manager) ä¸€èµ·å‡ç´š ä¸€èµ·å»ºç«‹æ–°ç‰ˆ VM ä¸€èµ·ç§»é™¤èˆŠç‰ˆ VM å¦‚æœæ˜¯å…¶ä»–æ–¹å¼ applyï¼Œä¾ç…§å°æ‡‰çš„å‡ç´šæŒ‡ä»¤ ä¾è³´ k8s â€¦","date":1722775500,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1729829824,"objectID":"57cae46599aaf4d3a9bc08863788afc8","permalink":"https://chechia.net/zh-hant/slides/2024-10-23-upgrade-k8s-cluster/","publishdate":"2024-08-04T12:45:00Z","relpermalink":"/zh-hant/slides/2024-10-23-upgrade-k8s-cluster/","section":"slides","summary":"åˆ†äº«å¦‚ä½•å‡ç´š VM-based Kubernetes Cluster çš„ç‰ˆæœ¬ï¼ŒåŒ…å« etcdï¼Œcontrol planeï¼Œèˆ‡ nodeã€‚å‡ç´šå‰å¦‚ä½•è¦åŠƒï¼Œå‡ç´šæ­¥é©Ÿè©²å¦‚ä½•æ“ä½œï¼Œå‡ç´šå¾Œæ‡‰è©²å¦‚ä½•æª¢æŸ¥ã€‚","tags":["kubernetes"],"title":"Kubernetes Summit: Upgrade A VM Based Cluster","type":"slides"},{"authors":[],"categories":["kubernetes","aws"],"content":"Info Title: SRE Conference: Cloud Infrastructure Saving Engineering é›²ç«¯çœéŒ¢å·¥ç¨‹\nä½¿ç”¨ AWS èˆ‡ Kubernetes å°±æ˜¯è¦èŠ±éŒ¢ï¼Œå¦‚ä½•çœéŒ¢ï¼Ÿ åˆç†çš„è¨­å®šè³‡æºï¼Œä¸åƒ…çœéŒ¢ï¼Œé‚„æå‡æ•´é«”æœå‹™ç©©å®šåº¦ï¼Ÿ æ—¢æœ‰æœå‹™å·²ç¶“å­˜åœ¨ï¼Œå¦‚ä½•é€æ­¥æ”¹è®Šï¼Œé™ä½æˆæœ¬ï¼Ÿ\næœ¬æ¬¡æ¼”è¬›ä»¥å¯¦å‹™çš„ç¯„ä¾‹ï¼Œåˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving planâ€¦ï¼Œä¸¦åˆ†äº«å¦‚ä½•æ”¹è®Šæ–‡åŒ–ï¼Œæé«˜åœ˜éšŠçš„æˆæœ¬æ„è­˜ï¼Œå¯¦éš›çš„é™ä½é–‹éŠ·\nTarget group AWS \u0026amp; Kubernetes User who want to decrease overall cost of infrastructure\nå°å…¥å·¥å…·ï¼šæœ‰å“ªäº›å·¥å…·å¯ä»¥ä½¿ç”¨ åˆ†æç¾æ³ï¼šç²¾ç®—å„åœ˜éšŠèˆ‡å„å°ˆæ¡ˆæˆæœ¬ æ”¹è®Šç¾æ³ï¼šå¾æ—¢æœ‰çš„æ¶æ§‹ä¸­ï¼Œæ‰¾å°‹å¯ä»¥ç¯€çœæˆæœ¬çš„åœ°æ–¹ æ”¹å–„æµç¨‹ï¼šæœ‰æ•ˆç‡çš„ç¶­æŒçœéŒ¢ workflow æ”¹è®Šæ–‡åŒ–ï¼šæŒçºŒæ€§ä½ç¶­æŒæ–°æœå‹™èˆ‡èˆŠæœå‹™çš„åˆç†æˆæœ¬ Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","date":1720010700,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1740581375,"objectID":"b8cb4492897366f8db7e55ad0be67693","permalink":"https://chechia.net/zh-hant/talk/cloud-summit-cloud-infrastructure-saving-engineering-%E9%9B%B2%E7%AB%AF%E7%9C%81%E9%8C%A2%E5%B7%A5%E7%A8%8B/","publishdate":"2024-07-01T00:00:00Z","relpermalink":"/zh-hant/talk/cloud-summit-cloud-infrastructure-saving-engineering-%E9%9B%B2%E7%AB%AF%E7%9C%81%E9%8C%A2%E5%B7%A5%E7%A8%8B/","section":"event","summary":"åˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan","tags":["vault","iac","aws","terraform","kubernetes","cost"],"title":"Cloud Summit: Cloud Infrastructure Saving Engineering  é›²ç«¯çœéŒ¢å·¥ç¨‹","type":"event"},{"authors":[],"categories":["kubernetes"],"content":" æŠ•å½±ç‰‡è·Ÿè¬›ç¨¿æˆ‘éƒ½æ”¾åœ¨æˆ‘çš„ç¶²ç«™ä¸Šï¼Œå¦‚æœæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒ é›²ç«¯K8sçœéŒ¢å·¥ç¨‹ Che Chia Chang\nå…©å€‹é—œéµå­—ï¼šé›²ç«¯ / k8s å¦‚æœä½ æœ‰åœ¨ä½¿ç”¨å…¬æœ‰é›²ï¼Œè€Œä¸”æœ‰åœ¨è·‘ k8sï¼Œä½ æ˜¯é€™ç¯‡æ¼”è¬›çš„æœ€ä¸»è¦å°è±¡ å¦‚æœä½ æ˜¯ç§æœ‰é›² k8sï¼Œæˆ–æ˜¯å…¶ä»–çš„é›²ç«¯æœå‹™ï¼Œæœ‰ä¸€äº›ç›¸é€šçš„æ¦‚å¿µï¼Œæœƒæœ‰ä¸€äº›åƒè€ƒåƒ¹å€¼ å¦‚æœä½ æ˜¯åœ°ç«¯çš„æ©Ÿå™¨ï¼Œé›–ç„¶æ¦‚å¿µç›¸åŒï¼Œä½†æˆæœ¬æ§åˆ¶çš„åšæ³•å®Œå…¨æ˜¯å¦å¤–ä¸€å€‹æ•…äº‹ï¼Œä½ å¯ä»¥ç•¶åˆä¼‘æ™‚é–“çš„æ•…äº‹è½è½çœ‹ é—œæ–¼æˆ‘ Che Chia Chang SRE @ Maicoin Microsoft MVP å€‹äººéƒ¨è½æ ¼chechia.net presentation and speaker notes éµäººè³½ (Terraform / Vault æ‰‹æŠŠæ‰‹å…¥é–€) å¤§ç¶± å…¬æœ‰é›²çš„è²»ç”¨ ç¯€çœç®—åŠ›æˆæœ¬ ç›£æ§æ˜¯æˆæœ¬æ§ç®¡çš„åŸºç¤ å°å…¥æˆæœ¬åˆ†æèˆ‡é æ¸¬å·¥å…· è‡ªå‹•åŒ–è³‡æºä½¿ç”¨å»ºè­° Saving Plan/Committed Usage Spot Instance èˆ‡å¾®æœå‹™ Autoscaling: HPA / VPA Q\u0026amp;A é€™æ˜¯æˆ‘å€‘ä»Šå¤©çš„å¤§ç¶±\næˆ‘å€‘æœƒå…ˆè¬›ä¸€ä¸‹åœ¨å…¬æœ‰é›²ä¸Šçš„æˆæœ¬ ç„¶å¾Œè¬›ä¸€ä¸‹ k8s çš„é‹ç®—è³‡æºç®¡ç† æ¥è‘—è¬›ä¸€ä¸‹ç›£æ§ï¼Œç‚ºä½•æˆæœ¬æ§ç®¡çš„åŸºç¤æ˜¯ç›£æ§ å¦‚ä½•ä½¿ç”¨å·¥å…·æˆæœ¬åˆ†æï¼Œæœªä¾†æˆæœ¬é æ¸¬ ç„¶å¾Œä½¿ç”¨å·¥å…·å»ºè­°åˆé©çš„è³‡æº æœ€å¾Œè¬›å¯¦å‹™ä¸Šè¦å¦‚ä½•é™ä½æˆæœ¬ï¼Œä¾‹å¦‚ saving plan / spot instance / HPA / VPAï¼Œä¾ç…§åŸ·è¡Œçš„é›£åº¦æ’åºï¼Œæœ‰æ™‚é–“çš„è©±ä¹Ÿæœƒè¬›å¦‚ä½•å¾ç„¡åˆ°æœ‰é–‹å§‹é€²è¡Œ\nå‹•æ©Ÿ å…¬å¸å¸Œæœ›è³ºéŒ¢ï¼Œç¯€çœæˆæœ¬ åœ˜éšŠå¸Œæœ›æ§åˆ¶æˆæœ¬ å€‹äººç”¢ç”Ÿ Credit èˆ‡åœ˜éšŠ Impact åœ˜éšŠè€Œè¨€ï¼Œæˆæœ¬æ§åˆ¶æ˜¯ä¸€å€‹å¾ˆé‡è¦çš„è­°é¡Œï¼Œå› ç‚ºæˆæœ¬æ§åˆ¶æ˜¯ä¸€å€‹å¾ˆç›´æ¥çš„å½±éŸ¿å…¬å¸ç²åˆ©çš„æ–¹å¼ å€‹äººï¼Œå¦‚æœç‚ºå…¬å¸ç¯€çœè¶…éå€‹äººçš„è–ªæ°´ï¼Œé‚£å…¬å¸è˜ç”¨ä½ å°±æ˜¯æ·¨è³º ç¯€çœå…¬å¸é›²ç«¯æˆæœ¬ 50% è·æ¶¯ä¸Šå±¥æ­·å¾ˆå¥½çœ‹ å…¬æœ‰é›²çš„è²»ç”¨ æ‰“é–‹å…¬æœ‰é›²çš„ billing\nç®—åŠ›æˆæœ¬ Compute Resource (cpu, memory) å„²å­˜æˆæœ¬ Storage (Disk, EBS, S3â€¦) ç¶²è·¯ Networking æœ‰åœ¨ä½¿ç”¨å…¬æœ‰é›²çš„äººï¼ŒæŠŠå…¬æœ‰é›²çš„ billing å¸³å–®æ‰“é–‹ä¾†çœ‹ï¼Œå¯èƒ½çœ‹åˆ°çš„å¤§æ¦‚æ˜¯é€™å¹¾å€‹é …ç›® ç•¶ç„¶å› ç‚ºä¸åŒåœ˜éšŠçš„æœå‹™ä¸åŒï¼Œå¯èƒ½æœƒæœ‰ä¸€äº›å‡ºå…¥ï¼Œä½†å¦‚æœä½ çš„å…¬å¸çš„ç”¢å“æ˜¯ web serviceï¼Œæ‡‰è©²æœƒæœ‰é€™å¹¾å€‹é …ç›® ä»Šå¤©åªæœƒè¬›é€™å€‹ç®—åŠ›æˆæœ¬ ç®—åŠ›æˆæœ¬ Compute Resource (cpu, memory) ä»Šå¤©åªæœƒè¬›é€™å€‹ Storage ä¸å¤ªå¥½èªªçœå°±çœï¼Œå› ç‚ºä½ çš„è³‡æ–™é‡å°±åœ¨é‚£é‚Šï¼Œæ”¾ä¸ä¸‹å°±æ˜¯è¦å†è²·ï¼Œæ‰€ä»¥ storage çš„æˆæœ¬æ§åˆ¶ï¼Œå¯èƒ½æ˜¯åœ¨è³‡æ–™çš„ä½¿ç”¨ä¸Šï¼Œä¾‹å¦‚è³‡æ–™çš„å£“ç¸®ï¼Œæˆ–æ˜¯è³‡æ–™çš„å‚™ä»½ï¼Œæˆ–æ˜¯è³‡æ–™çš„å­˜å–æ–¹å¼ï¼Œé€™äº›æ˜¯å¦å¤–ä¸€å€‹æ•…äº‹ ä½¿ç”¨å…¬æœ‰é›²çš„æœå‹™ï¼ŒåŸºæœ¬ä¸Š storage éƒ½æ˜¯ä¾æ“šä½¿ç”¨çš„å¤§å°è¨ˆåƒ¹ï¼Œè€Œä¸”éœ€å¤šæœå‹™éƒ½å¯ä»¥å‹•æ…‹å¢é•·ï¼Œä¾‹å¦‚å‹•æ…‹å¢åŠ  disk\nStorage / Database / Networking é€™å¹¾å€‹é …ç›®ï¼Œæˆ‘å€‘ä¸‹é›†å†ä¾†è«‡\nç®—åŠ›æˆæœ¬ ç¶²é æœå‹™çš„å¾®æœå‹™ç³»çµ±ï¼Œéƒ½éœ€è¦ç®—åŠ›\napi server cronjob business logic job database å¦‚éœ€ç¯€çœï¼Œä¹Ÿå¯ä»¥å¾é€™è£¡ä¸‹æ‰‹ å¦‚æœä½ è·Ÿæ•ç¤¾ä¸€æ¨£æ˜¯ web serviceï¼Œé‚£éº¼ cpu / memory å¯èƒ½æ˜¯ä½ æœ€å¤§çš„ä¸€ç­†æˆæœ¬\nä½ éœ€è¦è¶³å¤ é‹ç®—èƒ½åŠ› serve å®¢æˆ¶ï¼Œä¸ç®¡æ˜¯æ”¯æŒç”¨æˆ¶çš„requestï¼Œé€²è¡Œå•†æ¥­é‚è¼¯çš„é‹ç®—ï¼Œç„¶å¾ŒæŠŠé‹ç®—å®Œæˆçš„ç‹€æ…‹å›å‚³çµ¦å®¢æˆ¶ï¼Œæˆ–æ˜¯å­˜åœ¨è³‡æ–™åº«ä¸­ï¼Œæ¯ä¸€å€‹å‹•ä½œéƒ½éœ€è¦ç®—åŠ›\nè¶³å¤ çš„ cpu è·Ÿ memoryï¼Œä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè€Œæ˜¯è¶³å¤ ï¼Œä¸æœƒæµªè²»ï¼Œä¹Ÿä¸æœƒå› ç‚ºä¸è¶³è€Œå½±éŸ¿æœå‹™å“è³ª æˆ‘å€‘è¦çœéŒ¢ï¼Œå°±è¦å¾é€™è£¡ä¸‹æ‰‹\nå°‹æ‰¾å¤šé¤˜çš„ç®—åŠ› å·²æœ‰è¶³å¤ çš„ cpu / memoryï¼Œå¤šçµ¦ä¹Ÿä¸æœƒå¢åŠ æœå‹™å“è³ªçš„å¤šé¤˜ç®—åŠ› å¤šå°‘æ‰æ˜¯å¤ ï¼Ÿ æ¸›å»å¤šå°‘ cpu / memoryï¼Œä¾ç„¶ä¸æ”¹è®Šæœå‹™å“è³ª å¤šå°‘æ‰æ˜¯å¤ ï¼Ÿé€™æ˜¯ä¸€å€‹è¤‡é›œçš„å•é¡Œï¼Œå¯¦å‹™ä¸Šé€šå¸¸ä½¿ç”¨ SLA / SLO ä¾†è¡¡é‡æœå‹™å“è³ªï¼Œç„¶å¾Œæ ¹æ“šæœå‹™å“è³ªçš„è¦æ±‚ï¼Œä¾†è¨­å®š cpu / memory çš„é…é¡\næˆ‘å€‘ä»Šå¤©è¦åšçš„æ˜¯æˆæœ¬å„ªåŒ–ï¼Œç™½è©±çš„èªªæ˜¯é™ä½ cpu / memory çš„è¨­å®šé…é¡ï¼Œä½†æ˜¯æˆ‘å€‘ä¸èƒ½é™ä½åˆ°å½±éŸ¿æœå‹™å“è³ª ç”šè‡³é€€ä¸€ç™¾æ­¥ï¼Œé˜²å®ˆæ€§çš„ä¾†èªªï¼Œæˆ‘å€‘ä¸å¸Œæœ›å› ç‚ºé™ä½ cpu / memory çš„è¨­å®šé…é¡ï¼Œç‚ºäº†çœéŒ¢è€Œå°è‡´è² é¢çš„çµæœï¼Œç”šè‡³ç‚ºæœå‹™çš„ç©©å®šåº¦èƒŒé‹ã€‚\nç¶­æŒSLO ä»¥ç¶­æŒå„å€‹æœå‹™å…ƒä»¶çš„ SLOç‚ºå‰æï¼Œé™ä½ cpu / memory ä½¿ç”¨é‡\nç¶­æŒå€‹å€‹æœå‹™å…ƒä»¶çš„ SLO æ˜¯ä¸€å€‹å¾ˆå¥½çš„æŒ‡æ¨™ï¼Œå¦‚æœä½ çš„æœå‹™æ˜¯ 99.9% çš„ SLAï¼Œé‚£éº¼ä½ çš„æœå‹™å°±è¦ä¿è­‰ 99.9% çš„æ™‚é–“éƒ½æ˜¯æ­£å¸¸é‹ä½œçš„ï¼Œé‚£éº¼ä½ çš„ cpu / memory å°±è¦è¶³å¤ æ”¯æŒé€™å€‹ SLA\nè«‡ SLO ä¹‹å‰ï¼Œä½ è¦å…ˆçŸ¥é“ä½ çš„æœå‹™çš„ SLA æ˜¯å¤šå°‘ï¼Œä½ è¦å…ˆçŸ¥é“ç•¶å‰çš„ç‹€æ…‹æ˜¯å¤šå°‘ é€™å€‹åœ¨ç¨å¾Œçš„ monitoring æœƒæåˆ°ï¼Œç‚ºä»€éº¼ç›£æ§æ˜¯æˆæœ¬ç®¡ç†çš„åŸºç¤\nåŸºæ–¼ SLO çš„æˆæœ¬èª¿é™ è² è¼‰ç©©å®šçš„å…ƒä»¶ï¼Œå¯ä»¥æŠ“éå» 30d çš„ p99 cpu time æˆ– p99 memory usage + buffer è² è¼‰ä¸ç©©å®šçš„å…ƒä»¶ï¼Œä¾‹å¦‚ cpu usage èˆ‡å—æ´»èºç”¨æˆ¶æ•¸é‡æ­£æ¯”ï¼Œéœ€è¦æ­é… HPA æ°´å¹³æ‹“å±• è² è¼‰ä¸ç©©å®šçš„å…ƒä»¶ï¼Œä½†åˆä¸èƒ½æ°´å¹³æ‹“å±•ï¼Œä¾‹å¦‚ stateful serviceï¼Œå¯ä»¥è€ƒæ…® VPA è² è¼‰ç©©å®šçš„å…ƒä»¶ï¼Œå›ºå®šåƒå¤šå°‘ cpu / memoryï¼Œä»–çš„é™„è¼‰ä¸å¤ªå®¹æ˜“éš¨å¤–éƒ¨å› ç´ æ³¢å‹•çš„æœå‹™ï¼Œå¯ä»¥æŠ“éå» 30d çš„ p99 cpu time æˆ– p99 memory usage + bufferï¼Œç„¶å¾Œé™ä½ cpu / memory çš„è¨­å®šé…é¡ å°çµï¼šæˆæœ¬æ§ç®¡çš„åŸºæœ¬æ¦‚å¿µ å°‹æ‰¾æœå‹™ä¸­å¤šé¤˜ç®—åŠ› ä»¥ç¶­æŒ SLO ç‚ºå‰æ é™ä½ cpu / memory ä½¿ç”¨é‡ ä¾æ“šå…ƒä»¶è² è¼‰ç‰¹æ€§ï¼Œé¸æ“‡é©ç•¶çš„èª¿é™æ–¹å¼ k8s cpu / memory management https://kubernetes.io/docs/concepts/configuration/manage-resources-containers\nk8s å¦‚ä½•ç®¡ç† workload çš„ cpu èˆ‡ memory èª¿é™å¤šå°‘æœƒå½±éŸ¿æœå‹™å“è³ª é€™è£¡é¢å†è¬›ä¸€ä¸‹ k8s å¦‚ä½•ç®¡ç† cpu / memory\né€™é‚Šçš„é‡é»æ˜¯ï¼Œæ€éº¼æ¨£çš„èª¿æ•´æœƒå½±éŸ¿åˆ°æœå‹™å“è³ªï¼Œé‚£æˆ‘å€‘åšæˆæœ¬æ§åˆ¶çš„æ™‚å€™ï¼Œå°±ä¸è¦å»è¸©åˆ°é€™å€‹åº•ç·š\nHow k8s manage cpu / memory scheduler ä¾æ“š cpu / memory request èª¿åº¦ pod container runtime è¨­å®š cgroup cpu ä½¿ç”¨é‡ä¾æ“š request ä½” node æ¯”ä¾‹åˆ†é… æ§åˆ¶ cpu ç”¨é‡ä¸è¶…é limit memory ä½¿ç”¨ limitï¼Œè¶…é limit æœƒè¢« oomkillï¼Œä¸¦ä¾æ“šè¨­å®šé‡å•Ÿ ç•¶å‰ node memory ä¸è¶³æ™‚ï¼Œæœƒä¾æ“š pod request Evict pod æ–‡ä»¶è¬›å¾—å¾ˆæ¸…æ¥š ä¸Šé¢éƒ½æ˜¯æ¦‚å¿µï¼Œåº•ä¸‹é€²å¯¦ä½œ Monitoring ç›£æ§æ˜¯æˆæœ¬æ§ç®¡çš„åŸºç¤ ç›£æ¸¬æ˜¯æˆæœ¬æ§ç®¡çš„åŸºç¤ æ²’æœ‰ç›£æ¸¬å°±æ²’æœ‰ p99 cpu time / memory usageï¼Œä¹Ÿæ²’æœ‰ SLI/SLO æ²’æœ‰æª¢æ¸¬ä¸‹åšæˆæœ¬ç²¾ç°¡ï¼Œæœƒç¢°å£æœå‹™ å¦‚æœæ²’æœ‰ç›£æ¸¬å…ˆè£œæª¢æ¸¬ å¦‚æœæ²’æœ‰ monitoringï¼Œä¸Šé¢çš„å…©å¤§å‰æéƒ½ä¸å­˜åœ¨ ç›®å‰çš„ cpu / memory usageï¼Œruntime utilization çš„è³‡æ–™ ç›®å‰SLOï¼Œèª¿é™ä¹‹å¾Œæ–°çš„SLO\næ²’æœ‰æª¢æ¸¬ä¸‹ï¼Œé‚„æ˜¯å¯ä»¥åšæˆæœ¬ç²¾ç°¡ ç„¶è€Œè¦é¦¬å…’å¥½åˆè¦è€Œä¸åƒè‰ï¼Œä»Šå¤©å¦‚æœæŠŠ cpu / memory é™ä¸‹ä¾†ï¼Œæœ‰å¯èƒ½æœƒé¤“åˆ°æœå‹™ cpu throttling / memory oomkillï¼Œé€™äº›éƒ½æ˜¯å¯èƒ½ç™¼ç”Ÿçš„äº‹æƒ… æœƒç¢°å£æœå‹™\nç›£æ¸¬ï¼šèª¿æ•´å‰è¨­å®šç›®æ¨™åŸºæº–ç·š è¨­å®šç¯€çœç›®æ¨™ï¼šex. éå» 3 å€‹æœˆçš„ p99 è³‡æºç”¨é‡ 99% çš„æ™‚é–“ï¼Œmemory ä½¿ç”¨é‡éƒ½åœ¨é€™æ¢ç·šä»¥ä¸‹ 99% çš„æ™‚é–“ï¼Œcpu throttling åœ¨é€™æ¢ç·šä»¥ä¸‹ å¤šé¤˜çš„ç®—åŠ› = (åˆ†é…çš„ resource - p99) é‚£å¦‚æœæˆ‘å€‘æŠŠ cpu / memory é™ä½åˆ° p99 / p99.9 æœå‹™å“è³ªæœƒå—åˆ°å½±éŸ¿å—ï¼Ÿ åšä¹‹å‰è¦èƒ½è©•ä¼°åšå®Œå¤§æ¦‚èƒ½çœå¤šå°‘ ä¾‹å¦‚è©•ä¼°å®Œå¾Œ\nå¦‚æœè©•ä¼°å®Œç™¼ç¾çœä¸äº†ä»€éº¼éŒ¢ï¼Œé‚£ç•¶ç„¶åœ˜éšŠå°±ä¸ä¸€å®šè¦åšé€™ä»¶äº‹\nç›£æ¸¬: èª¿æ•´å¾Œ è³‡æºç”¨é‡æ˜¯å¦æœ‰è®ŠåŒ– ç¢ºå®šæ²’æœ‰æ”¹å£æ±è¥¿ï¼Œæœ‰å£è¦æœ‰åŠæ™‚çš„ alert æ•ˆèƒ½è¡¨ç¾ï¼šæœ‰å¯èƒ½æ²’å£ï¼Œä½†æ˜¯è®Šå¾ˆæ…¢ å¦‚æœä½ æ”¹å£äº†ï¼ŒåŠæ™‚çš„ alert æœƒæ•‘ä½ ä¸€å‘½\nperformance ç›£æ¸¬å¾ˆé‡è¦\næ¨è–¦ç›£æ¸¬å·¥å…· prometheus.io Kubecost / Opencost å¤§å®¶éƒ½çŸ¥é“ prometheus æ˜¯ä»€éº¼å—ï¼Ÿ\nçŸ¥é“çš„äººè«‹èˆ‰å€‹æ‰‹ ä¸çŸ¥é“çš„æˆ‘å¾ˆç°¡å–®èªªä¸€ä¸‹\næˆ‘å€‘æƒ³è¦çŸ¥é“ä¸€å€‹ pod æœƒéœ€è¦èŠ±å¤šå°‘ cpu / memoryï¼Œä½ å°±æŠŠå®ƒè·‘èµ·ä¾†ï¼Œç„¶å¾Œå»ç´€éŒ„è·‘èµ·ä¾†çš„ pod ç”¨äº†å¤šå°‘ cpu / memoryï¼Œç„¶å¾Œæ ¹æ“šæ™‚é–“çµ±è¨ˆï¼Œä½ å°±å¯ä»¥æ‹‰å‡ºä¸€å¼µåœ–ï¼Œçœ‹åˆ°é€™å€‹ pod ç”¨äº†å¤šå°‘ cpu / memory ä½ çš„ kubelet / cadvisor / container runtime æœƒçŸ¥é“ä½ çš„ container çš„ cpu / memory ä½¿ç”¨é‡ï¼ŒåŒ…å« request \u0026amp; limit ç„¶å¾Œæ˜¯å¦æœ‰ throttling æˆ–æ˜¯ oomkillï¼Œé€™äº›è³‡è¨Šéƒ½æœƒè¢« prometheus æ”¶é›†èµ·ä¾†ï¼Œç„¶å¾Œä½ å¯ä»¥é€éå…¶ä»–å·¥å…·ï¼Œä¾‹å¦‚ kubecost çœ‹åˆ°é€™äº›è³‡è¨Š\nhttps://grafana.com/grafana/dashboards/17375-k8s-resource-monitoring/\né€™æ˜¯ prometheus æ”¶é›†çš„è³‡æ–™ï¼Œvm çš„ resource ä½¿ç”¨é‡çš„ grafana dashboard å°å…¥æˆæœ¬åˆ†æèˆ‡é æ¸¬å·¥å…· æœ‰äº† prometheus å¾Œï¼Œæˆ‘å€‘çŸ¥é“çŸ­æœŸ/é•·æœŸçš„è³‡æºä½¿ç”¨ç‹€æ³ è¦æŠŠè³‡æºä½¿ç”¨è½‰æˆæˆæœ¬ï¼Œéœ€è¦ä¸€å€‹æˆæœ¬è¨ˆç®—å·¥å…· è©•ä¼°æ˜¯å¦è¦åšæˆæœ¬ç²¾ç°¡ï¼Œèƒ½å¤ æ¸›å°‘å¤šå°‘éŒ¢ ç®¡ç†ä¸Šçš„è€ƒé‡ï¼šæŠ•è³‡äººåŠ›æˆæœ¬ï¼Œèˆ‡é æœŸå›å ± æ”¿æ²»ä¸Šçš„è€ƒé‡ï¼Œåšæˆæœ¬ç¯€çœéœ€è¦æ™‚é–“è·ŸäººåŠ›è³‡æº æœ‰ä¸€å€‹ç²¾æº–çš„æˆæœ¬åˆ†æï¼Œç¯€çœç©ºé–“ä¼°ç®—çš„å·¥å…·ååˆ†æœ‰èªªæœåŠ›\næœ‰é€™äº›è³‡æ–™ï¼Œæ‰å¯ä»¥ç§‘å­¸åŒ–æ±ºç­–è¦ä¸è¦åšï¼Œè©²æ€éº¼åš åšä¹‹å‰å°±èƒ½è©•ä¼°åšå®Œå¤§æ¦‚èƒ½çœå¤šå°‘\nå¦‚æœè©•ä¼°å®Œç™¼ç¾çœä¸äº†ä»€éº¼éŒ¢ï¼Œé‚£ç•¶ç„¶åœ˜éšŠå°±ä¸ä¸€å®šè¦åšé€™ä»¶äº‹\næˆæœ¬åˆ†æ VM å¯ä»¥ç”¨å„å®¶å…¬æœ‰é›²çš„è²»ç”¨è¨ˆç®—å·¥å…· Azure Cost Management AWS Cost Explorer GCP Cost Breakdown æˆæœ¬åˆ†æï¼šå…¬æœ‰é›² billing è¨ˆç®—é•·æ™‚é–“çš„è²»ç”¨è¶¨å‹¢ é©åˆç•¶ä½œæˆæœ¬ç²¾ç°¡å¾Œçš„æˆæœå›å ± ä¸é©åˆç•¶åšèª¿æ•´çš„ä¾æ“š æ™‚é–“è¨ˆç®—è¼ƒé•·ï¼Œåé¥‹æ™‚é–“é•·ï¼Œä¸åŠæ™‚ï¼Œé …ç›®ä¸å¤ ç²¾ç´° æœ‰ç„¡æ›´å³æ™‚çš„æˆæœ¬åˆ†æå·¥å…·ï¼Ÿ æˆæœ¬åˆ†æ: Kubecost / Opencost æœ‰æä¾› UI åŸºæ–¼ prometheus å¯ä»¥é‡å° allocation åšæˆæœ¬åˆ†æ Cost Allocation å¯ä»¥é€é cloud provider å»æ’ˆé›²ç«¯çš„ä½¿ç”¨è³‡æ–™ https://docs.kubecost.com/using-kubecost/navigating-the-kubecost-ui/cost-allocation\nhttps://docs.kubecost.com/using-kubecost/navigating-the-kubecost-ui/cost-allocation/efficiency-idle\næ¨è–¦å·¥å…· https://github.com/robusta-dev/krr Kubecost / Opencost Savings VPA recommendator æ¨è–¦å·¥å…·: Kubecost / Opencost Savings è¨­å®š target utilization request / allocatable dev 80%+ prod 60% æ ¹æ“šæœå‹™å“è³ªçš„è¦æ±‚ï¼Œä»¥åŠå…¬å¸æ”¿ç­–å»åšè¨­å®š SLA/SLO é–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒï¼Œåœ¨ä¸å½±éŸ¿å·¥ä½œçš„å‰æï¼Œéƒ½å¯ä»¥æ‹‰åˆ° overcommit æ¨è–¦å·¥å…·: KRR https://github.com/robusta-dev/krr å…å®‰è£ï¼Œ â€¦","date":1719837900,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1719980793,"objectID":"b0f9e57fc1ebd344be514e5f25fc24b9","permalink":"https://chechia.net/zh-hant/slides/2024-07-03-saving-money-on-cloud-k8s/","publishdate":"2024-07-01T12:45:00Z","relpermalink":"/zh-hant/slides/2024-07-03-saving-money-on-cloud-k8s/","section":"slides","summary":"åˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan","tags":["kafka","kubernetes"],"title":"Cloud Summit: Cloud Infrastructure Saving Engineering  é›²ç«¯çœéŒ¢å·¥ç¨‹","type":"slides"},{"authors":[],"categories":[],"content":"Get-Started Google â€œhow to contribute to kubernetesâ€ click the first link you like in every page do what the page says Get-Started https://www.kubernetes.dev https://www.kubernetes.dev/docs/guide/ Contributor Playground Youtube: New Contributor Series 2018-2019 Join the Kubernetes Slack Contribute to kubernetes Documentation Join Group https://www.kubernetes.dev/community/community-groups/ SIG-DOCS Find Issue on Github https://github.com/kubernetes/website/issues/38681 Contributing to Kubernetes Documentation Join sig-docs google groupd Prerequisites In my opinion, the following are the prerequisites to contribute to Kubernetes:\nEnglish proficiency Unorganized Links Community-membership actively contributer Community Forums ","date":1714213123,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1719800115,"objectID":"f345716cecd78bb059146b4b34f1db6f","permalink":"https://chechia.net/zh-hant/post/2024-04-27-contribute-to-k8s/","publishdate":"2024-04-27T18:18:43+08:00","relpermalink":"/zh-hant/post/2024-04-27-contribute-to-k8s/","section":"post","summary":"Get-Started Google â€œhow to contribute to kubernetesâ€ click the first link you like in every page do what the page says Get-Started https://www.kubernetes.dev https://www.kubernetes.dev/docs/guide/ Contributor Playground Youtube: New Contributor Series 2018-2019 Join the Kubernetes Slack Contribute to kubernetes Documentation Join Group https://www.","tags":[],"title":"2024 04 27 Contribute to K8s","type":"post"},{"authors":[],"categories":["kubernetes","aws"],"content":"Info Title: SRE Conference: Cloud Infrastructure Saving Engineering é›²ç«¯çœéŒ¢å·¥ç¨‹\nä½¿ç”¨ AWS èˆ‡ Kubernetes å°±æ˜¯è¦èŠ±éŒ¢ï¼Œå¦‚ä½•çœéŒ¢ï¼Ÿ åˆç†çš„è¨­å®šè³‡æºï¼Œä¸åƒ…çœéŒ¢ï¼Œé‚„æå‡æ•´é«”æœå‹™ç©©å®šåº¦ï¼Ÿ æ—¢æœ‰æœå‹™å·²ç¶“å­˜åœ¨ï¼Œå¦‚ä½•é€æ­¥æ”¹è®Šï¼Œé™ä½æˆæœ¬ï¼Ÿ\næœ¬æ¬¡æ¼”è¬›ä»¥å¯¦å‹™çš„ç¯„ä¾‹ï¼Œåˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving planâ€¦ï¼Œä¸¦åˆ†äº«å¦‚ä½•æ”¹è®Šæ–‡åŒ–ï¼Œæé«˜åœ˜éšŠçš„æˆæœ¬æ„è­˜ï¼Œå¯¦éš›çš„é™ä½é–‹éŠ·\nTarget group AWS \u0026amp; Kubernetes User who want to decrease overall cost of infrastructure\nå°å…¥å·¥å…·ï¼šæœ‰å“ªäº›å·¥å…·å¯ä»¥ä½¿ç”¨ åˆ†æç¾æ³ï¼šç²¾ç®—å„åœ˜éšŠèˆ‡å„å°ˆæ¡ˆæˆæœ¬ æ”¹è®Šç¾æ³ï¼šå¾æ—¢æœ‰çš„æ¶æ§‹ä¸­ï¼Œæ‰¾å°‹å¯ä»¥ç¯€çœæˆæœ¬çš„åœ°æ–¹ æ”¹å–„æµç¨‹ï¼šæœ‰æ•ˆç‡çš„ç¶­æŒçœéŒ¢ workflow æ”¹è®Šæ–‡åŒ–ï¼šæŒçºŒæ€§ä½ç¶­æŒæ–°æœå‹™èˆ‡èˆŠæœå‹™çš„åˆç†æˆæœ¬ Author Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","date":1714137600,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1713932735,"objectID":"da8760839238a071aee0bb02b11bdee2","permalink":"https://chechia.net/zh-hant/talk/sre-conference-cloud-infrastructure-saving-engineering-%E9%9B%B2%E7%AB%AF%E7%9C%81%E9%8C%A2%E5%B7%A5%E7%A8%8B/","publishdate":"2024-04-01T00:00:00Z","relpermalink":"/zh-hant/talk/sre-conference-cloud-infrastructure-saving-engineering-%E9%9B%B2%E7%AB%AF%E7%9C%81%E9%8C%A2%E5%B7%A5%E7%A8%8B/","section":"event","summary":"åˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan","tags":["vault","iac","aws","terraform","kubernetes","cost"],"title":"SRE Conference: Cloud Infrastructure Saving Engineering  é›²ç«¯çœéŒ¢å·¥ç¨‹","type":"event"},{"authors":[],"categories":["kubernetes"],"content":" æŠ•å½±ç‰‡è·Ÿè¬›ç¨¿æˆ‘éƒ½æ”¾åœ¨æˆ‘çš„ç¶²ç«™ä¸Šï¼Œå¦‚æœæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒ Cost Management of Cloud Kubernetes é›²ç«¯K8sçœéŒ¢å·¥ç¨‹ Che Chia Chang\nå…©å€‹é—œéµå­—ï¼šé›²ç«¯ / k8s å¦‚æœä½ æœ‰åœ¨ä½¿ç”¨å…¬æœ‰é›²ï¼Œè€Œä¸”æœ‰åœ¨è·‘ k8sï¼Œä½ æ˜¯é€™ç¯‡æ¼”è¬›çš„æœ€ä¸»è¦å°è±¡ å¦‚æœä½ æ˜¯ç§æœ‰é›² k8sï¼Œæˆ–æ˜¯å…¶ä»–çš„é›²ç«¯æœå‹™ï¼Œæœ‰ä¸€äº›ç›¸é€šçš„æ¦‚å¿µï¼Œæœƒæœ‰ä¸€äº›åƒè€ƒåƒ¹å€¼ å¦‚æœä½ æ˜¯åœ°ç«¯çš„æ©Ÿå™¨ï¼Œé›–ç„¶æ¦‚å¿µç›¸åŒï¼Œä½†æˆæœ¬æ§åˆ¶çš„åšæ³•å®Œå…¨æ˜¯å¦å¤–ä¸€å€‹æ•…äº‹ï¼Œä½ å¯ä»¥ç•¶åˆä¼‘æ™‚é–“çš„æ•…äº‹è½è½çœ‹ About Me Che Chia Chang SRE @ Maicoin Microsoft MVP å€‹äººéƒ¨è½æ ¼chechia.net presentation and speaker notes éµäººè³½ (Terraform / Vault æ‰‹æŠŠæ‰‹å…¥é–€) Outline Cost on Public Cloud K8s Compute Resource Management Monitoring Cost Analysis and Prediction Resource Recommendation Saving Plan Spot Instance HPA / VPA Q\u0026amp;A é€™æ˜¯æˆ‘å€‘ä»Šå¤©çš„å¤§ç¶±\næˆ‘å€‘æœƒå…ˆè¬›ä¸€ä¸‹åœ¨å…¬æœ‰é›²ä¸Šçš„æˆæœ¬ ç„¶å¾Œè¬›ä¸€ä¸‹ k8s çš„é‹ç®—è³‡æºç®¡ç† æ¥è‘—è¬›ä¸€ä¸‹ç›£æ§ï¼Œç‚ºä½•æˆæœ¬æ§ç®¡çš„åŸºç¤æ˜¯ç›£æ§ å¦‚ä½•ä½¿ç”¨å·¥å…·æˆæœ¬åˆ†æï¼Œæœªä¾†æˆæœ¬é æ¸¬ ç„¶å¾Œä½¿ç”¨å·¥å…·å»ºè­°åˆé©çš„è³‡æº æœ€å¾Œè¬›å¯¦å‹™ä¸Šè¦å¦‚ä½•é™ä½æˆæœ¬ï¼Œä¾‹å¦‚ saving plan / spot instance / HPA / VPAï¼Œä¾ç…§åŸ·è¡Œçš„é›£åº¦æ’åºï¼Œæœ‰æ™‚é–“çš„è©±ä¹Ÿæœƒè¬›å¦‚ä½•å¾ç„¡åˆ°æœ‰é–‹å§‹é€²è¡Œ\nCost on Public Cloud open your cloud billing\nCompute Resource (cpu, memory) Storage (Disk, EBS, S3â€¦) Database (Compute Resource + Storage) Networking æœ‰åœ¨ä½¿ç”¨å…¬æœ‰é›²çš„äººï¼ŒæŠŠå…¬æœ‰é›²çš„ billing å¸³å–®æ‰“é–‹ä¾†çœ‹ï¼Œå¯èƒ½çœ‹åˆ°çš„å¤§æ¦‚æ˜¯é€™å¹¾å€‹é …ç›® ç•¶ç„¶å› ç‚ºä¸åŒåœ˜éšŠçš„æœå‹™ä¸åŒï¼Œå¯èƒ½æœƒæœ‰ä¸€äº›å‡ºå…¥ï¼Œä½†å¦‚æœä½ çš„å…¬å¸çš„ç”¢å“æ˜¯ web serviceï¼Œæ‡‰è©²æœƒæœ‰é€™å¹¾å€‹é …ç›® Todayâ€™s topic Todayâ€™s topic\nCompute Resource cpu \u0026amp; memory Maybe next time\nStorage (Disk, EBS, S3â€¦) Database (Compute Resource + Storage) Networking Storage ä¸å¤ªå¥½èªªçœå°±çœï¼Œå› ç‚ºä½ çš„è³‡æ–™é‡å°±åœ¨é‚£é‚Šï¼Œæ”¾ä¸ä¸‹å°±æ˜¯è¦å†è²·ï¼Œæ‰€ä»¥ storage çš„æˆæœ¬æ§åˆ¶ï¼Œå¯èƒ½æ˜¯åœ¨è³‡æ–™çš„ä½¿ç”¨ä¸Šï¼Œä¾‹å¦‚è³‡æ–™çš„å£“ç¸®ï¼Œæˆ–æ˜¯è³‡æ–™çš„å‚™ä»½ï¼Œæˆ–æ˜¯è³‡æ–™çš„å­˜å–æ–¹å¼ï¼Œé€™äº›æ˜¯å¦å¤–ä¸€å€‹æ•…äº‹ ä½¿ç”¨å…¬æœ‰é›²çš„æœå‹™ï¼ŒåŸºæœ¬ä¸Š storage éƒ½æ˜¯ä¾æ“šä½¿ç”¨çš„å¤§å°è¨ˆåƒ¹ï¼Œè€Œä¸”éœ€å¤šæœå‹™éƒ½å¯ä»¥å‹•æ…‹å¢é•·ï¼Œä¾‹å¦‚å‹•æ…‹å¢åŠ  disk\nStorage / Database / Networking é€™å¹¾å€‹é …ç›®ï¼Œæˆ‘å€‘ä¸‹é›†å†ä¾†è«‡\nCost on Public Cloud CPU / memory intense web service\nRESTful api long-connetion service business logic save state to disk / database å¦‚æœä½ è·Ÿæ•ç¤¾ä¸€æ¨£æ˜¯ web serviceï¼Œé‚£éº¼ cpu / memory å¯èƒ½æ˜¯ä½ æœ€å¤§çš„ä¸€ç­†æˆæœ¬\nä½ éœ€è¦è¶³å¤ é‹ç®—èƒ½åŠ› serve å®¢æˆ¶ï¼Œä¸ç®¡æ˜¯æ”¯æŒç”¨æˆ¶çš„requestï¼Œé€²è¡Œå•†æ¥­é‚è¼¯çš„é‹ç®—ï¼Œç„¶å¾ŒæŠŠé‹ç®—å®Œæˆçš„ç‹€æ…‹å›å‚³çµ¦å®¢æˆ¶ï¼Œæˆ–æ˜¯å­˜åœ¨è³‡æ–™åº«ä¸­ï¼Œæ¯ä¸€å€‹å‹•ä½œéƒ½éœ€è¦ç®—åŠ›\nè¶³å¤ çš„ cpu è·Ÿ memoryï¼Œä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè€Œæ˜¯è¶³å¤ ï¼Œä¸æœƒæµªè²»ï¼Œä¹Ÿä¸æœƒå› ç‚ºä¸è¶³è€Œå½±éŸ¿æœå‹™å“è³ª æˆ‘å€‘è¦çœéŒ¢ï¼Œå°±è¦å¾é€™è£¡ä¸‹æ‰‹\nå°‹æ‰¾å¤šé¤˜çš„ç®—åŠ› å·²æœ‰è¶³å¤ çš„ cpu / memoryï¼Œå¤šçµ¦ä¹Ÿä¸æœƒå¢åŠ æœå‹™å“è³ªçš„å¤šé¤˜ç®—åŠ› å¤šå°‘æ‰æ˜¯å¤ ï¼Ÿ æ¸›å»å¤šå°‘ cpu / memoryï¼Œä¾ç„¶ä¸æ”¹è®Šæœå‹™å“è³ª å¤šå°‘æ‰æ˜¯å¤ ï¼Ÿé€™æ˜¯ä¸€å€‹è¤‡é›œçš„å•é¡Œï¼Œå¯¦å‹™ä¸Šé€šå¸¸ä½¿ç”¨ SLA / SLO ä¾†è¡¡é‡æœå‹™å“è³ªï¼Œç„¶å¾Œæ ¹æ“šæœå‹™å“è³ªçš„è¦æ±‚ï¼Œä¾†è¨­å®š cpu / memory çš„é…é¡\næˆ‘å€‘ä»Šå¤©è¦åšçš„æ˜¯æˆæœ¬å„ªåŒ–ï¼Œç™½è©±çš„èªªæ˜¯é™ä½ cpu / memory çš„è¨­å®šé…é¡ï¼Œä½†æ˜¯æˆ‘å€‘ä¸èƒ½é™ä½åˆ°å½±éŸ¿æœå‹™å“è³ª ç”šè‡³é€€ä¸€ç™¾æ­¥ï¼Œé˜²å®ˆæ€§çš„ä¾†èªªï¼Œæˆ‘å€‘ä¸å¸Œæœ›å› ç‚ºé™ä½ cpu / memory çš„è¨­å®šé…é¡ï¼Œç‚ºäº†çœéŒ¢è€Œå°è‡´è² é¢çš„çµæœï¼Œç”šè‡³ç‚ºæœå‹™çš„ç©©å®šåº¦èƒŒé‹ã€‚\nç¶­æŒSLO ä»¥ç¶­æŒå„å€‹æœå‹™å…ƒä»¶çš„ SLOç‚ºå‰æï¼Œé™ä½ cpu / memory ä½¿ç”¨é‡\nç¶­æŒå€‹å€‹æœå‹™å…ƒä»¶çš„ SLO æ˜¯ä¸€å€‹å¾ˆå¥½çš„æŒ‡æ¨™ï¼Œå¦‚æœä½ çš„æœå‹™æ˜¯ 99.9% çš„ SLAï¼Œé‚£éº¼ä½ çš„æœå‹™å°±è¦ä¿è­‰ 99.9% çš„æ™‚é–“éƒ½æ˜¯æ­£å¸¸é‹ä½œçš„ï¼Œé‚£éº¼ä½ çš„ cpu / memory å°±è¦è¶³å¤ æ”¯æŒé€™å€‹ SLA\nè«‡ SLO ä¹‹å‰ï¼Œä½ è¦å…ˆçŸ¥é“ä½ çš„æœå‹™çš„ SLA æ˜¯å¤šå°‘ï¼Œä½ è¦å…ˆçŸ¥é“ç•¶å‰çš„ç‹€æ…‹æ˜¯å¤šå°‘ é€™å€‹åœ¨ç¨å¾Œçš„ monitoring æœƒæåˆ°ï¼Œç‚ºä»€éº¼ç›£æ§æ˜¯æˆæœ¬ç®¡ç†çš„åŸºç¤\nåŸºæ–¼ SLO çš„æˆæœ¬èª¿é™ è² è¼‰ç©©å®šçš„å…ƒä»¶ï¼Œå¯ä»¥æŠ“éå» 30d çš„ p99 cpu time æˆ– p99 memory usage + buffer è² è¼‰ä¸ç©©å®šçš„å…ƒä»¶ï¼Œä¾‹å¦‚ cpu usage èˆ‡å—æ´»èºç”¨æˆ¶æ•¸é‡æ­£æ¯”ï¼Œéœ€è¦æ­é… HPA æ°´å¹³æ‹“å±• è² è¼‰ä¸ç©©å®šçš„å…ƒä»¶ï¼Œä½†åˆä¸èƒ½æ°´å¹³æ‹“å±•ï¼Œä¾‹å¦‚ stateful serviceï¼Œå¯ä»¥è€ƒæ…® VPA è² è¼‰ç©©å®šçš„å…ƒä»¶ï¼Œå›ºå®šåƒå¤šå°‘ cpu / memoryï¼Œä»–çš„é™„è¼‰ä¸å¤ªå®¹æ˜“éš¨å¤–éƒ¨å› ç´ æ³¢å‹•çš„æœå‹™ï¼Œå¯ä»¥æŠ“éå» 30d çš„ p99 cpu time æˆ– p99 memory usage + bufferï¼Œç„¶å¾Œé™ä½ cpu / memory çš„è¨­å®šé…é¡ å°çµï¼šæˆæœ¬æ§ç®¡çš„åŸºæœ¬æ¦‚å¿µ å°‹æ‰¾æœå‹™ä¸­å¤šé¤˜ç®—åŠ› ä»¥ç¶­æŒ SLO ç‚ºå‰æ é™ä½ cpu / memory ä½¿ç”¨é‡ ä¾æ“šå…ƒä»¶è² è¼‰ç‰¹æ€§ï¼Œé¸æ“‡é©ç•¶çš„èª¿é™æ–¹å¼ Background Knowledge k8s cpu / memory management https://kubernetes.io/docs/concepts/configuration/manage-resources-containers\nk8s å¦‚ä½•ç®¡ç† workload çš„ cpu èˆ‡ memory èª¿é™å¤šå°‘æœƒå½±éŸ¿æœå‹™å“è³ª é€™è£¡é¢å†è¬›ä¸€ä¸‹ k8s å¦‚ä½•ç®¡ç† cpu / memory\né€™é‚Šçš„é‡é»æ˜¯ï¼Œæ€éº¼æ¨£çš„èª¿æ•´æœƒå½±éŸ¿åˆ°æœå‹™å“è³ªï¼Œé‚£æˆ‘å€‘åšæˆæœ¬æ§åˆ¶çš„æ™‚å€™ï¼Œå°±ä¸è¦å»è¸©åˆ°é€™å€‹åº•ç·š\nHow k8s manage cpu / memory scheduler ä¾æ“š cpu / memory request èª¿åº¦ pod container runtime è¨­å®š cgroup cpu ä½¿ç”¨é‡ä¾æ“š request ä½” node æ¯”ä¾‹åˆ†é… æ§åˆ¶ cpu ç”¨é‡ä¸è¶…é limit memory ä½¿ç”¨ limitï¼Œè¶…é limit æœƒè¢« oomkillï¼Œä¸¦ä¾æ“šè¨­å®šé‡å•Ÿ ç•¶å‰ node memory ä¸è¶³æ™‚ï¼Œæœƒä¾æ“š pod request Evict pod æ–‡ä»¶è¬›å¾—å¾ˆæ¸…æ¥š ä¸Šé¢éƒ½æ˜¯æ¦‚å¿µï¼Œåº•ä¸‹é€²å¯¦ä½œ Monitoring Monitoring æ˜¯ cost management çš„åŸºç¤ æ²’æœ‰ monitoring å°±æ²’æœ‰ p99 cpu time / p99 memory usageï¼Œä¹Ÿæ²’æœ‰ SLI/SLO å¦‚æœæ²’æœ‰ monitoring å…ˆè£œ monitoring å¦‚æœæ²’æœ‰ monitoringï¼Œä¸Šé¢çš„å…©å¤§å‰æéƒ½ä¸å­˜åœ¨ ç›®å‰çš„ cpu / memory usageï¼Œruntime utilization çš„è³‡æ–™ ç›®å‰SLOï¼Œèª¿é™ä¹‹å¾Œæ–°çš„SLO Monitoring: èª¿æ•´å‰ éå»çš„ p99 è³‡æºç”¨é‡ ç›®å‰çš„æ•ˆèƒ½è¡¨ç¾ å¤šé¤˜çš„ç®—åŠ› = (åˆ†é…çš„ resource - p99) åšä¹‹å‰è¦èƒ½è©•ä¼°åšå®Œå¤§æ¦‚èƒ½çœå¤šå°‘ ä¾‹å¦‚è©•ä¼°å®Œå¾Œ\nå¦‚æœè©•ä¼°å®Œç™¼ç¾çœä¸äº†ä»€éº¼éŒ¢ï¼Œé‚£ç•¶ç„¶åœ˜éšŠå°±ä¸ä¸€å®šè¦åšé€™ä»¶äº‹\nMonitoring: èª¿æ•´å¾Œ èª¿æ•´å‰å¾Œæ¯”è¼ƒ\nè³‡æºç”¨é‡ ç›®å‰çš„æ•ˆèƒ½è¡¨ç¾ ç¢ºå®šæ²’æœ‰æ”¹å£æ±è¥¿ æœ‰æ”¹å£ï¼Œè¦æœ‰åŠæ™‚çš„ alert å¦‚æœä½ æ”¹å£äº†ï¼ŒåŠæ™‚çš„ alert æœƒæ•‘ä½ ä¸€å‘½ Monitoring Tools prometheus.io Kubecost / Opencost å¤§å®¶éƒ½çŸ¥é“ prometheus æ˜¯ä»€éº¼å—ï¼Ÿ\nçŸ¥é“çš„äººè«‹èˆ‰å€‹æ‰‹ ä¸çŸ¥é“çš„æˆ‘å¾ˆç°¡å–®èªªä¸€ä¸‹\næˆ‘å€‘æƒ³è¦çŸ¥é“ä¸€å€‹ pod æœƒéœ€è¦èŠ±å¤šå°‘ cpu / memoryï¼Œä½ å°±æŠŠå®ƒè·‘èµ·ä¾†ï¼Œç„¶å¾Œå»ç´€éŒ„è·‘èµ·ä¾†çš„ pod ç”¨äº†å¤šå°‘ cpu / memoryï¼Œç„¶å¾Œæ ¹æ“šæ™‚é–“çµ±è¨ˆï¼Œä½ å°±å¯ä»¥æ‹‰å‡ºä¸€å¼µåœ–ï¼Œçœ‹åˆ°é€™å€‹ pod ç”¨äº†å¤šå°‘ cpu / memory ä½ çš„ kubelet / cadvisor / container runtime æœƒçŸ¥é“ä½ çš„ container çš„ cpu / memory ä½¿ç”¨é‡ï¼ŒåŒ…å« request \u0026amp; limit ç„¶å¾Œæ˜¯å¦æœ‰ throttling æˆ–æ˜¯ oomkillï¼Œé€™äº›è³‡è¨Šéƒ½æœƒè¢« prometheus æ”¶é›†èµ·ä¾†ï¼Œç„¶å¾Œä½ å¯ä»¥é€éå…¶ä»–å·¥å…·ï¼Œä¾‹å¦‚ kubecost çœ‹åˆ°é€™äº›è³‡è¨Š\nhttps://grafana.com/grafana/dashboards/17375-k8s-resource-monitoring/\né€™æ˜¯ prometheus æ”¶é›†çš„è³‡æ–™ï¼Œvm çš„ resource ä½¿ç”¨é‡çš„ grafana dashboard Cost Analysis and Prediction æœ‰äº† prometheus å¾Œï¼Œæˆ‘å€‘çŸ¥é“çŸ­æœŸ/é•·æœŸçš„è³‡æºä½¿ç”¨ç‹€æ³ è¦æŠŠè³‡æºä½¿ç”¨è½‰æˆæˆæœ¬ï¼Œéœ€è¦ä¸€å€‹æˆæœ¬è¨ˆç®—å·¥å…· è©•ä¼°æ˜¯å¦è¦åšæˆæœ¬ç²¾ç°¡ï¼Œèƒ½å¤ æ¸›å°‘å¤šå°‘éŒ¢ ç®¡ç†ä¸Šçš„è€ƒé‡ï¼šæŠ•è³‡äººåŠ›æˆæœ¬ï¼Œèˆ‡é æœŸå›å ± æ”¿æ²»ä¸Šçš„è€ƒé‡ï¼Œåšæˆæœ¬ç¯€çœéœ€è¦æ™‚é–“è·ŸäººåŠ›è³‡æº æœ‰ä¸€å€‹ç²¾æº–çš„æˆæœ¬åˆ†æï¼Œç¯€çœç©ºé–“ä¼°ç®—çš„å·¥å…·ååˆ†æœ‰èªªæœåŠ›\næœ‰é€™äº›è³‡æ–™ï¼Œæ‰å¯ä»¥ç§‘å­¸åŒ–æ±ºç­–è¦ä¸è¦åšï¼Œè©²æ€éº¼åš åšä¹‹å‰å°±èƒ½è©•ä¼°åšå®Œå¤§æ¦‚èƒ½çœå¤šå°‘\nå¦‚æœè©•ä¼°å®Œç™¼ç¾çœä¸äº†ä»€éº¼éŒ¢ï¼Œé‚£ç•¶ç„¶åœ˜éšŠå°±ä¸ä¸€å®šè¦åšé€™ä»¶äº‹\nCost Analysis: billing å„å®¶å…¬æœ‰å…ƒéƒ½æœ‰è‡ªå·±çš„è²»ç”¨è¨ˆç®—å·¥å…· Azure Cost Management AWS Cost Explorer GCP Cost Breakdown Cost Analysis: Cloud billing è¨ˆç®—é•·æ™‚é–“çš„è²»ç”¨è¶¨å‹¢ é©åˆç•¶ä½œæˆæœ¬ç²¾ç°¡å¾Œçš„æˆæœå›å ± ä¸é©åˆç•¶åšèª¿æ•´çš„ä¾æ“š æ™‚é–“è¨ˆç®—è¼ƒé•·ï¼Œåé¥‹æ™‚é–“é•·ï¼Œä¸åŠæ™‚ï¼Œé …ç›®ä¸å¤ ç²¾ç´° æœ‰ç„¡æ›´å³æ™‚çš„æˆæœ¬åˆ†æå·¥å…·ï¼Ÿ Cost Analysis: Kubecost / Opencost æœ‰æä¾› UI åŸºæ–¼ prometheus å¯ä»¥é‡å° allocation åšæˆæœ¬åˆ†æ Cost Allocation å¯ä»¥é€é cloud provider å»æ’ˆé›²ç«¯çš„ä½¿ç”¨è³‡æ–™ https://docs.kubecost.com/using-kubecost/navigating-the-kubecost-ui/cost-allocation\nhttps://docs.kubecost.com/using-kubecost/navigating-the-kubecost-ui/cost-allocation/efficiency-idle\nRecommedation Tools https://github.com/robusta-dev/krr Kubecost / Opencost Savings VPA recommendator Recommedation Tools: Kubecost / Opencost Savings è¨­å®š target utilization dev 80%+ prod 60% æ ¹æ“šæœå‹™å“è³ªçš„è¦æ±‚ï¼Œä»¥åŠå…¬å¸æ”¿ç­–å»åšè¨­å®š SLA/SLO é–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒï¼Œåœ¨ä¸å½±éŸ¿å·¥ä½œçš„å‰æï¼Œéƒ½å¯ä»¥æ‹‰åˆ° overcommit Recommedation Tools: KRR â€¦","date":1711411200,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1714110971,"objectID":"f6762a4ddacc51e570d92a180c8651af","permalink":"https://chechia.net/zh-hant/slides/2024-04-26-saving-money-on-cloud-k8s/","publishdate":"2024-03-26T00:00:00Z","relpermalink":"/zh-hant/slides/2024-04-26-saving-money-on-cloud-k8s/","section":"slides","summary":"åˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan","tags":["kafka","kubernetes"],"title":"SRE Conference: Cloud Infrastructure Saving Engineering  é›²ç«¯çœéŒ¢å·¥ç¨‹","type":"slides"},{"authors":[],"categories":["kubernetes","vault"],"content":"Info Title: Resource as Code for Kubernetes: stop kubectl apply\nhttps://k8s.ithome.com.tw/CFP\nInfrastrure as Code (IaC) èˆ‡ PaCï¼Œåœ¨è¬ç‰©éƒ½è©² as Code å¾—æ™‚ä»£ï¼Œä½ é‚„åœ¨ä¸æ–·çš„ kubectl apply å—ï¼Ÿ\næ‰‹å‹• apply çš„ç—›é»ï¼š\näººå°±æ˜¯æœƒå¿˜ï¼šæ˜¯èª° apply é€™å€‹åœ¨ k8s ä¸Šçš„ï¼Ÿæ˜¯èª°ä¸Šæ¬¡æ¼ apply æ‰€ä»¥å£äº†ï¼Ÿ äººå°±æ˜¯æœƒå¯«éŒ¯ï¼šèƒ½å¦ apply ç®¡ç†å¤§é‡çš„ label, taint, annotation å®‰å…¨ï¼šapply è®Šæ›´å…§å®¹æ˜¯å¦æœ‰ç¶“éè³‡è¨Šå®‰å…¨çš„ review ç•¶æœå‹™çš„ app code base éƒ½å·²ç¶“ç”¨ chart æ‰“åŒ…ï¼Œä½¿ç”¨ vcs ç®¡ç†å¾Œï¼Œç‚ºä½•ä¾è³´çš„ k8s resource (namespace, secret, label, crd, â€¦) ä¸éœ€è¦æ¨ä¸Š vcs ç®¡ç†çš„ï¼Ÿ\næœ¬æ¬¡æ¼”è¬›é›†åˆå¹¾å€‹ç®¡ç† k8s çš„ç¯„ä¾‹ï¼Œå°‡ k8s resource ä»¥ code ç®¡ç†ï¼Œæ¨ä¸Š vcsï¼Œä¸¦ä½¿ç”¨ argoCD, secret operator, â€¦ ç­‰å·¥å…·é€²è¡Œç®¡ç†ï¼Œä¾†è®“é¿å…ä½ç´šçš„äººå·¥æ“ä½œéŒ¯èª¤ï¼Œé™ä½åœ˜éšŠæ•´é«”å¤±èª¤ç‡ï¼Œä¸¦é™ä½ k8s admin ç®¡ç†çš„æˆæœ¬ï¼Œæé«˜ç®¡ç†æ•ˆç‡\ntarget group Kubernetes User who want to increase performance in k8s management\n","date":1698240000,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1713932423,"objectID":"52c6a9bbde2bd97e9bd818ac94ff1916","permalink":"https://chechia.net/zh-hant/talk/kubernetes-summit-resource-as-code-for-kubernetes-stop-kubectl-apply/","publishdate":"2023-09-10T00:00:00Z","relpermalink":"/zh-hant/talk/kubernetes-summit-resource-as-code-for-kubernetes-stop-kubectl-apply/","section":"event","summary":"å°‡ k8s resource ä»¥ code ç®¡ç†ï¼Œæ¨ä¸Š vcsï¼Œä¸¦ä½¿ç”¨ argoCD, secret operator ç­‰å·¥å…·é€²è¡Œç®¡ç†ï¼Œä¾†è®“é¿å…ä½ç´šçš„äººå·¥æ“ä½œéŒ¯èª¤ï¼Œé™ä½åœ˜éšŠæ•´é«”å¤±èª¤ç‡ï¼Œä¸¦é™ä½ k8s admin ç®¡ç†çš„æˆæœ¬ï¼Œæé«˜ç®¡ç†æ•ˆç‡","tags":["vault","iac","aws","terraform","kubernetes"],"title":"Kubernetes Summit: Resource as Code for Kubernetes: Stop kubectl apply","type":"event"},{"authors":[],"categories":["kubernetes"],"content":" Q1: æœ‰éä½¿ç”¨ helm è·Ÿ argocd çš„äººè«‹èˆ‰æ‰‹ Q2: k8s object èµ° gitflow ç®¡ç†çš„æ¯”ä¾‹æœ‰è¶…é 9 æˆçš„ Resource as Code for K8s Object å¦‚ä½•ç®¡ç† k8s object Che Chia Chang\nOutline Manage Kubernetes Objects in Gitflow\nkubectl helm chart argocd (gitflow) applicationset test ä»Šå¤©çš„å…§å®¹å‰åŠéƒ¨åƒæ˜¯è¬›å¤\né¦–å…ˆæœƒè¬› kubectl create / apply kubectl ä½¿ç”¨ï¼Œç„¶å¾Œå®˜æ–¹æœ‰æé†’æˆ‘å€‘ä½¿ç”¨ kubectl ç®¡ç† k8s object æ™‚çš„ trade-offï¼Œé€™äº› trade-off æˆ‘å€‘å¯ä»¥ä½¿ç”¨å…¶ä»–çš„å·¥å…·ä¾†å½Œè£œ\nå°å…¥ helm chartï¼Œä¾†æ‰“åŒ… k8s objects è®Šæˆä¸€å€‹å®Œæ•´åœ°ç™¼å¸ƒå–®ä½\nargocd èµ° gitflow ä¾†ç™¼å¸ƒ\nç„¶å¾Œåœ¨ workflow è£¡åŠ å…¥æ¸¬è©¦ï¼Œç¢ºä¿ k8s objects çš„äº¤ä»˜å“è³ª\nKubectl # Imperative commands kubectl create deployment nginx --image nginx # Imperative object configuration kubectl create -f nginx.yaml # Declarative object configuration kubectl apply -R -f configs/ https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/#management-techniques\nkubectl æ‡‰è©²æ˜¯æ‰€æœ‰äººå­¸ k8s çš„ç¬¬ä¸€å€‹å·¥å…· ä½œç‚ºå®˜æ–¹çš„ cli å·¥å…·ï¼Œkunectl éå¸¸å¼·å¤§ï¼Œå¯ä»¥æ§åˆ¶å¹¾ä¹å¤§éƒ¨åˆ† k8s çš„ apiï¼Œä¹Ÿèƒ½å°å¹¾ä¹æ‰€æœ‰ k8s object é€²è¡Œæ“ä½œ é¦–å…ˆï¼Œå¦‚åŒå®˜æ–¹æ–‡ä»¶æ‰€æè¿°ï¼Œkubectl çš„ä½¿ç”¨ä¸Šï¼Œä¹Ÿæœ‰å„ç¨®ä¸åŒæ–¹æ³•ã€‚ie. kubectl äº¤åœ¨ä¸åŒäººæ‰‹ä¸Šï¼Œä½¿ç”¨æ–¹å¼æ˜¯ä¸åŒçš„ å®˜æ–¹æ–‡ä»¶æè¿°\nImperative commands æŒ‡ä»¤å¼ Imperative object configuration æŒ‡ä»¤ç‰©ä»¶ Declarative object configuration å®£å‘Šç‰©ä»¶ kubectl create deployment nginxï¼Œä¸€è¡Œå‘½ä»¤å‘Šè¨´ k8s ä½ è¦ create deployment\nkubectl create -f nginx.yamlï¼Œä½¿ç”¨è€…é¸æ“‡è¦ create / apply / delete è€Œ nginx.yaml è£¡é¢æè¿°ä¸€å€‹ nginx deployment ç‰©ä»¶\nkubectl apply -f -R nginx/ï¼Œä½¿ç”¨è€…æè¿°ä¸€å€‹æˆ–å¤šå€‹ç‰©ä»¶ï¼Œæè¿°ç‰©ä»¶çš„ç‹€æ…‹ã€‚apply æ™‚ï¼Œç”± kubectl æ±ºå®šè¦å° object åŸ·è¡Œï¼Œcreate / update / delete\nIssue # Imperative commands kubectl create deployment nginx --image nginx # Imperative object configuration kubectl create -f nginx.yaml # Declarative object configuration kubectl apply -R -f configs/ kubectl é€™éº¼å¥½ç”¨ï¼Œé‚£ç‚ºä½•ä¸ç¹¼çºŒç”¨ä¸‹å»ï¼Ÿ\nçš„å•é¡Œå¾ˆæ˜é¡¯ï¼Œä¸èƒ½ diff 2.3. æœƒæœ‰ä¸€å€‹åŸºç¤çš„ specï¼Œé—œæ–¼ deployment/nginxï¼Œå› æ­¤å¯ä»¥åœ¨ é‡é»\nchange review / diff source record other than live templateï¼Œä¸€å€‹å¯é‡è¤‡ä½¿ç”¨çš„æ¨£ç‰ˆ 2.3. çš„å•é¡Œï¼Œä½ å¿…é ˆå° object å¤ äº†è§£ï¼Œæ‰å¯«å¾—å‡ºå®Œæ•´æ²’ bug çš„ spec yaml\nè½èµ·ä¾†æ˜¯æœ€å®Œæ•´çš„ï¼Œä»–çš„å•é¡Œå°±æ˜¯è¦å¦‚ä½•ç¶­æŒ local file èˆ‡ live é€£çµï¼Œæˆ–æ˜¯èªª sync é€™å€‹æœ‰ä½¿ç”¨ argocd çš„äººå¯èƒ½å°±æœƒæ¯”è¼ƒæœ‰æ„Ÿè¦º å¤§å®¶æœ‰èˆˆè¶£å¯ä»¥å»çœ‹å®˜æ–¹æè¿°çš„å…§å®¹ï¼Œé€™è£¡ä¸è´…è¿°\nIssue change review / diff before apply source of live record template / repetitive apply sync local to live change review / diff before apply source of live record template / repetitive apply sync local to live Declarative object configuration nginx â”œâ”€â”€ deployment.yaml â”œâ”€â”€ ingress.yaml â””â”€â”€ service.yaml redis â”œâ”€â”€ deployment.yaml â”œâ”€â”€ ingress.yaml â””â”€â”€ service.yaml microservice-a b c ... ç‚ºäº† change reviewï¼Œé€šå¸¸æœƒèµ°å‘ 3. Declarative object configurationï¼Œå¯èƒ½æœƒé•·é€™æ¨£ ä¸€å€‹ git repository è£¡é¢æœ‰å¤šå€‹ directoryï¼Œæè¿°æ¯ä¸€çµ„æœå‹™æ‰€éœ€è¦çš„è³‡æº ä½¿ç”¨ kubectl ä¸€æ¬¡ apply æ•´å€‹ directoryï¼Œæ‰€ä»¥ local file åŸºæœ¬ä¸Šä¹Ÿåæ‡‰ live object æœ‰ local fileï¼Œå¾ˆè‡ªç„¶è€Œç„¶å°±æœƒæƒ³è¦æ”¾åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼Œä¾‹å¦‚ gitï¼Œé€™æ¨£åˆå¯ä»¥èµ° gitflow PR -\u0026gt; review -\u0026gt; merged -\u0026gt; apply master / release tag æœ‰äººåœ¨ 2014 å¹´å‰ç”¨é k8s å—ï¼Ÿ\nå¤æ—©æ™‚æœŸï¼Œè¦ç”¨å€‹ redis é‚„è¦è‡ªå·±åŒ… service / ingress / deploymentï¼Œå…ˆå» dockerhub æ‰¾ redisï¼Œç„¶å¾Œä¾æ“š readme è‡ªå·±åŒ… deploymentï¼Œè‡ªå·±æ¸¬è©¦çœ‹ redis æœƒä¸æœƒå‹•\nç¾åœ¨æ‡‰è©²æ²’æœ‰äººæœƒå› ç‚ºè¦å»ä½¿ç”¨ redis æˆ–æ˜¯ mysqlï¼Œè‡ªå·±è·‘å»å¯« k8s object äº†å§\nhelm v2.0-alpha 2016\nç¾åœ¨æœ‰ helm + chart\nå¦‚æœåªæ˜¯ä½¿ç”¨ä½ä¸‰æ–¹é–‹æºçš„ helm chartï¼Œç¤¾ç¾¤å¹«ä½ ç¶­è­· service / ingress / deployment\næä¾›åŸºæœ¬çš„ default valueï¼Œé è¨­å°±è·‘å¾—èµ·ä¾† è·‘å¾—èµ·ä¾†å¾Œï¼Œè·‘å¾—å¥½ï¼Œèƒ½ä½¿ç”¨ k8s orchestration æä¾›å®Œæ•´çš„åŠŸèƒ½ï¼Œé€é value.yaml æ§åˆ¶ ç¶“éæ¸¬è©¦ issue tracking Helm chart k8s object çš„é–‹ç™¼ï¼Œæ‰“åŒ…ï¼Œæ¸¬è©¦ï¼Œrelease\nk8s ååˆ†å¼·å¤§ï¼Œäº«å— orchestration k8s object è®Šå¾—å¤ªè¤‡é›œ æ¨™æº–åŒ– templateï¼Œrelease + upgrade chart ä½œç‚ºä¸€å€‹ k8s object çš„ release / artifactï¼Œæœ‰é–‹ç™¼æµç¨‹ï¼Œç‰ˆæœ¬æ§ç®¡ï¼Œæ¸¬è©¦ï¼Œå®Œæ•´çš„ç™¼ä½ˆ\napp æœ¬èº«ï¼Œä¾‹å¦‚ redisï¼Œç•¶ç„¶æ˜¯æ•´å€‹æ‡‰ç”¨çš„æ ¸å¿ƒã€‚ä½†è¦èƒ½å¤ åœ¨ k8s åŸ·è¡Œï¼Œä¸¦æ­£ç¢ºåœ°äº«å— k8s orchestration çš„å¥½è™•ï¼Œk8s object éå¸¸çš„é‡è¦\nç”šè‡³ï¼Œk8s object è¤‡é›œåº¦å·²ç¶“é é è¶…ééå»åœ¨ vm ä¸Šè·‘ä¸€å€‹ redisï¼Œå…œä¸€å€‹ systemd unit å°±å¯ä»¥è·‘èµ·ä¾†\nk8s object éœ€è¦ release / versionï¼Œæ‰èƒ½åš object çš„å›ºå®šç‰ˆæœ¬ applyï¼Œupgrade ç”Ÿç‰ˆï¼Œæœ‰å•é¡Œ rollback\nåœ¨ k8s ä¸Šè¦è·‘å¾—ç©©é‚Šçš„ååˆ†é–«é›£ï¼Œé€éç¤¾ç¾¤ä¾†ç¶­è­·å¤§éƒ¨åˆ†é€šé‹çš„ç¬¬ä¸‰æ–¹æœå‹™\nHelm Chart Library helm repo list NAME URL bitnami https://charts.bitnami.com/bitnami argocd https://argoproj.github.io/argo-helm chaos-mesh https://charts.chaos-mesh.org k8s objects èƒ½å‹•å¾ˆç°¡å–®ï¼Œä½†è¦è·‘å¾—ç©©åˆèƒ½äº«å— orchestration çš„ä¾¿åˆ©ï¼Œååˆ†å›°é›£ é€éç¤¾ç¾¤ä¾†ç¶­è­·å¤§éƒ¨åˆ†é€šé‹çš„ç¬¬ä¸‰æ–¹æœå‹™ï¼Œé€éå–®ä¸€ value.yaml\nç¤¾ç¾¤ç¶­è­·çš„ chart ä¸æ˜¯å°±ä¸€å‹æ°¸é€¸\nä¸ç†±é–€çš„ chart ç‰¹æ®Šéœ€æ±‚æ™‚ï¼Œé‚„æ˜¯éœ€è¦ fork chart å›ä¾†è‡ªå·±ç¶­è­· ä½†ç„¡è«–å¦‚ä½•ï¼Œéƒ½æ˜¯å¤§å¹…é™ä½ç¶­é‹çš„è¤‡é›œåº¦\nhelm ç”Ÿæ…‹ç³» ex. helmfile\nrepositories: - name: argocd url: https://argoproj.github.io/argo-helm helmDefaults: kubeContext: general #verify: true wait: true timeout: 300 context: general releases: - name: argocd namespace: argocd chart: argocd/argo-cd version: 5.31.0 values: - values/argocd.yaml - name: redis - name: mysql https://github.com/cdwv/awesome-helm\næ›´é«˜å±¤ç´šçš„å°è£ api-services â”œâ”€â”€ nginx â”œâ”€â”€ mysql â””â”€â”€ ingress -\u0026gt; nlb daemon-services â”œâ”€â”€ redis â”œâ”€â”€ mysql â””â”€â”€ kafka åº•ä¸‹çš„ä¾è³´æ¨™æº–åŒ–ï¼Œä¾æ“šç©©å®šçš„ release ç™¼å¸ƒä¹‹å¾Œ å¯ä»¥å†é€²è¡Œæ›´é«˜å±¤ç´šçš„å°è£\né‡è¤‡æ€§çš„æœå‹™ï¼Œä¾‹å¦‚æ¯å€‹ microservice éƒ½éœ€è¦ ä¾‹å¦‚æˆ‘æœ‰ä¸€ç™¾å€‹ api service groupï¼Œéƒ½æ˜¯ restful apiï¼Œéƒ½éœ€è¦ ingress / service / nginx ç­‰ç­‰\nåº•ä¸‹çš„å…ƒä»¶æ¨™æº–åŒ–ï¼Œé™ä½ç¶­è­·æˆæœ¬\nçµ±ä¸€ç‰ˆæœ¬ï¼Œé†«ç—…ç¶­è­·ï¼Œå‡ç´šï¼Œé€€ç‰ˆ ä¾‹å¦‚ daemon serviceï¼Œåº•ä¸‹ä¾è³´ queue / redis / db\nå¾®æœå‹™ å¾®æœå‹™ä¸æ˜¯å•é¡Œï¼Œå¾®æœå‹™åº•ä¸‹çš„ k8s object æ‰æ˜¯å•é¡Œ\nå¯ä»¥å¿«é€Ÿï¼Œæ¨™æº–åŒ–çš„ç”¢ç”Ÿç¶“éæ¸¬è©¦ï¼Œå¾®æœå‹™å–®å…ƒ Issues V change review / diff before apply source of live record V template / repetitive apply sync local to live version control / gitflow\nhelm template æœ‰æä¾›è¨±å¤šèªæ³•ï¼Œå¯ä»¥æœ‰ç³»çµ±åŒ–çš„ç”¢ç”Ÿé‡è¤‡çš„ k8s object ex. å¯ä»¥è·‘ for loop / for each é€™å€‹åœ¨ IaC æˆ–æ˜¯ resource as code çš„ xxx as code éƒ½ååˆ†æœ‰åˆ©\nArgo CD Declarative GitOps CD for Kubernetes\nWhy Argo CD? Application definitions, configurations, and environments should be declarative and version controlled. Application deployment and lifecycle management should be automated, auditable, and easy to understand.\napplication æ‡‰è©²æ˜¯æ˜ç¢ºå®£å‘Šçš„ï¼Œæ¸…æ¥šæè¿°ï¼Œä¸¦ä¸”æœ‰ç‰ˆæœ¬æ§ç®¡ æè¿° application æœ¬èº«ï¼Œé™„å¸¶çš„è¨­å®š secret / â€¦","date":1698019200,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1698209393,"objectID":"d6e2933d05346cab57f8fe3579d9e7b6","permalink":"https://chechia.net/zh-hant/slides/2023-10-25-k8s-resource-as-code/","publishdate":"2023-10-23T00:00:00Z","relpermalink":"/zh-hant/slides/2023-10-25-k8s-resource-as-code/","section":"slides","summary":"å°‡ k8s resource ä»¥ code ç®¡ç†ï¼Œæ¨ä¸Š vcsï¼Œä¸¦ä½¿ç”¨ argoCD, secret operator ç­‰å·¥å…·é€²è¡Œç®¡ç†ï¼Œä¾†è®“é¿å…ä½ç´šçš„äººå·¥æ“ä½œéŒ¯èª¤ï¼Œé™ä½åœ˜éšŠæ•´é«”å¤±èª¤ç‡ï¼Œä¸¦é™ä½ k8s admin ç®¡ç†çš„æˆæœ¬ï¼Œæé«˜ç®¡ç†æ•ˆç‡","tags":["kafka","kubernetes"],"title":"Kubernetes Summit: Resource as Code for Kubernetes: Stop kubectl apply","type":"slides"},{"authors":[],"categories":["vault","docker"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay ??: Integrated Backend é›†æˆå­˜å„²\nVault æ”¯æ´å¤šç¨®å­˜å„²é¸é …ï¼Œç”¨æ–¼æŒä¹…å­˜å„² Vault è³‡è¨Šã€‚è‡ª Vault 1.4 èµ·ï¼Œæä¾›äº†æ•´åˆå¼å­˜å„²é¸é …ã€‚æ­¤å­˜å„²å¾Œç«¯ä¸ä¾è³´æ–¼ä»»ä½•ç¬¬ä¸‰æ–¹ç³»çµ±ï¼Œå¯¦ç¾é«˜å¯ç”¨æ€§èªç¾©ï¼Œæ”¯æ´ä¼æ¥­è¤‡è£½åŠŸèƒ½ï¼Œä¸¦æä¾›å‚™ä»½/é‚„åŸå·¥ä½œæµã€‚\nè©²é¸é …å°‡ Vault çš„æ•¸æ“šå­˜å„²åœ¨æœå‹™å™¨çš„æ–‡ä»¶ç³»çµ±ä¸Šï¼Œä¸¦ä½¿ç”¨å…±è­˜å”è­°å°‡æ•¸æ“šè¤‡è£½åˆ°é›†ç¾¤ä¸­çš„æ¯å€‹æœå‹™å™¨ã€‚æœ‰é—œæ•´åˆå¼å­˜å„²å…§éƒ¨çš„æ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–±æ•´åˆå¼å­˜å„²å…§éƒ¨æ–‡æª”ã€‚æ­¤å¤–ï¼Œé…ç½®æ–‡æª”å¯ä»¥å¹«åŠ©é…ç½® Vault ä»¥ä½¿ç”¨æ•´åˆå¼å­˜å„²ã€‚\nä»¥ä¸‹å„ç¯€å°‡è©³ç´°ä»‹ç´¹å¦‚ä½•ä½¿ç”¨æ•´åˆå¼å­˜å„²æ“ä½œ Vaultã€‚\næœå‹™å™¨é–“é€šä¿¡ ä¸€æ—¦ç¯€é»åŠ å…¥åˆ°å½¼æ­¤ï¼Œå®ƒå€‘é–‹å§‹ä½¿ç”¨ Vault çš„å¢é›†ç«¯å£é€²è¡Œ mTLS é€šä¿¡ã€‚å¢é›†ç«¯å£çš„é»˜èªå€¼ç‚º 8201ã€‚TLS ä¿¡æ¯åœ¨åŠ å…¥æ™‚äº¤æ›ï¼Œä¸¦æŒ‰ä¸€å®šçš„ç¯€å¥é€²è¡Œè¼ªæ›ã€‚\næ•´åˆå¼å­˜å„²çš„è¦æ±‚ä¹‹ä¸€æ˜¯å¿…é ˆè¨­ç½® cluster_addr é…ç½®é¸é …ã€‚é€™å…è¨± Vault åœ¨åŠ å…¥æ™‚ç‚ºç¯€é» ID åˆ†é…åœ°å€ã€‚\nå¢é›†æˆå“¡è³‡æ ¼ æœ¬ç¯€å°‡æ¦‚è¿°å¦‚ä½•å¼•å°å’Œç®¡ç†é‹è¡Œæ•´åˆå¼å­˜å„²çš„ Vault ç¯€é»é›†ç¾¤ã€‚\næ•´åˆå¼å­˜å„²åœ¨åˆå§‹åŒ–éç¨‹ä¸­å¼•å°ï¼Œä¸¦ä¸”çµæœæ˜¯å¤§å°ç‚º 1 çš„é›†ç¾¤ã€‚æ ¹æ“šæ‰€éœ€çš„éƒ¨ç½²å¤§å°ï¼Œå¯ä»¥å°‡ç¯€é»åŠ å…¥åˆ°æ´»å‹• Vault ç¯€é»ä¸­ã€‚\nåŠ å…¥ç¯€é» åŠ å…¥æ˜¯å°‡æœªåˆå§‹åŒ–çš„ Vault ç¯€é»ä¸¦ä½¿å…¶æˆç‚ºç¾æœ‰é›†ç¾¤æˆå“¡çš„éç¨‹ã€‚ç‚ºäº†å°‡æ–°ç¯€é»é©—è­‰åˆ°é›†ç¾¤ï¼Œå®ƒå¿…é ˆä½¿ç”¨ç›¸åŒçš„å¯†å°æ©Ÿåˆ¶ã€‚å¦‚æœä½¿ç”¨è‡ªå‹•è§£å°ï¼Œå‰‡å¿…é ˆé…ç½®æ–°ç¯€é»ä»¥ä½¿ç”¨èˆ‡å…¶å˜—è©¦åŠ å…¥çš„é›†ç¾¤ç›¸åŒçš„ KMS æä¾›ç¨‹åºå’Œå¯†é‘°ã€‚å¦‚æœä½¿ç”¨ Shamir å¯†å°ï¼Œå‰‡å¿…é ˆåœ¨åŠ å…¥éç¨‹å®Œæˆä¹‹å‰ç‚ºæ–°ç¯€é»æä¾›è§£å°å¯†é‘°ã€‚ä¸€æ—¦ç¯€é»æˆåŠŸåŠ å…¥ï¼Œä¾†è‡ªæ´»å‹•ç¯€é»çš„æ•¸æ“šå°±å¯ä»¥é–‹å§‹è¤‡åˆ¶åˆ°å®ƒã€‚ä¸€æ—¦ç¯€é»åŠ å…¥ï¼Œå‰‡ä¸èƒ½é‡æ–°åŠ å…¥åˆ°ä¸åŒçš„é›†ç¾¤ã€‚\næ‚¨å¯ä»¥é€šéé…ç½®æ–‡ä»¶è‡ªå‹•åŠ å…¥ç¯€é»ï¼Œä¹Ÿå¯ä»¥é€šé API æ‰‹å‹•åŠ å…¥ï¼ˆä¸‹é¢æè¿°äº†é€™å…©ç¨®æ–¹æ³•ï¼‰ã€‚åœ¨åŠ å…¥ç¯€é»æ™‚ï¼Œå¿…é ˆä½¿ç”¨é ˜å°ç¯€é»çš„ API åœ°å€ã€‚æˆ‘å€‘å»ºè­°åœ¨æ‰€æœ‰ç¯€é»ä¸Šè¨­ç½® api_addr é…ç½®é¸é …ï¼Œä»¥ä½¿åŠ å…¥éç¨‹æ›´ç°¡å–®ã€‚\nretry_join é…ç½® æ­¤æ–¹æ³•å…è¨±åœ¨é…ç½®æ–‡ä»¶ä¸­è¨­ç½®ä¸€å€‹æˆ–å¤šå€‹ç›®æ¨™é ˜å°ç¯€é»ã€‚ç•¶æœªåˆå§‹åŒ–çš„ Vault æœå‹™å™¨å•Ÿå‹•æ™‚ï¼Œå®ƒå°‡å˜—è©¦åŠ å…¥æ¯å€‹å·²å®šç¾©çš„æ½›åœ¨é ˜å°è€…ï¼Œç›´åˆ°æˆåŠŸã€‚ç•¶æŒ‡å®šçš„é ˜å°è€…ä¹‹ä¸€è®Šç‚ºæ´»å‹•ç‹€æ…‹æ™‚ï¼Œæ­¤ç¯€é»å°‡æˆåŠŸåŠ å…¥ã€‚ç•¶ä½¿ç”¨ Shamir å¯†å°æ™‚ï¼Œå·²åŠ å…¥çš„ç¯€é»ä»ç„¶éœ€è¦æ‰‹å‹•è§£å°ã€‚ç•¶ä½¿ç”¨è‡ªå‹•è§£å°æ™‚ï¼Œç¯€é»å°‡èƒ½å¤ è‡ªå‹•åŠ å…¥ä¸¦è‡ªå‹•è§£å°ã€‚\nä¸‹é¢æ˜¯ä¸€å€‹ç¤ºä¾‹ retry_join é…ç½®ï¼š\nstorage \u0026#34;raft\u0026#34; { path = \u0026#34;/var/raft/\u0026#34; node_id = \u0026#34;node3\u0026#34; retry_join { leader_api_addr = \u0026#34;https://node1.vault.local:8200\u0026#34; } retry_join { leader_api_addr = \u0026#34;https://node2.vault.local:8200\u0026#34; } } storage \u0026#34;raft\u0026#34; { path = \u0026#34;/var/raft/\u0026#34; node_id = \u0026#34;node3\u0026#34; retry_join { auto_join = \u0026#34;provider=aws region=eu-west-1 tag_key=vault tag_value=... access_key_id=... secret_access_key=...\u0026#34; } } chatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/concepts/integrated-storage å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026#34;æ‚¨\u0026#34;ï¼Œè«‹ç”¨\u0026#34;ä½ \u0026#34;å–ä»£\u0026#34;æ‚¨\u0026#34;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026#34;æ•¸æ“š\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™\u0026#34;ï¼Œå°‡ \u0026#34;æ•¸æ“šåº«\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™åº«\u0026#34;ï¼Œå°‡ \u0026#34;æ•¸æ“š\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™\u0026#34;ï¼Œå°‡ \u0026#34;è¨ªå•\u0026#34; æ”¹ç‚º \u0026#34;å­˜å–\u0026#34;ï¼Œå°‡ \u0026#34;æºä»£ç¢¼\u0026#34; æ”¹ç‚º \u0026#34;åŸå§‹ç¢¼\u0026#34;ï¼Œå°‡ \u0026#34;ä¿¡æ¯\u0026#34; æ”¹ç‚º \u0026#34;è³‡è¨Š\u0026#34;ï¼Œå°‡ \u0026#34;å‘½ä»¤\u0026#34; æ”¹ç‚º \u0026#34;æŒ‡ä»¤\u0026#34;ï¼Œå°‡ \u0026#34;ç¦ç”¨\u0026#34; æ”¹ç‚º \u0026#34;åœç”¨\u0026#34;ï¼Œå°‡ \u0026#34;é»˜èª\u0026#34; æ”¹ç‚º \u0026#34;é è¨­\u0026#34;ã€‚ ","date":1696884146,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695693546,"objectID":"5722c092452f4f8235aabe5724a0d084","permalink":"https://chechia.net/zh-hant/post/2023-10-10-vault-workshop-integrated-storage/","publishdate":"2023-10-10T04:42:26+08:00","relpermalink":"/zh-hant/post/2023-10-10-vault-workshop-integrated-storage/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay ??: Integrated Backend é›†æˆå­˜å„²\nVault æ”¯æ´å¤šç¨®å­˜å„²é¸é …ï¼Œç”¨æ–¼æŒä¹…å­˜å„² Vault è³‡è¨Šã€‚è‡ª Vault 1.4 èµ·ï¼Œæä¾›äº†æ•´åˆå¼å­˜å„²é¸é …ã€‚æ­¤å­˜å„²å¾Œç«¯ä¸ä¾è³´æ–¼ä»»ä½•ç¬¬ä¸‰æ–¹ç³»çµ±ï¼Œå¯¦ç¾é«˜å¯ç”¨æ€§èªç¾©ï¼Œæ”¯æ´ä¼æ¥­è¤‡è£½åŠŸèƒ½ï¼Œä¸¦æä¾›å‚™ä»½/é‚„åŸå·¥ä½œæµã€‚\nè©²é¸é …å°‡ Vault çš„æ•¸æ“šå­˜å„²åœ¨æœå‹™å™¨çš„æ–‡ä»¶ç³»çµ±ä¸Šï¼Œä¸¦ä½¿ç”¨å…±è­˜å”è­°å°‡æ•¸æ“šè¤‡è£½åˆ°é›†ç¾¤ä¸­çš„æ¯å€‹æœå‹™å™¨ã€‚æœ‰é—œæ•´åˆå¼å­˜å„²å…§éƒ¨çš„æ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–±æ•´åˆå¼å­˜å„²å…§éƒ¨æ–‡æª”ã€‚æ­¤å¤–ï¼Œé…ç½®æ–‡æª”å¯ä»¥å¹«åŠ©é…ç½® Vault ä»¥ä½¿ç”¨æ•´åˆå¼å­˜å„²ã€‚\nä»¥ä¸‹å„ç¯€å°‡è©³ç´°ä»‹ç´¹å¦‚ä½•ä½¿ç”¨æ•´åˆå¼å­˜å„²æ“ä½œ Vaultã€‚\næœå‹™å™¨é–“é€šä¿¡ ä¸€æ—¦ç¯€é»åŠ å…¥åˆ°å½¼æ­¤ï¼Œå®ƒå€‘é–‹å§‹ä½¿ç”¨ Vault çš„å¢é›†ç«¯å£é€²è¡Œ mTLS é€šä¿¡ã€‚å¢é›†ç«¯å£çš„é»˜èªå€¼ç‚º 8201ã€‚TLS ä¿¡æ¯åœ¨åŠ å…¥æ™‚äº¤æ›ï¼Œä¸¦æŒ‰ä¸€å®šçš„ç¯€å¥é€²è¡Œè¼ªæ›ã€‚","tags":["vault","iac","workshop","docker","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop ??: Integrated Storage","type":"post"},{"authors":[],"categories":null,"content":"HashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢\næœ¬æ¬¡æ¼”è¬›å¾å°å…¥ HashiCorp Vault ä½œç‚ºèµ·é»ï¼Œç›´æ¥æä¾›å¯¦å‹™ä¸Šç¶“é©—ï¼Œåˆ†äº«å»ºè­°çš„è¨­å®šèˆ‡è·¯ä¸Šå¯èƒ½æœ‰çš„é›·ã€‚\nVault å…¥å‘çš„å›°é›£ Vault + Terraform ä¸€å…¥å‘å°± IaC mount path + role + policy å‘½åèˆ‡ç®¡ç† å‡ç´šèˆ‡ç¶­è­· æœƒä¾æ“šä¼æ¥­éœ€æ±‚æä¾›å¯¦éš›ç”¨ä¾‹ demoï¼Œç•¶å¤©æä¾› github code example ä¸­éš\né æœŸè½çœ¾æ˜¯æœ‰ Vault ä½¿ç”¨ç¶“é©—ï¼Œå¸Œæœ›èƒ½æ›´æœ‰æ•ˆç‡ç®¡ç† Vault çš„äºº ä¸æœƒè¬›å¤ªå¤šåŸºæœ¬åŠŸèƒ½ä»‹ç´¹ vault ä»‹ç´¹ ","date":1695734400,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1713932423,"objectID":"4a0a8e731612ddbde164c1bfa90b86f2","permalink":"https://chechia.net/zh-hant/talk/devopsday-hashicorp-vault-%E8%87%AA%E5%BB%BA%E9%87%91%E9%91%B0%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%85%A5%E5%9D%91%E5%A7%BF%E5%8B%A2/","publishdate":"2023-09-09T00:00:00Z","relpermalink":"/zh-hant/talk/devopsday-hashicorp-vault-%E8%87%AA%E5%BB%BA%E9%87%91%E9%91%B0%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%85%A5%E5%9D%91%E5%A7%BF%E5%8B%A2/","section":"event","summary":"å¾å°å…¥ HashiCorp Vault ä½œç‚ºèµ·é»ï¼Œç›´æ¥æä¾›å¯¦å‹™ä¸Šç¶“é©—ï¼Œåˆ†äº«å»ºè­°çš„å…¥å‘è¨­å®š","tags":[],"title":"DevOpsDay: HashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢","type":"event"},{"authors":[],"categories":["vault","terraform","kubernetes"],"content":" Q1: æœ‰éä½¿ç”¨ hashicorp vault çš„äººè«‹èˆ‰æ‰‹\næ²’ä½¿ç”¨éçš„äººä¸æ˜¯é€™å€‹ session çš„ç›®æ¨™è½çœ¾ï¼Œå¯ä»¥ QR code æ‹ä¸‹ä¾†å»è½åˆ¥å ´ã€‚ä¾‹å¦‚å°é¢åŒé¡Œæçš„session QR code æœ‰æŠ•å½±ç‰‡ï¼Œç¯„ä¾‹ github repoï¼ŒæŠ•å½±ç‰‡è£¡é‚„æœ‰è¬›ç¨¿ï¼Œæ‰€ä»¥æˆ‘ä»Šå¤©åœ¨é€™è£¡çš„ç”¨è™•å°±æ˜¯å¿µç¨¿ï¼ŒçœŸçš„å¯ä»¥ qrcode æ‹äº†å›å®¶çœ‹\nQ2: æœ‰ä½¿ç”¨é infrastructure as code / terraform çš„äººè«‹èˆ‰æ‰‹\næœ‰ä½¿ç”¨ vault ä½†æ˜¯æ²’æœ‰ä½¿ç”¨ IaC çš„æœ‹å‹ï¼Œæ‰æ˜¯é€™å ´ session çš„ä¸»è¦å—çœ¾\nQ3: æœ‰ä½¿ç”¨ iac deploy vault stackï¼Œæˆ–æ˜¯æœ‰ä½¿ç”¨ iac / vcs ç®¡ç† vault å…§çš„ policy çš„äººè«‹èˆ‰æ‰‹\né€™äº›äººå¯ä»¥å‡ºå»åƒé›¶é£Ÿï¼Œä»Šå¤©è¬›çš„å…§å®¹ä½ å€‘éƒ½æœƒäº†ï¼Œæˆ‘æ²’ä»€éº¼æ±è¥¿å¯ä»¥è·Ÿä½ å€‘åˆ†äº«\nHashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å¯¦è¸ Che Chia Chang | Vault éµäººè³½ workshop\ns æ¨™é¡Œæœ‰ç¨å¾®ä¿®æ”¹ About Me\nOutline from dev to prod-ready terraform deployment IaC on aws / azure / gcp / k8s å¦‚ä½•é–‹å§‹ terraform configuration IaC IaC everything secret backends / auth method / role / policy / audit â€¦ å·¥ä½œæµç¨‹è‡ªå‹•åŒ– gitflow / tested / automation manage vault infra \u0026amp; vault configuration from a aspect of devops Vault åŸºç¤çš„å­¸ç¿’è³‡æº 2023-05-10 é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å° 2023 éµäººè³½: vault 10- day workshop 2021 éµäººè³½: terraform 30 day workshop ç¯„ä¾‹ Github åŒä¸€æ™‚é–“ï¼ŒVault + Kubernetes è«‹å‡ºé–€å°é¢DEæœƒè­°å®¤ ä¸æœƒè¬› vault çš„åŸºç¤æ“ä½œï¼Œä½†å¦‚æœä½ éœ€è¦å­¸ç¿’è³‡æºï¼Œä½ å¯ä»¥ä¾†é€™é‚Šæ‰¾ ç¬¬ä¸€å€‹ google slides æ˜¯æˆ‘åœ¨å…¶ä»–å ´åˆçš„æ¼”è¬›ï¼Œé©åˆç¬¬ä¸€æ¬¡æ¥è§¸ vaultï¼Œæˆ–æ˜¯æ­£åœ¨è©•ä¼°æ˜¯å¦è¦å°å…¥ vault çš„åœ˜éšŠ\nç¬¬äºŒå€‹ä»Šå¹´çš„ ithome 2023éµäººè³½ï¼Œæˆ‘å¯«çš„å…§å®¹å°±æ˜¯ vault workshopï¼Œé›–ç„¶å¯«åˆ°ç¬¬åç¯‡å°±å› æ•…åœæ›´ï¼Œä½†å‰é¢ 1-8 ç¯‡å‰›å¥½æ˜¯ vault æ“ä½œåŸºç¤ï¼Œä½¿ç”¨ chatgpt ç¿»è­¯ vault official tutorialï¼Œä¹Ÿæ˜¯é©åˆç¬¬ä¸€æ¬¡ä½¿ç”¨ vault çš„äºº\nç¬¬ä¸‰å€‹æ˜¯å¦‚æœæ²’æ¥è§¸é infrastructure as code IaCï¼Œé€™å€‹ä¹Ÿæ˜¯éµäººè³½çš„ 30 day workshopï¼Œé€™å€‹æœ‰å®Œè³½ä½³ä½œ\nproduction deploy checklist End-to-End TLS Single Tenancy Enable Auditing Immutable Upgrades Upgrade Frequently Restrict Storage Access é€²å…¥ production å‰çš„ç¶­é‹å•é¡Œ\nvault å®˜æ–¹å»ºè­°çš„ prod checklist å¤§å¤šéœ€è¦å®šæœŸæ›´æ–°ï¼Œç¶­è­·ï¼Œè€Œéä¸€å‹æ°¸é€¸ä¸€æ¬¡æ€§ä½œæ¥­\nä¾‹å¦‚ end-to-end TLS certificate éœ€è¦ç®¡ç†èˆ‡æ›´æ–°\nauditing å° vault çš„å­˜å–ç´€éŒ„éœ€è¦å®‰å…¨çš„è¼¸å‡ºï¼Œä¸¦ä¸”èƒ½å¤ æª¢æ ¸ã€‚è¨­å®šåšä¸€æ¬¡å°±å¯ä»¥ç”Ÿæ•ˆã€‚ä½†æ˜¯å¯¦å‹™ä¸Šæœªä¾†æœƒéœ€è¦ä¸æ–·çš„æ ¹æ“šå¤–éƒ¨ç¨½æ ¸éœ€æ±‚èª¿æ•´\nimmutable upgrades æŒ‡çš„æ˜¯ç•¶ä½ ä½¿ç”¨ vault server èˆ‡ storage backendï¼Œvault server æœ¬èº«æ˜¯ immutable çš„ï¼Œä½ å¯ä»¥è‡ªå·±ä½¿ç”¨ official binary build VM Image (ex. aws ami)ï¼Œæˆ–æ˜¯é€é container image release ä¾†æ›´æ–°\nupgrade frequentlyï¼Œä½†è¦åšçš„å®‰å…¨ï¼Œè€Œä¸”æœ‰æ•ˆç‡ï¼Œæœ€å¥½æ˜¯åšåˆ°åŠè‡ªå‹•åŒ–æˆ–æ˜¯å…¨è‡ªå‹•åŒ–ï¼Œå¦‚æœæ²’æœ‰ IaC æœƒæ¯”è¼ƒè€—å·¥\nInfrastructure as Code å°å…¥ IaC ï¼Œåšåˆ°é »ç¹ä¸”å®‰å…¨çš„ vault æ›´æ–°ï¼Œä½†åŒæ™‚åˆè¦æœ‰æ•ˆç‡ç”šè‡³å…¨è‡ªå‹•åŒ–\nmultiple env: dev, stag, prod programable / reusable: æ¨™æº–åŒ–ï¼Œå¯é‡è¤‡ä½¿ç”¨çš„ code tested infrastructure ä»¥ vault ç‚ºç›®æ¨™ ç¶­é‹ vault çš„ç¬¬ä¸€ç›®æ¨™ï¼šå®‰å…¨ç¬¬ä¸€ï¼Œä¸æ±‚é«˜æ•ˆèƒ½ï¼Œä½†æ˜¯è¿½æ±‚å®‰å…¨ æ˜¯æˆ‘å€‘è¦å°‡ deploy / release / upgrade vault ä¸­çš„é¢¨éšªé™åˆ°æœ€ä½\ninfra: å‡ç´š vault ç‰ˆæœ¬ï¼Œèª¿æ•´ VM / containerï¼Œèª¿æ•´ load balancerï¼Œé™¤éŒ¯ config: æ›´æ”¹ auth-method / policy\npolicy å®¹æ˜“æ”¹å£ä½†ç„¡æ³•åŠæ™‚ç™¼ç¾ï¼Œè¦ç”¨æ™‚æ‰ç™¼ç¾æ¬Šé™å£äº† å¦‚ä½•é–‹å§‹ IaC for Vault immutable Vault server storage backend load balancer security group / firewall rule IaC å¥½æ£’ï¼Œé‚£æœ‰æ²’æœ‰ä»€éº¼è³‡æºå¯ä»¥å¹«åŠ©æˆ‘å€‘é–‹å§‹ deploy IaC Vault ç­”æ¡ˆæ˜¯æœ‰çš„ https://www.terraform.io/\nDeploy on public cloud https://github.com/hashicorp/terraform-aws-vault https://github.com/hashicorp/terraform-aws-vault-starter https://github.com/hashicorp/terraform-azurerm-vault https://github.com/terraform-google-modules/terraform-google-vault åœ¨å…¬æœ‰é›² deploy Vaultï¼Œé›²æœå‹™å•†æœ‰æä¾›æ—¢æœ‰çš„terraform module ä¸ä¸€å®šè¦ç…§å–®å…¨æ”¶ï¼Œå¯ä»¥è©¦è‘—æ¶èµ·æ¸¬è©¦ç’°å¢ƒï¼Œç„¶å¾Œèª¿æ•´terraform moduleï¼Œæˆç‚ºé©åˆè‡ªå·±ç”¢å“çš„æ¶æ§‹ èª¿æ•´æ¶æ§‹éœ€è¦è€ƒé‡çš„é»ï¼Œåº•ä¸‹åˆ†æ Deploy terraform-aws-vault hashicorp å®˜æ–¹æä¾›çš„ terraform-aws-vault æ˜¯ä¸€å€‹ä¸éŒ¯çš„é–‹å§‹ terraform-aws-vault ELB -\u0026gt; AWS Autoscaling Group -\u0026gt; EC2 Backend: consul cluster Vault AMI security group tested by hashicorp with terratest goto https://github.com/hashicorp/terraform-aws-vault terraform-aws-vault å¦‚ä½•ä½¿ç”¨\nå¯ä»¥åƒè€ƒ main.tf ç¯„ä¾‹ å¯ä»¥æª¢è¦– ./modules å…§èªªæ˜é€æ­¥æ“ä½œ terraform-aws-vault-starter ELB -\u0026gt; AWS Autoscaling Group -\u0026gt; EC2 security group Integrated storage (raft) goto https://github.com/hashicorp/terraform-aws-vault-starter Integrated storage integrated-storage Raft Consensus protocol å‡ºincidentè¦æœ‰è¾¦æ³•è§£ stateful server å‚™ä»½ï¼Œç®¡ç†(è³‡æ–™é·ç§») util å·¥å…·æœªå¿…å¤ æˆç†Ÿ é¸ä¸€å€‹æœƒç¶­è­·çš„storage DynamoDB MySQL / PostgreSQL æ³¨æ„storageæ˜¯å¦èƒ½å¤ ç‚ºç¶­è­·ï¼Œé‡å•Ÿï¼Œå‚™ä»½ On Kubernetes argocd + vault helm chart\nserver èˆ‡ injector å»ºè­°åˆ†é–‹å…©å€‹ argocd applicatoin / helm releaseç¨ç«‹deploy\nserver é¸ä¸€å€‹æœƒç¶­è­·çš„storage backend injector goto https://github.com/hashicorp/vault-helm/blob/main/values.yaml#L357\næ³¨æ„server æ˜¯å¦ ha\nDeploy On Kubernetes secure your k8s goto https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/\nFAQ: on VM or on K8s? å•é¡Œä¸æ˜¯ vault åœ¨ VM ä¸Šå®‰å…¨ï¼Œé‚„æ˜¯åœ¨ k8s ä¸Šå®‰å…¨ è€Œæ˜¯åœ˜éšŠèƒ½ä¸èƒ½ secure åº•ä¸‹çš„ infraï¼Œå¦‚æœç†Ÿ VM å°±æœƒè¦ºå¾— VM å¥½åš secure k8s æ˜¯ VM + k8s éƒ½è¦\nå›åˆ° Outline: prod-ready terraform configuration IaC auth method / config / role secret mounts policy team / people application / service account audit log Vault Configuration IaC VCS / PR reviewed well-formed / linted / no-typo multiple env: dev, stag, prod programable / reusable: æ¨™æº–åŒ–ï¼Œå¯é‡è¤‡ä½¿ç”¨çš„ code tested å¯ä»¥ç‚º terraform code å¯«æ¸¬è©¦ å¯ä»¥å¯«æ•´åˆæ¸¬è©¦è…³æœ¬æ¸¬è©¦ vault dev server automation auditable version control æœ‰å¤šé‡è¦ï¼Ÿ\næœ‰ / æ²’æœ‰ review çš„ code å“è³ªï¼Œå¤©å·®åœ°é  åˆ†äº«åœ˜éšŠçŸ¥è­˜ï¼Œåˆ†äº«è®Šæ›´è³‡è¨Š é¿å…æœ€é›·çš„åŒäº‹å‡ºåŒ…ï¼Œå…¨ team çš„æ•ˆèƒ½ç“¶é ¸ change management å°æ–¼ vault å…§çš„çš„æ›´æ”¹è¦æœ€åš´æ ¼æ§åˆ¶ æ²’æœ‰ã€èª’æ˜¯èª°æ”¹äº†é€™å€‹æˆ‘æ€éº¼ä¸çŸ¥é“ã€é€™å›äº‹ Linter / formated æ˜¯å·¥ä½œæ•ˆç‡çš„æ ¹æœ¬\nå¤šç’°å¢ƒæ¸¬è©¦\næœ‰å®‰å…¨çš„æ¸¬è©¦ç’°å¢ƒï¼Œæ‰èƒ½ä¿ƒé€²åœ˜éšŠå‰µæ–° æœ‰ / æ²’æœ‰ ç¶“éå®Œæ•´ç’°å¢ƒæ¸¬è©¦çš„ release å“è³ªï¼Œå¤©å·®åœ°é  Programable / Reusable\nvariable / for loop reusable module / donâ€™t repeat your self tested policy code\npolicy as code terratest automation\ngitflow secured admin access only to workflow. developer donâ€™t have admin access. auditable\naudit in code / review live server generate audit log å¤–éƒ¨ç¨½æ ¸ hashicorp official tutorial tee admin-policy.hcl \u0026lt;\u0026lt;EOF # Read system health check path \u0026#34;sys/health\u0026#34; { capabilities = [\u0026#34;read\u0026#34;, \u0026#34;sudo\u0026#34;] } # List existing policies path \u0026#34;sys/policies/acl\u0026#34; { capabilities = [\u0026#34;list\u0026#34;] } EOF configure vault policy with CLI hashicorp official tutorial vault policy â€¦","date":1695254400,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695705440,"objectID":"86c60c34cc522e669267a036580d9278","permalink":"https://chechia.net/zh-hant/slides/2023-09-26-devopsday-2023-vault/","publishdate":"2023-09-21T00:00:00Z","relpermalink":"/zh-hant/slides/2023-09-26-devopsday-2023-vault/","section":"slides","summary":"å¾å°å…¥ HashiCorp Vault ä½œç‚ºèµ·é»ï¼Œç›´æ¥æä¾›å¯¦å‹™ä¸Šç¶“é©—ï¼Œåˆ†äº«å»ºè­°çš„å…¥å‘è¨­å®š","tags":["vault","terraform","iac","kubernetes"],"title":"DevOpsDay: HashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢","type":"slides"},{"authors":[],"categories":["vault","docker"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 09: Deploy with Docker Local with Docker minikube r=https://api.github.com/repos/kubernetes/minikube/releases curl -LO $(curl -s $r | grep -o \u0026#39;http.*download/v.*beta.*/minikube-darwin-arm64\u0026#39; | head -n1) sudo install minikube-darwin-arm64 /usr/local/bin/minikube å¦‚ä½•é¸æ“‡ VM or Docker or Kubernetes å‡è­°é¡Œ\nchatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/install å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026#34;æ‚¨\u0026#34;ï¼Œè«‹ç”¨\u0026#34;ä½ \u0026#34;å–ä»£\u0026#34;æ‚¨\u0026#34;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026#34;æ•¸æ“š\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™\u0026#34;ï¼Œå°‡ \u0026#34;æ•¸æ“šåº«\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™åº«\u0026#34;ï¼Œå°‡ \u0026#34;æ•¸æ“š\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™\u0026#34;ï¼Œå°‡ \u0026#34;è¨ªå•\u0026#34; æ”¹ç‚º \u0026#34;å­˜å–\u0026#34;ï¼Œå°‡ \u0026#34;æºä»£ç¢¼\u0026#34; æ”¹ç‚º \u0026#34;åŸå§‹ç¢¼\u0026#34;ï¼Œå°‡ \u0026#34;ä¿¡æ¯\u0026#34; æ”¹ç‚º \u0026#34;è³‡è¨Š\u0026#34;ï¼Œå°‡ \u0026#34;å‘½ä»¤\u0026#34; æ”¹ç‚º \u0026#34;æŒ‡ä»¤\u0026#34;ï¼Œå°‡ \u0026#34;ç¦ç”¨\u0026#34; æ”¹ç‚º \u0026#34;åœç”¨\u0026#34;ï¼Œå°‡ \u0026#34;é»˜èª\u0026#34; æ”¹ç‚º \u0026#34;é è¨­\u0026#34;ã€‚ ","date":1694644946,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695693546,"objectID":"1c39a5994f9f38f15204da63004165db","permalink":"https://chechia.net/zh-hant/post/2023-09-21-vault-workshop-deploy-on-kubernetes/","publishdate":"2023-09-14T06:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-21-vault-workshop-deploy-on-kubernetes/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 09: Deploy with Docker Local with Docker minikube r=https://api.github.com/repos/kubernetes/minikube/releases curl -LO $(curl -s $r | grep -o 'http.*download/v.*beta.*/minikube-darwin-arm64' | head -n1) sudo install minikube-darwin-arm64 /usr/local/bin/minikube å¦‚ä½•é¸æ“‡ VM or Docker or Kubernetes å‡è­°é¡Œ","tags":["vault","iac","workshop","docker","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 10: Deploy with Docker","type":"post"},{"authors":[],"categories":["vault","docker"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 09: Deploy with Docker Vault configuration chatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/install å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026#34;æ‚¨\u0026#34;ï¼Œè«‹ç”¨\u0026#34;ä½ \u0026#34;å–ä»£\u0026#34;æ‚¨\u0026#34;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026#34;æ•¸æ“š\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™\u0026#34;ï¼Œå°‡ \u0026#34;æ•¸æ“šåº«\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™åº«\u0026#34;ï¼Œå°‡ \u0026#34;æ•¸æ“š\u0026#34; æ”¹ç‚º \u0026#34;è³‡æ–™\u0026#34;ï¼Œå°‡ \u0026#34;è¨ªå•\u0026#34; æ”¹ç‚º \u0026#34;å­˜å–\u0026#34;ï¼Œå°‡ \u0026#34;æºä»£ç¢¼\u0026#34; æ”¹ç‚º \u0026#34;åŸå§‹ç¢¼\u0026#34;ï¼Œå°‡ \u0026#34;ä¿¡æ¯\u0026#34; æ”¹ç‚º \u0026#34;è³‡è¨Š\u0026#34;ï¼Œå°‡ \u0026#34;å‘½ä»¤\u0026#34; æ”¹ç‚º \u0026#34;æŒ‡ä»¤\u0026#34;ï¼Œå°‡ \u0026#34;ç¦ç”¨\u0026#34; æ”¹ç‚º \u0026#34;åœç”¨\u0026#34;ï¼Œå°‡ \u0026#34;é»˜èª\u0026#34; æ”¹ç‚º \u0026#34;é è¨­\u0026#34;ã€‚ ","date":1694641346,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695693546,"objectID":"35cac6b0ffb7996b911978440f6a4c58","permalink":"https://chechia.net/zh-hant/post/2023-09-20-vault-workshop-ha-docker/","publishdate":"2023-09-14T05:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-20-vault-workshop-ha-docker/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 09: Deploy with Docker Vault configuration chatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/install å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\"æ‚¨\"ï¼Œè«‹ç”¨\"ä½ \"å–ä»£\"æ‚¨\"ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \"æ•¸æ“š\" æ”¹ç‚º \"è³‡æ–™\"ï¼Œå°‡ \"æ•¸æ“šåº«\" æ”¹ç‚º \"è³‡æ–™åº«\"ï¼Œå°‡ \"æ•¸æ“š\" æ”¹ç‚º \"è³‡æ–™\"ï¼Œå°‡ \"è¨ªå•\" æ”¹ç‚º \"å­˜å–\"ï¼Œå°‡ \"æºä»£ç¢¼\" æ”¹ç‚º \"åŸå§‹ç¢¼\"ï¼Œå°‡ \"ä¿¡æ¯\" æ”¹ç‚º \"è³‡è¨Š\"ï¼Œå°‡ \"å‘½ä»¤\" æ”¹ç‚º \"æŒ‡ä»¤\"ï¼Œå°‡ \"ç¦ç”¨\" æ”¹ç‚º \"åœç”¨\"ï¼Œå°‡ \"é»˜èª\" æ”¹ç‚º \"é è¨­\"ã€‚ ","tags":["vault","iac","workshop","docker","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 09: Vault HA","type":"post"},{"authors":[],"categories":["vault","docker"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 08: Vault in Docker and Initialization Vault in container å‰å¹¾å¤©æˆ‘å€‘ä½¿ç”¨ vault dev Server ä¾†å•Ÿç”¨æ¸¬è©¦ç”¨çš„ Vault serverã€‚\nåœ¨ production ç’°å¢ƒæˆ‘å€‘ä¸æœƒä½¿ç”¨ dev Serverã€‚Vault æä¾›è¨±å¤šå®‰è£æ–¹æ³•\nå¯ä»¥ä½¿ç”¨ binary ç›´æ¥å®‰è£åœ¨VMä¸Š ä¹Ÿå¯ä»¥é€é hashicorp/vault official docker imageï¼Œåœ¨container ç’°å¢ƒä¸­åŸ·è¡Œ æˆ–æ˜¯ä½¿ç”¨ hashicorp official helm chartï¼Œå®‰è£åœ¨kuberntesä¸Š ä½¿ç”¨ç¯„ä¾‹ repository ä½ å¯ä»¥ä½¿ç”¨ç­†è€…æº–å‚™çš„ç¯„ä¾‹ repository https://github.com/chechiachang/vault-playground\ngit clone git@github.com:chechiachang/vault-playground.git cd deploy/00-docker-dev/ ä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤å•Ÿå‹• vault in docker\nä¸¦ä½¿ç”¨ -v flag ä¾†æ›è¼‰ ./config/ volume åˆ° container ä¸­çš„ /vault/config.d/ docker run --cap-add=IPC_LOCK \\ --volume ./vault/config/:/vault/config.d \\ --volume ./vault/file/:/vault/file \\ --volume ./vault/logs/:/vault/logs \\ -p 8200:8200 \\ --name vault_1 \\ -d \\ hashicorp/vault:1.14.3 \\ vault server -config=/vault/config.d/vault.hcl ç„¶å¾Œä½¿ç”¨ docker logs æŒ‡ä»¤æª¢è¦– vault server log\ndocker logs -f vault_1 output\n==\u0026gt; Vault server configuration: Administrative Namespace: Api Address: https://0.0.0.0:8200 Cgo: disabled Cluster Address: https://0.0.0.0:8201 Environment Variables: GODEBUG, GOTRACEBACK, HOME, HOSTNAME, NAME, PATH, PWD, SHLVL, VERSION Go Version: go1.20.8 Listener 1: tcp (addr: \u0026#34;0.0.0.0:8200\u0026#34;, cluster address: \u0026#34;0.0.0.0:8201\u0026#34;, max_request_duration: \u0026#34;1m30s\u0026#34;, max_request_size: \u0026#34;33554432\u0026#34;, tls: \u0026#34;disabled\u0026#34;) Log Level: Mlock: supported: true, enabled: false Recovery Mode: false Storage: file Version: Vault v1.14.3, built 2023-09-11T21:23:55Z Version Sha: 56debfa71653e72433345f23cd26276bc90629ce ==\u0026gt; Vault server started! Log data will stream in below: 2023-09-20T13:38:25.914Z [INFO] proxy environment: http_proxy=\u0026#34;\u0026#34; https_proxy=\u0026#34;\u0026#34; no_proxy=\u0026#34;\u0026#34; 2023-09-20T13:38:25.920Z [INFO] core: Initializing version history cache for core ä½ æœƒç™¼ç¾ï¼Œvault server ä¸æ˜¯ä»¥ dev server çš„ç‹€æ…‹å•Ÿå‹•çš„ï¼Œéœ€è¦é€²è¡Œé¡å¤–çš„åˆå§‹åŒ–è¨­å®š\nexport VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; æª¢æŸ¥ vault status\nvault status outputï¼Œé¡¯ç¤ºä¸€å€‹ä¸Šæœªåˆå§‹åŒ–çš„ vault server èˆ‡å…¶ storage backend â€œfilesysteâ€\nå¯ä»¥åœ¨ ./vault/config/vault.hcl ä¸Šçœ‹åˆ°æˆ‘å€‘ä½¿ç”¨æ–°çš„ Storage Backend â€œfileâ€ è¨­å®š vault server çš„ storage backend ç›®å‰æ˜¯ sealed ç‹€æ…‹ ä¸æ˜¯ vault server sealedï¼Œè€Œæ˜¯æ²’æœ‰æä¾› vault server åˆå§‹åŒ–è¨­å®š / unseal keysï¼Œæ‰€ä»¥ vault server ç„¡æ³•è§£å¯† storage backend Key Value --- ----- Seal Type shamir Initialized false Sealed true Total Shares 0 Threshold 0 Unseal Progress 0/0 Unseal Nonce n/a Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type file HA Enabled false Storage Backend: filesystem https://developer.hashicorp.com/vault/docs/configuration/storage/filesystem\nfilesystem storage backendå°‡ Vault çš„è³‡æ–™å­˜å„²åœ¨æ–‡ä»¶ç³»çµ±ä¸Šï¼Œä½¿ç”¨æ¨™æº–çš„ç›®éŒ„çµæ§‹ã€‚\nå®ƒå¯ä»¥ç”¨æ–¼æŒä¹…çš„Single Serveræƒ…æ³ï¼Œæˆ–è€…åœ¨æœ¬åœ°é–‹ç™¼æ™‚ï¼Œè€ä¹…æ€§ä¸æ˜¯é—œéµå•é¡Œçš„æƒ…æ³ä¸‹ä½¿ç”¨ã€‚\nfilesystem storage backend ä¸æ”¯æ´é«˜å¯ç”¨æ€§ - æª”æ¡ˆç³»çµ±å¾Œç«¯ä¸æ”¯æ´é«˜å¯ç”¨æ€§ã€‚\nfilesystem storage backend ç”±HashiCorp å®˜æ–¹æ”¯æ´ - æª”æ¡ˆç³»çµ±å¾Œç«¯æ˜¯ç”± HashiCorp å®˜æ–¹æ”¯æ´ç¶­è­·çš„ã€‚\nåˆå§‹åŒ– Vault åˆå§‹åŒ–æ˜¯é…ç½® Vault çš„éç¨‹ã€‚åƒ…å°ç¬¬ä¸€æ¬¡ä½¿ç”¨åœ¨ Vault server ä¸Šçš„ Backend ä¸ŠåŸ·è¡Œä¸€æ¬¡ã€‚åœ¨é«˜å¯ç”¨(HA)æ¨¡å¼ä¸‹é‹è¡Œæ™‚ï¼Œé€™åƒ…åœ¨æ¯å€‹å¢é›†(Vault Cluster)ä¸­åŸ·è¡Œä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯å°Serverã€‚\nåœ¨åˆå§‹åŒ–æœŸé–“ï¼Œå°‡ç”ŸæˆåŠ å¯†é‡‘é‘°ã€å‰µå»º unseal keysï¼Œä¸¦å‰µå»º init root tokenã€‚\nåˆå§‹åŒ–ä¸éœ€èº«ä»½é©—è­‰ï¼Œåƒ…é©ç”¨æ–¼å…¨æ–°çš„ Vaultï¼Œæœ‰è³‡æ–™å­˜åœ¨çš„ Storage Backend ç„¡æ³•ç”¨åˆå§‹åŒ–è§£é–ã€‚\nè¦åˆå§‹åŒ– Vaultï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤\nvault operator init output\nUnseal Key 1: 9AYJ...kNCn Unseal Key 2: RqDx...odRU Unseal Key 3: uHUv...lws4 Unseal Key 4: f+KD...aHgL Unseal Key 5: AKyF...e6vd Initial Root Token: hvs.8yU3...7esX Vault initialized with 5 key shares and a key threshold of 3. Please securely distribute the key shares printed above. When the Vault is re-sealed, restarted, or stopped, you must supply at least 3 of these keys to unseal it before it can start servicing requests. # Vault ä½¿ç”¨äº† 5 å€‹é‡‘é‘°ä»½é¡encryption key shareå’Œ 3 çš„ key threshold é€²è¡Œåˆå§‹åŒ–ã€‚è«‹å®‰å…¨åœ°åˆ†ç™¼ä¸Šé¢çš„é‡‘é‘°ä»½é¡ã€‚ # ç•¶ Vault è¢«é‡æ–°å¯†å°ã€é‡æ–°å•Ÿå‹•æˆ–åœæ­¢æ™‚ï¼Œä½ å¿…é ˆæä¾›è‡³å°‘ 3 å€‹é€™äº›é‡‘é‘°ä¾†å°å…¶é€²è¡Œè§£å°ï¼Œç„¶å¾Œå®ƒæ‰èƒ½é–‹å§‹è™•ç†è«‹æ±‚ã€‚ Vault does not store the generated root key. Without at least 3 keys to reconstruct the root key, Vault will remain permanently sealed! # Vault ä¸å­˜å„²ç”Ÿæˆçš„æ ¹é‡‘é‘°ã€‚å¦‚æœæ²’æœ‰è‡³å°‘ 3 å€‹é‡‘é‘°ä¾†é‡å»ºæ ¹é‡‘é‘°ï¼ŒVault å°‡ä¿æŒæ°¸ä¹…å¯†å°ï¼ It is possible to generate new unseal keys, provided you have a quorum of existing unseal keys shares. See \u0026#34;vault operator rekey\u0026#34; for more information. # å¦‚æœä½ æœ‰è¶³å¤ çš„ç¾æœ‰è§£å°é‡‘é‘°ä»½é¡ï¼Œå‰‡å¯ä»¥ç”Ÿæˆæ–°çš„è§£å°é‡‘é‘°ã€‚æœ‰é—œæ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–± \u0026#34;vault operator rekey\u0026#34;ã€‚ åˆå§‹åŒ–éç¨‹è¼¸å‡ºäº†å…©å€‹éå¸¸é‡è¦çš„ä¿¡æ¯ï¼šè§£å°é‡‘é‘°å’Œ init root tokenã€‚é€™æ˜¯å”¯ä¸€ä¸€æ¬¡ Vault é¡¯ç¤ºé€™äº›è³‡æ–™ã€‚\nç‚ºäº†é€™å€‹å…¥é–€èª²ç¨‹ï¼Œè«‹å°‡é€™äº›é‡‘é‘°ä¿å­˜åœ¨æŸå€‹åœ°æ–¹ï¼Œç„¶å¾Œç¹¼çºŒé€²è¡Œæ“ä½œã€‚\nVault backend storage èª key ä¸èªäººï¼Œè«‹æ”¶å¥½é€™äº”éš» unseal keyï¼Œæ”¾ç½®åœ¨äº”å€‹ä¸åŒå®‰å…¨çš„åœ°æ–¹ æœ‰ 3/5 çš„ unseal key å°±èƒ½é‡å»º encryption keyï¼Œä¹Ÿå°±æ˜¯èƒ½å¤ è§£å¯† storage backend å¯ä»¥ç”¨ 3/5 unseal key ç”¢ç”Ÿ root token vault operator generate-root æ›å¥è©±èªªï¼Œunseal key æ˜¯æ¯” root é‚„å¤§çš„è¶…ç´šç®¡ç†å“¡ key åœ¨å¯¦éš›çš„éƒ¨ç½²æƒ…æ³ä¸‹ï¼Œä½ æ°¸é ä¸æ‡‰è©²å°‡é€™äº›é‡‘é‘°ä¿å­˜åœ¨ä¸€èµ·ã€‚ ä½ å¯èƒ½æœƒä½¿ç”¨ Vault çš„ PGP å’Œ Keybase.io æ”¯æ´ï¼Œä½¿ç”¨ä½¿ç”¨è€…çš„ PGP é‡‘é‘°åŠ å¯†æ¯å€‹è§£å°é‡‘é‘°ã€‚ é€™å¯ä»¥é˜²æ­¢å–®å€‹äººæ“æœ‰æ‰€æœ‰çš„è§£å°é‡‘é‘°ã€‚ vault server logï¼Œå¯ä»¥çœ‹åˆ° vault server é–‹å§‹é€²è¡Œåˆå§‹åŒ–æµç¨‹\n2023-09-20T13:47:05.113Z [INFO] core: security barrier not initialized 2023-09-20T13:47:05.117Z [INFO] core: seal configuration missing, not initialized 2023-09-20T14:03:28.506Z [INFO] core: security barrier not initialized 2023-09-20T14:03:28.512Z [INFO] core: seal configuration missing, not initialized 2023-09-20T14:03:28.521Z [INFO] core: security barrier not initialized 2023-09-20T14:03:28.557Z [INFO] core: security barrier initialized: stored=1 shares=5 threshold=3 â€¦","date":1694637746,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695224937,"objectID":"59374be8f87e0b492479a15fb6977f17","permalink":"https://chechia.net/zh-hant/post/2023-09-19-vault-workshop-docker-and-initialization/","publishdate":"2023-09-14T04:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-19-vault-workshop-docker-and-initialization/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 08: Vault in Docker and Initialization Vault in container å‰å¹¾å¤©æˆ‘å€‘ä½¿ç”¨ vault dev Server ä¾†å•Ÿç”¨æ¸¬è©¦ç”¨çš„ Vault serverã€‚\nåœ¨ production ç’°å¢ƒæˆ‘å€‘ä¸æœƒä½¿ç”¨ dev Serverã€‚Vault æä¾›è¨±å¤šå®‰è£æ–¹æ³•","tags":["vault","iac","workshop","docker","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 08: Vault in Docker and Initialization","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 07: Policy \u0026amp; Approle åœ¨ Vault ä¸­ï¼Œç­–ç•¥ï¼ˆPoliciesï¼‰æ§åˆ¶è‘—ä½¿ç”¨è€…å¯ä»¥è¨ªå•çš„è³‡æºã€‚åœ¨ä¸Šä¸€ç¯‡èº«ä»½é©—è­‰ä¸­ï¼Œä½ å·²ç¶“å­¸åˆ°äº†èº«ä»½é©—è­‰æ–¹æ³•(authentication method)ã€‚è€Œé€™ä¸€ç¯€æ˜¯é—œæ–¼æˆæ¬Š(Authorization)ï¼Œä¹Ÿå°±æ˜¯åˆæ³•çš„ç”¨æˆ¶ç™»å…¥å¾Œï¼Œæ‡‰è©²èƒ½å¤ å–å¾—æ€æ¨£çš„æ¬Šé™ã€‚\nåœ¨èº«ä»½é©—è­‰æ–¹é¢ï¼ŒVault æä¾›äº†å¤šç¨®å•Ÿç”¨å’Œä½¿ç”¨çš„é¸é …æˆ–æ–¹æ³•ã€‚Vault åœ¨æˆæ¬Šå’Œ policy æ–¹é¢ä¹Ÿä½¿ç”¨ç›¸åŒçš„è¨­è¨ˆã€‚æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•éƒ½å°‡ç™»å…¥è€…çš„èº«ä»½ map å›èˆ‡ Vault é…ç½®çš„æ ¸å¿ƒ policyã€‚\næº–å‚™ç’°å¢ƒ åœ¨ vault å®˜æ–¹ç¶²ç«™æ–‡ä»¶ä¸­ï¼ŒHashicorp å®˜æ–¹æº–å‚™äº† https://instruqt.com/çš„ session lab\nç­†è€…å€‹äººè¦ºå¾— interactive lab çš„ browser tab å¾ˆé›£ç”¨ï¼Œä¹Ÿä¸å–œæ­¡ Terminal session é€£ remote VM çš„å»¶é²ï¼Œä»¥ä¸‹å…§å®¹é‚„æ˜¯æœƒä½¿ç”¨ local dev Server èªªæ˜ã€‚\nè§€çœ¾å€‘å¯ä»¥è‡ªå·±æ–Ÿé…Œä½¿ç”¨ã€‚\nPolicy æ ¼å¼ ç­–ç•¥ï¼ˆPoliciesï¼‰æ˜¯ä»¥HCLæ’°å¯«çš„ï¼Œä½†ä¹Ÿå…¼å®¹JSONæ ¼å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ç¯„ä¾‹ç­–ç•¥ï¼š\n# Dev servers have version 2 of KV secrets engine mounted by default, so will # need these paths to grant permissions: path \u0026#34;secret/data/*\u0026#34; { capabilities = [\u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;] } path \u0026#34;secret/data/foo\u0026#34; { capabilities = [\u0026#34;read\u0026#34;] } é€™å€‹ç¯„ä¾‹ policy æˆäºˆäº†å° KV v2 ç§˜å¯†ç®¡ç†ï¼ˆsecrets engineï¼‰çš„è³‡æºçš„èƒ½åŠ›ã€‚å¦‚æœä½ å°æ–¼èˆ‡é€™å€‹ç§˜å¯†ç®¡ç†å¼•æ“ç›¸é—œçš„è·¯å¾‘ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥é–±è©²ç§˜å¯†ç®¡ç†å¼•æ“æ–‡ä»¶ä¸­çš„ ACL è¦å‰‡éƒ¨åˆ†ã€‚\næ ¹æ“šé€™å€‹ policyï¼Œä½¿ç”¨è€…å¯ä»¥å° secret/data/ ä¸­çš„ä»»ä½•ç§˜å¯†é€²è¡Œå¯«å…¥æ“ä½œï¼Œä½†å°æ–¼ secret/data/foo çš„å­˜å–åƒ…å…è¨±è®€å–ã€‚policy çš„é è¨­è¡Œç‚ºæ˜¯ Denyï¼Œå› æ­¤ä¸å…è¨±å°æœªæŒ‡å®šè·¯å¾‘çš„è³‡æºé€²è¡Œä»»ä½•å­˜å–ã€‚\npolicy æ ¼å¼ä½¿ç”¨ prefix åŒ¹é…ç³»çµ±ä¾†ç¢ºå®šå° API è·¯å¾‘çš„è¨ªå•æ§åˆ¶ã€‚ä½¿ç”¨æœ€å…·é«”çš„å·²å®šç¾©ç­–ç•¥ï¼Œå³ç²¾ç¢ºåŒ¹é…æˆ–æœ€é•· prefix åŒ¹é…ã€‚ä¹Ÿå°±æ˜¯å­˜å– secret/data/foo è·¯å¾‘ç¬¦åˆä¸Šé¢å…©æ¢è¦å‰‡ï¼Œä½†æ˜¯ç”±æ–¼ç¬¬äºŒæ¢è¦å‰‡çš„è·¯å¾‘ match æœ€é•·æœ€ç²¾ç¢ºï¼Œæ‰€ä»¥æœ€çµ‚æ‹¿åˆ°çš„æ¬Šé™æ˜¯ â€œreadâ€\nç”±æ–¼ Vault ä¸­çš„ä¸€åˆ‡éƒ½å¿…é ˆé€šé API é€²è¡Œè¨ªå•ï¼Œé€™ä½¿å¾—å° Vault çš„æ¯å€‹æ–¹é¢éƒ½æœ‰åš´æ ¼çš„æ§åˆ¶ï¼ŒåŒ…æ‹¬å•Ÿç”¨ç§˜å¯†ç®¡ç†å¼•æ“ã€å•Ÿç”¨èº«ä»½é©—è­‰æ–¹æ³•ã€èº«ä»½é©—è­‰ï¼Œä»¥åŠå­˜å–ç§˜å¯†ç­‰ã€‚\næœ‰ä¸€äº›å…§å»ºçš„ç­–ç•¥ç„¡æ³•è¢«ç§»é™¤ã€‚ä¾‹å¦‚ï¼Œroot policy å’Œ default policy æ˜¯å¿…éœ€çš„ç­–ç•¥ï¼Œç„¡æ³•è¢«åˆªé™¤ã€‚\ndefault policy æä¾›äº†ä¸€çµ„å¸¸è¦‹çš„æ¬Šé™ï¼Œä¸¦ä¸” default åŒ…å«åœ¨æ‰€æœ‰ token ä¸­ã€‚ root policy çµ¦äºˆ token è¶…ç´šç®¡ç†å“¡æ¬Šé™ï¼Œé¡ä¼¼æ–¼Linuxæ©Ÿå™¨ä¸Šçš„ root ç”¨æˆ¶ã€‚ å•Ÿå‹•æœ¬åœ°é–‹ç™¼ç’°å¢ƒ æ­¥é©Ÿåœ¨å‰å¹¾ç¯‡å·²ç¶“å‡ºç¾éæ•¸æ¬¡ï¼Œé€™é‚Šå°±ç°¡å–®å¸¶é\nvault server -dev -dev-no-store-token export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; unset VAULT_TOKEN vault login Defult policy ä½ å¯ä»¥ç”¨ä¸‹åˆ—æŒ‡ä»¤åˆ—å‡ºé è¨­çš„ policy\nvault policy list output\ndefault root å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤è®€å– default policy çš„å…§å®¹\nvault policy read default output å›å‚³è¨±å¤šæ¢ policy ruleï¼Œä¸»è¦æ˜¯çµ¦äºˆ token åŸºæœ¬çš„æ“ä½œæ¬Šé™\n# Allow tokens to look up their own properties path \u0026#34;auth/token/lookup-self\u0026#34; { capabilities = [\u0026#34;read\u0026#34;] } # Allow tokens to renew themselves path \u0026#34;auth/token/renew-self\u0026#34; { capabilities = [\u0026#34;update\u0026#34;] } # Allow tokens to revoke themselves path \u0026#34;auth/token/revoke-self\u0026#34; { capabilities = [\u0026#34;update\u0026#34;] } ... ç†Ÿæ‚‰ default policy å…§å®¹å¾Œï¼Œå¯ä»¥æ–Ÿé…Œä½¿ç”¨ã€‚æˆ–æ˜¯é¸æ“‡å¾é ­ç·¨å¯«è‡ªå·±çš„ policyã€‚\nç·¨å¯«ç¬¬ä¸€å€‹ policy è¦æ’°å¯« policy ï¼Œä½¿ç”¨ vault policy write æŒ‡ä»¤ã€‚è«‹æŸ¥é–±è©²æŒ‡ä»¤çš„å¹«åŠ©æ–‡ä»¶ä»¥é€²ä¸€æ­¥äº†è§£ç”¨æ³•ã€‚\nvault policy write -h Usage: vault policy write [options] NAME PATH Uploads a policy with name NAME from the contents of a local file PATH or stdin. If PATH is \u0026#34;-\u0026#34;, the policy is read from stdin. Otherwise, it is loaded from the file at the given path on the local disk. # ä½¿ç”¨ vault policy write æŒ‡ä»¤ï¼Œå¯ä»¥å¾æœ¬åœ°æ–‡ä»¶ PATH æˆ–æ¨™æº–è¼¸å…¥ï¼ˆstdinï¼‰çš„å…§å®¹ä¸Šå‚³ä¸€å€‹åç‚º NAME çš„ç­–ç•¥ã€‚å¦‚æœ PATH æ˜¯ \u0026#34;-\u0026#34;ï¼Œå‰‡ç­–ç•¥å°‡å¾ stdin è®€å–ã€‚å¦å‰‡ï¼Œå®ƒå°‡å¾æœ¬åœ° disk ä¸Šçµ¦å®šè·¯å¾‘çš„æ–‡ä»¶ä¸­è¼‰å…¥ã€‚ Upload a policy named \u0026#34;my-policy\u0026#34; from \u0026#34;/tmp/policy.hcl\u0026#34; on the local disk: $ vault policy write my-policy /tmp/policy.hcl Upload a policy from stdin: $ cat my-policy.hcl | vault policy write my-policy - ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å‰µå»ºåç‚º â€œmy-policyâ€ çš„ policyï¼Œä¸¦å°‡å…¶å…§å®¹ä¾†è‡ª stdinï¼ˆæ¨™æº–è¼¸å…¥ï¼‰\nvault policy write my-policy - \u0026lt;\u0026lt; EOF # Dev servers have version 2 of KV secrets engine mounted by default, so will # need these paths to grant permissions: path \u0026#34;secret/data/*\u0026#34; { capabilities = [\u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;] } path \u0026#34;secret/data/foo\u0026#34; { capabilities = [\u0026#34;read\u0026#34;] } EOF output\nSuccess! Uploaded policy: my-policy ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤åˆ—å‡º policy\nvault policy list output\ndefault my-policy root è®€å– my-policy çš„å…§å®¹\nvault policy read my-policy output\n# Dev servers have version 2 of KV secrets engine mounted by default, so will # need these paths to grant permissions: path \u0026#34;secret/data/*\u0026#34; { capabilities = [\u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;] } path \u0026#34;secret/data/foo\u0026#34; { capabilities = [\u0026#34;read\u0026#34;] } æ¸¬è©¦ policy ä½ æ‰€å»ºç«‹çš„ policy ï¼Œæä¾›å° KV-V2 ç§˜å¯†å¼•æ“æ‰€å®šç¾©çš„ç§˜å¯†é€²è¡Œç®¡ç†ã€‚policy è¢«é™„åŠ åˆ° Vault ç›´æ¥ç”Ÿæˆçš„ otokenï¼Œæˆ–é€éå…¶å„ç¨®æˆæ¬Šæ–¹æ³•ç”Ÿæˆçš„ token ä¸Šã€‚\nå‰µå»ºä¸€å€‹ token ï¼Œæ·»åŠ  my-policyã€‚-field flag è¨­å®šåªå›å‚³éƒ¨åˆ† key-vault dataï¼Œè€Œä¸æ˜¯å‚³æ•´å€‹ metadata tableã€‚-policy è¨­å®šé€£çµ token çš„ policyã€‚\nvault token create -field token -policy=my-policy hvs.CAESIIDh...UxbUU ç‚ºäº†ç°¡åŒ–ï¼Œæœ¬å…§å®¹ä½¿ç”¨ dev æ¨¡å¼ä¼ºæœå™¨ï¼Œç›´æ¥å¾ token æˆæ¬Šæ–¹æ³•å‰µå»º token ã€‚è«‹è¨˜ä½ï¼Œåœ¨å¤§å¤šæ•¸ production ç’°å¢ƒéƒ¨ç½²ä¸­ï¼Œtoken å°‡ç”±å·²å•Ÿç”¨çš„æˆæ¬Šæ–¹æ³•(ex. github auth method)å‰µå»ºã€‚\nå¯ä»¥ä½¿ç”¨ token login\nvault login output å›å‚³ç™»å…¥è³‡è¨Šï¼Œä»¥åŠé€£çµ token çš„ policyï¼Œpolicy åŒ…å« default èˆ‡ my-policy\nSuccess! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026#34;vault login\u0026#34; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.CAESIIDh...UxbUU token_accessor vY3aLwMSezlxeOn7YwcjxuhZ token_duration 767h56m52s token_renewable true token_policies [\u0026#34;default\u0026#34; \u0026#34;my-policy\u0026#34;] identity_policies [] policies [\u0026#34;default\u0026#34; \u0026#34;my-policy\u0026#34;] ä½ å¯ä»¥åŸ·è¡Œ vault token lookupï¼ŒæŸ¥æ‰¾ç›®å‰ token çš„å®Œæ•´è³‡è¨Š\nvault token lookup output\nKey Value --- ----- accessor vY3aLwMSezlxeOn7YwcjxuhZ creation_time 1694917062 creation_ttl 768h display_name token entity_id n/a expire_time 2023-10-19T10:17:42.723364+08:00 explicit_max_ttl 0s id hvs.CAESIIDh...UxbUU issue_time 2023-09-17T10:17:42.723365+08:00 meta \u0026lt;nil\u0026gt; num_uses 0 orphan false path auth/token/create policies [default my-policy] renewable true ttl 767h55m45s type service é€™å€‹policy å•Ÿç”¨äº† secret/ ç§˜å¯†å¼•æ“å…§æ¯å€‹è·¯å¾‘çš„å‰µå»ºå’Œæ›´æ–°åŠŸèƒ½ï¼Œé™¤äº†ä¸€å€‹ä¾‹å¤–è·¯å¾‘ secret/data/foo  â€¦","date":1694634146,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695049410,"objectID":"e51bdf75acbc70ef48688971a226ba31","permalink":"https://chechia.net/zh-hant/post/2023-09-18-vault-workshop-policy-and-approle/","publishdate":"2023-09-14T03:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-18-vault-workshop-policy-and-approle/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 07: Policy \u0026 Approle åœ¨ Vault ä¸­ï¼Œç­–ç•¥ï¼ˆPoliciesï¼‰æ§åˆ¶è‘—ä½¿ç”¨è€…å¯ä»¥è¨ªå•çš„è³‡æºã€‚åœ¨ä¸Šä¸€ç¯‡èº«ä»½é©—è­‰ä¸­ï¼Œä½ å·²ç¶“å­¸åˆ°äº†èº«ä»½é©—è­‰æ–¹æ³•(authentication method)ã€‚è€Œé€™ä¸€ç¯€æ˜¯é—œæ–¼æˆæ¬Š(Authorization)ï¼Œä¹Ÿå°±æ˜¯åˆæ³•çš„ç”¨æˆ¶ç™»å…¥å¾Œï¼Œæ‡‰è©²èƒ½å¤ å–å¾—æ€æ¨£çš„æ¬Šé™ã€‚\nåœ¨èº«ä»½é©—è­‰æ–¹é¢ï¼ŒVault æä¾›äº†å¤šç¨®å•Ÿç”¨å’Œä½¿ç”¨çš„é¸é …æˆ–æ–¹æ³•ã€‚Vault åœ¨æˆæ¬Šå’Œ policy æ–¹é¢ä¹Ÿä½¿ç”¨ç›¸åŒçš„è¨­è¨ˆã€‚æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•éƒ½å°‡ç™»å…¥è€…çš„èº«ä»½ map å›èˆ‡ Vault é…ç½®çš„æ ¸å¿ƒ policyã€‚\næº–å‚™ç’°å¢ƒ åœ¨ vault å®˜æ–¹ç¶²ç«™æ–‡ä»¶ä¸­ï¼ŒHashicorp å®˜æ–¹æº–å‚™äº† https://instruqt.","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 07: Policy \u0026 approle","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 06ï¼šGithub auth method ä¸éœ€è¦ä½¿ç”¨ root token çš„ auth method: github Vault æ”¯æ´ç”¨æ–¼äººå“¡ä½¿ç”¨è€…çš„èº«ä»½é©—è­‰æ–¹æ³•ã€‚GitHub èº«ä»½é©—è­‰ï¼Œä½¿ç”¨æˆ¶å¯ä»¥é€šéæä¾›ä»–å€‘çš„ GitHub æ†‘è­‰ä¾†é©—è­‰ Vaultï¼Œä¸¦æ”¶åˆ°ä¸€å€‹ Vault tokenã€‚\nç°¡å–®ä¾†èªªï¼Œgithub organization chechia-netï¼Œå¯ä»¥è¨­å®šé©ç•¶çš„æ¬Šé™çµ¦æˆå“¡ chechiachangï¼Œè®“ chechiachang å¯ä»¥é€é github å–å¾—æœ‰æ¬Šé™çš„ tokenã€‚\næ³¨æ„\nåœ¨ç·´ç¿’ä¸­æ‰€æè¿°çš„é€™ç¨®èº«ä»½é©—è­‰æ–¹æ³•ï¼Œéœ€è¦ä½ æ“æœ‰ GitHubã€å±¬æ–¼ GitHub org ä¸­çš„ä¸€å€‹ team ï¼Œä¸¦ç”Ÿæˆäº†å…·æœ‰ read:org scope çš„ GitHub personal access tokenã€‚ä½ å¯ä»¥æ–¼ github å‰µå»ºä¸€å€‹ free plan çš„ orgï¼Œä¸¦è¨­å®šä¸€å€‹ teamï¼Œç„¶å¾Œé€éå€‹äºº Settings / Developer Settings ä¾†ç”¢ç”Ÿä¸€æŠŠå…·æœ‰ read:org æ¬Šé™çš„ personal access token\nå•Ÿç”¨ github auth method ä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼Œåœ¨ path=github/ ä¸‹å•Ÿç”¨ GitHub èº«ä»½é©—è­‰æ–¹æ³•ã€‚\nexport VAULT_TOKEN=hvs.qCqY...9KYv vault auth enable github é€™å€‹æŒ‡ä»¤ä½¿ç”¨ root token è¨­å®š auth methodï¼Œä¹Ÿæ˜¯æ•´å€‹ github auth methods ä¸­ï¼Œå”¯ä¸€éœ€è¦ç”¨åˆ° root token è¨­å®šçš„åœ°æ–¹ï¼Œè€Œä¸”åªéœ€è¦è¨­å®šä¸€æ¬¡\noutput\nSuccess! Enabled github auth method at: github/ vault server log é¡¯ç¤º credential backend å·²å•Ÿç”¨\n2023-09-16T21:40:10.444+0800 [INFO] core: enabled credential backend: path=github/ type=github version=\u0026#34;\u0026#34; ä½ å¯ä»¥ä¸‹åˆ—æŒ‡ä»¤ï¼Œåˆ—å‡ºæ‰€æœ‰çš„ auth methods\nvault auth list output\nPath Type Accessor Description Version ---- ---- -------- ----------- ------- github/ github auth_github_9bc96e5f n/a n/a token/ token auth_token_b7984c52 token based credentials n/a github èº«ä»½é©—è­‰æ–¹æ³•å·²å•Ÿç”¨ï¼Œä¸¦ä½æ–¼è·¯å¾‘ auth/github/ã€‚\nè¨­å®š github auth method æ­¤èº«ä»½é©—è­‰æ–¹æ³•éœ€è¦ä½ åœ¨é…ç½®ä¸­è¨­ç½® GitHub organizationã€‚GitHub organizationä¸­ï¼Œç¶­è­·äº†ä¸€å€‹å…è¨±èˆ‡ Vault é©—è­‰çš„ä½¿ç”¨è€…åˆ—è¡¨ã€‚\nè¨­ç½® GitHub èº«ä»½é©—è­‰çš„çµ„ç¹”ã€‚\nvault write auth/github/config organization=chechia-net output\nSuccess! Data written to: auth/github/config ç¾åœ¨ï¼Œchechia-net GitHub çµ„ç¹”ä¸­çš„æ‰€æœ‰ä½¿ç”¨è€…éƒ½å¯ä»¥é€²è¡Œèº«ä»½é©—è­‰ã€‚\nè¨­å®š github auth methodï¼Œçµ¦ä¸åŒ team ä¸åŒçš„ policy GitHub çµ„ç¹”å¯ä»¥å®šç¾©åœ˜éšŠ(team)ã€‚æ¯å€‹åœ˜éšŠå¯èƒ½å¯ä»¥åœ¨çµ„ç¹”ç¶­è­·çš„æ‰€æœ‰ repository ä¸­åŸ·è¡Œä¸åŒçš„æ“ä½œã€‚é€™äº›åœ˜éšŠä¹Ÿå¯èƒ½éœ€è¦è¨ªå• Vault å…§çš„ç‰¹å®šå¯†ç¢¼ã€‚\né…ç½® GitHub sre åœ˜éšŠçš„èº«ä»½é©—è­‰ï¼Œä»¥ç²å¾— default å’Œ application å…©å€‹ policyçš„æˆæ¬Šã€‚\nvault write auth/github/map/teams/sre value=default,application output\nSuccess! Data written to: auth/github/map/teams/sre GitHub sre åœ˜éšŠä¸­ chechia-net çµ„ç¹”çš„æˆå“¡ï¼Œå°‡ä½¿ç”¨ default å’Œ application policy é€²è¡Œèº«ä»½é©—è­‰å’Œæˆæ¬Šã€‚\nå‚™è¨»ï¼šapplication policy å°šæœªåœ¨ Vault ä¸­å®šç¾©ã€‚åœ¨è©²ç­–ç•¥å®šç¾©ä¹‹å‰ï¼ŒVault ä»ç„¶å…è¨±ä½¿ç”¨è€…é€²è¡Œèº«ä»½é©—è­‰ï¼Œä½†æœƒç”¢ç”Ÿè­¦å‘Šã€‚\nä½ å¯ä»¥ä½¿ç”¨æŒ‡ä»¤é¡¯ç¤º Vault å•Ÿç”¨çš„æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•\nvault auth list å›å‚³é¡¯ç¤ºå…©å€‹ auth methodsï¼Œgithub/ èˆ‡ token/\nPath Type Accessor Description Version ---- ---- -------- ----------- ------- github/ github auth_github_9bc96e5f n/a n/a token/ token auth_token_b7984c52 token based credentials n/a ä½¿ç”¨ github auth method login ä½¿ç”¨ help æŒ‡ä»¤ä¾†äº†è§£ github auth method çš„èªªæ˜\nvault auth help github output\nUsage: vault login -method=github [CONFIG K=V...] The GitHub auth method allows users to authenticate using a GitHub personal access token. Users can generate a personal access token from the settings page on their GitHub account. # GitHub èº«ä»½é©—è­‰æ–¹æ³•å…è¨±ä½¿ç”¨è€…ä½¿ç”¨ GitHub personal access tokené€²è¡Œèº«ä»½é©—è­‰ã€‚ä½¿ç”¨è€…å¯ä»¥å¾å…¶ GitHub Settings -\u0026gt; Developer Settings -\u0026gt; Personal access tokens (classic) ç”Ÿæˆå€‹äººè¨ªå•ä»¤ç‰Œã€‚ Authenticate using a GitHub token: $ vault login -method=github token=abcd1234 Configuration: mount=\u0026lt;string\u0026gt; Path where the GitHub credential method is mounted. This is usually provided via the -path flag in the \u0026#34;vault login\u0026#34; command, but it can be specified here as well. If specified here, it takes precedence over the value for -path. The default value is \u0026#34;github\u0026#34;. # GitHub æ†‘è­‰æ–¹æ³•æ›è¼‰çš„è·¯å¾‘ã€‚é€šå¸¸é€é \u0026#34;vault login\u0026#34; æŒ‡ä»¤çš„ -path flag æä¾›ï¼Œä½†é€™è£¡ä¹Ÿå¯ä»¥æŒ‡å®šã€‚å¦‚æœåœ¨é€™è£¡æŒ‡å®šï¼Œå‰‡å„ªå…ˆæ–¼ -path çš„å€¼ã€‚é è¨­çš„è·¯å¾‘å€¼ç‚º \u0026#34;github\u0026#34;ã€‚ token=\u0026lt;string\u0026gt; GitHub personal access token to use for authentication. If not provided, Vault will prompt for the value. # ç”¨æ–¼èº«ä»½é©—è­‰çš„ GitHub personal access tokenã€‚å¦‚æœæœªæä¾›ï¼ŒVault å°‡æç¤ºè¼¸å…¥æ­¤å€¼ã€‚ è¼¸å‡ºé¡¯ç¤ºäº†ä½¿ç”¨ GitHub æ–¹æ³•é€²è¡Œ login çš„ä¾‹å­ã€‚è©²æ–¹æ³•è¦æ±‚å¿…é ˆå®šç¾©è©²æ–¹æ³•ï¼Œä¸¦ç”±ä½¿ç”¨è€…æä¾› GitHub personal access tokenã€‚\nç”±æ–¼ä½ å°‡å˜—è©¦ä½¿ç”¨èº«ä»½é©—è­‰æ–¹æ³•é€²è¡Œç™»éŒ„ï¼Œè«‹ç¢ºä¿åœ¨æ­¤ shell session ä¸­æœªè¨­ç½® VAULT_TOKEN ç’°å¢ƒè®Šæ•¸ï¼Œå› ç‚ºå…¶å€¼å°‡å„ªå…ˆæ–¼ä½ å¾ Vault ç²å–çš„ä»»ä½• tokenã€‚\nå–æ¶ˆè¨­å®šè©²ç’°å¢ƒè®Šæ•¸ã€‚\nunset VAULT_TOKEN å˜—è©¦ä½¿ç”¨ github auth methods ç™»å…¥\nvault login -method=github outputï¼Œä½¿ç”¨è€…ä½¿ç”¨ github personal access tokenï¼Œå–å¾—æœ‰æ•ˆçš„ vault token\ntoken æ ¼å¼ä¸åŒ token çš„æ•ˆæœŸç‚º 768hï¼ŒçŸ­æ•ˆæœŸ token çš„æ›éšªç¨‹åº¦è¼ƒä½ é€™å€‹ token çš„ policy æ¬Šé™åªæœ‰ default policy metadata æ˜¯ github å›å‚³çš„ï¼Œvault ä¸­ä¸¦æ²’æœ‰å»ºç«‹ username=chechiachang çš„è³‡æ–™ org æ˜¯ chechia-net username æ˜¯ chechiachang GitHub Personal Access Token (will be hidden): Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026#34;vault login\u0026#34; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.CAESI...ncU0 token_accessor lKVpMawotXg1fXcgRvpAOAwQ token_duration 768h token_renewable true token_policies [\u0026#34;default\u0026#34;] identity_policies [] policies [\u0026#34;default\u0026#34;] token_meta_org chechia-net token_meta_username chechiachang ç•¶æœªæä¾› GitHub personal access token çµ¦å‘½ä»¤æ™‚ï¼ŒVault CLI æœƒæç¤ºä½¿ç”¨è€…è¼¸å…¥ã€‚\nå¦‚æœæä¾›äº†æœ‰æ•ˆçš„ GitHub personal access tokenï¼Œå‰‡ä½¿ç”¨è€…å°‡æˆåŠŸç™»éŒ„ vaultï¼Œä¸¦ä¸”è¼¸å‡ºæœƒé¡¯ç¤ºä¸€å€‹ Vault tokenã€‚ä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨é€™å€‹ Vault tokenï¼Œç›´åˆ°è©² token è¢«æ’¤éŠ·æˆ–å…¶æœ‰æ•ˆæœŸè¶…éäº† token_durationã€‚\nä½ å¯ä»¥ä½¿ç”¨ vault token lookup ä¾†æª¢è¦–ç•¶å‰çš„ token\nvault token lookup outputï¼Œé¡¯ç¤ºä½¿ç”¨ä¸­çš„ tokenï¼Œä½¿ç”¨çš„ path èˆ‡ methods æ˜¯ github/ï¼Œæ•ˆæœŸ ttl åœ¨å€’æ•¸ä¸­é€æ¼¸æ¸›å°‘ 767h54m27s\nKey Value --- ----- accessor lKVpMawotXg1fXcgRvpAOAwQ creation_time 1694873434 creation_ttl 768h display_name github-chechiachang entity_id 5d8af1ab-53a2-e1c5-61bf-bb0b6c7d190f expire_time â€¦","date":1694630546,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695049680,"objectID":"fd8b4581fef04cb3cd24151b55ee5223","permalink":"https://chechia.net/zh-hant/post/2023-09-17-vault-workshop-authentication-github/","publishdate":"2023-09-14T02:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-17-vault-workshop-authentication-github/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 06ï¼šGithub auth method ä¸éœ€è¦ä½¿ç”¨ root token çš„ auth method: github Vault æ”¯æ´ç”¨æ–¼äººå“¡ä½¿ç”¨è€…çš„èº«ä»½é©—è­‰æ–¹æ³•ã€‚GitHub èº«ä»½é©—è­‰ï¼Œä½¿ç”¨æˆ¶å¯ä»¥é€šéæä¾›ä»–å€‘çš„ GitHub æ†‘è­‰ä¾†é©—è­‰ Vaultï¼Œä¸¦æ”¶åˆ°ä¸€å€‹ Vault tokenã€‚\nç°¡å–®ä¾†èªªï¼Œgithub organization chechia-netï¼Œå¯ä»¥è¨­å®šé©ç•¶çš„æ¬Šé™çµ¦æˆå“¡ chechiachangï¼Œè®“ chechiachang å¯ä»¥é€é github å–å¾—æœ‰æ¬Šé™çš„ tokenã€‚","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 06: Github Auth method","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 05ï¼šAuthentication åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œä½ å·²ç¶“å‰µå»ºäº†ç¬¬ä¸€å€‹ç§˜å¯†ï¼Œäº†è§£äº†ç§˜å¯†å¼•æ“ï¼Œä¸¦åœ¨ä»¥é–‹ç™¼æ¨¡å¼å•Ÿå‹•çš„ Vault æœå‹™å™¨ä¸­æ¢ç´¢äº†å‹•æ…‹ç§˜å¯†ã€‚\næ¥ä¸‹ä¾†çš„å…§å®¹ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥ç ”ç©¶ä½¿ç”¨ Vault token å’Œ GitHub æ†‘è­‰é€²è¡Œèº«ä»½é©—è­‰ã€‚\nToken èº«ä»½é©—è­‰ Token èº«ä»½é©—è­‰å·²è‡ªå‹•å•Ÿç”¨ã€‚ç•¶ä½ å•Ÿå‹•é–‹ç™¼æ¨¡å¼æœå‹™å™¨æ™‚ï¼Œè¼¸å‡ºé¡¯ç¤ºäº† Root tokenã€‚Vault CLI å¾ $VAULT_TOKEN ç’°å¢ƒè®Šæ•¸ä¸­è®€å– Root tokenã€‚é€™å€‹æ ¹ token å¯ä»¥åœ¨ Vault å…§åŸ·è¡Œä»»ä½•æ“ä½œï¼Œå› ç‚ºå®ƒè¢«åˆ†é…äº† Root policy æ¬Šé™ã€‚å…è¨±çš„æ¬Šé™ä¸­åŒ…å«å‰µå»ºæ–°çš„ tokenã€‚\nç¾åœ¨ï¼Œè®“æˆ‘å€‘å‰µå»ºä¸€å€‹æ–°çš„ tokenã€‚\nå•Ÿå‹•å…¨æ–°çš„ dev Vault Server\nvault server -dev outputï¼Œserver log å›å‚³ dev æ¨¡å¼çš„è­¦å‘Š\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory and starts unsealed with a single unseal key. The root token is already authenticated to the CLI, so you can immediately begin using Vault. # è­¦å‘Šï¼å·²å•Ÿç”¨é–‹ç™¼æ¨¡å¼ï¼åœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒVaultå®Œå…¨é‹è¡Œåœ¨å…§å­˜ä¸­ï¼Œä½¿ç”¨å–®å€‹unseal keyè§£å°ã€‚ # root tokenå·²è¢«CLIé©—è­‰ï¼Œå› æ­¤ä½ å¯ä»¥ç«‹å³é–‹å§‹ä½¿ç”¨Vaultã€‚ You may need to set the following environment variables: $ export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; # ä»¥ä¸‹é¡¯ç¤ºäº†unseal key å’Œ root tokenï¼Œä»¥é˜²ä½ æƒ³è¦å°å­˜/è§£å°Vaultï¼Œæˆ–é‡æ–°é€²è¡Œèº«ä»½é©—è­‰ã€‚ The unseal key and root token are displayed below in case you want to seal/unseal the Vault or re-authenticate. # dev æ¨¡å¼é è¨­é…ç½®çš„ unseal key èˆ‡ root token Unseal Key: QDUAuY7Kltsc/3bVwUYF39u8aEFgWNRs/1D5yxFtim4= Root Token: hvs.J30e...0DJaN # é–‹ç™¼æ¨¡å¼çµ•ä¸æ‡‰åœ¨ç”Ÿç”¢å®‰è£ä¸­ä½¿ç”¨ï¼ Development mode should NOT be used in production installations! ä¾æ“šæç¤º export éœ€è¦çš„è®Šæ•¸\nexport VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; åœ¨ dev mode ä¸‹ï¼Œæœªä½¿ç”¨ token ä¹Ÿå¯ä»¥å­˜å– Vault Server ä¸­çš„è³‡æ–™ï¼Œé€™æ˜¯å› ç‚º vault server åœ¨å•Ÿç”¨æ™‚ï¼Œé è¨­ä½¿ç”¨ token helperï¼Œå°‡ root token å¯«å…¥åˆ° local filesystem\nVault token helper èªªæ˜\nä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼Œæª¢æŸ¥å„²å­˜æ–¼æœ¬åœ°çš„ vault token\ncat ~/.vault-token output\nhvs.J30e...0DJaN% vault CLI è‡ªå‹•å–ç”¨æœ¬åœ°å„²å­˜çš„ root tokenï¼Œæ‰€ä»¥å·²ç¶“è‡ªå‹•å®Œæˆ authenticationï¼Œä¸ç”¨é¡å¤–é€²è¡Œ authenticationï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Vault\nä½¿ç”¨ Vault æ™‚ï¼Œé ˆé¡å¤–æ³¨æ„æœ¬åœ°å„²å­˜çš„ token\né¿å… dev æ¨¡å¼ä¸‹å„²å­˜ root token Vault dev server è‡ªå‹•å¯«å…¥ root tokenï¼Œè®“é–‹ç™¼ Vault åŠŸèƒ½æ™‚ååˆ†ä¾¿åˆ©ã€‚ç„¶è€Œåœ¨è³‡è¨Šå®‰å…¨çš„é ˜åŸŸï¼Œä¾¿åˆ©å¾€å¾€ä»£è¡¨è‘—é¢¨éšªã€‚åœ¨é dev Server ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘æœƒåš´æ ¼æ§åˆ¶æ‰€æœ‰ token çš„æ›éšªç¨‹åº¦ï¼Œç‰¹åˆ¥æ˜¯ root tokenï¼Œæ ¹æœ¬ä¸è©²è¢« print å‡ºï¼Œç•¶ç„¶ä¹Ÿè¬è¬ä¸èƒ½å„²å­˜åœ¨æœ¬åœ°é›»è…¦ã€‚\nä¾æ“šä½ çš„é–‹ç™¼éœ€æ±‚ï¼Œä½ å¯èƒ½ä¸å¸Œæœ› dev æ¨¡å¼ä¸‹ï¼Œlong-live æ°¸ä¹…æœ‰æ•ˆçš„ root token å„²å­˜åœ¨æœ¬åœ°é›»è…¦ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ -dev-no-store-token flag ä¾†é¿å… Vault dev server æš´éœ² root tokenã€‚\nvault server -dev -dev-no-store-token output\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory and starts unsealed with a single unseal key. The root token is already authenticated to the CLI, so you can immediately begin using Vault. You may need to set the following environment variables: $ export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; The unseal key and root token are displayed below in case you want to seal/unseal the Vault or re-authenticate. Unseal Key: hNi8T3YctTZrLYlKezLAJttfiF97D1Vy7Tq+HMM3y9w= Root Token: hvs.qCqY...p89KYv Development mode should NOT be used in production installations! ä½ å¯ä»¥æª¢æŸ¥æœ¬åœ°ä½¿å¦æœ‰å„²å­˜çš„çš„ vault token\ncat ~/.vault-token output\ncat: /Users/che-chia/.vault-token: No such file or directory ç„¶å¾Œè©¦åœ–åœ¨æ²’æœ‰ .vault-token çš„ç‹€æ…‹ä¸‹ï¼Œå­˜å– Vault Server\nvault secrets list outputï¼Œæ²’æœ‰åˆæ³•çš„ access tokenï¼ŒVault server å›å‚³ 403 æ¬Šé™è¢«æ‹’\nvault secrets list Error listing secrets engines: Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/mounts Code: 403. Errors: * permission denied Authentication ä½ å¯ä»¥ä½¿ç”¨ vault dev Server log ä¸­å›å‚³çš„ root token ä¾†å­˜å– Vault server\nä½ å¯ä»¥å°‡ token åœ¨å¯«å› .vault-tokenï¼Œé€™æ˜¯æœ€æ–¹ä¾¿ï¼Œä¹Ÿæœ€å±éšª\nå»ºè­°ï¼šæ°¸é ä¸è¦å„²å­˜ root token åœ¨æœ¬åœ°é›»è…¦ä¸Šã€‚éå¸¸å®¹æ˜“éºå¿˜è‡ªå·±æœ¬åœ°æœ‰å„²å­˜ root tokenã€‚\necho hvs.qCqY...p89KYv \u0026gt; ~/.vault-token å¦ä¸€å€‹æ–¹å¼æ˜¯ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ VAULT_TOKEN\nVAULT_TOKEN=hvs.qCqY...p89KYv vault secrets list ä¸Šé¢æ˜¯åœ¨ CLI å‰é¢æ’å…¥ç’°å¢ƒè®Šæ•¸ï¼Œä¸‹é¢æ˜¯ export VAULT_TOKEN åˆ°ç•¶å‰ session çš„ç’°å¢ƒè®Šæ•¸\nexport VAULT_TOKEN=hvs.qCqY...p89KYv vault secrets list output\nPath Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_9cc57bcf per-token private secret storage identity/ identity identity_41faabef identity store secret/ kv kv_fca914b5 key/value secret storage sys/ system system_5dd83198 system endpoints used for control, policy and debugging ä½ å¯ä»¥æª¢æŸ¥ç›®å‰ç’°å¢ƒè®Šæ•¸ä¸­ï¼Œèˆ‡ Vault æœ‰é—œçš„ env\nenv | grep VAULT output\nVAULT_ADDR=http://127.0.0.1:8200 VAULT_TOKEN=hvs.qCqY...p89KYv ç•¶ç„¶ï¼ŒVAULT_TOKEN çš„å­˜åœ¨æ™‚é–“è¶Šä¹…ï¼Œtoken æ›éšªçš„æ©Ÿç‡å°±è¶Šé«˜ã€‚\nä¹Ÿå¾ˆå®¹æ˜“å¿˜è¨˜ VAULT_TOKEN æœ‰å­˜åœ¨çš„ç’°å¢ƒè®Šæ•¸ã€‚\nVAULT TOKEN é›·é» workshop è‡³ä»Šï¼Œä½ ç›®å‰åªæœ‰ä¸€å° vault dev serverï¼Œè€Œä¸”è£¡é¢ä¸¦æ²’æœ‰ä»»ä½•çš„æ©Ÿå¯†è³‡æ–™ï¼Œé€™å€‹ vault server å¯ä»¥éš¨æ™‚æ‹‹æ£„ã€‚\nç„¶è€Œï¼Œåœ¨å¯¦å‹™ä¸Šï¼ŒVault ç®¡ç†å“¡æ‰‹ä¸Šå¯èƒ½æœƒæœ‰å¤šå€‹ Vault server éœ€è¦ç®¡ç†ã€‚\næƒ³åƒä½ æœ‰ dev / stag / prod çš„ serverï¼ŒæŸä¸€å¤©ä½ æ­£åœ¨ dev é–‹ç™¼ä¸€å€‹æ–°åŠŸèƒ½ï¼Œç”±æ–¼æœ¬åœ°æœ‰ VAULT_TOKEN èˆ‡ VAULT_ADDRï¼Œä½ ä¸ç–‘æœ‰ä»–çš„åœ¨é€™å° server ä¸Šé‹è¡Œè¨±å¤šæ¸¬è©¦çš„æŒ‡ä»¤ï¼ŒåŒ…å«æ–°å¢ä¸€å°æ¸¬è©¦ secretï¼Œåˆªåˆªæ”¹æ”¹ç¾æœ‰çš„ secretã€‚\nç„¶å¾Œä½ çš„æœ¬èƒ½å¿½ç„¶è¦ºå¾—æ€ªæ€ªçš„ï¼Œæˆ‘æ²’æœ‰è¨­ç½®ä»»ä½• vault envï¼Œç‚ºä½•å¯ä»¥ç›´æ¥å­˜å– dev serverï¼Ÿ\nä½ æ‹‰å‡º env çœ‹ï¼Œç™¼ç¾æ˜¯ production server çš„ addr + tokenï¼Œä¸Šæ¬¡é€²å…¥ production server æ™‚çš„ sessionï¼Œé‚„å­˜æœ‰æœ‰æ•ˆçš„ addr èˆ‡ token\nVAULT_ADDR=http://vault.prod.chechia.net VAULT_TOKEN=this-is-prod-token ä½ éº»ç…©å¤§äº†\nå¿ƒå¾—ï¼šæ°¸é ä¸è¦å„²å­˜é•·æ•ˆæœŸçš„ token åœ¨æœ¬åœ°ã€‚æœ¬ workshop æœƒä¸æ–·åœ°å¼·èª¿ï¼Œæé†’å„ç¨®æ“ä½œä¸­çš„è³‡å®‰é¢¨éšªï¼Œè«‹å„ä½å­¸ç¿’éç¨‹ä¸­å°±é¤Šæˆè‰¯å¥½ç¿’æ…£ï¼Œä»¥å…æ–¹ä¾¿ä¸€æ™‚ï¼Œéºæ†¾çµ‚èº«ã€‚\nroot token https://developer.hashicorp.com/vault/docs/concepts/tokens#root-tokens\nroot tokenæ˜¯é™„å¸¶root policyçš„tokenã€‚root tokenå¯ä»¥åœ¨Vaultä¸­åŸ·è¡Œä»»ä½•æ“ä½œã€‚ä»»ä½•æ“ä½œã€‚\næ­¤å¤–ï¼Œå®ƒå€‘æ˜¯Vaultä¸­å”¯ä¸€å¯ä»¥è¨­ç½®ç‚ºæ°¸ä¸éæœŸï¼Œä¸”ç„¡éœ€é€²è¡Œä»»ä½•çºŒè¨‚çš„ token é¡å‹ã€‚ç”±æ–¼ root token æ¬Šé™å¦‚æ­¤å¤§ï¼ŒVault è¨­è¨ˆä¸Šåˆ»æ„è®“å‰µå»ºroot token å¾ˆå›°é›£ï¼›å¯¦éš›ä¸Šåªæœ‰ä¸‰ç¨®æ–¹æ³•å¯ä»¥å‰µå»ºroot tokenï¼š\nåœ¨ vault operator init æ™‚ç”Ÿæˆçš„åˆå§‹root token - æ­¤tokenä¸æœƒéæœŸ\nä½¿ç”¨å¦ä¸€å€‹root token å‰µå»º root tokenã€‚é€™é»æœ‰å€‹é™åˆ¶ï¼šä½¿ç”¨æœ‰é™æœŸçš„root tokenï¼Œç„¡æ³•å‰µå»ºæ°¸ä¸éæœŸçš„root token\nåœ¨æ“æœ‰ unseal keys quorumçš„æ¬Šé™ä¸‹ï¼Œä½¿ç”¨ vault operator generate-root ä¾†å‰µå»ºroot token\nroot â€¦","date":1694626946,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695049680,"objectID":"b4a38f7af09257f7c24eff5155088a26","permalink":"https://chechia.net/zh-hant/post/2023-09-16-vault-workshop-authentication/","publishdate":"2023-09-14T01:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-16-vault-workshop-authentication/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 05ï¼šAuthentication åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œä½ å·²ç¶“å‰µå»ºäº†ç¬¬ä¸€å€‹ç§˜å¯†ï¼Œäº†è§£äº†ç§˜å¯†å¼•æ“ï¼Œä¸¦åœ¨ä»¥é–‹ç™¼æ¨¡å¼å•Ÿå‹•çš„ Vault æœå‹™å™¨ä¸­æ¢ç´¢äº†å‹•æ…‹ç§˜å¯†ã€‚\næ¥ä¸‹ä¾†çš„å…§å®¹ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥ç ”ç©¶ä½¿ç”¨ Vault token å’Œ GitHub æ†‘è­‰é€²è¡Œèº«ä»½é©—è­‰ã€‚\nToken èº«ä»½é©—è­‰ Token èº«ä»½é©—è­‰å·²è‡ªå‹•å•Ÿç”¨ã€‚ç•¶ä½ å•Ÿå‹•é–‹ç™¼æ¨¡å¼æœå‹™å™¨æ™‚ï¼Œè¼¸å‡ºé¡¯ç¤ºäº† Root tokenã€‚Vault CLI å¾ $VAULT_TOKEN ç’°å¢ƒè®Šæ•¸ä¸­è®€å– Root tokenã€‚é€™å€‹æ ¹ token å¯ä»¥åœ¨ Vault å…§åŸ·è¡Œä»»ä½•æ“ä½œï¼Œå› ç‚ºå®ƒè¢«åˆ†é…äº† Root policy æ¬Šé™ã€‚å…è¨±çš„æ¬Šé™ä¸­åŒ…å«å‰µå»ºæ–°çš„ tokenã€‚","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 05: Authentication","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 04ï¼šSecret Engine KV V2 KVç§˜å¯†å¼•æ“ï¼Œç”¨æ–¼åœ¨Vaultçš„å·²é…ç½®ç‰©ç†Storageä¸­ï¼Œå­˜å„²ä»»æ„ç§˜å¯†ã€‚\nkey åç¨±å¿…é ˆå§‹çµ‚æ˜¯å­—ç¬¦ä¸²ã€‚å¦‚æœä½ ç›´æ¥é€šéCLIç·¨å¯«éå­—ä¸² valueï¼Œå®ƒå€‘å°‡è¢«è½‰æ›ç‚ºå­—ä¸²ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥é€šéå¾JSONæ–‡ä»¶ä¸­å°‡key-value pairå¯«å…¥Vaultï¼Œæˆ–ä½¿ç”¨HTTP APIä¾†ä¿ç•™éå­—ä¸² valueã€‚\næ­¤ç§˜å¯†å¼•æ“éµç…§ACL policyä¸­ï¼Œå‰µå»º(create)å’Œæ›´æ–°(update)æ¬Šé™ä¹‹é–“çš„è¨­å®šã€‚å®ƒé‚„æ”¯æŒpatchåŠŸèƒ½ï¼Œç”¨æ–¼è¡¨ç¤ºéƒ¨åˆ†æ›´æ–°(patch)ï¼Œè€Œæ›´æ–°åŠŸèƒ½(update)å‰‡è¡¨ç¤ºå®Œå…¨è¦†è“‹ã€‚\nè¨­ç½® å¤§å¤šæ•¸ç§˜å¯†å¼•æ“å¿…é ˆåœ¨åŸ·è¡Œå…¶åŠŸèƒ½ä¹‹å‰äº‹å…ˆé…ç½®ã€‚é€™äº›æ­¥é©Ÿé€šå¸¸ç”±æ“ä½œäººå“¡æˆ–é…ç½®ç®¡ç†å·¥å…·å®Œæˆã€‚\nå•Ÿç”¨v2 kvç§˜å¯†å¼•æ“ï¼š\nå•Ÿå‹•ä¸€å€‹ä¹¾æ·¨çš„æœ¬åœ°çš„é–‹ç™¼æ¨¡å¼ Vault Serverï¼Œå…¨æ–°çš„ Vault Server åŒ…å«åº•ä¸‹é è¨­å•Ÿç”¨çš„å¼•æ“\nvault server -dev export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging ä½ å¯ä»¥åœ¨æŒ‡å®šçš„è·¯å¾‘ä¸‹ï¼Œå•Ÿç”¨ä¸€å€‹æ–°çš„ v2 kv ç§˜å¯†å¼•æ“ã€‚è‹¥ä¸æŒ‡å®š -path åƒæ•¸ï¼Œå‰‡é è¨­ path ç‚º typeï¼Œä¹Ÿå°±æ˜¯ path=kvã€‚\nvault secrets enable -version=2 -path=kv kv Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store kv/ kv kv_904eee17 n/a secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging æˆ–è€…ï¼Œä½ å¯ä»¥å°‡kv-v2ä½œç‚ºç§˜å¯†å¼•æ“é¡å‹ï¼Œä»¥åƒæ•¸å‚³éï¼š\nvault secrets enable kv-v2 ä¸Šé¢çš„æŒ‡ä»¤èˆ‡ä¸‹é¢çš„æŒ‡ä»¤ç­‰æ•ˆï¼Œé‡è¤‡åŸ·è¡Œæœƒå‡ºç¾è·¯å¾‘é‡è¤‡éŒ¯èª¤\nvault secrets enable -path kv-v2 -version=2 kv-v2 Error enabling: Error making API request. URL: POST http://127.0.0.1:8200/v1/sys/mounts/kv-v2 Code: 400. Errors: * path is already in use at kv-v2/ ä½ å¯ä»¥åœç”¨ä¸€å€‹ç§˜å¯†å¼•æ“\nvault secrets disable kv-v2 ç‚ºäº†å­¸ç¿’æ•ˆæœï¼Œå¾€å¾Œèª²ç¨‹éƒ½æœƒä½¿ç”¨æ›´å®Œæ•´çš„æŒ‡ä»¤ï¼Œä½œç‚ºç¤ºç¯„ã€‚\næ›´å¤šå•Ÿç”¨ç§˜å¯†å¼•æ“çš„æŒ‡ä»¤ï¼Œä½ å¯ä»¥åƒè€ƒ vault secrets enable â€“help çš„å”åŠ©æŒ‡ä»¤\nvault secrets enable --help Usage: vault secrets enable [options] TYPE Enables a secrets engine. By default, secrets engines are enabled at the path corresponding to their TYPE, but users can customize the path using the -path option. å•Ÿç”¨ç§˜å¯†å¼•æ“ã€‚é è¨­æƒ…æ³ä¸‹ï¼Œç§˜å¯†å¼•æ“æœƒåœ¨èˆ‡å…¶é¡å‹ç›¸å°æ‡‰çš„è·¯å¾‘å•Ÿç”¨ï¼Œä½†ä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨ -path é¸é …è‡ªè¨‚è·¯å¾‘ã€‚ Once enabled, Vault will route all requests which begin with the path to the secrets engine. ä¸€æ—¦å•Ÿç”¨ï¼ŒVault å°‡å°‡æ‰€æœ‰ä»¥è©²è·¯å¾‘é–‹é ­çš„è«‹æ±‚è·¯ç”±åˆ°ç§˜å¯†å¼•æ“ã€‚ Enable the AWS secrets engine at aws/: $ vault secrets enable aws Enable the SSH secrets engine at ssh-prod/: $ vault secrets enable -path=ssh-prod ssh Enable the database secrets engine with an explicit maximum TTL of 30m: $ vault secrets enable -max-lease-ttl=30m database Enable a custom plugin (after it is registered in the plugin registry): $ vault secrets enable -path=my-secrets -plugin-name=my-plugin plugin OR (preferred way): $ vault secrets enable -path=my-secrets my-plugin å¾ä¸Šé¢çš„å…§å®¹ï¼Œå¯ä»¥çœ‹åˆ°ç§˜å¯†å¼•æ“æ”¯æ´å„ç¨®ä¸åŒçš„ç§˜å¯†é¡å‹ï¼Œä¾‹å¦‚ä»¥ä¸‹éƒ½æ˜¯ä¸€å€‹ç§˜å¯†å¼•æ“é¡å‹ï¼šawsï¼Œsshï¼Œdatabaseï¼Œpluginã€‚\næ³¨æ„ï¼Œè«‹ä¸è¦å¼„æ·· path=aws çš„ç§˜å¯†å¼•æ“ï¼Œä»¥åŠ type=aws çš„ç§˜å¯†å¼•æ“ã€‚åº•ä¸‹æ˜¯ä¸€å€‹ååˆ†æ··æ·†çš„ä¾‹å­ï¼š\nvault secrets enable --version=2 --path=kv-v1 kv vault secrets enable --version=1 --path=kv-v2 kv vault secrets list --detailed Path Plugin Accessor Default TTL Max TTL Force No Cache Replication Seal Wrap External Entropy Access Options Description UUID Version Running Version Running SHA256 Deprecation Status ---- ------ -------- ----------- ------- -------------- ----------- --------- ----------------------- ------- ----------- ---- ------- --------------- -------------- ------------------ cubbyhole/ cubbyhole cubbyhole_57a4ca51 n/a n/a false local false false map[] per-token private secret storage cee0001e-95f8-efaa-6a9a-a3d5c3573abc n/a v1.14.3+builtin.vault n/a n/a identity/ identity identity_c2ecbd49 system system false replicated false false map[] identity store 3b481e0d-1c6d-6698-85c3-c52839b4d6e4 n/a v1.14.3+builtin.vault n/a n/a kv-v1/ kv kv_c8de7a39 system system false replicated false false map[version:2] n/a 98289587-5b5d-06f3-c3cf-469e830eda9e n/a v0.15.0+builtin n/a supported kv-v2/ kv kv_f83d9acd system system false replicated false false map[version:1] n/a 5fc è«‹ä¸è¦åšé€™ç¨®ä¸è‰¯çš„å‘½åï¼Œèª¤å°è‡ªå·±ä¹Ÿèª¤å°åˆ¥äººã€‚ä¸å»ºè­°æŠŠ engine type ç•¶ä½œ pathï¼Œå¯¦å‹™ä¸Šä¹Ÿæ²’æœ‰å¿…è¦é€™å€‹åšã€‚\nvault secrets disable kv-v1 vault secrets disable kv-v2 ä½¿ç”¨å…¬å¸çµ„ç¹”ï¼Œåœ˜éšŠï¼Œå°ˆæ¡ˆåç¨±ï¼Œä½œç‚º engine path çš„å‘½åï¼Œæ˜¯å€‹ä¸éŒ¯çš„èµ·é»ã€‚\norg = chechia.net team = sre project = workshop vault secrets enable --version=2 --path=chechia-net/sre/workshop kv ä½¿ç”¨ v2 kv åœ¨ç§˜å¯†å¼•æ“é…ç½®å®Œæˆï¼Œä¸”ç”¨æˆ¶/æ©Ÿå™¨å…·å‚™å…·æœ‰é©ç•¶æ¬Šé™çš„Vault tokenå¾Œï¼Œå®ƒå¯ä»¥ç”Ÿæˆæ†‘è­‰ã€‚KVç§˜å¯†å¼•æ“å…è¨±å°‡ä»»æ„vvalueå¯«å…¥æŒ‡å®šçš„keyã€‚\nåœ¨KV-v2ä¸­ä»ç„¶å¯ä»¥ä½¿ç”¨é¡ä¼¼è·¯å¾‘çš„KV-v1èªæ³•ä¾†å¼•ç”¨ç§˜å¯†ï¼ˆsecret/fooï¼‰ï¼Œä½†æˆ‘å€‘å»ºè­°ä½¿ç”¨-flagçš„èªæ³•ä»¥é¿å…å°‡å…¶éŒ¯èª¤èªç‚ºæ˜¯ç§˜å¯†çš„å¯¦éš›è·¯å¾‘ï¼ˆsecret/data/fooæ˜¯çœŸæ­£çš„è·¯å¾‘ï¼‰ã€‚\nå¯«å…¥/è®€å–ä»»æ„è³‡æ–™ å¯«å…¥ä»»æ„è³‡æ–™ï¼š\nvault kv put -mount=chechia-net/sre/workshop my-secret foo=a bar=b ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 1 è®€å–ä»»æ„è³‡æ–™ï¼š\nvault kv get -mount=chechia-net/sre/workshop my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 1 === Data === Key Value â€¦","date":1694623346,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695049428,"objectID":"dc2687c559eb0003de9fff7dd72f0685","permalink":"https://chechia.net/zh-hant/post/2023-09-15-vault-workshop-secret-engine-kv-v2/","publishdate":"2023-09-14T00:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-15-vault-workshop-secret-engine-kv-v2/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 04ï¼šSecret Engine KV V2 KVç§˜å¯†å¼•æ“ï¼Œç”¨æ–¼åœ¨Vaultçš„å·²é…ç½®ç‰©ç†Storageä¸­ï¼Œå­˜å„²ä»»æ„ç§˜å¯†ã€‚\nkey åç¨±å¿…é ˆå§‹çµ‚æ˜¯å­—ç¬¦ä¸²ã€‚å¦‚æœä½ ç›´æ¥é€šéCLIç·¨å¯«éå­—ä¸² valueï¼Œå®ƒå€‘å°‡è¢«è½‰æ›ç‚ºå­—ä¸²ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥é€šéå¾JSONæ–‡ä»¶ä¸­å°‡key-value pairå¯«å…¥Vaultï¼Œæˆ–ä½¿ç”¨HTTP APIä¾†ä¿ç•™éå­—ä¸² valueã€‚\næ­¤ç§˜å¯†å¼•æ“éµç…§ACL policyä¸­ï¼Œå‰µå»º(create)å’Œæ›´æ–°(update)æ¬Šé™ä¹‹é–“çš„è¨­å®šã€‚å®ƒé‚„æ”¯æŒpatchåŠŸèƒ½ï¼Œç”¨æ–¼è¡¨ç¤ºéƒ¨åˆ†æ›´æ–°(patch)ï¼Œè€Œæ›´æ–°åŠŸèƒ½(update)å‰‡è¡¨ç¤ºå®Œå…¨è¦†è“‹ã€‚\nè¨­ç½® å¤§å¤šæ•¸ç§˜å¯†å¼•æ“å¿…é ˆåœ¨åŸ·è¡Œå…¶åŠŸèƒ½ä¹‹å‰äº‹å…ˆé…ç½®ã€‚é€™äº›æ­¥é©Ÿé€šå¸¸ç”±æ“ä½œäººå“¡æˆ–é…ç½®ç®¡ç†å·¥å…·å®Œæˆã€‚\nå•Ÿç”¨v2 kvç§˜å¯†å¼•æ“ï¼š\nå•Ÿå‹•ä¸€å€‹ä¹¾æ·¨çš„æœ¬åœ°çš„é–‹ç™¼æ¨¡å¼ Vault Serverï¼Œå…¨æ–°çš„ Vault Server åŒ…å«åº•ä¸‹é è¨­å•Ÿç”¨çš„å¼•æ“","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 04: Secret Engine KV V2","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 03ï¼šç´°æ¢ Secret Engine ç§˜å¯†å¼•æ“ ä»€éº¼æ˜¯ç§˜å¯†å¼•æ“ï¼Ÿ ç§˜å¯†å¼•æ“æ˜¯Vaultçš„çµ„ä»¶ï¼Œç”¨æ–¼å­˜å„²ã€ç”Ÿæˆæˆ–åŠ å¯†ç§˜å¯†ã€‚åœ¨å‰é¢çš„å…§å®¹ä¸­ï¼Œä½ ä½¿ç”¨äº†Key/Value v2 ç§˜å¯†å¼•æ“ä¾†å­˜å„²æ•¸æ“šã€‚ä¸€äº›ç§˜å¯†å¼•æ“ï¼Œæ¯”å¦‚éµ/å€¼ç§˜å¯†å¼•æ“ï¼Œåƒ…åƒ…æ˜¯ç”¨ä¾†å­˜å„²å’Œè®€å–æ•¸æ“šçš„ã€‚å…¶ä»–ç§˜å¯†å¼•æ“å‰‡é€£æ¥åˆ°å…¶ä»–æœå‹™ä¸¦æ ¹æ“šéœ€æ±‚ç”Ÿæˆå‹•æ…‹æ†‘è­‰ã€‚é‚„æœ‰ä¸€äº›ç§˜å¯†å¼•æ“æä¾›åŠ å¯†ä½œç‚ºæœå‹™ã€‚\nå‰é¢çš„å…§å®¹ä¸­ï¼Œé»˜èªæƒ…æ³ä¸‹ï¼Œkey/value v2 ç§˜å¯†å¼•æ“å·²å•Ÿç”¨ï¼Œä¸¦æº–å‚™åœ¨ secret/ ä¸‹æ¥æ”¶è«‹æ±‚ï¼Œå› ç‚ºæˆ‘å€‘åœ¨-dev æ¨¡å¼ä¸‹å•Ÿå‹•äº†Vault Serverã€‚\nåœ¨åº•ä¸‹æˆ‘å€‘ä½¿ç”¨ kv v1 åšç°¡å–®çš„ç¯„ä¾‹ã€‚\nmount path å»ºè­°åœ¨ä½¿ç”¨ KV v2 ç§˜å¯†å¼•æ“æ™‚ï¼Œä½¿ç”¨å¯é¸çš„ -mount flag èªæ³•ï¼Œä¾‹å¦‚\nvault kv get -mount=secret foo è«‹å˜—è©¦ä»¥ä¸‹å‘½ä»¤ï¼Œé€™å°‡å°è‡´éŒ¯èª¤ï¼š\nvault kv put foo/bar a=b Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/foo/bar Code: 403. Errors: * preflight capability check returned 403, please ensure client\u0026#39;s policies grant access to path \u0026#34;foo/bar/\u0026#34; Path prefix è·¯å¾‘å‰ç¶´å‘Šè¨´ Vault æ‡‰è©²å°‡æµé‡ route åˆ°å“ªå€‹ç§˜å¯†å¼•æ“\nç•¶è«‹æ±‚åˆ°é” Vault æ™‚ï¼Œå®ƒæœƒä½¿ç”¨æœ€é•·å‰ç¶´åŒ¹é…ä¾†åŒ¹é…åˆå§‹è·¯å¾‘éƒ¨åˆ†ï¼Œç„¶å¾Œå°‡è«‹æ±‚å‚³éçµ¦åœ¨è©²è·¯å¾‘å•Ÿç”¨çš„ç›¸æ‡‰ç§˜å¯†å¼•æ“ã€‚\nå¦‚æœ mount è¨­ç½®ç‚º foo/bar å‰‡æœƒåœ¨ foo/bar é€™å€‹ path ä¸‹çš„ secret engineï¼Œå„²å­˜ a=b å¦‚æœ mount è¨­ç½®ç‚º foo å‰‡æœƒåœ¨ foo é€™å€‹ path ä¸‹çš„ secret engineï¼Œå„²å­˜åœ¨ path /barï¼Œa=b Vault å°‡é€™äº›ç§˜å¯†å¼•æ“å‘ˆç¾å¾—é¡ä¼¼æ–¼æ–‡ä»¶ç³»çµ± (ex. )/usr/local/bin/vault)\nåœ¨ linux ä¸Šå­˜å–ä¸€å€‹ mount path ä¸å­˜åœ¨çš„ directory path åœ¨ vault ä¸­å­˜å– foo è™•æœªæ›è¼‰ç§˜å¯†å¼•æ“ï¼Œæ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤è¿”å›äº†éŒ¯èª¤ã€‚ å°æ–¼ vault kv å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ -mount flag\nå•Ÿç”¨ä¸€å€‹ç§˜å¯†å¼•æ“ è¦é–‹å§‹ï¼Œè«‹åœ¨è·¯å¾‘ kv å•Ÿç”¨ä¸€å€‹æ–°çš„ KV ç§˜å¯†å¼•æ“ã€‚æ¯å€‹è·¯å¾‘éƒ½æ˜¯å®Œå…¨éš”é›¢çš„ï¼Œç„¡æ³•èˆ‡å…¶ä»–è·¯å¾‘é€šä¿¡ã€‚ä¾‹å¦‚ï¼Œ\nå•Ÿç”¨åœ¨ foo çš„ KV ç§˜å¯†å¼•æ“ç„¡æ³•èˆ‡å•Ÿç”¨åœ¨ bar çš„ KVç§˜å¯†å¼•æ“é€šä¿¡ã€‚\n/foo a=b /bar c=d å•Ÿç”¨æ–°çš„ç§˜å¯†å¼•æ“ä»¥å‰ï¼Œå…ˆæŸ¥çœ‹ä¸€ä¸‹ç›®å‰ vault server ä¸­å·²ç¶“å•Ÿç”¨çš„å¼•æ“ã€‚\né™¤äº† default å­˜åœ¨çš„å¼•æ“ï¼Œé‚„æœ‰åœ¨ dev æ¨¡å¼ä¸‹è‡ªå‹•å»ºç«‹çš„ secret/\ndefault\ncubbyhole/ identity/ sys/ dev mode\nsecret/ vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_9c6d82c2 per-token private secret storage identity/ identity identity_8feb8f49 identity store secret/ kv kv_6f946f62 key/value secret storage sys/ system system_b45bc416 system endpoints used for control, policy and debugging ç„¶å¾Œåœ¨ path=kv ä¸‹ï¼Œå•Ÿç”¨ä¸€å€‹ secret engine\nvault secrets enable -path=kv kv Success! Enabled the kv secrets engine at: kv/ ç§˜å¯†å¼•æ“å•Ÿç”¨çš„è·¯å¾‘é»˜èªç‚ºç§˜å¯†å¼•æ“çš„åç¨±ã€‚å› æ­¤ï¼Œä»¥ä¸‹å‘½ä»¤ç­‰æ•ˆæ–¼åŸ·è¡Œä¸Šé¢çš„å‘½ä»¤ã€‚\nvault secrets enable kv é‡è¤‡åŸ·è¡Œé€™å€‹å‘½ä»¤æœƒæ‹‹å‡ºâ€œè·¯å¾‘å·²åœ¨kv/ ä¸­ä½¿ç”¨â€éŒ¯èª¤ã€‚\nç‚ºäº†é©—è­‰æˆ‘å€‘çš„æˆåŠŸä¸¦ç²å–æœ‰é—œç§˜å¯†å¼•æ“çš„æ›´å¤šä¿¡æ¯ï¼Œä½¿ç”¨ä»¥ä¸‹çš„ vault secrets list å‘½ä»¤ï¼š\nvault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_9c6d82c2 per-token private secret storage identity/ identity identity_8feb8f49 identity store kv/ kv kv_2b6528af n/a secret/ kv kv_6f946f62 key/value secret storage sys/ system system_b45bc416 system endpoints used for control, policy and debugging é€™é¡¯ç¤ºäº†åœ¨é€™å€‹Vaultä¼ºæœå™¨ä¸Šå·²å•Ÿç”¨çš„5å€‹ç§˜å¯†å¼•æ“ã€‚\nä½ å¯ä»¥çœ‹åˆ°ç§˜å¯†å¼•æ“çš„é¡å‹ã€ç›¸æ‡‰çš„è·¯å¾‘ä»¥åŠå¯é¸çš„æè¿°ï¼ˆå¦‚æœæ²’æœ‰æä¾›æè¿°ï¼Œå‰‡ç‚ºâ€œn/aâ€ï¼‰ã€‚\nä½¿ç”¨å¸¶æœ‰ -detailed æ¨™èªŒé‹è¡Œä¸Šè¿°å‘½ä»¤å¯ä»¥é¡¯ç¤ºKVç§˜å¯†å¼•æ“çš„ç‰ˆæœ¬å’Œæ›´å¤šä¿¡æ¯ã€‚\nvault secrets list --detailed Path Plugin Accessor Default TTL Max TTL Force No Cache Replication Seal Wrap External Entropy Access Options Description UUID Version Running Version Running SHA256 Deprecation Status ---- ------ -------- ----------- ------- -------------- ----------- --------- ----------------------- ------- ----------- ---- ------- --------------- -------------- ------------------ cubbyhole/ cubbyhole cubbyhole_9c6d82c2 n/a n/a false local false false map[] per-token private secret storage 6087f484-a02c-f36c-0a1a-aa07840f988c n/a v1.14.3+builtin.vault n/a n/a identity/ identity identity_8feb8f49 system system false replicated false false map[] identity store c3a1e4ae-09c6-29b9-906a-8281b46690f3 n/a v1.14.3+builtin.vault n/a n/a kv/ kv kv_2b6528af system system false replicated false false map[] n/a 5ff9bc4c-6d2c-5fd7-cbe0-e9b7fbf03ee5 n/a v0.15.0+builtin n/a supported secret/ kv kv_6f946f62 system system false replicated false false map[version:2] key/value secret storage ed28307e-0472-c0a7-b7a9-65543a63e68c n/a v0.15.0+builtin n/a supported sys/ system system_b45bc416 n/a n/a false replicated true false map[] system endpoints used for control, policy and debugging 9712d56d-95e3-6c07-796f-d44565de5c07 n/a v1.14.3+builtin.vault n/a n/a sys/ è·¯å¾‘å°æ‡‰åˆ°ç³»çµ±å¾Œç«¯ã€‚é€™äº›è·¯å¾‘èˆ‡Vaultçš„æ ¸å¿ƒç³»çµ±äº¤äº’ï¼Œå°æ–¼åˆå­¸è€…ä¾†èªªä¸æ˜¯å¿…éœ€çš„ã€‚\nå»ºç«‹ Secret è¦å‰µå»ºç§é‘°ï¼Œä½¿ç”¨ kv put å‘½ä»¤ã€‚\nvault kv put kv/hello target=world Success! Data written to: kv/hello è¦è®€å–å­˜å„²åœ¨kv/helloè·¯å¾‘ä¸­çš„ç§é‘°ï¼Œä½¿ç”¨ kv get å‘½ä»¤ã€‚\nvault kv get kv/hello ===== Data ===== Key Value --- ----- target world å˜—è©¦å»ºç«‹ç¬¬äºŒå€‹ kv/my-secret\nvault kv put kv/my-secret value=\u0026#34;s3c(eT\u0026#34; Success! Data written to: kv/my-secret è®€å–ä½æ–¼ kv/my-secret çš„è³‡æ–™\nvault kv get kv/my-secret ==== Data ==== Key Value --- ----- value s3c(eT åˆªé™¤ä½æ–¼ kv/my-secret çš„è³‡æ–™\nvault kv delete kv/my-secret Success! Data deleted (if it existed) at: kv/my-secret åˆ—å‡ºä½æ–¼ kv/my-secret çš„è³‡æ–™\nvault kv list kv/ Keys ---- hello åœç”¨ç§˜å¯†å¼•æ“ ç•¶ä¸å†éœ€è¦ç§˜å¯†å¼•æ“æ™‚ï¼Œå¯ä»¥å°‡å…¶åœç”¨ã€‚\nç•¶åœç”¨ç§˜å¯†å¼•æ“æ™‚ï¼Œæ‰€æœ‰ç§é‘°éƒ½å°‡è¢«æ’¤éŠ·ï¼Œç›¸æ‡‰çš„Vaultæ•¸æ“šå’Œé…ç½®å°‡è¢«åˆªé™¤ã€‚\nvault secrets disable kv/ Success! Disabled the secrets engine (if it existed) at: kv/ è«‹æ³¨æ„ï¼Œæ­¤å‘½ä»¤å°‡è·¯å¾‘ä½œç‚ºåƒæ•¸ï¼Œè€Œä¸æ˜¯ç§˜å¯†å¼•æ“çš„é¡å‹ã€‚\nå°åŸå§‹è·¯å¾‘çš„ä»»ä½•æ•¸æ“šè·¯ç”±è«‹æ±‚éƒ½å°‡å°è‡´éŒ¯èª¤ï¼Œä½†ç¾åœ¨å¯ä»¥åœ¨è©²è·¯å¾‘å•Ÿç”¨å¦ä¸€å€‹ç§˜å¯†å¼•æ“ã€‚\nvault kv get kv/hello Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/kv/hello Code: 403. Errors: * preflight capability check returned 403, please ensure client\u0026#39;s policies grant access to path \u0026#34;kv/hello/\u0026#34; ç§˜å¯†å¼•æ“æ˜¯ä¸€å€‹æŠ½è±¡ Vaultçš„è¡Œç‚ºé¡ä¼¼æ–¼è™›æ“¬æ–‡ä»¶ç³»çµ±ã€‚è®€å–/å¯«å…¥/åˆªé™¤/åˆ—å‡ºæ“ä½œå°‡è½‰ç™¼åˆ°ç›¸æ‡‰çš„ç§˜å¯†å¼•æ“ï¼Œç§˜å¯†å¼•æ“æ±ºå®šå¦‚ä½•å°é€™äº›æ“ä½œåšå‡ºåæ‡‰ã€‚\né€™ç¨®æŠ½è±¡éå¸¸å¼·å¤§ã€‚å®ƒä½¿Vaultèƒ½å¤ ç›´æ¥èˆ‡ç‰©ç†ç³»çµ±ã€è³‡æ–™åº«ã€HSM ç­‰é€²è¡Œäº¤äº’ã€‚\nä½†é™¤äº†é€™äº›ç‰©ç†ç³»çµ±å¤–ï¼ŒVaulté‚„å¯ä»¥èˆ‡æ›´å¤šç¨ç‰¹çš„ç’°å¢ƒé€²è¡Œäº¤äº’ï¼Œæ¯”å¦‚AWS IAMã€å‹•æ…‹SQL â€¦","date":1694616146,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695049428,"objectID":"c63a0db7bb8cfcf7073b7e8d60e8c068","permalink":"https://chechia.net/zh-hant/post/2023-09-14-vault-workshop-secret-engine/","publishdate":"2023-09-13T22:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-14-vault-workshop-secret-engine/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 03ï¼šç´°æ¢ Secret Engine ç§˜å¯†å¼•æ“ ä»€éº¼æ˜¯ç§˜å¯†å¼•æ“ï¼Ÿ ç§˜å¯†å¼•æ“æ˜¯Vaultçš„çµ„ä»¶ï¼Œç”¨æ–¼å­˜å„²ã€ç”Ÿæˆæˆ–åŠ å¯†ç§˜å¯†ã€‚åœ¨å‰é¢çš„å…§å®¹ä¸­ï¼Œä½ ä½¿ç”¨äº†Key/Value v2 ç§˜å¯†å¼•æ“ä¾†å­˜å„²æ•¸æ“šã€‚ä¸€äº›ç§˜å¯†å¼•æ“ï¼Œæ¯”å¦‚éµ/å€¼ç§˜å¯†å¼•æ“ï¼Œåƒ…åƒ…æ˜¯ç”¨ä¾†å­˜å„²å’Œè®€å–æ•¸æ“šçš„ã€‚å…¶ä»–ç§˜å¯†å¼•æ“å‰‡é€£æ¥åˆ°å…¶ä»–æœå‹™ä¸¦æ ¹æ“šéœ€æ±‚ç”Ÿæˆå‹•æ…‹æ†‘è­‰ã€‚é‚„æœ‰ä¸€äº›ç§˜å¯†å¼•æ“æä¾›åŠ å¯†ä½œç‚ºæœå‹™ã€‚\nå‰é¢çš„å…§å®¹ä¸­ï¼Œé»˜èªæƒ…æ³ä¸‹ï¼Œkey/value v2 ç§˜å¯†å¼•æ“å·²å•Ÿç”¨ï¼Œä¸¦æº–å‚™åœ¨ secret/ ä¸‹æ¥æ”¶è«‹æ±‚ï¼Œå› ç‚ºæˆ‘å€‘åœ¨-dev æ¨¡å¼ä¸‹å•Ÿå‹•äº†Vault Serverã€‚\nåœ¨åº•ä¸‹æˆ‘å€‘ä½¿ç”¨ kv v1 åšç°¡å–®çš„ç¯„ä¾‹ã€‚","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 03: Secret Engine","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDay 02 æº–å‚™ï¼šåŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„ Vault æ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\næº–å‚™å·¥ä½œ åœ¨é–‹å§‹é€²è¡Œ Vault 30 å¤© workshop ä¹‹å‰ï¼Œæœ‰ä¸€äº›æº–å‚™å·¥ä½œéœ€è¦å®Œæˆï¼š\næ­¥é©Ÿ1ï¼šä¸‹è¼‰ Vault Binary\né¦–å…ˆï¼Œä½ éœ€è¦ä¸‹è¼‰HashiCorp Vaultçš„æœ€æ–°ç‰ˆæœ¬ã€‚ä½ å¯ä»¥åœ¨HashiCorpçš„å®˜æ–¹ç¶²ç«™ä¸Šæ‰¾åˆ°Vaultçš„ä¸‹è¼‰éˆæ¥ã€‚è«‹ç¢ºä¿ä¸‹è¼‰é©ç”¨æ–¼ä½ æ“ä½œç³»çµ±çš„ç‰ˆæœ¬ã€‚\nhttps://developer.hashicorp.com/vault/downloads\nMacOS amd64 MacOS arm64 Linux æ­¥é©Ÿ2ï¼šå®‰è£Vault\nä¸‹è¼‰å®Œæˆå¾Œï¼Œæ ¹æ“šä½ çš„æ“ä½œç³»çµ±é€²è¡Œå®‰è£ã€‚å°æ–¼å¤§å¤šæ•¸Linuxå’ŒUnixç³»çµ±ï¼Œä½ cå¯ä»¥é€šéè§£å£“ç¸®å£“ç¸®æ–‡ä»¶ä¾†å®‰è£Vaultã€‚å°‡Vault Binaryæ–‡ä»¶ç§»è‡³ä½ çš„PATHä¸­ï¼Œä»¥ä¾¿åœ¨çµ‚ç«¯ä¸­è¼•é¬†è¨ªå•\nç­†è€…ä½¿ç”¨çš„æ˜¯ Mac M1ï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤é€²è¡Œå®‰è£\nwget https://releases.hashicorp.com/vault/1.14.3/vault_1.14.3_darwin_arm64.zip unzip vault_1.14.3_darwin_arm64.zip sudo mv vault /usr/local/bin/vault Vault v1.14.3 (56debfa71653e72433345f23cd26276bc90629ce), built 2023-09-11T21:23:55Z ä½ ä¸éœ€è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Vault ä¹Ÿå¯ä»¥å®Œæˆé€™æ¬¡ workshop\nå•Ÿå‹• Vault server ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤åœ¨æœ¬åœ°å•Ÿå‹• Vault Serverã€‚è«‹ç¢ºä¿ Vault ä¼ºæœå™¨å·²æ­£ç¢ºå•Ÿå‹•ï¼Œä¸¦ä¸”æœªå‡ºç¾éŒ¯èª¤æ¶ˆæ¯ã€‚\nvault server -dev ä½¿ç”¨ -dev é¸é …å¯ä»¥å•Ÿå‹•Vaultçš„é–‹ç™¼æ¨¡å¼ï¼Œè©²æ¨¡å¼ä¸éœ€è¦èº«ä»½é©—è­‰å³å¯é‹è¡ŒVaultã€‚\nç¢ºèªVaulté‹è¡Œ æ‰“é–‹ä½ çš„ç€è¦½å™¨ï¼Œç€è¦½åˆ° http://127.0.0.1:8200\næˆ–è€…ä½¿ç”¨ curl å‘½ä»¤ç™¼é€ GET è«‹æ±‚ï¼š\ncurl http://127.0.0.1:8200/v1/sys/health | jq { \u0026#34;initialized\u0026#34;: true, \u0026#34;sealed\u0026#34;: false, \u0026#34;standby\u0026#34;: false, \u0026#34;performance_standby\u0026#34;: false, \u0026#34;replication_performance_mode\u0026#34;: \u0026#34;disabled\u0026#34;, \u0026#34;replication_dr_mode\u0026#34;: \u0026#34;disabled\u0026#34;, \u0026#34;server_time_utc\u0026#34;: 1694693898, \u0026#34;version\u0026#34;: \u0026#34;1.14.3\u0026#34;, \u0026#34;cluster_name\u0026#34;: \u0026#34;vault-cluster-3273d150\u0026#34;, \u0026#34;cluster_id\u0026#34;: \u0026#34;a32d555e-3346-0757-1d57-21e2f646aaf3\u0026#34; } å¦‚æœVaultæ­£å¸¸é‹è¡Œï¼Œä½ æ‡‰è©²æœƒæ”¶åˆ°ä¸€å€‹åŒ…å«Vaultè¨Šæ¯çš„JSON responseã€‚\nä¹Ÿå¯ä½¿ç”¨ Vault Binary ä¾†å­˜å– Vault API\nexport Vault Server çš„ http endpoint (æˆ‘å€‘å°šæœªå•Ÿå‹• tls listenerï¼Œæ‰€ä»¥æ²’æœ‰ https endpoint)\nexport VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; vault status Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 1 Threshold 1 Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type inmem Cluster Name vault-cluster-3273d150 Cluster ID a32d555e-3346-0757-1d57-21e2f646aaf3 HA Enabled false å¯ä»¥çœ‹åˆ°æœ¬åœ°çš„ Vault server\nå·²åˆå§‹åŒ– å·²è§£å° ç‰ˆæœ¬ æœªå•Ÿç”¨ HA ä¹Ÿå¯ä»¥ä½¿ç”¨ Vault Binary ä¸­çš„ operator æŒ‡ä»¤æª¢æ¸¬\nvault operator members Host Name API Address Cluster Address Active Node Version Upgrade Version Redundancy Zone Last Echo --------- ----------- --------------- ----------- ------- --------------- --------------- --------- CheChias-MacBook-Pro.local http://127.0.0.1:8200 https://127.0.0.1:8201 true 1.14.3 n/a n/a n/a åˆå§‹åŒ–Vault åœ¨é–‹ç™¼æ¨¡å¼ä¸‹é‹è¡Œçš„Vaultå¯èƒ½ä¸éœ€è¦åˆå§‹åŒ–ï¼Œä½†å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ production æ¨¡å¼ï¼Œè«‹åƒè€ƒVaultçš„å®˜æ–¹æ–‡æª”ï¼Œé€²è¡Œåˆå§‹åŒ–å’Œè¨­ç½®ã€‚\nVault server åœ¨ dev æ¨¡å¼ä¸‹å•Ÿå‹•å¾Œï¼Œæœƒè‡ªå‹•ç”¢ç”Ÿä¸€éš»å–®ä¸€å€‹ unseal keyï¼Œèˆ‡ä¸€æŠŠ Root Tokenã€‚\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory and starts unsealed with a single unseal key. The root token is already authenticated to the CLI, so you can immediately begin using Vault. You may need to set the following environment variables: $ export VAULT_ADDR=\u0026#39;http://127.0.0.1:8200\u0026#39; The unseal key and root token are displayed below in case you want to seal/unseal the Vault or re-authenticate. Unseal Key: JbKrVzhH4VO14nPBRvWE1qxJz9CVhnOFJT0pYLsx9LU= Root Token: hvs.0pmmzGSZ8S7w8vP2E4sm7SqE Development mode should NOT be used in production installations! ä½ å¯ä»¥ä½¿ç”¨ vault operator æŒ‡ä»¤ï¼Œå˜—è©¦ seal Vault server\nvault operator seal Success! Vault is sealed. å†æ¬¡æª¢æŸ¥ status\nvault status Key Value --- ----- Seal Type shamir Initialized true Sealed true Total Shares 1 Threshold 1 Unseal Progress 0/1 Unseal Nonce n/a Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type inmem HA Enabled false é¡¯ç¤ºç‚ºå¯†é‘°å¯†å°ï¼ˆSealedï¼‰ç‹€æ…‹\nä½ å¯ä»¥ä½¿ç”¨ vault operator è§£å° Vault\nvault operator unseal JbKrVzhH4VO14nPBRvWE1qxJz9CVhnOFJT0pYLsx9LU= Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 1 Threshold 1 Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type inmem Cluster Name vault-cluster-3273d150 Cluster ID a32d555e-3346-0757-1d57-21e2f646aaf3 HA Enabled false é¡¯ç¤ºç‚ºè§£å°ç‹€æ…‹\nå¯†é‘°å®‰å…¨ æœ¬ workshop ä¸­ä½¿ç”¨çš„ vault server / seal key / root token éƒ½æ˜¯æ¸¬è©¦ç”¨é€”çš„æš«æ™‚æ€§å­˜åœ¨ï¼Œç­†è€…å¯«å®Œæ–‡ç« å¾Œï¼Œé€™äº› server èˆ‡å¯†é‘°æ—©å·²ç¶“æ¸…ç†å®Œç•¢ï¼Œæ‰€ä»¥æ²’æœ‰è³‡å®‰é¢¨éšªã€‚\nç‚ºäº†ç¤ºç¯„æ–¹ä¾¿ï¼Œworkshop æœƒä»¥æ˜ç¢¼ plain text å½¢å¼è¡¨ç¾\nå¦‚æœä½ æ˜¯åœ¨å…¬å¸çš„ production ç’°å¢ƒä½¿ç”¨ï¼Œå‹™å¿…è¦ç¢ºä¿å¯†é‘°çš„å®‰å…¨\nä¸è¦åœ¨ local é›»è…¦ä¸Šå­˜æ”¾ token æˆ– seal key ä¸è¦åœ¨æ²’æœ‰å¯†ç¢¼å­¸èˆ‡è³‡å®‰æª¢æ¸¬çš„å¹³å°ä¸Šå„²å­˜ token æˆ– seal key ä¸è¦é€éé€šè¨Šè»Ÿé«”(ex. slack) æ˜ç¢¼å‚³é€ token æˆ– seal key â€¦ ä½ å¯èƒ½æœƒå•ï¼Œæœ¬åœ°ä¸èƒ½å­˜ï¼Œé ç«¯ä¹Ÿä¸èƒ½å­˜ï¼Œä¹Ÿä¸èƒ½éš¨æ„å‚³é€çµ¦åŒäº‹ï¼Œé‚£æ‡‰è©²å¦‚ä½•å”ä½œèˆ‡ç®¡ç†ï¼Ÿ\nåœ¨å¾Œé¢çš„ workshop å…§å®¹æœƒèˆ‡å¤§å®¶ä¸€ä¸€ç¤ºç¯„è§£èªª\nDev æ¨¡å¼ ä½ å¯ä»¥é—œé–‰åŸ·è¡Œ vault server çš„ terminal session ä¾†é—œé–‰ vault server\nvault server -dev ctrl + c https://developer.hashicorp.com/vault/docs/concepts/dev-server\nâ€œDevâ€ ä¼ºæœå™¨æ¨¡å¼\ndev æ¨¡å¼çš„ä¼ºæœå™¨ä¸éœ€è¦é€²ä¸€æ­¥çš„è¨­å®šï¼Œä¸”ä½ æœ¬åœ°çš„ vault CLI å·²ç¶“è¢«èªè­‰ã€‚é€™ä½¿å¾—ä½¿ç”¨ Vault æˆ–å•Ÿå‹•ç”¨æ–¼é–‹ç™¼çš„ Vault instance è®Šå¾—å®¹æ˜“ã€‚Vault çš„æ¯ä¸€å€‹åŠŸèƒ½åœ¨ â€œdevâ€ æ¨¡å¼ä¸­éƒ½æ˜¯å¯ç”¨çš„ã€‚-dev flag åªæ˜¯å°‡å¾ˆå¤šè¨­ç½®ç°¡åŒ–ç‚ºä¸å®‰å…¨çš„é»˜èªå€¼ã€‚\nè­¦å‘Šï¼šæ°¸é ã€æ°¸é ã€æ°¸é ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­é‹è¡Œ â€œdevâ€ æ¨¡å¼ä¼ºæœå™¨ã€‚é€™æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸”æ¯æ¬¡é‡æ–°å•Ÿå‹•éƒ½æœƒä¸Ÿå¤±è³‡æ–™ï¼ˆå› ç‚ºå®ƒå°‡è³‡æ–™å­˜å„²åœ¨è¨˜æ†¶é«”ä¸­ï¼‰ã€‚å®ƒåƒ…ä¾›é–‹ç™¼æˆ–å¯¦é©—ä½¿ç”¨ã€‚\ndev æ¨¡å¼ç‰¹æ€§ dev ä¼ºæœå™¨çš„å±¬æ€§ï¼ˆæœ‰äº›å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œ flag æˆ–æŒ‡å®šé…ç½®æ–‡ä»¶ä¾†è¦†å¯«ï¼‰ï¼š\nåˆå§‹åŒ–ä¸”æœªå°å°: ä¼ºæœå™¨å°‡è‡ªå‹•åˆå§‹åŒ–ä¸”æœªå°å°ã€‚ä½ ä¸éœ€è¦ä½¿ç”¨ vault operator unsealã€‚å®ƒç«‹å³å¯ç”¨ã€‚\nè¨˜æ†¶é«”å­˜å„²: æ‰€æœ‰è³‡æ–™ï¼ˆåŠ å¯†å¾Œï¼‰éƒ½å­˜å„²åœ¨è¨˜æ†¶é«”ä¸­ã€‚Vault ä¼ºæœå™¨ä¸éœ€è¦ä»»ä½•æª”æ¡ˆæ¬Šé™ã€‚\nç¶å®šåˆ°æœ¬åœ°åœ°å€è€Œä¸ä½¿ç”¨ TLS: ä¼ºæœå™¨æ­£åœ¨ç›£è½ 127.0.0.1:8200ï¼ˆé»˜èªçš„ä¼ºæœå™¨åœ°å€ï¼‰è€Œä¸ä½¿ç”¨ TLSã€‚\nè‡ªå‹•èªè­‰: ä¼ºæœå™¨å­˜å„²äº†ä½ çš„ root access tokenï¼Œæ‰€ä»¥ vault CLI å­˜å–å·²ç¶“æº–å‚™å¥½ã€‚å¦‚æœä½ é€é API å­˜å– Vaultï¼Œä½ éœ€è¦ä½¿ç”¨æ‰“å°å‡ºçš„ token é€²è¡Œèªè­‰ã€‚\nå–®ä¸€è§£å°é‘°åŒ™: ä¼ºæœå™¨ä½¿ç”¨å–®ä¸€çš„ unseal key é€²è¡Œåˆå§‹åŒ–ã€‚Vault å·²ç¶“æ˜¯è§£å°çš„ï¼Œä½†å¦‚æœä½ æƒ³å˜—è©¦ seal/unsealï¼Œé‚£éº¼åªéœ€è¦è¼¸å‡ºçš„å–®ä¸€é‘°åŒ™ã€‚\nå®‰è£ key value storage: åœ¨ secret/ è™•å®‰è£äº†ä¸€å€‹ v2 KV secret engineã€‚è«‹æ³¨æ„ v1 KV æœ‰æ‰€ä¸åŒã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ v1ï¼Œä½¿ç”¨æ­¤æ——æ¨™ -dev-kv-v1ã€‚\nç¬¬ä¸€æ¬¡å­˜å– vault è³‡æ–™ å»ºç«‹é€šç”¨ Key-Value å­˜å„²ï¼š ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨ Vault ä¸­å‰µå»ºé€šç”¨çš„ Key-Value å­˜å„²ã€‚åœ¨é€™å€‹ä¾‹å­ä¸­ï¼Œ â€¦","date":1694612546,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694876681,"objectID":"ad2a1383e84754656adf59306e7b8928","permalink":"https://chechia.net/zh-hant/post/2023-09-13-vault-workshop-get-started/","publishdate":"2023-09-13T21:42:26+08:00","relpermalink":"/zh-hant/post/2023-09-13-vault-workshop-get-started/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDay 02 æº–å‚™ï¼šåŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„ Vault æ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\næº–å‚™å·¥ä½œ åœ¨é–‹å§‹é€²è¡Œ Vault 30 å¤© workshop ä¹‹å‰ï¼Œæœ‰ä¸€äº›æº–å‚™å·¥ä½œéœ€è¦å®Œæˆï¼š\næ­¥é©Ÿ1ï¼šä¸‹è¼‰ Vault Binary\né¦–å…ˆï¼Œä½ éœ€è¦ä¸‹è¼‰HashiCorp Vaultçš„æœ€æ–°ç‰ˆæœ¬ã€‚ä½ å¯ä»¥åœ¨HashiCorpçš„å®˜æ–¹ç¶²ç«™ä¸Šæ‰¾åˆ°Vaultçš„ä¸‹è¼‰éˆæ¥ã€‚è«‹ç¢ºä¿ä¸‹è¼‰é©ç”¨æ–¼ä½ æ“ä½œç³»çµ±çš„ç‰ˆæœ¬ã€‚\nhttps://developer.hashicorp.com/vault/downloads\nMacOS amd64 MacOS arm64 Linux æ­¥é©Ÿ2ï¼šå®‰è£Vault","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 02: Get Started","type":"post"},{"authors":[],"categories":["vault"],"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDay 01 å‰è¨€ï¼šå¾é›¶é–‹å§‹çš„ Hashicorp Vault Workshop å¾é›¶é–‹å§‹ workshop ç³»åˆ—å·²ç¶“åšäº†å››å¹´ï¼Œå…§å®¹åŒ…å« k8s, terraform, aws ç­‰ã€‚\næ·±æ·±è¦ºå¾—è¦å­¸ç¿’ä¸€å€‹å·¥å…·ï¼Œé‚„æ˜¯è¦å‹•æ‰‹åšã€‚\næ‰€ä»¥æœ‰äº† 30 å¤©æ‰‹æŠŠæ‰‹ workshop ç³»åˆ—æ–‡ï¼Œè®“æœ‰èˆˆè¶£æ¥è§¸çš„æœ‹å‹ï¼Œèƒ½ä»¥ç›¸å°ä½çš„é–€æª»å…¥é–€ã€‚\né—œæ–¼å…§å®¹\nç„¡åŸºç¤çš„æ‰‹æŠŠæ‰‹çš„åŸºç¤æ•™å­¸ å®Œæ•´çš„ç¯„ä¾‹ï¼Œæä¾›åŸå§‹ç¨‹å¼ç¢¼ï¼Œä¹Ÿæä¾› production çš„ç¶“é©—èˆ‡ç¯„ä¾‹ å®˜æ–¹æœ€æ–°æ–‡ä»¶ç¹ä¸­ç¿»è­¯ (chatGPT based) å»ºè­°è®€è€…å‹™å¿…è·Ÿè‘—æ“ä½œï¼Œä¸è¦åªæ˜¯çœ‹é\nå…¶ä»–æ–‡ç«  https://chechia.net/\néå»çš„ Workshop\n2022 éµäººè³½: Terraform IaC Best Practice on AWS Cloud / åœ¨ aws å…¬æœ‰é›²ä¸Šæ‰¾ IaC æœ€ä½³å¯¦è¸ (å› æ•…é€€è³½) 2021 éµäººè³½: Terraform Workshop - Infrastructure as Code for Public Cloud 2020 éµäººè³½: Kubernetes X DevOps X å¾é›¶é–‹å§‹å°å…¥å·¥å…· X éœ€æ±‚åˆ†æ 2019 éµäººè³½: Kubernetes é å®šå…§å®¹èˆ‡è¨±é¡˜æ¸…å–® æœ¬ workshop é è¨ˆæœ‰åº•ä¸‹å…§å®¹\nDay 01 å‰è¨€ï¼šå¾é›¶é–‹å§‹çš„ Hashicorp Vault Workshop Day 02 æº–å‚™ï¼šåŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„ Vault Day 03ï¼šç´°æ¢ Secret Engine ç§˜å¯†å¼•æ“ Day 04ï¼šSecret Engine KV V2 Day 05ï¼šAuthentication Day 06: Github auth method Day 07: Policy Day 08: Docker and Initialization æœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDynamic Secrets tls certificate management configuration docker initialization ha storage backend filesystem postgresql Infrastructure as Code for Vault deploy policy auth method Vault Kuberntes integration Azure integration AWS integration token in detail é—œæ–¼ç¿»è­¯å·¥å…· chatGPT æœ¬ç³»åˆ—æ–‡ç« å¤§é‡ä½¿ç”¨ chatGPT ç¿»è­¯å®˜æ–¹æ–‡ç« ã€‚ç›®çš„æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆå®˜æ–¹æ–‡ä»¶å…§å®¹ï¼Œæä¾›ç¬¬ä¸€æ‰‹ä¸”ç²¾æº–çš„è³‡æ–™çµ¦è®€è€…ï¼Œä½†åˆèƒ½é™ä½éæ¯èªè®€è€…å¾—å­¸ç¿’é–€æª»ã€‚\næœ‰ç¿»è­¯çš„æ®µè½éƒ½æœƒæ¨™ç¤ºå‡ºè™•ï¼Œè‘—ä½œæ¬Šçš†å±¬æ–¼åŸå‡ºè™•æ‰€æœ‰ã€‚\næœ¬ç³»åˆ—æ–‡ç« ä»¥åˆ†äº«è³‡è¨Šï¼Œè²¢ç»ç¤¾ç¾¤ï¼Œæé«˜åœ‹å…§æ•´é«”æŠ€è¡“èƒ½åŠ›ç‚ºç›®çš„ï¼Œä¸¦ä¸ç”¨æ–¼å•†æ¥­ç”¨é€”ã€‚\nä½¿ç”¨ç¿»è­¯å·¥å…·ä¸¦ä¸ä»£è¡¨ä½œè€…ï¼ˆè­¯è€…ï¼‰æ²’æœ‰ä»˜å‡ºç›¸ç•¶æ™‚é–“å¿ƒåŠ›ï¼ŒåŒ…å«è¦åŠƒæ–‡ç« å¤§ç¶±ï¼Œæ¸¬è©¦ prompt engineeringï¼Œèª¿æ•´åƒæ•¸ï¼Œä¸¦äººå·¥æ ¡æ­£ç”¢ç”Ÿçš„å…§å®¹ã€‚\næœ¬ç³»åˆ—ä½œå“åœ¨æ–¼æ•™å°è®€è€…ä½¿ç”¨å·¥å…· Hashicorp Vaultï¼Œè€Œ chatGPT ç­‰å¤§èªè¨€æ¨¡å‹å·¥å…·å°±æ˜¯è¿‘å¹´æœ€å€¼å¾—å­¸ç¿’çš„å·¥å…·ã€‚å¦‚æœè®€è€…é‚„ä¸æœƒä½¿ç”¨ chatGPTï¼Œæœ¬ç³»åˆ—æ–‡ç« éƒ½é™„ä¸Š Prompt æç¤ºè©ï¼Œå¯ä»¥åƒè€ƒï¼Œå­¸ç¿’ï¼Œä¸¦è‡ªç”±ä½¿ç”¨ã€‚ä¹Ÿè¨±å­¸æœƒä½¿ç”¨ chatGPT æ‰€å¸¶ä¾†çš„åƒ¹å€¼ï¼Œæœƒæ¯”å­¸ç¿’ Vault å¸¶ä¾†çš„é‚„å¤šã€‚\nå¾ˆé‡è¦æ‰€ä»¥å†èªªä¸€éï¼ŒchatGPT æ˜¯è¿‘å¹´æœ€å€¼å¾—å­¸ç¿’çš„å·¥å…·ï¼Œæ²’æœ‰ä¹‹ä¸€ã€‚\nhttps://github.com/f/awesome-chatgpt-prompts/blob/main/prompts.csv What is Vault? æœ¬æ®µå…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/what-is-vault å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ä¸è¦ä½¿ç”¨æ•¬èªï¼Œè«‹ç”¨ä½ å–ä»£æ‚¨ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinary ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šç§˜å¯†æ”¹ç‚ºç§é‘°ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œæ•¸æ“šåº«æ”¹ç‚ºè³‡æ–™åº«ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œè¨ªå•æ”¹ç‚ºå­˜å–ï¼Œæºä»£ç¢¼æ”¹ç‚ºåŸå§‹ç¢¼ã€‚ What is Vault? HashiCorp Vault æ˜¯ä¸€å¥—åŸºæ–¼èº«ä»½çš„ç§é‘°å’ŒåŠ å¯†ç®¡ç†ç³»çµ±ã€‚æ‰€è¬‚çš„\u0026#34;ç§é‘°\u0026#34;ï¼Œæ˜¯ä½ å¸Œæœ›åš´æ ¼æ§åˆ¶å­˜å–çš„è³‡è¨Šï¼Œä¾‹å¦‚ API keyã€å¯†ç¢¼å’Œcertificateã€‚Vault æä¾›åŠ å¯†æœå‹™ï¼Œä¸¦é€éèªè­‰å’Œæˆæ¬Šæ–¹æ³•é€²è¡Œç®¡æ§ã€‚ä½¿ç”¨ Vault çš„ä½¿ç”¨è€…ä»‹é¢ã€å‘½ä»¤åˆ—ä»‹é¢æˆ– HTTP APIï¼Œå¯ä»¥å®‰å…¨åœ°å„²å­˜å’Œç®¡ç†ç§é‘°åŠå…¶ä»–æ•æ„Ÿè³‡æ–™ï¼Œä¸¦èƒ½åš´æ ¼æ§åˆ¶ï¼ˆé™åˆ¶ï¼‰å…¶å­˜å–æ¬Šï¼Œä¸¦å¯é€²è¡Œ auditã€‚\nç¾ä»£ç³»çµ±éœ€è¦å­˜å–å¤§é‡çš„ç§é‘°ï¼ŒåŒ…æ‹¬è³‡æ–™åº«æ†‘è­‰ã€å¤–éƒ¨æœå‹™çš„ API keyã€é¢å‘æœå‹™çš„æ¶æ§‹é€šè¨Šæ†‘è­‰ç­‰ã€‚äº†è§£èª°æ­£åœ¨å­˜å–å“ªäº›ç§é‘°å¯èƒ½ç›¸ç•¶å›°é›£ï¼Œå°¤å…¶ç•¶é€™ç¨®å­˜å–å¯èƒ½å› å¹³å°è€Œç•°ã€‚è€Œåœ¨æ­¤åŸºç¤ä¸ŠåŠ å…¥key rollingã€å®‰å…¨å„²å­˜å’Œè©³ç´°çš„audit trailï¼Œè‹¥ç„¡è‡ªè¨‚çš„è§£æ±ºæ–¹æ¡ˆå¹¾ä¹æ˜¯ä¸å¯èƒ½çš„ã€‚é€™æ­£æ˜¯ Vault ç™¼æ®ä½œç”¨çš„åœ°æ–¹ã€‚\nVault æœƒé©—è­‰ä¸¦æˆæ¬Šå®¢æˆ¶ç«¯ï¼ˆç”¨æˆ¶ã€æ©Ÿå™¨ã€æ‡‰ç”¨ç¨‹åºï¼‰åœ¨æä¾›ä»–å€‘å­˜å–ç§˜å¯†æˆ–å„²å­˜çš„æ•æ„Ÿè³‡æ–™ä¹‹å‰ã€‚\nVault å¦‚ä½•é‹ä½œï¼š Vault ä¸»è¦ä½¿ç”¨ tokenï¼Œä¸” token èˆ‡å®¢æˆ¶ç«¯çš„ policy ç›¸é—œè¯ã€‚æ¯ä¸€ policy éƒ½æ˜¯åŸºæ–¼ path-based çš„ï¼Œpolicy rule é™åˆ¶æ¯å€‹å®¢æˆ¶ç«¯å°æ–¼æ¯ä¸€ path çš„è¡Œå‹•å’Œå­˜å–èƒ½åŠ›ã€‚ä½¿ç”¨ Vaultï¼Œä½ å¯ä»¥æ‰‹å‹•å»ºç«‹ token ä¸¦æŒ‡æ´¾çµ¦ä½ çš„å®¢æˆ¶ç«¯ï¼Œæˆ–å®¢æˆ¶ç«¯å¯ä»¥ç™»å…¥ä¸¦ç²å¾— tokenã€‚ä¸‹é¢çš„æ’åœ–é¡¯ç¤ºäº† Vault çš„æ ¸å¿ƒå·¥ä½œæµç¨‹ã€‚\nVault å·¥ä½œæµç¨‹ Vault çš„æ ¸å¿ƒå·¥ä½œæµç¨‹åŒ…å«å››å€‹éšæ®µï¼š\nèªè­‰ï¼šåœ¨ Vault ä¸­çš„èªè­‰æ˜¯æŒ‡å®¢æˆ¶ç«¯æä¾›è³‡è¨Šï¼ŒVault ä½¿ç”¨æ­¤è³‡è¨Šä¾†åˆ¤å®šä»–å€‘æ˜¯å¦æ˜¯ä»–å€‘æ‰€è²ç¨±çš„é‚£å€‹äººã€‚ä¸€æ—¦å®¢æˆ¶ç«¯æ ¹æ“šæŸç¨®èªè­‰æ–¹å¼æˆåŠŸèªè­‰ï¼Œå°‡ç”Ÿæˆä¸€å€‹èˆ‡ç­–ç•¥ç›¸é—œè¯çš„ tokenã€‚\né©—è­‰ï¼šVault æ ¹æ“šç¬¬ä¸‰æ–¹å—ä¿¡è³´çš„ä¾†æºï¼Œä¾‹å¦‚ Githubã€LDAPã€AppRole ç­‰ï¼Œå°å®¢æˆ¶ç«¯é€²è¡Œé©—è­‰ã€‚\næˆæ¬Šï¼šå®¢æˆ¶ç«¯æ ¹æ“š Vault å®‰å…¨ç­–ç•¥é€²è¡ŒåŒ¹é…ã€‚æ­¤ç­–ç•¥æ˜¯ä¸€å¥—è¦å‰‡é›†ï¼Œå®šç¾©å®¢æˆ¶ç«¯ä½¿ç”¨å…¶ Vault token å¯å­˜å–å“ªäº› API ç«¯é»ã€‚ç­–ç•¥æä¾›äº†ä¸€ç¨®å®£å‘Šæ–¹å¼ä¾†æˆäºˆæˆ–ç¦æ­¢å­˜å– Vault ä¸­çš„ç‰¹å®šè·¯å¾‘å’Œæ“ä½œã€‚\nå­˜å–ï¼šæ ¹æ“šèˆ‡å®¢æˆ¶ç«¯èº«ä»½ç›¸é—œè¯çš„ç­–ç•¥ï¼ŒVault é€šéç™¼å‡º token ä¾†æˆäºˆå­˜å–ç§˜å¯†ã€é‡‘é‘°å’ŒåŠ å¯†èƒ½åŠ›çš„æ¬Šé™ã€‚ç„¶å¾Œï¼Œå®¢æˆ¶ç«¯å¯ä»¥ä½¿ç”¨ä»–å€‘çš„ Vault token é€²è¡Œæœªä¾†çš„æ“ä½œã€‚\nç‚ºä»€éº¼é¸æ“‡ Vaultï¼Ÿ ç¾ä»Šçš„å¤§å¤šæ•¸ä¼æ¥­éƒ½æœ‰æ†‘è­‰æ•£å¸ƒåœ¨å…¶çµ„ç¹”ä¸­ã€‚å¯†ç¢¼ã€API é‡‘é‘°å’Œæ†‘è­‰å­˜å„²åœ¨æ˜æ–‡ä¸­ã€æ‡‰ç”¨æºä»£ç¢¼ã€é…ç½®æ–‡ä»¶å’Œå…¶ä»–ä½ç½®ã€‚ç”±æ–¼é€™äº›æ†‘è­‰å­˜åœ¨æ–¼å„è™•ï¼Œå› æ­¤å¯èƒ½å¾ˆé›£çœŸæ­£çŸ¥é“èª°æœ‰å­˜å–å’Œæˆæ¬Šæ¬Šé™ã€‚æ˜æ–‡ä¸­çš„æ†‘è­‰ä¹Ÿå¢åŠ äº†å…§éƒ¨å’Œå¤–éƒ¨æ”»æ“Šè€…é€²è¡Œæƒ¡æ„æ”»æ“Šçš„å¯èƒ½æ€§ã€‚\nè€ƒæ…®åˆ°é€™äº›æŒ‘æˆ°ï¼ŒVault è¢«è¨­è¨ˆå‡ºä¾†ã€‚Vault æ¡å–æ‰€æœ‰é€™äº›æ†‘è­‰ä¸¦é›†ä¸­ç®¡ç†ï¼Œé€™æ¨£ä»–å€‘å°±åªåœ¨ä¸€å€‹ä½ç½®å®šç¾©ï¼Œå¾è€Œæ¸›å°‘äº†æ†‘è­‰çš„ä¸å¿…è¦æš´éœ²ã€‚ä½† Vault æ›´é€²ä¸€æ­¥ï¼Œç¢ºä¿ç”¨æˆ¶ã€æ‡‰ç”¨ç¨‹åºå’Œç³»çµ±éƒ½è¢«èªè­‰ä¸¦æ˜ç¢ºæˆæ¬Šå­˜å–è³‡æºï¼ŒåŒæ™‚ä¹Ÿæä¾›ä¸€å€‹å¯©è¨ˆè·Ÿè¸ªï¼Œæ•æ‰ä¸¦ä¿ç•™å®¢æˆ¶ç«¯æ“ä½œçš„æ­·å²è¨˜éŒ„ã€‚\nVault çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ å®‰å…¨çš„ç§˜å¯†å­˜å„²ï¼šå¯ä»¥åœ¨ Vault ä¸­å­˜å„²ä»»æ„çš„é‡‘é‘°/å€¼ç§˜å¯†ã€‚Vault åœ¨å°‡é€™äº›ç§˜å¯†å¯«å…¥æŒä¹…æ€§å­˜å„²ä¹‹å‰æœƒå°å…¶é€²è¡ŒåŠ å¯†ï¼Œå› æ­¤ç²å–åŸå§‹å­˜å„²ä¸¦ä¸è¶³ä»¥å­˜å–ä½ çš„ç§˜å¯†ã€‚Vault å¯ä»¥å¯«å…¥ç£ç›¤ã€Consul ç­‰ã€‚\nå‹•æ…‹ç§˜å¯†ï¼šVault å¯ä»¥ç‚ºæŸäº›ç³»çµ±å³æ™‚ç”Ÿæˆç§˜å¯†ï¼Œä¾‹å¦‚ AWS æˆ– SQL æ•¸æ“šåº«ã€‚ä¾‹å¦‚ï¼Œç•¶æ‡‰ç”¨ç¨‹åºéœ€è¦å­˜å– S3 æ¡¶æ™‚ï¼Œå®ƒæœƒè¦æ±‚ Vault æä¾›æ†‘è­‰ï¼ŒVault å°‡å³æ™‚ç”Ÿæˆå…·æœ‰æœ‰æ•ˆæ¬Šé™çš„ AWS å¯†é‘°å°ã€‚åœ¨å‰µå»ºé€™äº›å‹•æ…‹ç§˜å¯†å¾Œï¼ŒVault ä¹Ÿæœƒåœ¨ç§ŸæœŸåˆ°æœŸå¾Œè‡ªå‹•æ’¤éŠ·å®ƒå€‘ã€‚\næ•¸æ“šåŠ å¯†ï¼šVault å¯ä»¥åœ¨ä¸å­˜å„²æ•¸æ“šçš„æƒ…æ³ä¸‹åŠ å¯†å’Œè§£å¯†æ•¸æ“šã€‚é€™å…è¨±å®‰å…¨åœ˜éšŠå®šç¾©åŠ å¯†åƒæ•¸ï¼Œä¸¦å…è¨±é–‹ç™¼äººå“¡å°‡åŠ å¯†æ•¸æ“šå­˜å„²åœ¨å¦‚ SQL æ•¸æ“šåº«ä¹‹é¡çš„åœ°æ–¹ï¼Œè€Œä¸å¿…è¨­è¨ˆä»–å€‘è‡ªå·±çš„åŠ å¯†æ–¹æ³•ã€‚\nç§Ÿè³ƒå’ŒçºŒæœŸï¼šVault ä¸­çš„æ‰€æœ‰ç§˜å¯†éƒ½æœ‰ä¸€å€‹èˆ‡ä¹‹ç›¸é—œçš„ç§ŸæœŸã€‚åœ¨ç§ŸæœŸçµæŸæ™‚ï¼ŒVault æœƒè‡ªå‹•æ’¤éŠ·è©²ç§˜å¯†ã€‚å®¢æˆ¶ç«¯å¯ä»¥é€šéå…§ç½®çš„çºŒæœŸ API ä¾†çºŒç§Ÿã€‚\næ’¤éŠ·ï¼šVault å…·æœ‰å…§ç½®çš„ç§˜å¯†æ’¤éŠ·æ”¯æ´ã€‚Vault ä¸åƒ…å¯ä»¥æ’¤éŠ·å–®ä¸€çš„ç§˜å¯†ï¼Œé‚„å¯ä»¥æ’¤éŠ·ç§˜å¯†æ¨¹ï¼Œä¾‹å¦‚ç”±ç‰¹å®šç”¨æˆ¶è®€å–çš„æ‰€æœ‰ç§˜å¯†ï¼Œæˆ–ç‰¹å®šé¡å‹çš„æ‰€æœ‰ç§˜å¯†ã€‚æ’¤éŠ·åœ¨é‡‘é‘°æ»¾å‹•ä»¥åŠåœ¨å…¥ä¾µæƒ…æ³ä¸‹é–å®šç³»çµ±æ™‚éƒ½å¾ˆæœ‰å¹«åŠ©ã€‚\nä»€éº¼æ˜¯ HCP Vaultï¼Ÿ HashiCorp Cloud Platform (HCP) Vault æ˜¯ Vault çš„è¨—ç®¡ç‰ˆæœ¬ï¼Œç”± HashiCorp é‹ç‡Ÿï¼Œä½¿çµ„ç¹”èƒ½å¤ å¿«é€Ÿå•Ÿå‹•ä¸¦é‹è¡Œã€‚HCP Vault ä½¿ç”¨èˆ‡è‡ªè¨—ç®¡çš„ Vault ç›¸åŒçš„äºŒé€²åˆ¶æ–‡ä»¶ï¼Œé€™æ„å‘³è‘—ä½ å°‡æ“æœ‰ä¸€è‡´çš„ç”¨æˆ¶é«”é©—ã€‚ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ Vault å®¢æˆ¶ç«¯èˆ‡ HCP Vault é€šä¿¡ï¼Œå°±åƒä½ ä½¿ç”¨è‡ªè¨—ç®¡çš„ Vault ä¸€æ¨£ã€‚è«‹åƒè€ƒ HCP Vault æ–‡æª”ä»¥ç²å¾—æ›´å¤šè³‡è¨Šã€‚\n","date":1694522119,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1695224937,"objectID":"65feca0329c2cf52a51a072f2efd39dd","permalink":"https://chechia.net/zh-hant/post/2023-09-12-vault-workshop-introduction/","publishdate":"2023-09-12T20:35:19+08:00","relpermalink":"/zh-hant/post/2023-09-12-vault-workshop-introduction/","section":"post","summary":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDay 01 å‰è¨€ï¼šå¾é›¶é–‹å§‹çš„ Hashicorp Vault Workshop å¾é›¶é–‹å§‹ workshop ç³»åˆ—å·²ç¶“åšäº†å››å¹´ï¼Œå…§å®¹åŒ…å« k8s, terraform, aws ç­‰ã€‚\næ·±æ·±è¦ºå¾—è¦å­¸ç¿’ä¸€å€‹å·¥å…·ï¼Œé‚„æ˜¯è¦å‹•æ‰‹åšã€‚\næ‰€ä»¥æœ‰äº† 30 å¤©æ‰‹æŠŠæ‰‹ workshop ç³»åˆ—æ–‡ï¼Œè®“æœ‰èˆˆè¶£æ¥è§¸çš„æœ‹å‹ï¼Œèƒ½ä»¥ç›¸å°ä½çš„é–€æª»å…¥é–€ã€‚\né—œæ–¼å…§å®¹\nç„¡åŸºç¤çš„æ‰‹æŠŠæ‰‹çš„åŸºç¤æ•™å­¸ å®Œæ•´çš„ç¯„ä¾‹ï¼Œæä¾›åŸå§‹ç¨‹å¼ç¢¼ï¼Œä¹Ÿæä¾› production çš„ç¶“é©—èˆ‡ç¯„ä¾‹ å®˜æ–¹æœ€æ–°æ–‡ä»¶ç¹ä¸­ç¿»è­¯ (chatGPT based) å»ºè­°è®€è€…å‹™å¿…è·Ÿè‘—æ“ä½œï¼Œä¸è¦åªæ˜¯çœ‹é","tags":["vault","iac","workshop","terraform","éµäººè³½2023","chatgpt"],"title":"Vault Workshop 01: Introduction","type":"post"},{"authors":null,"categories":null,"content":"","date":1694304000,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694692432,"objectID":"fb93c27fe10b079a575ad02284ccff89","permalink":"https://chechia.net/zh-hant/project/vault-playground/","publishdate":"2023-09-10T00:00:00Z","relpermalink":"/zh-hant/project/vault-playground/","section":"project","summary":"","tags":["éµäººè³½2023","iac","vault","terraform"],"title":"å¾é›¶é–‹å§‹çš„ 30 å¤© Hashicorp Vault Workshop","type":"project"},{"authors":[],"categories":["kubernetes","vault"],"content":"Info ç¾ä»£ç¶²è·¯æ‡‰ç”¨éœ€è¦è™•ç†è¨±å¤šç§å¯†é‡‘é‘°çš„ç®¡ç†ï¼Œä¾‹å¦‚ï¼šuser çš„å¯†ç¢¼ã€server çš„è³‡æ–™ã€database çš„è³‡æ–™ã€microservices å½¼æ­¤ authenticationâ€¦ã€‚åŠ ä¸Šé§­å®¢åœ˜é«”çŒ–ç—ï¼Œè¨±å¤šåœ‹å…§å¤–çŸ¥åä¼æ¥­ç´›ç´›é­é§­ï¼Œå°è‡´å…¬å¸èˆ‡ä½¿ç”¨è€…çš„æå¤±ã€‚ å¦‚ä½•ç³»çµ±åŒ–ä¸”è‡ªå‹•åŒ–ç®¡ç†å¤§é‡çš„ç§å¯†è³‡æ–™ï¼Œæˆç‚ºç³»çµ±æ•´é«”å®‰å…¨æ€§çš„é—œéµã€‚\nHashiCorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ï¼Œé™¤äº†ä¿éšœç³»çµ±å®‰å…¨æ€§ï¼Œæ¯”èµ·å¸‚é¢ä¸Šçš„å…¶ä»–ç®¡ç†å·¥å…·ï¼Œé‚„æœ‰è¨±å¤šç‰¹é»å¦‚ï¼š\nä¸ä¾è³´å¤–éƒ¨æœå‹™ï¼Œé©åˆè‡ªè¡Œæ¶è¨­åœ¨å…§éƒ¨å…¬æœ‰é›²/ç§æœ‰é›²/å‚³çµ± server/Kubernetes/VM æ”¯æ´è·¨ç’°å¢ƒçš„æ‡‰ç”¨ï¼Œå¯ä»¥ä¸²é€£æ··åˆé›²ä¸­çš„æ‡‰ç”¨ï¼Œä½œç‚ºç§é‘°èªè­‰çš„ä¸­å¿ƒ\nTarget group æœ¬æ¬¡æ´»å‹•å°‡ç°¡ä»‹ Hashicorp Vaultï¼Œä¸¦ä»¥ AWS Cloud èˆ‡æœ¬åœ° Kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ï¼Œé©åˆåˆæ¬¡æ¥è§¸ HashiCorp Vault èˆ‡å°‹æ‰¾ç§é‘°ç®¡ç†å¹³å°çš„åœ˜éšŠã€‚\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","date":1683716400,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1724336959,"objectID":"d209db151869cc26e808a5bd6d0ee9e9","permalink":"https://chechia.net/zh-hant/talk/hashicorp-vault-on-aws-k8s-%E9%9B%B2%E7%AB%AF%E5%9C%B0%E7%AB%AF%E9%80%9A%E5%90%83%E7%9A%84%E7%A7%81%E9%91%B0%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/","publishdate":"2023-05-01T00:00:00Z","relpermalink":"/zh-hant/talk/hashicorp-vault-on-aws-k8s-%E9%9B%B2%E7%AB%AF%E5%9C%B0%E7%AB%AF%E9%80%9A%E5%90%83%E7%9A%84%E7%A7%81%E9%91%B0%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/","section":"event","summary":"HashiCorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ã€‚æœ¬æ¬¡æ´»å‹•å°‡ç°¡ä»‹ Hashicorp Vaultï¼Œä¸¦ä»¥ AWS Cloud èˆ‡æœ¬åœ° Kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ï¼Œé©åˆåˆæ¬¡æ¥è§¸ HashiCorp Vault èˆ‡å°‹æ‰¾ç§é‘°ç®¡ç†å¹³å°çš„åœ˜éšŠã€‚","tags":["iac","aws","terraform","kubernetes","vault"],"title":"HashiCorp Vault on AWS \u0026 K8s - é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å°","type":"event"},{"authors":null,"categories":["vault"],"content":"target group é‡‘èå®¢æˆ¶ vault 4/15 ä¸Šæ¶\naccupass 5/10 (Wed) 11:00-12:00\nwebbase link (online)\n10:30 ä¸Šç·šè¨­å‚™æ¸¬è©¦\n11:00 Ming é–‹å ´\n11:05 ä¸»è¬›\n12:00 Q\u0026amp;A (ç•™è¨€)\nç•¶å¤©éŒ„å½±æœƒä¸Šç·š\næ¼”è¬›å¤§ç¶± åŸºæœ¬ä»‹ç´¹ vault æ¶æ§‹ ä¼æ¥­éœ€æ±‚ self-host è¤‡é›œçš„ policy ç”¨ä¾‹ demo aws auth k8s auth policy ç•¶å¤©æä¾› github example Q\u0026amp;A (10mins) å…§å®¹ æ¼”è¬›ä¸»é¡Œï¼šHashicorp vault é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å°\nç¾ä»£ç¶²è·¯æ‡‰ç”¨éœ€è¦è™•ç†è¨±å¤šç§å¯†é‡‘æ›œçš„ç®¡ç†ï¼Œä¾‹å¦‚ï¼šuser çš„å¯†ç¢¼ï¼Œserver çš„è³‡æ–™ï¼Œdatabase çš„è³‡æ–™ï¼Œmicroservices å½¼æ­¤ authenticationâ€¦ã€‚åŠ ä¸Šé§­å®¢åœ˜é«”çŒ–ç—ï¼Œè¨±å¤šåœ‹å…§å¤–çŸ¥åä¼æ¥­ç´›ç´›é­é§­ï¼Œå°è‡´å…¬å¸èˆ‡ä½¿ç”¨è€…çš„æå¤±ã€‚ å¦‚ä½•ç³»çµ±åŒ–ä¸”è‡ªå‹•åŒ–ç®¡ç†å¤§é‡çš„ç§å¯†è³‡æ–™ï¼Œæˆç‚ºç³»çµ±æ•´é«”å®‰å…¨æ€§çš„é—œéµã€‚ Hashicorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ï¼Œé™¤äº†ä¿éšœç³»çµ±å®‰å…¨æ€§ï¼Œæ¯”èµ·å¸‚é¢ä¸Šçš„å…¶ä»–ç®¡ç†å·¥å…·ï¼Œæœ‰è¨±å¤šç‰¹é»\nä¸ä¾è³´å¤–éƒ¨æœå‹™ï¼Œé©åˆè‡ªè¡Œæ¶è¨­åœ¨å…§éƒ¨å…¬æœ‰é›²/ç§æœ‰é›²/å‚³çµ±server/Kubernetes/VM æ”¯æ´è·¨ç’°å¢ƒçš„æ‡‰ç”¨ï¼Œå¯ä»¥ä¸²é€£æ··åˆé›²ä¸­çš„æ‡‰ç”¨ï¼Œä½œç‚ºç§è¦èªè­‰çš„ä¸­å¿ƒ æœ¬æ¬¡æ¼”è¬›ç°¡ä»‹ Hashicorp Vaultï¼Œä»¥ aws cloud èˆ‡æœ¬åœ° kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ é©åˆåˆæ¬¡æ¥è§¸çš„ Hashicorp Vaultï¼Œèˆ‡å°‹æ‰¾ç§è¦ç®¡ç†å¹³å°çš„åœ˜éšŠ è¬›è€…ç°¡ä»‹\nChe-Chia Changï¼ŒSREï¼Œå–œæ­¡ç ”ç©¶å…¬æœ‰é›²/å®¹å™¨åŒ–æ‡‰ç”¨/Kubernetes Microsoft MVPï¼ŒIthome é›²ç«¯å¤§æœƒ/COSCUPè¬›å¸«ï¼Œå¸¸å‡ºç¾ CNTUG / DevOpsTW / Golang Taipei æŠ€è¡“ blog æ”¶éŒ„éå¾€æ¼”è¬›èˆ‡æ–‡ç«  https://chechia.net\nPresentation https://docs.google.com/presentation/d/1iex9lm89OCIR8IAoD1RPe4vcW--bcKBmMHoixDybqP8/edit#slide=id.g2403737215e_0_147\n","date":1683692342,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"28f24b96533b13a26af4fb714b6facd2","permalink":"https://chechia.net/zh-hant/post/2023-05-10-hashicorp-comminity-presentation-vault-introduction/","publishdate":"2023-05-10T12:19:02+08:00","relpermalink":"/zh-hant/post/2023-05-10-hashicorp-comminity-presentation-vault-introduction/","section":"post","summary":"target group é‡‘èå®¢æˆ¶ vault 4/15 ä¸Šæ¶\naccupass 5/10 (Wed) 11:00-12:00\nwebbase link (online)\n10:30 ä¸Šç·šè¨­å‚™æ¸¬è©¦\n11:00 Ming é–‹å ´\n11:05 ä¸»è¬›\n12:00 Q\u0026A (ç•™è¨€)\nç•¶å¤©éŒ„å½±æœƒä¸Šç·š\næ¼”è¬›å¤§ç¶± åŸºæœ¬ä»‹ç´¹ vault æ¶æ§‹ ä¼æ¥­éœ€æ±‚ self-host è¤‡é›œçš„ policy ç”¨ä¾‹ demo aws auth k8s auth policy ç•¶å¤©æä¾› github example Q\u0026A (10mins) å…§å®¹ æ¼”è¬›ä¸»é¡Œï¼šHashicorp vault é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å°","tags":["vault","iac","aws"],"title":"Hashicorp Comminity Presentation Vault Introduction","type":"post"},{"authors":null,"categories":["terraform"],"content":"AWS cross account delegation ä¾èˆŠ WIPï¼Œä»Šå¤©å»¶çºŒæ˜¨å¤©å…§å®¹ï¼Œä½¿ç”¨ github action åš terraform module çš„ CI/CD\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nTerraform Github Action Jobs æˆ‘å€‘å¯ä»¥åœ¨ terraform repository ä¸­å¢åŠ  tool checks åˆ° CI/CD ä¸­ï¼ŒåŠ å¼· code çš„å“è³ªæ§ç®¡\nterragrunt-infrastructure-modules PR åœ¨æ­¤\né€™å€‹ PR åŒ…å«å¹¾å€‹ Github Action Workflow\nls .github/workflows checkov.yaml format.yaml plan.yaml security-scan.yaml validate.yaml format.yaml ä¸­åŸ·è¡Œ terraform fmt -recursiveï¼Œéœ€æ±‚èˆ‡ç›®çš„å·²åœ¨æ˜¨å¤©èªªæ˜ validate.yaml ä¸­åŸ·è¡Œ terraform validateï¼Œç”¨ä¾†é©—è­‰ module å…§çš„ terraform syntax æ˜¯å¦ç¬¦åˆèªæ³• checkov.yaml æ˜¯å¤šèªè¨€çš„ policy as code å·¥å…·ï¼Œåœ¨é€™é‚ŠåŸ·è¡Œæƒæ terraform code çš„å®‰å…¨æ€§èˆ‡ CVEs æª¢æŸ¥ security-scan.yaml ä¸­ä¹Ÿæ˜¯ Policy As Code ä½¿ç”¨ tfsec å·¥å…·æƒæ plan.yaml ä¸­åœ¨ pipeline åŸ·è¡Œè‡ªå‹•åŒ– terraform plan ç”±æ–¼ plan éœ€è¦å­˜å– state èˆ‡ provider APIï¼Œè¨­å®šä¸Šæœ‰è¨±å¤šæ¬Šé™è¨­å®šéœ€è¦é–‹å•Ÿï¼Œç›®å‰æ˜¯ä¸€å€‹ dummy workflow policy as code å…§å®¹å¯ä»¥å°‡ä¸€ç¯‡æ¼”è¬›ï¼Œæœ‰èˆˆè¶£è«‹è¦‹åº•ä¸‹æŠ•å½±ç‰‡: 2022 DevOpsDay: Policy As Code for Terraform: https://docs.google.com/presentation/d/1yawazO1B_sP5Yiav-XLGJXW3ZS2JTV0wGuJwhrUKQ3A\nå°æ–¼ Policy as Code æœ‰èˆˆè¶£çš„æœ‹å‹è«‹è¦‹ä»Šå¹´ DevOpsDay çš„æ¼”è¬› https://devopsdays.tw/session-page/1146\nTODO èˆ‡é€²åº¦ root ä¸­è¨­å®š IAM User aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role cross account iam role iam_cross_account_roles TODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key root account password policy aws cross account iam role delegation root account MFA policy Optional: Cloudtrail Optional: terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","date":1664109543,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"dd2f2867b25fc954a3882c597084ebb4","permalink":"https://chechia.net/zh-hant/post/2022-09-25-14th-ithome-ironman-iac-aws-workshop-11-aws-github-action-ci-cd/","publishdate":"2022-09-25T20:39:03+08:00","relpermalink":"/zh-hant/post/2022-09-25-14th-ithome-ironman-iac-aws-workshop-11-aws-github-action-ci-cd/","section":"post","summary":"AWS cross account delegation ä¾èˆŠ WIPï¼Œä»Šå¤©å»¶çºŒæ˜¨å¤©å…§å®¹ï¼Œä½¿ç”¨ github action åš terraform module çš„ CI/CD\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nTerraform Github Action Jobs æˆ‘å€‘å¯ä»¥åœ¨ terraform repository ä¸­å¢åŠ  tool checks åˆ° CI/CD ä¸­ï¼ŒåŠ å¼· code çš„å“è³ªæ§ç®¡","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Terraform Github Action CI/CD","type":"post"},{"authors":null,"categories":["terraform"],"content":"TODO èˆ‡é€²åº¦ root ä¸­è¨­å®š IAM User aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nAWS cross account with iam roles è¦åšè·¨ AWS account çš„ IAM Roles access controlï¼Œæˆ‘å€‘å…ˆçœ‹å®˜æ–¹æ–‡ä»¶ç†è§£é€™å€‹åŠŸèƒ½\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html\nå›æ†¶æˆ‘å€‘åœ¨ day-04 æåˆ°çš„ multi-accounts æ¶æ§‹\naccount/security æœ‰æ‰€æœ‰ iam-users å…¶ä»– child-account ex. account/test ä¸­æœƒæœ‰ iam-roles éœ€æ±‚ï¼šsecurity/iam-user å¯ä»¥ä½¿ç”¨ test/iam-role çš„èº«ä»½ï¼Œå­˜å– test åº•ä¸‹çš„ resource ex.test/ec2 å¥½è™• admin ä¸éœ€è¦åˆ°æ¯ä¸€å€‹ child-account ä¸‹é¢å»é–‹æ¯ä¸€å€‹äººçš„ iam userï¼Œçµ±ä¸€åˆ° account/security ç®¡ç† user åªè¦ç™»å…¥ä¸€å€‹ security å¸³è™Ÿï¼Œå°±å¯ä»¥æ§åˆ¶å¤šå€‹ child-accountï¼Œä¸ç”¨ç™»å‡ºåˆç™»å…¥ä¸åŒ account åœ¨ aws official doc ä¸Šï¼Œä¹Ÿæ˜¯èˆ‰å¹¾å€‹ account ä½œç‚º cross account delegation çš„ç¯„ä¾‹ã€‚ç”±æ–¼æœ¬ workshop å·²ç¶“æœ‰ç¾å­˜çš„ child-accountï¼Œæˆ‘å€‘æœƒç›´æ¥ä½¿ç”¨ workshop çš„ accounts åšèªªæ˜ã€‚å®Œæˆé€™æ¬¡ iam role delegation çš„è¨­å®šå¾Œï¼Œæˆ‘å€‘æœƒå¾—åˆ°ä»¥ä¸‹æˆæœ\naccount/security ä¸‹é¢ IAM User å¯ä»¥ assume åˆ° account/test ä¸‹é¢çš„ç‰¹å®šçš„ IAM role account/test ä¸‹é¢æœ‰ä¸€å€‹ IAM role å¯ä»¥å­˜å– S3 Bucket å·¥ç¨‹å¸«å¯ä»¥ä½¿ç”¨ web console ç™»å…¥ security/userï¼Œç„¶å¾Œ assume role ç‚º test/roleï¼Œå–å¾—æŸ¥çœ‹ s3 bucket çš„æ¬Šé™ å·¥ç¨‹å¸«ä¹Ÿå¯ä½¿ç”¨ä»¥ security/user çš„èº«ä»½ï¼Œ call aws API å–å¾— test/role çš„æš«æ™‚çš„ credential æ­¥é©Ÿ æˆ‘å€‘æœƒå…ˆéä¸€æ¬¡ aws å®˜æ–¹æ–‡ä»¶ä¸Šæ‰€è¿°çš„æ­¥é©Ÿï¼Œè®“å¤§å®¶äº†è§£æ•´å€‹è¨­å®šæ­¥é©Ÿï¼Œå¼„æ¸…æ•´å€‹ delegation çš„æµç¨‹èˆ‡æ¦‚å¿µã€‚ä¹‹å¾Œæœƒè½‰è€Œä½¿ç”¨ Terraform è¨­å®šæ‰€æœ‰çš„å…ƒä»¶ã€‚\né¦–å…ˆè¦åœ¨ test (child-account) è¨­å®š iam role å°‡ account/security ä½œç‚º trusted entity è¨­å®š role çš„ policyï¼Œå¢åŠ å¯ä»¥å­˜å– s3 bucket çš„æ¬Šé™çµ¦ test/role èª¿æ•´ iam roleï¼Œå¯ä»¥è¨­å®šéœ€è¦çµ¦äºˆæ¬Šé™ï¼Œæˆ–æ˜¯ deny æŸäº›æ¬Šé™ æœ€å¾Œåšæ¸¬è©¦ï¼Œæ˜¯å¦å¯ä»¥å®Œæˆ switch role AWS çš„ç¯„ä¾‹ä½¿ç”¨ aws web console åšç¯„ä¾‹ï¼Œé€™å€‹ workshop å¾Œé¢æˆ‘å€‘æœƒä½¿ç”¨ terraform ä¾†å¯¦ä½œã€‚\nå¤–å‡ºå–æ ä¸Šé¢çš„ç¯„ä¾‹é‚„åœ¨ WIPï¼Œè«‹ç•¶ä½œè€…å¤–å‡ºå–æä¸€å¤©ï¼Œä»Šå¤©å…ˆè¬›å¦å¤–ä¸€å€‹å·¥å…·\nTerraform fmt \u0026amp; lint è¦æå‡ terraform code å“è³ªï¼Œæœ‰è¨±å¤šå·¥å…·éå¸¸å€¼å¾—åœ¨ CI/CD éç¨‹ä¸­ä½¿ç”¨\nä¾‹å¦‚ terraform å…§å»ºçš„ fmt èˆ‡ terragrunt å…§å»ºçš„ hclfmt\nåœ¨ module çš„ repository ä¸­æœƒéœ€è¦è·‘ terraform fmtï¼Œç¢ºä¿æ¯å€‹ module release å‡ºå»å‰éƒ½æœ‰ç¶“é fmt åœ¨ä½¿ç”¨ terragrunt çš„ root module æœƒéœ€è¦ hclfmt .hcl æª”æ¡ˆ cd terragrunt-infrastructure-modules terraform fmt -recursive cd terragrunt-infrastructure-live-example terragrunt hclfmt fmt å°æ–¼ç¨‹å¼ç¢¼çš„å“è³ªæ˜¯åŸºç¤ä½†ååˆ†é‡è¦çš„\næ²’æœ‰å›ºå®š format çš„ç¨‹å¼ç¢¼æœƒé€ æˆ git ä½¿ç”¨å‡ºç¾éå¤š diffï¼Œé€ æˆåœ˜éšŠå”ä½œçš„å›°é›£ format ä¹Ÿæœƒå½±éŸ¿è‡ªå‹•åŒ–ï¼Œä¾‹å¦‚ templating / variable expension fmt / lint æ˜¯æˆ‘å€‘ç¬¬ä¸€å€‹å¸¶å…¥ CI/CD çš„å·¥å…·\næ‰‹å‹• fmt fmt ä¸€ä¸‹\ncd terragrunt-infrastructure-modules terraform fmt -recursive cd terragrunt-infrastructure-live-example terragrunt hclfmt commit å¦‚ä¸‹\nterragrunt-infrastructure-modules commit terragrunt-infrastructure-live-example Git precommit hook æ—¢ç„¶æ˜¯ code å“è³ªçš„åŸºç¤ï¼Œæ‡‰è©²æ¯æ¬¡ commit ä¹‹å‰éƒ½è§¸ç™¼æª¢æŸ¥ï¼Œé€™å€‹éšæ®µé©åˆä½¿ç”¨ git pre-commit hook å‰åŸ·è¡Œ\nhttps://github.com/antonbabenko/pre-commit-terraform\nä»¥ terragrunt-infrastructure-live-example ç‚ºä¾‹\nPR åœ¨æ­¤ å•Ÿç”¨å‰éœ€è¦ install remote script åˆ°æœ¬åœ° git add å¾Œï¼Œä½¿ç”¨ run ä¾†æ‰‹å‹•è§¸ç™¼ pre-commit hook æœƒæ ¹æ“š commit hook åŸ·è¡Œè…³æœ¬ï¼Œä»¥é€™é‚Šçš„ç¯„ä¾‹æœƒåŸ·è¡Œ id: terraform-fmt id: terraform-validate id: tflint id: terraform_checkov id: terrascan id: terraform_tfsec id: infracost_breakdown é™¤äº† fmt æœ‰èªªæ˜éä»¥å¤–ï¼Œå…¶ä»–çš„ tool æˆ‘å€‘å¾ŒçºŒå†èªªæ˜ pre-commit install pre-commit install pre-commit installed at .git/hooks/pre-commit pre-commit run å¦‚æœé€šé run æ¸¬è©¦ï¼Œå°±å¯ä»¥é€²è¡Œ git commit commit ä¹‹å‰æœƒåœ¨è·‘ä¸€æ¬¡ scriptï¼Œæ‰€ä»¥ç¨±ä½œ pre-commit hook å¦‚æœé€šéæ¸¬è©¦è®ŠåŒ–è‡ªå‹• commit å¦‚æœæ²’æœ‰é€šéï¼Œå‰‡é€€å›é€™æ¬¡ commit å¦‚æœæƒ³è¦è·³é pre-commit checkï¼Œå¯ä»¥ä½¿ç”¨ git commit â€“no-verify é€šéä¸Šè¿°æ­¥é©Ÿï¼Œä¾†ç¢ºä¿å·¥ç¨‹å¸«åœ¨æœ¬åœ°ç™¼å‡ºçš„ commit æœ‰ç¶“éåŸºç¤çš„é©—è­‰ï¼Œéå¸¸å€¼å¾—åœ˜éšŠå°å…¥\nGithub Action ","date":1663772141,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"8de2d22651c7a119d2c32206633f5cfb","permalink":"https://chechia.net/zh-hant/post/2022-09-21-14th-ithome-ironman-iac-aws-workshop-10-aws-cross-account-delegation-and-pre-commit-hook/","publishdate":"2022-09-21T22:55:41+08:00","relpermalink":"/zh-hant/post/2022-09-21-14th-ithome-ironman-iac-aws-workshop-10-aws-cross-account-delegation-and-pre-commit-hook/","section":"post","summary":"TODO èˆ‡é€²åº¦ root ä¸­è¨­å®š IAM User aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026 Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role iThome éµäººè³½å¥½è®€ç‰ˆ","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Aws Cross Account Delegation \u0026 pre-commit hook","type":"post"},{"authors":null,"categories":["terraform"],"content":"ä½¿ç”¨ aws module çš„å¥½è™• ç‚ºä½•è¨±å¤šé–‹æºçš„ terraform module å…§éƒ¨ä½¿ç”¨çš„éƒ½æ˜¯å…¶ä»–çš„ moduleï¼Œè€Œä¸æ˜¯å¾ resource å–®ä½é–‹å§‹ï¼Ÿ\nTerraform å®˜æ–¹æ–‡ä»¶ï¼Œå¦‚ä½•å»ºç«‹ module\nå¦‚ä½•å»ºç«‹ä¸€å€‹ module\næ ¹æ“šæœ€å¸¸å‡ºç¾çš„ä½¿ç”¨æƒ…åŠ‡èˆ‡éœ€æ±‚ å°ˆæ³¨æ–¼æ¥­å‹™çš„éœ€æ±‚èˆ‡æŠ½è±¡ï¼Œé›ƒå¾ŒæŠŠå¯¦ä½œ(terraform resource) åœ¨ module ä¸­çµ„åˆå¯¦ä½œå‡ºä¾† module ä¹Ÿéœ€è¦è€ƒæ…® resource ä¹‹é–“çš„ architecture ä¹Ÿè¦è€ƒæ…®åˆ°è§€ç¦®æ˜¯å¦æ–¹ä¾¿ï¼Ÿä½¿ç”¨ä¸Šæ˜¯å¦å®‰å…¨ï¼Ÿ ex. æˆ‘å€‘éœ€æ±‚æ˜¯ç”¢ç”Ÿä¸€å€‹ IAM User\næ­£å¸¸çš„å¯¦ä½œå°±æ˜¯å¯«ä¸€å€‹ resource.aws_iam_user é”æˆéœ€æ±‚ æ›´å¥½çš„å¯¦ä½œæ˜¯ï¼šé™¤äº† iam_user å¤–ï¼ŒåŠ ä¸Š ä¸€å®šæœƒéœ€è¦é…æ¬Šé™ï¼Œæ‡‰æ­é… iam_group + iam_policy pgp encrypt è®“è³‡æ–™æ›´å®‰å…¨ password_policy å¢åŠ å¯†ç¢¼å®‰å…¨ â€¦ç­‰ æ¯”èµ·å–®ä¸€ä¸€å€‹ iam_user æ€è€ƒçš„æ›´å…¨é¢ï¼Œæ›´æ¥è¿‘æœ€ä½³å¯¦è¸ åœ¨é€™æ¬¡çš„ Best Practice è¿½å°‹ä¹‹æ—…ä¸­ï¼Œæˆ‘å€‘æœƒå¸¶å¤§å®¶å»çœ‹å…¶ä»–åœ˜éšŠæ‰€å¯«å‡ºçš„ terraform module\nç›®å‰å·²ç¶“çœ‹äº† aws çš„ terraform module gruntwork çš„ terraform module design (æˆ‘å€‘æ²’çœ‹åˆ° private moduleï¼Œåªæ˜¯è·Ÿéš¨æ–‡ä»¶è‡ªå·±åˆ») é€™äº›æœ‰å¤šå¹´ä¼æ¥­è§£æ±ºæ–¹æ¡ˆç¶“é©—çš„åœ˜éšŠï¼Œå¯«å‡ºä¾†çš„ terraform module éƒ½æœƒè€ƒé‡è¨±å¤š security æ–¹é¢çš„å•é¡Œ é€™ä¹Ÿæ˜¯æˆ‘å€‘å‰åç¯‡éƒ½åœ¨å°ˆæ³¨çš„æ–¹å‘ ä¸€èˆ¬ä¾†èªªï¼Œä¸€å€‹å¥½ module æœƒå¸¶ä¾†å¾ˆå¤šå¥½è™•\nç²¾ç°¡ .tf codeï¼Œé€é terraform function èˆ‡åˆ¤æ–·å¼ä¾†ç”¢ç”Ÿ resource æ•´åˆä¸åŒ resource ä½¿ç”¨æ™‚è¦è¼¸å…¥çš„ input å¯ä»¥å¼•å°ä½¿ç”¨è€…çš„ architecture è¨­è¨ˆ èƒ½ç¬¦åˆéœ€æ±‚ï¼Œåƒæ•¸æ–¹ä¾¿ä½¿ç”¨ï¼Œå…§å®¹é‚è¼¯æ¸…æ¥šçš„ module å°±æ˜¯å¥½ module\nç„¶è€Œè¦å¯«å¥½ä¸€å€‹ module éœ€è¦å¾ˆå¤šç¶“é©—ï¼Œä¸åƒ…è¦å° aws å…ƒä»¶ï¼Œæ¶æ§‹éƒ½å¾ˆç†Ÿæ‚‰ï¼Œé‚„è¦è€ƒé‡ç®¡ç†èˆ‡å®‰å…¨ã€‚æˆ‘å€‘æœ‰æ©Ÿæœƒå†ä¾†åˆ†äº«ã€‚\nç‚ºä»€éº¼è¦èŠ±é€™éº¼å¤šæ™‚é–“è¬› account / iam / security çš„åŸºç¤è¨­å®šï¼Ÿ å› ç‚ºäººå®¶å¯«å‡ºä¾†çš„å°±æ˜¯é€™éº¼çš„å®‰å…¨ï¼Œé–‹é ­ç›´æ¥ç«‹æ–¼ä¸è¢«é§­ä¹‹åœ°\næ˜¨å¤©ä½¿ç”¨ reset root IAM user çš„å¯†ç¢¼ï¼Œä¸¦ä½¿ç”¨ pgp key åŠ å¯†ä¿è­·ï¼Œä»Šå¤©è¦é€²ä¸€æ­¥å¼·åŒ– IAM çš„å®‰å…¨æ€§ï¼ŒåŒ…æ‹¬\nå¼·åŒ– password policy å¢åŠ è·¨å¸³è™Ÿ iam role çš„ assume permission å¢åŠ  MFA æœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key root account password policy aws cross account iam role delegation root account MFA policy iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\npassword policy å¯†ç¢¼å¼·åº¦çš„é‡è¦æ€§ä¸éœ€è¦å†å¼·èª¿ï¼Œå¼·è¿« user ä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ä¸¦ä¸”å®šæœŸæ›´æ–°ï¼Œæ‰èƒ½å°‡åœ°å®‰å…¨é¢¨éšª æƒ³è¦é€é web console ä¿®æ”¹ password policy çš„æœ‹å‹å¯ä»¥çœ‹aws doc: setting account password policyã€‚æˆ‘å€‘é€™é‚Šæœƒä½¿ç”¨ terraform é…ç½®\nä¿®æ”¹ terragrunt-infrastructure-modules\næ³¨æ„ï¼šæ˜¨å¤©åœ¨ module.iam_user è¨­å®šçš„æ˜¯ login profile çš„ passwordï¼Œæ˜¯ç®¡ç†å“¡é…çµ¦ user çš„ç¬¬ä¸€æŠŠ passwordï¼Œä¸¦ä¸”ç™»å…¥å¾Œå¿…é ˆæ›´æ›å¯†ç¢¼ ä»Šå¤©è¦è¨­ç½®çš„æ˜¯ä¹‹å¾Œçš„é‡è¨­å¯†ç¢¼éƒ½è¦éµå¾ªçš„è¦ç¯„ å¦‚æœæƒ³è¦å¼·åŒ–å¯†ç¢¼ç®¡ç†\næ›´é•·çš„å¯†ç¢¼ æ›´å¤šé™åˆ¶ å®šæœŸæ›´æ–° é¦–å…ˆå…ˆæ›´æ”¹ terraform moduleï¼Œé–‹å•Ÿ password policy\nå¢åŠ  resource.aws_iam_account_password_policy å¢åŠ  input variableï¼Œå°‡ variable å¾€å¾ä¸Šå±¤ input variable æ¥é€²ä¾†ï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨æœ€ä¸Šå±¤èª¿æ•´ å¯ä»¥è¨­å®šå¯†ç¢¼å£½å‘½ï¼Œdefault 90 å¤© å¯ä»¥è¨­å®šæœ€å°å¯†ç¢¼é•·åº¦ï¼Œdefault 32 å­—å…ƒ å…¶ä»– policy åƒæ•¸éƒ½å¯«æ­»å›ºå®š éœ€è¦æ•¸å­—ï¼Œå¤§å°å¯«è‹±æ–‡ å…è¨±ä½¿ç”¨è€…åœ¨å¯†ç¢¼éæœŸå‰é‡è¨­å¯†ç¢¼ å¯†ç¢¼éæœŸå°±é–ä½å¸³è™Ÿä¸çµ¦ç™»å…¥ï¼Œè¦è«‹ admin ä¾† reset # aws_iam_account_password_policy.tf resource \u0026#34;aws_iam_account_password_policy\u0026#34; \u0026#34;strict\u0026#34; { allow_users_to_change_password = true minimum_password_length = var.minimum_password_length hard_expiry = true max_password_age = var.max_password_age require_lowercase_characters = true require_numbers = true require_uppercase_characters = true require_symbols = true password_reuse_prevention = 0 } # variables.tf variable \u0026#34;minimum_password_length\u0026#34; { type = number description = \u0026#34;The number of days that an user password is valid.\u0026#34; default = 32 } variable \u0026#34;max_password_age\u0026#34; { type = number description = \u0026#34;Minimum length to require for user passwords.\u0026#34; default = 90 } é€²è¡Œ terragrunt planï¼Œæ²’å•é¡Œçš„è©±å°±å¯ä»¥ç›´æ¥ apply\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # aws_iam_account_password_policy.strict will be created + resource \u0026#34;aws_iam_account_password_policy\u0026#34; \u0026#34;strict\u0026#34; { + allow_users_to_change_password = true + expire_passwords = (known after apply) + hard_expiry = true + id = (known after apply) + max_password_age = 90 + minimum_password_length = 32 + password_reuse_prevention = 0 + require_lowercase_characters = true + require_numbers = true + require_symbols = true + require_uppercase_characters = true } Plan: 1 to add, 0 to change, 0 to destroy. aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt apply æ³¨æ„æ›´æ”¹å¯†ç¢¼çš„å‰¯ä½œç”¨\nç”±æ–¼æ›´æ”¹ password policy æ˜¯æ•´å€‹ account é€šç”¨çš„ï¼Œæ‰€ä»¥ä¹Ÿæœƒå½±éŸ¿åˆ° administrator çš„ password é›–ç„¶å½±éŸ¿ passwordï¼Œä½†ä¸å½±éŸ¿ access keyï¼Œæ‰€ä»¥ terraform å¯ä»¥æ­£å¸¸å·¥ä½œ Apply passsword policy å¾Œï¼Œæˆ‘å€‘ä½¿ç”¨åŸå…ˆçš„å¯†ç¢¼èµ° aws web console ç™»å…¥çœ‹çœ‹\nå¯ä»¥ä½¿ç”¨ç¾æœ‰å¯†ç¢¼ç™»å…¥ å˜—è©¦å¾å³ä¸Šè§’ User -\u0026gt; security credentials -\u0026gt; change passwordï¼Œå¯ä»¥ç™¼ç¾æ–°çš„ password policy å·²ç¶“æ›´æ–°äº† æˆ‘å€‘ä¾¿æ‰‹å‹•æ›´æ”¹å¯†ç¢¼ï¼Œä»¥ç¬¦åˆæ–°çš„ password policy æ›´æ”¹å¯†ç¢¼å®Œæˆè¨˜å¾—å­˜åœ¨å¯†ç¢¼å„²å­˜å™¨ä¸­ å€‹äººç¿’æ…£è€•è²·å¯†ç¢¼å®Œæˆå¾Œï¼Œéƒ½é‡æ–°ç™»å…¥ï¼Œå†ç™»å…¥ä¸€æ¬¡ï¼Œç¢ºå®šå¯†ç¢¼æ­£ç¢ºï¼Œæ¬Šé™ä¹Ÿæ²’å•é¡Œ MFA for me æ¥è‘—æˆ‘å€‘å¯ä»¥ç‚ºè‡ªå·±çš„ IAM User å•Ÿç”¨ MFA è£ç½®\nåœ¨å³ä¸Šè§’ User -\u0026gt; security credentials -\u0026gt; MFA\né»é¸ Assign MFA Device é¸æ“‡ virtual MFA Deviceï¼Œæˆ‘å€‘é€™é‚Šç¤ºç¯„ä½¿ç”¨ google authenticator app ç•«é¢ä¸Šå‡ºç¾ MFA key çš„ QRcodeï¼Œé€™å€‹ QRcode == keyï¼Œä¸èƒ½æ´©æ¼ï¼Œé›¢é–‹é€™å€‹ç•«é¢å°±ä¸æœƒå†å‡ºç¾äº† ä½¿ç”¨ google authenticatorï¼Œæ–°å¢ä¸€çµ„ accountï¼Œç„¶å¾Œæƒæ QRCode åº•ä¸‹å¡«å…¥æ–° account ç”¢ç”Ÿçš„ 6 ä½æ•¸å­— token ç­‰å¾… 60 ç§’ åº•ä¸‹å¡«å…¥ç¬¬äºŒçµ„æ–° account ç”¢ç”Ÿçš„ 6 ä½æ•¸å­— tokenï¼Œç¢ºå®šçœŸçš„èƒ½å¤ å–å¾—æ­£ç¢ºçš„ token ä¹‹å¾Œæ¯æ¬¡ç™»å…¥éƒ½éœ€è¦è¼¸å…¥ MFA NOTE: é€™è£¡æ˜¯ IAM User login æ™‚éœ€è¦è¼¸å…¥ MFAï¼Œæˆ‘å€‘ä¹‹å¾Œæœƒè¨­å®š child account ä¸‹ iam-role assume æ™‚éƒ½éœ€è¦è¼¸å…¥ MFA\næ˜å¤©æœƒå‰åç¯‡çš„é‡é»ä¹‹ä¸€ï¼šcross account çš„ iam role é…ç½®\nTODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key root account password policy aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM â€¦","date":1663689674,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"997aec17b48e979502eb3a0c1f01b6e8","permalink":"https://chechia.net/zh-hant/post/2022-09-20-14th-ithome-ironman-iac-aws-workshop-09-terraform-module-and-password-security/","publishdate":"2022-09-21T00:01:14+08:00","relpermalink":"/zh-hant/post/2022-09-20-14th-ithome-ironman-iac-aws-workshop-09-terraform-module-and-password-security/","section":"post","summary":"ä½¿ç”¨ aws module çš„å¥½è™• ç‚ºä½•è¨±å¤šé–‹æºçš„ terraform module å…§éƒ¨ä½¿ç”¨çš„éƒ½æ˜¯å…¶ä»–çš„ moduleï¼Œè€Œä¸æ˜¯å¾ resource å–®ä½é–‹å§‹ï¼Ÿ\nTerraform å®˜æ–¹æ–‡ä»¶ï¼Œå¦‚ä½•å»ºç«‹ module\nå¦‚ä½•å»ºç«‹ä¸€å€‹ module\næ ¹æ“šæœ€å¸¸å‡ºç¾çš„ä½¿ç”¨æƒ…åŠ‡èˆ‡éœ€æ±‚ å°ˆæ³¨æ–¼æ¥­å‹™çš„éœ€æ±‚èˆ‡æŠ½è±¡ï¼Œé›ƒå¾ŒæŠŠå¯¦ä½œ(terraform resource) åœ¨ module ä¸­çµ„åˆå¯¦ä½œå‡ºä¾† module ä¹Ÿéœ€è¦è€ƒæ…® resource ä¹‹é–“çš„ architecture ä¹Ÿè¦è€ƒæ…®åˆ°è§€ç¦®æ˜¯å¦æ–¹ä¾¿ï¼Ÿä½¿ç”¨ä¸Šæ˜¯å¦å®‰å…¨ï¼Ÿ ex. æˆ‘å€‘éœ€æ±‚æ˜¯ç”¢ç”Ÿä¸€å€‹ IAM User","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Modules and password security","type":"post"},{"authors":null,"categories":["terraform"],"content":"æ˜¨å¤©è™•ç†å®Œ Accounting çš„ reset passwordï¼Œä»Šå¤©è¦ä¾† reset root account Administrator çš„æ¬Šé™\næœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nReset IAM root user Administrator Password ä¾ç…§ä¸Šé¢çš„æ­¥é©Ÿï¼Œæˆ‘å€‘ç¢ºå®šå¯ä»¥æ­£å¸¸ç™»å…¥ï¼Œæ–¼æ˜¯å¯ä»¥ä¾†å¯ä»¥æ–°å»º Administrator çš„ login profile\nç”±æ–¼ Administrator æœƒéœ€è¦ access keyï¼Œæ‰€ä»¥æˆ‘å€‘ä¹ŸæŠŠä»–è¨­æˆ true # terragrunt.hcl users = { Administrator = { groups = [\u0026#34;full-access\u0026#34;] pgp_key = \u0026#34;keybase:chechiachang\u0026#34; create_login_profile = true create_access_keys = true }, Accounting = { groups = [\u0026#34;billing\u0026#34;] pgp_key = \u0026#34;keybase:chechiachang\u0026#34; create_login_profile = true create_access_keys = false # accounting always use web console, won\u0026#39;t use access key } } è¨˜å¾—æ›´æ”¹ module/output.tfï¼Œå¢åŠ  secret key çš„ outputï¼Œè€Œä¸è¦åªç•™åœ¨ terraform state è£¡é¢\n# output.tf output \u0026#34;keybase_secret_key_decrypt_command\u0026#34; { description = \u0026#34;Decrypt access secret key command\u0026#34; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_secret_key_decrypt_command } } output \u0026#34;keybase_secret_key_pgp_message\u0026#34; { description = \u0026#34;Encrypted access secret key\u0026#34; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_secret_key_pgp_message } } è©¦è‘— plan ä¸€ä¸‹ï¼Œé æœŸ\nAdministrator æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„ login profile Administrator æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„ access key aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0] will be created + resource \u0026#34;aws_iam_access_key\u0026#34; \u0026#34;this\u0026#34; { + create_date = (known after apply) + encrypted_secret = (known after apply) + encrypted_ses_smtp_password_v4 = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + pgp_key = \u0026#34;keybase:chechiachang\u0026#34; + secret = (sensitive value) + ses_smtp_password_v4 = (sensitive value) + status = \u0026#34;Active\u0026#34; + user = \u0026#34;Administrator\u0026#34; } # module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_user_login_profile.this[0] will be created + resource \u0026#34;aws_iam_user_login_profile\u0026#34; \u0026#34;this\u0026#34; { + encrypted_password = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 + password_reset_required = false + pgp_key = \u0026#34;keybase:chechiachang\u0026#34; + user = \u0026#34;Administrator\u0026#34; } Plan: 2 to add, 0 to change, 0 to destroy. Changes to Outputs: + iam_access_key_id = { + Accounting = \u0026#34;\u0026#34; + Administrator = null -\u0026gt; (known after apply) } ~ keybase_password_decrypt_command = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } ~ keybase_password_pgp_message = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } + keybase_secret_key_decrypt_command = { + Accounting = null + Administrator = (known after apply) } + keybase_secret_key_pgp_message = { + Accounting = null + Administrator = (known after apply) } ç¬¦åˆé æœŸ!! å¯å–œå¯è³€\nä½†æ˜¯æˆ‘å€‘å·²ç¶“æœ‰ access key åœ¨ä½¿ç”¨äº†ï¼Œæˆ‘åˆä¸æƒ³è¦èµ° day 3 aws-vault add key çš„æ­¥é©Ÿæ›ä¸€çµ„æ–°çš„ï¼Œé€™æ™‚è©²æ€è¾¦\næ²’éŒ¯ï¼Œæˆ‘å€‘å¯ä»¥åƒ Day3 ä¸€æ¨£ï¼Œä½¿ç”¨ import åŒ¯å…¥å·²ç¶“å­˜åœ¨çš„ resource åˆ° address è£¡é¢\ngoogle â€œterraform aws iam user access keyâ€ï¼Œæ‰¾åˆ° aws iam user access key çš„èªªæ˜é é¢ address æ˜¯ module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0] access key ID å¯ä»¥åœ¨å¯†ç¢¼ç®¡ç†å™¨æŸ¥çœ‹ æˆ–æ˜¯åœ¨ aws web console -\u0026gt; IAM -\u0026gt; User -\u0026gt; Administrator -\u0026gt; Security Credential -\u0026gt; Access Keys æŸ¥åˆ° aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import \u0026#39;module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0]\u0026#39; AKIA1234567890 module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0]: Importing from ID \u0026#34;AKIA2I2H7ERWKI4RIF4Z\u0026#34;... module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0]: Import prepared! Prepared aws_iam_access_key for import module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0]: Refreshing state... [id=AKIA2I2H7ERWKI4RIF4Z] Import successful! The resources that were imported are shown above. These resources are now in your Terraform state and will henceforth be managed by Terraform. Releasing state lock. This may take a few moments... é †ä¾¿ login profile ä¹Ÿ import è¿‘ä¾†\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import \u0026#39;module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_user_login_profile.this[0]\u0026#39; Administrator å†æ¬¡ plan å°±ä¸éœ€è¦æ–°å»ºä¸€æŠŠ access key äº†â€¦å§ï¼Ÿï¼\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create -/+ destroy and then create replacement Terraform will perform the following actions: # module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_access_key.this[0] must be replaced -/+ resource \u0026#34;aws_iam_access_key\u0026#34; \u0026#34;this\u0026#34; { ~ create_date = \u0026#34;2022-09-16T13:05:35Z\u0026#34; -\u0026gt; (known after apply) + encrypted_secret = (known after apply) + encrypted_ses_smtp_password_v4 = (known after apply) â€¦","date":1663689407,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"2a383c951b1367a21cd12cdeb545d392","permalink":"https://chechia.net/zh-hant/post/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/","publishdate":"2022-09-20T23:56:47+08:00","relpermalink":"/zh-hant/post/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/","section":"post","summary":"æ˜¨å¤©è™•ç†å®Œ Accounting çš„ reset passwordï¼Œä»Šå¤©è¦ä¾† reset root account Administrator çš„æ¬Šé™\næœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026 pgp key iThome éµäººè³½å¥½è®€ç‰ˆ","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Reset Iam User Administrator","type":"post"},{"authors":null,"categories":["terraform"],"content":"æ˜¨å¤©æˆ‘å€‘å»ºç«‹ IAM Group èˆ‡ policyï¼Œä¸¦èªªæ˜ policy ç®¡ç†åŸå‰‡ã€‚\nç„¶è€Œæ˜¨å¤©æœ€å¾Œå‰µå»º user æ™‚ï¼Œæˆ‘å€‘é—œé–‰äº† create_login_profile = false çš„é¸é … é€™æ˜¯ç‚ºäº†é¿å…ç•¶å‰çš„ç™»å…¥æ©Ÿåˆ¶è¢«è¦†è“‹æ‰ï¼Œå½±éŸ¿ root account Administrator çš„ä½¿ç”¨ æ›´æ”¹ login æ–¹å¼ï¼Œåœ¨æŸäº›æ¥µç«¯çš„æƒ…å½¢ä¸‹ï¼Œæœ‰å¯èƒ½è®“ Administrator è‡ªå·±è¦†è“‹è‡ªå·±çš„ login è¨­å®šå¾Œï¼Œè®“è‡ªå·±ç„¡æ³•ç™»å…¥ å¦‚æœä½ æ˜¯ç®¡ç†å“¡ï¼Œåœ¨æ›´æ”¹ admin å¸³è™Ÿçš„æ¬Šé™èˆ‡ç™»å…¥è¨­å®šæ™‚ï¼Œä¸€å®šè¦å¤šåŠ æ³¨æ„\nå¦‚æœä¸å¹¸æ”¹å£ï¼Œç„¡æ³•ç™»å…¥ï¼Œå°±åªèƒ½å†å»æ‰¾å‡º root account root user å¸³è™Ÿä¾†è§£æ•‘äº† å¦‚æœæ˜¯ root account root user æŠŠè‡ªå·±çš„ login æ”¹å£ï¼Œå°±æœƒå¾ˆç—›è‹¦ï¼Œè¦è«‹ aws support ä¾†æ•‘ä½  æœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nEnhance User Login Security Gruntwork Guide åœ¨å®Œæˆ group èˆ‡ policy è¨­å®šå¾Œï¼Œä¸‹ä¸€å€‹éœ€è¦åšçš„æ˜¯åŠ å¼· user ç™»å…¥çš„å®‰å…¨æ€§\néœ€è¦åšçš„äº‹æƒ…æœ‰\nå•Ÿç”¨ MFA policy è¨­å®šåš´æ ¼çš„ password policy å»ºç«‹ login profile: password å¾Œï¼Œä½¿ç”¨å„å€‹æˆå“¡çš„ gpg key åŠ å¯† (encrypt) passwordï¼Œåªæœ‰æˆå“¡è‡ªå·±å¯ä»¥è§£é–‹è‡ªå·±çš„ password MFA Policy Multi-factor authentication æ˜¯å¸¸ç”¨çš„èªè­‰æ–¹å¼\nåœ¨ä½¿ç”¨ AWS API çš„æ™‚å€™ï¼Œé™¤äº†å¸³è™Ÿå¯†ç¢¼ / access key ä»¥å¤–ï¼Œéœ€è¦ç¬¬äºŒå±¤ç™»å…¥è£ç½®åšé©—è­‰ AWS æ”¯æ´è¨±å¤šä¸åŒå½¢å¼çš„ MFA è£ç½® è™›æ“¬çš„ MFA è£ç½® ex. è·Ÿ google authenticator ä¸€èµ·ä½¿ç”¨ ç¡¬é«”çš„ MFA è£ç½® ex. ç¬¦åˆ FIDO2 æ¨™æº–çš„ YubiKey ç­‰ç­‰ æœ¬ workshop æœƒå¯¦ä½œè™›æ“¬çš„ MFA è£ç½®ï¼Œè®“ä½¿ç”¨è€…ä½¿ç”¨ Google Authenticator ç™»å…¥æ‰èƒ½ä½¿ç”¨ API ç„¶è€Œ å¦‚ Gruntwork Guide åœ¨ MFA Policyæ‰€è¿°ï¼Œè¦ enforce MFA åˆ°æ‰€æœ‰çš„ AWS API æœƒæœ‰è«¸å¤šå›°é›£\nå¦‚æœæˆ‘å€‘è¦æ±‚æ‰€æœ‰ AWS API éƒ½é MFAï¼Œæœ‰äº›ä¾†æºå¯èƒ½å¾ˆé›£åš MFA ex. EC2 VM ä¸Šçš„ä¸€å€‹ application ä¹Ÿéœ€è¦æ‰“ AWS APIï¼Œä½†åœ¨ VM ä¸Šå°±å¾ˆé›£å–å¾— Google Authenticator çš„èªè­‰ç¢¼ ex. æ–°çš„ IAM User å‰›æ–°å»ºï¼Œæ²’æœ‰ MFAï¼Œä¹Ÿå°±ç„¡æ³•ç™»å…¥è¨­å®šè‡ªå·±çš„ MFAï¼Œè®Šæˆé›ç”Ÿè›‹è›‹ç”Ÿé› Gruntwork Guide ä¸­å»ºè­°åœ¨ä»¥ä¸‹æƒ…å¢ƒä¸­å•Ÿç”¨ MFA å°±å¥½\nsecurity ä»¥å¤–çš„ child-account (dev/stag/prod) çš„æ‰€æœ‰ iam-role éƒ½é–‹å•Ÿ MFA ç•¶æˆ‘å€‘è¦ä½¿ç”¨ security/iam-user assuem åˆ°å¦å¤–ä¸€å€‹ account/iam-role æ™‚ï¼Œéœ€è¦ MFA èªè­‰æ‰å¯ assume role ç„¶å¾ŒæŠŠ security ä»¥å¤–çš„ child-account é–‹å•Ÿ global çš„ trust policy ï¼Œé€™æ¨£è¨­å®šå°±å¾ˆå–®ç´” ä¸æœƒ block iam-user ç™»å…¥ï¼Œå› ç‚ºæ‰€æœ‰ user éƒ½åœ¨ security åº•ä¸‹ï¼Œå…¶ä»– child-account æ²’æœ‰ user åœ¨ root èˆ‡ security account å…§ï¼Œæ‰æœ‰ IAM User èˆ‡ IAM Groupï¼Œåœ¨é€™é‚Šå•Ÿç”¨ MFA å°‡ MFA ä¾æ“š policy å»è¨­å®šï¼Œé€é policy - group - user å» enforce user ä½¿ç”¨ MFA æ–° user å»ºç«‹æ™‚ï¼Œéœ€è¦é¡å¤–å»ºç«‹ â€œself-managementâ€ permissions policyï¼Œè®“æ–°ç”¨æˆ¶å¯ä»¥ä¸ç”¨ MFAï¼Œé€²è¡Œç¬¬ä¸€æ¬¡çš„ MFA è¨­å®š Password Policy Password Policy æŒ‡çš„æ˜¯å°æ–¼ user è‡ªå·±è¨­å®šçš„å¯†ç¢¼è¦ç¬¦åˆä¸€å®šçš„è¦ç¯„\nAWS official doc: å¦‚ä½•è¨­å®š password policy ex. å¯†ç¢¼è‡³å°‘è¦ 32 å­—å…ƒé•·åº¦ ex. å¯†ç¢¼è¦åŒ…å«è‹±æ–‡ï¼Œæ•¸å­—ï¼Œå¤§å°å¯«ï¼Œæˆ–ç‰¹æ®Šå­—å…ƒ ex. å¯†ç¢¼å¤šä¹…éœ€è¦æ›´æ–°ä¸€æ¬¡ é€™äº› password policy å¯ä»¥å¤§å¹…å¼·åŒ–æ‰€æœ‰ User çš„å¯†ç¢¼å®‰å…¨æ€§ ç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„ external module terraform-aws-iam å·²ç¶“æ•´åˆäº† password policyï¼Œæ‰€ä»¥æˆ‘å€‘é€™é‚Šç›´æ¥åœ¨ input ä¸­é–‹å•Ÿå³å¯ä»¥ä½¿ç”¨\nPGP key pgp (Pretty Good Privacy) æ˜¯éå¸¸å¸¸ç”¨çš„éå°ç¨±åŠ å¯†å·¥å…·\næ¯”è¼ƒå¸¸ç”¨çš„å·¥å…·å¦‚ OpenPGP æˆ–æ˜¯ gpg (GnuPG) ç‚ºä½• iam user å‰µå»ºæœƒç‰½æ‰¯åˆ° pgpï¼Ÿ\nä¸ç®¡æ˜¯ gruntwork module æˆ–æ˜¯ aws terraform-aws-iam module éƒ½æ”¯æ´ pgp åœ¨ admin æ–°å»º User èˆ‡ login profile å¾Œï¼Œaws api ç”¢ç”Ÿ passwordï¼Œå›å‚³çµ¦ admin terraformï¼Œé€™æ™‚ admin éœ€è¦æŠŠç¬¬ä¸€æŠŠ password å‚³çµ¦ userï¼Œè®“ user åšç¬¬ä¸€æ¬¡ç™»å…¥ é€™æ•´å€‹å‚³ééç¨‹ï¼Œä¸ç®¡å¾ aws api -\u0026gt; terraform state -\u0026gt; terraform output -\u0026gt; admin -\u0026gt; userï¼Œå¦‚æœæ˜¯æ˜ç¢¼æœªåŠ å¯†çš„ç‹€æ…‹ä¸‹ï¼Œå¯¦åœ¨ä¸å®œå‚³éï¼Œå¾ˆæœ‰å¯èƒ½è¢«æœ‰å¿ƒä¸­ä¸­é€”æ””æˆª å› æ­¤æˆ‘å€‘å¯ä»¥ä½¿ç”¨ pgp ç›¸é—œå·¥å…·ä¾†åŠ å¯† admin ä»¥ gpg(GnuPG) ç‚ºä¾‹éå°ç¨±åŠ å¯† (local exposure)\nadmin å–å¾—æ–° user (ex. accounting äººå“¡) çš„ gpg public key admin ç”¢ç”Ÿ user password å¾Œï¼Œä½¿ç”¨ gpg å·¥å…·ï¼Œä»¥ account äººå“¡çš„ public key åŠ å¯† password ç²å¾—ä¸€ä¸² encrypted textï¼Œå‚³çµ¦ accounting äººå“¡ accounting äººå“¡ä½¿ç”¨è‡ªå·±çš„ private key ç”¨ gpg å·¥å…·è§£å¯†ï¼Œå³å¯å–å¾—æ˜ç¢¼ password åªæœ‰æœ‰ private key çš„äººå¯ä»¥è§£é–‹ encrypted text accounting äººå“¡ä½¿ç”¨ password ç™»å…¥å¾Œï¼Œæœƒå› ç‚º login profile è¦æ±‚ï¼Œè€Œè¢«è¿«æ›´æ”¹æ–°å¯†ç¢¼ï¼Œæ¨æ£„ admin local æœ‰æ›éšªéçš„ password ä¸Šé¢çš„åšæ³• terraform state èˆ‡ admin local æœƒçœ‹åˆ°æ˜ç¢¼ passwordï¼Œä¸å¤ å®‰å…¨ã€‚\nPGP \u0026amp; keybase.io aws æä¾›ä¸€å€‹æ”¹é€²çš„åšæ³•ï¼Œterraform state åªå­˜ encrypted text\né€™æ¨£å¯ä»¥é¿å…åœ¨ terraform state ä¸­èˆ‡ admin local çš„ password æ›éšª pre-requisite\ngpg tool keybase.io è¨»å†Š å®‰è£ gpg\nsudo port install gpg gpg --version å¦‚æœç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå¯ä»¥å‰µå»ºä¸€å° key pair\ngpg --full-generate-key åˆ—å‡ºè‡ªå·±æœ‰çš„ secret key (private key)\ngpg --list-secret-keys --keyid-format=long export public key\ngpg --armor --export 3AA5C34371567BD2 -----BEGIN PGP PUBLIC KEY BLOCK----- mQINBF9oN7ABEADeJ5BO3RsvfB0RpU3ZtI3AZmLmMfoaQ41QtkLoFEhF0XnSBNhH .... ARFfAR39B4hHAnA+/+scVFdGT8i9kuYxk8Ocb7zHgULrOBfKEPEQ5XLmdiqAD+DN jO2IFPM= -----END PGP PUBLIC KEY BLOCK----- NOTE: private key æ˜¯é‘°åŒ™ï¼Œpublic key æ˜¯é–é ­ï¼Œæ°¸é ä¸è¦æŠŠ private key å‚³å‡ºå»ï¼Œè€Œæ˜¯æŠŠ public key å‚³å‡ºå»è®“åˆ¥äººåŠ å¯†ï¼Œç”¨ public key åŠ å¯†éçš„æ±è¥¿ï¼Œåªèƒ½ç”¨æ‰‹ä¸Šé€™æŠŠ private key è§£é–‹ï¼Œä¹Ÿå°±æ˜¯å°ˆå±¬ä½ çš„\nåœ¨ keybase.io ä¸Šé¢è¨»å†Šå¾Œï¼Œä¸Šå‚³ä½ çš„ pgp public key\nä¾ç…§æŒ‡ç¤ºå®Œæˆæ­¥é©Ÿ (optional) èªè­‰ github / domain / å…¶ä»–ç¶²ç«™è®“å…¶ä»–äººç¢ºå®šé€™å€‹æ˜¯ä½ æœ¬äºº å¯¦éš›æ“ä½œï¼špassword policy \u0026amp; pgp key NOTE: å¦‚æœä¸å•Ÿç”¨ pgp-keyï¼Œadmin terraform apply æ–° user å¾Œæ‹¿åˆ°çš„ password å°±æœƒæ˜¯æ˜ç¢¼ï¼Œå¯ä»¥é€é gpg å·¥å…·åŠ å¯†ï¼Œåœ¨é€éç¶²è·¯å‚³çµ¦å°æ–¹\né€™é‚Šæˆ‘å€‘å…ˆä½¿ç”¨ Accounting å…ˆåšæ¸¬è©¦ï¼Œå•Ÿç”¨ login profile\nNOTE: ä½ çŸ¥é“è‡ªå·±æ˜¯ adminï¼Œå°±è«‹ä¸è¦æ‹¿è‡ªå·±çš„ User åšæ¸¬è©¦ï¼Œå£äº†å¾ˆéº»ç…©\nå°‡ terragrunt.hcl æ”¹æˆ\nAccounting = { groups = [\u0026#34;billing\u0026#34;] pgp_key = \u0026#34;keybase:chechiachang\u0026#34; create_login_profile = true create_access_keys = false # accounting always use web console, won\u0026#39;t use access key } } æ¥è‘—è¦æ”¹ module ä¸­çš„ codeï¼Œå°‡ module çš„ output æ¥å‡ºä¾†åˆ°ä¸Šå±¤çš„ root module\noutput.tf\n# https://github.com/terraform-aws-modules/terraform-aws-iam/blob/master/modules/iam-user/outputs.tf output \u0026#34;keybase_password_pgp_message\u0026#34; { description = \u0026#34;Encrypted password\u0026#34; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_password_pgp_message } } output \u0026#34;keybase_password_decrypt_command\u0026#34; { description = \u0026#34;Decrypt user password command\u0026#34; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_password_decrypt_command } } ç„¶å¾Œæˆ‘å€‘è©¦è‘— plan\né æœŸï¼šç”¢ç”Ÿ accounting login profileï¼Œç”¢ç”Ÿ pgp encrypted password text (è€Œä¸æ˜¯æ˜ç¢¼ password) aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform will perform the following actions: # â€¦","date":1663669806,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"6f5b87cae3d99396b95c73ccf8087ddb","permalink":"https://chechia.net/zh-hant/post/2022-09-18-14th-ithome-ironman-iac-aws-workshop-07-reset-iam-user/","publishdate":"2022-09-20T18:30:06+08:00","relpermalink":"/zh-hant/post/2022-09-18-14th-ithome-ironman-iac-aws-workshop-07-reset-iam-user/","section":"post","summary":"æ˜¨å¤©æˆ‘å€‘å»ºç«‹ IAM Group èˆ‡ policyï¼Œä¸¦èªªæ˜ policy ç®¡ç†åŸå‰‡ã€‚\nç„¶è€Œæ˜¨å¤©æœ€å¾Œå‰µå»º user æ™‚ï¼Œæˆ‘å€‘é—œé–‰äº† create_login_profile = false çš„é¸é … é€™æ˜¯ç‚ºäº†é¿å…ç•¶å‰çš„ç™»å…¥æ©Ÿåˆ¶è¢«è¦†è“‹æ‰ï¼Œå½±éŸ¿ root account Administrator çš„ä½¿ç”¨ æ›´æ”¹ login æ–¹å¼ï¼Œåœ¨æŸäº›æ¥µç«¯çš„æƒ…å½¢ä¸‹ï¼Œæœ‰å¯èƒ½è®“ Administrator è‡ªå·±è¦†è“‹è‡ªå·±çš„ login è¨­å®šå¾Œï¼Œè®“è‡ªå·±ç„¡æ³•ç™»å…¥ å¦‚æœä½ æ˜¯ç®¡ç†å“¡ï¼Œåœ¨æ›´æ”¹ admin å¸³è™Ÿçš„æ¬Šé™èˆ‡ç™»å…¥è¨­å®šæ™‚ï¼Œä¸€å®šè¦å¤šåŠ æ³¨æ„\nå¦‚æœä¸å¹¸æ”¹å£ï¼Œç„¡æ³•ç™»å…¥ï¼Œå°±åªèƒ½å†å»æ‰¾å‡º root account root user å¸³è™Ÿä¾†è§£æ•‘äº† å¦‚æœæ˜¯ root account root user æŠŠè‡ªå·±çš„ login æ”¹å£ï¼Œå°±æœƒå¾ˆç—›è‹¦ï¼Œè¦è«‹ aws support ä¾†æ•‘ä½  æœ¬æ—¥é€²åº¦","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Reset Iam User","type":"post"},{"authors":null,"categories":["terraform"],"content":"æ˜¨å¤©æˆ‘å€‘å°‡ root account IAM user import åˆ° terraform ä¸­\nç¤ºç¯„ terraform import å¢åŠ  iam user çš„åŠŸèƒ½åˆ° module repository ä¸­ ä»Šå¤©è¦å®Œæˆ root account ä¸­ IAM Group + Policyï¼Œé †ä¾¿èŠèŠ aws IAM policy ç®¡ç†åŸå‰‡\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\næ‰¿æ¥æ˜¨å¤©çš„ plan çµæœï¼Œæˆ‘å€‘ä»Šå¤©è¦æŠŠ IAM policy èˆ‡ group é–‹å‡ºä¾†\nIam User é¦–å…ˆ review aws_iam_user çš„ resource\n# module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_user.this[0] will be updated in-place ~ resource \u0026#34;aws_iam_user\u0026#34; \u0026#34;this\u0026#34; { + force_destroy = true id = \u0026#34;Administrator\u0026#34; name = \u0026#34;Administrator\u0026#34; tags = {} # (4 unchanged attributes hidden) }` force_destroy é€™å€‹åƒæ•¸æˆ‘å€‘éœ€è¦å—ï¼Ÿå¯ä»¥ä¸€æ‰¾ä»¥ä¸‹çš„æ­¥é©ŸæŸ¥æ–‡ä»¶åˆ¤æ–·\nç›´æ¥ google â€œterraform aws iam userâ€ï¼Œæ‰¾åˆ° Terraform registry ä¸Š AWS iam user çš„èªªæ˜ é€™è£¡æœ‰èªªæ˜ï¼Œåˆªé™¤ user æ™‚ï¼Œå¦‚æœæœ‰ non-terraform-managed çš„ access key, login profile, MFA devicesï¼Œæ˜¯å¦ä»è¦å¼·åˆ¶åˆªé™¤ é€™è£¡æˆ‘å€‘å¸Œæœ›å¦‚æœæœ‰ access key æˆ– MFA device å­˜åœ¨çš„è©±ï¼Œä¸è¦ç›´æ¥åˆªé™¤ User å°‡ https://github.com/chechiachang/terragrunt-infrastructure-modules/pull/1/files#diff-b15a741b1129d8f5451060653922d85c934792a1dd41c7fae1b02f3a6398094aR8 æ”¹æˆ false Iam Group \u0026amp; Policy ä»Šå¤©è¦ä¾†èª¿æ•´ Iam Group \u0026amp; Policy\nGruntwork æ–‡ä»¶: Root Account èªªæ˜ï¼Œroot account ä¸‹æ‡‰è©²æœ‰å…©å€‹ policy group group/full-access çµ¦äºˆ root account è¶…ç´šç®¡ç†å“¡å®Œæ•´çš„æ§åˆ¶æ¬Šé™ billing çµ¦äºˆ billing çš„æœƒè¨ˆäººå“¡é€²ä¾†å ±å¸³ é¦–å…ˆ full-access çš„ iam_group plan å¾Œçš„çµæœå¦‚ä¸‹\nç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„ module æ˜¯ terraform-aws-iam çš„ group with policies module.iam_group_with_policies_full_access è£¡é¢æœ‰ group ä¹Ÿæœ‰ policy .aws_iam_group.this[0] æ˜¯ä¸»è¦çš„ group # module.iam_group_with_policies_full_access.aws_iam_group.this[0] will be created + resource \u0026#34;aws_iam_group\u0026#34; \u0026#34;this\u0026#34; { + arn = (known after apply) + id = (known after apply) + name = \u0026#34;full-access\u0026#34; + path = \u0026#34;/\u0026#34; + unique_id = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_group_membership.this[0] will be created + resource \u0026#34;aws_iam_group_membership\u0026#34; \u0026#34;this\u0026#34; { + group = (known after apply) + id = (known after apply) + name = \u0026#34;full-access\u0026#34; + users = [ + \u0026#34;Administrator\u0026#34;, ] } æœ‰äº† groupï¼Œæ¥ä¸‹ä¾†å°±æ˜¯è¦é… policy\nä¸€æ¨£é€é group + policy -\u0026gt; attachment çš„ resourceï¼ŒæŠŠ group è·Ÿ policy ç¶åœ¨ä¸€èµ· æˆ‘å€‘é€™é‚Šçš„ç¨‹å¼ç¢¼ ç›´æ¥ä½¿ç”¨ aws é å…ˆå®šç¾©å¥½çš„ policy arn:aws:iam::aws:policy/AdministratorAccess # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.custom_arns[0] will be created + resource \u0026#34;aws_iam_group_policy_attachment\u0026#34; \u0026#34;custom_arns\u0026#34; { + group = (known after apply) + id = (known after apply) + policy_arn = \u0026#34;arn:aws:iam::aws:policy/AdministratorAccess\u0026#34; } IAM AWS é å…ˆå®šç¾©çš„ policy æœ‰å“ªäº› aws å·²ç¶“é å…ˆå®šç¾©å¥½çš„ policy å¯ä»¥ä½¿ç”¨ï¼Ÿ\nå¯ä»¥ä¸Š aws web console -\u0026gt; iam -\u0026gt; policies ä¸‹æŸ¥è©¢ é€™äº›é å…ˆå®šç¾©çš„ policyï¼Œæ˜¯ aws ä¾ç…§æœ€å¸¸å‡ºç¾çš„ä½¿ç”¨æƒ…å¢ƒï¼Œäº‹å…ˆå»ºç«‹çš„ policy\nä½¿ç”¨è€…ä¸ç”¨å†å»ºè­° ex. AWS è¦ºå¾— administrator å¤§æ¦‚æœƒéœ€è¦é€™äº›æ¬Šé™ï¼Œéƒ½å…ˆé–‹åˆ°é€™å€‹ policy/admin ä¸Š ex. AWS è¦ºå¾— billing å¤§æ¦‚æœƒéœ€è¦é€™äº›æ¬Šé™ï¼Œéƒ½å…ˆé–‹åˆ°é€™å€‹ policy/billing ä¸Š ç”±æ–¼æ˜¯ AWS ä¾ç…§å¤§éƒ¨åˆ†äººçš„éœ€æ±‚é–‹çš„ policyï¼Œæ‰€ä»¥æœƒå¤šé–‹è¨±å¤šæ¬Šé™ é€™ä¹Ÿæ˜¯ç”¨é å…ˆå®šç¾© policy çš„ç¼ºé»ï¼Œå°±æ˜¯ç‚ºäº†æ»¿è¶³å¾ˆå¤šäººçš„éœ€æ±‚ï¼Œæ¬Šé™å¤ªå¤§ é•åæœ€å°æ¬Šé™åŸå‰‡ï¼Œçµ¦äºˆæ¬Šé™éå¤šä¹Ÿé€ æˆå®‰å…¨æ€§çš„é¢¨éšª ä¸ä½¿ç”¨é å…ˆå®šç¾©çš„ policy çš„è©±ï¼Œæˆ‘å€‘å¯ä»¥è‡ªå·±å¯« policy\nä¸€å€‹ policy é–‹å‡ºä¾† default æ²’æœ‰ä»»ä½• permission ä¾æ“šæœ€å°æ¬Šé™åŸå‰‡ï¼Œä¸€å¥ä¸€å¥å¢åŠ  permission åˆ° policy ä¸Š å¦‚æ­¤å¯ä»¥ç¢ºä¿ policy ä¸Šçš„ permission éƒ½æ˜¯éœ€è¦çš„ï¼Œè€Œä¸æœƒæœ‰å¤šé–‹ä½†æ˜¯ç”¨ä¸åˆ°çš„æ¬Šé™ æ¬Šé™æ„ˆå¤§ï¼Œå®‰å…¨æ€§é¢¨éšªè¶Šé«˜ï¼Œæ‰€ä»¥æœ€ä½³å¯¦è¸æœƒå¸Œæœ›æ‰€æœ‰ policy éƒ½æ˜¯é…å¾—å‰›å‰›å¥½å¤ ç”¨å°±å¥½\nç„¶è€Œé… policy å¾ˆèŠ±æ™‚é–“ï¼Œç”¨ aws å·²ç¶“å¯«å¥½çš„ policy é¦¬ä¸Šå¯ä»¥ç”¨ å¯¦å‹™ä¸Šå¯ä»¥è€ƒé‡å°ˆæ¡ˆæ™‚é–“èˆ‡æ•´é«”äººåŠ›ï¼Œä»¥åŠéœ€è¦çš„å®‰å…¨ç­‰ç´šï¼Œä¾†è€ƒæ…®è¦ä¸è¦åšåˆ°é€™éº¼ç´° AWS policy access advisor é€šå¸¸å¯« policy å¾ˆé›£é…åˆ°éå¸¸å®Œç¾å‰›å‰›å¥½ï¼Œé€šå¸¸éƒ½æœƒå¤šé–‹ permission\næ¬Šé™å¤šé–‹åŠŸèƒ½ä¸æœƒå£ï¼Œå°‘é–‹ç›´æ¥ permission denied é‚£å¤šé–‹çš„æ¬Šé™æ²’æœ‰ç”¨åˆ°ï¼Œä¹‹å¾Œè¦å¦‚ä½•æŠŠæ²’æœ‰ç”¨åˆ°çš„æ¬Šé™æ”¶å›ä¾†ï¼Ÿ AWS web console æä¾›æ ¹æ“šä½¿ç”¨ç´€éŒ„ï¼Œæå»ºè­°ä¿®æ”¹ policy\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_access-advisor.html\naws æœƒçµ±è¨ˆå„å€‹ IAM å…ƒä»¶ï¼Œå­˜å– AWS API ä½¿ç”¨/æ²’ä½¿ç”¨çš„æ¬Šé™\nä¾‹å¦‚é€™å€‹ User éå» 90 å¤©ä½¿ç”¨äº†å“ªäº› permission å»æ‰“ API ä»¥åŠ User é‚„æœ‰å“ªäº› policy permissionï¼Œæ˜¯éå» 90 å¤©éƒ½æ²’æœ‰ç”¨åˆ°çš„ é€™äº›é•·æ™‚é–“éƒ½æ²’æœ‰ç”¨åˆ°çš„ policyï¼Œæˆ‘å€‘å°±æ‡‰è©²å®šæœŸ reviewï¼Œç„¶å¾Œç§»é™¤é€™äº›ä¸å¿…è¦çš„æ¬Šé™\nUser / Group / â€¦ ç­‰ç­‰éƒ½éœ€è¦åšä¸€æ¨£çš„äº‹æƒ… module ä½œç‚ºä¸€å€‹çµ„æˆå…ƒä»¶ä½¿ç”¨ ç”±æ–¼æˆ‘å€‘åœ¨ module input ä¸­é–‹å•Ÿäº† attach_iam_self_management_policy = true åƒæ•¸ï¼Œåœ¨ module ä¸­ä¾¿é€£å¸¶ç”¢ç”Ÿ\n.aws_iam_policy.iam_self_management[0]ï¼Œè£¡é¢å®šç¾©çš„è¦åš self management æ‰€éœ€è¦çš„ permission å†æŠŠ policy é€é .aws_iam_group_policy_attachment.iam_self_management[0] ç¶åˆ° group ä¸Š # module.iam_group_with_policies_full_access.aws_iam_policy.iam_self_management[0] will be created + resource \u0026#34;aws_iam_policy\u0026#34; \u0026#34;iam_self_management\u0026#34; { ... } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.iam_self_management[0] will be created + resource \u0026#34;aws_iam_group_policy_attachment\u0026#34; \u0026#34;iam_self_management\u0026#34; { + group = (known after apply) + id = (known after apply) + policy_arn = (known after apply) } ä¸Šé¢å°±æ˜¯æˆ‘å€‘çš„ root account group/full-access èˆ‡å°æ‡‰çš„ policy\nbilling account æ¥è‘—æ˜¯ root account group/full-access èˆ‡å°æ‡‰çš„ policy\næˆ‘å€‘å¯ä»¥è‡ªå·±æ‰‹å¯« policyï¼Œä¾ç…§æœ€å°æ¬Šé™åŸå‰‡ï¼Œä¸€æ¢ä¸€æ¢åŠ å…¥ permission æˆ–æ˜¯æˆ‘å€‘å¯ä»¥ä¸Š aws web console æ‰¾çœ‹çœ‹æœ‰ç„¡é å…ˆå®šç¾©å¥½çš„ policy æˆ‘å€‘æœå°‹ billing æœ‰çœ‹åˆ°å››å€‹ policyï¼Œæ¯å€‹ policy éƒ½æœ‰é™„ä¸Š description èªªæ˜ä½¿ç”¨çš„ç›®çš„\nBilling AWSBillingConductorReadOnlyAccess AWSBillingConductorFullAccess AWSBillingReadOnlyAccess é€™è£¡å°±è¦ä¾æ“šä½¿ç”¨çš„éœ€æ±‚é¸æ“‡\nçµ¦äºˆ billing ç®¡ç†å“¡çš„æ¬Šé™ï¼Œå°±æœƒæ˜¯ ConductorFullAccess æˆ– ConductorReadOnlyAccess çµ¦äºˆ billing å ±å¸³äººå“¡ï¼Œæ‡‰è©²ä¸ç”¨æ›´æ”¹ aws çš„å…¶ä»–è¨­å®šï¼Œåªéœ€è¦è®€å–è·Ÿè¼¸å‡ºï¼Œå°±æœƒæ˜¯ AWSBillingReadOnlyAccess æˆ‘å€‘é€™é‚Šé¸æ“‡ AWSBillingConductorFullAccessï¼Œåšå€‹ç¤ºç¯„\né»æ“Š AWSBillingConductorFullAccessï¼Œè·³åˆ° Policies Â» AWSBillingConductorFullAccess é é¢ å¯ä»¥çœ‹åˆ° policy çš„å®Œæ•´ arnï¼ŒAmazon Resource Name (ARN) å”¯ä¸€è­˜åˆ¥AWS è³‡æºï¼Œé¡ä¼¼æ–¼ ID ç„¶å¾ŒæŠŠ arn å¡«å…¥ module.am_group_with_policies_billing plan \u0026amp; apply ä¸Šé¢çš„è®Šæ›´æˆ‘å€‘çš„ PR â€¦","date":1663641577,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"3de821611ca5806b0d201e57b829ddbd","permalink":"https://chechia.net/zh-hant/post/2022-09-17-14th-ithome-ironman-iac-aws-workshop-06-provision-iam-group-policy/","publishdate":"2022-09-20T10:39:37+08:00","relpermalink":"/zh-hant/post/2022-09-17-14th-ithome-ironman-iac-aws-workshop-06-provision-iam-group-policy/","section":"post","summary":"æ˜¨å¤©æˆ‘å€‘å°‡ root account IAM user import åˆ° terraform ä¸­\nç¤ºç¯„ terraform import å¢åŠ  iam user çš„åŠŸèƒ½åˆ° module repository ä¸­ ä»Šå¤©è¦å®Œæˆ root account ä¸­ IAM Group + Policyï¼Œé †ä¾¿èŠèŠ aws IAM policy ç®¡ç†åŸå‰‡","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Provision Iam Group Policy","type":"post"},{"authors":null,"categories":["terraform"],"content":"æ˜¨å¤©æˆ‘å€‘ç‚ºæ¯å€‹ç’°å¢ƒ(dev / stag / prod â€¦) è¨­å®šä¸€å€‹ aws organization account\nä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS IAM User\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User åŠ åˆ° terraform ä¸­ security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nAccounts \u0026amp; IAM Users ä»Šå¤©è¦ä½¿ç”¨ Terraform è¨­å®š IAM Usersã€‚\næœªä¾†æ‰€æœ‰çš„ User éƒ½æœƒé€é terraform è¨­å®šä¸¦ç®¡ç† Day02 è¨­å®šçš„ root account IAM User: Administrator é›–ç„¶æ˜¯æ‰‹å‹•å»ºç«‹çš„ï¼Œæˆ‘å€‘ä¸€æ¨£éœ€è¦æŠŠä»–åŒ¯å…¥åˆ° terraform ä¸­ ç„¶è€Œä¸Šå€‹ PR ä¸­ï¼Œæˆ‘å€‘çš„ terraform module ä¸­ä¸¦æ²’æœ‰è¨­å®š IAM User çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯é€™æ®µ code æ˜¯æ²’æœ‰ç™¼æ®åŠŸèƒ½ https://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/1/files#diff-62920ff868733e1c625c23fe7ffd6c93bebd87ae16b865869bf682e29b082a99R54-R67\nusers = { alice = { groups = [\u0026#34;full-access\u0026#34;] pgp_key = \u0026#34;keybase:alice\u0026#34; create_login_profile = true create_access_keys = false }, bob = { groups = [\u0026#34;billing\u0026#34;] pgp_key = \u0026#34;keybase:bob\u0026#34; create_login_profile = true create_access_keys = false } } æˆ‘å€‘é€™é‚Šä¸€æ¨£å˜—è©¦æŠŠé€™å€‹ users (map) çš„åŠŸèƒ½è£œä¸Š\nä½¿ç”¨é–‹æº module å¯¦ä½œ IAM User ä½¿ç”¨çš„é–‹æº terraform module æ˜¯ terraform-aws-modules/terraform-aws-iam æ˜¯ aws å®˜æ–¹ç¶­è­·çš„é–‹æº terraform moduleï¼Œå“è³ªå¾ˆå¥½ï¼Œæ”¾å¿ƒä½¿ç”¨ éœ€æ±‚æ•´ç†\nè¦ç”¢ç”Ÿ IAM User input: ä¸€å€‹ map users = {} output: å¤šå€‹ user è¦ç”¢ç”Ÿ IAM Group èˆ‡ IAM Policy å¢åŠ  IAM User PR çš„ commit åœ¨æ­¤ https://github.com/chechiachang/terragrunt-infrastructure-modules/pull/1\næ–¼æ˜¯æˆ‘å€‘è©¦è‘—åŸ·è¡Œ terraform plan\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # module.iam_group_with_policies_full_access.aws_iam_group.this[0] will be created + resource \u0026#34;aws_iam_group\u0026#34; \u0026#34;this\u0026#34; { + arn = (known after apply) + id = (known after apply) + name = \u0026#34;full-access\u0026#34; + path = \u0026#34;/\u0026#34; + unique_id = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_group_membership.this[0] will be created + resource \u0026#34;aws_iam_group_membership\u0026#34; \u0026#34;this\u0026#34; { + group = (known after apply) + id = (known after apply) + name = \u0026#34;full-access\u0026#34; + users = [ + \u0026#34;Administrator\u0026#34;, ] } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.custom_arns[0] will be created + resource \u0026#34;aws_iam_group_policy_attachment\u0026#34; \u0026#34;custom_arns\u0026#34; { + group = (known after apply) + id = (known after apply) + policy_arn = \u0026#34;arn:aws:iam::aws:policy/AdministratorAccess\u0026#34; } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.iam_self_management[0] will be created + resource \u0026#34;aws_iam_group_policy_attachment\u0026#34; \u0026#34;iam_self_management\u0026#34; { + group = (known after apply) + id = (known after apply) + policy_arn = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_policy.iam_self_management[0] will be created + resource \u0026#34;aws_iam_policy\u0026#34; \u0026#34;iam_self_management\u0026#34; { + arn = (known after apply) + id = (known after apply) + name = (known after apply) + name_prefix = \u0026#34;IAMSelfManagement-\u0026#34; + path = \u0026#34;/\u0026#34; + policy = jsonencode( { + Statement = [ + { + Action = [ + \u0026#34;iam:UploadSigningCertificate\u0026#34;, + \u0026#34;iam:UploadSSHPublicKey\u0026#34;, + \u0026#34;iam:UpdateUser\u0026#34;, + \u0026#34;iam:UpdateLoginProfile\u0026#34;, + \u0026#34;iam:UpdateAccessKey\u0026#34;, + \u0026#34;iam:ResyncMFADevice\u0026#34;, + \u0026#34;iam:List*\u0026#34;, + \u0026#34;iam:Get*\u0026#34;, + \u0026#34;iam:GenerateServiceLastAccessedDetails\u0026#34;, + \u0026#34;iam:GenerateCredentialReport\u0026#34;, + \u0026#34;iam:EnableMFADevice\u0026#34;, + \u0026#34;iam:DeleteVirtualMFADevice\u0026#34;, + \u0026#34;iam:DeleteLoginProfile\u0026#34;, + \u0026#34;iam:DeleteAccessKey\u0026#34;, + \u0026#34;iam:CreateVirtualMFADevice\u0026#34;, + \u0026#34;iam:CreateLoginProfile\u0026#34;, + \u0026#34;iam:CreateAccessKey\u0026#34;, + \u0026#34;iam:ChangePassword\u0026#34;, ] + Effect = \u0026#34;Allow\u0026#34; + Resource = [ + \u0026#34;arn:aws:iam::706136188012:user/*/${aws:username}\u0026#34;, + \u0026#34;arn:aws:iam::706136188012:user/${aws:username}\u0026#34;, + \u0026#34;arn:aws:iam::706136188012:mfa/${aws:username}\u0026#34;, ] + Sid = \u0026#34;AllowSelfManagement\u0026#34; }, + { + Action = [ + \u0026#34;iam:List*\u0026#34;, + \u0026#34;iam:Get*\u0026#34;, ] + Effect = \u0026#34;Allow\u0026#34; + Resource = \u0026#34;*\u0026#34; + Sid = \u0026#34;AllowIAMReadOnly\u0026#34; }, + { + Action = \u0026#34;iam:DeactivateMFADevice\u0026#34; + Condition = { + Bool = { + \u0026#34;aws:MultiFactorAuthPresent\u0026#34; = \u0026#34;true\u0026#34; } + NumericLessThan = { + \u0026#34;aws:MultiFactorAuthAge\u0026#34; = \u0026#34;3600\u0026#34; } } + Effect = \u0026#34;Allow\u0026#34; + Resource = [ + \u0026#34;arn:aws:iam::706136188012:user/*/${aws:username}\u0026#34;, + \u0026#34;arn:aws:iam::706136188012:user/${aws:username}\u0026#34;, + \u0026#34;arn:aws:iam::706136188012:mfa/${aws:username}\u0026#34;, ] + Sid = \u0026#34;AllowDeactivateMFADevice\u0026#34; }, ] + Version = \u0026#34;2012-10-17\u0026#34; } ) + policy_id = (known after apply) + tags_all = (known after apply) } # module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_user.this[0] will be created + resource \u0026#34;aws_iam_user\u0026#34; \u0026#34;this\u0026#34; { + arn = (known after apply) + force_destroy = true + id = (known after apply) + name = \u0026#34;Administrator\u0026#34; + path = \u0026#34;/\u0026#34; + tags_all = (known after apply) + unique_id = (known after apply) } # module.iam_user[\u0026#34;Administrator\u0026#34;].aws_iam_user_login_profile.this[0] will be created + resource \u0026#34;aws_iam_user_login_profile\u0026#34; \u0026#34;this\u0026#34; { + encrypted_password = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 + password_reset_required = false + pgp_key = \u0026#34;keybase:alice\u0026#34; + user = \u0026#34;Administrator\u0026#34; } â€¦","date":1663559967,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"19de429dcd5b3f0fc76036459753eab2","permalink":"https://chechia.net/zh-hant/post/2022-09-16-14th-ithome-ironman-iac-aws-workshop-05-provision-iam-user/","publishdate":"2022-09-19T11:59:27+08:00","relpermalink":"/zh-hant/post/2022-09-16-14th-ithome-ironman-iac-aws-workshop-05-provision-iam-user/","section":"post","summary":"æ˜¨å¤©æˆ‘å€‘ç‚ºæ¯å€‹ç’°å¢ƒ(dev / stag / prod â€¦) è¨­å®šä¸€å€‹ aws organization account\nä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS IAM User\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User åŠ åˆ° terraform ä¸­ security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy iThome éµäººè³½å¥½è®€ç‰ˆ","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Provision Iam User","type":"post"},{"authors":null,"categories":["terraform"],"content":"æ˜¨å¤©è¨­å®šäº†å¤šå€‹ aws organization accountsï¼Œä½†æˆ‘å€‘é‚„æ²’æœ‰èªªæ˜ç‚ºä»€éº¼è¦é€™æ¨£åš\nä»Šå¤©æœƒå…ˆè¬› Gruntwork æå‡ºçš„ Production-Grade Design: multi-account security strategy\næ‹†åˆ†å¤šå€‹ account çš„ç”¨æ„ å¤š account ä¸‹å¦‚ä½•çµ±ä¸€ç®¡ç† IAM User access control èˆ‡å®‰å…¨æ€§æ§ç®¡ iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nProduction-grade Design IAM Gruntwork æå‡ºçš„ Production-Grade Design: multi-account security strategyï¼Œæˆ‘å€‘é€™é‚Šä¸€ä¸€è¬›è§£\nRoot Account çš„ç”¨é€” ä½æ–¼ diagram åœ–ä¸­çš„æœ€ä¸Šå±¤ æ˜¯æ•´å€‹æ¶æ§‹çš„å‰µä¸–å¸³è™Ÿï¼Œæ¬Šé™æœ€å¤§ root account è£¡é¢æ²’æœ‰ä»»ä½• infrastructure å…ƒä»¶ï¼Œ i.e. aws ec2 ä¸æœƒé•·åœ¨è£¡é¢ï¼Œæ˜¯ä¸€å€‹ç©º account root account çš„å­˜å–æœ€åš´æ ¼ åªæœ‰å¾ˆå°‘æ•¸çš„ admin å¯ä»¥å­˜å– i.e åªæœ‰ SRE éƒ¨é–€ä¸»ç®¡æœ‰è‡ªå·±çš„ IAM Userï¼Œå…¶ä»– SRE æ²’æœ‰æ¬Šé™å­˜å– root account root account çš„å·¥ä½œæœ€å°‘ è¨­å®š child account ç®¡ç† billing IAM policy ç®¡ç†ï¼Œä¸è¦æŠŠ policy ç›´æ¥ç¶åœ¨ User ä¸Šï¼Œæ‡‰è©²è¦\nç‚ºä¸åŒæ¬Šè²¬çš„æˆå“¡è¨­å®š IAM Groupï¼Œex. dev-admin / dev-user / stag-admin / qa / billing / â€¦ æŠŠ policy ç¶åœ¨ Group ä¸Šï¼Œex. ReadPermission -\u0026gt; dev-user / Read+Write -\u0026gt; dev-admin æŠŠ User åŠ é€² / ç§»é™¤ Groupï¼Œä¾†ç®¡ç†äººå“¡æ¬Šé™ Group é€šå¸¸æœƒæ¥è¿‘å…¬å¸åœ˜éšŠçš„è·è²¬åˆ†é… root account å…§éƒ¨åªæœƒæœ‰ full-access çš„ç®¡ç†å“¡ group billing çš„æœƒè¨ˆå‡ºå¸³ group Child Account çš„ç”¨é€” é€é root account å‰µå»º child accounts å¾Œï¼Œé€™è£¡èªªæ˜å„å€‹ account çš„è¨­è¨ˆç”¨é€”\nSecurity ç”¨ä¾†ç®¡ç† authentication èˆ‡ authorization\nåº•ä¸‹ä¸€æ¨£æ²’æœ‰ä»»ä½• infrastructure å…ƒä»¶ å®šç¾©æ‰€æœ‰ IAM User èˆ‡ IAM Groupï¼Œæ‰€æœ‰åœ˜éšŠæˆå“¡çš„ User åœ¨é€™é‚Šè¨­å®š æ‰€æœ‰çš„ User æ”¾åœ¨ Security åº•ä¸‹çµ±ä¸€ç®¡ç† å…¶ä»–çš„ child account ä¸æœƒè¨­å®š IAM Userï¼Œex. dev / stag / prod è£¡é¢éƒ½æ²’æœ‰ IAM User child account ä¸­è¨­å®š IAM rolesï¼Œè®“ security/user assume role å­˜å–å…¶ä»– child account ex. security/dev-admin/chechia assume role dev/adminï¼Œé€é aws STS(Security Token Service) æš«æ™‚å–å¾— dev/admin é€™å€‹ role çš„æ¬Šé™ä¾†æ§åˆ¶ dev åœ˜éšŠä¸»ç®¡ä¹Ÿæœƒæœ‰ä¸€å€‹ security IAM Userï¼Œå¹³æ™‚é–‹ç™¼ infrastructure ä½¿ç”¨é€™å€‹ IAM Userï¼Œåªæœ‰éœ€è¦èª¿æ•´ root account æ™‚æ‰æœƒå‹•ç”¨ root account IAM Userã€‚åæ­£ root account æ˜¯èƒ½ä¸ç”¨å°±ä¸ç”¨ é€™å€‹åšæ³•æœ‰éå¸¸å¤šå¥½è™•ï¼Œä½†åˆä¸æœƒé€ æˆå·¥ä½œä¸Šçš„è² æ“”\nä½¿ç”¨æ–¹é¢ï¼šæ‰€æœ‰çš„åœ˜éšŠæˆå“¡åªæœƒæœ‰ä¸€å€‹ Userï¼Œé€é security ç™»å…¥ã€‚ä¸æœƒä¸€å€‹äººæœ‰å¥½å¹¾å€‹å¸³è™Ÿå¯†ç¢¼å¾ˆç…© ç®¡ç†æ–¹é¢ï¼šç®¡ç†å“¡åªè¦åœ¨ security å…§ç®¡ç† Userï¼Œè€Œä¸ç”¨ä¸€ç›´åˆ‡æ› account å»èª¿æ•´ IAM User å®‰å…¨æ–¹é¢ï¼šåªè¦åœ¨ security å…§è½å¯¦å®‰å…¨æ€§è¨­å®šï¼Œå°±å¯ä»¥å¾ˆå¥½çš„æ§åˆ¶æ‰€æœ‰ account çš„å­˜å–æ¬Šé™ dev / stag / prod ç”¨ä¾†å­˜æ”¾ infrastructure èˆ‡è·‘ application\né–‹ç™¼æ™‚ä½¿ç”¨ dev / stag ç’°å¢ƒï¼Œæ¸¬è©¦éƒ½å®Œæˆå¾Œï¼Œæ‰è‡ªå‹•æ¨å€’ prod å…¬é–‹çµ¦ç”¨æˆ¶ä½¿ç”¨ dev / stag ç’°å¢ƒæ˜¯å…§éƒ¨ç’°å¢ƒï¼Œæ¶æ§‹èˆ‡ prod é¡ä¼¼ï¼Œä¾†æ¨¡æ“¬ prod çš„ç’°å¢ƒæ–¹ä¾¿é–‹ç™¼èˆ‡æ¸¬è©¦ å¯èƒ½æ©Ÿå™¨æ•¸é‡æˆ–è¦æ ¼æ¯” prod å°å¾ˆå¤šï¼Œä¾†ç¯€çœæˆæœ¬ æœ‰äº›åœ˜éšŠæœƒæœ‰æ›´å¤š accountï¼Œä¾‹å¦‚ qa / uat / â€¦ï¼Œéƒ½å¯ä»¥ä¾ç…§éœ€æ±‚å»ºç«‹ prod æœ‰äº›åœ˜éšŠæœƒæœ‰è¤‡æ•¸ prod ç’°å¢ƒï¼Œå¯ä»¥ä¾›ç½é›£ç™¼ç”Ÿæ™‚åšå‚™æ´åˆ‡æ› shared è£¡é¢æ”¾è·¨ application account å…±ç”¨çš„å…ƒä»¶\nä¾‹å¦‚ AWS ECR å¯èƒ½ä¸æƒ³è¦æ¯å€‹ account éƒ½é–‹ï¼Œæƒ³æ”¾ä¸€èµ·çš„è©±å¯ä»¥æ”¾åœ¨ sharedï¼Œç„¶å¾Œè®“å…¶ä»– account å­˜å– shared ç‰ˆæœ¬æ§åˆ¶ç³»çµ± Git / github å¯èƒ½æœƒåªæœ‰ä¸€çµ„å¤§å®¶å…±ç”¨ CI/CD pipeline / Jenkins â€¦ç­‰ç­‰è·¨ç’°å¢ƒå…±ç”¨çš„è³‡æºï¼Œå¯ä»¥æ”¾ shared æ¯å€‹ account éƒ½é–‹ä¹Ÿæ˜¯æœ‰è¨±å¤šå¥½è™•ï¼Œä¾‹å¦‚æ›´ç¨ç«‹æ›´å®‰å…¨ï¼Œé€™å°±çœ‹çœ‹å„å€‹åœ˜éšŠç½å®‰å…¨èˆ‡æˆæœ¬ä¸Šçš„å–æ¨ ç®¡ç†ä¸Šç”±æ–¼ prod æœƒä½¿ç”¨åˆ° shared çš„å…ƒä»¶ï¼Œå»ºè­°è¦æŠŠ shared çš„å®‰å…¨ç­‰ç´šç•¶ä½œ prod ä¾†ç®¡ç†ï¼Œåš´æ ¼é™åˆ¶ shared çš„å­˜å–ï¼Œä»¥ä¿è­· prod ç’°å¢ƒçš„å®‰å…¨ å¾ˆå¤šå€‹ sandbox account è®“å·¥ç¨‹å¸«è‡ªç”±çš„æ¸¬è©¦åŠŸèƒ½\nå¦‚æœæœ‰éœ€æ±‚èˆ‡é ç®—ï¼Œä¸€å€‹å®Œå…¨ç¨ç«‹çš„ sandbox è®“å·¥ç¨‹å¸«å¯ä»¥åšå„ç¨®å¯¦é©—ï¼Œå°æ–¼ä¿ƒé€²åœ˜éšŠå…§éƒ¨çš„å‰µæ–°æœƒæœ‰éå¸¸å¤§çš„å¹«åŠ© å¦‚æœåœ¨ dev ä¸Šåšé€™æ¸¬è©¦ï¼Œæœ‰å¯èƒ½æœƒå½±éŸ¿åˆ°å…¶ä»–åœ˜éšŠæˆå“¡ï¼Œè€Œè¦ºå¾—ç¶æ‰‹ç¶è…³çš„äº‹æƒ…ï¼Œéƒ½å¯ä»¥ç›¡æƒ…åœ¨ sandbox ä¸Šæ“ä½œ å¯ä»¥ç‚º sandbox çš„å¸³è™Ÿè¨­å®šæ›´åš´æ ¼çš„ billing / cost è¨­å®šï¼Œé¿å…å·¥ç¨‹å¸«ç©å¤ªå—¨è¶…éé ç®— é»ƒé‡‘æº–å‰‡æ˜¯ä¸€å€‹å·¥ç¨‹å¸«ä¸€å€‹ sandbox ä¾†é”åˆ° 100% é–‹ç™¼ç¨ç«‹ testing account ç”¨ä¾†æ¸¬è©¦ infrastructure çš„æ¸¬è©¦\nå¦‚æœæœ‰ä½¿ç”¨ Gruntwork/Terratest ä¾†æ¸¬è©¦ terraform tf code çš„æœ‹å‹ï¼Œæ‡‰è©²çŸ¥é“ terratest æœƒæŠŠ terraform module ä¸­çš„ infrastrcuture çœŸçš„åœ¨ aws é–‹å‡ºä¾†ï¼ŒåšåŠŸèƒ½æ¸¬è©¦ï¼Œç„¶å¾Œæ¸¬è©¦å®Œæˆå¾Œå†æŠŠ infrastrcture å…¨éƒ¨åˆªæ‰ æ˜¯çš„ IaC terraform module ä¹Ÿæ˜¯éœ€è¦å–®å…ƒæ¸¬è©¦ testing å°±æ˜¯ç”¨ä¾†è®“ IaC åšè‡ªå‹•åŒ–æ¸¬è©¦çš„ç’°å¢ƒï¼Œè£¡é¢çš„ infrastructure éƒ½æ˜¯å¸¸å¸¸ create + destroyï¼Œä¸æœƒæœ‰å¸¸é§çš„æœå‹™ èˆ‡ sandbox ä¸åŒçš„æ˜¯ testing æ˜¯è·‘è‡ªå‹•åŒ– CI/CD pipeline çš„æ¸¬è©¦ sandbox æ˜¯è®“å·¥ç¨‹å¸«åšè¦æ¨¡è¼ƒå°çš„æ‰‹å‹•æ¸¬è©¦èˆ‡é–‹ç™¼ï¼Œå› ç‚ºæˆ‘å€‘ä¹Ÿä¸å¸Œæœ›ä¸€å †æ¸¬è©¦ç”¨ infrastructure æ•£è½åœ¨ sandbox è£¡é¢ï¼Œæ„Ÿè¦ºå¾ˆè²´ logs ç”¨ä¾†æ”¶é›† log åˆ°å–®ä¸€ account åº•ä¸‹ï¼Œæ–¹ä¾¿æŸ¥é–±\næ‰€æœ‰ child account çš„ log éƒ½æ”¶åˆ°é€™è£¡ï¼Œè€Œä¸ç”¨è·‘åˆ°å„å€‹ account å»æŸ¥ log aws account å…§éƒ¨çš„ logï¼Œcloud trail éƒ½å¯ä»¥é€éå®¢è¨‚èˆ‡å·¥å…·è½‰ç™¼ï¼Œé›†ä¸­æ”¶é›† å¦‚æœå…¬å¸è¦æ¨¡å¾ˆå¤§ï¼Œæœ‰å¤šå€‹ business unit çš„è©±ï¼Œä¹Ÿå¯ä»¥å¤šå»ºå¹¾å€‹ organizationï¼Œä¾†å°æ‡‰å…¬å¸çµ„ç¹”\né€é web console switch role æˆ‘æ˜¯ä¸€å€‹é–‹ç™¼å·¥ç¨‹å¸«ï¼ˆä¸æ˜¯ adminï¼‰ï¼Œé‚£åœ¨ multi-account ä¸‹çš„ç’°å¢ƒæˆ‘æ‡‰è©²å¦‚ä½•å·¥ä½œï¼Ÿ\nå¦‚ä½•å­˜å– aws\nIAM User å¯ä»¥é€éå¸³è™Ÿå¯†ç¢¼ä¾†å­˜å– aws web consoleï¼Œç™»å…¥ä¹‹å¾Œæœƒç™¼ç¾è‡ªå·±è™•åœ¨ security account åº•ä¸‹ ç¬¬ä¸€æ¬¡ç™»å…¥çš„è©±éœ€è¦é‡è¨­å¯†ç¢¼ï¼Œéœ€è¦ç¬¦åˆ IAM Password Policy æœƒéœ€è¦è¼¸å…¥ MFAï¼Œæœƒéœ€è¦ç¬¦åˆ IAM MFA Policy å…©é¢çš„å®‰å…¨æ€§ policy åœ¨å¯¦éš›å…¬å¸å¸³è™Ÿè£¡æ˜¯å¿…å‚™ï¼Œä½†åœ¨ workshop ä¸­ï¼Œæˆ‘å€‘é‚„æ²’åšï¼Œå…ˆç•™å€‹å‘ä¹‹å¾Œä¾†è£œ programatic access å¦‚åŒ day03 çš„ root account IAM User æ­¥é©Ÿï¼Œæˆ‘å€‘ä¹Ÿæ˜¯ä½¿ç”¨ aws-vault æ­é… aws access keyï¼Œä¾†è®“ terraform åŸ·è¡Œ web console å¦‚ä½• switch role\nå¯ä»¥åœ¨ aws web console -\u0026gt; å³ä¸Šè§’ user -\u0026gt; switch role å¡«å…¥\nç›®æ¨™ account ID (ex dev: 123456789012) ç›®æ¨™çš„ role çµ¦è‡ªå·±çœ‹çš„å¥½è¾¨è­˜åç¨± å¦‚æœ admin æœ‰è¨­å®š IAM role èˆ‡ assume role æ¬Šé™ï¼Œå°±å¯ä»¥åˆ‡æ›åˆ° dev account ä¸‹çš„ IAM role èº«åˆ† é€é web console switch role å¦‚åŒ day03 ä½¿ç”¨ root account IAM Userï¼Œæˆ‘å€‘ä¹Ÿæ˜¯ä½¿ç”¨ aws-vault æ­é… aws access keyï¼Œä¾†è®“ terraform åŸ·è¡Œ) ä¾†è·‘ terraform å»ºç«‹ child accounts ä¸€æ¨£ï¼Œæˆ‘å€‘ä¹Ÿéœ€è¦è¨­å®š aws-vaultï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨ local æ©Ÿä¸Š assume ä¸åŒ account roleï¼Œä¾†ä½¿ç”¨å„å€‹ child account\naws-vault Roles and MFA éœ€è¦èª¿æ•´ ~/.aws/config çš„è¨­å®š\nsecurity ç®¡ç†å“¡è¨­å®šå®Œ iam role + assume policy å¾Œï¼Œæœƒæä¾›ç™»å…¥è³‡è¨Šçµ¦å…¶ä»–åœ˜éšŠæˆå“¡ cat ~/.aws/config # é€™æ˜¯ root account IAM User ä¸è¦å†æ‹¿ä¾†ç”¨äº† # aws access key æ”¶åœ¨æœ¬æ©Ÿçš„ aws-vault å…§ [profile terraform-30day-root-iam-user] region=ap-northeast-1 # é€™æ˜¯ security account (111111111111) IAM Userï¼ˆé‚„æ²’å»ºç«‹ï¼‰ # aws access key æ”¶åœ¨æœ¬æ©Ÿçš„ aws-vault å…§ [profile chechia-security-iam-user] region=ap-northeast-1 # é€™æ˜¯ dev account (333333333333) IAM Roleï¼ˆé‚„æ²’å»ºç«‹ï¼‰ [profile dev-admin] source_profile = chechia-security-iam-user role_arn = arn:aws:iam::333333333333:role/dev-admin mfa_serial = arn:aws:iam::111111111111:mfa/chechia-security-iam-user ä¸Šé¢é€™äº›éƒ½é‚„æ²’å»ºç«‹ï¼Œæ‰€ä»¥éƒ½é‚„ä¸èƒ½ç”¨ï¼Œåªæ˜¯å…ˆèªªä¸€ä¸‹ä¹‹å¾Œè¦æ€éº¼æ“ä½œ\nsecurity ç®¡ç†å“¡è¦è¨­å®šä¸€å¤§å †æ±è¥¿ï¼Œä½†å·¥ç¨‹å¸«ä½¿ç”¨éå¸¸ç°¡å–®ï¼Œåªè¦é€é aws-vault åˆ‡æ›å°±å¯ä»¥åœ¨ä¸åŒ account ä¸‹æ“ä½œ terraform\naws-vault exec dev-admin -- aws sts get-caller-identity { \u0026#34;UserId\u0026#34;: \u0026#34;xxxxxxxxxxxxxxxx\u0026#34;, \u0026#34;Account\u0026#34;: \u0026#34;333333333333\u0026#34;, \u0026#34;Arn\u0026#34;: \u0026#34;arn:aws:iam::333333333333:role/dev-admin\u0026#34; } aws-vault exec dev-admin -- terragrunt plan aws-vault exec stag-admin -- terragrunt plan â€¦","date":1663464925,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"ace90bff86625ba1b3ca74db6c3e4380","permalink":"https://chechia.net/zh-hant/post/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/","publishdate":"2022-09-18T09:35:25+08:00","relpermalink":"/zh-hant/post/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/","section":"post","summary":"æ˜¨å¤©è¨­å®šäº†å¤šå€‹ aws organization accountsï¼Œä½†æˆ‘å€‘é‚„æ²’æœ‰èªªæ˜ç‚ºä»€éº¼è¦é€™æ¨£åš\nä»Šå¤©æœƒå…ˆè¬› Gruntwork æå‡ºçš„ Production-Grade Design: multi-account security strategy\næ‹†åˆ†å¤šå€‹ account çš„ç”¨æ„ å¤š account ä¸‹å¦‚ä½•çµ±ä¸€ç®¡ç† IAM User access control èˆ‡å®‰å…¨æ€§æ§ç®¡ iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nProduction-grade Design IAM Gruntwork æå‡ºçš„ Production-Grade Design: multi-account security strategyï¼Œæˆ‘å€‘é€™é‚Šä¸€ä¸€è¬›è§£","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"AWS Multi-Accounts Structure","type":"post"},{"authors":null,"categories":["terraform"],"content":"ä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nâ€“\nProvision AWS Account\nä»Šå¤©è¦æŠŠ aws account è¨­å®šå®Œæˆï¼Œä¸¦ä¸”é–‹å§‹ä½¿ç”¨ live-repository ä¾†æ­å»º aws å…ƒä»¶\næˆ‘å€‘è‡ªå·±çš„ module repository é–‹ä¸€å€‹æ¬Šé™çš„ repository fork æˆ‘è‡ªå¹¹çš„ modules repository terragrunt-infrastructure-modules https://github.com/chechiachang/terragrunt-infrastructure-modules ä¸Šé¢é€™å€‹æ˜¯æ”¾ terraform module çš„ repositoryï¼Œæ˜¯å…©å€‹ repository ä¸è¦è·ŸåŸ·è¡Œ terragrunt repository ææ··ï¼Œæ˜¯å…©å€‹ repository https://github.com/chechiachang/terragrunt-infrastructure-live-example ä»Šå¤©çš„é€²åº¦èˆ‡ code base\nterraform-live-example PR åœ¨æ­¤ terragrunt-infrastructure-modules è«‹ç›´æ¥çœ‹ tag v0.0.1 å› ç‚ºæœ‰åœ°æ–¹åš´é‡å¯«éŒ¯ï¼Œæˆ‘æœ‰ force push æ±è¥¿ :tear:ï¼Œå¦‚æœå·²ç¶“ææ—©ä¸‹è¼‰çš„æœ‹å‹å¯èƒ½æœƒéœ€è¦æ¸…æ‰ repository main branch + tag é‡æ‹‰ orz å°ï¼Œæˆ‘å€‘ä¸”æˆ°ä¸”èµ°å¸¸å¸¸æœƒé€™æ¨£ï¼Œç™¼ç¾æ˜¨å¤©å¯«çš„æ±è¥¿å¯«éŒ¯è‡¨æ™‚æ”¹ï¼Œè«‹å¤§å®¶è¦‹è«’\nç‚ºä½•ä½¿ç”¨ aws modules X) å› ç‚ºæˆ‘å€‘æ²’æœ‰ä»˜éŒ¢ï¼Œä¸èƒ½ç”¨ gruntwork çš„ priviate repository (å¤§èª¤\nO) å› ç‚ºæˆ‘å€‘æƒ³è¦ä½¿ç”¨é–‹æºç‰ˆæœ¬çš„ terraform module (XD)\næˆ‘å€‘å¿«é€Ÿçœ‹ä¸€ä¸‹ module è£¡é¢çš„å…§å®¹ https://github.com/chechiachang/terragrunt-infrastructure-modules/tree/v0.0.1/aws/modules/account-baseline-root\nresource \u0026#34;aws_organizations_organization\u0026#34; \u0026#34;org\u0026#34; { aws_service_access_principals = [ \u0026#34;cloudtrail.amazonaws.com\u0026#34;, \u0026#34;config.amazonaws.com\u0026#34;, ] feature_set = \u0026#34;ALL\u0026#34; } resource \u0026#34;aws_organizations_account\u0026#34; \u0026#34;account\u0026#34; { for_each = var.child_accounts name = each.key email = each.value[\u0026#34;email\u0026#34;] depends_on = [ aws_organizations_organization.org ] } æˆ‘å€‘çš„éœ€æ±‚\nåœ¨ root account ä¸‹ provision ä¸€å€‹ aws organization ç‚ºæ¯å€‹ç’°å¢ƒ provision ä¸€å€‹ aws organization account ä½¿ç”¨ terraform for_each function ä¾†è¿­ä»£ variabel å‚³å…¥çš„ organization accounts (å‹åˆ¥æ˜¯ map) each.key æœƒæ‹¿åˆ°æ¯å€‹ map element çš„ keyï¼Œä¾‹å¦‚ child_accounts = { logs = {}, security = {}, shared = {}, dev = {}, stage = {}, prod = {} } è·‘å‡ºä¾† each.key å°±æœƒæ˜¯ [logs, security, shared, dev, stage, prod] æ­£å¥½æ˜¯æˆ‘å€‘é€™æ¬¡éœ€è¦ provision çš„å…­å€‹ aws organization accountsï¼Œæ»¿è¶³ç›®å‰çš„éœ€æ±‚ each.value[â€œemailâ€] å‰‡ä¾åºå¸¶å…¥å„è‡ªçš„ email åˆ° account ä¸­ NOTE: é€™äº› email è«‹ä½¿ç”¨ä½ æ”¶å¾—åˆ°çš„ email\nåœ¨ç¾å¯¦ä¸­é€™æœƒæ˜¯å…­çµ„ä¸åŒçš„ emailï¼Œemail é‡è¤‡çš„è©±æœƒè¢« aws api rejectï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸åŒçš„ email æˆ–æ˜¯è·Ÿ gruntwork guide ä¸€æ¨£ï¼Œä½¿ç”¨ gmail å¸³è™Ÿå¾Œ+ çš„å­—å…ƒæœƒ ignore å¦‚æœè¨­å®šäº†æ”¶ä¸åˆ°ä¿¡çš„ email ä½œç‚º account email å°±æœƒæœ‰é»éº»ç…© ä¸è¦åƒæˆ‘ä¸€æ¨£è¨­äº† 6 å€‹æ”¶ä¸åˆ° emailï¼Œåªå¥½å†å¤šé–‹ä¸€å€‹ account XDï¼Œé‚„å¥½æˆ‘å€‘æ˜¯åœ¨ workshop é€™å€‹ terraform module çš„å¯«æ³•å®Œå…¨å¿½ç•¥å…¶ä»– each.value å…§çš„å€¼\næˆ‘å€‘ä¸¦ä¸æ¸…æ¥š gruntwork åœ¨ private çš„ terraform module ä¸­ï¼Œé®äº›åƒæ•¸çš„ç¢ºåˆ‡ç”¨é€”ï¼Œä»¥åŠå° aws organization account è¨­å®šæœ‰ä½•å½±éŸ¿ ä½†ä»¥ç­†è€…ä½¿ç”¨ aws çš„ç¶“é©—ï¼Œå¤§æ¦‚çŒœå¾—å‡ºä¾†é€™äº›åƒæ•¸çš„ç”¨é€”ï¼Œä»¥åŠ terraform module æ‡‰è©²å¦‚ä½•èª¿æ•´ï¼Œç‚ºäº†èª²ç¨‹é€²åº¦å®‰æ’ï¼Œæˆ‘å€‘å…ˆæš«æ™‚å¿½ç•¥ã€‚ç¹¼çºŒç…§è‘— gruntwork çš„æ–‡ä»¶åšä¸‹å»ï¼Œä¹‹å¾Œæœ‰ç”¨åˆ°å†ä¾†è£œ Terragrunt Plan \u0026amp; apply åœ¨è·‘ terragrunt ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆè¦åˆ‡æ›æˆ root account çš„ iam Userï¼Œæ˜¨å¤©æ–°å»ºçš„ IAM Userï¼Œå­˜æ”¾åœ¨å¯†ç¢¼ä¼ç†ï¼Œé‚„è¨˜å¾—å—ï¼Ÿ\nä½¿ç”¨ aws-vault æ‹¿ IAM User çš„ access key åš programatic ç™»å…¥ï¼Œæä¾› terraform credentialã€‚è€Œéé€é aws web console è¨˜ä½ï¼šæˆ‘å€‘ä¸èƒ½ç”¨ root account åšé€™äº›å·¥ä½œ\naws-vault ç”±æ–¼æˆ‘å€‘ç¾åœ¨è¦ä½¿ç”¨ IAM User åš terraform ä¾†å‰µå»ºæ–°çš„ child accountsï¼Œæœªä¾†æœƒä½¿ç”¨æ–°çš„ child accounts ä¾†åšå„å€‹ç’°å¢ƒä¸­çš„ terraform å…ƒä»¶æ“ä½œï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹å·¥å…·ä¾†å”åŠ©åˆ‡æ›é€™äº› account\næˆ‘å€‘ä½¿ç”¨çš„å·¥å…·æ˜¯ aws-vault\nhttps://github.com/99designs/aws-vault æ”¯æ´å¾ˆå¤šå®‰è£å¹³å°ï¼Œé¸è‡ªå·±å–œæ­¡ç”¨çš„ï¼Œæˆ–æ˜¯ç›´æ¥åœ¨ github release é é¢ä¸‹è¼‰ binary $ aws-vault --help usage: aws-vault [\u0026lt;flags\u0026gt;] \u0026lt;command\u0026gt; [\u0026lt;args\u0026gt; ...] A vault for securely storing and accessing AWS credentials in development environments. ... ä½¿ç”¨ Root Account IAM User èº«ä»½åŸ·è¡Œ terragrunt\nåœ¨æœ¬æ©Ÿç´€éŒ„ access key (è«‹å¥½å¥½ä¿è­·æœ¬æ©Ÿçš„å®‰å…¨)\naws-vault add terraform-30day-root-iam-user Enter Access Key Id: XXXXXXXXXXXX Enter Secret Key: YYYYYYYYYYYY é€é aws-cli å–å¾— caller identityï¼Œä¹Ÿå°±æ˜¯ç¾åœ¨çš„èº«ä»½æ˜¯èª°ï¼Œç¢ºå®šæ˜¯ Administrator\nå¾ aws çš„è§’åº¦ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯ IAM User: Administrator æ“ä½œçš„ åªèƒ½æ“ä½œç•¶åˆå»ºç«‹ IAM User æ™‚ attach çš„æ¬Šé™ï¼ˆè˜‡ç„¶ä¹Ÿæ˜¯å¾ˆå¤§ï¼‰ä½†å·²ç¶“æ¯” root account å°å¾ˆå¤š ä¹‹å¾Œæˆ‘å€‘æœƒé€²ä¸€æ­¥é™ç¸®æ¯ä¸€å€‹ IAM User çš„ permission aws-vault exec terraform-30day-root-iam-user -- aws sts get-caller-identity { \u0026#34;UserId\u0026#34;: \u0026#34;AIDAxxxxxxxxxxxKGW\u0026#34;, \u0026#34;Account\u0026#34;: \u0026#34;706136188012\u0026#34;, \u0026#34;Arn\u0026#34;: \u0026#34;arn:aws:iam::706136188012:user/Administrator\u0026#34; } ç„¶å¾Œé€é aws-vault ä¾†åŸ·è¡Œ terraguntï¼Œé€™æ¨£ terragrunt å°±æœƒä½¿ç”¨ IAM User çš„ credential ä¾†æ“ä½œ provider å»å‘¼å« aws api\naws-vault exec terraform-30day-root-iam-user -- terragrunt init aws-vault exec terraform-30day-root-iam-user -- terragrunt plan Terraform will perform the following actions: # aws_organizations_account.account[\u0026#34;dev\u0026#34;] will be created + resource \u0026#34;aws_organizations_account\u0026#34; \u0026#34;account\u0026#34; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026#34;terraform30days@outlook.com\u0026#34; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026#34;dev\u0026#34; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026#34;logs\u0026#34;] will be created + resource \u0026#34;aws_organizations_account\u0026#34; \u0026#34;account\u0026#34; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026#34;terraform30days@outlook.com\u0026#34; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026#34;logs\u0026#34; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026#34;prod\u0026#34;] will be created + resource \u0026#34;aws_organizations_account\u0026#34; \u0026#34;account\u0026#34; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026#34;terraform30days@outlook.com\u0026#34; + govcloud_id = (known after apply) â€¦","date":1663319781,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"10581b524e3d36685d7bd357048bbb0e","permalink":"https://chechia.net/zh-hant/post/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/","publishdate":"2022-09-16T17:16:21+08:00","relpermalink":"/zh-hant/post/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/","section":"post","summary":"ä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nâ€“\nProvision AWS Account\nä»Šå¤©è¦æŠŠ aws account è¨­å®šå®Œæˆï¼Œä¸¦ä¸”é–‹å§‹ä½¿ç”¨ live-repository ä¾†æ­å»º aws å…ƒä»¶\næˆ‘å€‘è‡ªå·±çš„ module repository é–‹ä¸€å€‹æ¬Šé™çš„ repository fork æˆ‘è‡ªå¹¹çš„ modules repository terragrunt-infrastructure-modules https://github.","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"Provision Child AWS Accounts","type":"post"},{"authors":null,"categories":["terraform"],"content":"ä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nâ€“\nAWS Account structure AWS account structure æ˜¯ AWS IAM æä¾›çš„ feature ä¹‹ä¸€ï¼Œå¯ä»¥è®“ç”¨æˆ¶å¾ä¸€å€‹ account loginï¼Œç„¶å¾Œé€éæˆæ¬Šæ“ä½œå…¶ä»– account çš„å…ƒä»¶ã€‚\nç„¶è€Œæœ‰é€™å€‹ feature ä¸ä»£è¡¨ç”¨æˆ¶å°±è¦è²·å–®ï¼Œæœ‰å¯¦éš›éœ€æ±‚æˆ‘å€‘æ‰ä¾†ç”¨ featureã€‚ä½¿ç”¨ account structure çš„ç†ç”±æ˜¯ä»€éº¼ï¼Ÿ\nAccount structure çš„éœ€æ±‚ AWS å®˜æ–¹ whitepaper: ä½¿ç”¨ multiple aws account çš„å¥½è™•\nä¾æ“šè·å‹™éœ€æ±‚å°‡ workload åˆ†çµ„ ç‚ºä¸åŒ environment è¨­å®šç¨ç«‹çš„ security control é™åˆ¶æ•æ„Ÿè³‡æ–™çš„å­˜å– æå‡å‰µæ–°èˆ‡é–‹ç™¼çš„æ•æ· æ§åˆ¶äº‹æ•…çš„å½±éŸ¿ç¨‹åº¦èˆ‡è¡æ“Š impact ç²¾ç´°çš„æ‹†åˆ† IT çš„å·¥ä½œ æˆæœ¬æ§ç®¡ åˆ†æ•£ aws quotas ä½¿ç”¨é™é¡èˆ‡ API rate limit AWS å®˜æ–¹çš„ organization best practice AWS å®˜æ–¹ OU ç®¡ç†çš„ best practice\nGruntwork Doc å»ºè­°çš„ IaC best practice ä¸­çš„ aws account structureï¼Œæåˆ°ä¸‰å€‹ä¸»è¦çš„ç›®çš„\nIsolation (AKA compartmentalization) ä¸åŒç’°å¢ƒï¼Œäº‹æ•…ç™¼ç”Ÿæ™‚ï¼Œå½±éŸ¿ç¯„åœä¸æœƒå¤ªå¤§ (ex. å·¥ç¨‹å¸« terraform èª¤åˆª infra) å®‰å…¨æ€§ï¼Œdev / stag æœ‰å®‰å…¨æ€§æ¼æ´æ™‚ï¼Œattacker ä¸æœƒæ”»æ“Šåˆ° prod ç’°å¢ƒ Authentication and authorization æŠŠ user éƒ½æ”¾åœ¨ä¸€èµ·ç®¡ç†ï¼Œé€éæ›´ç²¾ç´°çš„ access control å»æ§åˆ¶å…¶ä»– account å…§éƒ¨çš„å…ƒä»¶ Auditing and reporting ä¾æ“šç’°å¢ƒèˆ‡ç”¨é€”æ‹†åˆ† accountï¼Œè®“ç›£æ¸¬èˆ‡æˆæœ¬æ§åˆ¶æ›´ç²¾ç´° å¾å¯¦å‹™ä¸Šçš„ç¶“é©—ï¼Œæœ‰ä»¥ä¸‹ç‹€æ³å°±è€ƒæ…®è¦æ‹†åˆ† aws account\nå¦‚æœ IT éƒ¨é–€å¾ˆå¤§äººæ•¸å¾ˆå¤šï¼Œé‚£å°‡æ‰€æœ‰å·¥ä½œå…§å®¹ä¸åŒçš„ user éƒ½æ”¾åœ¨åŒä¸€å€‹ aws account ä¸‹å°è‡´ç®¡ç†éº»ç…© å¤§å¤šæ•¸çš„ incident éƒ½æ˜¯å·¥ç¨‹å¸« change é€ æˆçš„ï¼Œæ‹†åˆ† dev / stag çš„ change æ›¾ç¶“å½±éŸ¿åˆ° prod ä¸åŒåœ˜éšŠå°æ–¼è² è²¬çš„å…ƒä»¶ç¯„åœå€åˆ†ä¸æ¸… å·¥ä½œæ‰çƒï¼Œè©²åšçš„äº‹æ²’äººè™•ç† å·¥ä½œé‡åŠŸï¼Œåšäº†ä¸€æ¨£çš„äº‹æƒ…å°è‡´è¡çª å°æ•…äº‹ï¼šæŠ€è¡“å•é¡Œè§£æ±ºäººç‚ºå•é¡Œï¼ˆï¼Ÿï¼‰ iThome DevOpsDay æœ‰ä¸€å€‹è½çœ¾è½å®Œ2022 DevOpsDay PaC for IaC æ¼”è¬› å¾Œè·‘ä¾†æ‰¾æˆ‘ï¼Œä»–å•èªªï¼š è¬›å¸«ä½ å¥½ï¼Œæˆ‘å€‘ terraform å¸¸å¸¸èª¤åˆªæ±è¥¿ï¼Œdeploy dev / stag çµæœ prod å£æ‰ï¼ˆæ±— å¦‚æœä¸æ˜¯æŠ€è¡“çš„å•é¡Œï¼Œæ˜¯äººçš„å•é¡Œï¼Œä¸çŸ¥é“æœ‰æ²’æœ‰æ–¹æ³•è§£ï¼Ÿ\nè¦æ²»æœ¬é‚„æ˜¯è¦åŠ å¼·å…§éƒ¨æ•™è‚²è¨“ç·´ï¼Œå¾ˆåŸºç¤çš„é‡å¤§éŒ¯èª¤æ˜¯å¾ˆé›£ç”¨æŠ€è¡“æ“‹çš„ ä½†çŸ­æœŸè¦æ²»æ¨™ï¼Œå¯ä»¥\nå…ˆå€éš” dev stag èˆ‡ prod çš„ terraform repo è·Ÿ aws account æŠŠ prod æ¬Šé™é–èµ·ä¾†ï¼Œå…ˆä¸è¦è®“ junior çš„æˆå“¡å»è§¸ç¢° æ‰€æœ‰ prod apply éƒ½è¦å…©åˆ°ä¸‰å€‹ senior å» approve ä¹Ÿè¨±ä½ å€‘çš„ç”Ÿæ´»æœƒå¿«æ¨‚ä¸€é»(å¥½è¡€æ·š)\nworkshop æˆ‘å€‘æœƒæ ¹æ“š Gruntwork Landing Zone Guide çš„æ–‡å­—æ•˜è¿°ä¾†é€²è¡Œä»Šå¤©çš„ workshop\nCAUTION You must be a Gruntwork subscriber to access the Gruntwork Infrastructure as Code Library. æ˜¯çš„ï¼Œé€™ä»½ Gruntwork Landing Zone Guide å…§éƒ¨çš„ç¯„ä¾‹æœ‰ä½¿ç”¨è¨±å¤š gruntwork-io çš„ private repositoryï¼Œé€™éƒ¨åˆ†æ˜¯éœ€è¦ä»˜è²»ã€‚gruntwork subscription ä¸€å€‹æœˆ $795 èµ·è·³ï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥åƒè€ƒ Gruntwork subscription checkout\næˆ‘å€‘é€™ç¯‡ workshop ä¸¦ä¸ä½¿ç”¨ Gruntwork çš„ä»˜è²»åŠŸèƒ½ï¼Œæ‰€æœ‰ private repository æˆ‘å€‘å°±æœƒä½¿ç”¨å…¶ä»–é–‹æºçš„ modules ä¾†æ›¿ä»£ï¼Œä¾‹å¦‚ä½¿ç”¨ aws + terraform team å®˜æ–¹ç¶­è­·çš„ aws modules\nç”±æ–¼ç¼ºå°‘éƒ¨åˆ† repository çš„å…§å®¹ï¼Œé€™ä»½ Gruntwork Landing Zone Guide æœƒå¸¸å¸¸çœ‹åˆ°å¾ˆå¤š github external link æ˜¯ 404 not foundï¼Œè¡¨ç¤ºæ˜¯ private repositoryã€‚çœ‹èµ·ä¾†æœƒæœ‰é»ä¸èˆ’æœï¼Œä½†æ²’é—œä¿‚æˆ‘å€‘å°±è¦‹æ‹›æ‹†æ‹›è‡ªç”±ç™¼æ®ã€‚\nå»ºç«‹ workspace repository repository çš„å…§å®¹å¯ä»¥ç›´æ¥åƒç…§ Gruntwork Guide çš„å…§å®¹\næœ¬æ¬¡ workshop æˆ‘å€‘ä½¿ç”¨çš„ repository https://github.com/chechiachang/terragrunt-infrastructure-live-example\nterragrunt éƒ½æœƒåœ¨é€™å€‹ repository è£¡é¢é‹ä½œ å„ä½å¯ä»¥ç›´æ¥ copy ä¾†æ”¹ Root account root account æ˜¯æ•´å€‹ account structure æœ€ä¸Šå±¤çš„ accountï¼Œå‰µä¸– accountã€‚ç”±æ–¼æ˜¯å‰µä¸– accountï¼Œæ¬Šé™ä¹Ÿæ˜¯æœ€å¤§ï¼Œå› æ­¤æœƒéœ€è¦åŠ ä¸Šè¨±å¤šé™åˆ¶:\nä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ ä½¿ç”¨å¯†ç¢¼å„²å­˜å™¨ä¿ç®¡å¯†ç¢¼ï¼Œex 1password / lastpass / â€¦ï¼Œé€™äº›å¯†ç¢¼å„²å­˜å™¨éƒ½æœ‰è‡ªå‹•åŠ å¯†ï¼Œä¸”æœ‰é€šéå®‰å…¨é¢¨éšªæ¸¬è©¦ ä¸è¦å­˜åœ¨é›»è…¦ä¸Š / email / google drive / ç´™ä¸Š / æˆ–æ˜¯å…¶ä»–æ²’æœ‰ç¶“éå®‰å…¨é©—è­‰å·¥å…·ä¸Š å‹™å¿…é–‹å•Ÿ MFA åˆªé™¤ root account çš„ aws access keyï¼Œåªå…è¨±é€é aws web console å­˜å– è‡ªå·±å†ä¹Ÿä¸è¦ä½¿ç”¨é€™å€‹å¸³è™Ÿï¼Œé™ä½æ´©æ¼çš„é¢¨éšª AWS å®˜æ–¹å»ºè­°ï¼Œåªæœ‰é€™äº›å·¥ä½œéœ€è¦ä½¿ç”¨ root account ï¼Œå…¶ä»–å·¥ä½œéƒ½ä¸æ‡‰è©²ä½¿ç”¨ root account Root Account IAM user æˆ‘å€‘ä½¿ç”¨ root account çš„æœ€å¾Œä¸€ä»¶å·¥ä½œï¼Œå°±æ˜¯å»ºç«‹ä¸€å€‹ IAM User ä½œç‚º adminï¼Œä¹‹å¾Œä½¿ç”¨é€™å€‹ IAM User æ“ä½œã€‚æ–‡ä»¶èˆ‡æ­¥é©Ÿåœ¨æ­¤\nName: Administrator å‹¾é¸: programmatic access AWS Management Console access Permission é é¢é¸æ“‡ Attach existing policies to user directly å‹¾é¸ AdministratorAccess policy. é»ä¸‹ä¸€æ­¥ï¼Œç›´åˆ°ç”¢ç”Ÿå‡º IAM User å°‡ç™»å…¥è³‡è¨Šå­˜åœ¨å¯†ç¢¼å„²å­˜å™¨ login url name password Access key ID Secret access key æ¥è‘—ä¹Ÿæ˜¯è¦é–ä½ root account çš„ IAM User\nä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ ä½¿ç”¨å¯†ç¢¼å„²å­˜å™¨ä¿ç®¡å¯†ç¢¼ å‹™å¿…é–‹å•Ÿ MFA ç‚º Root account è¨­å®š Security baseline ä¾ç…§ gruntwork guide æ¥ä¸‹ä¾†éœ€è¦è¨­å®šåº•ä¸‹çš„å…ƒä»¶\nå»ºç«‹æ‰€æœ‰çš„ child accounts è¨­å®š AWS Organization IAM ROles IAM Users IAM Groups IAM Password Policies Amazon GuardDuty AWS CloudTrail AWS Config. CAUTION You must be a Gruntwork subscriber to access terraform-aws-service-catalog. ç”±æ–¼ terraform-aws-service-catalog æ˜¯ private repositoryï¼Œéœ€è¦ä»˜è²»è¨‚é–±æ‰èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘å€‘ç„¡æ³•å–å¾—è£¡é¢çš„å…§å®¹\nç‚ºäº†é¿å…é€™å€‹ workshop å¡åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°±ä¾†è‡ªå¹¹é€™äº› module å§ï¼¸ï¼¤\nç›´æ¥ä½¿ç”¨å…¶ä»–çš„é–‹æº modules æ›¿ä»£ ä¾ç…§ guide æŠŠå…ƒä»¶ç”Ÿå‡ºä¾† ç„¶å¾Œä¾ç…§è‡ªå·±çš„éœ€æ±‚å»å®¢è£½åŒ– NOTE: Gruntwork çš„ security module æœ‰å…¶ enterprise solution çš„ç¶“é©—åœ¨è£¡é¢ï¼Œå…¶å¯¦å…¬å¸æœ‰é ç®—é‚„æ˜¯ç›¸ç•¶å€¼å¾—åƒè€ƒçš„ã€‚åªæ˜¯æˆ‘å€‘ workshop ç‚ºäº†å£é¢å¤§å®¶ç ´è²»ï¼Œå…ˆç•¶ä¸€å›å…è²»ä»”ã€‚\næˆ‘å€‘è‡ªå·±çš„ module repository é–‹ä¸€å€‹æ¬Šé™çš„ repository fork æˆ‘è‡ªå¹¹çš„ modules repository terragrunt-infrastructure-modules ä¸Šé¢é€™å€‹æ˜¯æ”¾ terraform module çš„ repositoryï¼Œæ˜¯å…©å€‹ repository ä¸è¦è·ŸåŸ·è¡Œ terragrunt repository ææ··ï¼Œæ˜¯å…©å€‹ repository https://github.com/chechiachang/terragrunt-infrastructure-live-example å¯«åˆ°é€™é‚Šå°± 6000 å­—äº†ï¼Œé‚„æ²’é–‹å§‹ç¢° terragrunt\naws account structure èˆ‡ terragrunt directory structure çš„æ¦‚å¿µéå¸¸é‡è¦ï¼Œæœ‰å¥½çš„åŸºç¤æœƒè®“å¾Œé¢çš„å·¥ä½œå¿«æ¨‚å¾ˆå¤š æ˜å¤©æœƒç¹¼çºŒä»Šå¤©çš„å·¥ä½œï¼ŒæŠŠ aws account / iam policy / permission é…å¥½\n","date":1663233381,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"d9b9f9e8b77dc857ce82518398c4c770","permalink":"https://chechia.net/zh-hant/post/2022-09-13-14th-ithome-ironman-iac-aws-workshop-02-aws-account-structure/","publishdate":"2022-09-15T17:16:21+08:00","relpermalink":"/zh-hant/post/2022-09-13-14th-ithome-ironman-iac-aws-workshop-02-aws-account-structure/","section":"post","summary":"ä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nâ€“\nAWS Account structure AWS account structure æ˜¯ AWS IAM æä¾›çš„ feature ä¹‹ä¸€ï¼Œå¯ä»¥è®“ç”¨æˆ¶å¾ä¸€å€‹ account loginï¼Œç„¶å¾Œé€éæˆæ¬Šæ“ä½œå…¶ä»– account çš„å…ƒä»¶ã€‚\nç„¶è€Œæœ‰é€™å€‹ feature ä¸ä»£è¡¨ç”¨æˆ¶å°±è¦è²·å–®ï¼Œæœ‰å¯¦éš›éœ€æ±‚æˆ‘å€‘æ‰ä¾†ç”¨ featureã€‚ä½¿ç”¨ account structure çš„ç†ç”±æ˜¯ä»€éº¼ï¼Ÿ","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"AWS Account Struture","type":"post"},{"authors":null,"categories":["terraform"],"content":"iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nâ€“\nAWS ç‚ºä¾‹ï¼Œå¯¦ç¾ production framework çš„æœ€ä½³å¯¦è¸çš„ 30 å¤© workshop\næº–å‚™ Production environmtn Devops é¢è‡¨çš„å•é¡Œ DevOps çš„å·¥ä½œå…§å®¹ç¹é›œ\nä»Šå¤©æƒ³è¦ Deploy ä¸€å€‹ backend API deployment åˆ° k8s ä¸Š ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® port / servie / ingress / alb ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® tls certificate ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® node linux ä¸Šçš„ä¸€å€‹ bug ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® monitoring / metrics + alert / log collection â€¦ æˆ‘åªæ˜¯æƒ³ deploy ä¸€å€‹ backend deployment ä¿®infra èŠ±äº†å¥½å¹¾å¤©ï¼Œè€Œå¯« deployment åªè¦ 2 hr Devops çš„å·¥ä½œï¼Œæ˜¯è™•ç† developer èˆ‡ operator ä¸­é–“çš„ç¹é›œçš„ç´°ç¯€ æ›å€‹è§’åº¦æ€è€ƒï¼šä¸Šé¢é€™äº›å…ƒä»¶å…¨éƒ½æ˜¯å­˜åœ¨è¨±ä¹…çš„åŠŸèƒ½ï¼Œæ‡‰è©²æœ‰ä¸€å¥—çµ±ä¸€ä»‹é¢éš¨å«å³ç”¨é€™äº›æœå‹™ï¼Œex.\nä»Šå¤©æƒ³è¦ Deploy ä¸€å€‹ backend API deployment åˆ° k8s ä¸Š æ‰¿ä¸Šï¼ŒåŒå€¼æ€§é«˜ï¼Œcoding è¬›æ±‚ DRY åŸå‰‡ (Donâ€™t Repeat Youself)ï¼Œinfra ç®¡ç†ä¸Šå»æœƒæœ‰å¤§é‡é‡è¤‡çš„å·¥ä½œ\né–‹ä¸€å€‹ Restful API deployment é–‹ä¸€å€‹ GRPC deployment é–‹ä¸€å€‹ Kafka message Queue / redis / RDS / â€¦ å¸Œæœ›é€™äº›å…ƒä»¶éƒ½æœ‰å¯«å¥½çš„ unit å¯ä»¥é‡è¤‡ä½¿ç”¨ ä½†å¯¦å‹™ä¸Šé‚„æ˜¯æœƒæœ‰ç´°ç¯€éœ€è¦èª¿æ•´ è‡ªå‹•åŒ–\næ¨™æº–åŒ–åŠŸèƒ½å¾Œï¼Œæ‡‰è©²è¦å¯ä»¥è‡ªå‹•éƒ¨ç½² ç”šè‡³æ˜¯ç•¶ Backend API deployment éƒ¨ç½²ä¸Šå»æ™‚ï¼Œè‡ªå‹•èª¿ç”¨ç”¢ç”Ÿå°æ‡‰çš„å…ƒä»¶ Backend API deployment æœ‰è®ŠåŒ–æ™‚æ‡‰è©²è¦è·Ÿæ“š deployment éœ€æ±‚å»åš reconcile (k8s controller) ç¼ºä¹æ¸¬è©¦\nVM / alb / RDS / â€¦ ç­‰å…¬æœ‰é›²æœå‹™éœ€è¦æ¸¬è©¦å— A: AWS / Google / Azure éƒ½æ¸¬éäº†ï¼Œæˆ‘å€‘ä¸ç”¨å†æ¸¬ ç„¶è€Œ SRE å»ç™¼ç¾æ™‚å¸¸éœ€è¦èŠ±æ™‚é–“ debug é€™äº›å…ƒä»¶ ä¸æ˜¯ functional issueï¼Œè€Œæ˜¯ configuration å•é¡Œï¼Œæˆ–æ˜¯ä¸åŒå…ƒä»¶è¨­å®šé€ æˆäº¤äº’ä½œç”¨ B: è¦ä¸Š production çš„å…ƒä»¶éƒ½è¦æ¸¬è©¦ ä½¿ç”¨ terraform provision ä¸€å° EC2 å¾Œï¼Œåœ¨ä½¿ç”¨ terratest (Golang) æ‰“ aws API é€²è¡Œæ¸¬è©¦ æ¨™æº–åŒ–ï¼Œè‡ªå‹•åŒ–å¾Œï¼Œæ‡‰è©²æœ‰å¤§é‡çš„è‡ªå‹•åŒ–æ¸¬è©¦ï¼Œä¾†ç¢ºä¿æ¯ä¸€å€‹å…ƒä»¶çš„ configuration éƒ½æ˜¯æ­£ç¢ºçš„ï¼Œè€Œä¸”æœ‰ä¿¡å¿ƒç¶­æŒç©©å®šåº¦ infra æ™‚å¸¸æ”¹è®Š\næŠ€è¡“å…ƒä»¶æ™‚å¸¸æ”¹è®Šï¼šterraform å‡ç´šï¼Œaws å‡ç´šï¼Œk8s å‡ç´šï¼Œlinux å‡ç´šèˆ‡ patch infra æ²’æœ‰å°„å¾Œä¸ç†é€™ç¨®äº‹ï¼Œéƒ½éœ€è¦æ™‚å¸¸ä¸”ç©©å®šçš„æ›´æ–° ç‚ºäº†æ»¿è¶³ä¸Šæ¸¸æœå‹™(å‰å¾Œç«¯/DB/â€¦)çš„éœ€æ±‚ èª¿æ•´ VM spec / networking / routing / security rules / ä¸æ–·çš„æ”¹è®Šè€—è²»å¤§é‡çš„äººå·¥æ™‚é–“ production ready éœ€è¦æº–å‚™çš„\nproduction -\u0026gt; çœŸé‡‘ç™½éŠ€ï¼Œå…¬å¸çš„æ¥­å‹™èˆ‡åè² production ready æ‡‰è©²æ˜¯æœ‰æ˜ç¢ºçš„è¡¨æº– True / Falseï¼Œè€Œä¸æ˜¯ã€æˆ‘è¦ºå¾—ç¾åœ¨æ˜¯ production ready äº†ã€ DevOps / SRE éƒ½çŸ¥é“ production ready çš„æ¨™æº–ï¼Œåªæ˜¯æ²’æœ‰æŠŠä»–æ˜ç¢ºå¯«å‡ºä¾† production ready æ‡‰è©²å°±è·Ÿ unit test ä¸€æ¨£ï¼Œä¸€å€‹ checklist è·‘ä¸‹å»æª¢æŸ¥ï¼Œé€šéå°±æ˜¯ production-readyï¼Œä¸é€šéå°±æ˜¯ not-readyï¼Œä¸”æœƒèªªæ˜ä¸é€šéçš„åŸå›  Gruntwork production ready checklist äººå·¥ä»‹å…¥å·¥ä½œå¤ªå¤š\næ–°å¢å…ƒä»¶éœ€è¦äººå·¥è™•è£¡ å®šæœŸçš„ patch \u0026amp; update / å®‰å…¨æ€§æ›´æ–° / deploy éƒ½éœ€è¦äººå·¥ä»‹å…¥çš„è©±å°±å¤ªæµªè²»æ™‚é–“äº† äººå·¥å·¥ä½œå¤ªå¤šå®¹æ˜“é€ æˆäººç‚ºéŒ¯èª¤(human error) å¤šç’°å¢ƒ\nSRE éœ€è¦æä¾›å¤§é‡çš„ç’°å¢ƒ dev / qa / stag / prod â€¦ æˆ–æ˜¯ææ—© scan åˆ°æ›´å‰é¢çš„å·¥ä½œæµç¨‹ï¼Œä¾‹å¦‚åœ¨ code base / reposiroty ä¸­å°±å…ˆ scan Gruntwork solution ç‚ºä½•è¦ä½¿ç”¨ gruntwork framework\nWhy you need a framework\nGruntwork æå‡ºå…©å€‹ solution\nReference Architecture Build your own architecture Prerequisites ç”±æ–¼æœ¬æ¬¡åˆ†äº«ä¸å¸Œæœ›æœ‰å¤šé¤˜çš„è²»ç”¨ï¼Œæ‰€ä»¥å…§å®¹ä¾æ“š gruntwork å…¬é–‹ç¶²ç«™èˆ‡é–‹æºçš„ repository å…§å®¹è¬›è§£ä½¿ç”¨\nä¸æœƒæ¶‰åŠä»˜è²»ç‰ˆçš„ terraform code library å…§å®¹èˆ‡æ•™æ(subscription $795/month) aws æœå‹™ä¹Ÿç›¡é‡ä½¿ç”¨ free tier ä¸­çš„é¡åº¦ Prerequisites\nåŸºæœ¬ Terraform ç¶“é©—ï¼Œæˆ–æ˜¯åƒè€ƒ2021 å¹´çš„éµäººè³½ç³»åˆ—æ–‡ç« : 30 å¤©å­¸ Terraform on Azure åŸºæœ¬ AWS æœå‹™çš„è§€å¿µ éƒ½æ²’æœ‰ä¹Ÿæ²’é—œä¿‚ï¼Œæœƒæ²¿è·¯åœ¨å¹«å„ä½è¤‡ç¿’ 30 å¤©çš„ç›®æ¨™ ä½¿ç”¨ terraform è¨­å®šæ‰€æœ‰ aws account çš„ resource åƒè€ƒ gruntwork-io çš„é–‹æº repositoryï¼Œè¨­å®š å¦‚æœæ˜¯æ¸¬è©¦æˆ–å­¸ç¿’ï¼Œå¯ä»¥åƒè€ƒ https://github.com/gruntwork-io/terraform-aws-service-catalog å­¸ç¿’ç›®æ¨™\nç†Ÿæ‚‰ terraform åŸºæœ¬è§€å¿µ å­¸æœƒä½¿ç”¨ terraform IaC æ§åˆ¶æ‰€æœ‰ aws service Repository NOTE: å¦‚æœæ˜¯æœ‰è³¼è²· gruntwork subscription çš„æœ‹å‹ï¼Œè«‹ä½¿ç”¨ç§æœ‰çš„ IaC library repositoryï¼Œæœ‰æ›´å®Œæ•´ä¸”ç¶“éæ¸¬è©¦çš„æ¶æ§‹\næœ¬èª²ç¨‹ä½¿ç”¨ gruntwork é–‹æºçš„ repository æ¶æ§‹\nè«‹ copy éœ€è¦çš„éƒ¨åˆ†ï¼ˆè€Œä¸è¦ forkï¼Œå› ç‚ºé€™è£¡ä¸éœ€è¦éå»çš„ commit history èˆ‡æœªä¾†çš„ update)\nå»å¹´iThome éµäººè³½ä½¿ç”¨çš„ç¯„ä¾‹ repository æˆ‘è‡ªå·±ä½¿ç”¨çš„ repo ä»Šå¹´ iThome æœƒä½¿ç”¨çš„ repository ä»Šå¤©è¦åšçš„äº‹ è«‹æº–å‚™å¥½ä»¥ä¸‹ prerequisite\nè¨­å®š / è¨»å†Š aws account ä½µå–å¾— aws 12-month free-tier (é æœŸæ˜¯å…è²»çš„é æœŸ 12-month free tier å³å¯åŒ…å«æ‰€æœ‰å…§å®¹) ç„¶è€Œæˆæœ¬æ§åˆ¶ä¹Ÿæ˜¯èª²ç¨‹çš„ä¸€ç’°ï¼Œå„ä½è¦æ³¨æ„ä½¿ç”¨çš„è³‡æºï¼Œä¸è¦è¶…é aws free tier å¤ªå¤šï¼Œç†è«–ä¸Šä¹Ÿæ˜¯æœ€å¤šå¹¾ç¾é‡‘çš„èŠ±è²» å®‰è£èˆ‡è¨­å®š terraform tools terraform 1.2.9 terragrunt 0.38.9 ä½¿ç”¨èˆŠç‰ˆæœ¬çš„æœ‹å‹è«‹ç›¡é‡ä½¿ç”¨ terraform \u0026gt;1.x èˆ‡ terragrunt \u0026gt;0.35.8 çš„ç‰ˆæœ¬ Aws account\nå¦‚æœå·²ç¶“æœ‰ aws cloud service account å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæœ¬èª²ç¨‹æœƒä½¿ç”¨å…¨æ–°çš„ aws account ä½¿ç”¨ email è¨»å†Š aws cloud service email èªè­‰ ä¿¡ç”¨å¡ç™»è¨˜ æ‰‹æ©Ÿèªè­‰ Install terraform\nterraform 1.2.9 terragrunt 0.38.9 è¨­å®š Github repository æº–å‚™ä¸€å€‹ github repository ä¾†å­˜æ”¾ã„çš„ terraform code\nå¯ä»¥ä½¿ç”¨æˆ‘çš„ç¯„ä¾‹ repositoryï¼Œä¹Ÿæ˜¯ fork åº•ä¸‹ gruntwork çš„ repository ç¨ä½œæ•´ç† æˆ–åƒè€ƒ gruntwork Github repository example git clone git@github.com:chechiachang/terragrunt-infrastructure-live-example.git æ˜å¤© å¸¶è‘—å¤§å®¶åœ¨ terraform code ä¸­è¨­å®š aws account èˆ‡ IAM æ¬Šé™\nåƒè€ƒè³‡æº ä¸ç†Ÿæ‚‰ terraform çš„æœ‹å‹ä¸å¦¨åƒè€ƒå»å¹´çš„ä½³ä½œ Terraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©ï¼Œé›–ç„¶æ˜¯åœ¨ Azure ä¸Š ï¼Œä½†è¨±å¤šåŸºæœ¬æ¦‚å¿µéƒ½æ˜¯ç›¸é€šçš„\néå»çš„éµäººè³½æ–‡ç« \n13th ä½³ä½œ Terraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤© 12th ä½³ä½œ Kubernetes X DevOps X å¾é›¶é–‹å§‹å°å…¥å·¥å…· X éœ€æ±‚åˆ†æï¼Šå¾åº•å±¤é–‹å§‹ç ”ç©¶åˆ°æ‡·ç–‘äººç”Ÿçš„é«”æ‚Ÿï¼Š 11th å„ªå‹ å…¶å¯¦æˆ‘çœŸçš„æ²’æƒ³éåªæ˜¯æŠŠæœå‹™ä¸Ÿä¸Š kubernetes å°±æœ‰é€™éº¼å¤šå•é¡Œåªå¥½ä¾†åƒåŠ 30å¤©åˆ†äº«é‚£äº›å¹´æˆ‘æ€éº¼åœ¨ kubernetes ä¸Šè¸©é›·å„é …æœå‹™ kkk æ¨è–¦ä¸€ä¸‹ Gruntwork ä»–å€‘å®¶çš„ blog: Gruntwork devops as a service\nQ\u0026amp;A éå»åƒè³½éƒ½æœƒæœ‰è¨±å¤šæœ‹å‹æå‡ºå•é¡Œï¼Œä»Šå¹´è‹¥æœ‰ç–‘å•å¯ä»¥é›†ä¸­åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘æœƒè·Ÿå¤§å®¶ä¸€èµ·è¨è«–ã€‚æœ‰æƒ³è¦çœ‹çš„é¡Œç›®ä¹Ÿå¯ä»¥ç•™è¨€ï¼Œæˆ‘å€‘çœ‹æ™‚é–“åšå®‰æ’ã€‚\nreferences https://docs.gruntwork.io/intro/overview/how-it-works ","date":1662964308,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"97c2f2c800290596eab5d3a84d18c24d","permalink":"https://chechia.net/zh-hant/post/2022-09-12-14th-ithome-ironman-iac-aws-workshop-01-introduction/","publishdate":"2022-09-12T14:31:48+08:00","relpermalink":"/zh-hant/post/2022-09-12-14th-ithome-ironman-iac-aws-workshop-01-introduction/","section":"post","summary":"iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nâ€“\nAWS ç‚ºä¾‹ï¼Œå¯¦ç¾ production framework çš„æœ€ä½³å¯¦è¸çš„ 30 å¤© workshop\næº–å‚™ Production environmtn Devops é¢è‡¨çš„å•é¡Œ DevOps çš„å·¥ä½œå…§å®¹ç¹é›œ\nä»Šå¤©æƒ³è¦ Deploy ä¸€å€‹ backend API deployment åˆ° k8s ä¸Š ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® port / servie / ingress / alb ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® tls certificate ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® node linux ä¸Šçš„ä¸€å€‹ bug ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® monitoring / metrics + alert / log collection â€¦ æˆ‘åªæ˜¯æƒ³ deploy ä¸€å€‹ backend deployment ä¿®infra èŠ±äº†å¥½å¹¾å¤©ï¼Œè€Œå¯« deployment åªè¦ 2 hr Devops çš„å·¥ä½œï¼Œæ˜¯è™•ç† developer èˆ‡ operator ä¸­é–“çš„ç¹é›œçš„ç´°ç¯€ æ›å€‹è§’åº¦æ€è€ƒï¼šä¸Šé¢é€™äº›å…ƒä»¶å…¨éƒ½æ˜¯å­˜åœ¨è¨±ä¹…çš„åŠŸèƒ½ï¼Œæ‡‰è©²æœ‰ä¸€å¥—çµ±ä¸€ä»‹é¢éš¨å«å³ç”¨é€™äº›æœå‹™ï¼Œex.","tags":["terraform","iac","aws","éµäººè³½2022"],"title":"IaC best practice workshop on aws","type":"post"},{"authors":null,"categories":["Technology"],"content":"Titleq å¾é›¶å°å…¥ Policy as Code åˆ° terraform ç”˜è‹¦è«‡ - Introducing policy as code for terraform\nPresentation Google Slides\nDescription Terraform æ˜¯ä¸€å€‹å¾ˆæ£’çš„ Infrastructure as Code çš„å·¥å…·ï¼Œèƒ½å¤ ä»¥ç¾ä»£çš„è»Ÿé«”å·¥ç¨‹æµç¨‹ä¾†ç©©å®šçš„å»ºæ§‹ infrastructureï¼Œä¸¦éš¨è‘—éœ€æ±‚è®Šæ›´è‡ªå‹•åŒ–è¿­ä»£ï¼Œå°‡æ–°çš„ feature å®‰å…¨åœ°æ›´æ–°åˆ°æ—¢æœ‰çš„ infrastructure ä¸Šã€‚åªè¦æ˜¯ Infrastructure æœ‰é—œçš„å•é¡Œï¼Œæˆ‘ä¸€å¾‹æ¨è–¦ Terraformã€‚\né€™ä¹Ÿæ„å‘³ Terraform çš„å“è³ªå°±ç­‰æ–¼ infrastructure çš„å“è³ªï¼Œå¥½çš„ terraform å¸¶ä½ ä¸Šå¤©å ‚ï¼Œä¸å¥½çš„ terraform å…¨ team ç«è‘¬å ´ã€‚\nInfrastructure æœ‰å¤ªå¤šè³‡å®‰çš„è€ƒé‡ï¼Œæ–°çš„é¢¨éšªä¸æ–·è¢«æª¢æŸ¥å‡ºä¾†ï¼Œé€£å¸¶è¦ä¸æ–·çš„ patch terraform code ä¾†é¿å…æ½›åœ¨çš„è³‡å®‰é¢¨éšª Infrastructure æœƒä¸æ–·åœ°æ›´æ–°ï¼Œä¾‹å¦‚å…¬æœ‰é›²çš„ api ä¸æ–·æ›´æ–°ï¼Œå»å¹´çš„ code å·²ç¶“è·Ÿä¸ä¸Šä»Šå¹´çš„æœ€ä½³å¯¦è¸äº† å¥½çš„å·¥ç¨‹å¸«å¯«å‡ºçš„ terraform code å±Œæ‰“èœé³¥å·¥ç¨‹å¸«ï¼Œè¦å¦‚ä½•è®“åœ˜éšŠä¾å¾ªæ›´å¥½çš„å¯¦è¸ï¼Œé¿å…å¯«å‡ºçˆ› code ç¶­è­· code æœ‰ clean code / best practiceï¼ŒTerraform ä¹Ÿæœ‰ clean code èˆ‡ best practiceï¼Œå·¥ç¨‹å¸«è¦å¦‚ä½•å·¥å…·ä¾†è¼”åŠ©ï¼Œæ˜¯ Policy as Code çš„ä¸€å¤§èª²é¡Œã€‚ æœ¬æ¼”è¬›èšç„¦æ–¼å¯¦éš›ç¶“é©—ï¼Œå¾ä¸€å¤§å † terraform modules é–‹å§‹ï¼Œæ²’æœ‰ Policy as Codeï¼Œåˆ°ä¸€æ­¥æ­¥è©•ä¼°ã€å°å…¥ã€å¯¦ä½œã€æ”¹é€²èˆ‡è¿­ä»£ï¼Œé€æ¼¸çš„æå‡åœ˜éšŠ Terraform code å“è³ªï¼Œæå‡ infrastructure äº¤ä»˜å“è³ªï¼Œä¸¦é¿å…åˆ°æœªä¾†æ½›åœ¨çš„é¢¨éšªã€‚\næœ¬æ¬¡æ¼”è¬›çš„ Terraform ç‰ˆæœ¬ç‚ºå¾ 0.12, 0.13, ä¸€è·¯æ¨é€² 1.0+ã€‚\nContent å¾é›¶å°å…¥ Policy as Code åˆ° terraform ç”˜è‹¦è«‡\nç°¡ä»‹ Terraform èˆ‡ Policy as Code ç•¶ä½ æ‰‹ä¸Šæœ‰æ•¸ä¸å®Œçš„ terraform modulesï¼Œç®¡ç† terraform å“è³ªæ˜¯å€‹å¤§å•é¡Œ å¦‚ä½•ç®¡ç† Terraform è‡ªå‹•åŒ–: æ”¹è®Šå¾ Jenkins pipeline é–‹å§‹ï¼Œgitflow æ”¹é€²ï¼Œpre-commit hook Policy as Code æ ¡é©— ä½¿ç”¨å·¥å…·é‡åŒ– terraform code å“è³ª å®Œæ•´å°å…¥ Policy as Code å°çµ: ç© infra å¿…ç”¨ terraformï¼Œç© terraform å¿…åš policy as code About me Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit 2019 Ithome Cloud Summit 2020 Ithome Cloud Summit 2020/12/18\tCloud Native Taiwan å¹´æœ«èšæœƒ 2020/8/17\tDevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2021 Ithome Cloud Summit 2022 Ithome Cloud Summit 2022 COSCUP\nSuggested Audience æ¨è–¦æœ‰ Terraform ä½¿ç”¨ç¶“é©—ï¼Œç‰¹åˆ¥æ˜¯å…¬æœ‰é›²ç¶“é©—ï¼Œå° Policy as Code æœ‰èˆˆè¶£çš„äºº æƒ³è¦å¯«å‡º Terraform clean code çš„äºº ","date":1654707852,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"b1e366b15d0a114530fef8154d410d7f","permalink":"https://chechia.net/zh-hant/post/2022-06-09-ithome-devopsday-2022-proposal-introduce-policy-as-code-for-terraform-/","publishdate":"2022-06-09T01:04:12+08:00","relpermalink":"/zh-hant/post/2022-06-09-ithome-devopsday-2022-proposal-introduce-policy-as-code-for-terraform-/","section":"post","summary":"Titleq å¾é›¶å°å…¥ Policy as Code åˆ° terraform ç”˜è‹¦è«‡ - Introducing policy as code for terraform\nPresentation Google Slides\nDescription Terraform æ˜¯ä¸€å€‹å¾ˆæ£’çš„ Infrastructure as Code çš„å·¥å…·ï¼Œèƒ½å¤ ä»¥ç¾ä»£çš„è»Ÿé«”å·¥ç¨‹æµç¨‹ä¾†ç©©å®šçš„å»ºæ§‹ infrastructureï¼Œä¸¦éš¨è‘—éœ€æ±‚è®Šæ›´è‡ªå‹•åŒ–è¿­ä»£ï¼Œå°‡æ–°çš„ feature å®‰å…¨åœ°æ›´æ–°åˆ°æ—¢æœ‰çš„ infrastructure ä¸Šã€‚åªè¦æ˜¯ Infrastructure æœ‰é—œçš„å•é¡Œï¼Œæˆ‘ä¸€å¾‹æ¨è–¦ Terraformã€‚","tags":["pac","devops","terraform"],"title":"IThome 2022 DevOpsDay Introducing policy as code for terraform","type":"post"},{"authors":null,"categories":["Technology"],"content":"Titleq åœ¨ k8s ä¸Šè·‘ time series database ç”˜è‹¦è«‡ - Operating Time Series Database in K8s\nGoogle Slides Youtube live record: https://youtu.be/YexUnVOZC8M?t=9421\nDescription Influxdb ç‚ºå¸‚å æœ€é«˜çš„ time series DBMS ä¹‹ä¸€ï¼Œä½¿ç”¨ä¸Šèˆ‡ RDBMS æœ‰ä¸åŒå„ªåŠ£å‹¢ã€‚\nåœ¨ç¶­é‹æ–¹é¢ï¼Œdatabase æœ‰è¨±å¤šç›¸ä¼¼éœ€æ±‚ï¼šç©©å®šæ€§ã€é«˜å¯ç”¨æ€§ã€å‚™ä»½ã€é‚„åŸã€è³‡æºç®¡ç†ã€èª¿åº¦ã€ç½é›£å¾©åŸâ€¦ç­‰ã€‚ç¤¾ç¾¤å¸¸è½åˆ°æœ‰äººå•ï¼šå¯ä¸å¯ä»¥åœ¨ K8s ä¸Šè·‘ databaseã€‚\næœ¬æ¼”è¬›æœƒåˆ†äº«åœ¨ k8s ä¸­ç¶­é‹ï¼Œå¯¦å‹™ä¸Šæ‰€é‡åˆ°çš„å•é¡Œï¼Œæä¾›ä¸€äº›æ€è€ƒæ–¹å‘ã€‚\næœ¬æ¬¡æ¼”è¬›çš„ influxdb ç‰ˆæœ¬ç‚º Influxdb OSS / enterprise 1.9+\nInfluxDB is one the the most popular time series database management system (DBMS) and is a powerful platform when dealing with time series data.\nDBMSs, including RDBMS, have many similar requirements on aspect of infrastructure operation. They all require stability, high availability, backup and restore utilities, cpu / memory resource management, disaster recoveryâ€¦etc. People often ask about that whether is it ok to run DBMS in kubernetes cluster or not. This lecture try to provide some points from our experiences dealing with real-world issues.\nThe version of InfluxDB discussed in the lecture is InfluxDB OSS / Enterprise 1.9+\nContent åœ¨ k8s ä¸Šè·‘ time series database ç”˜è‹¦è«‡\nç°¡ä»‹ Influxdbï¼Œtime series èˆ‡ RDBMS çš„å·®ç•° ä½¿ç”¨ time series çš„å¹¾å€‹æƒ…å¢ƒ: åœ¨ k8s ä¸Šè·‘ DB ç©©å®šæ€§ Availabilityã€HA (enterprise)ã€faillure recovery è³‡æºç®¡ç† OOMKilledã€cpu throttlingã€OutOfDisk DB management: data migrationã€backup \u0026amp; restoreã€data retention å°çµ: ä½ è©²ä¸è©²ç”¨ cloud service / VM / åœ¨ K8s ä¸Šè·‘ database Operating Time Series Database in K8s\nA brief introduction about InfluxDB and the differences with RDBMS Some scenario to use a time series database (other than RDBMS) Operate InfluxDB in K8s Stability, availability, disaster recovery Resource management, OOMKilled, cpu throttling, out of disk DB management: data migration, retention, rotation, backup \u0026amp; restore summary: whether or not to run a database in k8s About me Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit 2019 Ithome Cloud Summit 2020 Ithome Cloud Summit 2020/12/18\tCloud Native Taiwan å¹´æœ«èšæœƒ 2020/8/17\tDevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2021 Ithome Cloud Summit\nSuggested Audience æ¨è–¦æœ‰ k8s ä½¿ç”¨ç¶“é©—çš„å¾æ¥­äººå“¡ï¼Œå° k8s æœ‰ä¸Šæ‰‹ç¶“é©— å•å¯ä¸å¯ä»¥åœ¨ k8s ä¸Šé¢è·‘ database çš„äºº ","date":1653066252,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"56672428516db290abe4cd5185237096","permalink":"https://chechia.net/zh-hant/post/2022-05-21-coscup-proposal-operating-time-series-database-in-k8s/","publishdate":"2022-05-21T01:04:12+08:00","relpermalink":"/zh-hant/post/2022-05-21-coscup-proposal-operating-time-series-database-in-k8s/","section":"post","summary":"Titleq åœ¨ k8s ä¸Šè·‘ time series database ç”˜è‹¦è«‡ - Operating Time Series Database in K8s\nGoogle Slides Youtube live record: https://youtu.be/YexUnVOZC8M?t=9421\nDescription Influxdb ç‚ºå¸‚å æœ€é«˜çš„ time series DBMS ä¹‹ä¸€ï¼Œä½¿ç”¨ä¸Šèˆ‡ RDBMS æœ‰ä¸åŒå„ªåŠ£å‹¢ã€‚","tags":["kubernetes","devops","terraform"],"title":"2022 05 21 COSCUP Operating Time Series Database in K8s","type":"post"},{"authors":null,"categories":["Technology"],"content":"å„ä½å¥½\né—œæ–¼é€™å€‹ QRcode\næ¯æ¬¡ä¸Šå°å‰ï¼Œæˆ‘éƒ½æœƒæƒ³è¦å¸¶ä»€éº¼æ¨£çš„å…§å®¹çµ¦è§€çœ¾ï¼Œè®“è§€çœ¾å€¼å¾—èŠ± 30 åˆ†é˜åœ¨åº•ä¸‹è½ã€‚å¾Œä¾†å°±ç¿’æ…£å…ˆç™¼è¡¨ä¸€ç¯‡æ–‡ç« ï¼ŒæŠŠå°è§€çœ¾æœ‰å¹«åŠ©çš„è³‡æºåŒ…æˆä¸€åŒ…ï¼š\né¦–å…ˆæ˜¯å®Œæ•´æŠ•å½±ç‰‡ï¼šhttps://slides.com/chechiacâ€¦/terraform-introduction-a56697 é€å­—è¬›ç¨¿ï¼š(æœ€å¾Œæ ¡ç¨¿ä¸­ï¼‰ ç„¶è€Œåªæœ‰æœ¬æ¬¡æ¼”è¬›å…§å®¹ï¼Œå›å»å¯èƒ½é‚„æ˜¯ä¸å¤ªå®¹æ˜“æ“ä½œã€‚æ‰€ä»¥é€™æ¬¡é™„ä¸Šä½¿ç”¨ Terraform ä¸€éµéƒ¨ç½² vault çš„ Github Repositoryï¼šhttps://github.com/â€¦/southeâ€¦/chechia_net/vault/singleton å¦‚æœä¸ç†Ÿ Terraformï¼Œå†é™„ä¸Š 30 å¤©æ‰‹æŠŠæ‰‹ Terraform æ•™å­¸æ–‡ç« ï¼Œåªè¦é¡˜æ„èŠ±æ™‚é–“ï¼Œå…¨ç¯‡ä¸­æ–‡ä¸€å€‹æœˆå¸¶ä½ ä¸Šæ‰‹ Terraformã€‚ IThome éµäººè³½å¥½è®€ç‰ˆï¼šhttps://ithelp.ithome.com.tw/users/20120327/ironman/4057 Github Repository å®Œæ•´ç‰ˆï¼šhttps://github.com/â€¦/terraform-30â€¦/tree/main/lecture/zh å¦‚æœé‡åˆ°å•é¡Œé‚„æ˜¯éœ€è¦æ‰¾äººç™¼å•ï¼Œæ‰€ä»¥å†æ¨è–¦å…©å€‹ç¤¾ç¾¤ï¼Œå¯ä»¥ä¾†é€™é‚Šç™¼å•ï¼Œè¦æ‰¾æˆ‘æœ¬äººä¹Ÿæ‰¾å¾—åˆ°ã€‚ç”šè‡³åªæ˜¯åŠ å…¥æ½›æ°´ä¸è¬›è©±ï¼Œéƒ½å¯ä»¥è¢«å‹•å¸æ”¶è¨±å¤šæ–°çŸ¥ã€‚ Cloud Native Taiwan User Group https://t.me/cntug https://fb.cloudnative.tw DevOps Taiwan Meetup Group https://t.me/devopstw å¤§å®¶å¯ä»¥æ‰‹æ©Ÿæ‹å®Œé€™å€‹å°±å‡ºå»åƒåˆé¤äº†ã€‚ æˆ–æ˜¯æ‹å›å®¶ï¼Œç„¶å¾Œå‚³çµ¦ä¸€å€‹åŒäº‹å«ä»–èŠ± 30 å¤©æŠŠ Terraform è·Ÿ Vault é€™äº›éƒ½å­¸æœƒã€‚\nç¸½ä¹‹å¸Œæœ›å°å„ä½æœ‰å¹«åŠ©ï¼Œè®“åœ‹å…§æŠ€è¡“åŠ›èƒ½æŒçºŒé€²æ­¥æˆé•·ã€‚\nå›åˆ°æœ¬æ¬¡æ¼”è¬›ã€‚\næœ¬æ¬¡æ¼”è¬›æœ‰ä¸‰å€‹é—œéµå­—\nKubernetes Vault Terraform é€™å€‹æ˜¯éš±è—çš„ è«‹å•å¹³æ™‚å·¥ä½œæœƒç”¨åˆ°é€™ä¸‰å€‹æŠ€è¡“ä¹‹ä¸€çš„æœ‹å‹ï¼Œè«‹èˆ‰å€‹æ‰‹ï¼Œå¥½è®“æˆ‘çŸ¥é“ä¸€ä¸‹è§€çœ¾çš„åˆ†å¸ƒï¼Œç­‰ç­‰åˆ†äº«çš„å…§å®¹æœƒç…§æ¯”ä¾‹åšä¸€äº›èª¿æ•´ã€‚\næˆ‘å€‘ä»Šå¤©ä¸æœƒè¬›å¤ªå¤š Kubernetes çš„å…§å®¹ï¼Œé‡é»æ”¾åœ¨ Vaultï¼Œä»¥åŠå¦‚ä½•è¨­å®š Vaultï¼Œæ‰€ä»¥ Terraform Infrastructure as Code æˆ–æ˜¯ configuration as Code æœƒåœ¨é€™é‚Šè·‘å‡ºä¾†ã€‚\né—œæ–¼æˆ‘ï¼Œæˆ‘æ˜¯å“²å˜‰ã€‚æˆ‘åœ¨ Maicoin ç•¶ SREã€‚å¸¸å‡ºç¾çš„ç¤¾ç¾¤æ˜¯ CNTUG èˆ‡ DevOpsTWã€‚\næˆ‘å€‘ä»Šå¤©è«‡çš„æ›´å¤§çš„ä¸»é¡Œå…¶å¯¦æ˜¯ Key Management ç§é‘°ç®¡ç†ï¼Œæˆ–æ˜¯å¯†ç¢¼ç®¡ç†ã€‚é€™æ˜¯ä¸€å€‹å¾ˆå¤§çš„é¡Œç›®ï¼Œä»Šå¤©æ¼”è¬›å…§å®¹åªæ˜¯å…¶ä¸­çš„ä¸€å€‹å¯¦ä½œæ¡ˆä¾‹ã€‚\nèˆ‰å€‹ä¾‹å­ï¼Œä¸€é‚Šæ˜¯ API Serverï¼Œå¦ä¸€é‚Š Databaseï¼Œæˆ–æ˜¯ç¬¬ä¸‰æ–¹æœå‹™\nDatabase ä¾† Authenticate åˆæ³•çš„ Client ç”¨æˆ¶ç«¯ï¼Œå¯èƒ½æ˜¯ username + passwordï¼Œæˆ–æ˜¯ API Key + Secretï¼Œæˆ–æ˜¯ Access Tokenï¼Œæˆ–æ˜¯ Private Keyï¼ŒClient Certificateï¼Œéƒ½å¯ä»¥ã€‚\nåœ¨è·¨ä¸åŒå¹³å°æˆ–æ˜¯ä»‹é¢çš„æœå‹™ï¼Œæˆ‘å€‘å¸¸ç”¨çš„ Auth æ–¹æ³•ã€‚èª Key ä¸èªäººã€‚\né‚£ä¸­é–“é€™äº› Key è¦æ€éº¼ç®¡ç†ï¼Œå°±æœ‰å¾ˆå¤šå­¸å• å…¶ä¸­æœ€åŸºæœ¬çš„ï¼Œæ˜¯æ€éº¼é…ç½®çµ¦ API Server è®“ä»–ä½¿ç”¨ æ³¨æ„ï¼šè®“ API Server ä½¿ç”¨ï¼Œéš±å«çš„æ„æ€æ˜¯ï¼Œå…¶ä»–äººä¸ç®¡æ˜¯å…¶ä»–å¾®æœå‹™ï¼Œæˆ–æ˜¯é–‹ç™¼å·¥ç¨‹å¸«ï¼Œé–’é›œäººç­‰éƒ½ä¸èƒ½çœ‹åˆ°ã€‚\né€™é‚Šæˆ‘å€‘å‡è¨­ API Server æ˜¯åœ¨ Kubernetes è£¡é¢è·‘ï¼Œå¾®æœå‹™æ¶æ§‹ï¼Œæ‰€ä»¥ API Server å¯èƒ½æ˜¯ä¸€å€‹ Podï¼Œæˆ‘å€‘ SRE è¦ç‚ºé€™çµ„ Pod é…ç½®å¯†ç¢¼ã€‚\né€™é‚Šåˆ—å‡ºçš„æ‡‰è©²æ˜¯ K8s æ¯”è¼ƒå¸¸è¦‹çš„å¹¾ç¨®åšæ³•ã€‚\nplain textï¼Œç›´æ¥å¯«é€² file è®“ Pod å»è®€å– k8s secret åš base64 encode å®‰å…¨ä¸€é»çš„é€éå¤–éƒ¨æ©Ÿåˆ¶ä½œåŠ å¯†è§£å¯† æˆ–æ˜¯å¯«åœ¨ API Server çš„ memory ä¸­ äº‹å¯¦ä¸Šå¦‚æœæ²’æœ‰ä½¿ç”¨ K8sï¼Œä½¿ç”¨ VM æˆ–æ˜¯å…¬æœ‰é›² Container Serviceï¼Œæ‡‰è©²éƒ½æ˜¯é¡ä¼¼çš„åŸç†ï¼Œå¤§å®¶éƒ½æ˜¯ Linux baseï¼Œsecret æ”¾é€²ä¾†çœ‹è¦æ”¾åœ¨ disk æˆ–æ˜¯ memory è£é¢ã€‚\nå¯¦éš›æ”¾åˆ° K8s å¤§æ¦‚æœƒé•·é•·é€™äº› yaml\næœ€ç°¡å–®ï¼Œå°±ç›´æ¥æŠŠ secret å£“åˆ° Pod env è£é¢ï¼Œ\næœ€ç°¡å–®ä¹Ÿæœ€å±éšª\næ‰€æœ‰çœ‹å¾—åˆ° yaml çš„äººéƒ½æ˜ç¢¼çœ‹è¦‹å¯†ç¢¼ æ‰€æœ‰èƒ½é€²åˆ° file system æå¤–è©±\nAPI Server è¢«å¾æ­£é¢æ‰“ç©¿ï¼Œæ»²é€åˆ°æ‹¿åˆ°é€™çµ„å¯†ç¢¼çš„æ©Ÿæœƒå¤šé«˜ï¼Ÿ\nå¦‚æœ API Server golang library æœ‰åœ¨è·Ÿå®‰å…¨æ€§æ›´æ–° Kubernetes ç”¨å…¬æœ‰é›²çš„ Kubernetes Serviceï¼Œæœ‰åœ¨æ›´æ–° OS ami è·Ÿ docker image éƒ½æœ‰åœ¨æ›´æ–° ç„¶å¾Œæœ‰åŠŸèƒ½æ­£å¸¸çš„é˜²ç«ç‰† æ‰“æ›è »æœ‰å¯èƒ½çš„ï¼Œä½†æ‰“ç©¿æœå‹™åˆ°æ‹¿åˆ°å¯†ç¢¼ï¼Œæ˜¯æœ‰é›£åº¦çš„ã€‚\næ›´å¤šæ™‚å€™ï¼Œè‡³å°‘åœ¨å¹£åœˆæœ‰è¢«çˆ†å‡ºä¾†çš„è³‡å®‰äº‹ä»¶ï¼Œå¤§å¤šæ˜¯æ˜¯å…¬å¸å“¡å·¥è¢«é‡£é­šä¿¡æ‰åˆ°ï¼Œè¢«æ¤å…¥æƒ¡æ„è»Ÿé«”åœ¨ local é›»è…¦ï¼Œç„¶å¾Œä»–åˆçœ‹å¾—åˆ°æ˜ç¢¼çš„å¯†ç¢¼ï¼Œç›´æ¥çˆ†ç‚¸ã€‚\næ˜ç¢¼ç³Ÿç³•çš„åœ°æ–¹ï¼Œå¤§å®¶éƒ½çœ‹å¾—åˆ°ï¼Œä¸€é–‹å§‹å°±æ˜¯ exposed çš„ç‹€æ…‹ï¼Œé¢¨éšªä¸å¯æ§ï¼Œä¹Ÿç„¡å¾ç®¡åˆ¶ã€‚\nç„¶å¾Œæ˜¯ K8s secretï¼Œä¹Ÿæ˜¯å¾ env æ›é€²å» Pod\næ”¾åœ¨ k8s secretï¼Œæ˜¯ base64 çš„æ ¼å¼\nçœ‹èµ·ä¾†è·ŸåŸå…ˆå…§å®¹ä¸ä¸€æ¨£äº†ï¼Œæœ‰äººå°±è·Ÿæˆ‘èªªï¼Œä»–å€‘å®¶çš„ k8s secret æœ‰ç”¨ base64 åŠ å¯†ã€‚\nencode è·Ÿ encrypt\nk8s secret æœ‰ä»€éº¼å•é¡Œ\næ˜ç¢¼ plain text çš„å•é¡Œï¼Œä¸è©²çœ‹åˆ°çš„äººå¾ˆå®¹æ˜“å°±çœ‹åˆ° æ ¹æœ¬çš„å•é¡Œé‚„æ˜¯ RBAC æ‡¶å¾—è¨­å®šï¼Œå¤§å®¶éƒ½ç”¨ default role é€²ä¾† è¦ç”¨å¯ä»¥ï¼Œå…ˆçœ‹ k8s secret å¾Œé¢çš„å„²å­˜å¯¦ä½œæ˜¯ä»€éº¼ï¼Ÿ\næ˜¯ k8s etcd é€é k8s API server å­˜å– etcd è·Ÿ kube-api ä¸€èˆ¬ä¾†èªªæ˜¯å¤ å®‰å…¨çš„ã€‚å®˜æ–¹æ–‡ä»¶é‚„å»ºè­°\nsecret è¦åŠ å¯† encrypt å¢å¼· RBAC æ§åˆ¶ï¼Œåªæœ‰ç‰¹å®š role æ‰çœ‹å¾—åˆ° secretï¼Œï¼Œè€Œä¸æ˜¯æ¯å€‹äººéƒ½ç”¨ default role è¿‘ä¾† k8sï¼Œç„¶å¾Œé€²åˆ° namespace å…¨éƒ¨ secret å°±çœ‹å…‰å…‰ RBAC æœ‰è¨­å®šå¥½ï¼Œæœ‰åŠ å¯†ï¼Œæ˜¯å¯ä»¥åšåˆ°å®‰å…¨ã€‚ç•¶ç„¶é‚„æ˜¯æ²’æœ‰å°ˆé–€ key Management å·¥å…·ï¼Œå¦‚ Vault æœ‰é¡å¤–ç®¡ç†ä¸Šçš„å„ªåŒ–åŠŸèƒ½ã€‚\nåŠ å¯†ç¯„ä¾‹å¯ä»¥çœ‹å¼·è€…æˆ‘æœ‹å‹çš„æ–‡ç« \nåŠ å¯†å®Œå¯èƒ½é•·é€™æ¨£ï¼Œé‚„è¦é¡å¤–é€éå…¶ä»–æ©Ÿåˆ¶æ‰èƒ½é€²è¡Œè§£å¯†ï¼Œæ‹¿åˆ°åŸå§‹è³‡æ–™\nä¾‹å¦‚é€é k8s controller è§£å¯† æˆ–æ˜¯é€é vault server æˆ–æ˜¯é€éå…¬æœ‰é›²çš„ Key Management Service åšè§£å¯† å…¶ä»–çš„ k8s secret åŠ å¯†è§£æ±ºæ–¹æ¡ˆ\nä»Šå¤©æˆ‘å€‘ä½¿ç”¨ Vaultï¼Œå…¶ä¸­ä¸€å€‹ç›®çš„å°±æ˜¯è¦åä¸­é–“é€™æ®µ Safe Magic\nçµ¦é€™å€‹ Pod secret ç„¶å¾Œåªçµ¦é€™å€‹ Pod Secret ç•¶ç„¶ Key Management å…¶ä»–é‚„æœ‰ä¸€å †äº‹æƒ…è¦è™•ç†\nå¯†ç¢¼æ´©æ¼çš„è©±æœ‰æ²’æœ‰ revoke æ©Ÿåˆ¶\nèƒ½ä¸èƒ½å®šæ™‚ Rotate æ±°æ›å¯†ç¢¼ï¼Ÿ\næ”¹æ¶æ§‹ï¼Œåº•ä¸‹çš„è¨­å®šå¥½ä¸å¥½è€•è‘—å‹•æ…‹èª¿æ•´ï¼Œé‚„æ˜¯è¦è·Ÿè‘— rename / mv k8s secret\næ€éº¼åšç¨½æ ¸ï¼Œæ€éº¼æª¢æŸ¥å…§å®¹ã€‚æˆ‘çœ‹ä¸åˆ° vault å¹«æˆ‘çœ‹ä¸€ä¸‹å…§å®¹å°ä¸å°ï¼Œé€™å€‹å¾ˆå®¹æ˜“ç™¼ç”Ÿã€‚\nè‡†æƒ³é ­å°±å¾ˆç—›\nä»Šå¤©çš„ç›®çš„å¾ˆå–®ç´”\nå¯†ç¢¼çš„éœ²å‡ºç›¡é‡å° æœ€å¥½å¯†ç¢¼æ˜¯æœ‰æœŸé™çš„ï¼Œé€¾æœŸè‡ªå‹•å¤±æ•ˆ æš´éœ²äº†å¯ä»¥ revoke Vault\næœ‰äººç”¨éï¼Ÿé€™é‚Šç°¡ä»‹ä¸€ä¸‹\nåœ¨ CNCF çš„ landscape æ¼±æ¸ Key Managementï¼Œæ‡‰è©²æ˜¯è£¡é¢å¸‚ä½”æœ€é«˜çš„é–‹æºé …ç›®\né‡é»å°±æ˜¯ä¿è­·èˆ‡ç®¡ç† secret\nVault çš„æ ¸å¿ƒæ¦‚å¿µï¼Œé€™å€‹å½±ç‰‡æ˜¯ Hashicorp å®˜æ–¹ä»‹ç´¹çš„å½±ç‰‡ï¼Œè¬›å¾—å¾ˆå¥½ï¼Œå¤§å®¶è‡ªå·±å›å»çœ‹ä¸€ä¸‹\né€™é‚Šç°¡å–® vault 101\nç¾åœ¨æœ‰ä¸€å° vault server å·²ç¶“è¨­å®šå¥½äº†ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ vault client é€£ç·š\nä¾‹å¦‚é€™é‚Š\nä½¿ç”¨ VAULT TOKEN å‘Šè¨´ vault ä½ æ˜¯ä»€éº¼èº«ä»½çš„ç”¨æˆ¶ æˆ–æ˜¯é€²è¡Œ loginï¼ŒVault æœƒå‘¸ç™¼ä¸€çµ„è‡¨æ™‚çš„ TOKEN çµ¦ä½  æ‹¿è‘—çµ„ TOKEN å»å• Vaultï¼Œè«‹å•æˆ‘å¯ä»¥è¦ /user/mysql é€™å€‹è·¯å¾‘ä¸‹çš„è³‡æ–™å—ï¼Ÿ\nVault æª¢æŸ¥ TOKEN çš„ role èˆ‡ permissionï¼Œå¯ä»¥å°±å›å‚³å€¼ ä¸è¡Œå°± permission denied\nVault å°±æ˜¯é‡‘åº«ï¼ŒçœŸæ­£é‡è¦çš„ key å­˜åœ¨è£¡é¢ï¼Œä½¿ç”¨é€™è¦ä¾†å• Vaultï¼Œè¦å…ˆé Vault é€™é—œ\nVault å¯¦éš›å­˜æ”¾ Secret Engineï¼Œé€™é‚Šä¹Ÿè·³éï¼Œå¤§å®¶å…ˆæŠŠä»–ç•¶ key / value å­˜æ”¾å¥½äº† XD\nç­‰ç­‰ï¼Œé€™æ¨£ vault Auth æœ‰é»æ€ª\næœ¬ä¾†æ‹¿ username / password å»æ§åˆ¶ Mysql å…ˆåœ¨å¤šä¸€æ­¥ï¼Œå…ˆæ‹¿åˆ° VAULT TOKENï¼Œå†æ‹¿ TOKEN å»è·Ÿ Vault æ‹¿ Mysql passwordï¼Œå†å»é€£ MySQL\nå’¦é€™æ¨£ä¸æ˜¯å¾ˆæ€ªï¼Ÿæˆ‘å¦‚æœ Vault token æš´éœ²äº†ï¼Œæœ‰å¿ƒäººå£«é‚„æ˜¯å¯ä»¥å¾ vault æ‹¿åˆ°è³‡æ–™å•Š\né€™æ¨£æœ‰æ¯”è¼ƒå®‰å…¨å—ï¼Ÿé‚„æ˜¯åªæ˜¯èŠ±å¼è¢«é§­\nå°ï¼Œåªæ˜¯åš token äº¤æ›çš„è©±ï¼Œé‚„æ˜¯ä¸å¤ ï¼Œæ‰€ä»¥ Vault æœ‰æä¾›è¨±å¤š Auth method\ntoken åªæ˜¯å…¶ä¸­ä¸€ç¨® æœ‰å¾ˆå¤šèªè­‰æ–¹æ³•ä¸ç”¨ token äº¤æ›ï¼Œä½†ä¹Ÿèƒ½è®“ vault èªå¾— k8s pod èˆ‡ api server é€™æ˜¯ä»Šå¤©çš„é‡é»ä¹‹ä¸€ï¼Œtoken / å¯†ç¢¼å‚³éä¸å®‰å…¨ï¼Œé‚£å°±ç”¨å…¶ä»–æ‰‹æ®µ auth\nä»¥ AWS IAM auth ç‚ºä¾‹\nå¦‚æœä»Šå¤©æ˜¯åœ¨ aws ec2 ä¸Šè·‘ï¼Œé‚£å¯ä»¥é€é aws internal api å»å–å¾—èº«ä»½èªè­‰è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯ ec2 instance metadata\næ‹¿é€™å€‹ metadata å»å• vaultï¼Œvault å†é€é aws api å»ç¢ºèªï¼Œé€™å€‹ ec2 instance çœŸçš„æ˜¯åˆæ³•çš„\nç„¶å¾Œä¾æ“š ec2 instance èº«ä»½ï¼Œé…ç™¼æ¬Šé™è·Ÿè³‡æ–™\napi server ec2 å°±çµ¦ api server secret frontend server ec2 å°±çµ¦ frontend secret ä¸­é–“æ²’æœ‰å¤šé¤˜çš„å¯†ç¢¼ / token äº¤æ›\nä¾†å¾€çš„å°è©±å¤§æ¦‚æ˜¯é€™æ¨£\nAWS API æ˜¯å¯ä¿¡çš„ Vault è‡ªå·±ç¶­è­·æ˜¯å¯ä¿¡çš„ æœå‹™é€éä¸‰æ–¹äº¤æ¡å»èªè­‰ï¼Œèª runtime ç’°å¢ƒçš„ metadataï¼Œä¸å†æ˜¯èª key ä¸èªäºº è‡³æ–¼ api server ec2 è¿‘ä¾† vault å¾Œï¼Œæ‡‰è©²æœ‰ä»€éº¼æ¨£çš„æ¬Šé™ï¼Œåœ¨ vault å…§éƒ¨é€é policy é…ç½®\nè¨­å®š path è¨­å®šå…è¨±çš„ operation ä¾‹å¦‚ read write list delete â€¦ ç­‰ runtime å‹•æ…‹èª¿æ•´\nç•¶ç„¶ Vault é‚„æœ‰æä¾›å¾ˆå¤šæ›´åŠ å®‰å…¨çš„åŠŸèƒ½\nä¾‹å¦‚å¦‚ä½•å®‰å…¨åœ°å­˜æ”¾ secret Storage é€™é‚Šè·³é\nSecret + auth æ­é…è·³é\nä»¥åŠ dynamic secretï¼Œä¾†è§£èª key ä¸èªäººçš„å•é¡Œ\nä¾‹å¦‚ mysql çš„éœæ…‹ username / passwordï¼Œé€é vault è¨­å®šå¯ä»¥è®Šæˆå‹•æ…‹çš„\nå›åˆ° k8sï¼Œä½¿ç”¨ token authï¼Œç„¶å¾ŒæŠŠ VAULT TOKEN æ”¾åœ¨ k8s secret è£é¢ï¼Œåªæœ‰æ¯”è¼ƒå®‰å…¨ä¸€é»é»\nå°±æ˜¯ VAULT TOKEN å¯ä»¥å¿«é€Ÿ rotate è·Ÿ revoke\né€™é‚Šå¯ä»¥æ­é…å…¶ä»– auth æ–¹å¼ä¾†è§£æ±º\nå‰›å‰›ä¸æ˜¯è®“ vault å»èª aws ec2ï¼Ÿ\nåœ¨ k8s ä¸­ï¼Œå¯ä»¥è®“ vault å»èª k8s cluster / service account\nè·¯å¾‘åœ–é•·é€™æ¨£\npod runtime éƒ½æœƒæœ‰ service account ä½¿ç”¨ service account çš„ metadata å»å• vault vault å»å• k8sï¼Œé€™å€‹ service account æ˜¯çœŸçš„å‡çš„ k8s å›ç­” vaultï¼ŒPod è·Ÿservice account æ˜¯åˆæ³•çš„ vault å†é…æ¬Šé™çµ¦ Pod â€¦","date":1636995852,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"dd1551f4eb238bd451484b5d83882cbe","permalink":"https://chechia.net/zh-hant/post/2021-11-16-ithome-cloud-summit-vault/","publishdate":"2021-11-16T01:04:12+08:00","relpermalink":"/zh-hant/post/2021-11-16-ithome-cloud-summit-vault/","section":"post","summary":"å„ä½å¥½\né—œæ–¼é€™å€‹ QRcode\næ¯æ¬¡ä¸Šå°å‰ï¼Œæˆ‘éƒ½æœƒæƒ³è¦å¸¶ä»€éº¼æ¨£çš„å…§å®¹çµ¦è§€çœ¾ï¼Œè®“è§€çœ¾å€¼å¾—èŠ± 30 åˆ†é˜åœ¨åº•ä¸‹è½ã€‚å¾Œä¾†å°±ç¿’æ…£å…ˆç™¼è¡¨ä¸€ç¯‡æ–‡ç« ï¼ŒæŠŠå°è§€çœ¾æœ‰å¹«åŠ©çš„è³‡æºåŒ…æˆä¸€åŒ…ï¼š\né¦–å…ˆæ˜¯å®Œæ•´æŠ•å½±ç‰‡ï¼šhttps://slides.com/chechiacâ€¦/terraform-introduction-a56697 é€å­—è¬›ç¨¿ï¼š(æœ€å¾Œæ ¡ç¨¿ä¸­ï¼‰ ç„¶è€Œåªæœ‰æœ¬æ¬¡æ¼”è¬›å…§å®¹ï¼Œå›å»å¯èƒ½é‚„æ˜¯ä¸å¤ªå®¹æ˜“æ“ä½œã€‚æ‰€ä»¥é€™æ¬¡é™„ä¸Šä½¿ç”¨ Terraform ä¸€éµéƒ¨ç½² vault çš„ Github Repositoryï¼šhttps://github.com/â€¦/southeâ€¦/chechia_net/vault/singleton å¦‚æœä¸ç†Ÿ Terraformï¼Œå†é™„ä¸Š 30 å¤©æ‰‹æŠŠæ‰‹ Terraform æ•™å­¸æ–‡ç« ï¼Œåªè¦é¡˜æ„èŠ±æ™‚é–“ï¼Œå…¨ç¯‡ä¸­æ–‡ä¸€å€‹æœˆå¸¶ä½ ä¸Šæ‰‹ Terraformã€‚ IThome éµäººè³½å¥½è®€ç‰ˆï¼šhttps://ithelp.ithome.com.tw/users/20120327/ironman/4057 Github Repository å®Œæ•´ç‰ˆï¼šhttps://github.com/â€¦/terraform-30â€¦/tree/main/lecture/zh å¦‚æœé‡åˆ°å•é¡Œé‚„æ˜¯éœ€è¦æ‰¾äººç™¼å•ï¼Œæ‰€ä»¥å†æ¨è–¦å…©å€‹ç¤¾ç¾¤ï¼Œå¯ä»¥ä¾†é€™é‚Šç™¼å•ï¼Œè¦æ‰¾æˆ‘æœ¬äººä¹Ÿæ‰¾å¾—åˆ°ã€‚ç”šè‡³åªæ˜¯åŠ å…¥æ½›æ°´ä¸è¬›è©±ï¼Œéƒ½å¯ä»¥è¢«å‹•å¸æ”¶è¨±å¤šæ–°çŸ¥ã€‚ Cloud Native Taiwan User Group https://t.","tags":["kubernetes","vault","terraform"],"title":"2021 11 16 Ithome Cloud Summit Vault","type":"post"},{"authors":null,"categories":["kubernetes","terraform"],"content":"2021 ithome éµäººè³½é–‹è·‘äº†ï½\nä»Šå¹´çš„é¡Œç›®æ˜¯ã€ŒTerraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©ã€ï¼Œæ˜¯ä¸€å€‹é•·é” 30 å¤©çš„ terraform workshopï¼Œå° terraform æœ‰èˆˆè¶£çš„æœ‹å‹æ­¡è¿è¿½ç¸±\nDay 01 - å¼•è¨€ï¼šTerraform æ˜¯å€‹å¥½æ±è¥¿ã€‚\nèª²ç¨‹å…§å®¹èˆ‡ä»£ç¢¼æœƒæ”¾åœ¨ Github ä¸Š: https://github.com/chechiachang/terraform-30-days\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\n","date":1630470306,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"4564241cb1a4b220e0de74caa8dd4a1d","permalink":"https://chechia.net/zh-hant/post/2021-09-01-ithome-ironman-go/","publishdate":"2021-09-01T12:25:06+08:00","relpermalink":"/zh-hant/post/2021-09-01-ithome-ironman-go/","section":"post","summary":"2021 ithome éµäººè³½é–‹è·‘äº†ï½\nä»Šå¹´çš„é¡Œç›®æ˜¯ã€ŒTerraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©ã€ï¼Œæ˜¯ä¸€å€‹é•·é” 30 å¤©çš„ terraform workshopï¼Œå° terraform æœ‰èˆˆè¶£çš„æœ‹å‹æ­¡è¿è¿½ç¸±\nDay 01 - å¼•è¨€ï¼šTerraform æ˜¯å€‹å¥½æ±è¥¿ã€‚\nèª²ç¨‹å…§å®¹èˆ‡ä»£ç¢¼æœƒæ”¾åœ¨ Github ä¸Š: https://github.com/chechiachang/terraform-30-days","tags":["terraform","iac","éµäººè³½2021"],"title":"2021 09 01 Ithome Ironman Go","type":"post"},{"authors":null,"categories":null,"content":"Event https://devops.kktix.cc/events/meetup33-maicoin-devops-taiwan https://youtu.be/8hEifTAWnY0?t=3269 audience: 90/90 resources this presentation\nhttps://slides.com/chechiachang/terraform-introduction-a56697 github\nhttps://github.com/chechiachang/terraform-azure https://github.com/chechiachang/vault-playground/tree/master/deploy/v0.8.0 ","date":1620894566,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"35859312eb3813377645389ac87c1439","permalink":"https://chechia.net/zh-hant/post/2021-05-13-devops-taiwan-33-hashicorp-vault-for-kubernetes-apps/","publishdate":"2021-05-13T16:29:26+08:00","relpermalink":"/zh-hant/post/2021-05-13-devops-taiwan-33-hashicorp-vault-for-kubernetes-apps/","section":"post","summary":"Event https://devops.kktix.cc/events/meetup33-maicoin-devops-taiwan https://youtu.be/8hEifTAWnY0?t=3269 audience: 90/90 resources this presentation\nhttps://slides.com/chechiachang/terraform-introduction-a56697 github\nhttps://github.com/chechiachang/terraform-azure https://github.com/chechiachang/vault-playground/tree/master/deploy/v0.8.0 ","tags":null,"title":"DevOps Taiwan Meetup #33: Hashicorp Vault for Kubernetes","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\néœ€æ±‚èˆ‡å•é¡Œ éš¨è‘— terraform åœ¨åœ˜éšŠå…§çš„è¦æ¨¡æŒçºŒæˆé•·ï¼Œåœ˜éšŠéœ€è¦è®“å·¥ä½œæµç¨‹æ›´åŠ é †æš¢ï¼Œä¾†é¢å°å¤§é‡çš„ tf è®Šæ›´æŸ¥æ ¸èˆ‡è®Šæ›´è«‹æ±‚ã€‚æƒ³åƒå¹¾åå€‹å·¥ç¨‹å¸«åŒæ™‚åœ¨ä¿®æ”¹å¹¾åå€‹ä¸åŒçš„ terraform projects / modulesï¼Œé€™æ™‚å¯èƒ½æœƒæœ‰å¹¾å€‹å•é¡Œ\néœ€è¦ä¸€å€‹ç©©å®šä¹¾æ·¨çš„ç’°å¢ƒåŸ·è¡Œ terraform å·¥ç¨‹å¸«çš„é–‹ç™¼æœ¬æ©Ÿä¸æ˜¯å€‹å¥½é¸æ“‡ éœ€è¦ 24/7 çš„ terraform åŸ·è¡Œä¸­å¿ƒ åŸ·è¡Œä¸­å¿ƒæœƒæœ‰å„å€‹ç’°å¢ƒ (dev / stage / prod) çš„å­˜å–æ¬Šé™ï¼Œå¸Œæœ›è¨­ç½®åœ¨å…§éƒ¨ ä¸‹åˆ—å…©å€‹å·¥ä½œæœƒåˆ‡æ›å·¥ä½œå¹³å°ï¼Œä¾‹å¦‚ Github reviewï¼Œæª¢è¦– differenceï¼Œèˆ‡è¨è«– PR review å®Œæœ‰æ™‚æœƒå¿˜è¨˜ mergeï¼Œmerge å®Œæœ‰æ™‚æœƒå¿˜è¨˜ apply repository è¶Šå¤šï¼Œå¿˜å¾—è¶Šå¤šâ€¦ åœ˜éšŠå·²ç¶“å°å…¥ Git-flowï¼Œå¸Œæœ›æŠŠå·¥ä½œæµç¨‹åšå¾—æ›´å®Œæ•´è‡ªå‹•åŒ–æ›´åŠ ä¾¿åˆ©\nAtlantis è§£æ±ºæ–¹æ¡ˆæ˜¯èˆ‡ç‰ˆæœ¬æ§åˆ¶æ•´åˆï¼Œæä¾› terraform åŸ·è¡Œçš„ workerï¼Œç—…å¯ä»¥èˆ‡ Git Host (e.g. Github) æ•´åˆåš PR + Reviewï¼Œä¾†é”æˆæŒçºŒçš„ CI/CD é ç«¯åŸ·è¡Œï¼Œè‡ªå‹• plan èˆ‡è‡ªå‹• apply mergeã€‚ä¹Ÿå°±æ˜¯ Atlantis å¹«æˆ‘å€‘è™•ç†ä»¥ä¸‹å¹¾ä»¶äº‹\nGit-flow TODO è‡ªå‹•åŒ– plan TODO Webhook å›å‚³ plan çµæœ TODO é€é bot æ§åˆ¶ apply TODO è‡ªå‹• merge éœ€æ±‚èˆ‡å·¥ä½œæµç¨‹ ä»¥ä¸‹çš„ç¯„ä¾‹ä½¿ç”¨\nGithub ä½œç‚ºç‰ˆæœ¬æ§ç®¡å·¥å…· æ˜¯æ•´å€‹å·¥ä½œæµç¨‹çš„æ§åˆ¶ä¸­å¿ƒ tf codeï¼Œreviewï¼Œplanï¼Œapply çš„çµæœéƒ½æœƒåœ¨ Github é€²ä¸€æ­¥æ•´åˆåˆ° Slack ä¸Šä¹Ÿéå¸¸æ–¹ä¾¿ Atlantis æ”¾åœ¨ Kubernetes ä¸Š ä½¿ç”¨ helm chart éƒ¨ç½² å¦‚æœéœ€è¦å…¶ä»–çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·æˆ–æ˜¯å®‰è£æ–¹å¼ï¼Œè«‹è¦‹Atlantis å®˜æ–¹æ–‡ä»¶ï¼ŒAtlantis æ”¯æ´éå¸¸å¤šç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œä¾‹å¦‚ Githubï¼ŒGitlabï¼ŒBitbucketï¼Œâ€¦ç­‰\næ•´å€‹å·¥ä½œæµç¨‹\nGithub commit push Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Github PR push Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Github Merge event / main branch push Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Atlantis acquire access to site (dev / stage) Atlantis apply to site Github release tag push (eg. 1.2.0-rc) Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Atlantis acquire access to site (dev/stage) Atlantis apply to site (release-candidate / prod) ä¾æ“šä¸Šé¢çš„ç’°å¢ƒï¼Œå®‰è£éœ€è¦æº–å‚™ä»¥ä¸‹å¹¾å€‹æ±è¥¿\nGit Git Host ä¸Šè¨­å®š Atlantis å­˜å– Git Repository çš„æ¬Šé™ ç‚º Git Host è¨­å®šå­˜å–ç§é‘°ï¼Œè®“ Atlantis èªè­‰ webhook Terraform Backend State storage: Atlantis éœ€è¦å­˜å–å¤–éƒ¨çš„ state storage Terraform ä½¿ç”¨çš„ç‰ˆæœ¬è¦æ³¨æ„ä¸€ä¸‹ã€‚Atlantis å¯ä»¥æ”¯æ´ä¸åŒ repository / project ä½¿ç”¨ä¸åŒç‰ˆæœ¬ Environment credential (provider credential) Atlantis æœƒéœ€è¦å­˜å–ä¸åŒçš„ç’°å¢ƒ (dev / stage / prod) ç‚ºé€™äº›ç’°å¢ƒç¨ç«‹é…ç½® credential è®“ Atlantis å­˜å– å¯¦éš› Atlantis çš„ç’°å¢ƒæœƒæœ‰\nDocker ä½œç‚ºå­¤åŸå¸«æœ¬æ©Ÿé–‹ç™¼æ¸¬è©¦ä½¿ç”¨ Kubernetes Atlantis æˆ‘å€‘çš„åœ˜éšŠæœƒæ˜¯ä¸€å€‹ç’°å¢ƒä¸€å€‹ç¨ç«‹çš„ Atlantis å®‰å…¨æ€§ï¼šåˆ‡åˆ†å„å€‹ç’°å¢ƒçš„æ¬Šé™èˆ‡ Access å„å€‹ Atlantis webhook åªæ¥æ”¶å±¬æ–¼è‡ªå·±çš„ event Docker ä½¿ç”¨ Docker ä½œç‚ºæœ¬åœ°é–‹ç™¼èˆ‡æ¸¬è©¦çš„å®¹å™¨ runtimeï¼š\ndocker pull runatlantis/atlantis:v0.15.0 docker run runatlantis/atlantis:v0.15.0 atlantis \\ --gh-user=GITHUB_USERNAME \\ --gh-token=GITHUB_TOKEN Helm Chart Helm çš„å®‰è£ååˆ†ç°¡æ˜“\nhelm repo add runatlantis https://runatlantis.github.io/helm-charts helm inspect values runatlantis/atlantis \u0026gt; values.yaml æ›´æ”¹ values.yaml\ngithub: user: chechiachang token: ... secret: ... orgWhitelist: github.com/chechiachang/* å®‰è£åˆ° Kubernetes ä¸Š\nhelm install atlantis runatlantis/atlantis -f values.yaml çµæœ å·¥ç¨‹å¸«é€é Github å°±å¯ä»¥å®Œæˆæ‰€æœ‰å·¥ä½œ åŠ ä¸Š Github Slack æ•´åˆï¼Œå°±å®Œå…¨ä¸ç”¨é›¢é–‹ Slackï¼Œè·Ÿ bot èŠå¤©å°±å¯ä»¥å®Œæˆæ‰€æœ‰ terraform å·¥ä½œ å®‰å…¨ç©©å®šçš„ terraform åŸ·è¡Œç’°å¢ƒ ç¨ç«‹çš„ in-cluster credentialï¼Œé›†ç¾¤çš„å­˜å–æ¬Šé™éƒ½æ§åˆ¶åœ¨é›†ç¾¤å…§ï¼Œä¸æœƒæš´éœ²åˆ°å¤–éƒ¨ç’°å¢ƒ è‡ªå‹• plan èˆ‡ applyï¼Œä¸æœƒéºå¿˜ å„ªåŠ£ å„ªé»\nå¯ä»¥ self-hostedï¼Œcredential ä¸å¤–æ´©ï¼Œç¢ºä¿æœ€é«˜çš„å®‰å…¨æ€§ å·²ç¶“æ•´åˆ Kubernetes, helm chart webhook æ•´åˆè¨±å¤šç‰ˆæœ¬æ§åˆ¶åº«ï¼Œä¾‹å¦‚ github, gitlab,â€¦ å¯¦ç¾å®‰å…¨çš„é ç«¯åŸ·è¡Œ æœ¬åœ°åŸ·è¡Œé‚„æ˜¯æœƒæœ‰è«¸å¤šå•é¡Œ terraform cloud æä¾›çš„é ç«¯åŸ·è¡Œ ç¼ºé»ï¼Œå…¶å¯¦æ²’ä»€éº¼ç¼ºé»\nå°±éœ€è¦å¤šé¤Šä¸€çµ„ Atlantis ä½¿ç”¨ stateless deploymentï¼Œå…¶å¯¦æ˜¯æ‡‰è©²ä¸æœƒæœ‰ä»€éº¼è² æ“” Terraform ç³»åˆ—è‡³æ­¤æ‡‰è©²æ˜¯å…¨éƒ¨å®Œçµï¼Œæ„Ÿè¬å„ä½\n","date":1602040548,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"358feb9ca2bde56b386e8fcd36eebbae","permalink":"https://chechia.net/zh-hant/post/2020-10-07-terraform-infrastructure-as-code-atlantis/","publishdate":"2020-10-07T11:15:48+08:00","relpermalink":"/zh-hant/post/2020-10-07-terraform-infrastructure-as-code-atlantis/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","éµäººè³½2020","iac","aws"],"title":"Terraform Infrastructure as Code: Atlantis","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\næ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html å·¥å…· Terraform Atlantis Terragrunt å•é¡Œèˆ‡éœ€æ±‚ ç•¶åœ˜éšŠå·²ç¶“é–‹å§‹å¤§è¦æ¨¡ä½¿ç”¨ terraformï¼Œtf æª”æ¡ˆè¶Šä¾†è¶Šå¤šã€‚æˆ‘å€‘ç‚ºäº†å¢åŠ ç¨‹å¼ç¢¼çš„é‡è¤‡åˆ©ç”¨æ€§ï¼Œæœƒä½¿ç”¨ terraform module å°‡å¸¸ç”¨çš„ tf æª”æ¡ˆå°è£ã€‚\néš¨è‘—å°å…¥çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œé€™äº› module æœƒè¶Šä¾†è¶Šå¤šï¼Œè€Œä¸”ä½¿ç”¨é€™äº› module çš„ project ä¹Ÿå¢åŠ  éš¨è‘—ç®¡ç†çš„ infrastructure è¶Šä¾†è¶Šè¤‡é›œï¼Œç‚ºäº†æè¿°é€™äº›æœ¬ä¾†å°±å¾ˆè¤‡é›œçš„ infrastructureï¼Œmodule ä¸åªè¶Šä¾†è¶Šå¤šï¼Œé‚„æœƒå‡ºç¾ module å¼•ç”¨å…¶ä»– moduleï¼Œå¤§ module ä½¿ç”¨å° module çš„ nested module é€™é»åœ¨è¤‡é›œçš„ provider ä¸­å¸¸å‡ºç¾ï¼Œä¾‹å¦‚ ä½¿ç”¨ terraform æè¿°ç¶²è·¯æ¶æ§‹ æè¿°è¤‡é›œçš„ IAM \u0026amp; Role terraform vault-provider ç®¡ç†çš„ç’°å¢ƒè¶Šä¾†è¶Šå¤šï¼Œä¾‹å¦‚ dev, staging, prod,â€¦ï¼Œæ¯å€‹ç’°å¢ƒéƒ½éœ€è¦ç¨ç«‹çš„å·¥ä½œç©ºé–“ï¼Œé€ æˆå¤§é‡é‡è¤‡çš„ tf code ä½¿ç”¨ä¸€æ®µæ™‚é–“ terraform ï¼Œå¾ˆå¿«å°±æœƒç™¼ç¾çš„ç¬¬ä¸€å€‹å•é¡Œæ˜¯ï¼šä¸è«–æ€éº¼å¾ tf æª”æ¡ˆä¸­æå–é‡è¤‡éƒ¨åˆ†ï¼Œåšæˆ moduleï¼Œé‚„æ˜¯æœ‰å¾ˆå¤šéƒ¨åˆ†çš„ tf code æ˜¯å®Œå…¨é‡è¤‡çš„ï¼Œä¾‹å¦‚ï¼š\næ¯å€‹ module æœƒå®šç¾©çš„ variable (argument)ï¼Œä½¿ç”¨é€™å€‹ module çš„ä¸Šå±¤æœƒéœ€è¦æä¾›å‚³å…¥ variable æ¯å€‹ module éƒ½æœƒéœ€è¦æä¾› provider Terraform çš„èªæ³•è¦æ±‚ä¸Šé¢é€™äº›åƒæ•¸éƒ½æ˜ç¢ºçš„å®šç¾©ï¼Œé€™è®“æ•´å€‹ module æˆ–è³‡æ–™å¤¾çš„æè¿°éå¸¸æ¸…æ¥šã€‚ä½†æœƒè™•å°±æ˜¯ï¼Œé€™äº›æè¿°çš„åƒæ•¸é“å‡ºéƒ½æ˜¯ï¼Œè€Œä¸”ä¸æ–·çš„é‡è¤‡ï¼Œæ¯å€‹ module æˆ–è³‡æ–™å¤¾éƒ½è¦æä¾›ï¼Œä¸ç„¶åœ¨ terraform validate æ™‚æœƒå› ç‚ºæ‡‰æä¾›åƒæ•¸æœªæä¾›ï¼Œå°è‡´éŒ¯èª¤ã€‚é›–ç„¶ç«‹æ„è‰¯å¥½ï¼Œä½†å»åš´é‡é•å DRY (Donâ€™t Repeat Yourself) çš„åŸå‰‡\nmodule å¤šå±¤å¼•ç”¨ï¼Œproject å¼•ç”¨å¤§ moduleï¼Œå¤§ module åˆå¼•ç”¨å° module é–‹å§‹æ„Ÿè¦º backend èˆ‡ provider çš„ code æ¯”å…¶ä»–åŠŸèƒ½ code å¤šäº† æœ‰æ²’æœ‰å¯èƒ½ç”¨å…¶ä»–å·¥å…·ï¼Œé¿å…é€™äº›é‡è¤‡çš„åƒæ•¸ï¼Œbackendï¼Œprovider ç­‰ç­‰ï¼Ÿ\nTerragrunt æ¨è–¦æœ‰å¤§é‡ä½¿ç”¨çš„åœ˜éšŠï¼Œç›´æ¥ä½¿ç”¨ Terragrunt é€™æ¬¾å·¥å…·ã€‚\nä»–æ˜¯ä¸€å±¤ terraform çš„ wrapper\ni.e. åŸ·è¡Œ terraform plan -\u0026gt; terragrunt plan terragrunt æœƒå…ˆè§£æï¼Œç”¢ç”Ÿé‡è¤‡çš„ codeï¼Œç„¶å¾Œå†åŸ·è¡Œ terraform ç·¨è¼¯æ™‚åªè¦å¯«ä¸€æ¬¡ï¼Œterragrunt ä»£ç‚ºåœ¨å…¶ä»–åœ°æ–¹ç”¢ç”Ÿé‡è¤‡çš„ code ç”¢ç”Ÿçš„ code æœƒè¢«éš±è—èˆ‡ cache Terragrunt æœ‰è¨±å¤šåŠŸèƒ½ï¼Œä¾‹å¦‚\nè™•ç† Backendï¼Œproviderï¼Œèˆ‡å…¶ä»–ä¸æ–·é‡è¤‡çš„ tf code è™•ç†å¤šç’°å¢ƒä¸‹é‡è¤‡çš„ tf â€¦å®Œæ•´åŠŸèƒ½è«‹è¦‹å®˜æ–¹æ–‡ä»¶ å°å…¥ Terragrunt å¯ä»¥é¿å…é‡è¤‡ä»£ç¢¼ï¼Œé™ä½ç¶­è­·æˆæœ¬ï¼Œæå‡ç”Ÿç”¢æ•ˆç‡\nä½¿ç”¨æƒ…å¢ƒ ä¸Šè¿°èªªæ˜å¯èƒ½ä¸å¤ªæ¸…æ¥šï¼Œæˆ‘å€‘å¯¦éš›çœ‹ç¯„ä¾‹ï¼Œä»¥å‰å¹¾ç¯‡æˆ‘å€‘ä½¿ç”¨çš„ç¯„ä¾‹ repository ç‚ºä¾‹å­ï¼ŒæŠŠ gcp çš„è³‡æ–™å¤¾ç›®éŒ„æ‡‰è©²é•·é€™æ¨£ï¼š\nå¯ä»¥å¾ˆæ¸…æ¥šè¦‹åˆ°åº•ä¸‹å¹¾å€‹æ±è¥¿ä¸æ–·é‡è¤‡ ç”±æ–¼ my-new-project, gke-playground, national-team-5g ä¸‰å€‹å°ˆæ¡ˆæ˜¯ç¨ç«‹çš„å°ˆæ¡ˆï¼Œå„è‡ªå¯ä»¥ç¨ç«‹é‹è¡Œã€‚ä½†å…¶å¯¦åŒå±¬æ–¼åŒå…¬å¸çš„å°ˆæ¡ˆï¼Œå¯èƒ½è¨±å¤šå…§å®¹éƒ½æ˜¯é‡è¤‡çš„ã€‚\ntree gcp gcp â”œâ”€â”€ README.md â”œâ”€â”€ Makefile â”œâ”€â”€ my-new-project/ â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”œâ”€â”€ variable.tf â”‚Â â””â”€â”€ provider.tf â”œâ”€â”€ gke-playground/ â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”œâ”€â”€ variable.tf â”‚Â â””â”€â”€ provider.tf â”œâ”€â”€ national-team-5g/ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”‚Â â”œâ”€â”€ variable.tf â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â”œâ”€â”€ stag â”‚Â â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”‚Â â”œâ”€â”€ variable.tf â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â””â”€â”€ prod â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”œâ”€â”€ variable.tf â”‚Â â””â”€â”€ provider.tf â”œâ”€â”€ templates/ â””â”€â”€ modules/ å¯ä»¥å¾ˆæ¸…æ¥šè¦‹åˆ°åº•ä¸‹å¹¾å€‹æ±è¥¿ä¸æ–·é‡è¤‡\nprovider.tf é€™è£¡æè¿°ä½¿ç”¨çš„ providerï¼Œé€™é‚Šåªæœ‰ä½¿ç”¨ gcp providerï¼Œæ‰€ä»¥æ˜¯å®Œå…¨ä¸€æ¨£é‡è¤‡ variable.tf æ˜¯å®šç¾©çš„åƒæ•¸ terraform.tfvars æ˜¯å‚³å…¥çš„åƒæ•¸ï¼Œä¹Ÿå°±æ˜¯å¯¦éš›å„å°ˆæ¡ˆå„è‡ªçš„åŸ·è¡Œåƒæ•¸ national-team-5g çš„å°ˆæ¡ˆä¸‹ï¼Œåˆå„è‡ªæ‹†åˆ†å¤šå€‹åŸ·è¡Œç’°å¢ƒï¼Œæ¯å€‹ç’°å¢ƒç¨ç«‹ï¼Œæ‰€ä»¥åˆæœ‰è¨±å¤šé‡è¤‡çš„ code é€™é‚Šçš„ç›®çš„ï¼Œæ˜¯æœ‰ç³»çµ±åŒ–çš„è™•ç†é€™äº›é‡è¤‡çš„ä»£ç¢¼\ngcp â”œâ”€â”€ terraform.tfvars # gcp å…±ç”¨çš„åƒæ•¸ â”œâ”€â”€ terragrunt.hcl # gcp å…±ç”¨çš„ç¨‹å¼ç¢¼ â”œâ”€â”€ national-team-5g/ â”‚Â â”œâ”€â”€ terraform.tfvars # national-team-5g å…±ç”¨çš„åƒæ•¸ â”‚Â â”œâ”€â”€ terragrunt.hcl # national-team-5g å…±ç”¨çš„ç¨‹å¼ç¢¼ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # dev çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ terragrunt.hcl # dev ç’°å¢ƒè‡ªå·±çš„ç¨‹å¼ç¢¼ â”‚Â â”œâ”€â”€ staging â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # staging çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ terragrunt.hcl # staging ç’°å¢ƒè‡ªå·±çš„ç¨‹å¼ç¢¼ â”‚Â â””â”€â”€ prod â”‚Â â”œâ”€â”€ terraform.tfvars # prod çš„åƒæ•¸ â”‚Â â””â”€â”€ terragrunt.hcl # prod ç’°å¢ƒè‡ªå·±çš„ç¨‹å¼ç¢¼ å·®ç•°éå¸¸å¤šæ˜¯å§ï¼Œä½†é€™é‚Šåªæ˜¯å¾è³‡æ–™ç›®éŒ„çµæ§‹çœ‹ï¼Œå…¶å¯¦å¦‚æœå¾ tf æª”æ¡ˆå…§éƒ¨çš„ç¨‹å¼ç¢¼çœ‹ï¼Œè£¡é¢çš„ä»£ç¢¼æ›´æ˜¯ç²¾ç°¡åˆ°ä¸è¡Œï¼Œç”¨èµ·ä¾†éå¸¸çš„çˆ½XD\nå®‰è£ å» release é é¢æ‰¾é©åˆçš„åŸ·è¡Œæª”æ¡ˆ ä¸‹è¼‰ chmod u+x terragrunt mv terragrunt /usr/local/bin/terragrunt è©³ç´°æ–‡ä»¶è«‹è¦‹\nç¯„ä¾‹ Terragrunt çš„ DRY featureï¼Œå…¶å¯¦å…§å®¹éƒ½å¤§åŒå°ç•°\nâ”œâ”€â”€ national-team-5g/ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # staging çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â”œâ”€â”€ stag â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # staging çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â””â”€â”€ prod â”‚Â â”œâ”€â”€ terraform.tfvars # prod çš„åƒæ•¸ â”‚Â â””â”€â”€ provider.tf\nä¾‹å¦‚\nnational-team-5g/dev/provider.tf\nprovider \u0026#34;google\u0026#34; { version = \u0026#34;~\u0026gt;v3.25.0\u0026#34; credentials = file(var.credential_json) project = var.project region = var.region } æ”¹æˆ\nnational-team-5g/dev/terragrunt.hcl\ngenerate \u0026#34;provider\u0026#34; { path = \u0026#34;provider.tf\u0026#34; if_exists = \u0026#34;overwrite\u0026#34; contents = \u0026lt;\u0026lt;EOF provider \u0026#34;google\u0026#34; { version = \u0026#34;~\u0026gt;v3.25.0\u0026#34; credentials = file(var.credential_json) project = var.project region = var.region } EOF } åŸ·è¡Œ\ncd national-team-5g/dev terragrunt plan é—œæ–¼åƒæ•¸\nvar.region æ˜¯æœ¬åœ°åƒæ•¸ï¼Œå¯ä»¥ä¾æ“š dev/staging/prod åƒæ•¸å„è‡ªè¨­å®š var.project é€™å€‹æ˜¯æ•´å€‹ national-team-5g éƒ½å…±ç”¨çš„åƒæ•¸ï¼Œå¯ä»¥é€²ä¸€æ­¥æé«˜åˆ°æ›´ä¸Šå±¤ i.g. æ”¾åœ¨ national-team-5g/terraform.tfvars æª”æ¡ˆè£¡é¢ï¼Œé€é terragrunt.hcl å‚³éã€‚ Functions tf æª”æ¡ˆï¼Œåœ¨è¨±å¤š block ä¸­ç¦æ­¢ä½¿ç”¨ variableï¼Œé€™å±¤é™åˆ¶æœ‰å…¶è€ƒé‡ï¼Œä½†æ˜¯ç¼ºé»æ˜¯é€ æˆè¨±å¤š hard coded çš„ç¨‹å¼ç¢¼ã€‚\nTerragrunt ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ï¼Œç”±æ–¼æ˜¯åœ¨ terragrunt åŸ·è¡Œå¾Œï¼Œterraform åŸ·è¡Œå‰ï¼Œå› æ¬¡æ²’æœ‰é€™å±¤é™åˆ¶ï¼Œå¯ä»¥åšè¨±å¤šäº‹æƒ…ï¼Œä¾‹å¦‚ code generate ä»¥åŠ function é‹ç®—ï¼Œterragrunt æä¾›è¨±å¤šå…§å»º functionï¼Œé€™é‚Šåªä»‹ç´¹å¸¸ç”¨å¹¾å€‹ã€‚\nfind_in_parent_folder() path_relative_to_include() ç¯„ä¾‹å…©å€‹æª”æ¡ˆ\nproject/dev/terraform.hcl\ninclude { path = find_in_parent_folders() } project/terraform.hcl\nenv = path_relative_to_include() æœ€å¾Œ parse å¾Œçš„çµæœ\nproject/dev/terraform.hcl\nenv = \u0026#34;dev\u0026#34; åšäº†å…©ä»¶äº‹\nè¦æ±‚ project/dev å»ä¸Šå±¤å°‹æ‰¾ terraform.hclï¼Œ â€¦","date":1601954148,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"4931936b48903ad9f4ca7c041c2d11cb","permalink":"https://chechia.net/zh-hant/post/2020-10-06-terraform-infrastructure-as-code-terragrunt/","publishdate":"2020-10-06T11:15:48+08:00","relpermalink":"/zh-hant/post/2020-10-06-terraform-infrastructure-as-code-terragrunt/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","éµäººè³½2020","iac","aws"],"title":"Terraform Infrastructure as Code: Terragrunt","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ å·¥å…· Terraform Atlantis Terragrunt å·¥å…·èˆ‡æ–‡åŒ– æ–°å·¥å…·æä¾›è§£æ±ºæ–¹æ¡ˆï¼Œç„¶è€Œå–®ç´”å°å…¥å·¥å…·å¾Œä¸æ˜¯å°±ä¸€å‹æ°¸é€¸ï¼Œè¨±å¤šå¯¦å‹™ä¸Šçš„å•é¡Œï¼Œé‚„æ˜¯è¦ä¾è³´æ”¹å–„å·¥ä½œæµç¨‹ï¼Œä¸¦ä¸”é¿å…æ•´é«”é‹ä½œçš„éŒ¯èª¤ã€‚\nå…¶æ¬¡ï¼Œä¸åŒåœ˜éšŠå·²æœ‰æ—¢æœ‰çš„åœ˜éšŠæ–‡åŒ–ï¼Œæ•´åˆæ–°çš„å·¥å…·å¾Œé‚„æ˜¯éœ€è¦ç£¨åˆï¼Œä¸ä¸€å®šè¦ç…§å–®å…¨æ”¶ã€‚æ›å¥è©±èªªï¼Œå·¥ä½œæµç¨‹çš„ä¸æ–·æ”¹é€²ä¹Ÿæ˜¯è§£æ±ºæ–¹æ¡ˆçš„ä¸€ç’°ã€‚\nå»ºè­°å¯¦è¸ Recommended Practices Terraform å®˜ç¶²æœ‰è¨±å¤šå»ºè­°çš„å¯¦ä½œèˆ‡å°å…¥æµç¨‹ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†çš„å»ºè­°æˆ‘å€‘éƒ½å·²ç¶“åœ¨å‰é¢çš„å¹¾ç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œé€™é‚Šè¦ä¾†èªªæ˜ä¸€ä¸‹ï¼Œä¸¦è£œå……å…¶ä»–å®˜æ–¹æ¨è–¦çš„å¯¦è¸ã€‚\næŠ€è¡“è¤‡é›œåº¦: éš¨è‘—æ¶æ§‹çš„è¤‡é›œå¢åŠ ï¼Œç¶­è­·æ•´é«”æ¶æ§‹çš„å›°é›£é€æ¼¸å¢åŠ  çµ„ç¹”è¤‡é›œåº¦: éš¨è‘—åœ˜éšŠè¦æ¨¡å¢é•·ï¼Œåˆ†å·¥èˆ‡æ¬Šè²¬è¶Šé¡¯è¤‡é›œï¼Œåœ˜éšŠçš„å”ä½œå›°é›£é€æ¼¸å¢åŠ  Terraform çš„ç›®çš„ï¼Œåœ¨æ–¼æ¸›å°‘ä¸Šé¢å…©è€…çš„è¤‡é›œåº¦ã€‚\nå·¥ä½œç›®éŒ„çµæ§‹ å·¥ä½œç›®éŒ„ (workspace) æ˜¯ terraform é‹ä½œçš„åŸºæº–é»ï¼Œå®¹ç´ tf æª”æ¡ˆï¼Œé€šå¸¸æœƒä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ã€‚\nä¸€å€‹ç’°å¢ƒä¸€å€‹å·¥ä½œç›®éŒ„ é€™å€‹æˆ‘å€‘åœ¨å‰é¢çš„ç¯„ä¾‹å·²ç¶“å¯¦è¸ï¼ŒåŸºæœ¬ä¸Šç›®éŒ„ç‚º\nproject (git repository) â”œâ”€â”€ api-server/ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â””â”€â”€ terraform.tf â”‚Â â”œâ”€â”€ stage â”‚Â â”‚Â â””â”€â”€ terraform.tf â”‚Â â””â”€â”€ prod â”‚Â â””â”€â”€ terraform.tf â”œâ”€â”€ grpc-server/ â”‚ å°‡ç”¢å“æˆ–å°ˆæ¡ˆåˆ‡å‰²æˆå„è‡ªç¨ç«‹çš„ç’°å¢ƒï¼Œä»¥æŸå°ˆæ¡ˆçš„æŸç’°å¢ƒä½œç‚ºç®¡ç†å–®ä½\nproject-api-server-dev project-api-server-stage project-api-server-prod project-grpc-server-dev â€¦ é€™éº¼åšæœ‰å¹¾å€‹å¥½è™•ï¼š\nç¢ºä¿ç”¢å“èˆ‡ç’°å¢ƒçš„ç¨ç«‹ å½¼æ­¤ä¸äº’ç›¸å½±éŸ¿ ä½†åˆå¯ç¢ºä¿å½¼æ­¤çš„é—œé€£æ€§ï¼Œä¾‹å¦‚æ¶æ§‹ç›¸åŒ ä»¥ç’°å¢ƒçš„ç‚ºç®¡ç†å–®ä½ï¼Œæ›å¥è©±èªªï¼Œä¸€çµ„å®Œæ•´çš„ç’°å¢ƒ ç›´æ¥å°æ‡‰åˆ° ä¸€çµ„å®Œæ•´çš„å·¥ä½œç›®éŒ„ ç®¡ç†ä¸Šéå¸¸ç›´è§€æ˜ç¢º ä½¿ç”¨å·¥ä½œç›®éŒ„åˆ†é…æ¬Šé™èˆ‡æ¬Šè²¬ ç›´æ¥ç‚ºä¸åŒåœ˜éšŠåˆ†é…ä¸åŒå·¥ä½œç›®éŒ„çš„å­˜å–æ¬Šé™ æ¬Šè²¬èˆ‡å·¥ä½œç›®éŒ„çš„æ˜ç¢ºå°æ‡‰ æŒçºŒè©•ä¼°èˆ‡æ”¹é€² è‡ªå‹•åŒ–ç¨‹åº¦ä¹Ÿæ˜¯å·¥ä½œæµç¨‹é€²æ­¥çš„æŒ‡æ¨™ï¼š\næ‰‹å‹•æ§åˆ¶ åŠè‡ªå‹•åŒ– å…¨è‡ªå‹•åŒ– å°å…¥ terraform å¾Œçš„æˆ‘å€‘å·²ç¶“æè¿°éäº†ï¼Œå…§å®¹è©³æƒ…è«‹è¦‹ä¸Šä¸Šç¯‡æ–‡ç« ã€‚ä¸‹é¢æè¿°å®˜æ–¹æ¨è–¦çš„å¾æœ€é–‹å§‹ï¼Œå®Œå…¨æ²’æœ‰ terraform ç¶“é©—é–‹å§‹å°å…¥æµç¨‹ï¼Œä»¥ç­†è€…å€‹äººæ–¼å…¬å¸å¾é›¶é–‹å§‹å°å…¥çš„ç¶“é©—ï¼Œéå¸¸ç›´å¾—åƒè€ƒã€‚\nå¦‚ä½•å¾å®Œå…¨æ‰‹å‹•æ“ä½œï¼Œè®ŠæˆåŠè‡ªå‹•æ“ä½œ å¦‚ä½•å¾åŠè‡ªå‹•ï¼Œè®Šæˆ IaC (infrastructure as code) å¦‚ä½•å¾ IaCï¼Œè®Šæˆ IaC å¤šäººå”ä½œ é€²éšæ”¹é€² IaC å¤šäººå”ä½œ å¦‚ä½•å¾å®Œå…¨æ‰‹å‹•æ“ä½œï¼Œè®ŠæˆåŠè‡ªå‹•æ“ä½œ å¦‚æœåœ˜éšŠæ‡‰è©²æ˜¯é‚„åœ¨å®Œå…¨æ‰‹å‹•æ§åˆ¶ infrastructure\næŸ¥é©— (audit) å›°é›£ ç„¡æ³•è¤‡ç¾ (reproduce) æ‹“å±• (scale) å›°é›£ å¾ˆé›£åˆ†äº« infrastructure çš„çŸ¥è­˜ ç¬¬ä¸€æ­¥è¦åŸ·è¡Œçš„æ˜¯ï¼šé¸æ“‡å°‘éƒ¨åˆ†ï¼Œå¯ä»¥æ§åˆ¶çš„ infrastructure é–‹å§‹å°å…¥ terraformã€‚æ‰€ä»¥è¦åšçš„å°±æ˜¯\né–‹å§‹ä½¿ç”¨ terraform å¦‚æœéœ€è¦å¯ä»¥åƒè€ƒä¸€äº›ç¯„ä¾‹å°ˆæ¡ˆ Terraform: Get Started collection é–‹å§‹é€²å…¥åŠè‡ªå‹•éšæ®µå¾Œï¼Œåœ˜éšŠä¸­çš„å°‘éƒ¨åˆ†äººå“¡é–‹å§‹ä½¿ç”¨ terraformï¼Œæ‰‹ä¸Šä¹Ÿæœ‰äº†å¯é‹ä½œçš„å°‘éƒ¨åˆ† infrastructure as codeï¼Œå¯ä»¥ä½œç‚º demo ï¼Œæˆ–æ˜¯å…¶ä»–åœ˜éšŠæˆå“¡çš„æ•™è‚²è¨“ç·´ï¼Œé€™å€‹å¯ä»¥å¹«åŠ©ä¸‹ä¸€éšæ®µçš„æ¼”é€²ã€‚\nå¦‚ä½•å¾åŠè‡ªå‹•ï¼Œè®Šæˆ IaC (infrastructure as code) ç›®å‰åŠè‡ªå‹•çš„å·¥ä½œå°ˆæ¡ˆå…§å®¹æ‡‰è©²æ˜¯ï¼š\nTerraform code æ‰‹å‹•æ“ä½œçš„æµç¨‹ ä¸€äº›è¼”åŠ©è…³æœ¬ ä¸‹å€‹éšæ®µå¸Œæœ›ç¹¼çºŒæ¨å±• terraform çš„ä½¿ç”¨ï¼Œé™ä½æ‰‹å‹•æ­¥é©Ÿèˆ‡è…³æœ¬åŸ·è¡Œã€‚é€™å€‹éšæ®µå¯ä»¥åšçš„äº‹æƒ…\nä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç† tf code é€™é‚Šå‡è¨­åœ˜éšŠæœ¬ä¾†å°±æœ‰ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œé–‹å§‹å°‡ tf code å°å…¥ç‰ˆæœ¬æ§åˆ¶çš„å·¥ä½œæµç¨‹ é–‹å§‹å°‡å…ˆç”¢ç”Ÿçš„ tf code ç§»å…¥ç‰ˆæœ¬æ§åˆ¶ æ‰€æœ‰åœ˜éšŠéƒ½èƒ½å…±äº«æ–° tf code çš„çŸ¥è­˜ é–‹å§‹ä½¿ç”¨ç¬¬ä¸€å€‹ terraform module ä¸€å€‹ç°¡å–®çš„æ–¹å¼æ˜¯å°‡é‡è¤‡ä½¿ç”¨çš„ infrastructure æŠ½å‡ºï¼Œæ¸›å°‘é‡è¤‡çš„ tf code é€™é‚Šéœ€è¦æé†’ï¼Œç›¡é‡ä»¥å®Œæ•´å€‹ infrastructure ä½œç‚ºå–®ä½æŠ½é›¢ tf code ä½œç‚º module å®Œæ•´çš„ infrastructure ä¹Ÿæ˜¯åœ¨ provider ä¸­é–“è½‰æˆçš„å–®ä½ æŒçºŒæ¨å»£åœ˜éšŠå…§ terraform çš„ä½¿ç”¨ é–‹å§‹è¨­å®šå·¥ä½œæº–å‰‡ (Guidelines) ä¾†æè¿°ä¸¦è¦ç¯„å·¥ä½œæµç¨‹ åœ¨åœ˜éšŠä¸Šä¸å®Œå…¨ç†Ÿæ‚‰ terraform å‰ï¼Œå¯ä»¥æå‡å·¥ä½œæ•ˆç‡ï¼Œæ¨å»£æœ€ä½³å¯¦è¸ï¼Œä¸¦ä¸”é™ä½éŒ¯èª¤é¢¨éšª åœ˜éšŠçš„æ¶æ§‹å¸«å¯ä»¥ä¾æ“šåœ˜éšŠæ–‡åŒ–å½¢å¡‘å·¥ä½œæµç¨‹ï¼Œæ›´ç¬¦åˆåœ˜éšŠéœ€æ±‚ é–‹å§‹å°å…¥ configuration management ä¾‹å¦‚ Chef cookbook ç§é‘°èˆ‡éš±ç§˜è³‡è¨Šç®¡ç† å°å…¥ vault ä¾†ç®¡ç† terraform æ•´åˆ vaultï¼Œå¯ä»¥ä½¿ç”¨ terraform ç®¡ç† vault çš„çµæ§‹ï¼Œä½¿ç”¨ vault ä¾†ç®¡ç† terraform æ‰€éœ€çš„ credentials å¦‚ä½•å¾ IaCï¼Œè®Šæˆ IaC å¤šäººå”ä½œ å°å…¥ç‰ˆæœ¬æ§åˆ¶å¯ä»¥é™ä½å †äººå”ä½œçš„è¤‡é›œåº¦ï¼Œä¸‹å€‹éšæ®µéœ€è¦\nçµ±ä¸€è·¨åœ˜éšŠçš„å·¥ä½œæµç¨‹ ä½¿ç”¨ terraform ç®¡ç†åœ˜éšŠçš„ IAM æ¬Šé™ å¯ä»¥åŸ·è¡Œçš„æ”¹é€²å¦‚ä¸‹ï¼š\nå®˜æ–¹æ¨è–¦ä½¿ç”¨ Terraform Cloud ä¾†åšå¾Œå°ï¼Œæˆ‘å€‘ç¨å€™æ¨è–¦çš„å¹¾å€‹å…è²»å·¥å…·ä¹Ÿæœ‰ç›¸ä¼¼åŠŸèƒ½ï¼Œåœ˜éšŠå¯ä»¥åƒè€ƒä½¿ç”¨ã€‚é€™é‚Šå°ˆæ³¨åœ¨éœ€æ±‚èˆ‡æ–¹æ³•ã€‚ é–‹å§‹è¨­è¨ˆæ•´å€‹çµ„ç¹”é–“çš„å·¥ä½œç›®éŒ„çµæ§‹ å·¥ä½œç›®éŒ„è¦åæ˜  ç¨ç«‹çš„ç’°å¢ƒèˆ‡ç¨ç«‹çš„å°ˆæ¡ˆ è² è²¬ç®¡ç†çš„åœ˜éšŠçµ„ç¹”ï¼Œå·²åˆ†é…å­˜å–æ¬Šé™ é€™éƒ¨åˆ†çš„å¯¦ä½œå¾Œé¢çš„æ–‡ç« ä¹Ÿæœƒæåˆ° å®˜æ–¹æ¨è–¦çš„ Terraform Cloud å¯è¦‹å®˜æ–¹æ–‡ä»¶ é€²éšæ”¹é€² IaC å¤šäººå”ä½œ å¦‚ä»Šåœ˜éšŠå·²ç¶“æœ‰å¤šäººå”ä½œçš„ä»‹é¢ï¼Œä¹Ÿæœ‰å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼Œæˆ‘å€‘å¯ä»¥è—‰ç”±ä»¥ä¸‹æ”¹é€²ï¼Œé”æˆæ›´å …å›ºçš„æ¡†æ¶\nå®˜æ–¹å»ºè­°å¤§é‡å°å…¥ Terraform Cloudï¼Œä½†é€™æœƒè¶…å‡ºå…è²»é¡åº¦ æˆ‘å€‘ä¹‹å¾Œçš„æ–‡ç« æœƒæä¾›é–‹æºç‰ˆæœ¬çš„è§£æ³• ç°¡åŒ–å·¥ä½œç›®éŒ„çš„ç®¡ç† æ˜ç¢ºçš„ review èˆ‡ audit å·¥ä½œæµç¨‹ å¢åŠ  infrastructure çš„ç›£æ¸¬èˆ‡æ•ˆèƒ½ç›£æ§ï¼Œé€™äº›éƒ½å¯ä»¥ä½¿ç”¨ terraform è¨­ç½® å…·é«”å¯¦ä½œï¼Œè«‹è¦‹ä¸‹ç¯‡æ–‡ç« \n","date":1601867748,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"e7204c2d088ce225d600bffe6c70e999","permalink":"https://chechia.net/zh-hant/post/2020-10-05-terraform-infrastructure-as-code-recommended-practices/","publishdate":"2020-10-05T11:15:48+08:00","relpermalink":"/zh-hant/post/2020-10-05-terraform-infrastructure-as-code-recommended-practices/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","éµäººè³½2020","iac","aws"],"title":"Terraform Infrastructure as Code: Recommended Practices","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\næ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html å·¥å…· Terraform Atlantis Terragrunt Terraform Backend å‰›é–‹å§‹ä½¿ç”¨ terraform çš„æ™‚å€™ï¼Œå¤§å®¶çš„ç¬¬ä¸€å€‹ç¯„ä¾‹æ‡‰è©²éƒ½æ˜¯ local backend å§ï¼Œå°±æ˜¯ç›´æ¥åœ¨æœ¬åœ° terraform applyï¼Œåœ¨ç›®å‰çš„å·¥ä½œç›®éŒ„ä¸‹ç”¢ç”Ÿ state æª”æ¡ˆã€‚é€™å€‹ state æª”æ¡ˆç›´æ¥ cat æ‰“é–‹ä¾†çœ‹å¾Œï¼Œå¯ä»¥ç™¼ç¾è£¡é¢ä¸€åˆ‡éƒ½æ˜¯æ˜ç¢¼çš„ã€‚åˆå­¸æ™‚ç­†è€…æ„Ÿè¦ºæ‰€è¬‚çš„ Terraform backend åªæ˜¯ä¸€å€‹å­˜æ”¾ä¸­ç¹¼çš„ state è³‡æ–™çš„ workspaceï¼Œå¾Œä¾†ç™¼ç¾å®Œå…¨ä¸æ˜¯é€™éº¼å›äº‹ï¼Œä¾¿ç«‹åˆ»æ£„ç”¨äº† local backendã€‚\nä¹‹å¾Œä¾ç…§å®˜æ–¹æ¨è–¦å°±ä½¿ç”¨äº† Terraform Cloudï¼Œå¾Œä¾†ä¾¿å‡ºç¾è¨±å¤šå•é¡Œï¼Œç­‰ç­‰æœƒåˆ†æã€‚\næœ€å¾Œåœ˜éšŠé¸ç”¨äº†è‡ªå®¶å…¬æœ‰é›²çš„ backendï¼Œä¾‹å¦‚\nAWS S3 ä½œç‚º state storageï¼ŒDynamoDB ä½œç‚ºä¸­å¿ƒåŒ–çš„ workflow lock GCP å®Œæ•´ terraform backend æ”¯æ´æ¸…å–®å¯ä»¥è¦‹å®˜æ–¹ç¶²ç«™ã€‚\né€™ç¯‡æ–‡ç« è¦ä¾†ä»”ç´°æ¢è¨æ‰€è¬‚çš„ terraform backendï¼Œbackend çš„é‡è¦æ€§ï¼Œèˆ‡å¦‚é¸æ“‡é©åˆè‡ªå·±åœ˜éšŠçš„ backendã€‚\nå•é¡Œ å¦‚æœä½¿ç”¨ tf random ç”¢ç”Ÿäº‚æ•¸å¯†ç¢¼ï¼Œç›´æ¥å» cat state æª”æ¡ˆå°±å¯ä»¥çœ‹åˆ°æ˜ç¢¼çš„ random æ•¸å€¼ã€‚\nå¤šäººå”ä½œ lock\nå¦å¤–ä¸€å€‹è§£æ³•æ˜¯ï¼Œæ ¹æœ¬ä¸ä½¿ç”¨ backendï¼Œterraform ä¹Ÿæ”¯æ´é€™æ¨£çš„åšæ³•ã€‚é›–ç„¶å®˜æ–¹ä¹Ÿæ˜è¬› backend are completely optionalï¼Œä½†ä¾ç…§ç­†è€…çš„ç¶“é©—ï¼Œå¼·çƒˆå»ºè­°å¤šäººåœ˜éšŠå‹™å¿…å»å•Ÿç”¨ï¼Œä¸¦æ‰¾å°‹é©åˆè‡ªå·±çš„ Backendã€‚\néœ€æ±‚ è³‡è¨Šå®‰å…¨ï¼Œå¸Œæœ› terraform ä½¿ç”¨æ˜¯å®‰å…¨çš„ï¼Œä¸æœƒæš´éœ²æ•æ„Ÿè³‡è¨Š å¤šäººå”ä½œï¼Œå¸Œæœ›å¯ä»¥åŒæ™‚å·¥ä½œï¼Œä½†åˆä¸æœƒäº’ç›¸è¡çª é ç«¯æ“ä½œï¼Œé¿å…æœ¬åœ°æ“ä½œ State å­˜æ”¾èˆ‡é– é è¨­çš„ backend æ˜¯ loal backendï¼Œä¹Ÿå°±æ˜¯åŸ·è¡Œ terraform apply å¾Œï¼Œæœ¬åœ°æœƒå‡ºç¾ä¸€å€‹ JSON æ ¼å¼çš„ state æª”æ¡ˆã€‚ç„¶è€Œ local state æœƒç«‹åˆ»é‡åˆ°çš„å•é¡Œï¼Œå°±æ˜¯\nç¬¬ä¸€å€‹æ˜¯å”ä½œå›°é›£ï¼Œapply çš„çµæœåˆ¥äººçœ‹ä¸åˆ°ï¼Œä¸èƒ½æ¥çºŒè‘—åš æ¯å€‹äººéƒ½å¯ä»¥ apply ä½†ä¸åŒäººçš„ apply æ²’æœ‰ç›¸ä¾æ€§ å¯æ˜¯é ç«¯çš„ infrastructure æœ‰ï¼ŒA B ä¸åŒäººä¸€èµ· apply åˆ° infrastructure ä¸Šï¼Œå¯å¯§å°±æœƒè¡çªï¼Œæˆ–æ˜¯ç”¢ç”Ÿä¸å¯é æœŸçš„éŒ¯èª¤ æ‰€ä»¥ç­†è€…å¼·çƒˆæ¨è–¦ä½¿ç”¨å¤–éƒ¨çš„ backend ä¾†å–ä»£ local backendã€‚å¤šåŠ backend æœƒå¤šåšè¨±å¤šäº‹ï¼Œé€éæ§åˆ¶ state ä¾†ç¢ºä¿ infrastrure çš„å®Œæ•´æ€§ï¼Œä¾‹å¦‚å° state å­˜å–æœ‰ä»¥ä¸‹çš„é™åˆ¶:\nï¼¡é€éé–ä¾†æ§åˆ¶ï¼Œç¦æ­¢å¤šäººåŒæ™‚å­˜å–ï¼Œä¾‹å¦‚åŒæ™‚æœ‰å…©å€‹äºº apply ç›¸åŒæˆ–ä¸åŒæª”æ¡ˆï¼Œå…ˆå–å¾— backend lock çš„äººåŸ·è¡Œï¼Œå¾Œä¾†çš„äººæœƒè¢« terraform é˜»æ“‹ é¿å…å¤šé ­é¦¬è»Šçš„å•é¡Œ ç¢ºä¿ state çš„å”¯ä¸€æ€§ï¼Œä½¿ç”¨å¦å¤–ä¸€å€‹ repo çš„ state æª”æ¡ˆï¼Œé ç«¯çš„ state æœƒæ‹’çµ•å­˜å– ç¢ºä¿ state çš„é †åºï¼Œæ¯æ¬¡ apply çš„ state éƒ½æ˜¯ä¾åºç”¢ç”Ÿ å¦‚æœ state æ˜¯èˆŠçš„ï¼Œå¯èƒ½å°±æœƒè¢«é ç«¯çš„ backend æ‹’çµ•ï¼Œé¿å…ä½¿ç”¨èˆŠçš„ apply è¦†è“‹æ–°çš„ infrastructure é€™äº›é™åˆ¶ï¼Œå¦‚æœä½¿ç”¨ local backend æ‰æœƒå®¹æ˜“é‡åˆ°ï¼Œä½¿ç”¨å¤–éƒ¨çš„ backend å…¶å¯¦ä¸å®¹æ˜“æœƒç™¼ç”Ÿã€‚Terraform åŸºæ–¼ Infrastructure as Code å¯¦ç¾ï¼Œå¯ä»¥å°‡æ•´å€‹ terraform repo è¦–ç‚º code ä¸€éƒ¨åˆ†ï¼Œé€™æ¨£å°±å¯ä»¥æƒ³åƒç‚ºä½•é€™äº› state é™åˆ¶æ˜¯é‡è¦çš„ã€‚\nstate è·Ÿéš¨ tf æª”æ¡ˆï¼Œéš¨è‘— tf æª”æ¡ˆçš„ commit æ¨é€²ï¼Œstate ä¹Ÿè·Ÿè‘—æ¨é€² commit 1 çš„ tf æª”æ¡ˆï¼Œapply å¾Œç”¢ç”Ÿ state 1 å¦‚æœä»Šå¤©æœ‰åœ˜éšŠ force push äº†ä¸€å€‹ conflict çš„ tf æª”æ¡ˆï¼Œç¡¬è¦ apply çš„çµæœä¹Ÿå¯èƒ½é€ æˆ infrastructure conflicts å¦‚æœä»Šå¤©åœ˜éšŠæœ‰å¤šå€‹ branch åŒæ™‚é–‹ç™¼ï¼Œbranch A apply çš„ state æœƒèˆ‡ branch B apply çš„ state ä¹Ÿå¯èƒ½é€ æˆè¡çª State æ‰‹å‹•æ›´æ”¹ åœ¨å¾ˆç‰¹æ®Šçš„ç‹€æ³ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹å‹•æ›´æ”¹ state fileï¼Œç„¶å¾Œ push ä¸Šå‚³ï¼Œä½†é€™é»éå¸¸ä¸å»ºè­°ï¼Œterraform æœƒè‡ªå‹•ç¶­è­· state çš„å®Œæ•´æ€§ï¼Œæ‰‹å‹•æ›´æ”¹å¯èƒ½æœƒç›´æ¥ç ´å£æ­£å¸¸çš„ stateã€‚ä»€éº¼æƒ…å½¢æœƒç”¨åˆ°ï¼Ÿå°±æ˜¯ä½ çš„ state å› ç‚ºæŸå€‹åŸå› è¢«ç©å£ï¼Œå¤§éƒ¨åˆ†æ˜¯äººç‚ºå¼„å£çš„ã€‚é€™æ™‚å€™æ‰è¢«è¿«è¦æ‰‹å‹•æ›´æ”¹ stateã€‚æ‰‹å‹•æ›´æ”¹ state ï¼Œè¬›ç™½äº†ä¸åšæ­»å°±ä¸æœƒæ­»ã€‚\nvault state pull vim your-local-state-file # Increment Serial if needed vault state push # vault state push -force Hosted: Terraform Cloud Terraform Cloudï¼Œæ˜¯å®˜æ–¹æä¾›çš„è§£æ±ºæ–¹æ¡ˆï¼Œæœ‰æä¾›è¼ƒå¤šåŠŸèƒ½ï¼Œä¾‹å¦‚åœ¨ terraform cloud çš„ç¶²ç«™ä¸Šé ç«¯ planã€‚æœ‰æä¾›å…è²»ç‰ˆï¼Œæä¾›æœ€å¤š 5 äººåœ˜éšŠä½¿ç”¨ã€‚ä¹Ÿæœ‰æä¾›é€²éšçš„æ–¹æ¡ˆ $20/user æˆ–æ˜¯ $70/userï¼Œä»¥åŠ enterprise ç‰ˆæœ¬ï¼Œå¯ä»¥æœ¬åœ°å®‰è£ã€‚\nä½¿ç”¨å¾ˆç°¡å–®ï¼Œæˆ‘åœ¨å‰å¹¾ç¯‡æä¾›çš„ç¯„ä¾‹ repositoryå…¨éƒ¨éƒ½æ˜¯ä½¿ç”¨ terraform cloud ä½œç‚º Backendã€‚æä¾›\né ç«¯çš„ state å„²å­˜åº« æ‰€æœ‰åœ˜éšŠæˆå“¡ä½¿ç”¨å„è‡ªå¸³è™Ÿç™»å…¥ plan ä¹‹å‰æœƒ sync terraform cloud ä¸Šé¢çš„ state é ç«¯çš„ state lock å¦‚æœ lock è¢«äººä½”æ“šï¼Œè¡¨ç¤ºæœ‰å…¶ä»–äººæ­£åœ¨ä½¿ç”¨ï¼Œæœƒå–æ¶ˆæ–°çš„æ“ä½œï¼Œé¿å…è¡çª ä¹Ÿæä¾›ç·šä¸Šæª¢è¦– state ï¼Œæˆ–æ˜¯ç·šä¸Šä¿®æ”¹ state çš„åŠŸèƒ½ è²¼å¿ƒå°åŠŸèƒ½ï¼Œä½†å¤šåŠç”¨ä¸åˆ° è¨—ç®¡çš„ Terraform Cloud ä½œç‚º backend ä»–æœ‰å¹¾å€‹å•é¡Œ\nå¦‚æœè¦å•Ÿç”¨é ç«¯ planï¼Œéœ€è¦ç¶å®šç‰ˆæœ¬æ§åˆ¶æœå‹™å™¨ï¼Œä¾‹å¦‚ç¶å®š Github æˆ– Gitlab åŸºæ–¼å®‰å…¨æ€§è€ƒé‡ï¼Œé€™é»å¾ˆå¤šå…¬å¸å°±ç›´æ¥æ‰“æ§äº† æš´éœ²åŸå§‹ç¢¼çµ¦ç¬¬ä¸‰æ–¹å…¬å¸ï¼Œå¯èƒ½æœƒè®“å…¬å¸çš„å®‰å…¨æ€§æª¢é©—ä¸é åŠ ä¸Š terraform çš„ Git Codeï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ‰€æœ‰ infrastructure çš„è³‡è¨Š åŠ ä¸Šå¦‚æœæœ‰ä½¿ç”¨ terraform ç·¨è¼¯ IAM æˆ–æ˜¯ provision vaultï¼Œç­‰æ–¼è¨±å¤šæ•æ„Ÿè³‡æ–™éƒ½æœƒå‡ºç¾åœ¨ terraform repository ä¸­ å¦‚æœæ˜¯é‡è¦–å®‰å…¨æ€§çš„åœ˜éšŠï¼Œå‰‡è‡³å°‘è¦ä½¿ç”¨å¯ä»¥ self-hosted çš„ Terraform Enterpriseï¼Œè€Œä¸è¦ä½¿ç”¨å…¬æœ‰çš„ Terraform Cloudã€‚ç„¶è€Œ Enterprise æˆ‘æ˜¯æ²’ç”¨éï¼Œè«‹ä¸è¦å•æˆ‘åƒ¹éŒ¢ã€‚\nConsul Consul åš´æ ¼ä¾†èªªä¸æ˜¯å–®ç´”çš„å„²å­˜åº«ï¼Œä»–æ˜¯ Service Networking è¨­å®šèˆ‡æœå‹™ç™¼ç¾çš„è§£æ±ºæ–¹æ¡ˆï¼Œåªæ˜¯æœ¬èº«å¸¶æœ‰ key value çš„å„²å­˜åŠŸèƒ½ï¼Œå°±è¢«è‡ªå®¶æ•´åˆã€‚æ›å¥è©±èªªï¼Œä»–ä¸æ˜¯å°ˆé–€æ‹¿ä¾†åš terraform backend çš„ï¼Œæ¯”è¼ƒåƒæ˜¯å¦‚æœåœ˜éšŠæœ¬ä¾†å°±æœ‰ä½¿ç”¨ consulï¼Œå¯ä»¥è€ƒæ…®å…¬ç”¨å„²å­˜åº«ï¼Œä½œç‚º terraform backendã€‚\né€™æ˜¯ç›¸åŒå…¬å¸ Hashicorp æä¾›çš„è‡ªå®¶çš„ backendï¼Œæ•´åˆçš„å¾ˆå®Œæ•´ã€‚ä½†å°±åªæ˜¯å–®ç´”çš„å„²å­˜åº«ï¼Œæ²’æœ‰ terraform cloud çš„é ç«¯åŸ·è¡Œå•Šï¼Œæˆ–æ˜¯ç·šä¸Šæª¢è¦– state æª”æ¡ˆçš„åŠŸèƒ½ã€‚\nå¯ä»¥åœ¨å…¬å¸å…§éƒ¨è‡ªè¡Œæ¶è¨­ä¸€çµ„ clusterï¼Œç„¶å¾Œå°±å¯ä»¥ä½œç‚º backendã€‚\nå•é¡Œæ˜¯\nConsul é€™éº¼å¤§ä¸€åŒ…ï¼Œçµæœåªä½¿ç”¨äº†è£¡é¢çš„ kv store Consul æ˜¯åˆ†æ•£å¼çš„ Key-value storeï¼Œä¸ç†Ÿæ‚‰çš„è©±ä¸å¤ªå¥½é¤Š æ›å¥è©±èªªï¼Œå¦‚æœæ­»äº†æ•‘å¾—èµ·ä¾†å— Etcd Etcd è·Ÿ consul é¡ä¼¼ï¼Œé›–ç„¶æ˜¯å°ˆæ¥­çš„å„²å­˜åº«ï¼Œä½†æ˜¯ä½¿ç”¨é€™éº¼è¤‡é›œçš„åˆ†æ•£å¼å„²å­˜åº«ï¼Œåªä½œç‚º terraform çš„ backendï¼Œé¡¯ç„¶å¾ˆä¸ç¶“æ¿Ÿã€‚\nå¯ä»¥åœ¨å…¬å¸å…§éƒ¨è‡ªè¡Œæ¶è¨­ä¸€çµ„ clusterï¼Œç„¶å¾Œå°±å¯ä»¥ä½œç‚º backendã€‚\nä¸€æ¨£åªå»ºè­°å·²ç¶“æœ‰åœ¨ä½¿ç”¨ etcd ï¼Œä¸”ç†Ÿæ‚‰ç¶­é‹ etcd çš„åœ˜éšŠï¼Œæ‰è€ƒæ…®ä½¿ç”¨ etcd å…¼ä½œç‚º terraform backendã€‚\né€™äº›åˆ†æ•£å¼çš„å„²å­˜åº«ï¼Œä¸å¤ªå®¹æ˜“æ­»ï¼Œç„¶è€Œè¬ä¸€æ­»äº†å¯èƒ½ä¸å¤ªå¥½æ•‘ã€‚\nPublic Cloud AWS S3 + DynamoDB GCP gcs + pg Azurerm + pg\nåªæœ‰å–®ç´”çš„ state storage èˆ‡ lock çš„åŠŸèƒ½ï¼Œæ²’æœ‰ä»€éº¼èŠ±ä¿çš„ç·šä¸ŠåŸ·è¡Œæˆ–æ˜¯å¿«é€Ÿ reviewã€‚\nå¥½è™•æ˜¯\nä½¿ç”¨éå¸¸å–®ç´” ä¹Ÿæ˜¯è™•åœ¨å®‰å…¨çš„å…§ç¶²ç’°å¢ƒä¸­ æœ‰æ–¼æ˜¯å…¬æœ‰é›²æä¾›çš„æœå‹™ï¼ŒåŸºæœ¬çš„ IAM èˆ‡æ¬Šé™æ§ç®¡å¯ä»¥ç›´æ¥æ‡‰ç”¨ Postgresql Postgrel ä¹Ÿæ˜¯ä¸€å€‹ä¸éŒ¯çš„é¸æ“‡\nTerraform ä¸¦ä¸æœƒå¸¶ä¾†å¤§é‡çš„è³‡æ–™åº«è² æ“”ï¼Œæ‰€ä»¥å¯èƒ½æœƒæŠŠ terraform èˆ‡é™„è¼‰è¼ƒä½çš„æ‡‰ç”¨ï¼Œå…±ç”¨è³‡æ–™åº«ã€‚\nä½¿ç”¨ä¸Šä½œç‚º state storage èˆ‡ lock å¾ˆå–®ç´”æ²’ä»€éº¼å•é¡Œ\nå…¶ä»– å®˜æ–¹é‚„æœ‰æä¾›æ‰€æœ‰æ”¯æ´çš„ backend\nå¦‚æœ Kubernetes é‚„æœ‰åšå…¶ä»–äº‹æƒ…çš„è©±ï¼Œè«‹ä¸è¦ç”¨ Kubernetes secret ä½œç‚º terraform çš„ backend\n","date":1601781348,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"1a9f99fd076abd2eb693e41d09ddcdf0","permalink":"https://chechia.net/zh-hant/post/2020-10-04-terraform-infrastructure-as-code-backend/","publishdate":"2020-10-04T11:15:48+08:00","relpermalink":"/zh-hant/post/2020-10-04-terraform-infrastructure-as-code-backend/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","éµäººè³½2020","iac","aws"],"title":"Terraform Infrastructure as Code: Backends","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\næ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html å·¥å…· Terraform Atlantis Terragrunt CI/CD å…¨è‡ªå‹•åŒ– ç•¶å…¬å¸æˆåŠŸå°å…¥ terraform ï¼Œä¸¦ä¸”æ•´åˆ Git-flow çš„å·¥ä½œæµç¨‹å¾Œï¼Œæ‡‰è©²å¯ä»¥å¾ˆæ˜é¡¯çš„æ„Ÿå—åˆ°ï¼Œæ•´é«”çš„ infrastructure ç”¢å‡ºç©©å®šåº¦æœ‰å¤§å¹…æå‡ï¼Œç•¢ç«Ÿè»Ÿé«”å·¥ç¨‹ä¸­ code review æ˜¯ç©©å®šåº¦çš„æ ¸å¿ƒé—œéµä¹‹ä¸€ï¼Œè€Œå°å…¥ terraform èˆ‡ infrastructure as code è®“ infrastructure ä¹Ÿèƒ½åœ¨åˆç†çš„å·¥ä½œæµç¨‹ä¸­è¢«å±¤å±¤ reviewã€‚\nstable master -\u0026gt; feature/add-new-infra -\u0026gt; PR feature/add-new-infra -\u0026gt; master\nfeature branch merge é€²å» master ä¹‹å¾Œï¼Œå°±ç¢ºå®šæ˜¯ review éè€Œä¸”ç©©å®šçš„ç¨‹å¼ç¢¼ï¼Œå†ç”±å·¥ç¨‹å¸« pull æœ€æ–°çš„ master ï¼Œç„¶å¾Œåœ¨æœ¬åœ°åŸ·è¡Œ terraform applyï¼ŒæŠŠ infrastructure ç”Ÿå‡ºä¾†ã€‚\né€™æ¨£åšæœ¬è³ªä¸æœƒæœ‰ä»€éº¼å¤§å•é¡Œï¼Œç•¢ç«Ÿ code å·²ç¶“æ˜¯ç©©å®šã€‚ç„¶è€Œï¼Œå¯¦å‹™ä¸Šå»é‚„æ˜¯æœƒå‡ºç¾å¶ç™¼çš„å•é¡Œã€‚ä¾‹å¦‚ï¼šä½¿ç”¨éŒ¯èª¤çš„ credentail æˆ– contextï¼Œå°è‡´ dev æˆ– staging çš„ infrastructure apply åˆ° prod ä¸Šï¼Œç›´æ¥ p0 issue å¤§çˆ†ç™¼ï¼ŒSRE éƒ½è·ªè‘—ä¸Šç­ã€‚åˆä¾‹å¦‚ï¼šä½¿ç”¨éŒ¯èª¤çš„ master ç‰ˆæœ¬ applyï¼Œçµæœä¹Ÿæ˜¯æœå‹™æ‰ç·šï¼Œæ•´å€‹ team è·ªè‘—ä¸Šç­ã€‚\né—œéµï¼šåœ˜éšŠæ•´é«”çš„å®‰å…¨æ€§ï¼Œæ˜¯ç”±ç¨‹åº¦æœ€èœçš„åŒäº‹æ±ºå®šã€‚\nå°æˆ‘å°±æ˜¯åœ¨èªªä½ XDã€‚ç„¶è€Œäººéƒ½æœƒèœï¼Œè€Œäººäº‹æˆæœ¬ä¹Ÿæ˜¯å…¬å¸ç¶“ç‡Ÿçš„é—œéµè€ƒé‡ï¼Œç›¸ä¿¡æ‰€æœ‰åŒäº‹éƒ½å¤§ç¥æ˜¯ä¸åˆ‡å¯¦éš›çš„ï¼Œä¸å¦‚æ”¹é€²å·¥ä½œæµç¨‹ï¼Œè¿‘ä¸€æ­¥é™ä½äººç‚ºæ“ä½œå¤±èª¤çš„å¯èƒ½ã€‚äººçš„å•é¡Œï¼Œæ ¹æœ¬ä¹‹é“é‚„æ˜¯æ•™è‚²ï¼Œç„¶è€Œæˆ‘å€‘å¯ä»¥è©¦è‘—ç”¨æŠ€è¡“èˆ‡å·¥å…·é™ä½é¢¨éšªã€‚\nä»¥ä¸‹çš„åšæ³•ï¼Œå¯èƒ½æœƒå”åŠ©é¿å…é€™å€‹å•é¡Œã€‚æˆ‘å€‘è¦åšçš„å°±æ˜¯ CI/CD çš„å…¨è‡ªå‹•åŒ–ã€‚\néœ€æ±‚ é¿å… apply å¤±èª¤ é¿å…æ„šè ¢çš„éŒ¯èª¤ ç’°å¢ƒåˆ‡æ›éŒ¯èª¤ apply éŒ¯ç‰ˆæœ¬ (æ„šè ¢çš„éŒ¯èª¤æ¯”ä½ æƒ³çš„è¦å¤šï¼Œå‡ºç¾å¾Œæœƒè®“ä½ ä¸‰è§€å¤§é–‹) åŠ é€Ÿå·¥ä½œæµç¨‹ PR çµæŸå¾Œï¼Œåœ¨åˆé©çš„æ™‚é–“è‡ªå‹• apply è‡ªå‹•å›å ±çµæœ å‡ºéŒ¯è‡ªå‹• rollback ä¸Šå€‹ç©©å®šç‰ˆæœ¬ æœ€å°æ¬Šé™åŸå‰‡ (least privilege access) åŸæœ¬å·¥ç¨‹å¸«ç‚ºäº† apply ï¼Œæœƒæœ‰ admin æ¬Šé™çš„ credential ç§»è½‰åˆ°å®‰å…¨çš„ CI/CD server ä¸Šï¼Œåœ¨ server ä¸ŠåŸ·è¡Œ å·¥ç¨‹å¸«ä¸å†æ¡æœ‰é€™äº›è¶…ç´šç®¡ç†å“¡æ¬Šé™ï¼Œé¿å…å·¥ä½œæ©Ÿè¢«é§­çš„å®‰å…¨éš±æ†‚ NOTE: å·¥ç¨‹å¸«è¢«é‡£é­š (phishing) æˆ–æ˜¯ç¤¾äº¤å·¥ç¨‹æ”»æ“Š (social engineering attacks) æ‰æ˜¯å°è‡´å…¬å¸æœå‹™è¢«å®³çš„ä¸»å› ï¼Œä¸å¯ä¸é˜² è§£æ±ºæ–¹æ¡ˆ é¸æ“‡å®‰å…¨çš„ CI/CD serverï¼Œä¾‹å¦‚åœ¨å…§ç¶²çš„ self-hosted Jenkins server å°‡ terraform çš„åŸ·è¡Œé»ï¼Œå¾å·¥ç¨‹å¸«æœ¬æ©Ÿç§»è½‰åˆ° CI/CD æœå‹™å™¨ä¸Š æ›´æ”¹ CI/CD ï¼ŒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ Terraform validate Terraform plan çš„çµæœè¼¸å‡ºåˆ° Github / Slack plan çµæŸå¾Œåœä½ CI/CDï¼Œç™¼é€ä¸€å€‹ apply request åˆ° Github commentï¼Œä¸å†ç¹¼çºŒåŸ·è¡Œ apply SRE ä¸»ç®¡åªè¦é€é Github comment æˆ–æ˜¯ Slack bot å°±å¯ä»¥é¸æ“‡åˆé©çš„æ™‚é–“ï¼Œapprove apply æœ€å¾Œç§»é™¤å¤§å¤šæ•¸å·¥ç¨‹å¸«çš„ terraform æ¬Šé™ ç¯„ä¾‹ äº‹å¯¦ä¸Šï¼Œä¸åŒå®¶çš„ CI/CD serverï¼Œå·¥ä½œæµç¨‹éƒ½æ˜¯é¡ä¼¼\ncheckout initialize tools / SDK (ex. az/aws/gcloud client) inject public cloud credential (ex. Azure/AWS/GCP key) terraform validete terraform plan terraform apply (option) require manual approve å¦‚æœæ˜¯ Jenkins çš„ä½¿ç”¨è€…ï¼Œå¯ä»¥åƒè€ƒ Azure æä¾›çš„ç¯„ä¾‹\nç’°å¢ƒç®¡ç† åœ¨äººå·¥ apply çš„å·¥ä½œæµç¨‹ä¸­ï¼Œå·¥ç¨‹å¸«éœ€è¦è‡ªè¡Œåˆ‡æ›ç’°å¢ƒï¼Œä¾‹å¦‚ git repo å·¥ä½œç›®éŒ„å¦‚ä¸‹\ntree project â”œâ”€â”€ dev â”œâ”€â”€ staging â””â”€â”€ prod cd project/dev; terraform plan # plan staging cd project/prod; terraform plan # plan prod é€™æ˜¯ç›¸å°æ¯”è¼ƒå®‰å…¨çš„åšæ³•ï¼Œåœ¨å°çš„è³‡æ–™å¤¾ç›®éŒ„ä¸‹ï¼Œå°±æœƒ apply åˆ°æ­£ç¢ºçš„ç’°å¢ƒï¼Œç¨‹å¼ç¢¼èˆ‡ç’°å¢ƒæœ‰ç·Šå¯†çš„å°æ˜ ã€‚é™¤äº†ä»¥ä¸‹å¹¾ç¨®æƒ…å½¢\næƒ³è¦éƒ¨ç½² devï¼Œçµæœæ²’æ³¨æ„åˆ°è‡ªå·±åœ¨ staging æˆ–æ˜¯ prod æœ‰ä¸€éƒ¨åˆ†çš„ input variable æœƒå½±éŸ¿çµæœï¼Œç„¶å¾Œåˆè¼¸å…¥éŒ¯èª¤çš„ input åˆ°éŒ¯èª¤çš„ç’°å¢ƒä¸Š å°å¾ˆæ„šè ¢ï¼Œä½†æˆ‘éƒ½è¦‹éï¼ˆæ°£è¡€æ”»å¿ƒï¼‰ã€‚\næ—¢ç„¶å°å…¥äº†è‡ªå‹•åŒ–ï¼Œç’°å¢ƒçš„åˆ‡æ›å¯ä»¥è‡ªå‹•åˆ‡æ›ï¼Œä¾‹å¦‚\næ‰€æœ‰ feature branch åŸ·è¡Œ CI/CD server ä¸Šçš„æœ¬åœ°æ¸¬è©¦ lint init validate æ‰€æœ‰ PR éƒ½æœƒè§¸ç™¼æ–°çš„ dev ç’°å¢ƒéƒ¨ç½² plan apply æ¸¬è©¦è…³æœ¬ æ‰€æœ‰ master merge / push éƒ½æœƒè§¸ç™¼ staginge éƒ¨ç½² QA æ¸¬è©¦ å£“åŠ›æ¸¬è©¦ (optional) æ‰€æœ‰ release candidate tag æœƒéƒ¨ç½²åˆ° release candinate release management æ‰€æœ‰ç™¼å¸ƒç‰ˆæœ¬çš„ tag (ex. 1.1.0 / 1.2.0-release) æœƒéƒ¨ç½² prod ç•¶ç„¶è¦äº‹å…ˆé€šçŸ¥ç›¸é—œäººå£« stack holders è³‡æ·±å·¥ç¨‹å¸«åªè¦æ§åˆ¶ branch / tag å°±å¯ä»¥æ§åˆ¶ç™¼å¸ƒã€‚\nä½ èªªé€™æ¨£ï¼Œè¬ä¸€å¤©å…µå»è‡ªå·±æ‰“ tag æ‰“éŒ¯ commitï¼Œæˆ–æ˜¯æ¨éŒ¯ branch æ¨åˆ° masteræˆ–æ˜¯ release candidateï¼Œé‚„ä¸æ˜¯ä¾æ¨£çˆ†æ‰ã€‚é‚£ä½ å¯ä»¥æŠŠ master èˆ‡ release branch é–èµ·ä¾† (protected branch) ï¼Œç„¶å¾ŒæŠŠ tag push æ¬Šé™é–ä½ã€‚\nä½ èªªé‚„æ˜¯éŒ¯ é‚£æˆ‘â€¦ â€¦å€‘çœ‹ä¸‹ä¸€æ®µ orz\nå®‰å…¨æ€§ é›–ç„¶èªªæ˜¯è‡ªå‹•åŒ–æ”¹å–„å·¥ä½œæµç¨‹ï¼Œç„¶è€Œæ”¶å›å­˜å–æ¬Šé™ï¼Œå°æ–¼æœå‹™çš„æ•´é«”å®‰å…¨æ€§å¤§å¹…æå‡ï¼Œç•¢ç«Ÿæ˜¯å¯ä»¥æ›´æ”¹ infrastructure çš„ç®¡ç†å“¡å¸³æˆ¶ã€‚Terraform æ—¢ç„¶èƒ½å¤ æ–°å¢ä¿®æ”¹é›²ç«¯çš„ infrastructureï¼Œé€™å€‹å¸³è™Ÿçš„æ¬Šé™æ˜¯ç›¸ç•¶å¤§çš„ï¼Œè¬ä¸€é‡‘é‘°(GCP/AWS/Azure credentail) æµå‡ºæˆ–é­é§­ï¼Œå¾Œæœéƒ½æ˜¯æ¯€æ»…æ€§çš„ï¼Œä¾‹å¦‚å¯ä»¥ç›´æ¥åˆªé™¤æœå‹™çš„ infrastructureï¼Œæˆ–æ˜¯ä¿®æ”¹é˜²ç«ç‰†çš„è¦å‰‡ï¼Œå·åŸ‹å…¶ä»–é‡‘è€€ï¼Œâ€¦ç­‰æ–¼æ˜¯æ•´åº§å…¬æœ‰é›²é€çµ¦é§­å®¢ã€‚æ‰€ä»¥æˆ‘å€‘ä½¿ç”¨ Terraform æ‡‰è©²è¦æ…é‡è€ƒæ…®å­˜å–æ¬Šé™çš„å®‰å…¨æ€§ã€‚\næœ¬ä¾†æ˜¯æ¯å€‹ SRE çš„æœ¬æ©Ÿé›»è…¦ä¸Šï¼Œå¯èƒ½éƒ½æœƒæœ‰é€™æŠŠå¸³æˆ¶æ¬Šé™ã€‚\nå¦‚æœæ˜¯ self-hosted Jenkins serverï¼Œæˆ–æ˜¯ Github enterprise serverï¼ŒæŠŠæœå‹™æ¬Šé™ç§»è½‰åˆ°é€™äº›æœå‹™å™¨ï¼Œä¾¿å¯ä»¥ç¢ºä¿é‡‘é‘°æ°¸é éƒ½åœ¨å…¬å¸çš„é˜²ç«ç‰†å…§éƒ¨ç¶²è·¯ï¼Œæ›´åŠ å¤§å¹…åº¦çš„æå‡æ•´é«”çš„å®‰å…¨æ€§ã€‚\nå…¶ä»– å¯ä»¥é€²ä¸€æ­¥åšé‡‘é‘°æ¬Šé™åˆ†å‰²ï¼Œå°‡åº•ä¸‹å››å€‹æ¬Šé™é€éå…¬æœ‰é›²çš„ IAM role å»åˆ‡å‰²ã€‚è¦æ˜¯è¬ä¸€é‡‘é‘°é‚„æ˜¯å¤–æ´©äº†ï¼Œå¯ä»¥é™ä½æå¤±ã€‚\nè®€å– æ–°å¢ ä¿®æ”¹ åˆªé™¤ ä½ èªªé€™å€‹ä¸ç”¨è‡ªå‹•åŒ–å°±å¯ä»¥åšï¼Œæˆ‘èªªå¦‚æœåˆ†å‰²é‡‘é‘°ç„¶å¾Œäººå·¥è‡ªå·±åˆ‡æ›æ“ä½œï¼Œåè€Œæœƒå¢åŠ æ“ä½œçš„è¤‡é›œåº¦ï¼Œå¢åŠ éŒ¯èª¤çš„æ©Ÿæœƒã€‚ç„¶å¾Œå·¥ç¨‹å¸«çš„ç—›è‹¦ç¨‹åº¦ï¼Œèˆ‡æ‰‹ä¸Šçš„é‡‘é‘°æ•¸é‡æˆæ­£æ¯”ã€‚\næˆ–æ˜¯åˆ©ç”¨ç’°å¢ƒå­˜å–é‡‘è€€åˆ†å‰²ï¼ŒæŠŠé‡‘è€€é€²ä¸€æ­¥åˆ‡å‰²æˆä¸åŒçš„æ¬Šé™ï¼Œè¬ä¸€æ‰äº†ï¼Œæå®³ä¹Ÿæ§åˆ¶åœ¨ä¸€å€‹ç’°å¢ƒä¹‹å…§ã€‚ä¾‹å¦‚ï¼š\ndev staging prod ä¸åŒç’°å¢ƒçš„ infrastructure ï¼Œåœ¨å‰µå»ºåˆæœŸå°±æ˜¯é€éä¸åŒçš„å¸³è™Ÿç”¢ç”Ÿçš„ï¼Œå½¼æ­¤ä¸æœƒæœ‰ä¸ä¹¾æ·¨æ®˜ç•™çš„å¸³è™Ÿæ¬Šé™ã€‚\nå°çµ é€™é‚Šå°±è¬›å…©ä»¶äº‹\nè‡ªå‹•åŒ–å¯ä»¥é˜²å‘† è‡ªå‹•åŒ–å¯ä»¥å¢åŠ å®‰å…¨ åƒè€ƒæ–‡ä»¶ Terraform Official doc: Running Terraform in Automation ","date":1601694948,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"ee597de7e0d59a4adfd309e27f519bd3","permalink":"https://chechia.net/zh-hant/post/2020-10-03-terraform-infrastructure-as-code-automation/","publishdate":"2020-10-03T11:15:48+08:00","relpermalink":"/zh-hant/post/2020-10-03-terraform-infrastructure-as-code-automation/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","éµäººè³½2020","iac","aws"],"title":"Terraform Infrastructure as Code: CI/CD automation","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›äº†å¾ˆå¤š terraform çš„æ“ä½œç¯„ä¾‹ï¼Œæ‡‰è©²çœ‹åˆ°é€™è£¡ï¼Œå°æ–¼ terraform åŸºæœ¬ä¸Šæ˜¯ä»€éº¼æ±è¥¿ï¼Œæ‡‰è©²æœ‰äº›æ¦‚å¿µäº†ã€‚ç„¶è€Œé€™æ¨£é‚„ä¸èƒ½ç®—æ˜¯å­¸æœƒ terraformï¼Œé€™ç¨®å·¥å…·çš„æ±è¥¿ä¸€å®šè¦æœ‰å¯¦éš›æ“ä½œéçš„ç¶“é©—æ‰ç®—æ˜¯å­¸æœƒã€‚\nå¯ä»¥ç›´æ¥åƒè€ƒ Terraform å®˜æ–¹çš„ Get-started æ–‡ä»¶ä¾†æ“ä½œå­¸ç¿’ï¼Œæˆ‘é€™é‚Šä¹Ÿæä¾›ä¸€å€‹ Git repository è®“å¤§å®¶ä¸Šæ‰‹ï¼Œç•¶ä½œåˆæ¬¡æ“ä½œçš„æ¡†æ¶ã€‚\næä¾›åšç‚ºç¯„ä¾‹çš„åŸå§‹ç¢¼ é€™å€‹ Github Repository æ˜¯æˆ‘çµ¦ç¤¾ç¾¤æ¼”è¬›æ‰€ä½¿ç”¨çš„ç¯„ä¾‹ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨çš„å¯ä»¥åƒè€ƒ\nhttps://github.com/chechiachang/terraform-playground\ntree â”œâ”€â”€ README.md â”œâ”€â”€ SOP.md â”œâ”€â”€ aws/ â”œâ”€â”€ azure/ â””â”€â”€ gcp/ TL;DR é¸æ“‡ä½¿ç”¨çš„é›²å¹³å°ï¼Œé€™é‚Šæä¾›ä¸‰å®¶ç¯„ä¾‹ï¼Œä¾‹å¦‚æˆ‘é€™é‚Šä½¿ç”¨ gcpï¼Œç•¶ç„¶ä½ å°±è¦æº–å‚™ GCP çš„å¸³è™Ÿï¼Œä¸¦ä¸”ä¸‹è¼‰æœ‰åŸ·è¡Œæ¬Šé™çš„ç”¨æˆ¶ credential json key ç­‰ç­‰ã€‚\né›–ç„¶æˆ‘æ²’æ”¶ gcp éŒ¢ï¼Œé€™é‚Šé‚„æ˜¯æ¨å»£ä¸€ä¸‹ gcp çš„ free credit è©¦ç”¨ã€‚é˜¿è¦ç”¨ Azure Cloud çš„ free credit ä¾†åŸ·è¡Œé€™å€‹ç¯„ä¾‹ä¹Ÿæ˜¯å®Œå…¨æ²’å•é¡Œï¼Œéå¸¸å¤ ç”¨ã€‚å”¯æœ‰ AWS çš„è©¦ç”¨æ–¹æ¡ˆè·Ÿå‰©ä¸‹å…©å®¶ä¸å¤ªä¸€æ¨£ï¼Œé€™å€‹ repository èµ·çš„æœå‹™å¯èƒ½æœƒè¶…é AWS çš„å…è²»é¡åº¦æ¶µè“‹ç¯„åœï¼Œç¸½ä¹‹è«‹è‡ªå·±æ³¨æ„ã€‚\ngit clone https://github.com/chechiachang/terraform-playground cd gcp DIR=my-new-project make project cd my-new-project vim *tf terraform init terraform plan terraform apply é€™æ¨£æ‡‰è©²å°±æœƒè·‘å®Œã€‚ç„¶å¾Œæˆ‘å€‘è¬›è§£å¹¾å€‹åœ°æ–¹ã€‚\nå·¥ä½œç›®éŒ„ Terraform é è¨­æ˜¯ä»¥ç•¶ä¸‹åŸ·è¡Œçš„ç›®éŒ„ä½œç‚ºåŸºæº–ï¼Œæƒæè³‡æ–™å¤¾ä¸­çš„ .tf æª”æ¡ˆã€‚æ‰€ä»¥å¯ä»¥æŠŠä¸€å€‹ä¸€å€‹ç¨ç«‹çš„å°ˆæ¡ˆå…ˆç”¨è³‡æ–™å¤¾è£å¥½ï¼Œå½¼æ­¤å…§å®¹äº’ä¸å¹²æ¶‰ã€‚\næˆ‘å€‘é€™é‚Šå‰µå»ºæ–°çš„ subdirectoryï¼Œé€™é‚Šæ˜¯ä»¥ my-new-project ç‚ºç¯„ä¾‹ã€‚é€™é‚ŠæŒ‡çš„ project åªæ˜¯ä¸€å€‹ terraform resource ç¯„åœï¼Œå¯ä»¥ä½†ä¸ç”¨æ˜¯ä¸€å€‹çœŸå¯¦çš„ gcp projectã€‚terraform åŸ·è¡Œæ˜¯ä»¥ä¸€å€‹ directory ç‚ºç¯„åœï¼Œä¸åŒ project directory å¯ä»¥é€éä¸åŒ terraform æŒ‡ä»¤æ§åˆ¶ã€‚å¦‚æœæ˜¯ç¨ç«‹çš„æœå‹™å¸Œæœ›ç¨ç«‹ç®¡ç†ä¹Ÿå¯ä»¥åˆ‡é–‹ã€‚\næˆ‘å¯«äº†ä¸€å€‹ç°¡å–®çš„ Makefileï¼Œé€²ä¸€æ­¥å°è£åŸºæœ¬çš„æŒ‡ä»¤ï¼ŒåŸºæœ¬ä¸Šä¸éœ€è¦ Makefile ä»¥å¤–çš„æ“ä½œã€‚ make project æ˜¯å…¶ä¸­ä¸€å€‹æŒ‡ä»¤ï¼Œå¹«å¿™å‰µå»ºè³‡æ–™å¤¾ã€å¸ƒç½® Makefile èˆ‡åŸºæœ¬çš„ terraform è¨­å®šç­‰ç­‰ã€‚\nå¦‚æœåœ˜éšŠæœ‰å¤šäººå”ä½œï¼Œéå¸¸æ¨è–¦ä½¿ç”¨çµ±ä¸€ Makefile / æˆ–æ˜¯ bash script å°è£ï¼Œçµ±ä¸€é€™äº›ç·¨è¼¯çš„é›œäº‹ï¼Œé™ä½ä¸åŒäººç·¨è¼¯å‡ºéŒ¯çš„é¢¨éšªã€‚\nç›®éŒ„çµæ§‹ ç¸½ä¹‹æˆ‘å€‘ç¾åœ¨ cd åˆ° my-new-project çš„å·¥ä½œç›®éŒ„ä¸‹ï¼Œé€™å€‹ç›®éŒ„ä»£è¡¨ä¸€å€‹å°ˆæ¡ˆã€‚å…¶ä»–çš„ gke-playgound èˆ‡ national-team-5g ä¹Ÿæ˜¯å…¶ä»–çš„å°ˆæ¡ˆï¼Œå…ˆå¿½ç•¥ä»–ã€‚\ngcp â”œâ”€â”€ README.md â”œâ”€â”€ Makefile â”œâ”€â”€ my-new-project/ â”œâ”€â”€ gke-playground/ â”œâ”€â”€ national-team-5g/ â”œâ”€â”€ templates/ â””â”€â”€ modules/ cd my-new-project é€²å…¥ my-new-project ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è£¡é¢å·²ç¶“æœ‰ä¸€äº›æª”æ¡ˆï¼Œæˆ‘å€‘é¦–å…ˆè¦ç·¨è¼¯çš„æ˜¯é€™å€‹ terraform.tf\nmy-new-project â”œâ”€â”€ Makefile â”œâ”€â”€ provider.tf â”œâ”€â”€ terraform.tf â””â”€â”€ variables.tf vim terraform.tf terraform.tf æ˜¯ terraform æœ¬èº«çš„è¨­å®š é€™é‚Šæ˜¯ Terraform Backend çš„è¨­å®šï¼Œå¦‚æœä¸çŸ¥é“ä»€éº¼æ˜¯ terraform backend é€™å€‹æˆ‘å€‘æ˜å¤©çš„æ–‡ç« æœƒè¬›ã€‚é€™é‚Šä½¿ç”¨çš„ backend æ˜¯ terraform å®˜æ–¹è‡ªå®¶çš„ terraform cloudï¼Œå¯ä»¥åœ¨ç¶²ç«™ä¸Š\nè¨»å†Šä½¿ç”¨è€…ï¼Œå¡«åˆ°åº•ä¸‹ organization é€™è£¡ å‰µå»ºä¸€å€‹ workspaceï¼Œå¡«åˆ° workspace.name é€™è£¡ terraform { # Create a remote organization on https://app.terraform.io backend \u0026#34;remote\u0026#34; { # Provide terraform credential by # - terraform login (suggested) # - use User API Token #token = \u0026#34;\u0026#34; hostname = \u0026#34;app.terraform.io\u0026#34; organization = \u0026#34;chechia\u0026#34; workspaces { name = \u0026#34;terraform-playground\u0026#34; } } } provider.tf æ˜¯ provider çš„è¨­å®š terraform client æœƒæŠŠ tf æª”æ¡ˆæ‹¿ä¾†é‹ç®—ï¼Œé€é Provider ï¼Œå°‡éœ€æ±‚å¯¦éš›è½‰åŒ–æˆ API call ï¼Œç„¶å¾Œé€åˆ°å…¬æœ‰é›²æˆ–æ˜¯å…¶ä»–ç›®æ¨™ã€‚é€™é‚Šå°±åªè¬›åˆ°é€™æ¨£ã€‚\nprovider ç‚ºäº†å·¥ä½œï¼Œå¯èƒ½æœƒéœ€è¦æä¾›ä¸€äº›åƒæ•¸ï¼Œä¾‹å¦‚ google çš„ provider æœƒéœ€è¦åœ¨é€™è£¡æä¾› credential_json çš„è·¯å¾‘ï¼Œè«‹æŠŠå®ƒæ”¾åœ¨é©åˆçš„åœ°æ–¹ï¼Œç„¶å¾Œç”¨çµ•å°è·¯å¾‘æŒ‡å‘ google\nNOTE: ä¸è¦ commit credential key åˆ° git repository è£¡é¢ã€‚å¯ä»¥æ”¾åˆ°å¤–å±¤è³‡æ–™å¤¾ï¼Œæˆ–è‡³å°‘è¦ gitignore æ‰ã€‚\nprovider \u0026#34;google\u0026#34; { version = \u0026#34;~\u0026gt;v3.25.0\u0026#34; credentials = file(var.credential_json) project = var.project region = var.region } variable.tf åšåƒæ•¸çš„å­˜æ”¾é» é›–ç„¶ä¸Šé¢ tf æª”æ¡ˆä½¿ç”¨äº† terraform / provider / variable ï¼Œä½† terraform æƒææª”æ¡ˆæ™‚ï¼Œæª”åæœ¬èº«ä¸¦ä¸æœƒå½±éŸ¿ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œåƒæ•¸ä½ æƒ³æ“ºå“ªå°±æ“ºå“ªã€‚ä¸éä¸Šé¢æ˜¯å¸¸è¦‹çš„å‘½åæ…£ä¾‹ï¼Œé€™æ¨£æ“ºäººé¡æ¯”è¼ƒå®¹æ˜“æ‰¾å¾—åˆ°ã€‚\nvariable é€™é‚Šè¨­å®šçš„åƒæ•¸ï¼Œæ¯”è¼ƒåƒæ˜¯ argumentsï¼Œä¹Ÿå°±æ˜¯ç•¶å…¶ä»–ä½ç½®çš„ tf æª”æ¡ˆï¼Œå¼•ç”¨é€™å€‹è³‡æ–™å¤¾ä½œç‚º module çš„æ™‚å€™ï¼Œä½œç‚ºåƒæ•¸è¼¸å…¥çš„ placeholderï¼Œå…¶ä»– tf æª”æ¡ˆå¯ä»¥ä½¿ç”¨ variable é—œéµå­—å®šç¾©çš„åƒæ•¸ï¼Œä¾‹å¦‚: var.projectï¼Œæˆ–æ˜¯ provider.tf è£¡çš„ var.credential_jsonã€‚\nvariable é—œéµå­—ä¹Ÿå¯ä»¥å®šç¾© default é è¨­å€¼ï¼Œå¦‚æœæ²’æœ‰å®šç¾© defaultï¼Œä¹Ÿæ²’æœ‰å¾å¤–éƒ¨å‚³å…¥ argumentï¼Œæœƒåœ¨ validate æ™‚é€ æˆ errorã€‚\n# Global variable \u0026#34;project\u0026#34; { type = string default = \u0026#34;myproject\u0026#34; } variable \u0026#34;credential_json\u0026#34; { type = string default = \u0026#34;../credentials/gke-playground-0423-aacf6a39cc3f.json\u0026#34; } variable \u0026#34;region\u0026#34; { type = string default = \u0026#34;asia-east1\u0026#34; } Create é€™è£¡æˆ‘å€‘è©¦è‘—å‰µå»ºä¸€å° GCEï¼Œä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼Œæœƒç™¼ç¾å¤šäº†ä¸€å€‹æª”æ¡ˆ compute_instance.tfã€‚\nNAME=my-new-gce make gce my-new-project â”œâ”€â”€ Makefile â”œâ”€â”€ compute_instance.tf â”œâ”€â”€ provider.tf â”œâ”€â”€ terraform.tf â””â”€â”€ variables.tf å…§å®¹å¤§æ¦‚æ˜¯\nmodule \u0026#34;my-new-gce\u0026#34; { source = \u0026#34;../modules/compute_instance\u0026#34; providers = { google = google } project = var.project name = \u0026#34;my-new-gce\u0026#34; image = \u0026#34;https://www.googleapis.com/compute/v1/projects/centos-cloud/global/images/centos-7-v20200429\u0026#34; machine_type = \u0026#34;n1-standard-1\u0026#34; network = \u0026#34;projects/${var.project}/global/networks/myproject\u0026#34; subnetwork = \u0026#34;projects/${var.project}/regions/asia-east1/subnetworks/myproject\u0026#34; } module é—œéµå­—å®šç¾©ä¸€çµ„è³‡æºï¼Œå…·é«”çš„å…§å®¹æ˜¯é€™è£¡ï¼Œç°¡å–®ä¾†èªªå¯ä»¥æŠŠä¸€å † tf æª”æ¡ˆæ”¾åœ¨ä¸€å¡Šï¼Œç„¶å¾ŒæŠŠéœ€è¦çš„åƒæ•¸ä½¿ç”¨ variable.tf æ‹‰å‡ºå»ï¼Œè®“å…¶ä»–åœ°æ–¹å¼•ç”¨ã€‚\nsource = \u0026#34;\u0026#34; æ˜¯å¯¦éš›å¼•ç”¨çš„ module ä¾†æº\nåº•ä¸‹æ˜¯é€™å€‹ module éœ€è¦ç”¨åˆ°çš„åƒæ•¸ï¼Œä¾‹å¦‚ project, name, image, machine_type,â€¦ ç­‰æ˜¯ gce é€™å€‹ module éœ€è¦çš„åƒæ•¸ã€‚\nMakefile NAME=my-new-gce make gce é€™è¡ŒæŒ‡ä»¤èˆ‡ terraform ç„¡é—œï¼Œåªæ˜¯ä¸€å€‹å¿«é€Ÿç”Ÿæˆ compute_instance.tf çš„å°è…³æœ¬ã€‚ä½¿ç”¨é€™å€‹è…³æœ¬å¯ä»¥\nå¿«é€Ÿç”¢ç”Ÿ tf æª”æ¡ˆ ç”¢ç”Ÿæ¨™æº–åŒ–çš„ tf æª”æ¡ˆï¼Œæ‰€æœ‰ project çš„ compute_instance éƒ½é•·ä¸€æ¨£ æŠ½æ›åå­ name ä½¿ç”¨ symbolic link è®“æ‰€æœ‰ project è³‡æ–™å¤¾ä½¿ç”¨åŒä¸€å€‹ Makefileï¼Œkeep your code DRYã€‚\næœ€å¾Œå°±æ˜¯å¸¸è¦çš„ plan èˆ‡ applyï¼Œé€™é‚Šæ²’æœ‰ä»€éº¼ç‰¹åˆ¥çš„ã€‚\nterraform plan terraform apply å°çµ æœ‰è¦å¾‹åœ°æ•´ç† project å¯ä»¥é™ä½ç¶­è­·æˆæœ¬ å–„ç”¨ module å°è£ï¼Œå¯ä»¥æé«˜æ•´é«”çš„é‡ç”¨æ€§èˆ‡æ˜“ç”¨å§“ï¼Œæé«˜é–‹ç™¼æ•ˆç‡ ä½¿ç”¨ template tf å¯ä»¥åŠ é€Ÿé‡è¤‡çš„è³‡æºç”¢ç”Ÿæ­¥é©Ÿ å•é¡Œ: æ­¤æ™‚çš„è³‡æ–™å¤¾ä¸­é‚„æ˜¯å……æ»¿å¤§é‡é‡è¤‡çš„ codeï¼Œä¾‹å¦‚åˆ°è™•éƒ½éœ€è¦ providerã€é‡è¤‡çš„ moduleï¼Œä¸€å¤§å †é‡è¤‡çš„æ±è¥¿ã€‚æœ‰æ²’æœ‰å¯èƒ½å†è®“æˆ‘å€‘çš„ç¨‹å¼ç¢¼æ›´ DRY ä¸€é»å‘¢?\nTerragrunt å¹«æˆ‘å€‘å¯¦ç¾é€™é»ï¼Œéå¸¸å€¼å¾—ä½¿ç”¨çš„å·¥å…·ã€‚è«‹è¦‹ä¸‹ç¯‡åˆ†äº«ã€‚\n","date":1601608548,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"ac35504a295f1db57a557e760dfaab0e","permalink":"https://chechia.net/zh-hant/post/2020-10-02-terraform-infrastructure-as-code-repository-example/","publishdate":"2020-10-02T11:15:48+08:00","relpermalink":"/zh-hant/post/2020-10-02-terraform-infrastructure-as-code-repository-example/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","éµäººè³½2020","iac"],"title":"Terraform Infrastructure as Code: Example repository","type":"post"},{"authors":[],"categories":null,"content":"å…ˆå è™›æ“¬æ©Ÿèˆ‡ Kubernetes åœ¨ GCP ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œæœƒéœ€è¦é¢å°å…ˆå è™›æ“¬æ©Ÿçš„é¡å¤–é™åˆ¶\nè³‡æ–™ä¸­å¿ƒæœƒ (å¯é æœŸæˆ–ä¸å¯é æœŸåœ°) çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿä¸èƒ½è‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒè¢«è³‡æ–™ä¸­å¿ƒçµ‚æ­¢å¾Œå›æ”¶ GCP ä¸ä¿è­‰æœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ ç¯€é»çš„çµ‚æ­¢æœƒé€ æˆé¡å¤–çš„ç¶­é‹æˆæœ¬ï¼Œä¾‹å¦‚\nç®¡ç†å¤šå€‹ç¯€é»ï¼Œå®¹å¿å…ˆå è™›æ“¬æ©Ÿçš„ç§»é™¤ï¼Œè‡ªå‹•è£œå……æ–°çš„å…ˆå è™›æ“¬æ©Ÿ ç®¡ç†å¤šå€‹æ‡‰ç”¨è¤‡æœ¬ï¼Œç¯€é»çµ‚æ­¢æ™‚ï¼Œç¶­è­·æ•´é«”æ‡‰ç”¨çš„å¯ç”¨æ€§ å°‡ç§»é™¤ç¯€é»ä¸Šçš„æ‡‰ç”¨ï¼Œé‡æ–°æ’ç¨‹åˆ°å…¶ä»–å¯ç”¨ç¯€é» å‹•æ…‹ç¶­è­·æ‡‰ç”¨è¤‡æœ¬çš„æœå‹™ç™¼ç¾ (Service Discovery) èˆ‡æœå‹™ç«¯é» (Endpoints) æ„æ€æ˜¯æ‡‰ç”¨é—œé–‰é‡å•Ÿå¾Œï¼Œæ›äº†ä¸€å€‹æ–° IPï¼Œé‚„è¦èƒ½æŒçºŒå­˜å–æ‡‰ç”¨ã€‚èˆŠçš„ IP è¦ä¸»å‹•å¤±æ•ˆ é…åˆæ‡‰ç”¨çš„å¥åº·æª¢æŸ¥ (Health Check) èˆ‡å¯ç”¨æª¢æŸ¥ (Readiness Check)ï¼Œå†åˆ†é…ç¶²è·¯æµé‡ é€™äº›éœ€æ±‚ï¼Œå¿…é ˆè¦æœ‰è‡ªå‹•åŒ–çš„ç®¡ç†å·¥å…·ï¼Œæ˜¯ä¸å¯èƒ½äººå·¥ç®¡ç†çš„ï¼Œæƒ³åƒä½ æ‰‹ä¸Šä½¿ç”¨ 100 å€‹å…ˆå ç¯€é»ï¼Œå¹³å‡æ¯å¤©æœƒæœ‰ 10% - 15% çš„å…ˆå ç¯€é»è¢«è³‡æ–™ä¸­å¿ƒå›æ”¶ï¼Œç¶­é‹éœ€è¦\nè£œè¶³è¢«ç§»é™¤çš„ 15 å€‹ç¯€é» è¨ˆç®—è¢«ç§»é™¤çš„æ‡‰ç”¨ï¼Œè£œè¶³ç§»é™¤çš„æ‡‰ç”¨æ•¸é‡ ç§»é™¤å¤±æ•ˆçš„æ‡‰ç”¨ç«¯é»ï¼Œè£œä¸Šæ–°çš„æ‡‰ç”¨ç«¯é» æŒçºŒç›£æ§æ‡‰ç”¨ç‹€æ…‹ â€¦ æ²’æœ‰è‡ªå‹•åŒ–ç®¡ç†å·¥å…·ï¼Œçœ‹äº†å¿ƒå·²ç´¯ (è²“çˆªæ©é¢)\næˆ‘å€‘ä½¿ç”¨ Kubernetes å”åŠ©ç¶­é‹è‡ªå‹•åŒ–ï¼Œåœ¨ GCP ä¸Šæˆ‘å€‘ä½¿ç”¨ GKEï¼Œé™¤äº†ä¸Šè¿°æåˆ°çš„å®¹å™¨æ‡‰ç”¨ç®¡ç†è‡ªå‹•åŒ–å¤–ï¼ŒGKE é‚„é¡å¤–æ•´åˆå…ˆå è™›æ“¬æ©Ÿçš„ä½¿ç”¨\nå•Ÿç”¨å…ˆå è™›æ“¬æ©Ÿçš„ç¯€é»æ±  (node-pool)ï¼Œè¨­å®šç¯€é»æ± çš„è‡ªå‹•æ‹“å±•ï¼Œè‡ªå‹•è£œè¶³å…ˆå ç¯€é»çš„æ•¸é‡ GKE è‡ªå‹•ç¶­è­·å…ˆå è™›æ“¬æ©Ÿçš„ labels é—œæ–¼ GKE çš„å…ˆå è™›æ“¬æ©Ÿçš„å®Œæ•´ç´°ç¯€ï¼Œè«‹è¦‹GCP å®˜æ–¹æ–‡ä»¶ã€‚é€™ä»½æ–‡ä»¶åº•ä¸‹ä¹Ÿæä¾›äº† GCP å®˜æ–¹å»ºè­°çš„å…ˆå è™›æ“¬æ©Ÿæœ€ä½³å¯¦è¸\næ¶æ§‹è¨­è¨ˆéœ€è¦å‡è¨­ï¼Œéƒ¨åˆ†æˆ–æ˜¯å…¨éƒ¨çš„å…ˆå è™›æ“¬æ©Ÿéƒ½ä¸å¯ç”¨çš„æƒ…å½¢ Pod ä¸ä¸€å®šæœ‰æ™‚é–“èƒ½å„ªé›…çµ‚æ­¢ (graceful shutdown) åŒæ™‚ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿèˆ‡å…ˆå è™›æ“¬æ©Ÿï¼Œä»¥ç¶­æŒå…ˆå è™›æ“¬æ©Ÿä¸å¯ç”¨æ™‚ï¼Œæœå‹™ä¾ç„¶å¯ç”¨ æ³¨æ„ç¯€é»æ›¿æ›æ™‚çš„ IP è®Šæ›´ é¿å…ä½¿ç”¨æœ‰ç‹€æ…‹çš„ Pod åœ¨å…ˆå è™›æ“¬æ©Ÿä¸Š (é€™é»ç¨å¾Œçš„æ–‡ç« ï¼Œæˆ‘å€‘æœƒè©¦åœ–è¶…è¶Š) ä½¿ç”¨ node taint ä¾†å”åŠ©æ’ç¨‹åˆ°å…ˆå è™›æ“¬æ©Ÿï¼Œèˆ‡éå…ˆå è™›æ“¬æ©Ÿ ç¸½ä¹‹ï¼Œç”±æ–¼æœ‰å®¹å™¨è‡ªå‹•åŒ–ç®¡ç†ï¼Œæˆ‘å€‘æ‰èƒ½è¼•æ˜“çš„ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿã€‚\nGKE ç„¶è€Œï¼Œæ±ºå®šä½¿ç”¨ GKE å¾Œï¼Œå°±æœ‰è¨±å¤šé—œæ–¼æˆæœ¬çš„äº‹æƒ…éœ€è¦è¨è«–\nå…ˆçœ‹ GKE çš„è¨ˆè²»æ–¹å¼ pricing\næ¯å€‹ GKE é›†ç¾¤ç®¡ç†è²»ç”¨ $0.1/hr = $72/hr é€™å€‹è²»ç”¨æ˜¯å›ºå®šæ”¶è²»ï¼Œåªè¦é–‹ä¸€å€‹é›†ç¾¤ï¼Œä¸è«–é›†ç¾¤çš„ç¯€é»æ•¸é‡ã€‚æ‰€ä»¥åœ¨ç¯€é»å¤šã€ç®—åŠ›å¤§çš„é›†ç¾¤è£¡ï¼Œé€™å€‹è²»ç”¨æœƒè¢«ç¨€é‡‹ï¼Œä½†åœ¨ç¯€é»å°‘çš„é›†ç¾¤è£¡æ¯”ä¾‹æœƒè¢«æ”¾å¤§ã€‚\nç„¶å¾Œ GKE é‚„æ˜¯æœƒæœ‰ä¸€äº›è‡ªå·±çš„æ¯›ï¼Œä¿—è©±èªªæœ‰ä¸€å¥½æ²’å…©å¥½ï¼Œæˆ‘å€‘ä½¿ç”¨å®ƒçš„å¥½è™•åŒæ™‚ï¼Œä¹Ÿè¦æ³¨æ„è¨±å¤šçœ‰çœ‰è§’è§’ã€‚å†ä¾†çˆ¬æ–‡ä»¶ã€‚å¦‚åŒæœ€å‰é¢å®£å°ï¼Œç”¨ç”¢å“å°±è¦ä¹–ä¹–æŠŠæ–‡ä»¶çœ‹å®Œï¼Œä¸éé€™è£¡å…ˆé‡å°èˆ‡å…ˆå è™›æ“¬æ©Ÿç›¸é—œçš„è­°é¡Œ\nAllocatable Resource Regional Cluster Cluster autoscaler Allocatable Resource åœ¨ç¶²è·¯ä¸Šçœ‹åˆ°é€™ç¯‡å¥½æ–‡ GKE ä¸Šçš„å¯ä½¿ç”¨çš„è³‡æº Allocatable Resourceã€‚å•¥æ„æ€å‘¢ï¼Ÿé›£é“é‚„æœ‰ä¸èƒ½ä½¿ç”¨çš„è³‡æºå—ï¼Ÿ\næ²’éŒ¯ï¼ŒGKE æœƒä¿ç•™ä¸€å®šçš„æ©Ÿå™¨è³‡æº (e.g. cpu, memory, disk)ï¼Œä¾†ç¶­æŒç¯€é»çš„ç®¡ç†å…ƒä»¶ï¼Œä¾‹å¦‚ container runtime (e.g. Docker)ã€kubeletã€cAdvisorã€‚\nä¹Ÿå°±æ˜¯èªªï¼Œå°±ç®—æˆ‘å€‘è·Ÿ GCP è³¼è²·äº†ç®—åŠ›ï¼Œæœ‰ä¸€å€‹æ¯”ä¾‹çš„è³‡æºæˆ‘å€‘æ˜¯ä½¿ç”¨ä¸åˆ°çš„ã€‚ç´°ç¯€è«‹è¦‹ ç†è§£ GKE é›†ç¾¤æ¶æ§‹ã€‚é€™æœƒå½±éŸ¿æˆ‘å€‘å–®ä¸€ç¯€é»çš„è¦æ ¼ï¼Œæˆ‘å€‘ä¹Ÿéœ€è¦ä¸€ä¸¦è¨ˆç®—ï¼Œèƒ½å¯¦éš›ä½¿ç”¨çš„è³‡æº (allocatable resource)ã€‚\nAllocatable = Capacity - Reserved - Eviction Threshold\nCapacityï¼Œæ˜¯æ©Ÿå™¨ä¸Šå¯¦éš›è£è¼‰çš„è³‡æºï¼Œä¾‹å¦‚ n1-standard-4 æä¾› 4 cpu 15 Gb memory Reservedï¼Œå…¬æœ‰é›²ä»£ç®¡é›†ç¾¤ï¼Œé ä¿ç•™çš„è³‡æº Eviction Thresholdï¼šKubernetes è¨­å®šçš„ kubelet é©…é€é–€æª» é©…é€é–€æª» (Eviction threshold) Kubelet æœƒä¸»å‹•ç›£æ¸¬ç¯€é»ä¸Šçš„è³‡æºä½¿ç”¨ç‹€æ³ï¼Œç•¶ç¯€é»ç™¼ç”Ÿè³‡æºä¸è¶³çš„ç‹€æ³æ™‚ï¼Œkubelet æœƒä¸»å‹•çµ‚æ­¢æŸäº› Pod çš„é‹è¡Œï¼Œä¸¦å›æ”¶ç¯€é»çš„è³‡æºï¼Œä¾†é¿å…æ•´å€‹ç¯€é»è³‡æºä¸è¶³å°è‡´çš„ç³»çµ±ä¸ç©©å®šã€‚è¢«çµ‚æ­¢çš„ Pod å¯ä»¥å†æ¬¡æ’ç¨‹åˆ°å…¶ä»–è³‡æºè¶³å¤ çš„ç¯€é»ä¸Šã€‚ç´°ç¯€è«‹è¦‹ å®˜æ–¹æ–‡ä»¶ Scheduling and Eviction\nåœ¨ Kubernetes ä¸Šï¼Œæˆ‘å€‘å¯ä»¥é€²ä¸€æ­¥è¨­å®šé©…é€é–€æª»ï¼Œç•¶ç¯€é»çš„å¯ç”¨è³‡æºä½æ–¼é©…é€çš„é–€æª»ï¼Œkubelet æœƒè§¸ç™¼ Pod é©…é€æ©Ÿåˆ¶\nGKE ä¸Šæ¯å€‹ç¯€é»æœƒé¡å¤–ä¿ç•™ 100 MiB çš„è¨˜æ†¶é«”ï¼Œä½œç‚ºé©…é€é–€æª»ï¼Œæ„æ€æ˜¯ç•¶ç¯€é»è€—ç›¡è³‡æºï¼Œå°è‡´å‰©é¤˜è¨˜æ†¶é«”ä½æ–¼ 100 MiB çš„æ™‚å€™ï¼Œæœƒç›´æ¥è§¸ç™¼ GKE çš„ Pod Evictionï¼Œçµ‚æ­¢ä¸¦å›æ”¶éƒ¨åˆ†çš„ Podã€‚æ›å¥è©±èªªï¼Œé€™ 100 MiB æ˜¯ä¸èƒ½è¢«ä½¿ç”¨çš„è³‡æºã€‚ç´°ç¯€è«‹è¦‹å®˜æ–¹æ–‡ä»¶\né›†ç¾¤ä¿ç•™è³‡æºç²¾ç®— è³‡æºçš„å®šç¾©ï¼Œä½¿ç”¨é›²å¹³å°çš„ä¸€èˆ¬è²»ç”¨å¤§å¤šä¾†è‡ªæ­¤\ncpu memory storage ç„¶å¾Œæ˜¯é€™å€‹è¡¨ï¼Œæ³¨æ„ä¿ç•™çš„è³‡æºæ˜¯ç´¯é€²ç´šè·\n255 MiB of memory for machines with less than 1 GB of memory 25% of the first 4GB of memory 20% of the next 4GB of memory (up to 8GB) 10% of the next 8GB of memory (up to 16GB) 6% of the next 112GB of memory (up to 128GB) 2% of any memory above 128GB\nå€¼è¨ˆä¸Šèƒ½å¤ ç”¨åˆ°çš„è³‡æºï¼Œåº•ä¸‹ GCP ä¹Ÿæ•´ç†å¥½äº†ï¼Œä¾‹å¦‚ n1-standard-4 å¯¦éš›ä½¿ç”¨çš„æ˜¯ memory 12.3/15ï¼Œcpu 3.92/4ã€‚\nåœ¨ç¶­æŒåˆç†çš„ä½¿ç”¨ç‡ä¸‹ï¼Œé–‹å•Ÿå¤§çš„æ©Ÿå™¨ï¼Œå¯ä»¥é™ä½è¢«ä¿ç•™çš„è³‡æºæ¯”ä¾‹ï¼Œä¾ç…§ç­†è€…å…¬å¸éå»ç¶“é©—ï¼ŒGKE èµ·è·³å°±æ˜¯ n1-standard-4 æˆ–æ˜¯ä»¥ä¸Šè¦æ ¼ï¼Œå¦‚æœä½æ–¼é€™å€‹è¦æ ¼ï¼Œå¯èª¿åº¦çš„è³‡æºæ¯”ä¾‹çœŸçš„å¤ªä½ï¼Œæ‡‰è©²é‡æ–°è€ƒæ…®ä¸€ä¸‹é€™å€‹è§£æ±ºæ–¹æ¡ˆæ˜¯å¦åˆä¹æˆæœ¬ã€‚\nä½†ç©¶ç«Ÿä»€éº¼è¦æ ¼çš„æ©Ÿå™¨é©åˆæˆ‘å€‘çš„éœ€æ±‚ï¼Œèªªå¯¦åœ¨å®Œå…¨è¦çœ‹åŸ·è¡Œçš„æ‡‰ç”¨è€Œå®šã€‚\n","date":1601112260,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"650c28bef3fe40dc9d01be07c20dfe80","permalink":"https://chechia.net/zh-hant/post/2020-09-26-gcp-preemptible-instance-kubernetes/","publishdate":"2020-09-26T17:24:20+08:00","relpermalink":"/zh-hant/post/2020-09-26-gcp-preemptible-instance-kubernetes/","section":"post","summary":"å…ˆå è™›æ“¬æ©Ÿèˆ‡ Kubernetes åœ¨ GCP ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œæœƒéœ€è¦é¢å°å…ˆå è™›æ“¬æ©Ÿçš„é¡å¤–é™åˆ¶\nè³‡æ–™ä¸­å¿ƒæœƒ (å¯é æœŸæˆ–ä¸å¯é æœŸåœ°) çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿä¸èƒ½è‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒè¢«è³‡æ–™ä¸­å¿ƒçµ‚æ­¢å¾Œå›æ”¶ GCP ä¸ä¿è­‰æœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ ç¯€é»çš„çµ‚æ­¢æœƒé€ æˆé¡å¤–çš„ç¶­é‹æˆæœ¬ï¼Œä¾‹å¦‚\nç®¡ç†å¤šå€‹ç¯€é»ï¼Œå®¹å¿å…ˆå è™›æ“¬æ©Ÿçš„ç§»é™¤ï¼Œè‡ªå‹•è£œå……æ–°çš„å…ˆå è™›æ“¬æ©Ÿ ç®¡ç†å¤šå€‹æ‡‰ç”¨è¤‡æœ¬ï¼Œç¯€é»çµ‚æ­¢æ™‚ï¼Œç¶­è­·æ•´é«”æ‡‰ç”¨çš„å¯ç”¨æ€§ å°‡ç§»é™¤ç¯€é»ä¸Šçš„æ‡‰ç”¨ï¼Œé‡æ–°æ’ç¨‹åˆ°å…¶ä»–å¯ç”¨ç¯€é» å‹•æ…‹ç¶­è­·æ‡‰ç”¨è¤‡æœ¬çš„æœå‹™ç™¼ç¾ (Service Discovery) èˆ‡æœå‹™ç«¯é» (Endpoints) æ„æ€æ˜¯æ‡‰ç”¨é—œé–‰é‡å•Ÿå¾Œï¼Œæ›äº†ä¸€å€‹æ–° IPï¼Œé‚„è¦èƒ½æŒçºŒå­˜å–æ‡‰ç”¨ã€‚èˆŠçš„ IP è¦ä¸»å‹•å¤±æ•ˆ é…åˆæ‡‰ç”¨çš„å¥åº·æª¢æŸ¥ (Health Check) èˆ‡å¯ç”¨æª¢æŸ¥ (Readiness Check)ï¼Œå†åˆ†é…ç¶²è·¯æµé‡ é€™äº›éœ€æ±‚ï¼Œå¿…é ˆè¦æœ‰è‡ªå‹•åŒ–çš„ç®¡ç†å·¥å…·ï¼Œæ˜¯ä¸å¯èƒ½äººå·¥ç®¡ç†çš„ï¼Œæƒ³åƒä½ æ‰‹ä¸Šä½¿ç”¨ 100 å€‹å…ˆå ç¯€é»ï¼Œå¹³å‡æ¯å¤©æœƒæœ‰ 10% - 15% çš„å…ˆå ç¯€é»è¢«è³‡æ–™ä¸­å¿ƒå›æ”¶ï¼Œç¶­é‹éœ€è¦","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance Kubernetes","type":"post"},{"authors":[],"categories":null,"content":"å…ˆå è™›æ“¬æ©Ÿï¼ŒæŠ€è¡“æ–‡ä»¶äºŒä¸‰äº‹ ç¬¬ä¸€ç¯‡çš„å…§å®¹å¤§éƒ¨ä»½é‚„æ˜¯ç¿»è­¯è·Ÿè¬›è§£å®˜æ–¹æ–‡ä»¶ã€‚å¾Œé¢å¹¾ç¯‡æ‰æœƒæœ‰å¯¦éš›çš„éœ€æ±‚èˆ‡è§£æ±ºæ–¹æ¡ˆåˆ†æã€‚\nGoogle å…ˆå è™›æ“¬æ©Ÿå®˜æ–¹æ–‡ä»¶\nä½¿ç”¨ä¸ç†Ÿæ‚‰çš„ç”¢å“å‰ä¸€å®šè¦å¥½å¥½çœ‹æ–‡ä»¶ï¼Œæ‰ä¸æœƒè¸©åˆ°é›·çš„æ™‚å€™ï¼Œç™¼ç¾äººå®¶å°±æ˜¯é€™æ¨£è¨­è¨ˆçš„ï¼Œè€Œä¸”æ–‡ä»¶ä¸Šå¯«å¾—æ¸…æ¸…æ¥šæ¥šã€‚ä»¥ç‚ºæ˜¯ bug çµæœçœŸçš„æ˜¯ featureï¼Œé›·åˆ°è‡ªå·±ã€‚å…ˆå è™›æ“¬æ©Ÿæ˜¯ç”¨èµ·ä¾†è·Ÿæ™®é€šè™›æ“¬æ©Ÿæ²’ä»€éº¼å…©æ¨£ï¼Œä½†å¯¦éš›ä¸Šè¶…ç´šå¤šç´°ç¯€è¦æ³¨æ„ï¼Œæ¯›å¾ˆå¤šçš„ç”¢å“ï¼Œè«‹å‹™å¿…è¦å°å¿ƒä½¿ç”¨ã€‚\nä»¥ä¸‹æ–‡ç« æ˜¯ç­†è€…å·¥ä½œç¶“é©—ï¼Œè¦ºå¾—å¥½ç”¨ã€ç¢ºå¯¦æœ‰å¹«åŠ©å…¬å¸ï¼Œä¾†è·Ÿå¤§å®¶åˆ†äº«ã€‚ç¤™æ–¼ç¯‡å¹…ï¼Œé€™è£¡åªèƒ½éå¸¸ç²—ç•¥åœ°æè¿°æˆ‘å€‘åœ˜éšŠæ€è€ƒéçš„å•é¡Œï¼Œå¯¦éš›ä¸Šçš„å•é¡Œæœƒè¤‡é›œéå¸¸å¤šã€‚æ–‡ç« åªæ˜¯ä½œå€‹ç™¼æƒ³ï¼Œä¸¦ä¸è¶³ä»¥æ”¯æ’å¯¦éš›çš„æ¥­å‹™ï¼Œæ‰€ä»¥å¦‚æœè¦è€ƒæ…®å°å…¥ï¼Œé‚„æ˜¯è¦\nå¤šä½œåŠŸèª²ï¼Œä»”ç´°æŸ¥é–±å®˜æ–¹æ–‡ä»¶ï¼Œç†è§£æœå‹™çš„è¦æ ¼ æ·±å…¥åˆ†æè‡ªèº«çš„éœ€æ±‚ åŸºæ–¼ä¸Šé¢å…©è€…ï¼Œé‡åŒ–åˆ†æ ä»€éº¼æ˜¯å…ˆå è™›æ“¬æ©Ÿå™¨(Preemptible Instance) å…ˆå è™›æ“¬æ©Ÿå™¨ï¼Œæ˜¯è³‡æ–™ä¸­å¿ƒçš„å¤šé¤˜ç®—åŠ›ï¼Œè®€è€…å¯ä»¥æƒ³åƒæ˜¯ç›®å‰è³£å‰©çš„æ©Ÿå™¨ï¼Œæœƒä¾æ“šè³‡æ–™ä¸­å¿ƒçš„éœ€æ±‚å‹•æ…‹èª¿æ•´ï¼Œä¾‹å¦‚\nç›®å‰è³‡æ–™ä¸­å¿ƒçš„ç®—åŠ›éœ€æ±‚ä½ï¼Œå¯ä½¿ç”¨çš„å…ˆå è™›æ“¬æ©Ÿé‡‹å‡ºé‡å¤šï¼Œå¯èƒ½å¯ä»¥ç”¨æ›´ä¾¿å®œçš„åƒ¹æ ¼ä½¿ç”¨ ç›®å‰è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚é«˜ï¼Œè³‡æ–™ä¸­å¿ƒæœƒæ”¶å›éƒ¨åˆ†å…ˆå è™›æ“¬æ©Ÿçš„é¡åº¦ï¼Œè½‰åŒ–æˆéš¨é¸ä»˜è²»çš„è™›æ“¬æ©Ÿ (pay-as-you-go) ç”±æ–¼å…ˆå è™›æ“¬æ©Ÿæœƒä¸å®šæ™‚ï¼ˆä½†å¯é æœŸï¼‰åœ°è¢«è³‡æ–™ä¸­å¿ƒæ”¶å›ï¼Œå› æ­¤ä¸Šé ­åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œéœ€è¦å¯ä»¥æ‰¿å—æ©Ÿå™¨çš„çµ‚æ­¢ï¼Œé©åˆæœ‰å®¹éŒ¯æ©Ÿåˆ¶ (fault-tolerant) çš„æ‡‰ç”¨ï¼Œæˆ–æ˜¯æ‰¹æ¬¡åŸ·è¡Œçš„å·¥ä½œä¹Ÿå¾ˆé©åˆã€‚\nå…ˆå æ©Ÿå™¨çš„å„ªç¼ºé» é™¤äº†æœ‰ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿçš„ç‰¹æ€§ï¼Œå…ˆå è™›æ“¬æ©Ÿé‚„æœ‰ä»¥ä¸‹ç‰¹é»\næ¯”ä¸€èˆ¬çš„è™›æ“¬æ©Ÿå™¨ä¾¿å®œéå¸¸å¤šï¼Œé€™ä¹Ÿæ˜¯æˆ‘å€‘é¸ç”¨å…ˆå è™›æ“¬æ©Ÿå„ªæ–¼ä¸€èˆ¬è™›æ“¬æ©Ÿçš„å”¯ä¸€ç†ç”± å…ˆå è™›æ“¬æ©Ÿæœ‰ä»¥ä¸‹é™åˆ¶ï¼Œä»¥ç¶­é‹çš„è§’åº¦ï¼Œé€™äº›éƒ½æ˜¯éœ€è¦è€ƒé‡çš„é»ã€‚\nGCP ä¸ä¿è­‰æœƒæœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿä¸èƒ½ç›´æ¥è½‰æ›æˆæ™®é€šè™›æ“¬æ©Ÿ è³‡æ–™ä¸­å¿ƒè§¸ç™¼ç¶­è­·äº‹ä»¶æ™‚(ex. å›æ”¶å…ˆå è™›æ“¬æ©Ÿ)ï¼Œå…ˆå è™›æ“¬æ©Ÿä¸èƒ½è¨­å®šè‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒç›´æ¥é—œé–‰ å…ˆå æ©Ÿå™¨æ’é™¤åœ¨ GCP çš„æœå‹™ç­‰ç´šå”è­° (SLA)ä¹‹å¤– å…ˆå è™›æ“¬æ©Ÿä¸é©ç”¨GCP å…è²»é¡åº¦ è²»ç”¨ç²—ä¼°è©¦ç®— è‡³æ–¼ä¾¿å®œæ˜¯å¤šä¾¿å®œå‘¢ï¼Ÿé€™é‚Šå…ˆé–‹å¹¾å€‹ä¾‹å­çµ¦å„ä½ä¸€äº›æ¦‚å¿µã€‚\nä»¥å¸¸ç”¨çš„ N1 standard è™›æ“¬æ©Ÿï¼šhttps://cloud.google.com/compute/vm-instance-pricing#n1_standard_machine_types\nHourly Machine type\tCPUs\tMemory\tPrice (USD)\tPreemptible price (USD) n1-standard-1\t1\t3.75GB\t$0.0550\t$0.0110 n1-standard-2\t2\t7.5GB\t$0.1100\t$0.0220 n1-standard-4\t4\t15GB\t$0.2200\t$0.0440 n1-standard-8\t8\t30GB\t$0.4400\t$0.0880 n1-standard-16\t16\t60GB\t$0.8800\t$0.1760 n1-standard-32\t32\t120GB\t$1.7600\t$0.3520 n1-standard-64\t64\t240GB\t$3.5200\t$0.7040\nå¦‚æœæ˜¯ç”¨ GPU é‹ç®—ï¼šhttps://cloud.google.com/compute/gpus-pricing\nModel\tGPUs\tGPU memory\tGPU price (USD)\tPreemptible GPU price (USD) NVIDIAÂ® TeslaÂ® T4\t1 GPU\t16 GB GDDR6\t$0.35 per GPU\t$0.11 per GPU NVIDIAÂ® TeslaÂ® V100\t1 GPU\t16 GB HBM2\t$2.48 per GPU\t$0.74 per GPU\nä¾æ“šè™›æ“¬æ©Ÿè¦æ ¼çš„ä¸åŒï¼Œå…ˆå è™›æ“¬æ©Ÿå¤§ç´„æ˜¯éš¨é¸è™›æ“¬æ©Ÿåƒ¹æ ¼çš„ 2 åˆ° 3 æŠ˜ã€‚åœ¨ AWS èˆ‡ Azureï¼Œç”±æ–¼è¨ˆè²»æ–¹å¼ä¸åŒï¼Œæœ‰å¯èƒ½æ‹¿åˆ° 1 æŠ˜å·¦å³çš„æµ®å‹•åƒ¹æ ¼ã€‚å¾å„ç¨®è§’åº¦ä¾†èªªï¼Œéƒ½æ˜¯éå¸¸é«˜çš„æŠ˜æ•¸ã€‚\nä¸å¦¨èªªï¼Œé€™æ•´ç³»åˆ—æ–‡ç« ï¼Œéƒ½æ˜¯è¡é€™è‘—å€‹æŠ˜æ•¸ä¾†çš„ XDã€‚ç•¢ç«Ÿæˆæœ¬æ˜¯å¯¦å¯¦åœ¨åœ¨çš„èŠ±è²»ï¼Œå·¥ä½œè² è¼‰ (workload) åˆé©çš„è©±ï¼Œæ‡‰è©²ç›¡é‡å˜—è©¦å°å…¥ã€‚\né€™å€‹æŠ˜æ•¸é‚„æœ‰å¦å¤–ä¸€å€‹æ•ˆæœæ˜¯ï¼Œå¯ä»¥åœ¨ç›¸åŒæˆæœ¬ä¸‹ï¼Œæ·»å¢æ›´å¤šè³‡æºç®—åŠ›ï¼Œä½œç‚ºè§£æ±ºæ–¹æ¡ˆã€‚ä»€éº¼æ„æ€å‘¢ï¼Ÿå°±æ˜¯å¦‚æœå·¥ä½œè² è¼‰åˆé©çš„è©±ï¼Œå¯ä»¥ä½¿ç”¨æ›´é«˜è¦æ ¼çš„å…ˆå ç¯€é»ï¼Œæ•´é«”æˆæœ¬åè€Œæœƒä¸‹é™ã€‚\nè‡³æ–¼ç©¶ç«Ÿå·®å¤šå°‘ï¼Œéœ€è¦ä¾æ“šè¦æ ¼èˆ‡å®šåƒ¹è©³ç´°è©¦ç®—æ‰çŸ¥é“ã€‚åº•ä¸‹æˆ‘å€‘å°±ä¾†ç®—ç®—çœ‹ã€‚\n","date":1601089420,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"7a2edcde9c17465b24dde23d7621e8c5","permalink":"https://chechia.net/zh-hant/post/2020-09-26-gcp-preemptible-instance-introduction/","publishdate":"2020-09-26T11:03:40+08:00","relpermalink":"/zh-hant/post/2020-09-26-gcp-preemptible-instance-introduction/","section":"post","summary":"å…ˆå è™›æ“¬æ©Ÿï¼ŒæŠ€è¡“æ–‡ä»¶äºŒä¸‰äº‹ ç¬¬ä¸€ç¯‡çš„å…§å®¹å¤§éƒ¨ä»½é‚„æ˜¯ç¿»è­¯è·Ÿè¬›è§£å®˜æ–¹æ–‡ä»¶ã€‚å¾Œé¢å¹¾ç¯‡æ‰æœƒæœ‰å¯¦éš›çš„éœ€æ±‚èˆ‡è§£æ±ºæ–¹æ¡ˆåˆ†æã€‚\nGoogle å…ˆå è™›æ“¬æ©Ÿå®˜æ–¹æ–‡ä»¶\nä½¿ç”¨ä¸ç†Ÿæ‚‰çš„ç”¢å“å‰ä¸€å®šè¦å¥½å¥½çœ‹æ–‡ä»¶ï¼Œæ‰ä¸æœƒè¸©åˆ°é›·çš„æ™‚å€™ï¼Œç™¼ç¾äººå®¶å°±æ˜¯é€™æ¨£è¨­è¨ˆçš„ï¼Œè€Œä¸”æ–‡ä»¶ä¸Šå¯«å¾—æ¸…æ¸…æ¥šæ¥šã€‚ä»¥ç‚ºæ˜¯ bug çµæœçœŸçš„æ˜¯ featureï¼Œé›·åˆ°è‡ªå·±ã€‚å…ˆå è™›æ“¬æ©Ÿæ˜¯ç”¨èµ·ä¾†è·Ÿæ™®é€šè™›æ“¬æ©Ÿæ²’ä»€éº¼å…©æ¨£ï¼Œä½†å¯¦éš›ä¸Šè¶…ç´šå¤šç´°ç¯€è¦æ³¨æ„ï¼Œæ¯›å¾ˆå¤šçš„ç”¢å“ï¼Œè«‹å‹™å¿…è¦å°å¿ƒä½¿ç”¨ã€‚\nä»¥ä¸‹æ–‡ç« æ˜¯ç­†è€…å·¥ä½œç¶“é©—ï¼Œè¦ºå¾—å¥½ç”¨ã€ç¢ºå¯¦æœ‰å¹«åŠ©å…¬å¸ï¼Œä¾†è·Ÿå¤§å®¶åˆ†äº«ã€‚ç¤™æ–¼ç¯‡å¹…ï¼Œé€™è£¡åªèƒ½éå¸¸ç²—ç•¥åœ°æè¿°æˆ‘å€‘åœ˜éšŠæ€è€ƒéçš„å•é¡Œï¼Œå¯¦éš›ä¸Šçš„å•é¡Œæœƒè¤‡é›œéå¸¸å¤šã€‚æ–‡ç« åªæ˜¯ä½œå€‹ç™¼æƒ³ï¼Œä¸¦ä¸è¶³ä»¥æ”¯æ’å¯¦éš›çš„æ¥­å‹™ï¼Œæ‰€ä»¥å¦‚æœè¦è€ƒæ…®å°å…¥ï¼Œé‚„æ˜¯è¦\nå¤šä½œåŠŸèª²ï¼Œä»”ç´°æŸ¥é–±å®˜æ–¹æ–‡ä»¶ï¼Œç†è§£æœå‹™çš„è¦æ ¼ æ·±å…¥åˆ†æè‡ªèº«çš„éœ€æ±‚ åŸºæ–¼ä¸Šé¢å…©è€…ï¼Œé‡åŒ–åˆ†æ ä»€éº¼æ˜¯å…ˆå è™›æ“¬æ©Ÿå™¨(Preemptible Instance) å…ˆå è™›æ“¬æ©Ÿå™¨ï¼Œæ˜¯è³‡æ–™ä¸­å¿ƒçš„å¤šé¤˜ç®—åŠ›ï¼Œè®€è€…å¯ä»¥æƒ³åƒæ˜¯ç›®å‰è³£å‰©çš„æ©Ÿå™¨ï¼Œæœƒä¾æ“šè³‡æ–™ä¸­å¿ƒçš„éœ€æ±‚å‹•æ…‹èª¿æ•´ï¼Œä¾‹å¦‚\nç›®å‰è³‡æ–™ä¸­å¿ƒçš„ç®—åŠ›éœ€æ±‚ä½ï¼Œå¯ä½¿ç”¨çš„å…ˆå è™›æ“¬æ©Ÿé‡‹å‡ºé‡å¤šï¼Œå¯èƒ½å¯ä»¥ç”¨æ›´ä¾¿å®œçš„åƒ¹æ ¼ä½¿ç”¨ ç›®å‰è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚é«˜ï¼Œè³‡æ–™ä¸­å¿ƒæœƒæ”¶å›éƒ¨åˆ†å…ˆå è™›æ“¬æ©Ÿçš„é¡åº¦ï¼Œè½‰åŒ–æˆéš¨é¸ä»˜è²»çš„è™›æ“¬æ©Ÿ (pay-as-you-go) ç”±æ–¼å…ˆå è™›æ“¬æ©Ÿæœƒä¸å®šæ™‚ï¼ˆä½†å¯é æœŸï¼‰åœ°è¢«è³‡æ–™ä¸­å¿ƒæ”¶å›ï¼Œå› æ­¤ä¸Šé ­åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œéœ€è¦å¯ä»¥æ‰¿å—æ©Ÿå™¨çš„çµ‚æ­¢ï¼Œé©åˆæœ‰å®¹éŒ¯æ©Ÿåˆ¶ (fault-tolerant) çš„æ‡‰ç”¨ï¼Œæˆ–æ˜¯æ‰¹æ¬¡åŸ·è¡Œçš„å·¥ä½œä¹Ÿå¾ˆé©åˆã€‚\nå…ˆå æ©Ÿå™¨çš„å„ªç¼ºé» é™¤äº†æœ‰ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿçš„ç‰¹æ€§ï¼Œå…ˆå è™›æ“¬æ©Ÿé‚„æœ‰ä»¥ä¸‹ç‰¹é»\næ¯”ä¸€èˆ¬çš„è™›æ“¬æ©Ÿå™¨ä¾¿å®œéå¸¸å¤šï¼Œé€™ä¹Ÿæ˜¯æˆ‘å€‘é¸ç”¨å…ˆå è™›æ“¬æ©Ÿå„ªæ–¼ä¸€èˆ¬è™›æ“¬æ©Ÿçš„å”¯ä¸€ç†ç”± å…ˆå è™›æ“¬æ©Ÿæœ‰ä»¥ä¸‹é™åˆ¶ï¼Œä»¥ç¶­é‹çš„è§’åº¦ï¼Œé€™äº›éƒ½æ˜¯éœ€è¦è€ƒé‡çš„é»ã€‚\nGCP ä¸ä¿è­‰æœƒæœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿä¸èƒ½ç›´æ¥è½‰æ›æˆæ™®é€šè™›æ“¬æ©Ÿ è³‡æ–™ä¸­å¿ƒè§¸ç™¼ç¶­è­·äº‹ä»¶æ™‚(ex. å›æ”¶å…ˆå è™›æ“¬æ©Ÿ)ï¼Œå…ˆå è™›æ“¬æ©Ÿä¸èƒ½è¨­å®šè‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒç›´æ¥é—œé–‰ å…ˆå æ©Ÿå™¨æ’é™¤åœ¨ GCP çš„æœå‹™ç­‰ç´šå”è­° (SLA)ä¹‹å¤– å…ˆå è™›æ“¬æ©Ÿä¸é©ç”¨GCP å…è²»é¡åº¦ è²»ç”¨ç²—ä¼°è©¦ç®— è‡³æ–¼ä¾¿å®œæ˜¯å¤šä¾¿å®œå‘¢ï¼Ÿé€™é‚Šå…ˆé–‹å¹¾å€‹ä¾‹å­çµ¦å„ä½ä¸€äº›æ¦‚å¿µã€‚","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance Introduction","type":"post"},{"authors":[],"categories":null,"content":"é—œæ–¼è³‡æºè©•ä¼° æ¶æ§‹åœ˜éšŠæä¾›è™›æ“¬æ©Ÿçµ¦æ‡‰ç”¨ï¼Œæœ‰å€‹å•é¡Œæ™‚å¸¸å‡ºç¾ï¼šæ‡‰è©²åˆ†é…å¤šå°‘è³‡æºçµ¦æ‡‰ç”¨ï¼Ÿä¾‹å¦‚ï¼šå¾Œç«¯æº–å‚™ä¸€å€‹ API serverï¼ŒSRE é€™é‚Šè¦æº–å‚™å¤šå°‘ä»€éº¼è¦æ ¼çš„æ©Ÿå™¨ï¼Ÿ\nä»¥å¾€ä½¿ç”¨è™›æ“¬æ©Ÿç›´æ¥éƒ¨ç½²æ‡‰ç”¨æ™‚ï¼Œæœƒéœ€è¦æ˜ç¢ºè¦åŠƒå„ç¾¤è™›æ“¬æ©Ÿï¼Œå„è‡ªéœ€è¦åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œå¦‚æœæ²’æœ‰åšè³‡æºçš„äº‹å‰è©•ä¼°ï¼Œæœ‰å¯èƒ½æ”¾ä¸Šæ©Ÿå™¨é‹è¡Œå¾Œå°±ç™¼ç”Ÿè³‡æºä¸è¶³ã€‚\nå°å…¥ Kubernetes å¾Œï¼Œé€éç¯€é»æ±  (Node Pool) å½¢æˆä¸€å€‹å¤§å‹è³‡æºæ± ï¼Œè¨­å®šéƒ¨ç½²çš„æ”¿ç­–å¾Œï¼Œè®“ Kubernetes è‡ªå‹•èª¿åº¦æ‡‰ç”¨ï¼š\næ¯ä¸€å€‹ç¯€é»çš„è³‡æºå¤ å¤§ï¼Œä½¿å¾—æ‡‰ç”¨è™›æ“¬æ©Ÿå™¨ä¸Šæ‰€ä½”çš„æ¯”ä¾‹ç›¸å°è¼ƒå°ï¼Œä¹Ÿå°±æ˜¯å–®ä¸€æ‡‰ç”¨çš„èª¿åº¦ä¸æœƒå½±éŸ¿ç¯€é»çš„æ•´é«”è² è¼‰ å¦‚æœç¯€é»å¤ªå°ï¼Œèª¿åº¦æ‡‰ç”¨å°±æœƒæœ‰äº›ä¾·ä¿ƒï¼Œä¾‹å¦‚ï¼šä¸€å€‹ API server å‡è¼‰æ™‚æ¶ˆè€— 1 cpu æ»¿è¼‰æ™‚æ¶ˆè€— 2 cpuã€‚æº–å‚™ 3 cpu çš„è™›æ“¬æ©Ÿï¼Œèª¿åº¦æ‡‰ç”¨æ™‚å¹¾ä¹æ˜¯é·ç§»æ•´å°è™›æ“¬æ©Ÿçš„è² è¼‰ æ­¤å¤–é‚„æœ‰æ©Ÿæœƒå› ç‚ºä¸Šç¯‡æåˆ°çš„è³‡æºä¿ç•™ï¼Œé€ æˆèª¿åº¦å¤±æ•—ã€‚å¦‚æœæº–å‚™ 24 cpu çš„æ©Ÿå™¨ï¼Œèª¿åº¦èµ·ä¾†å½ˆæ€§å°±å¾ˆå¤§ï¼Œå°ç¯€é»çš„æ€§èƒ½è¡æ“Šä¹Ÿæ¯”è¼ƒä½ åªéœ€è¦ä¼°è¨ˆæ•´é«”çš„è³‡æºæ¶ˆè€—ç‡è¨ˆç®—éœ€æ±‚ï¼Œé…åˆè‡ªå‹•æ“´å±•ï¼Œå‹•æ…‹å™¨è£œè¶³ä¸è¶³çš„è³‡æº ä¾‹å¦‚ï¼šä¼°è¨ˆç¸½å…±éœ€è¦ 32 cpu ï¼Œæº–å‚™ 36 cpu çš„è™›æ“¬æ©Ÿï¼Œç•¶æ»¿è¼‰æ™‚ä¾æ“š cpu å£“åŠ›è‡ªå‹•æ“´å®¹åˆ° 48 cpu å¸Œæœ›æ•´é«”è³‡æºçš„ä½¿ç”¨ç‡å¤ é«˜ï¼Œç•¶ç„¶é ç•™å¤ªå¤šçš„è³‡æºæœƒé€ æˆæµªè²» è¦æ§ç®¡ Kubernetes çš„è³‡æºä½¿ç”¨é‡ä¹Ÿå¯è¨­å®šè³‡æºéœ€æ±‚èˆ‡è³‡æºé™åˆ¶ï¼Œå»¶ä¼¸é–±è®€ã€‚\nä¼°è¨ˆå¾—è¶Šæº–ç¢ºï¼Œç•¶ç„¶å¯¦éš›éƒ¨ç½²çš„è³‡æºæŒæ¡åº¦å°±è¶Šé«˜ï¼Œç„¶è€Œç­†è€…éå»çš„ç¶“é©—ï¼Œåœ˜éšŠåœ¨äº¤ä»˜æºç¢¼æ™‚æœªå¿…å°±èƒ½å¤ åšå‡ºæœ‰æ•ˆçš„è³‡æºæ¶ˆè€—è©•ä¼°ï¼Œé‚£æœ‰æ²’æœ‰ä»€éº¼è¾¦æ³•å¯ä»¥å¹«åŠ©æˆ‘å€‘ï¼Ÿ\nè³‡æºéœ€æ±‚ä¼°ä¼°çœ‹ å¦‚æœæ‡‰ç”¨é–‹ç™¼åœ˜éšŠï¼Œæœ‰å…ˆä½œæ‡‰ç”¨çš„ profilingï¼Œç„¶å¾Œ release candidate ç‰ˆæœ¬æœ‰åœ¨ staging ä¸Šä½œå£“åŠ›æ¸¬è©¦çš„è©±ï¼Œç¶­é‹åœ˜éšŠé€™é‚Šæ‡‰è©²å°±å–å¾—çš„æ•¸æ“šï¼Œåšéƒ¨ç½²å‰çš„è³‡æºè©•ä¼°ã€‚\næ‡‰ç”¨åœ¨ä¸åŒç‹€æ…‹æˆ–æ˜¯å·¥ä½œéšæ®µï¼Œæœƒæ¶ˆè€—ä¸åŒçš„è³‡æº\nä¾‹å¦‚ï¼šé‹ç®—å¯†é›†çš„ batch job å¯èƒ½æœƒæœ‰\næ§åˆ¶ç¯€é» (master node) å•Ÿå‹•å¾Œæœƒä½”æœ‰ä¸€å®šçš„è³‡æºï¼Œä¸€èˆ¬ä¾†èªªä¸æœƒæ¶ˆè€—å¤ªå¤šï¼Œåªæ˜¯éœ€è¦ç‚ºæ§åˆ¶ç¯€é»å„ªå…ˆä¿ç•™è³‡æº å·¥ä½œç¯€é» (worker node) å•Ÿå‹•æ™‚æœƒéœ€è¦é ç•™è¶³å¤ çš„è³‡æºï¼Œæ¥æ”¶å·¥ä½œå¾Œæœƒé€æ¼¸å¢åŠ è³‡æºä½¿ç”¨ï¼Œæ‹‰åˆ°æ»¿è¼‰ ä¾‹å¦‚ï¼šé¢å‘ç”¨æˆ¶çš„æœå‹™ï¼Œå¯èƒ½æœƒæœ‰\nå•Ÿå‹•æ‡‰ç”¨æ‰€éœ€çš„è³‡æº æ²’æœ‰å¤§é‡è«‹æ±‚ï¼Œåªç¶­æŒåŸºæœ¬æ‡‰ç”¨é‹è¡Œæ‰€ä½¿ç”¨çš„è³‡æº è² è¼‰å£“åŠ›çŒé€²ä¾†æ™‚ï¼Œæ¶ˆè€—è³‡æºéš¨ç”¨æˆ¶è«‹æ±‚æ•¸é‡çš„æˆé•·æ›²ç·šï¼Œè¨­å®šçš„å®‰å…¨ä¸Šç•Œ å¦‚æœæ²’æœ‰é€™äº›æ•¸æ“šï¼Œå…¶å¯¦ç¶­é‹å¾ˆé›£äº‹å‰ä¼°è¨ˆè³‡æºï¼Œè®Šæˆè¦å¯¦éš›æ¨ä¸Šç·šå¾Œè¦‹æ‹›æ‹†æ‹›ï¼ŒåŸºæ–¼å¯¦éš›çš„è³‡æºæ¶ˆè€—å»åšè‡ªå‹•æ“´å®¹ï¼Œå…¶å¯¦æœ‰å¯èƒ½æœƒé€ æˆè³‡æºçš„æµªè²»ï¼Œå› æ­¤æˆ‘å»ºè­°å¦‚æœé–‹ç™¼åœ˜éšŠæ²’æœ‰ä½œ profilingï¼Œç¶­é‹åœ˜éšŠå¯ä»¥åœ¨å·¥ä½œæµç¨‹å…§ç°¡å–®åŠ ä¸€æ­¥ profilingï¼Œç›®å‰ä¸»æµèªè¨€éƒ½æœ‰æä¾›ç›¸é—œå·¥å…·ï¼Œç°¡å–®çš„åŸ·è¡Œå°±å¯ä»¥ç²å¾—å¾ˆå¤šè³‡è¨Šã€‚\nè‡³æ–¼å£“åŠ›æ¸¬è©¦ï¼Œä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨åŸºæœ¬çš„å·¥å…·(ä¾‹å¦‚ Artilery)ç°¡å–®æ•´åˆ°å·¥ä½œæµç¨‹ã€‚ç‰¹åˆ¥æ˜¯é¢å°å®¢æˆ¶çš„æ‡‰ç”¨ï¼Œå‹™å¿…è¦é€²è¡Œå£“åŠ›æ¸¬è©¦ã€‚\næœ‰äº†ä¸Šè¿°çš„è³‡æºéœ€æ±‚æ•¸æ“šï¼Œæ‰èƒ½äº‹å…ˆå®‰æ’æ©Ÿå™¨çš„è¦æ ¼ã€‚ä¾‹å¦‚\næ‡‰ç”¨æ˜¯é¢å°å®¢æˆ¶çš„ API server åŸºæœ¬è³‡æºæ˜¯ 200m cpu 1Gi memoryï¼Œé€™éƒ¨åˆ†ç›´æ¥å¯«é€² Kubernetes resource requestï¼Œåœ¨æ’ç¨‹æ™‚å°±å…ˆçµé»ä¸Šé ç•™ã€‚ è² è¼‰æ‹‰åˆ° 1,000 RPSï¼Œlatency 95% 20ms 99% 30msï¼Œé€™æ™‚çš„è³‡æºéœ€æ±‚çš„ä¸Šç•Œå¤§ç´„ 2 cpu 4 Gi memory è¶…é 1,000 RPS å°±æ‡‰è©²è¦é€éæ°´å¹³æ“´å±•å»å¢åŠ æ›´å¤š instamce å¦‚æœå–®è·‘é€™å€‹ API serverï¼Œå°±å¯ä»¥å®‰æ’ memory 8ï¼Œcpu 4 çš„ GKE node-poolï¼Œè®“è² è¼‰è½åœ¨å¯ç”¨è³‡æºçš„ 60%-70%ï¼Œé€™æ¨£é‚„æœ‰é¤˜è£•å¯ä»¥æ‰¿å—å¤§æµé‡ï¼Œçµ¦è‡ªå‹•æ°´å¹³æ“´å±•åšå‹•çš„æ™‚é–“ã€‚\nè³‡æºèª¿æ•´åƒè€ƒ ç•¶ç„¶é€™äº›æ•¸æ“šéƒ½å¯ä»¥ä¾ç…§æ™‚å¯¦éš›éœ€æ±‚èª¿æ•´ï¼Œè³‡æºè¦å£“ç¸®å¾—æ›´ç·Šæˆ–æ›´é¬†éƒ½æ˜¯å¯è¡Œçš„ã€‚\nå¦‚æœæ‡‰ç”¨æœ‰æ•´åˆåˆ†æå¾Œå°ï¼Œä¾‹å¦‚ Real-time Uer Monitoringã€æˆ–æ˜¯åŸºæœ¬çš„ Google Analyticsï¼Œéƒ½å¯ä»¥è§€å¯Ÿé€™äº›èª¿æ•´å¯¦éš›å°ç”¨æˆ¶å¸¶ä¾†çš„å½±éŸ¿ï¼Œç”¨æˆ¶è¡Œç‚ºæ”¹è®Šå°å…¬å¸ç‡Ÿæ”¶çš„å½±éŸ¿ï¼Œå…¨éƒ½å¯ä»¥é‡åŒ–ã€‚ä¾‹å¦‚\næ©Ÿå™¨è² è¼‰æ‹‰åˆ° 80%ï¼Œcpu çš„å£“åŠ›ï¼Œå°è‡´ API latency å¢åŠ åˆ° 95% 50ms 99% 100ms æ­¤æ™‚ç”¨æˆ¶å·²ç¶“å¾ˆæœ‰æ„Ÿäº†ï¼Œæœƒå°è‡´ 0.1% ç”¨æˆ¶è·³è½‰é›¢é–‹ è€Œé€™ 0.1% çš„ç”¨æˆ¶ï¼Œä»¥å¾€çš„å¹³å‡æ¶ˆè²»ï¼Œæ›ç®—æˆç‚ºå…¬å¸ç‡Ÿæ”¶ï¼Œæ˜¯ $1,000/month æŠŠæ©Ÿå™¨è² è¼‰å£“åˆ° 60%ï¼Œåªè¨ˆç®— cpu çš„æ•¸é‡çš„è©±ï¼Œéœ€è¦å¤šé–‹ 3 å° n1-standard-4 æ©Ÿå™¨ï¼Œå…±è¨ˆ $337.26/month æä¾›è€é—†åšåƒè€ƒï¼Œè€é—†å¯èƒ½æœƒè¶¨å‘åŠ é–‹æ©Ÿå™¨ ç•¶ç„¶ä¸Šé¢çš„ä¾‹å­éƒ½éå¸¸ç°¡åŒ–ï¼Œè®Šæˆåœ‹ä¸­æ•¸å­¸å•é¡Œï¼Œé€™é‚Šåªæ˜¯æä¾›ä¸€å€‹ä¼°ç®—çš„ä¾‹å­ã€‚ç¾å¯¦ä¸­çš„å•é¡Œéƒ½æœƒè¤‡é›œç™¾å€ï¼Œä¾‹å¦‚æ©Ÿå™¨è¦æ ¼æ‹‰ä¸Šå»å‡ºç¾æ–°çš„ç“¶é ¸ã€ä¾‹å¦‚ä¾è³´çš„æœå‹™ï¼Œmessage queueã€database å£“åŠ›ä¸Šå‡ï¼Œæˆ–æ˜¯å…¬å¸å…§éƒ¨å•é¡Œï¼Œå°±æ‹¿ä¸åˆ°é ç®—(è¡€æ·š SRE)ã€‚å¦‚æœè¦æ¸›å°‘æ©Ÿå™¨ï¼Œä¹Ÿå¯ä»¥åƒè€ƒï¼Œä¸€èˆ¬ä¾†èªªè½åˆ°é—œæ©Ÿå™¨çœéŒ¢çš„è©±ï¼Œè€é—†éƒ½æœƒæ¥å—çš„ XDã€‚\nå›åˆ°å…ˆå æ©Ÿå™¨ æ ¹æ“šä¸Šé¢çš„åœ‹ä¸­æ•¸å­¸ï¼ŒæŠŠæ‡‰ç”¨ä¸€å€‹ä¸€å€‹éƒ½è¨ˆç®—æ¸…æ¥šï¼Œéœ€æ±‚é€æ¼¸æ˜ç¢ºäº†ã€‚å‡è¨­ï¼Œæ¶æ§‹åœ˜éšŠæ‹¿åˆ°é–‹æ©Ÿå™¨çš„å·¥å–®ï¼ŒææŒ‡ä¸€ç®—ï¼Œæ±ºå®š\n1 GKE cluster 6 n1-standard-4 é€™äº›éƒ½æ˜¯éš¨é¸è™›æ“¬æ©Ÿï¼Œåƒ¹æ ¼å¤§ç´„æ˜¯ $747/month (å«é›†ç¾¤ç®¡ç†è²» $73/month)ã€‚ä»Šå¤©æœ‰äººè…¦å‹•å¤§é–‹ï¼Œé‚£å¦‚æœå…¨éƒ¨æ›æˆå…ˆå ç¯€é»å‘¢ï¼Ÿè®Šæˆ $265/monthï¼Œè™›æ“¬æ©Ÿè²»ç”¨ $192 / $674 = 0.28 ç›´æ¥æ‰“è¶…éä¸‰æŠ˜ã€‚\næœ‰äººå°±æ“”å¿ƒï¼Œé€™æ¨£çœŸçš„å¯ä»¥å—ï¼ŸçœŸçš„æ²’å•é¡Œå—ï¼Ÿæœƒä¸æœƒå½±éŸ¿ç”¨æˆ¶é˜¿ã€‚\nç­”æ¡ˆæ˜¯æœƒï¼Œå°±æ˜¯æœƒå½±éŸ¿ç”¨æˆ¶ XD\nè½åˆ°é€™é‚Šå¾ˆå¤šäººå°±æ€•äº†ã€‚ä½†æ˜¯æ€éº¼å€‹å½±éŸ¿æ³•å‘¢ï¼Œé‚„éœ€è¦çœ‹åº•ä¸‹å¹¾å€‹æ®µè½ï¼Œå¦‚æœæ›æˆå…ˆå è™›æ“¬æ©Ÿï¼Œç”¨æˆ¶æœƒæ€éº¼å—åˆ°å½±éŸ¿ã€‚æˆ‘å€‘ä¹Ÿè¦è©¦åœ–é‡åŒ–é€™å€‹å½±éŸ¿ï¼Œç•¶ä½œè¦ä¸è¦å°å…¥çš„åˆ¤æ–·ä¾æ“šã€‚\nå¥å€‹åä¾‹ï¼Œã€Œæˆ‘è¦ºå¾—å¯ä»¥ã€ã€Œä½ è¦ºå¾—ä¸è¡Œã€ï¼Œæˆ–æ˜¯ã€ŒæŸæŸå…¬å¸çš„æŸæŸåœ˜éšŠå¯ä»¥å•Šã€ã€Œæˆ‘å€‘å…¬å¸ä¹Ÿä¾†åšå§ã€ï¼Œé€™äº›éƒ½æ˜¯å¾ˆç³Ÿç³•çš„ç†ç”±ã€‚é™¤äº†å°å…§éƒ¨æ¯«ç„¡èªªæœåŠ›ä¹‹å¤–ï¼Œä¹Ÿæ²’æœ‰è¾¦æ³•ä½œç‚ºå°å…¥æˆæ•ˆçš„æŒ‡æ¨™ï¼Œæœƒè®“åœ˜éšŠé™·å…¥ã€Œå°å…¥äº†ä¹Ÿä¸çŸ¥é“æœ‰æ¯”å°å…¥å‰å¥½ï¼Ÿã€æˆ–æ˜¯ã€Œå…·é«”å°å…¥å¾Œæˆæ•ˆé‡åŒ–ã€ï¼Œæœƒå½±éŸ¿åœ˜éšŠåšå‡ºçœŸæ­£æœ‰æ•ˆçš„åˆ¤æ–·ï¼Œæ‡‰æ¥µåŠ›é¿å…ã€‚\næ­¤å¤–ï¼Œå•è¡Œä¸è¡Œä¹‹å‰ï¼Œå…¶å¯¦éœ€è¦çŸ¥é“åœ˜éšŠé¡˜æ„ç‚ºäº†ä¸‰æŠ˜æ©Ÿå™¨ï¼Œä»˜å‡ºå¤šå°‘æˆæœ¬ã€‚å¦‚æœåªæ˜¯æ¯æœˆçœå€‹å°å¹£ 15,000ï¼Œå·¥ç¨‹å¸«è–ªæ°´éƒ½è¶…éäº†ã€‚ä½†å¦‚æœæ‰‹ä¸‹æœ‰ä¸‰åå°æˆ–ä¸‰ç™¾å°ä»¥ä¸Šï¼Œä¹Ÿè¨±å°±éå¸¸å€¼å¾—æŠ•è³‡ã€‚æˆæœ¬ä¸æ˜¯çµ•å°çš„ï¼Œå¾ˆå¤šæ™‚å€™è¦èˆ‡å…¶ä»–æˆæœ¬ (e.g. é–‹ç™¼äººåŠ›æ™‚é–“æˆæœ¬) ä¸€èµ·è€ƒé‡ã€‚\nä»¥ä¸Šéƒ½æ˜¯èªªæ˜å°å…¥çš„å‹•æ©Ÿï¼Œä»¥ä¸‹èªªæ˜å…ˆå è™›æ“¬æ©Ÿçš„å„ç¨®æ©Ÿåˆ¶ï¼Œä»¥åŠå°æ‡‰ç”¨çš„å¯¦éš›å½±éŸ¿ã€‚\n","date":1601007722,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"887128d2f5d034ae96eca13ed213831a","permalink":"https://chechia.net/zh-hant/post/2020-09-25-gcp-preemptible-instance-resource-calculation/","publishdate":"2020-09-25T12:22:02+08:00","relpermalink":"/zh-hant/post/2020-09-25-gcp-preemptible-instance-resource-calculation/","section":"post","summary":"é—œæ–¼è³‡æºè©•ä¼° æ¶æ§‹åœ˜éšŠæä¾›è™›æ“¬æ©Ÿçµ¦æ‡‰ç”¨ï¼Œæœ‰å€‹å•é¡Œæ™‚å¸¸å‡ºç¾ï¼šæ‡‰è©²åˆ†é…å¤šå°‘è³‡æºçµ¦æ‡‰ç”¨ï¼Ÿä¾‹å¦‚ï¼šå¾Œç«¯æº–å‚™ä¸€å€‹ API serverï¼ŒSRE é€™é‚Šè¦æº–å‚™å¤šå°‘ä»€éº¼è¦æ ¼çš„æ©Ÿå™¨ï¼Ÿ\nä»¥å¾€ä½¿ç”¨è™›æ“¬æ©Ÿç›´æ¥éƒ¨ç½²æ‡‰ç”¨æ™‚ï¼Œæœƒéœ€è¦æ˜ç¢ºè¦åŠƒå„ç¾¤è™›æ“¬æ©Ÿï¼Œå„è‡ªéœ€è¦åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œå¦‚æœæ²’æœ‰åšè³‡æºçš„äº‹å‰è©•ä¼°ï¼Œæœ‰å¯èƒ½æ”¾ä¸Šæ©Ÿå™¨é‹è¡Œå¾Œå°±ç™¼ç”Ÿè³‡æºä¸è¶³ã€‚\nå°å…¥ Kubernetes å¾Œï¼Œé€éç¯€é»æ±  (Node Pool) å½¢æˆä¸€å€‹å¤§å‹è³‡æºæ± ï¼Œè¨­å®šéƒ¨ç½²çš„æ”¿ç­–å¾Œï¼Œè®“ Kubernetes è‡ªå‹•èª¿åº¦æ‡‰ç”¨ï¼š\næ¯ä¸€å€‹ç¯€é»çš„è³‡æºå¤ å¤§ï¼Œä½¿å¾—æ‡‰ç”¨è™›æ“¬æ©Ÿå™¨ä¸Šæ‰€ä½”çš„æ¯”ä¾‹ç›¸å°è¼ƒå°ï¼Œä¹Ÿå°±æ˜¯å–®ä¸€æ‡‰ç”¨çš„èª¿åº¦ä¸æœƒå½±éŸ¿ç¯€é»çš„æ•´é«”è² è¼‰ å¦‚æœç¯€é»å¤ªå°ï¼Œèª¿åº¦æ‡‰ç”¨å°±æœƒæœ‰äº›ä¾·ä¿ƒï¼Œä¾‹å¦‚ï¼šä¸€å€‹ API server å‡è¼‰æ™‚æ¶ˆè€— 1 cpu æ»¿è¼‰æ™‚æ¶ˆè€— 2 cpuã€‚æº–å‚™ 3 cpu çš„è™›æ“¬æ©Ÿï¼Œèª¿åº¦æ‡‰ç”¨æ™‚å¹¾ä¹æ˜¯é·ç§»æ•´å°è™›æ“¬æ©Ÿçš„è² è¼‰ æ­¤å¤–é‚„æœ‰æ©Ÿæœƒå› ç‚ºä¸Šç¯‡æåˆ°çš„è³‡æºä¿ç•™ï¼Œé€ æˆèª¿åº¦å¤±æ•—ã€‚å¦‚æœæº–å‚™ 24 cpu çš„æ©Ÿå™¨ï¼Œèª¿åº¦èµ·ä¾†å½ˆæ€§å°±å¾ˆå¤§ï¼Œå°ç¯€é»çš„æ€§èƒ½è¡æ“Šä¹Ÿæ¯”è¼ƒä½ åªéœ€è¦ä¼°è¨ˆæ•´é«”çš„è³‡æºæ¶ˆè€—ç‡è¨ˆç®—éœ€æ±‚ï¼Œé…åˆè‡ªå‹•æ“´å±•ï¼Œå‹•æ…‹å™¨è£œè¶³ä¸è¶³çš„è³‡æº ä¾‹å¦‚ï¼šä¼°è¨ˆç¸½å…±éœ€è¦ 32 cpu ï¼Œæº–å‚™ 36 cpu çš„è™›æ“¬æ©Ÿï¼Œç•¶æ»¿è¼‰æ™‚ä¾æ“š cpu å£“åŠ›è‡ªå‹•æ“´å®¹åˆ° 48 cpu å¸Œæœ›æ•´é«”è³‡æºçš„ä½¿ç”¨ç‡å¤ é«˜ï¼Œç•¶ç„¶é ç•™å¤ªå¤šçš„è³‡æºæœƒé€ æˆæµªè²» è¦æ§ç®¡ Kubernetes çš„è³‡æºä½¿ç”¨é‡ä¹Ÿå¯è¨­å®šè³‡æºéœ€æ±‚èˆ‡è³‡æºé™åˆ¶ï¼Œå»¶ä¼¸é–±è®€ã€‚","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance Resource Calculation","type":"post"},{"authors":[],"categories":null,"content":"éœ€æ±‚è¦åŠƒ ä½¿ç”¨å…ˆå ç¯€é»æ¯”èµ·ä½¿ç”¨ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿï¼Œæœƒå¤šå‡ºè¨±å¤šæŠ€è¡“å›°é›£éœ€è¦å…‹æœï¼Œåªæœ‰ç¯€çœä¸‹çš„æˆæœ¬å¤§æ–¼æ•´é«”æŠ€è¡“æˆæœ¬æ™‚ï¼Œæˆ‘å€‘æ‰æœƒé¸ç”¨å…ˆå ç¯€é»ã€‚å› æ­¤é€™é‚Šè¦é€²è¡Œæˆæœ¬ç²¾ç®—ï¼Œé‡æ–°èª¿æ•´çš„æ¶æ§‹ä¸‹ï¼Œå¯¦éš›åˆ°åº•èƒ½çœå¤šå°‘éŒ¢ã€‚å‹™å¿…ä½¿ç”¨ Google Cloud Pricing Calculator ç²¾ç®—æˆæœ¬ã€‚\nå¦å¤–ï¼Œé›–ç„¶å…ˆå è™›æ“¬æ©Ÿæœƒæœ‰å¾ˆå¤šé¡å¤–çš„é™åˆ¶èˆ‡æŠ€è¡“å›°é›£ï¼Œä½†å¯¦å‹™ä¸Šé‚„æ˜¯è¦å°æ¯”å¯¦éš›çš„éœ€æ±‚ï¼Œæœ‰äº›é™åˆ¶èˆ‡éœ€æ±‚æ˜¯è¡çªçš„ï¼Œæœ‰äº›é™åˆ¶å‰‡å®Œå…¨ä¸æœƒå½±éŸ¿æˆ‘å€‘çš„éœ€æ±‚ã€‚å‰è€…ç•¶ç„¶æœƒå¸¶çµ¦æˆ‘å€‘è¼ƒé«˜çš„å°å…¥é›£åº¦ï¼Œå¾Œè€…å¯èƒ½æœƒéå¸¸è¼•é¬†ã€‚\né€™é‚Šæƒ³çµ¦å¤§å®¶çš„æ¦‚å¿µæ˜¯ï¼Œå‹™å¿…å…ˆæ˜ç¢ºéœ€æ±‚ï¼Œå†è¨è«–æŠ€è¡“ã€‚é€™é»å¾ˆé‡è¦ï¼ŒæŠ€è¡“çš„é©ç”¨èˆ‡å¦ï¼Œä¸æ˜¯ç”±å€‹äººçš„å–œå¥½æ±ºå®šï¼Œå”¯ä¸€çš„åˆ¤æ–·æ¨™æº–ï¼Œæ˜¯èƒ½ä¸èƒ½æœ‰æ•ˆç‡çš„æ»¿è¶³éœ€æ±‚ã€‚\næ‰€ä»¥é€™é‚Šå…ˆå®šç¾©æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\nåŸ·è¡ŒçŸ­æœŸçš„ batch job åŸ·è¡Œé•·æœŸçš„ user-facing API server åŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº« Batch Job å¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\nä½¿ç”¨ç¶²è·¯çˆ¬èŸ² (crawler) å»æŠ“å–è¨±å¤šç¶²ç«™çš„æ‰€æœ‰å…§å®¹ ä½¿ç”¨ GPU é€²è¡Œæ©Ÿå™¨å­¸ç¿’çš„ Model Training å¤§æ•¸æ“šè¨ˆç®— MapReduce é€™äº›ä»»å‹™çš„æ ¸å¿ƒéœ€æ±‚ï¼Œå¾ˆç°¡å–®ç›´æ¥\nç›¡å¿«å®Œæˆæ•´é«”å·¥ä½œ ç›¡å¯èƒ½ç¯€çœå¤§é‡ç®—åŠ›æˆæœ¬ ä¾‹å¦‚ï¼šæˆ‘æ‰‹ä¸Šçš„æ©Ÿå™¨å­¸ç¿’ Model ç²—ç•¥ä¼°è¨ˆ 10000 å°æ™‚*GPU çš„ç®—åŠ›éœ€æ±‚ï¼Œæ‰èƒ½ç”¢å‡ºä¸€å€‹æœ‰æ•ˆçš„Modelã€‚ç”±æ–¼å¤§é‡çš„ç®—åŠ›éœ€æ±‚ï¼Œä¸€èˆ¬ä¾†èªªéƒ½æœƒé¸æ“‡åˆ†æ•£å¼çš„é‹ç®—æ¡†æ¶ (ex. MapReduce) ï¼Œå°‡çœŸæ­£æ¶ˆè€—ç®—åŠ›çš„å·¥ä½œï¼Œä½¿ç”¨åˆ†è€ŒåŒ–ä¹‹ (divide and conquer) çš„æ¶æ§‹è¨­è¨ˆï¼Œå°‡åˆ†é…ä»»å‹™çš„æ§åˆ¶ç¯€é» (master)ï¼Œèˆ‡å¯¦éš›é€²è¡Œé‹ç®—çš„å·¥ä½œç¯€é»(worker) æ‹†åˆ†ã€‚åŸºæ–¼åŸæœ¬çš„åˆ†æ•£å¼æ¶æ§‹ï¼Œå¹¾ä¹å¯ä»¥ç„¡ç—›åœ°å°‡å·¥ä½œç¯€é»è½‰ç§»åˆ°å…ˆå è™›æ“¬æ©Ÿä¸Šã€‚\næ ¹æ“šä¸Šè¿°çš„éœ€æ±‚ï¼Œé€™é¡çš„å·¥ä½œç‰¹æ€§å¯èƒ½æœ‰\nCPU / GPU ç®—åŠ›éœ€æ±‚é«˜çš„é‹ç®—ç¯€é» (Worker) Worker æœ¬èº«æ˜¯ç„¡ç‹€æ…‹çš„ Stateless å¯æ§çš„å³æ™‚è² è¼‰ å°‡æ•´é«”å·¥ä½œåˆ‡åˆ†æˆä»»å‹™å–®å…ƒ (task)ï¼Œåˆ†é…çµ¦å·¥ä½œç¯€é» ä»»å‹™å–®å…ƒçš„ç‹€æ…‹å¤–éƒ¨ä¿ç•™ï¼Œå·¥ä½œç¯€é»å¯å®¹éŒ¯ (fault-tolerent)ï¼Œä»»å‹™å–®å…ƒå¯å¾©åŸ ç”±æ–¼å…ˆå è™›æ“¬æ©Ÿå¯èƒ½æ˜¯æµ®å‹•åƒ¹æ ¼ï¼Œé€™é¡å·¥ä½œå¯ä»¥æ ¹æ“šå„ªå…ˆç¨‹åº¦ï¼Œèª¿æ•´åˆé©çš„å·¥ä½œæ™‚é–“ï¼Œä¾‹å¦‚åœ¨è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚ä½ï¼Œå…ˆå è™›æ“¬æ©Ÿçš„è²»ç”¨ä½å»‰æ™‚ï¼Œå•Ÿç”¨è¼ƒå¤šçš„å·¥ä½œç¯€é»åŠ å¿«é‹ç®—ï¼Œå¦‚æœè²»ç”¨é«˜æ™‚ï¼Œå¯ä»¥é™ä½å…ˆå è™›æ“¬æ©Ÿçš„ä½¿ç”¨ï¼Œå»¶å¾Œå·¥ä½œï¼Œç”šè‡³æ˜¯èª¿ç”¨ä¸åŒå€åŸŸï¼Œè²»ç”¨ä½çš„å·¥ä½œç¯€é»ï¼Œä¾†é™ä½æ•´é«”çš„æˆæœ¬ã€‚\nåŸ·å¾—æ³¨æ„çš„æ˜¯ï¼Œé€™é¡ä»»å‹™çš„æ§åˆ¶ç¯€é» (master)ï¼Œä¹Ÿè¨±æ˜¯é›†ä¸­å¼çš„ï¼Œä¹Ÿè¨±æ˜¯åˆ†æ•£å¼çš„ï¼Œéœ€è¦æ ¹æ“šæ€§è³ªè€ƒé‡ï¼Œæ˜¯å¦é©åˆæ”¾åœ¨å…ˆå è™›æ“¬æ©Ÿä¸Šã€‚æœ‰äº›æ¶æ§‹æ§åˆ¶ç¯€é»å¯ä»¥å®¹éŒ¯ï¼Œç„¶è€ŒéŒ¯èª¤ç™¼ç”Ÿå¾Œæœƒéœ€è¦å¾©åŸç‹€æ…‹ï¼Œé€™æ™‚æœƒæ¶ˆè€—é¡å¤–çš„ç®—åŠ›ï¼Œå¯èƒ½æœƒæ‹–ç·©æ•´é«”é€²åº¦ï¼Œé€ æˆç®—åŠ›çš„æ¶ˆè€—ã€‚ä¹Ÿè¨±å°±å¯ä»¥è€ƒé‡ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿé…åˆä½¿ç”¨ã€‚\nUser-facing services å¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\nRestful API server Websocket Server TCP/HTTP reverse proxy é€™äº›å·¥ä½œçš„æ ¸å¿ƒéœ€æ±‚å¦‚ä¸‹ï¼š\næ•´é¡Œæœå‹™çš„é«˜å¯ç”¨æ€§ (high availability) æ‰¿å—ä¸å¯é æœŸçš„è² è¼‰é«˜å³° (load spikes) æ•´é«”è¡¨ç¾éœ€è¦ä½å»¶é² (low latency) å¯ä»¥æ°´å¹³æ“´å±• (horizontal scaling)ï¼Œæ”¯æ’ç”¨æˆ¶çš„æˆé•· æœ€çµ‚å¹³è¡¡æ•ˆèƒ½å‘ˆç¾èˆ‡æˆæœ¬ ç”±æ–¼æœƒé¢å°ä½¿ç”¨è€…ï¼Œéœ€è¦èƒ½æ”¯æŒä½¿ç”¨è€…çš„å£“åŠ›ï¼ŒåˆåŒæ™‚éœ€è¦æœ‰ä¸€å®šçš„æœå‹™æ•ˆèƒ½ï¼Œä¾†ç¶­æŒä½¿ç”¨è€…é«”é©—ã€‚å¯¦å‹™ä¸Šè¨­è¨ˆå¯èƒ½æ¡ç”¨ç„¡ç‹€æ…‹æ‡‰ç”¨ (stateless)ï¼Œå¤šå‰¯æœ¬ (replica) éƒ¨ç½²åˆ°é›†ç¾¤ä¸­ã€‚éœ€è¦å„²å­˜çš„ç‹€æ…‹ï¼ˆå¦‚ç”¨æˆ¶ç‹€æ…‹ï¼‰ï¼Œä½¿ç”¨å¤–éƒ¨çš„å…±ç”¨å„²å­˜ (ä¾‹å¦‚ï¼šRedisï¼ŒRDBMSï¼Œæˆ–æ˜¯ Non-SQL DB)ã€‚è«‹æ±‚çš„æµé‡ï¼Œé€éä¸Šæ¸¸çš„è² è¼‰å‡è¡¡å™¨ (Load Balancer)ï¼Œé€é€²å¤šå€‹å¾Œç«¯ï¼Œè™•ç†å®Œæˆè«‹æ±‚å¾Œï¼Œå†è¿”å›çµ¦ä½¿ç”¨è€…ã€‚\né€™æ¨£çš„è¨­è¨ˆï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿä¹Ÿä¸æœƒæœ‰å¤ªå¤šçš„å•é¡Œ\nç¾ä»£çš„é™„è¼‰å‡è¡¡å™¨å¤šåŠéƒ½èƒ½åƒå¾Œç«¯åšå¯ç”¨æ€§æª¢æ¸¬ (health check)ï¼Œå¯ä»¥æŠŠæµé‡å°å‘å·¥ä½œæ­£å¸¸çš„ç¯€é»ï¼Œå¦‚æœå¾Œç«¯çš„è™›æ“¬æ©Ÿè¢«è³‡æ–™ä¸­å¿ƒæ”¶å›äº†ï¼Œæµé‡ä¹Ÿæœƒç§»è½‰åˆ°å…¶ä»–ç¯€é»ä¸Šï¼Œä¸æœƒéºå¤±ç”¨æˆ¶è«‹æ±‚ é…åˆè‡ªå‹•æ°´å¹³æ‹“å±•å·¥å…· (Auto horizontal scaler)ï¼Œå¯ä»¥è¨­å®šæœŸæœ›çš„æœå‹™ç¯€é»æ•¸é‡ï¼Œå¦‚æœè³‡æ–™ä¸­å¿ƒå›æ”¶å…ˆå ç¯€é»ï¼Œæ‹“å±•å·¥å…·å¯ä»¥åŒæ™‚å»å–å¾—æ–°çš„å…ˆå ç¯€é»ï¼Œæˆ–æ˜¯å–å¾—éš¨é¸éš¨ç”¨çš„è™›æ“¬æ©Ÿ é…åˆæµé‡ç›£æ¸¬ï¼Œä¹Ÿå¯ä»¥å‹•æ…‹èª¿æ•´æœŸæœ›çš„æœå‹™ç¯€é»æ•¸é‡ï¼Œä¾‹å¦‚ï¼šåµæ¸¬åˆ°å¤§é‡ç”¨æˆ¶é€£ç·šæ•¸æ™‚ï¼Œå¢åŠ æ›´å¤šæœå‹™ç¯€é»ï¼Œå¾…æµé‡ä¸‹é™å¾Œï¼Œå†é™ä½æœå‹™ç¯€é»æ•¸é‡ é€™æ¨£çš„è¨­è¨ˆå¯¦å‹™ä¸Šæœ‰å¹¾é»æ³¨æ„\né›–ç„¶èªªæ‡‰ç”¨å¾Œç«¯æœ¬èº«æ˜¯ç„¡ç‹€æ…‹çš„ï¼Œä½†é¢å°ç”¨æˆ¶ä¹Ÿè¨±é‚„æ˜¯æœƒæœ‰éƒ¨åˆ†ç‹€æ…‹å­˜åœ¨æ‡‰ç”¨å¤–éƒ¨ï¼Œä¾‹å¦‚ï¼šUser sessionï¼Œæˆ–æ˜¯ websocket çš„é•·é€£ç·šã€‚ç‰¹åˆ¥æ³¨æ„é€™äº›æœå‹™æ–·ç·šçš„æ™‚å€™ï¼Œå°æ–¼ä½¿ç”¨è€…çš„å½±éŸ¿ï¼Œé…åˆå‰ç«¯å¢å¼·ä½¿ç”¨è€…é«”é©— å¾Œç«¯æ°´å¹³æ‹“å±•å¾Œï¼Œç“¶é ¸æœƒè½‰ç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œä¾‹å¦‚ Database æˆç‚ºæ•ˆèƒ½ç“¶é ¸ï¼Œæ‡‰ç”¨é€™é‚Šéœ€è¦åšä¸€å®šç¨‹åº¦çš„è‡ªå¾‹( ex. connection limitï¼Œrate limit)ï¼Œé¿å…ä¸æ–·å¢é•·çš„æ‡‰ç”¨å£“å®ä¾è³´çš„æœå‹™ï¼Œå¦‚ MessageQueue æˆ–æ˜¯ Database åˆ†æ•£å¼çš„å„²å­˜ä¸­å¿ƒ (distributed DB)ï¼Œå¦‚ï¼šcassandra æˆ–æ˜¯å°å¼· DBã€‚è€Œé€™æ¨£é¡å‹çš„æœå‹™ï¼Œæ˜¯å¦é©åˆæ”¾åœ¨å…ˆå ç¯€é»ä¸Šï¼Ÿ\n","date":1600925952,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"d179df620641a513191bb3e0445ce8f4","permalink":"https://chechia.net/zh-hant/post/2020-09-24-gcp-preemptible-instance-requirement/","publishdate":"2020-09-24T13:39:12+08:00","relpermalink":"/zh-hant/post/2020-09-24-gcp-preemptible-instance-requirement/","section":"post","summary":"éœ€æ±‚è¦åŠƒ ä½¿ç”¨å…ˆå ç¯€é»æ¯”èµ·ä½¿ç”¨ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿï¼Œæœƒå¤šå‡ºè¨±å¤šæŠ€è¡“å›°é›£éœ€è¦å…‹æœï¼Œåªæœ‰ç¯€çœä¸‹çš„æˆæœ¬å¤§æ–¼æ•´é«”æŠ€è¡“æˆæœ¬æ™‚ï¼Œæˆ‘å€‘æ‰æœƒé¸ç”¨å…ˆå ç¯€é»ã€‚å› æ­¤é€™é‚Šè¦é€²è¡Œæˆæœ¬ç²¾ç®—ï¼Œé‡æ–°èª¿æ•´çš„æ¶æ§‹ä¸‹ï¼Œå¯¦éš›åˆ°åº•èƒ½çœå¤šå°‘éŒ¢ã€‚å‹™å¿…ä½¿ç”¨ Google Cloud Pricing Calculator ç²¾ç®—æˆæœ¬ã€‚\nå¦å¤–ï¼Œé›–ç„¶å…ˆå è™›æ“¬æ©Ÿæœƒæœ‰å¾ˆå¤šé¡å¤–çš„é™åˆ¶èˆ‡æŠ€è¡“å›°é›£ï¼Œä½†å¯¦å‹™ä¸Šé‚„æ˜¯è¦å°æ¯”å¯¦éš›çš„éœ€æ±‚ï¼Œæœ‰äº›é™åˆ¶èˆ‡éœ€æ±‚æ˜¯è¡çªçš„ï¼Œæœ‰äº›é™åˆ¶å‰‡å®Œå…¨ä¸æœƒå½±éŸ¿æˆ‘å€‘çš„éœ€æ±‚ã€‚å‰è€…ç•¶ç„¶æœƒå¸¶çµ¦æˆ‘å€‘è¼ƒé«˜çš„å°å…¥é›£åº¦ï¼Œå¾Œè€…å¯èƒ½æœƒéå¸¸è¼•é¬†ã€‚\né€™é‚Šæƒ³çµ¦å¤§å®¶çš„æ¦‚å¿µæ˜¯ï¼Œå‹™å¿…å…ˆæ˜ç¢ºéœ€æ±‚ï¼Œå†è¨è«–æŠ€è¡“ã€‚é€™é»å¾ˆé‡è¦ï¼ŒæŠ€è¡“çš„é©ç”¨èˆ‡å¦ï¼Œä¸æ˜¯ç”±å€‹äººçš„å–œå¥½æ±ºå®šï¼Œå”¯ä¸€çš„åˆ¤æ–·æ¨™æº–ï¼Œæ˜¯èƒ½ä¸èƒ½æœ‰æ•ˆç‡çš„æ»¿è¶³éœ€æ±‚ã€‚\næ‰€ä»¥é€™é‚Šå…ˆå®šç¾©æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\nåŸ·è¡ŒçŸ­æœŸçš„ batch job åŸ·è¡Œé•·æœŸçš„ user-facing API server åŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº« Batch Job å¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\nä½¿ç”¨ç¶²è·¯çˆ¬èŸ² (crawler) å»æŠ“å–è¨±å¤šç¶²ç«™çš„æ‰€æœ‰å…§å®¹ ä½¿ç”¨ GPU é€²è¡Œæ©Ÿå™¨å­¸ç¿’çš„ Model Training å¤§æ•¸æ“šè¨ˆç®— MapReduce é€™äº›ä»»å‹™çš„æ ¸å¿ƒéœ€æ±‚ï¼Œå¾ˆç°¡å–®ç›´æ¥","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance Requirement","type":"post"},{"authors":[],"categories":null,"content":"å…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢æµç¨‹ (Preemption process) å­æ›°ï¼šæœªçŸ¥ç”Ÿç„‰çŸ¥æ­»ã€‚ä½†åšå·¥ç¨‹å¸«è¦åéä¾†ï¼Œè€ƒé‡æœ€å·®æƒ…å½¢ï¼Œä¹Ÿå°±æ˜¯è¦çŸ¥é“æ‡‰ç”¨å¯èƒ½å¦‚ä½•æ­»å»ã€‚ä¸çŸ¥é“æ‡‰ç”¨å¯èƒ½æ€éº¼æ­»ï¼Œåˆ¥èªªä½ çŸ¥é“æ‡‰ç”¨æ´»å¾—å¥½å¥½çš„ï¼Œå¤§æ¦‚æƒ³è¡¨é”é€™éº¼æ„æ€ã€‚\né€™å°å…ˆå è™›æ“¬æ©Ÿä¾†èªªç‰¹åˆ¥é‡è¦ï¼Œä¸€èˆ¬æ‡‰ç”¨é¢å°çš„æ©Ÿå™¨æ•…éšœæˆ–æ˜¯æ©Ÿå™¨çµ‚æ­¢ï¼Œåœ¨ä½¿ç”¨å…ˆå è¥¿ä½ å¹¾çš„ç‹€æ³ä¸‹ï¼Œè®Šæˆæ¯æ—¥çš„å¿…ç„¶ï¼Œå› æ­¤ï¼Œéœ€è¦å°æ‡‰ç”¨çš„çµ‚æ­¢æƒ…å¢ƒï¼Œèˆ‡çµ‚æ­¢æµç¨‹æœ‰æ›´ç²¾ç´°çš„æŒæ§ã€‚å¦‚åŒå‰å¹¾ç¯‡æ‰€èªªçš„ï¼Œå…ˆå è™›æ“¬æ©Ÿæœƒè¢«å…¬æœ‰é›²æ”¶å›ï¼Œä½†æ”¶å›çš„æ™‚å€™ä¸æœƒçªç„¶æ©Ÿå™¨å°± ben ä¸è¦‹ï¼Œæœƒæœ‰ä¸€å€‹å›ºå®šçš„æµç¨‹ã€‚\nå¦‚æœä½ çš„æ‡‰ç”¨å·²ç¶“å¸¶æœ‰å¯å®¹éŒ¯çš„æ©Ÿåˆ¶ï¼Œèƒ½å¤ æ‰¿å—æ©Ÿå™¨çªç„¶è®Šä¸è¦‹ï¼Œæœå‹™é‚„å¥½å¥½çš„ï¼Œä»ç„¶è¦èŠ±æ™‚é–“ç†è§£é€™é‚Šçš„æµç¨‹ï¼Œè—‰æ­¤ç²¾ç®—æ¯å¤©è™›æ“¬æ©Ÿçš„çµ‚æ­¢èˆ‡æ›¿æ›ï¼šæ‡‰ç”¨æœƒæœ‰ä»€éº¼åæ‡‰ï¼Œæœƒç”¢ç”Ÿå¤šå°‘è¡æ“Šï¼Œç¨å¾Œå¯ä»¥é‡åŒ–æœå‹™çš„å½±éŸ¿ã€‚ä¾‹å¦‚\næ‡‰ç”¨é‡å•Ÿåˆå§‹åŒ–æ™‚ cpu memory çªç„¶æ‹‰é«˜ æ‰¿å—ç¯€é»éŒ¯èª¤å¾Œçš„å¾©åŸæµç¨‹ï¼Œéœ€è¦æ¶ˆè€—é¡å¤–ç®—åŠ›ã€‚ä¾‹å¦‚éœ€è¦å¾ä¸Šå€‹ checkpoint æ¥çºŒåšï¼Œéœ€è¦å»è®€å–è³‡æ–™é€ æˆ IOï¼Œæˆ–æ˜¯è³‡æ–™éœ€è¦åš rebalance â€¦ç­‰ç­‰ å¦‚æœä½ çš„æ‡‰ç”¨éœ€è¦æœ‰ graceful shutdown çš„æ©Ÿåˆ¶ï¼Œé‚£ä½ å‹™å¿…è¦ç´°å¿ƒç†è§£é€™é‚Šçš„æ­¥é©Ÿã€‚ä¸¦ä»”ç´°å®‰æ’å®‰å…¨ä¸‹æ¨çš„æ­¥é©Ÿã€‚åˆæˆ–æ˜¯ç„¡æ³•ä¿è­‰åœ¨å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„ä½œæ¥­æ™‚é™å…§ï¼Œå®Œæˆå„ªé›…çµ‚æ­¢ï¼Œéœ€è¦è€ƒæ…®å…¶ä»–å¯èƒ½çš„å¯¦ä½œè§£æ³•ã€‚\né€™é‚Šæœ‰å¹¾å€‹é¢å‘è¦æ³¨æ„\nGCP å¦‚ä½•çµ‚æ­¢å…ˆå ç¯€é» GCP ç§»é™¤ç¯€é»å° GKE ã€ä»¥åŠåŸ·è¡Œä¸­æ‡‰ç”¨çš„å½±éŸ¿ GKE é›†ç¾¤å¦‚ä½•æ‡‰å°çš„ç¯€é»å¤±æ•ˆ GCP è‡ªå‹•èª¿åº¦è£œè¶³æ–°çš„å…ˆå ç¯€é» GKE é›†ç¾¤å¦‚ä½•æ‡‰å°ç¯€é»è£œè¶³ ä¸‰å€‹é‡é»\nå…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢å°é›†ç¾¤çš„å½±éŸ¿ Pod éš¨ä¹‹çµ‚æ­¢å°æ‡‰ç”¨çš„å½±éŸ¿ï¼Œæ˜¯å¦èƒ½å¤ å„ªé›…çµ‚æ­¢ æœ‰æ²’æœ‰æ–¹æ³•å¯ä»¥é¿å…ä¸Šé¢å…©è€…çš„å½±éŸ¿ åŠ‡é€ä¸€ä¸‹ï¼šæœ‰çš„ï¼Œæœ‰ä¸€äº›æ‹›å¼å¯ä»¥è™•ç†ã€‚è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ã€‚\nGCP å¦‚ä½•çµ‚æ­¢è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿçš„ç¡¬é«”çµ‚æ­¢æ­¥é©Ÿèˆ‡ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿç›¸åŒï¼Œæ‰€ä»¥æˆ‘å€‘è¦å…ˆç†è§£è™›æ“¬æ©Ÿçš„åœæ­¢æµç¨‹\né€™è£¡æŒ‡çš„çµ‚æ­¢ (Stop) æ˜¯è™›æ“¬æ©Ÿç”Ÿå‘½é€±æœŸ çš„ RUNNING -\u0026gt; instances.stop() -\u0026gt; STOPPING -\u0026gt; TERMINATED çš„æ­¥é©Ÿã€‚\ninstances.stop() ACPI shutdown OS æœƒé€²è¡Œ shutdown æµç¨‹ï¼Œä¸¦å˜—è©¦åŸ·è¡Œå„å€‹æœå‹™çš„çµ‚æ­¢æµç¨‹ï¼Œä»¥å®‰å…¨çš„çµ‚æ­¢æœå‹™ã€‚å¦‚æœè™›æ“¬æ©Ÿæœ‰è¨­å®šShtudown Script æœƒåœ¨é€™æ­¥é©Ÿè™•ç† ç­‰å¾…è‡³å°‘ 90 ç§’ï¼Œè®“ OS å®Œæˆçµ‚æ­¢çš„æµç¨‹ é€¾æ™‚çš„çµ‚æ­¢æµç¨‹ï¼ŒGCP æœƒç›´æ¥å¼·åˆ¶çµ‚æ­¢ï¼Œå°±ç®— shutdown script é‚„æ²’è·‘å®Œ GCP ä¸ä¿è­‰çµ‚æ­¢æ™‚é™çš„æ™‚é–“ï¼Œå®˜æ–¹å»ºè­°ä¸è¦å¯«é‡è¦çš„ä¾è³´è…³æœ¬åœ¨çµ‚æ­¢æ™‚é™å…§ è™›æ“¬æ©Ÿè®Šæˆ TERMINATED ç‹€æ…‹ GCP å¦‚ä½•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ èˆ‡éš¨é¸è™›æ“¬æ©Ÿä¸åŒ\nå…ˆå è™›æ“¬æ©Ÿçš„æ™‚é–“ 30 ç§’ æ­é… GKE ä½¿ç”¨ Managed Instance Groupï¼Œçµ‚æ­¢çš„è™›æ“¬æ©Ÿæœƒè¢«åˆªé™¤ï¼ŒAutoscaler æœƒå•Ÿå‹•æ–°çš„è™›æ“¬æ©Ÿ ä¸€æ¨£å…ˆçœ‹å…ˆå è™›æ“¬æ©Ÿçš„èªªæ˜æ–‡ä»¶ï¼šçµ‚æ­¢æµç¨‹\nè³‡æ–™ä¸­å¿ƒé–‹å§‹å›æ”¶å…ˆå è™›æ“¬æ©Ÿï¼Œé¸ä¸­æˆ‘å€‘å°ˆæ¡ˆå…¶ä¸­çš„ä¸€å°å…ˆå è™›æ“¬æ©Ÿ Compute Engine å‚³é€ ACPI G2 Soft Offï¼Œé€™è£¡ OS æœƒè©¦åœ–å®‰å…¨é—œè®Šæœå‹™ï¼Œä¹ŸæœƒåŸ·è¡Œ shutdown scriptï¼Œå¯ä»¥åšç°¡çŸ­çš„å„ªé›…çµ‚æ­¢ 30ç§’å¾Œï¼ŒACPI G3 Mechanical off ä½† 30 ç§’èƒ½åšä»€éº¼ï¼Ÿåªèƒ½å¿«é€Ÿçš„äº¤ä»£ç•¶å‰é€²åº¦ã€‚å¦‚æœæ‡‰ç”¨éœ€è¦èŠ±æ™‚é–“æ”¶å°¾ï¼Œä¿å­˜å·¥ä½œé€²åº¦ï¼Œå¯èƒ½æœƒç”¢ç”Ÿè¨±å¤šå•é¡Œ\nGCP ä¸ä¿è­‰çµ‚æ­¢æ™‚é™çš„æ™‚é–“ï¼Œå®˜æ–¹å»ºè­°ä¸è¦å¯«é‡è¦çš„ä¾è³´è…³æœ¬åœ¨çµ‚æ­¢æ™‚é™å…§ åœ¨é¢å°å¤§é‡ IO çš„å·¥ä½œï¼Œå¯èƒ½æœƒå°è‡´è€…å°è™›æ“¬æ©Ÿçš„å¤§é‡æ‡‰ç”¨ä¸€èµ·é€²å…¥å„ªé›…çµ‚æ­¢ï¼Œå…ˆå è™›æ“¬æ©Ÿæœ€å¾Œè€—ç›¡è³‡æºï¼Œä¾†ä¸åŠåšå®Œ å¦‚æœå¯èƒ½æœƒè¶…æ™‚ï¼Œæˆ–æ˜¯æ²’å®Œæˆæœƒæœ‰è³‡æ–™éºå¤±é¢¨éšªï¼Œå°±ä¸èƒ½åœ¨é€™å€‹éšæ®µè™•ç† ä¾è³´ shutdown script åšæ”¶å°¾æ˜¯å±éšªçš„ï¼Œæˆ‘å€‘ä¹‹å¾Œè¦æƒ³è¾¦æ³•è™•ç†é€™å€‹ä¸ä¿è­‰åšå®Œçš„å„ªé›…çµ‚æ­¢ã€‚\nå¦‚æœæ‡‰ç”¨æœ¬èº«æœ‰å®¹éŒ¯çš„æ¡†æ¶ï¼Œæˆ–æ˜¯æœ‰å®¹éŒ¯æ©Ÿåˆ¶ï¼Œæˆ‘å€‘é€™é‚Šè¦é¡å¤–åšçš„å·¥ä½œå°±æœƒå°‘å¾ˆå¤šã€‚ä¾‹å¦‚è¨±å¤šç¨‹å¼æ¡†æ¶æä¾›è‡ªå‹•é‡å•Ÿçš„åŠŸèƒ½ï¼Œåœ¨å¤–éƒ¨ä¿å­˜ checkpointï¼Œworker åªè² è²¬é‹ç®—ï¼Œçµ‚æ­¢ä¿¡è™Ÿä¸€é€²ä¾†ï¼Œä¹Ÿä¸ç”¨ä¿å­˜ï¼Œç›´æ¥æ‹‹æ£„æœªå®Œæˆçš„å·¥ä½œé€²åº¦ï¼Œç•™å¾…ç¹¼èµ·çš„ worker å¾ checkpoint æ¥æ‰‹ã€‚\nPreemption selection é™¤äº† 24 å°æ™‚çš„å£½å‘½é™åˆ¶æœƒçµ‚æ­¢è™›æ“¬æ©Ÿï¼Œè³‡æ–™ä¸­å¿ƒçš„äº‹ä»¶ä¹Ÿæœƒè§¸ç™¼ä¸»å‹•çš„è™›æ“¬æ©Ÿå›æ”¶ï¼Œç”± GCP ä¸»å‹•è§¸ç™¼çš„å›æ”¶æ©Ÿåˆ¶æ©Ÿç‡å¾ˆä½ï¼Œæœƒæ ¹æ“šæ¯æ—¥æ¯å€‹å€åŸŸ (zone)Â çš„ç‹€æ…‹è€Œå®šã€‚é€™è£¡æè¿°è³‡æ–™ä¸­å¿ƒå•Ÿå‹•çš„è‡¨æ™‚å›æ”¶ã€‚\nGCP ä¸æœƒæŠŠæ‰€ä½ æ‰‹ä¸Šçš„ preemptible æ©Ÿå™¨éƒ½æ”¶èµ°ï¼Œè€Œæ˜¯ä¾ç…§ä¸€å®šçš„è¦å‰‡ï¼Œé¸æ“‡ä¸€å€‹æ¯”ä¾‹æ’¤æ›çš„æ©Ÿå™¨ã€‚\nå…ˆçœ‹æ–‡ä»¶æ•˜è¿°\nCompute Engine æœƒé¿å…å¾å–®ä¸€å®¢æˆ¶ç§»é™¤å¤ªå¤šå…ˆå è™›æ“¬æ©Ÿ å„ªå…ˆç§»é™¤æ–°çš„è™›æ“¬æ©Ÿï¼Œåå‘ä¿ç•™èˆŠçš„è™›æ“¬æ©Ÿ (ä½†æœ€å¤šä»æ´»ä¸é 24hr) é–‹å•Ÿå¾Œé¦¬ä¸Šè¢«ç§»é™¤çš„å…ˆå è™›æ“¬æ©Ÿä¸è¨ˆè²» æ©Ÿå™¨å°ºå¯¸è¼ƒå°çš„æ©Ÿå™¨ï¼Œå¯ç”¨æ€§è¼ƒé«˜ã€‚ä¾‹å¦‚ï¼š16 cpu çš„å…ˆå è™›æ“¬æ©Ÿï¼Œæ¯” 128 cpu çš„å…ˆå è™›æ“¬æ©Ÿå®¹æ˜“å–å¾— GCP æ¯å¤©å¹³å‡æœƒç§»é™¤ä¸€å€‹å°ˆæ¡ˆä¸­ 5% - 15% çš„è™›æ“¬æ©Ÿï¼Œå¾ç”¨æˆ¶çš„è§’åº¦æˆ‘å€‘éœ€è¦é æœŸè‡³å°‘é€™å€‹ç¨‹åº¦çš„å›æ”¶ã€‚ä¸éé€™å€‹æ¯”ä¾‹ï¼ŒGCP ä¹Ÿä¸çµ¦äºˆä»»ä½•ä¿è­‰ã€‚ä»¥ç­†è€…ç¶“é©—ï¼Œåªèƒ½èªªçµ•å¤§éƒ¨åˆ†çš„æ™‚å€™ï¼Œéƒ½ä¸æœƒæ“”å¿ƒè¶…éé€™å€‹æ¯”ä¾‹çš„å›æ”¶ï¼Œä½†æ˜¯é‚„æ˜¯è¦åšå¥½æœ€å£çš„æ‰“ç®—ï¼Œå¦‚æœè‡¨æ™‚ç„¡æ³•å–å¾—è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿï¼Œè¦æœ‰æ–¹æ³•æš«æ™‚è£œè¶³éš¨é¸è™›æ“¬æ©Ÿã€‚\nGKE ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿæœƒé•å Kubernetes çš„è¨­è¨ˆ\nPod grace period æœƒè¢«å¿½ç•¥ Pod disreuption budgetï¼Œä¸æœƒè¢«éµå®ˆ (å¯èƒ½æœƒè¶…é) å°æ‡‰ç”¨çš„å½±éŸ¿ GCP è§¸ç™¼çš„ Preemptible processï¼Œå°æ‡‰ç”¨çš„å½±éŸ¿\ninvoluntary disruptionsï¼ŒGCP é€ ACPI G2 Soft Off OS çµ‚æ­¢æœå‹™ï¼ŒåŒ…å«åŸ·è¡Œ Kubernetes çš„ container runtime å®¹å™¨å…§çš„æ‡‰ç”¨æœƒæ”¶åˆ° SIGTERMï¼Œå•Ÿå‹• graceful shutdown Kubernetes æä¾›çš„ Graceful-shutdown å¯èƒ½æœƒè·‘ä¸å®Œ å¯¦å‹™ä¸Šåªæ˜¯ä¸­æ–·ç•¶å‰å·¥ä½œ https://cloud.google.com/solutions/scope-and-size-kubernetes-engine-clusters\nå¤§é‡ç¯€é»åŒæ™‚å›æ”¶ ç”±æ–¼ GCP ä¸¦ä¸ä¿è­‰æ”¶å›çš„æ©Ÿå™¨çš„æ•¸é‡ï¼ŒåŒæ™‚å›æ”¶çš„æ©Ÿå™¨é‡å¤§ï¼Œé‚„æ˜¯æœƒè¡æ“Šåˆ°æœå‹™ã€‚ä¾‹å¦‚ï¼šä¸€æ¬¡æ”¶å› 15% çš„ç®—åŠ›ï¼Œç•¶ç„¶æœå‹™é‚„æ˜¯æœƒå—åˆ°è¡æ“Šã€‚ç•¶ç„¶é€™æ¨£äº‹ä»¶çš„æ©Ÿç‡ä¸¦ä¸é«˜ï¼Œä½†æˆ‘å€‘ä»æ˜¯éœ€è¦ç‚ºæ­¤æ‰“ç®—ã€‚é€™é‚Šæœ‰å¹¾å€‹åšæ³•\né ç•™æ›´å¤šçš„ç®—åŠ› ä½¿ç”¨ regional clusterï¼Œåœ¨å¤šå€‹ zone ä¸Šåˆ†é…å…ˆå è™›æ“¬æ©Ÿ æˆ‘å€‘è‡ªè¡Œæ§åˆ¶ï¼Œæå‰ä¸»å‹•å›æ”¶è™›æ“¬æ©Ÿ é ç•™æ›´å¤šè³‡æº é€™é»å¾ˆç›´è§€ï¼Œç”±æ–¼ä½¿ç”¨äº†æ›´åŠ ä¾¿å®œçš„æ©Ÿå™¨ï¼Œæˆ‘å€‘å¯ä»¥ç”¨åŒæ¨£çš„æˆæœ¬ï¼Œé–‹æ›´å¤šçš„æ©Ÿå™¨ã€‚\né€€ä¸€æ­¥èªªï¼Œä½¿ç”¨æ‰“ä¸‰æŠ˜çš„å…ˆå è™›æ“¬æ©Ÿï¼Œç„¶å¾Œé–‹åŸæœ¬å…©å€çš„æ©Ÿå™¨æ•¸é‡\nç¸½æˆæœ¬æ˜¯ 0.3 * 2 = 0.6 å€ åŒæ™‚é–“å¯ç”¨è³‡æºæ˜¯ 2 å€ ç”±æ–¼å…ˆå ç¯€é»å›æ”¶çš„å–®ä½æ˜¯ä¸€å€‹ä¸€å€‹è™›æ“¬æ©Ÿ\nå®‰æ’åˆé©çš„æ©Ÿå™¨å°ºå¯¸ å°ºå¯¸è¼ƒå°çš„å…ˆå è™›æ“¬æ©Ÿï¼Œå¯ç”¨æ€§è¼ƒé«˜ã€‚æ„æ€æ˜¯é›¶ç¢çš„å…ˆå è™›æ“¬æ©Ÿå®¹æ˜“å–å¾— ä½†ç•¶ç„¶ä¹Ÿä¸èƒ½éƒ½é–‹å¤ªå°çš„æ©Ÿå™¨ï¼Œé€™æœƒåš´é‡å½±éŸ¿æ‡‰ç”¨çš„åˆ†é…ã€‚è‡³æ–¼å…·é«”éœ€è¦é–‹å¤šå¤§ï¼Œå¯ä»¥æ ¹æ“šé è¨ˆåœ¨æ©Ÿå™¨ä¸Šé‹è¡Œçš„æ‡‰ç”¨ï¼Œåšç¶œåˆè€ƒé‡ï¼Œä¾‹å¦‚æœ‰ä»¥ä¸‹å½±ç”¨éœ€è¦åŸ·è¡Œï¼š\napp A: 1 cpu 5 replica app B: 3 cpu 5 replica app C: 5 cpu 5 replica ç¸½å…±è‡³å°‘ 45 cpu ï¼Œé æœŸæ©Ÿå™¨è² è¼‰8 æˆçš„è©±ï¼Œéœ€è¦ç¸½å…± 45 / 0.8 = 56 cpuã€‚ä¹Ÿè¨±å¯ä»¥è€ƒæ…®\n8 cpu * 7 å…ˆå è™›æ“¬æ©Ÿ 4 cpu * 14 ä¹Ÿèˆ‰å¹¾å€‹æ¥µç«¯ä¸å¯è¡Œçš„ä¾‹å­\n56 cpu * 1 é€™æ¨£çš„è™›æ“¬æ©Ÿå›æ”¶æ™‚çš„å½±éŸ¿ç¯„åœ (blast radius) å°±æ˜¯ 100% æœå‹™ 1 cpu * 56 æ©Ÿå™¨å¤ªç‘£ç¢ï¼Œå¯èƒ½è¶…å‡º Qouta (ç¯€é»æ•¸é‡ï¼ŒIP æ•¸é‡â€¦) æ‡‰ç”¨æœƒæ›´åˆ†æ•£ï¼Œç¯€é»é–“çš„å…§éƒ¨ç¶²è·¯æµé‡æœƒå¢åŠ  å‰å¹¾ç¯‡æåˆ°çš„ reserved resource æ¯”ä¾‹é«˜ï¼Œæœƒå½±éŸ¿æ‡‰ç”¨çš„éƒ¨ç½² å¦‚æœå¸Œæœ›æ›´ä¿éšªï¼Œå¯ä»¥å†è£œä¸Šéš¨é¸è™›æ“¬æ©Ÿæ··åˆæ­é…ï¼Œä¾‹å¦‚\n8 cpu * 7 5 å…ˆå è™›æ“¬æ©Ÿ 2 éš¨é¸è™›æ“¬æ©Ÿ 4 cpu * 14 10 å…ˆå è™›æ“¬æ©Ÿ 4 éš¨é¸è™›æ“¬æ©Ÿ è™›æ“¬æ©Ÿå€åŸŸ è™›æ“¬æ©Ÿçš„å›æ”¶è§¸ç™¼ï¼Œä¹Ÿæ˜¯æœƒä¾æ“šæœå‹™çš„å€åŸŸ (zone) å›æ”¶ã€‚æ„æ€æ˜¯ç¯€é»å›æ”¶ä¸æœƒåŒæ™‚è§¸ç™¼ asia-east1 ä¸­æ‰€æœ‰ zone çš„ç¯€é»å›æ”¶ï¼Œä¸€èˆ¬ä¾†èªªæ™‚é–“æ˜¯éŒ¯é–‹çš„ (ä¸éGCP ä¹Ÿä¸ä¿è­‰é€™é» XD)ã€‚ç‚ºäº†ç¶­æŒ GKE çš„å¯ç”¨æ€§ï¼Œæˆ‘å€‘éƒ½æœƒé–‹å¤šå€‹ node-pool åœ¨å¤šå€‹å€åŸŸä¸‹ã€‚\nç¸½ä¹‹é¿å…æŠŠæ©Ÿå™¨éƒ½æ”¾åœ¨åŒå€‹å€åŸŸä¸­ã€‚\nè‡ªè¡Œæ§åˆ¶çš„è™›æ“¬æ©Ÿæ±°æ› ç°¡å–®ä¾†èªªæˆ‘å€‘åœ¨ 24 hr æœŸé™ä¹‹å‰ï¼Œå…ˆåˆ†æ‰¹è‡ªç›¡ XDï¼Œæ‰“æ•£å€‹å„å€‹è™›æ“¬æ©Ÿçš„ 24 å°æ™‚é™åˆ¶ã€‚\nä½¿ç”¨é€™å€‹æœ‰è¶£çš„å·¥å…· estafette-gke-preemptible-killerï¼Œè‡ªå‹•æ±°æ›å…ˆå è™›æ“¬æ©Ÿï¼Œè®“æ•´å€‹ç¹¼èµ·è™›æ“¬æ©Ÿéƒ½åˆ†æ•£åœ¨ 24 å°æ™‚é–“ã€‚\nestafette-gke-preemptible-killer ï¼Œä½¿ç”¨ä¸Šç°¡å–®ï¼Œå¤§å®¶è‡ªå·±çœ‹è‘—è¾¦ XDã€‚å¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œç•™è¨€çš„äººå¤šçš„è©±ï¼Œæˆ‘å†å¦å¤–é–‹ä¸€ç¯‡ç´°è¬›ã€‚\nå°çµ ç‚ºäº†ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œæˆ‘å€‘è¦å¤šåšä»¥ä¸‹å¹¾ä»¶äº‹\nç‚ºæ‡‰ç”¨è¨­è¨ˆå¯å®¹éŒ¯åˆ†æ•£å¼æ¶æ§‹ï¼Œä¾‹å¦‚æ‡‰ç”¨å¯ä»¥åŒæ™‚åŸ·è¡Œä¸€æ¨£çš„ API server 3 å€‹ replica åˆ†æ•£ Pod åˆ°åˆé©çš„æ©Ÿå™¨ä¸Šï¼Œä¾‹å¦‚è¨­ç½® PodAntiAffinity è¨­å®šåˆé©çš„è™›æ“¬æ©Ÿå¤§å°ï¼Œåˆé©çš„åˆ†æ•£æ‡‰ç”¨ ä½¿ç”¨ estafette-gke-preemptible-killerï¼Œè‡ªå‹•æ±°æ›å…ˆå è™›æ“¬æ©Ÿ ä¸ä¾è³´æ‡‰ç”¨çš„ Graceful-shutdown æµç¨‹ ","date":1600849394,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"f8a9bd9ab0bd2bef9c340229ff9d702a","permalink":"https://chechia.net/zh-hant/post/2020-09-23-gcp-preemptible-instance-speficication/","publishdate":"2020-09-23T16:23:14+08:00","relpermalink":"/zh-hant/post/2020-09-23-gcp-preemptible-instance-speficication/","section":"post","summary":"å…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢æµç¨‹ (Preemption process) å­æ›°ï¼šæœªçŸ¥ç”Ÿç„‰çŸ¥æ­»ã€‚ä½†åšå·¥ç¨‹å¸«è¦åéä¾†ï¼Œè€ƒé‡æœ€å·®æƒ…å½¢ï¼Œä¹Ÿå°±æ˜¯è¦çŸ¥é“æ‡‰ç”¨å¯èƒ½å¦‚ä½•æ­»å»ã€‚ä¸çŸ¥é“æ‡‰ç”¨å¯èƒ½æ€éº¼æ­»ï¼Œåˆ¥èªªä½ çŸ¥é“æ‡‰ç”¨æ´»å¾—å¥½å¥½çš„ï¼Œå¤§æ¦‚æƒ³è¡¨é”é€™éº¼æ„æ€ã€‚\né€™å°å…ˆå è™›æ“¬æ©Ÿä¾†èªªç‰¹åˆ¥é‡è¦ï¼Œä¸€èˆ¬æ‡‰ç”¨é¢å°çš„æ©Ÿå™¨æ•…éšœæˆ–æ˜¯æ©Ÿå™¨çµ‚æ­¢ï¼Œåœ¨ä½¿ç”¨å…ˆå è¥¿ä½ å¹¾çš„ç‹€æ³ä¸‹ï¼Œè®Šæˆæ¯æ—¥çš„å¿…ç„¶ï¼Œå› æ­¤ï¼Œéœ€è¦å°æ‡‰ç”¨çš„çµ‚æ­¢æƒ…å¢ƒï¼Œèˆ‡çµ‚æ­¢æµç¨‹æœ‰æ›´ç²¾ç´°çš„æŒæ§ã€‚å¦‚åŒå‰å¹¾ç¯‡æ‰€èªªçš„ï¼Œå…ˆå è™›æ“¬æ©Ÿæœƒè¢«å…¬æœ‰é›²æ”¶å›ï¼Œä½†æ”¶å›çš„æ™‚å€™ä¸æœƒçªç„¶æ©Ÿå™¨å°± ben ä¸è¦‹ï¼Œæœƒæœ‰ä¸€å€‹å›ºå®šçš„æµç¨‹ã€‚\nå¦‚æœä½ çš„æ‡‰ç”¨å·²ç¶“å¸¶æœ‰å¯å®¹éŒ¯çš„æ©Ÿåˆ¶ï¼Œèƒ½å¤ æ‰¿å—æ©Ÿå™¨çªç„¶è®Šä¸è¦‹ï¼Œæœå‹™é‚„å¥½å¥½çš„ï¼Œä»ç„¶è¦èŠ±æ™‚é–“ç†è§£é€™é‚Šçš„æµç¨‹ï¼Œè—‰æ­¤ç²¾ç®—æ¯å¤©è™›æ“¬æ©Ÿçš„çµ‚æ­¢èˆ‡æ›¿æ›ï¼šæ‡‰ç”¨æœƒæœ‰ä»€éº¼åæ‡‰ï¼Œæœƒç”¢ç”Ÿå¤šå°‘è¡æ“Šï¼Œç¨å¾Œå¯ä»¥é‡åŒ–æœå‹™çš„å½±éŸ¿ã€‚ä¾‹å¦‚\næ‡‰ç”¨é‡å•Ÿåˆå§‹åŒ–æ™‚ cpu memory çªç„¶æ‹‰é«˜ æ‰¿å—ç¯€é»éŒ¯èª¤å¾Œçš„å¾©åŸæµç¨‹ï¼Œéœ€è¦æ¶ˆè€—é¡å¤–ç®—åŠ›ã€‚ä¾‹å¦‚éœ€è¦å¾ä¸Šå€‹ checkpoint æ¥çºŒåšï¼Œéœ€è¦å»è®€å–è³‡æ–™é€ æˆ IOï¼Œæˆ–æ˜¯è³‡æ–™éœ€è¦åš rebalance â€¦ç­‰ç­‰ å¦‚æœä½ çš„æ‡‰ç”¨éœ€è¦æœ‰ graceful shutdown çš„æ©Ÿåˆ¶ï¼Œé‚£ä½ å‹™å¿…è¦ç´°å¿ƒç†è§£é€™é‚Šçš„æ­¥é©Ÿã€‚ä¸¦ä»”ç´°å®‰æ’å®‰å…¨ä¸‹æ¨çš„æ­¥é©Ÿã€‚åˆæˆ–æ˜¯ç„¡æ³•ä¿è­‰åœ¨å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„ä½œæ¥­æ™‚é™å…§ï¼Œå®Œæˆå„ªé›…çµ‚æ­¢ï¼Œéœ€è¦è€ƒæ…®å…¶ä»–å¯èƒ½çš„å¯¦ä½œè§£æ³•ã€‚\né€™é‚Šæœ‰å¹¾å€‹é¢å‘è¦æ³¨æ„\nGCP å¦‚ä½•çµ‚æ­¢å…ˆå ç¯€é» GCP ç§»é™¤ç¯€é»å° GKE ã€ä»¥åŠåŸ·è¡Œä¸­æ‡‰ç”¨çš„å½±éŸ¿ GKE é›†ç¾¤å¦‚ä½•æ‡‰å°çš„ç¯€é»å¤±æ•ˆ GCP è‡ªå‹•èª¿åº¦è£œè¶³æ–°çš„å…ˆå ç¯€é» GKE é›†ç¾¤å¦‚ä½•æ‡‰å°ç¯€é»è£œè¶³ ä¸‰å€‹é‡é»","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance Speficication","type":"post"},{"authors":[],"categories":null,"content":"æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\nåŸ·è¡ŒçŸ­æœŸçš„ batch job åŸ·è¡Œé•·æœŸçš„ user-facing API server åŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº« è©²ä¸è©²åœ¨ Kubernetes ä¸Šé¢è·‘ databaseï¼Ÿ\nTL;DR ï¼Œå¦‚æœä½ å‰›é–‹å§‹è€ƒæ…®é€™ä»¶äº‹ï¼Œé€šå¸¸çš„ç­”æ¡ˆéƒ½æ˜¯å¦å®šçš„\nç­‰ç­‰ï¼Œæˆ‘å€‘é€™é‚Šä¸æ˜¯è¨è«–è©²ä¸è©²ä¸Š Kuberentes ï¼Œè€Œæ˜¯è©²ä¸è©²ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå§ã€‚ç„¶è€Œç”±æ–¼å…ˆå è™›æ“¬æ©Ÿç¯€é»çš„è«¸å¤šé™åˆ¶ï¼Œå…‰æ†‘å…ˆå è™›æ“¬æ©Ÿä¸¦ä¸é©åˆè·‘ä»»ä½•æŒä¹…æ€§çš„å„²å­˜åº«ã€‚æˆ‘å€‘é€™é‚Šä»°è³´ Kubernetes çš„ç¶²è·¯åŠŸèƒ½ (e.g. æœå‹™ç™¼ç¾)ï¼Œèˆ‡è‡ªå‹•ç®¡ç† (e.g. health checkï¼ŒHPAï¼Œauto-scaler)ï¼ŒåŸºæ–¼å…ˆå è™›æ“¬æ©Ÿï¼Œå»ºæ§‹é«˜å¯ç”¨æ€§çš„æœå‹™æ¶æ§‹ï¼Œä¾†æ”¯æ’é«˜å¯ç”¨ï¼Œä¸”æœ‰ç‹€æ…‹çš„çš„å„²å­˜åº«ã€‚\næ‡‰ç”¨æ˜¯å¦é©åˆéƒ¨ç½²åˆ° Kubernetes ä¸Šï¼Œå¯ä»¥çœ‹é€™ç¯‡ Google Blog: To run or not to run a database on Kubernetes: What to considerï¼Œå¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œå†ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å†é€²è¡Œä¸­æ–‡ç¿»è­¯ã€‚\næ–‡ä¸­é‡å°ä¸‰å€‹å¯èƒ½çš„æ–¹æ¡ˆåšåˆ†æï¼Œä»¥ MySQL ç‚ºä¾‹ï¼š\nSassï¼ŒGCP çš„ Cloud SQL æœ€ä½çš„ç®¡ç†ç¶­é‹æˆæœ¬ è‡ªæ¶ MySQL åœ¨ GCP çš„ VM ä¸Šï¼Œè‡ªè¡Œç®¡ç† è‡ªè² å®Œå…¨çš„ç®¡ç†è²¬ä»»ï¼ŒåŒ…å«å¯ç”¨æ€§ï¼Œå‚™ä»½ (backup)ï¼Œä»¥åŠå®¹éŒ¯ç§»è½‰ (failover) è‡ªæ¶ MySQL åœ¨ Kubernetes ä¸Š è‡ªè² å®Œå…¨çš„ç®¡ç†è²¬ä»» Kubernetes çš„è¤‡é›œæŠ½è±¡å±¤ï¼ŒæœƒåŠ é‡ç¶­é‹å·¥ä½œçš„è¤‡é›œç¨‹åº¦ ç„¶è€Œ RDBMS çš„æä¾›å•†ï¼Œè‡ªå®¶ä¹Ÿæä¾› Operator\nOracle è‡ªå®¶æä¾›çš„ MySQL Operator CrunchyData ä¹Ÿæœ‰æä¾›çš„ Postgres Operator ä½ å°±æƒ³ï¼Œæ‰€ä»¥é€™äº›äººæ˜¯æƒ³æ€æ¨£ï¼ŒRDBMS æ”¾ Kubernetes ä¸Šåˆ°åº•æ˜¯è¡Œä¸è¡Œ XDã€‚Google çš„æ–‡ç« èªªæ˜ï¼šå¦‚æœæ‡‰ç”¨æœ¬èº«ä¸¦ä¸ç¬¦åˆ Kubernetes çš„å·¥ä½œæµç¨‹ (Pod life-cycle)ï¼Œå¯ä»¥é€éä¸Šè¿°çš„ Operator ä¾†è‡ªå‹•åŒ–è¨±å¤šç¶­é‹çš„ä½œæ¥­ï¼Œé™ä½ç¶­é‹çš„å›°é›£ã€‚\nç„¶è€Œ DB æœ‰åƒç™¾ç¨®ï¼Œé™¤äº† RDBMS ä»¥å¤–ï¼Œé‚„æœ‰å¦å¤–ä¸€æ‰¹ Database å¤©ç”Ÿå°±å…·æœ‰åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œé€™äº›å„²å­˜åº«éƒ¨ç½²åˆ° Kubernetes ä¸Šï¼Œä¸¦ä¸æœƒå¤ªç—›è‹¦ (é‚„æ˜¯è¦ä»˜å‡ºä¸€å®šçš„æˆæœ¬XD)ï¼Œä½†æ˜¯å»å¯ä»¥å¾—ç›Šæ–¼ Kubernetes çš„è«¸å¤šåŠŸèƒ½ã€‚\nåº•ä¸‹æˆ‘å€‘å…ˆæ ¹æ“šåˆ†æ•£å¼çš„å„²å­˜åº«åšæ¦‚è§€æè¿°ï¼Œæœ¬ç³»åˆ—æ–‡çš„æœ€å¾Œï¼Œæœƒæ ¹æ“šæ™‚é–“ç‹€æ³ï¼Œåšå¯¦ä¾‹åˆ†äº«ï¼šCassandra æˆ–æ˜¯ CockroachDBã€‚æä¾›å„ä½ä¸€é»ç™¼æƒ³ï¼Œä¸¦æ ¹æ“šéœ€æ±‚å»é¸æ“‡éœ€è¦çš„å„²å­˜åº«\nã€Œè¡Œä¸è¡Œè¦å•ä½ è‡ªå·±äº†æ–½ä¸»ï¼ŒæŠ€è¡“ä¸Šéƒ½å¯ä»¥ï¼Œç¶­é‹ä¸Šè¦çœ‹çœ‹ä½ çš„åœ˜éšŠæœ‰æ²’æœ‰é‚£å€‹å±è‚¡åƒé€™ä»½è—¥ XDã€\nDistributed Database åº•ä¸‹éå¸¸ç²—æ·ºçš„ç°¡ä»‹åˆ†æ•£å¼å„²å­˜åº«çš„æ¦‚å¿µï¼Œæä¾›ä¸€å€‹åŸºæº–é»ï¼Œå¹«åŠ©æ¥ä¸‹ä¾†è¨è«–æ˜¯å¦å¯ä»¥ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿã€‚é€™é‚Šè¦å¼·èª¿ï¼Œå„²å­˜åº«çš„é¡å‹åƒç™¾ç¨®ï¼Œåº•å±¤çš„å„ç¨®å¯¦ä½œå·®ç•°éƒ½éå¸¸å¤§ï¼Œåº•ä¸‹çš„æ¨¡å‹æ˜¯åŸºæ–¼ cassandra ä½†ä¸æœƒèµ°å¤ªå¤šç´°ç¯€ã€‚ cassandra çš„è¦æ ¼æœ‰æ©Ÿæœƒå†ç´°èŠã€‚\nç•¶å¾Œç«¯æ‡‰ç”¨å·²ç¶“é †åˆ©æ°´å¹³æ‹“å±•ä¹‹å¾Œï¼Œæ•´é«”æœå‹™çš„æ•ˆèƒ½ç“¶é ¸å¾€å¾€éƒ½å£“åœ¨å¾Œç«¯ DB ä¸Šã€‚é€™äº›ä¸åŒçš„ DB é¢å‘ä¸åŒçš„éœ€æ±‚ï¼Œç•¶éœ€æ±‚ç¬¦åˆæ™‚ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨é€™äº›è§£æ±ºæ–¹æ³•ã€‚\né€™é‚Šè¦å¼·èª¿ï¼Œä¸æ˜¯æ”¾æ£„ç¾æœ‰çš„ RDBMS ï¼Œå®Œå…¨ç§»è½‰åˆ°æ–°çš„è³‡æ–™åº«ï¼Œé€™æ¨£çš„æˆæœ¬å¤ªé«˜ï¼Œä¹Ÿæ²’æœ‰å¿…è¦æ€§ã€‚æ›´å¥½çš„åšæ³•ï¼Œæ˜¯æ­é…æ—¢æœ‰çš„é—œè¯æ€§è³‡æ–™åº«ï¼Œå°‡ä¸æ˜¯æ ¸å¿ƒæ¥­å‹™çš„è³‡æ–™è™•ç†æŠ½å‡ºï¼Œç§»è½‰åˆ°åˆé©çš„è³‡æ–™åº«ä¸Šã€‚è®“ä¸åŒéœ€æ±‚çš„è³‡æ–™å„²å­˜åˆ°æ›´åˆé©çš„å„²å­˜åº«ï¼Œæ˜¯é€™æ®µè©±è¦å¼·èª¿çš„é‡é»ï¼Œé—œé€£å¼è³‡æ–™åº«ä¹Ÿä¸æ˜¯å”¯ä¸€é¸æ“‡ã€‚\nåˆ†æ•£å¼çš„è³‡æ–™åº«æœ‰ä»¥ä¸‹ç‰¹å¾µ\nåˆ†æ•£å¼ç¯€é»é›†ç¾¤ (Cluster)ï¼šè³‡æ–™åº«æ˜¯å¤šå€‹ç¯€é»å…±å­˜ï¼Œè€Œé single master, multiple slaves çš„æ¶æ§‹ é…åˆå…±è­˜ç®—æ³• (consensus algorithm) æºé€šç¯€é»ä¹‹é–“çš„è³‡è¨Š ç„¡å–®é»éŒ¯èª¤ (Single-point failure)ï¼še.g. ä¸æœƒå› ç‚º master éŒ¯èª¤å°è‡´æ•´å€‹æœå‹™å¤±æ•ˆ é«˜å¯ç”¨(High Availitilityï¼šå¯ä»¥æ‰¿å—é›†ç¾¤ä¸­ä¸€å®šæ•¸é‡è™›æ“¬æ©Ÿæ•…éšœï¼Œæœå‹™ä»ç„¶å¯ç”¨ è³‡æ–™ sharding åˆ°ä¸åŒç¯€é»ä¸Š è¤‡æœ¬ (replica) ç¯€é»è¤‡æœ¬ (node replicas)ï¼šå¤šå€‹ç¯€é»æä¾›æœå‹™ï¼Œæä¾›æµé‡çš„å¸¶å¯¬èˆ‡å¯ç”¨æ€§ è³‡æ–™è¤‡æœ¬ (data replicas)ï¼šåœ¨å¤šå€‹ç¯€é»ä¸Šå„²å­˜è³‡æ–™ï¼Œæä¾›è³‡æ–™çš„å‚™ä»½ï¼ŒåŒæ™‚ä¹Ÿæä¾›è®€å–å¸¶å¯¬èˆ‡å¯ç”¨æ€§ å¾ä»¥ä¸Šç‰¹å¾µä¾†èªªï¼Œä½¿ç”¨æ­¤æ¶æ§‹çš„æœå‹™å¯ä»¥æ‰¿å—å…ˆå è™›æ“¬æ©Ÿçš„ä¸å®šæ™‚çµ‚æ­¢ï¼Œæˆ–è¨±å¯ä»¥ä½¿ç”¨ã€‚\nå¯¦å‹™ä¸Šæœ‰éå¸¸å¤šéœ€è¦æ³¨æ„ï¼Œéœ€è¦ä¾æ“šå„è‡ªæœå‹™çš„æ€§è³ªï¼Œå„è‡ªè™•ç†ã€‚å¸¸è¦‹çš„å•é¡Œèˆ‰ä¾‹å¦‚ä¸‹ï¼š\næ‡‰ç”¨å¯ä»¥å®¹éŒ¯ (fault-tolerent)ï¼Œç„¶è€ŒéŒ¯èª¤ç™¼ç”Ÿå¾Œï¼Œæœƒéœ€è¦æ¶ˆè€—å¾©åŸæˆæœ¬ï¼Œä¾‹å¦‚é‡å•Ÿå¾Œéœ€è¦èŠ±æ™‚é–“åˆå§‹åŒ–ï¼Œæˆ–æ˜¯åœ¨å¤šç¯€é»ä¸Šé€²è¡Œ data rebalanceã€‚ å¯ä»¥æ‰¿å—çªç„¶çš„éŒ¯èª¤ï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œè®Šæˆæ¯æ—¥å›ºå®šæœƒæ‰¿å—å¿…ç„¶çš„éŒ¯èª¤ã€‚é€™è£¡çŠ§ç‰²äº†éƒ¨åˆ†ç®—åŠ›ï¼Œç”šè‡³é€ æˆéš±æ€§çš„ç¶­è­·æˆæœ¬ï¼Œæœ€å¾Œæ˜¯å¦ç¬¦åˆç¯€çœæˆæœ¬çš„éœ€æ±‚ã€‚ éƒ½æ˜¯éœ€è¦ä»”ç´°äº†è§£è§£æ±ºæ–¹æ¡ˆï¼Œä¸¦ä¸”åˆ†æéœ€æ±‚ï¼Œä¾†è©•ä¼°æ˜¯å¦æœ‰åˆä¹æˆæœ¬ã€‚\nGKE ä»¥ä¸Šåˆ†æäº†ä¸‰ç¨®å¸¸è¦‹éœ€æ±‚ä¾‹å­ï¼šå¾ batch jobï¼Œuser-facing serviceï¼Œèˆ‡ distributed databaseã€‚æ˜å¤©æœƒå¯¦éš›æ¬å‡º GKE èˆ‡ GCP Preemptible Instance çš„æŠ€è¡“è¦æ ¼ï¼Œèˆ‡å¤§å®¶å¯¦éš›è¨è«–ã€‚\n","date":1600756740,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"e14c46689d3578ca310e4410bc46bbf0","permalink":"https://chechia.net/zh-hant/post/2020-09-22-gcp-preemptible-instance-requirement-distributed/","publishdate":"2020-09-22T14:39:00+08:00","relpermalink":"/zh-hant/post/2020-09-22-gcp-preemptible-instance-requirement-distributed/","section":"post","summary":"æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\nåŸ·è¡ŒçŸ­æœŸçš„ batch job åŸ·è¡Œé•·æœŸçš„ user-facing API server åŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº« è©²ä¸è©²åœ¨ Kubernetes ä¸Šé¢è·‘ databaseï¼Ÿ\nTL;DR ï¼Œå¦‚æœä½ å‰›é–‹å§‹è€ƒæ…®é€™ä»¶äº‹ï¼Œé€šå¸¸çš„ç­”æ¡ˆéƒ½æ˜¯å¦å®šçš„\nç­‰ç­‰ï¼Œæˆ‘å€‘é€™é‚Šä¸æ˜¯è¨è«–è©²ä¸è©²ä¸Š Kuberentes ï¼Œè€Œæ˜¯è©²ä¸è©²ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå§ã€‚ç„¶è€Œç”±æ–¼å…ˆå è™›æ“¬æ©Ÿç¯€é»çš„è«¸å¤šé™åˆ¶ï¼Œå…‰æ†‘å…ˆå è™›æ“¬æ©Ÿä¸¦ä¸é©åˆè·‘ä»»ä½•æŒä¹…æ€§çš„å„²å­˜åº«ã€‚æˆ‘å€‘é€™é‚Šä»°è³´ Kubernetes çš„ç¶²è·¯åŠŸèƒ½ (e.g. æœå‹™ç™¼ç¾)ï¼Œèˆ‡è‡ªå‹•ç®¡ç† (e.g. health checkï¼ŒHPAï¼Œauto-scaler)ï¼ŒåŸºæ–¼å…ˆå è™›æ“¬æ©Ÿï¼Œå»ºæ§‹é«˜å¯ç”¨æ€§çš„æœå‹™æ¶æ§‹ï¼Œä¾†æ”¯æ’é«˜å¯ç”¨ï¼Œä¸”æœ‰ç‹€æ…‹çš„çš„å„²å­˜åº«ã€‚\næ‡‰ç”¨æ˜¯å¦é©åˆéƒ¨ç½²åˆ° Kubernetes ä¸Šï¼Œå¯ä»¥çœ‹é€™ç¯‡ Google Blog: To run or not to run a database on Kubernetes: What to considerï¼Œå¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œå†ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å†é€²è¡Œä¸­æ–‡ç¿»è­¯ã€‚","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance Requirement Distributed","type":"post"},{"authors":[],"categories":null,"content":"å‰è¨€ éµäººè³½çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¦å¸¶ä¾†å…¬æœ‰é›²çœéŒ¢ç³»åˆ—æ–‡ç« ã€‚\næ¶æ§‹çš„æˆæœ¬ï¼Œå¾ˆå¤šæ™‚å€™æœƒå½±éŸ¿æ¶æ§‹çš„è¨­è¨ˆèˆ‡éœ€æ±‚ã€‚å…¬å¸çš„ç‡Ÿé‹éƒ½éœ€è¦åœ¨æˆæœ¬èˆ‡éœ€æ±‚ä¹‹å‰å¹³è¡¡ï¼Œæˆæœ¬å…¶å¯¦æ˜¯å½±éŸ¿å…¬å¸æ±ºç­–çš„é‡è¦å› ç´ ã€‚èº«ç‚ºæ¶æ§‹ç®¡ç†å“¡ï¼Œæ‡‰è©²è¦è©¦è‘—é‡åŒ–ä¸¦ä¸”é€²è¡Œæˆæœ¬ç®¡ç†ï¼Œæå‡ºè§£æ±ºæ–¹æ¡ˆæ™‚ï¼Œä¹Ÿéœ€è¦æ€è€ƒå¦‚ä½•å¹«å…¬å¸é–‹æºç¯€æµã€‚\nä¸€æ˜§æ¶ˆæ¸›æ¶æ§‹çš„æˆæœ¬ä¹Ÿæœªå¿…æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå¸³é¢ä¸Šæ¶ˆæ¸›çš„æˆæœ¬æœ‰æ™‚ä¹Ÿæœƒåæ˜ åœ¨å…¶ä»–åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨æ¯”è¼ƒä¾¿å®œçš„è§£æ±ºæ–¹æ¡ˆï¼Œæˆ–æ˜¯è¼ƒä½çš„ç®—åŠ›ï¼Œä½†å»é€ æˆç¶­é‹éœ€è¦èŠ±æ›´å¤šæ™‚é–“ç¶­è­·ï¼Œé€ æˆéš±æ€§çš„äººåŠ›æˆæœ¬æ¶ˆè€—ã€‚ç”¨ä»€éº¼æ›¿ä»£æ–¹æ¡ˆ (trade-off) çœäº†é€™äº›éŒ¢ã€‚\nKubernetes æ˜¯ä¸€å€‹å¾ˆå¥½çš„ä¾‹å­ï¼šä¾‹å¦‚ï¼šæœ‰äººèªªã€ŒKubernetes å¯ä»¥çœéŒ¢ã€ï¼Œä½†ä¹Ÿæœ‰äººèªªã€ŒKubernetes ç”¢ç”Ÿçš„ Overhead å¤ªé‡æœƒè™§éŒ¢ã€ã€‚\nã€Œè¦ä¸è¦å°å…¥ Kubernetes æ˜¯ä¸€å€‹å¥½å•é¡Œã€ã€‚æ‡‰è©²å›æ­¸åŸºæœ¬çš„éœ€æ±‚ï¼Œäº†è§£éœ€æ±‚æ˜¯ä»€éº¼ã€‚ä¾‹å¦‚ï¼šGoogle ç•¶åˆé–‹ç™¼å®¹å™¨ç®¡ç†å¹³å°ï¼Œæ˜¯é¢å°ä»€éº¼æ¨£çš„ä½¿ç”¨éœ€æ±‚ï¼Œæœ€çµ‚é–‹ç™¼å‡º Kubernetesï¼Œå„ä½å¯ä»¥å›é¡§å‰ç¯‡æ–‡ç« ã€ŒBorg Omega and Kuberneteï¼ŒKubernetes çš„å‰æ—¥ä»Šç”Ÿï¼Œèˆ‡ Google åé¤˜å¹´çš„å®¹å™¨åŒ–æŠ€è¡“ã€ï¼Œå¾ Google çš„è§’åº¦ç†è§£å®¹å™¨ç®¡ç†å¹³å°ï¼Œåæ€è‡ªèº«åœ˜éšŠçš„å¯¦éš›éœ€æ±‚ã€‚\né€™å¥—è§£æ±ºæ–¹æ¡ˆæ˜¯å¦çœŸçš„é©åˆåœ˜éšŠï¼Œè§£æ±ºæ–¹æ¡ˆå¸¶ä¾†çš„æ•ˆæœåˆ°åº•æ˜¯æ€æ¨£å‘¢ï¼Ÿå¸Œæœ›çœ‹å®Œé€™ç³»åˆ—æ–‡ç« å¾Œï¼Œèƒ½å¹«åŠ©å„ä½ï¼Œå¾æˆæœ¬é¢æ€è€ƒé€™äº›é‡è¦çš„å•é¡Œã€‚\né€™ç¯‡ä½¿ç”¨ GCP çš„åŸå› ï¼Œé™¤äº†æ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„å…¬æœ‰é›²å¤–ï¼Œä¹Ÿæ˜¯å› ç‚º GCP æä¾›çš„å…è²»é¡åº¦ï¼Œè®“æˆ‘å¯ä»¥å¾ˆè¼•é¬†åœ°ä½œç‚ºç¤¾ç¾¤æ–‡ç« çš„ Demoï¼Œå¦‚æœæœ‰åˆ¥å®¶é›²å¹³å°æœ‰æä¾›ç›¸åŒæ–¹æ¡ˆï¼Œè«‹ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å¯èƒ½å°±æœƒå¤šé–‹å¹¾å®¶ä¸åŒçš„ç¯„ä¾‹ã€‚\nå…ˆå è™›æ“¬æ©Ÿ TL;DR å…ˆå è™›æ“¬æ©Ÿç‚ºéš¨é¸è™›æ“¬æ©Ÿå®šåƒ¹çš„ 2-3 æŠ˜ï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå¯èƒ½å¯ä»¥ç¯€çœ 7 æˆçš„é›²å¹³å°æ”¯å‡º å…ˆå è™›æ“¬æ©Ÿæ¯”èµ·éš¨é¸è™›æ“¬æ©Ÿï¼Œå¤–åŠ æœ‰è«¸å¤šé™åˆ¶ï¼Œe.g. æœ€é•·å£½å‘½ 24 hrã€é›²å¹³å°æœƒä¸»å‹•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿâ€¦ç­‰ é…åˆä½¿ç”¨è‡ªå‹•æ°´å¹³æ“´å±• (auto-scaler)ï¼Œè®“èˆŠçš„å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„åŒæ™‚ï¼Œå»è³¼è²·æ–°çš„å…ˆå è™›æ“¬æ©Ÿ é…åˆå¯å®¹éŒ¯ (fault-tolerent) çš„åˆ†æ•£å¼æ‡‰ç”¨ï¼Œè®“æ‡‰ç”¨å¯ä»¥ç„¡ç—›åœ¨è™›æ“¬æ©Ÿåˆ‡æ›è½‰ç§»ï¼Œä¸å½±éŸ¿æœå‹™ è¦è®“æ‡‰ç”¨å¯ä»¥å®¹éŒ¯ï¼Œéœ€è¦åšéå¸¸å¤šäº‹æƒ… æ­é… kubernetes ï¼Œè‡ªå‹•åŒ–ç®¡ç†ä¾†ç°¡åŒ–å·¥ä½œ é…åˆæ­£ç¢ºçš„è¨­å®šï¼Œå¯ä»¥ç©©å®šçš„åŸ·è¡Œæœ‰ç‹€æ…‹çš„åˆ†æ•£å¼è³‡æ–™åº«æˆ–å„²å­˜åº« æˆ–æ˜¯çœ‹ Google å®˜æ–¹ Blogï¼šCutting costs with Google Kubernetes Engine: using the cluster autoscaler and Preemptible VMs\né è¨ˆå…§å®¹\néœ€æ±‚å‡è¨­ã€é‡æ¸…éœ€æ±‚ï¼Œä¸¦ä¸”ç²¾æº–è¨ˆåƒ¹ ç²¾æº–è¨ˆåƒ¹ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿçš„ç¯€çœæˆæœ¬ å…ˆå è™›æ“¬æ©Ÿçš„è¦æ ¼ã€é¡å¤–é™åˆ¶ é¡å¤–é™åˆ¶ï¼Œé€ æˆæŠ€è¡“è¦å¤šåšå¾ˆå¤šé¡å¤–çš„äº‹æƒ… å¯¦å‹™ç¶“é©—åˆ†äº«ï¼šAPI server å¯¦å‹™ç¶“é©—ï¼šå¾ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿï¼Œç§»è½‰åˆ°å…ˆå è™›æ“¬æ©Ÿï¼Œå…¬å¸å¯¦éš›å°å…¥ç¶“é©— å¯¦å‹™ç¶“é©—ï¼šElasticsearch å¯¦å‹™ç¶“é©—åˆ†äº«ï¼šå…¶ä»–åˆ†æ•£å¼è³‡æ–™åº«ï¼Œä¹Ÿè¨±æ˜¯ Cassandra æˆ–æ˜¯ cockroachDB ä¸Šé¢çš„å…§å®¹ä¸æ›‰å¾—æœƒå¯«å¹¾ç¯‡çœ‹æ„Ÿè¦º XD\næœ‰å¯«ééµäººè³½çš„éƒ½çŸ¥é“ 30 ç¯‡çœŸçš„å¾ˆæ¼«é•·ï¼Œä¸€ç¯‡æ–‡ç« å¹¾åƒå­—ï¼Œéƒ½è¦èŠ±å¥½å¹¾å€‹å°æ™‚ã€‚æˆ‘å»å¹´å¾ŒåŠï¼ŒçœŸçš„éƒ½æœƒçœ‹è®€è€…çš„ç•™è¨€è·ŸæŒ‰è®šï¼Œå–æš–ä¸€æ³¢ï¼Œæ‰æœ‰å‹•åŠ›ç¹¼çºŒå¯«ã€‚ç•™è¨€çš„äººå¤šå°±æœƒå¤šå¯«ï¼Œç•™è¨€çš„äººå°‘å°±æœƒå°‘å¯«ï¼Œå„ä½è¦ºå¾—æ–‡ç« é‚„çœ‹å¾—ä¸‹å»ï¼Œè«‹å‹™å¿…ä¾†æˆ‘ç²‰å°ˆæŒ‰è®šç•™å€‹è¨€ï¼Œä¸ç®¡æ˜¯æ¨æ¨ã€é­é­ã€æˆ–æ˜¯æœ‰æƒ³çœ‹çš„æ–‡ç« ä¾†è¨±é¡˜ï¼Œéƒ½ååˆ†æ­¡è¿ã€‚æœ‰ä½ å€‘çš„æ”¯æŒï¼Œæˆ‘æ‰æœ‰å‹•åŠ›ç¹¼çºŒå¯«ã€‚\nè«‹å¤§å®¶å‹™å¿…ä»¥å¯¦éš›è¡Œå‹•æ”¯æŒå¥½æ–‡ç« ï¼Œä¸è¦è®“åŠ£å¹£é©…é€è‰¯å¹£ã€‚ä¸ç„¶ iThome ä¸Šé¢ä¹‹å¾Œåªå‰©æ´—è§€çœ‹æ•¸çš„ç†±é–€æ–‡ç« äº† XD\nç•¶ç„¶ï¼Œæ²’äººç•™è¨€æˆ‘å°±æœƒç•¶ä½œè‡ªå·±æ‰æ˜¯åƒåœ¾æ–‡ (è‡ªçŸ¥ä¹‹æ˜XD)ï¼Œå°±æœƒæ”¶ä¸€æ”¶å›å®¶åš•è²“ç¡è¦ºï¼Œæ°æ°~\n-\u0026gt;æˆ‘çš„ç²‰å°ˆï¼Œç­‰ä½ ä¾†ç•™è¨€\n","date":1600651337,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"8b6f6fe6a62ceb767543681a22a85162","permalink":"https://chechia.net/zh-hant/post/2020-09-21-gcp-preemptible-instance/","publishdate":"2020-09-21T09:22:17+08:00","relpermalink":"/zh-hant/post/2020-09-21-gcp-preemptible-instance/","section":"post","summary":"å‰è¨€ éµäººè³½çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¦å¸¶ä¾†å…¬æœ‰é›²çœéŒ¢ç³»åˆ—æ–‡ç« ã€‚\næ¶æ§‹çš„æˆæœ¬ï¼Œå¾ˆå¤šæ™‚å€™æœƒå½±éŸ¿æ¶æ§‹çš„è¨­è¨ˆèˆ‡éœ€æ±‚ã€‚å…¬å¸çš„ç‡Ÿé‹éƒ½éœ€è¦åœ¨æˆæœ¬èˆ‡éœ€æ±‚ä¹‹å‰å¹³è¡¡ï¼Œæˆæœ¬å…¶å¯¦æ˜¯å½±éŸ¿å…¬å¸æ±ºç­–çš„é‡è¦å› ç´ ã€‚èº«ç‚ºæ¶æ§‹ç®¡ç†å“¡ï¼Œæ‡‰è©²è¦è©¦è‘—é‡åŒ–ä¸¦ä¸”é€²è¡Œæˆæœ¬ç®¡ç†ï¼Œæå‡ºè§£æ±ºæ–¹æ¡ˆæ™‚ï¼Œä¹Ÿéœ€è¦æ€è€ƒå¦‚ä½•å¹«å…¬å¸é–‹æºç¯€æµã€‚\nä¸€æ˜§æ¶ˆæ¸›æ¶æ§‹çš„æˆæœ¬ä¹Ÿæœªå¿…æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå¸³é¢ä¸Šæ¶ˆæ¸›çš„æˆæœ¬æœ‰æ™‚ä¹Ÿæœƒåæ˜ åœ¨å…¶ä»–åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨æ¯”è¼ƒä¾¿å®œçš„è§£æ±ºæ–¹æ¡ˆï¼Œæˆ–æ˜¯è¼ƒä½çš„ç®—åŠ›ï¼Œä½†å»é€ æˆç¶­é‹éœ€è¦èŠ±æ›´å¤šæ™‚é–“ç¶­è­·ï¼Œé€ æˆéš±æ€§çš„äººåŠ›æˆæœ¬æ¶ˆè€—ã€‚ç”¨ä»€éº¼æ›¿ä»£æ–¹æ¡ˆ (trade-off) çœäº†é€™äº›éŒ¢ã€‚\nKubernetes æ˜¯ä¸€å€‹å¾ˆå¥½çš„ä¾‹å­ï¼šä¾‹å¦‚ï¼šæœ‰äººèªªã€ŒKubernetes å¯ä»¥çœéŒ¢ã€ï¼Œä½†ä¹Ÿæœ‰äººèªªã€ŒKubernetes ç”¢ç”Ÿçš„ Overhead å¤ªé‡æœƒè™§éŒ¢ã€ã€‚\nã€Œè¦ä¸è¦å°å…¥ Kubernetes æ˜¯ä¸€å€‹å¥½å•é¡Œã€ã€‚æ‡‰è©²å›æ­¸åŸºæœ¬çš„éœ€æ±‚ï¼Œäº†è§£éœ€æ±‚æ˜¯ä»€éº¼ã€‚ä¾‹å¦‚ï¼šGoogle ç•¶åˆé–‹ç™¼å®¹å™¨ç®¡ç†å¹³å°ï¼Œæ˜¯é¢å°ä»€éº¼æ¨£çš„ä½¿ç”¨éœ€æ±‚ï¼Œæœ€çµ‚é–‹ç™¼å‡º Kubernetesï¼Œå„ä½å¯ä»¥å›é¡§å‰ç¯‡æ–‡ç« ã€ŒBorg Omega and Kuberneteï¼ŒKubernetes çš„å‰æ—¥ä»Šç”Ÿï¼Œèˆ‡ Google åé¤˜å¹´çš„å®¹å™¨åŒ–æŠ€è¡“ã€ï¼Œå¾ Google çš„è§’åº¦ç†è§£å®¹å™¨ç®¡ç†å¹³å°ï¼Œåæ€è‡ªèº«åœ˜éšŠçš„å¯¦éš›éœ€æ±‚ã€‚\né€™å¥—è§£æ±ºæ–¹æ¡ˆæ˜¯å¦çœŸçš„é©åˆåœ˜éšŠï¼Œè§£æ±ºæ–¹æ¡ˆå¸¶ä¾†çš„æ•ˆæœåˆ°åº•æ˜¯æ€æ¨£å‘¢ï¼Ÿå¸Œæœ›çœ‹å®Œé€™ç³»åˆ—æ–‡ç« å¾Œï¼Œèƒ½å¹«åŠ©å„ä½ï¼Œå¾æˆæœ¬é¢æ€è€ƒé€™äº›é‡è¦çš„å•é¡Œã€‚\né€™ç¯‡ä½¿ç”¨ GCP çš„åŸå› ï¼Œé™¤äº†æ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„å…¬æœ‰é›²å¤–ï¼Œä¹Ÿæ˜¯å› ç‚º GCP æä¾›çš„å…è²»é¡åº¦ï¼Œè®“æˆ‘å¯ä»¥å¾ˆè¼•é¬†åœ°ä½œç‚ºç¤¾ç¾¤æ–‡ç« çš„ Demoï¼Œå¦‚æœæœ‰åˆ¥å®¶é›²å¹³å°æœ‰æä¾›ç›¸åŒæ–¹æ¡ˆï¼Œè«‹ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å¯èƒ½å°±æœƒå¤šé–‹å¹¾å®¶ä¸åŒçš„ç¯„ä¾‹ã€‚","tags":["kubernetes","gcp","preemptible","spot-instance","éµäººè³½2020"],"title":"Gcp Preemptible Instance","type":"post"},{"authors":[],"categories":null,"content":"å‰è¨€ é€™æ˜¯åŸæ–‡å®Œæ•´ç‰ˆæœ¬ã€‚å¤ªé•·ä¸è®€ (TL;DR) è«‹è¦‹Borg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæ‘˜è¦\nåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\næ‘˜è¦ åœ¨ container æŠ€è¡“å¤¯èµ·ä¾†å‰ï¼ŒGoogle å·²ç¶“åšäº† container åå¹¾å¹´ï¼Œéç¨‹ä¸­ç™¼å±•å‡ºéœ€ä¸‰å¥—å®¹å™¨ç®¡ç†ç³»çµ±ã€‚é›–ç„¶æ¯ä¸€ä»£ç³»çµ±çš„é–‹ç™¼éœ€æ±‚ä¸åŒï¼Œä½†æ¯ä¸€ä»£éƒ½æ·±å—ä¸Šä¸€ä»£å½±éŸ¿ã€‚é€™ç¯‡æ–‡ç« æè¿° Google é–‹ç™¼é€™äº›ç³»çµ±æ™‚ï¼Œå­¸åˆ°çš„ç¶“é©—ã€‚\nç¬¬ä¸€å¥— container management ç³»çµ±æ˜¯ Borgï¼Œç‚ºäº†ç®¡ç† 1. é•·æœŸåŸ·è¡Œçš„æœå‹™ 2. æ‰¹æ¬¡çš„çŸ­æœŸå·¥ä½œ (batch job)ï¼ŒåŸæœ¬åˆ†åˆ¥æ˜¯ç”± Babysitter èˆ‡ Global Work Queue å…©å¥—ç³»çµ±åˆ†é–‹ç®¡ç†ã€‚å¾Œè€…çš„æ¶æ§‹æ·±åˆ»å½±éŸ¿ Borgï¼Œä½† Global Work Queue å°ˆæ³¨æ–¼ batch jobã€‚å…©å¥—ç³»çµ±éƒ½åœ¨ Linux control groups ä¹‹å‰ã€‚Borg å°‡ä¸Šè¿°å…©ç¨®æ‡‰ç”¨æ”¾åœ¨å…±äº«çš„æ©Ÿå™¨ä¸Šï¼Œä¾†å¢åŠ è³‡æºçš„ä½¿ç”¨ç‡ï¼Œä»¥ç¯€çœæˆæœ¬ã€‚é€™ç¨®å…±äº«åŸºæ–¼æ”¯æ´ container çš„ Linux Kernel (Google ä¹Ÿè²¢ç»è¨±å¤š Linux kernel container ç¨‹å¼ç¢¼)ï¼Œæä¾›æ›´å¥½çš„éš”é›¢ (isolation) çµ¦å»¶é²æ•æ„Ÿçš„ä½¿ç”¨è€…æœå‹™ (latency-sentitive user-facing services)ï¼Œä»¥åŠæ¶ˆè€—å¤§é‡ cpu çš„ batch ç¨‹å¼ã€‚\nè¶Šä¾†è¶Šå¤šæ‡‰ç”¨éƒ½åœ¨ Borg ä¸Šé–‹ç™¼åŸ·è¡Œï¼Œ Google çš„æ‡‰ç”¨èˆ‡ infratructure åœ˜éšŠé–‹ç™¼è¨±å¤šå·¥å…·èˆ‡æœå‹™ï¼Œå½¢æˆ Borg ç”Ÿæ…‹ç³»ã€‚é€™äº›ç³»çµ±æä¾›è¨­å®š (configure) èˆ‡æ›´æ–° (update) å·¥ä½œã€é æ¸¬è³‡æºéœ€æ±‚ã€å‹•æ…‹æ¨é€è¨­å®šåˆ°åŸ·è¡Œä¸­çš„å·¥ä½œã€æœå‹™ç™¼ç¾ (service discovery) èˆ‡è² è¼‰å‡è¡¡ (Load balancing)ï¼Œç­‰ç­‰åŠŸèƒ½ã€‚é€™äº›ç”Ÿæ…‹ç³»çš„é–‹ç™¼åŸºæ–¼ Google ä¸åŒåœ˜éšŠçš„éœ€æ±‚ï¼Œç”¢ç”Ÿä¸€å€‹ä¸åŒèµ·æº (heterogeneous)ã€åªé‡å°å„åˆ¥éœ€æ±‚çš„ (ad-hoc) ä¸€å€‹å †ä¸åŒç³»çµ±ï¼ŒBorg çš„ä½¿ç”¨è€…éœ€è¦ä½¿ç”¨ä¸åŒçš„ç¨‹å¼èªè¨€èˆ‡ç¨‹åºï¼Œä¾†èˆ‡é€™äº›ç³»çµ±äº’å‹•ã€‚Borg ä»ç„¶æ˜¯ Google ä¸»è¦çš„å®¹å™¨ç®¡ç†ç³»çµ±ï¼Œå› ç‚ºä»–è¦æ¨¡ (scale) å·¨å¤§ï¼ŒåŠŸèƒ½å¤šæ¨£ï¼Œè€Œä¸”æ¥µåº¦å …å›º (robustness)ã€‚\nOmega æ˜¯ Borg çš„ä¸‹ä¸€ä»£ï¼Œç›®çš„æ˜¯æ”¹å–„ Borg ç”Ÿæ…‹ç³»çš„è»Ÿé«”å·¥ç¨‹ã€‚Omega æ‰¿è¥²è¨±å¤š Borg æ¸¬è©¦æˆåŠŸçš„æ¨¡å¼ï¼Œä½†ä¸åŒæ–¼ Borgï¼ŒOmega æœ‰å®Œæ•´çš„æ¶æ§‹è¨­è¨ˆï¼Œæ•´é«”æ›´åŠ ä¸€è‡´ã€‚Omega å°‡é›†ç¾¤ç‹€æ…‹ (cluster state) å­˜æ”¾åœ¨ä¸­å¿ƒåŒ– (centralized)ã€åŸºæ–¼ Paxos ç®—æ³•ã€äº¤æ˜“å°å‘ (transaction-oriented) çš„å„²å­˜ç³»çµ±ï¼Œè®“é›†ç¾¤çš„æ§åˆ¶é¢æ¿ (control panel) å­˜å–ï¼Œä¾‹å¦‚ schedulerã€‚Omega ä½¿ç”¨æ¨‚è§€çš„ä½µç™¼æ§åˆ¶ (optimistic concurrency control) ä¾†è™•ç†å¶ç™¼çš„è¡çªï¼Œé€™ä¸€å±¤è§£è—• (decoupling) çš„è¨­è¨ˆï¼Œä½¿å¾—åŸå…ˆçš„ Borgmaster çš„åŠŸèƒ½å¯ä»¥æ‹†åˆ†æˆå¤šå€‹å…ƒä»¶ï¼Œå–ä»£åŸæœ¬å–®ä¸€ (monolithic) é›†ä¸­ (centralized) çš„ masterï¼Œè¢«æ‰€æœ‰è®Šæ›´è«‹æ±‚å µå¡ã€‚è¨±å¤š Omage æˆåŠŸçš„å‰µæ–°ä¹Ÿæœƒè¢«è¿­ä»£å›å» Borg ä¸­ã€‚\nç¬¬ä¸‰å¥— Google é–‹ç™¼çš„å®¹å™¨ç®¡ç†ç³»çµ±æ˜¯ Kubernetesï¼Œé€™æ™‚å¤–ç•Œå·¥ç¨‹å¸«ä¹Ÿé–‹å§‹å° Linux å®¹å™¨æœ‰èˆˆè¶£ï¼Œè€Œ Google åŒæ™‚åœ¨é–‹ç™¼ä¸¦æ¨å±•è‡ªå·±çš„å…¬æœ‰é›²æ¶æ§‹ã€‚Kubernetes åœ¨é€™æ¨£çš„èƒŒæ™¯ä¸‹æ§‹æ€ä¸¦é–‹ç™¼ã€‚èˆ‡ Borg åŠ Omega ä¸åŒï¼ŒKubernetes æ˜¯é–‹æºè»Ÿé«”ï¼Œä¸é™æ–¼ Google å…§éƒ¨é–‹ç™¼ã€‚Kubernetes å…§éƒ¨æœ‰å…±äº«çš„æŒä¹…å±¤å„²å­˜ (persistent store)ï¼Œæœå‹™å…ƒä»¶æŒçºŒç›£æ¸¬æœ‰é—œç‰©ä»¶ï¼Œèˆ‡ Omega é¡ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒOmega å…è¨±ä¿¡ä»»çš„æ§åˆ¶é¢æ¿çš„å…ƒä»¶ç›´æ¥å­˜å–å„²å­˜åº«ï¼ŒKubernetes å‰‡é€é domain-specific çš„ REST API å­˜å–ï¼Œä¾†æä¾›é«˜éš (higher-level) çš„ API ç‰ˆæœ¬æ§åˆ¶ã€é©—è­‰ã€èªæ„è™•ç† (semantics)ã€ä»¥åŠå­˜å–æ”¿ç­– (policy)ï¼Œä¾†æ”¯æ´æ›´å»£æ³›çš„ç”¨æˆ¶ç«¯ã€‚æ›´é‡è¦çš„æ˜¯ Kubernetes è‘—é‡å·¥ç¨‹å¸«åœ¨ cluster ä¸Šé–‹ç™¼èˆ‡åŸ·è¡Œæ‡‰ç”¨çš„é«”é©—ï¼Œç°¡åŒ–è¤‡é›œåˆ†æ•£å¼ç³»çµ± (distributed system) çš„ç®¡ç†èˆ‡éƒ¨å±¬ (deploy)ï¼ŒåŒæ™‚ä»èƒ½é€éå®¹å™¨ä¾†æå‡è³‡æºçš„ä½¿ç”¨ç‡ã€‚\né€™ç¯‡æ–‡ç« æè¿° Google å¾ Borg åˆ° Kubernetes ç²å¾—çš„çŸ¥è­˜èˆ‡ç¶“é©—ã€‚\nå®¹å™¨ (Containers) å›é¡§æ­·å²ï¼Œç¬¬ä¸€å€‹å®¹å™¨åªæä¾› root file system (é€é chroot)ã€‚FreeBSD jail é€²ä¸€æ­¥å»¶ä¼¸å‡ºé¡å¤–çš„å‘½åç©ºé–“ (namespace) ä¾‹å¦‚ process IDã€‚Solaris å¤§å¹…åœ°æ¢ç´¢ç›¸é—œçš„æ–°åŠŸèƒ½ã€‚Linux control groups (cgroups) å¸æ”¶é€™äº›æƒ³æ³•ï¼Œç›´åˆ°ä»Šæ—¥ä»æŒçºŒé–‹ç™¼ã€‚\nå®¹å™¨æä¾›è³‡æºéš”é›¢ (resource isolation)ï¼ŒGoogle å¾—ä»¥å¤§å¹…æå‡è³‡æºä½¿ç”¨ç‡ (utilization) è¶…å‡ºç•¶æ™‚ç”¢æ¥­å¹³å‡å€¼ï¼Œä¾‹å¦‚ Borg ä½¿ç”¨å®¹å™¨ï¼Œå°‡æ‰¹æ¬¡æš«æ™‚å·¥ä½œã€èˆ‡é¢å°ç”¨æˆ¶éœ€è¦æ³¨æ„å»¶é²çš„æ‡‰ç”¨ï¼Œå…©è€…æ”¾åœ¨åŒæ¨£çš„ç‰©ç†æ©Ÿå™¨ä¸Šã€‚ç”¨æˆ¶æ‡‰ç”¨éœ€è¦é ç•™æ›´å¤šé¡å¤–çš„è³‡æºï¼Œä¾†è™•ç†çªç„¶ç”¢ç”Ÿçš„è² è¼‰é«˜å³° (load spikes) ä»¥åŠéŒ¯èª¤è™•ç† (fail-over) ï¼Œé€™äº›é ç•™çš„è³‡æºå¸¸å¸¸éƒ½ä¸æœƒç”¨åˆ°ï¼Œå¯ä»¥è½‰è®“æ‰¹æ¬¡å·¥ä½œä½¿ç”¨ã€‚å®¹å™¨æä¾›çš„è³‡æºç®¡ç†å·¥å…·å¯¦ç¾æ­¤é¡éœ€æ±‚ï¼Œkernel-level çš„è³‡æºéš”é›¢ä¹Ÿç¢ºä¿ç¨‹åºä¹‹é–“ä¸æœƒäº’ç›¸å¹²æ“¾ã€‚Google é–‹ç™¼ Borg ä¸­ï¼ŒåŒæ™‚ä¹Ÿæäº¤æ–°åŠŸèƒ½çµ¦ Linux å®¹å™¨ï¼Œä¾†æ»¿è¶³ä¸Šè¿°çš„éœ€æ±‚ã€‚ç„¶è€Œç›®å‰çš„éš”é›¢ä¸¦ä¸å®Œæ•´ï¼Œå¦‚æœ Linux kernel ä¸ç®¡ç†çš„è³‡æºï¼Œå®¹å™¨è‡ªç„¶ä¹Ÿç„¡æ³•æ ¼ç†ï¼Œä¾‹å¦‚ level-3 çš„è™•ç†å™¨å¿«å– (level-3 processor cache) èˆ‡è¨˜æ†¶é«”å¸¶å¯¬ (memory bandwith)ï¼Œå®¹å™¨é‚„éœ€è¦å¢åŠ ä¸€å±¤å®‰å…¨ä¿è­·å±¤ (ä¾‹å¦‚è™›æ“¬æ©Ÿå™¨ Virtual Machine) æ‰èƒ½å°ä»˜å…¬æœ‰é›²ä¸Šå‡ºç¾çš„æƒ¡æ„è¡Œç‚ºã€‚\nç¾ä»£çš„å®¹å™¨ä¸åªæä¾›éš”é›¢æ©Ÿåˆ¶ï¼Œæ›´æä¾›æ˜ åƒæª” (image)ï¼Œåœ¨é€™å€‹æª”æ¡ˆä¸Šå»ºæ§‹å®¹å™¨çš„æ‡‰ç”¨ã€‚Google ä½¿ç”¨ Midas Package Manager (MPM) ä¾†å»ºæ§‹ä¸¦éƒ¨å±¬å®¹å™¨æ˜ åƒæª”ï¼Œéš”é›¢æ©Ÿåˆ¶èˆ‡ MPM package çš„é—œä¿‚ï¼Œå¯ä»¥å°æ¯” Docker daemon èˆ‡ Docker image registryã€‚é€™å€‹ç« ç¯€æè¿°çš„ã€Œå®¹å™¨ã€åŒæ™‚åŒ…å«å…©å€‹æ¦‚å¿µï¼šéš”é›¢ã€æ˜ åƒæª”ã€‚\næ‡‰ç”¨å°å‘çš„æ¶æ§‹ (Application-oriented infrastructure) éš¨è‘—æ™‚é–“è­‰æ˜ï¼Œå®¹å™¨ä¸åªèƒ½æä¾›é«˜éšçš„è³‡æºä½¿ç”¨ç‡ï¼Œå®¹å™¨åŒ– (containerization) ä½¿è³‡æ–™ä¸­å¿ƒ (data center) å¾åŸæœ¬æ©Ÿå™¨å°å‘ (machine-oriented) è®Šæˆæ‡‰ç”¨å°å‘ (application-oriented)ï¼Œé€™å€‹æ®µè½æä¾›å…©å€‹ä¾‹å­ï¼š\nå®¹å™¨å°è£ (encapsulate) æ‡‰ç”¨çš„ç’°å¢ƒ (environment)ï¼Œåœ¨æ©Ÿå™¨èˆ‡ä½œæ¥­ç³»çµ±çš„ç´°ç¯€ä¸Šï¼Œå¢åŠ ä¸€å±¤æŠ½è±¡å±¤ï¼Œè§£è—•å…©ä»¶äº‹æƒ…ï¼šæ‡‰ç”¨é–‹ç™¼ã€éƒ¨å±¬åˆ°æ¶æ§‹ã€‚ è‰¯å¥½è¨­è¨ˆçš„å®¹å™¨èˆ‡æ˜ åƒæª”åªå°ˆæ³¨åœ¨å–®ä¸€å€‹æ‡‰ç”¨ï¼Œç®¡ç†å®¹å™¨æ„å‘³ç®¡ç†æ‡‰ç”¨ï¼Œè€Œä¸æ˜¯ç®¡ç†æ©Ÿå™¨ã€‚é€™é»å·®ç•°ä½¿å¾—ç®¡ç†çš„ APIï¼Œå¾æ©Ÿå™¨å°å‘è®Šæˆå½±ç”¨å°å‘ï¼Œå¤§å¹…åº¦çš„æ”¹å–„æ‡‰ç”¨çš„éƒ¨å±¬èˆ‡ç›£æ§ã€‚ æ‡‰ç”¨çš„ç’°å¢ƒ (Application environment) åŸæœ¬ kernel å…§çš„ cgroupã€chrootã€èˆ‡å‘½åç©ºé–“ï¼Œæ˜¯ç”¨ä¾†ä¿è­·æ‡‰ç”¨ä¸è¢«æ—é‚Šå…¶ä»–æ‡‰ç”¨çš„é›œè¨Šå½±éŸ¿ã€‚å°‡é€™äº›å·¥å…·èˆ‡å®¹å™¨æ˜ åƒæª”ä¸€èµ·ä½¿ç”¨ï¼Œç”¢ç”Ÿä¸€å±¤æŠ½è±¡å±¤ï¼Œåˆ†é›¢æ‡‰ç”¨ã€èˆ‡åº•ä¸‹çš„ (å„ç¨®ä¸åŒå®¶çš„) ä½œæ¥­ç³»çµ±ã€‚è§£è—•æ˜ åƒæª”èˆ‡ä½œæ¥­ç³»çµ±ï¼Œé€²ä¸€æ­¥æä¾›ç›¸åŒçš„ç’°å¢ƒçµ¦é–‹ç™¼ç’°å¢ƒ (development) èˆ‡ç”Ÿç”¢ç’°å¢ƒ (production)ï¼Œé™ä½ç’°å¢ƒé–“çš„ä¸ä¸€è‡´æ€§é€ æˆçš„å•é¡Œï¼Œæœ€çµ‚æå‡é–‹ç™¼çš„å¯é ç¨‹åº¦ã€ä¸¦åŠ é€Ÿé–‹ç™¼çš„æµç¨‹ã€‚\nå»ºæ§‹é€™å±¤æŠ½è±¡çš„é—œéµæ˜¯ï¼Œä½¿ç”¨å¯†é–‰çš„å®¹å™¨æ˜ è±¡æª” (hermetic container image) ï¼Œå°‡æ‰€æœ‰æ‡‰ç”¨æœ‰é—œçš„ä¾è³´ (dependencies) éƒ½æ‰“åŒ…ï¼Œæ•´åŒ…éƒ¨å±¬åˆ°å®¹å™¨ä¸­ã€‚æ­£ç¢ºåŸ·è¡Œçš„è©±ï¼Œå®¹å™¨å°å¤–éƒ¨çš„ä¾è³´åªå‰©ä¸‹ Linux kernel ç³»çµ±èª¿ç”¨ä»‹é¢ (system-call interface)ã€‚é€™å±¤ä»‹é¢å¤§å¹…æ”¹å–„æ˜ è±¡æª”çš„éƒ¨å±¬æ–¹ä¾¿æ€§ (protability)ï¼Œä½†ç›®å‰æ©Ÿåˆ¶ä»ä¸å®Œç¾ï¼Œæ‡‰ç”¨ä»ç„¶æš´éœ²åœ¨æŸäº›ä½œæ¥­ç³»çµ±çš„ä»‹é¢ä¸Šï¼Œç‰¹åˆ¥æ˜¯ socket optionsã€/procã€ä»¥åŠ ioctl çš„èª¿ç”¨åƒæ•¸ã€‚Google å¸Œæœ›é€éæ¨å»£é–‹æ”¾å®¹å™¨å€¡è­° (Open Container Initiative) ä¾†æ¸…æ¥šç•Œå®šï¼Œä¸Šè¿°ä»‹é¢èˆ‡å®¹å™¨çš„æŠ½è±¡å±¤ã€‚\næ¬¡å¤–ï¼Œå®¹å™¨æä¾›çš„éš”é›¢èˆ‡æœ€å°ä¾è³´ï¼Œåœ¨ Google è­‰æ˜éå¸¸æœ‰æ•ˆï¼Œå®¹å™¨æ˜¯ Google æ¶æ§‹ä¸Šå”¯ä¸€çš„å¯åŸ·è¡Œå–®ä½ (runnable entity)ï¼Œé€²ä¸€æ­¥ä½¿ Google åªæä¾›å°‘æ•¸çš„ä½œæ¥­ç³»çµ±ç‰ˆæœ¬çµ¦æ‰€æœ‰æ©Ÿå™¨ï¼Œåªéœ€è¦å°‘æ•¸çš„ç¶­è­·äººå“¡ä¾†è² è²¬ç®¡ç†ç‰ˆæœ¬ã€‚\nå¯†é–‰å®¹å™¨æ˜ æƒ³æª”æœ‰å¾ˆå¤šæ–¹å¼é”æˆï¼Œåœ¨ Borg å»ºæ§‹æ˜ æƒ³æª”æ™‚ï¼Œæ‡‰ç”¨çš„åŸ·è¡Œæª” (binary) éœæ…‹é€£çµåˆ°å¯ç”¨çš„ç¨‹åºåº« (library) ç‰ˆæœ¬ï¼Œç¨‹å¼åº«åœ¨å…¬å¸å…§éƒ¨å­˜æ”¾ã€‚è‡³æ­¤ Borg å®¹å™¨æ˜ åƒæª”é‚„ä¸æ˜¯å®Œå…¨å¯†é–‰ï¼Œåº•ä¸‹é‚„æœ‰ä¾è³´ä¸€å±¤åŸºåº•æ˜ è±¡æª” (base image)ï¼Œç›´æ¥äº‹å…ˆå®‰è£åˆ°æ©Ÿå™¨ä¸Šï¼Œè€Œä¸æ˜¯éš¨æ˜ åƒæª”éƒ¨å±¬ï¼ŒåŸºåº•æ˜ è±¡æª”åŒ…å«é€šç”¨å·¥å…·ä¾‹å¦‚ tar èˆ‡ libc ç¨‹å¼åº«ï¼Œå› æ­¤æ›´æ–°åŸºåº•æ˜ è±¡æª”ä»æœƒå½±éŸ¿æ‡‰ç”¨ï¼Œå¶çˆ¾æœƒç”¢ç”Ÿå¤§éº»ç…©ã€‚\nç¾ä»£çš„å®¹å™¨æ˜ åƒæª”æ ¼å¼ï¼Œå¦‚ Docker èˆ‡ ACIï¼Œéƒ½åŠ å¼·é€™å±¤æŠ½è±¡ã€æä¾›æ›´ç·Šå¯†çš„å°è£ï¼Œç§»é™¤ç‰¹å®šä½œæ¥­ç³»çµ±çš„ä¾è³´æ€§ï¼Œä¸¦è¦æ±‚ä½¿ç”¨è€…åœ¨åˆ†äº«æ˜ è±¡æª”å…§å®¹æ™‚ï¼Œå¿…é ˆæ˜ç¢ºå®£å‘Šã€‚\nå®¹å™¨ä½œç‚ºç®¡ç†å–®ä½ (Container as the unit of management) åœç¹å®¹å™¨å»ºæ§‹ç®¡ç† APIï¼Œè€Œéåœç¹æ©Ÿå™¨ï¼Œä½¿å¾—è³‡æ–™ä¸­å¿ƒçš„ã€ŒPrimary keyã€å¾æ©Ÿå™¨è®Šæˆæ‡‰ç”¨ã€‚å¸¶ä¾†è¨±å¤šå¥½è™•ï¼š\næ‡‰ç”¨å·¥ç¨‹å¸«èˆ‡ç¶­é‹åœ˜éšŠ (operation team) ä¸éœ€å†ç…©æƒ±æ©Ÿå™¨èˆ‡ä½œæ¥­ç³»çµ±çš„ç´°ç¯€ æ¶æ§‹åœ˜éšŠ (infrastructure team) ç²å¾—æ›´å¤šå‡ç‰ˆæˆ–æ˜¯èª¿åº¦ç¡¬é«”çš„å½ˆæ€§ï¼Œå¯¦éš›å°æ‡‰ç”¨èˆ‡é–‹ç™¼åœ˜éšŠçš„å½±éŸ¿éå¸¸å° ç®¡ç†ç³»çµ±æ”¶é›†æ‡‰ç”¨çš„ç›£æ¸¬æ•¸æ“š (ä¾‹å¦‚ CPU èˆ‡ Memory ä½¿ç”¨ metrics)ï¼Œè€Œéæ©Ÿå™¨çš„ç›£æ¸¬æ•¸æ“šï¼Œç›´æ¥æå‡æ‡‰ç”¨çš„ç›£æ¸¬èˆ‡è‡ªæˆ‘æª¢æŸ¥ (introspection)ï¼Œç‰¹åˆ¥æ˜¯æ“´å±• (scale-up)ã€æ©Ÿå™¨éŒ¯èª¤ã€æˆ–æ˜¯ç¶­è­·æ™‚ï¼Œé€ æˆæ‡‰ç”¨ç§»åˆ°å…¶ä»–ä½ç½®æ™‚ï¼Œç›£æ¸¬ä¾ç„¶å¯ç”¨ã€‚ å®¹å™¨æä¾›è¨±å¤šåˆ‡å…¥é»çµ¦æ³›ç”¨ API (generic API)ï¼Œæ³›ç”¨ API ä½¿è³‡è¨Šåœ¨ç®¡ç†ç³»çµ±èˆ‡æ‡‰ç”¨ä¹‹é–“æµå‹•ï¼Œä½†å…¶å¯¦å…©è€…äº’ç›¸ä¸æ¸…æ¥šå°æ–¹çš„å¯¦ä½œç´°ç¯€ã€‚åœ¨ Borg ä¸­æœ‰ä¸€ç³»åˆ—çš„ API é€£çµåˆ°æ‰€æœ‰å®¹å™¨ï¼Œä¾‹å¦‚ /healthz ç«¯é»å›å ±æ‡‰ç”¨çš„å¥åº·ç¨‹åº¦çµ¦å”èª¿ç®¡ç†è€… (orchestrator)ï¼Œç•¶ç™¼ç¾ä¸å¥åº·çš„æ‡‰ç”¨ï¼Œè‡ªå‹•çµ‚æ­¢ä¸¦é‡å•Ÿæ‡‰ç”¨ã€‚é€™å€‹è‡ªå‹•ä¿®å¾©åŠŸèƒ½æ˜¯å¯é çš„åˆ†æ•£å¼ç³»çµ±çš„åŸºç¤ã€‚(Kubernetes ä¹Ÿæä¾›é¡ä¼¼åŠŸèƒ½ï¼Œé€é HTTP ç«¯é»æˆ–æ˜¯ exec command ä¾†æª¢æŸ¥å®¹å™¨å…§éƒ¨çš„æ‡‰ç”¨)\nå®¹å™¨æä¾›ã€æˆ–æ˜¯æä¾›çµ¦å®¹å™¨çš„è³‡è¨Šï¼Œå¯ä»¥é€éè¨±å¤šä½¿ç”¨è€…ä»‹é¢å‘ˆç¾ã€‚Borg æä¾›å¯ä»¥å‹•æ…‹æ›´æ–°çš„æ–‡å­—ç‹€æ…‹è¨Šæ¯ï¼ŒKubernetes æä¾› key-value çš„ annotation å­˜æ”¾åœ¨çµ¦å€‹ç‰©ä»¶çš„ metadataï¼Œé€™äº›éƒ½èƒ½æºé€šæ‡‰ç”¨ã€‚annotation å¯ä»¥æ˜¯å®¹å™¨è‡ªè¡Œè¨­å®šã€æˆ–æ˜¯ç”±ç®¡ç†ç³»çµ±è¨­å®š (ä¾‹å¦‚æ»¾å‹•æ›´æ–°ç‰ˆæœ¬æ™‚æ¨™è¨»æ–°ç‰ˆæœ¬)ã€‚\nå®¹å™¨ç®¡ç†ç³»çµ±å¯ä»¥å–å¾—å®¹å™¨å…§éƒ¨è¨Šæ¯ï¼Œä¾‹å¦‚è³‡æºä½¿ç”¨ç‹€æ³ã€å®¹å™¨çš„ metadataï¼Œä¸¦å‚³æ’­çµ¦æ—¥èªŒ (logging) æˆ–æ˜¯ç›£æ§ (monitoring)ï¼Œä¾‹å¦‚ä½¿ç”¨è€…åç¨±ã€ç›£æ§ä»»å‹™åç¨±ã€ç”¨æˆ¶èº«åˆ†ã€‚ç”šè‡³é€²ä¸€æ­¥åœ¨ç¯€é»ç¶­è­·æ™‚ï¼Œ â€¦","date":1599889852,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"395acbd23bcba1c70eb2e6ba3ed2556a","permalink":"https://chechia.net/zh-hant/post/2020-09-12-borg-omega-and-kubernetes/","publishdate":"2020-09-12T13:50:52+08:00","relpermalink":"/zh-hant/post/2020-09-12-borg-omega-and-kubernetes/","section":"post","summary":"å‰è¨€ é€™æ˜¯åŸæ–‡å®Œæ•´ç‰ˆæœ¬ã€‚å¤ªé•·ä¸è®€ (TL;DR) è«‹è¦‹Borg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæ‘˜è¦\nåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\næ‘˜è¦ åœ¨ container æŠ€è¡“å¤¯èµ·ä¾†å‰ï¼ŒGoogle å·²ç¶“åšäº† container åå¹¾å¹´ï¼Œéç¨‹ä¸­ç™¼å±•å‡ºéœ€ä¸‰å¥—å®¹å™¨ç®¡ç†ç³»çµ±ã€‚é›–ç„¶æ¯ä¸€ä»£ç³»çµ±çš„é–‹ç™¼éœ€æ±‚ä¸åŒï¼Œä½†æ¯ä¸€ä»£éƒ½æ·±å—ä¸Šä¸€ä»£å½±éŸ¿ã€‚é€™ç¯‡æ–‡ç« æè¿° Google é–‹ç™¼é€™äº›ç³»çµ±æ™‚ï¼Œå­¸åˆ°çš„ç¶“é©—ã€‚\nç¬¬ä¸€å¥— container management ç³»çµ±æ˜¯ Borgï¼Œç‚ºäº†ç®¡ç† 1. é•·æœŸåŸ·è¡Œçš„æœå‹™ 2. æ‰¹æ¬¡çš„çŸ­æœŸå·¥ä½œ (batch job)ï¼ŒåŸæœ¬åˆ†åˆ¥æ˜¯ç”± Babysitter èˆ‡ Global Work Queue å…©å¥—ç³»çµ±åˆ†é–‹ç®¡ç†ã€‚å¾Œè€…çš„æ¶æ§‹æ·±åˆ»å½±éŸ¿ Borgï¼Œä½† Global Work Queue å°ˆæ³¨æ–¼ batch jobã€‚å…©å¥—ç³»çµ±éƒ½åœ¨ Linux control groups ä¹‹å‰ã€‚Borg å°‡ä¸Šè¿°å…©ç¨®æ‡‰ç”¨æ”¾åœ¨å…±äº«çš„æ©Ÿå™¨ä¸Šï¼Œä¾†å¢åŠ è³‡æºçš„ä½¿ç”¨ç‡ï¼Œä»¥ç¯€çœæˆæœ¬ã€‚é€™ç¨®å…±äº«åŸºæ–¼æ”¯æ´ container çš„ Linux Kernel (Google ä¹Ÿè²¢ç»è¨±å¤š Linux kernel container ç¨‹å¼ç¢¼)ï¼Œæä¾›æ›´å¥½çš„éš”é›¢ (isolation) çµ¦å»¶é²æ•æ„Ÿçš„ä½¿ç”¨è€…æœå‹™ (latency-sentitive user-facing services)ï¼Œä»¥åŠæ¶ˆè€—å¤§é‡ cpu çš„ batch ç¨‹å¼ã€‚","tags":["éµäººè³½2020","kubernetes","borg"],"title":"Borg Omega and Kubernetes Translation å…¨æ–‡ç¿»è­¯","type":"post"},{"authors":[],"categories":null,"content":"é€™æ˜¯åŸæ–‡ç¿»è­¯çš„å¤ªé•·ä¸è®€ (TL;DR) ç‰ˆæœ¬ã€‚å®Œæ•´ç¿»è­¯è«‹è¦‹Borg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæµ©æ–‡å®Œæ•´ç¿»è­¯\nåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\nå‰è¨€ Borg ä»¥å‰å°±æœ‰æ‡‰ç”¨ç®¡ç†ç³»çµ±ï¼Œé‚£æ™‚é‚„æ²’æœ‰ Linux control group Borg æ˜¯ç¬¬ä¸€å¥—çµ±ä¸€çš„ container-management system Borg ä»è¢«å¤§è¦æ¨¡çš„ä½¿ç”¨ï¼Œæœ‰è¨±å¤šåŠŸèƒ½è€Œä¸”éå¸¸å …å›º Omega ç¹¼æ‰¿ Borg ä¸ŠæˆåŠŸçš„è¨­è¨ˆï¼Œä¸¦å¸Œæœ›æ”¹é€² Borg çš„ç”Ÿæ…‹ç³» Kubernetes é–‹æº é€é REST API æºé€š client æ‡‰ç”¨é–‹ç™¼å°å‘ï¼Œè‘—é‡æ–¼é–‹ç™¼è€…çš„éœ€æ±‚ï¼Œå¸Œæœ›èƒ½ç°¡å–®çš„éƒ¨ç½²è¤‡é›œçš„ç³»çµ± Container Google ä½¿ç”¨ Container ä¾†ææ˜‡ utilization æŠŠ batch jobs è·Ÿé ç•™è³‡æºçš„æœå‹™ (user-facing app) æ”¾åœ¨ä¸€èµ·ï¼Œä½¿ç”¨é–’ç½®æ™‚çš„è³‡æºè·‘ batch job ç¾ä»£ container çš„å®šç¾©æ˜¯ runtime-isolation èˆ‡ image Application-oriented infrastructure container ä½¿ç”¨ä¹…äº†ï¼Œä¸åªæ»¿è¶³ utilization çš„éœ€æ±‚ è³‡æ–™ä¸­å¿ƒå¾æ©Ÿå™¨å°å‘è®Šæˆæ‡‰ç”¨å°å‘ Container å°è£ç’°å¢ƒï¼ŒæŠŠæ©Ÿå™¨èˆ‡ OS çš„ä¾è³´æŠ½è±¡åŒ– æ‡‰ç”¨ä¸ä¾è³´ éƒ¨ç½²æµç¨‹ runtime infrastrcture Container scope åœ¨æ‡‰ç”¨ä¸Šï¼Œå°ˆæ³¨åœ¨æ‡‰ç”¨ç®¡ç†è€Œä¸æ˜¯æ©Ÿå™¨ç®¡ç† Application environment cgroup, chroot, namespace åŸæœ¬çš„ç›®çš„æ˜¯ç‚ºäº†ä¿è­·æ‡‰ç”¨ï¼Œä¸è¢«å…¶ä»–æ‡‰ç”¨å½±éŸ¿ æ··åˆä½¿ç”¨å¯ä»¥åœ¨æ‡‰ç”¨èˆ‡ OS é–“ç”¢ç”ŸæŠ½è±¡å±¤ï¼Œè§£è€¦ app èˆ‡ OS æä¾›å®Œå…¨ç›¸åŒçš„éƒ¨ç½²ç’°å¢ƒï¼Œé¿å…åˆ‡æ›ç’°å¢ƒ(ex. dev, prod)æ™‚é€ æˆç’°å¢ƒå·®ç•° é€²ä¸€æ­¥æŠŠ app çš„ä¾è³´ç¨‹å¼ä¹Ÿæ‰“åŒ… image container å° OS å”¯ä¸€çš„ä¾è³´åªå‰© Linux kernel system-call interface å¤§å¹…å¢åŠ  app èª¿åº¦çš„å½ˆæ€§ ç„¶è€Œæœ‰äº› interface ä»é™„è‘— OS ä¸Šï¼Œex socket, /prod, ioctl calls å¸Œæœ›é€é Open Container Initiativeï¼Œæ¸…æ¥šå®šç¾© interface èˆ‡æŠ½è±¡ ç›´æ¥çš„å¥½è™•ï¼Œå°‘æ•¸å¹¾ç¨® OS èˆ‡ OS Version å°±å¯ä»¥è·‘æ‰€æœ‰æ‡‰ç”¨ï¼Œæ–°ç‰ˆæœ¬ä¹Ÿä¸å½±éŸ¿ Container as the unit of management è³‡æ–™ä¸­å¿ƒçš„é‡å¿ƒï¼Œå¾ç®¡ç†æ©Ÿå™¨è®Šæˆç®¡ç†æ‡‰ç”¨ æä¾›å½ˆæ€§çµ¦ infrastructure team æä¾›çµ±ä¸€çš„æ¶æ§‹ æ”¶é›†çµ±ä¸€çš„ metrics Container çµ±ä¸€çš„ä»‹é¢ï¼Œè®“ management system (ex. k8s) å¯ä»¥æä¾› generic APIs REST API, HTTP, /healthz, execâ€¦ çµ±ä¸€çš„ health check ä»‹é¢ï¼Œæ›´æ–¹ä¾¿çš„çµ‚æ­¢èˆ‡é‡å•Ÿ ä¸€è‡´æ€§ å®¹å™¨æä¾›çµ±ä¸€çš„è³‡è¨Šï¼Œex. status, text message, â€¦ ç®¡ç†å¹³å°æä¾›çµ±ä¸€è¨­å®š (ex. resource limits) ï¼Œä¸¦é€²è¡Œ logging èˆ‡ monitoring æä¾›æ›´ç²¾ç´°çš„åŠŸèƒ½ ex. graceful-termination cgroups æä¾› app çš„è³‡æºä½¿ç”¨è³‡è¨Šï¼Œè€Œä¸éœ€è¦çŸ¥é“ app specï¼Œå› ç‚º contaier æœ¬èº«å³æ˜¯ app æä¾›æ›´ç°¡å–®ï¼Œå»æ›´ç²¾ç´°ä¸”å …å›ºçš„ logging èˆ‡ monitoring æ‡‰ç”¨å°å‘çš„ monitoring ï¼Œè€Œä¸æ˜¯æ©Ÿå™¨å°å‘çš„ monitoring å¯ä»¥æ”¶é›†è·¨ OS çš„ app ç‹€æ…‹ï¼Œé€²è¡Œæ•´åˆåˆ†æï¼Œè€Œä¸æœƒæœ‰ OS ä¸åŒé€ æˆçš„é›œè¨Š æ›´å®¹æ˜“å°æ‡‰ç”¨é™¤éŒ¯ nested contaiers resource allocation (aka. alloc in Borg, Pod in Kubernetes) Orchestration is the beginning, not the end åŸæœ¬ Borg åªæ˜¯è¦æŠŠ workload åˆ†é…åˆ°å…±ç”¨çš„æ©Ÿå™¨ä¸Šï¼Œä¾†æ”¹å–„ utilization çµæœç™¼ç¾å¯ä»¥åšæ›´å¤šäº‹æƒ…ï¼Œä¾†å¹«åŠ©é–‹ç™¼èˆ‡éƒ¨ç½² Naming, service discovery Application-aware load balancing Rollout tool Workflow tool Monitoring tool æˆåŠŸçš„å·¥å…·è¢«ç•™ä¸‹ ç„¶è€Œå·¥å…·éƒ½éœ€è¦å„è‡ªçš„ APIï¼Œå‰¯ä½œç”¨æ˜¯å¢åŠ éƒ¨ç½²çš„è¤‡é›œåº¦åˆ° Borg çš„ç”Ÿæ…‹ç³» Kubernetese è©¦åœ–é™ä½è¤‡é›œåº¦ æä¾›ä¸€è‡´çš„ API ex. ObjectMetadata, Specification, Status Object metadata æ˜¯å…¨åŸŸå…±é€šçš„ Spec èˆ‡ Status æ ¹æ“š Object æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æ¦‚å¿µæ˜¯ä¸€è‡´çš„ Spec æè¿° desired state of object Status æä¾› read-only çš„ current state of object Uniform API æœ‰è¨±å¤šå¥½è™• é™ä½å­¸ç¿’æˆæœ¬ å¯ä»¥ä½¿ç”¨ generic çš„å·¥å…·è®“æ‰€æœ‰ workflow ä½¿ç”¨ çµ±ä¸€ä½¿ç”¨è€…çš„é–‹ç™¼æµç¨‹èˆ‡é–‹ç™¼ç¶“é©— Kubernetes æœ¬èº«æ¨¡çµ„åŒ–ï¼Œå¯ä»¥ä½¿ç”¨å»¶ä¼¸æ¨¡çµ„ ex. pod API è®“ä½¿ç”¨è€…ä½¿ç”¨ï¼Œkubernetes å…§éƒ¨ä½¿ç”¨ï¼Œå¤–éƒ¨è‡ªå‹•åŒ–å·¥å…·ä¹Ÿä½¿ç”¨ ä½¿ç”¨è€…å¯ä»¥è‡ªå·±å¢åŠ  customized API å¦‚ä½•é”åˆ° Uniform API decoupling API åˆ‡åˆ† API é—œæ³¨çš„é¢å‘ï¼Œè®Šæˆä¸åŒ components API. ex. replication controller ç¢ºä¿ desired æ•¸é‡çš„ Pod å­˜åœ¨ autoscaler é—œæ³¨åœ¨éœ€æ±‚èˆ‡ä½¿ç”¨çš„é æ¸¬ï¼Œç„¶å¾Œæ§åˆ¶ replication controller API higher-level æœå‹™éƒ½å…±ç”¨ç›¸åŒçš„ basic API åˆ‡åˆ† API è€Œå¤–çš„å¥½è™• æœ‰é—œè¯ä½†æ˜¯ç”¨é€”ä¸åŒçš„ API çš„å…§å®¹èˆ‡ä½¿ç”¨æ–¹å¼ååˆ†ç›¸ä¼¼. ex. ReplicationController: æ§åˆ¶é•·æ™‚é–“é‹è¡Œçš„ containers èˆ‡å…¶è¤‡æœ¬ DeamonSet: æ¯å€‹æ©Ÿå™¨ä¸Šéƒ½è·‘ä¸€å€‹ container Job: ä¸€æ¬¡æ€§åŸ·è¡Œå®Œç•¢çš„ container Common design patterns ex. reconciliation controller loop åœ¨ Borg, Omega, Kubernetes ä¸­å¤§é‡ä½¿ç”¨ éœ€æ±‚(desired state) è§€å¯Ÿç¾æ³(current state) åŸ·è¡Œå‹•ä½œï¼Œæ”¶æ–‚éœ€æ±‚èˆ‡ç¾æ³(reconcile) loop ç”±æ–¼ç‹€æ…‹æ˜¯åŸºæ–¼å¯¦éš›è§€æ¸¬ç”¢ç”Ÿï¼Œreconciliation loop éå¸¸å …å›ºï¼Œå¯ä»¥æ‰¿å—ç›¸ç•¶çš„ failure Kubernetes è¨­è¨ˆç‚ºä¸€é€£ä¸²çš„ç‚ºæœå‹™ç³»çµ±ï¼Œä»¥åŠè¨±å¤šå°å‹çš„ control loop å°æ¯”å¤§å‹çš„ centralized orchestration system Things to avoid Google é–‹ç™¼éç¨‹ä¸­ï¼Œä¹Ÿç™¼ç¾è¨±å¤šä¸è©²åšçš„äº‹æƒ…\nä¸è¦ä½¿ç”¨ conainer system ä¾†ç®¡ç† port numbers Borg æœƒæŒ‡å®š unique port number çµ¦æ¯å€‹ container å¿…é ˆç”¨å…¶ä»–æ–¹æ³•å–ä»£ DNS port ä¹Ÿä¸æ˜“åµŒå…¥ URL ä¸­ï¼Œè¦å¦å¤–è™•ç†è½‰å€ éœ€è¦è€Œå¤–çš„ç³»çµ±è™•ç† ip:port Kubernetes é¸æ“‡æŒ‡æ´¾ IP çµ¦ Pod å¯ä»¥ç›´æ¥ä½¿ç”¨å¸¸ç”¨ port (ex. 80,443) å¯ä»¥ä½¿ç”¨å…§éƒ¨ DNSï¼Œä½¿ç”¨ä¸€èˆ¬å¸¸ç”¨çš„å·¥å…· å¤§éƒ¨åˆ†å…¬æœ‰é›²éƒ½æä¾› networking underlaysï¼Œé”æˆ Ip-per-pod å¯ä»¥ä½¿ç”¨ DNS overlay æˆ–æ˜¯ L3 routingï¼Œä¾†æ§åˆ¶ä¸€å°æ©Ÿå™¨ä¸Šçš„å¤šå€‹ IPs ä¸è¦å¹« container ç·¨è™Ÿï¼Œä½¿ç”¨ label ä¾†ç®¡ç†å¤§é‡çš„ container Borg æœƒå¹« job å¾ 0 é–‹å§‹ç·¨è™Ÿ å¾ˆç›´è¦ºå¾ˆç›´æ¥ï¼Œä½†ç¨å¾Œå°±å¾Œæ‚”äº† å¦‚æœ job æ­»äº†ï¼Œé‡å•Ÿæ–°çš„ job åœ¨æ©Ÿå™¨ä¸Šå¾Œï¼Œé‚„éœ€è¦å»æ‰¾ä¸Šå€‹æ­»æ‰çš„ job task ä¸­é–“æœƒæœ‰å¾ˆå¤šæ´ (æ­»æ‰çš„ job) æ›´æ–°ç‰ˆæœ¬ï¼Œè¦æ›´æ–° jobs æ™‚æœƒä¾åºé‡å•Ÿ jobs è³‡æ–™å¦‚æœä¹Ÿæ˜¯æ ¹æ“š index åš shardingï¼Œé‡å•Ÿæ™‚è¦å¾©åŸ indexï¼Œä¸ç„¶æœƒæœ‰è³‡æ–™éºå¤± Kubernetes ä½¿ç”¨ label å¯ä»¥é€é label ç®¡ç†ä¸€çµ„ container ä¸€å€‹ container å¯ä½¿ç”¨å¤šå€‹ labelsï¼Œæ›´æ–¹ä¾¿çš„èª¿åº¦ éœ€è¦çš„è³‡è¨Šæ‰“åœ¨ label ä¸Š (ex. role assignments, work-partitioning, shardingâ€¦)ï¼Œæ›´å®¹æ˜“ç®¡ç† æ³¨æ„æ‰€æœ‰æ¬Š Borg ä¸Šï¼Œtasks éƒ½ç¶å®šåœ¨ job ä¸Šï¼Œç”¢ç”Ÿ job ä¹Ÿç”¢ç”Ÿ tasks å¾ˆç›´è¦ºæ–¹ä¾¿ åªå‰©ä¸‹ä¸€ç¨® group æ§åˆ¶æ©Ÿåˆ¶ Kubernetes çš„ pod-lifecycle management (ex. replication controller) ä½¿ç”¨ label selector ä¾†æ§åˆ¶ pod å¯ä»¥å½ˆæ€§æ§åˆ¶å¤§é‡ pod å¯èƒ½æœ‰å¤šå€‹ä¸Šå±¤ controller æ§åˆ¶åŒä¸€å€‹ podï¼Œè¦ç›¡é‡é¿å…é€™ç¨®æƒ…æ³ å¥½è™•æ˜¯ä¿ç•™å½ˆæ€§çš„åŒæ™‚ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šç•Œå®šç®¡ç†çš„ podï¼Œä¸æœƒæœ‰ orphan / adapt pod é€é label é€²è¡Œ service load balance å¦‚æœ pod æœ‰å•é¡Œï¼Œå¯ä»¥è®Šæ›´ labelï¼Œè®“æµé‡ä¸è¦é€²ä¾†ï¼Œä½†åˆä¿ç•™ Pod debug ä¸è¦æš´éœ² raw state Borgmaster æ˜¯ monolithicï¼Œå¯è¦‹æ‰€æœ‰çš„ API Operation Omega ä¸æ˜¯ centralizedï¼Œåªä¿ç•™è¢«å‹•çš„è³‡è¨Šï¼Œä½¿ç”¨ optimistic concurrent control state å­˜åˆ° client storeï¼Œä¸¦åŸºæ–¼ state é€²è¡Œ operation æ‰€æœ‰ client éœ€è¦ä½¿ç”¨ä¸€æ¨£çš„ client store library Kubernetes èµ°ä¸­é–“ æ‰€æœ‰ state å­˜å–éœ€è¦é€é centralized API server client components å¯ä»¥ç¨ç«‹é‹ä½œ Some open, hard problems configuration dependency management ","date":1598421052,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"666e87031b74dc9e2f3543c53783f03a","permalink":"https://chechia.net/zh-hant/post/2020-08-26-borg-omega-and-kubernetes-tldr/","publishdate":"2020-08-26T13:50:52+08:00","relpermalink":"/zh-hant/post/2020-08-26-borg-omega-and-kubernetes-tldr/","section":"post","summary":"é€™æ˜¯åŸæ–‡ç¿»è­¯çš„å¤ªé•·ä¸è®€ (TL;DR) ç‰ˆæœ¬ã€‚å®Œæ•´ç¿»è­¯è«‹è¦‹Borg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæµ©æ–‡å®Œæ•´ç¿»è­¯\nåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\nå‰è¨€ Borg ä»¥å‰å°±æœ‰æ‡‰ç”¨ç®¡ç†ç³»çµ±ï¼Œé‚£æ™‚é‚„æ²’æœ‰ Linux control group Borg æ˜¯ç¬¬ä¸€å¥—çµ±ä¸€çš„ container-management system Borg ä»è¢«å¤§è¦æ¨¡çš„ä½¿ç”¨ï¼Œæœ‰è¨±å¤šåŠŸèƒ½è€Œä¸”éå¸¸å …å›º Omega ç¹¼æ‰¿ Borg ä¸ŠæˆåŠŸçš„è¨­è¨ˆï¼Œä¸¦å¸Œæœ›æ”¹é€² Borg çš„ç”Ÿæ…‹ç³» Kubernetes é–‹æº é€é REST API æºé€š client æ‡‰ç”¨é–‹ç™¼å°å‘ï¼Œè‘—é‡æ–¼é–‹ç™¼è€…çš„éœ€æ±‚ï¼Œå¸Œæœ›èƒ½ç°¡å–®çš„éƒ¨ç½²è¤‡é›œçš„ç³»çµ± Container Google ä½¿ç”¨ Container ä¾†ææ˜‡ utilization æŠŠ batch jobs è·Ÿé ç•™è³‡æºçš„æœå‹™ (user-facing app) æ”¾åœ¨ä¸€èµ·ï¼Œä½¿ç”¨é–’ç½®æ™‚çš„è³‡æºè·‘ batch job ç¾ä»£ container çš„å®šç¾©æ˜¯ runtime-isolation èˆ‡ image Application-oriented infrastructure container ä½¿ç”¨ä¹…äº†ï¼Œä¸åªæ»¿è¶³ utilization çš„éœ€æ±‚ è³‡æ–™ä¸­å¿ƒå¾æ©Ÿå™¨å°å‘è®Šæˆæ‡‰ç”¨å°å‘ Container å°è£ç’°å¢ƒï¼ŒæŠŠæ©Ÿå™¨èˆ‡ OS çš„ä¾è³´æŠ½è±¡åŒ– æ‡‰ç”¨ä¸ä¾è³´ éƒ¨ç½²æµç¨‹ runtime infrastrcture Container scope åœ¨æ‡‰ç”¨ä¸Šï¼Œå°ˆæ³¨åœ¨æ‡‰ç”¨ç®¡ç†è€Œä¸æ˜¯æ©Ÿå™¨ç®¡ç† Application environment cgroup, chroot, namespace åŸæœ¬çš„ç›®çš„æ˜¯ç‚ºäº†ä¿è­·æ‡‰ç”¨ï¼Œä¸è¢«å…¶ä»–æ‡‰ç”¨å½±éŸ¿ æ··åˆä½¿ç”¨å¯ä»¥åœ¨æ‡‰ç”¨èˆ‡ OS é–“ç”¢ç”ŸæŠ½è±¡å±¤ï¼Œè§£è€¦ app èˆ‡ OS æä¾›å®Œå…¨ç›¸åŒçš„éƒ¨ç½²ç’°å¢ƒï¼Œé¿å…åˆ‡æ›ç’°å¢ƒ(ex.","tags":["kubernetes","google","borg"],"title":"Borg Omega and Kubernetes TLDR æ‘˜è¦ç¿»è­¯","type":"post"},{"authors":[],"categories":["murmur"],"content":"å­£ä¸­å›é¡§\né€™ä¸€å­£é–‹äº†å¾ˆå¤šæ–°å‘ï¼Œå»ä¾†ä¸åŠå¯«æ–‡ç« å¡«ä¸Š\nå®Œæˆçš„æœ‰ Terraform çš„åŸºç¤èˆ‡å¯¦å‹™å°å…¥ç¶“é©—\næ­£åœ¨è¶•å·¥çš„æœ‰ hashicorp vaultï¼ŒGitopsï¼Œèˆ‡ tlsã€‚\nå…¶ä¸­ GitOps å·²ç¶“æœ‰å¼·è€…æˆ‘æœ‹å‹ Hwchiu å·¨å·¨å¡«å‘äº†ï¼Œæˆ‘é€™é‚Šå°±æœƒå·æ‡¶è·³éã€‚å‹æƒ…é€£çµ\nå‰©ä¸‹çš„å¸Œæœ›æœ¬å­£çµæŸå‰èƒ½å¡«å®Œ(æ©é¢)\nå·²å¡«å‘ å¾é›¶é–‹å§‹å°å…¥ Terraform DevOps Taiwan Meetup iThome Cloud Summit æ–°å‘ï¼Œç¢¼è¾²æ­£åœ¨è€•ç”°ï¼ŒæŒ–å‘è‡ªå·±è·³ hashicorp vault install basic operation Sign \u0026amp; manage x509 certificate with pki secret engine å¡«å‘ä¸­ï¼Œæ–‡ç« å°šæœªå®Œæˆ aws\npost/play-aws-eks-with-low-cost: ç²¾ç®—å°ç¥ç«¥ï¼Œå¦‚ä½•ç”¨æœ€å°‘çš„ credits ç© aws eks æœå‹™ tls\npost/openssl-self-sign-tls-with-own-ca post/k8s-manage-tls-certificate gitOps\npost/gitops-with-argo-cd terraform\npost/terraform-infrastructure-as-code-module kubernetes\nborg, omega, and kubernetes ä½œè€…å¤–å‡ºå–æä¸­â€¦ MIT 6.824 Distributed System Learning Note ","date":1597802491,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"59a338847ee61a2c42c9383065c7b6f8","permalink":"https://chechia.net/zh-hant/post/2020-08-19-season-review/","publishdate":"2020-08-19T10:01:31+08:00","relpermalink":"/zh-hant/post/2020-08-19-season-review/","section":"post","summary":"å­£ä¸­å›é¡§\né€™ä¸€å­£é–‹äº†å¾ˆå¤šæ–°å‘ï¼Œå»ä¾†ä¸åŠå¯«æ–‡ç« å¡«ä¸Š\nå®Œæˆçš„æœ‰ Terraform çš„åŸºç¤èˆ‡å¯¦å‹™å°å…¥ç¶“é©—\næ­£åœ¨è¶•å·¥çš„æœ‰ hashicorp vaultï¼ŒGitopsï¼Œèˆ‡ tlsã€‚\nå…¶ä¸­ GitOps å·²ç¶“æœ‰å¼·è€…æˆ‘æœ‹å‹ Hwchiu å·¨å·¨å¡«å‘äº†ï¼Œæˆ‘é€™é‚Šå°±æœƒå·æ‡¶è·³éã€‚å‹æƒ…é€£çµ\nå‰©ä¸‹çš„å¸Œæœ›æœ¬å­£çµæŸå‰èƒ½å¡«å®Œ(æ©é¢)\nå·²å¡«å‘ å¾é›¶é–‹å§‹å°å…¥ Terraform DevOps Taiwan Meetup iThome Cloud Summit æ–°å‘ï¼Œç¢¼è¾²æ­£åœ¨è€•ç”°ï¼ŒæŒ–å‘è‡ªå·±è·³ hashicorp vault install basic operation Sign \u0026 manage x509 certificate with pki secret engine å¡«å‘ä¸­ï¼Œæ–‡ç« å°šæœªå®Œæˆ aws","tags":[],"title":"2020 08 Season Review","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nå„ä½å¥½\nAbout this presentation é–‹å§‹ä¹‹å‰ï¼Œå…ˆåˆ†äº«ä¸€äº›è³‡æº\næŠ•å½±ç‰‡ è¬›ç¨¿ ç¨‹å¼ç¢¼ SOP ç¯„æœ¬ Facebook ç²‰å°ˆ éƒ½æ”¾åœ¨é€™è£¡ï¼Œå› ç‚ºæœ‰é™„é€å­—ç¨¿ï¼Œæ‰€ä»¥å¦‚æœå¾ˆå¿™çš„æœ‹å‹ï¼Œæƒäº† QR code å°±å¯ä»¥å›å®¶è‡ªå·±çœ‹äº†ï¼Œä¸ç”¨å®¢æ°£ã€‚\nç„¶å¾Œæœ‰èˆˆè¶£åœ¨è¿½é€™ç³»åˆ—æ–‡ç« çš„ï¼Œå¯ä»¥å¹«æˆ‘ facebook ç²‰å°ˆæŒ‰å€‹è®šè·Ÿè¿½è¹¤ï¼Œæ¯å‘¨æ–°æ–‡ç« å‡ºä¾†ï¼Œæœƒæ¨æ’­é€šçŸ¥ã€‚\næ–‡ç« åœ¨ chechia.net ä¸Šï¼Œæ–°æ–‡ç« é€šçŸ¥é  facebook ç²‰å°ˆé€™æ¨£ã€‚ä¹Ÿå¯ä»¥åªè¿½è¹¤ä¸æŒ‰è®šã€‚æˆ‘è‡ªå·±çœ‹åˆ¥äººæŠ€è¡“ blog ä¹Ÿå¾ˆå¸¸é€™æ¨£(XD\néœ€æ±‚ å¥½ï¼Œä»Šå¤©ä¾†è¬›å¾—é€™å€‹ Terraform\næˆ‘æœƒå¯¦éš›åˆ†äº«æˆ‘å€‘å…¬å¸ç‚ºé›²åœ˜éšŠå°å…¥çš„ç¶“é©—ï¼Œå‰åŠéƒ¨æœƒæœ‰é»åƒè³¼ç‰©é »é“çš„å»£å‘Š\nä»¥ä¸‹çš„å°è©±æ˜¯ä¸æ˜¯å¸¸å‡ºç¾åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Ÿ\nä»¥ä¸‹é€™æ®µå°è©±å¾ˆè€³ç†Ÿï¼Ÿ ã€Œæ˜¯èª°æ”¹äº†é€™å€‹è¨­å®šï¼Ÿã€\nby é€±ä¸€ä¸Šç­çš„ DevOps èˆ‡é€±å…­å€¼ç­çš„ç¶­é‹åœ˜éšŠ å°å•Ÿç”¨çš„ç’°å¢ƒçš„æŒæ¡å¦‚ä½• ç’°å¢ƒçš„è®Šæ›´èƒ½å¦æ°¸ä¹…ä¿å­˜ ã€Œé€™å€‹ç’°å¢ƒæ€éº¼å°‘ä¸€å€‹è¨­å®šï¼Ÿã€\nç¶²ç«™å™´éŒ¯å¾Œï¼Œæ•´å€‹åœ˜éšŠä¸€æ­¥æ­¥é‡æ¸…å•é¡Œï¼Œä¸æ˜¯ codeï¼Œä¸æ˜¯è®Šæ•¸configï¼Œæ˜¯ infra æœ‰ä¸€å€‹å°åœ°æ–¹æ²’è¨­å®š ç’°å¢ƒè¤‡é›œï¼Œä»¥æˆ‘å€‘çš„ä¾‹å­æ˜¯è¤‡é›œå¾—å¤šé›²ç¶²è·¯ï¼Œå¸¸å‡ºé€™ç¨®å•é¡Œ ç’°å¢ƒè¨­å®šçš„é™¤éŒ¯å¾ˆè²»æ™‚ å®Œå…¨å¯ä»¥é¿å… ã€Œæœƒå‹•å°±å¥½ï¼Œæ²’äº‹ä¸è¦æ”¹ç’°å¢ƒï¼ˆæŠ–ï¼‰ã€\nLegacy site èª¿æ•´ production ç’°å¢ƒæ˜¯å¦æœ‰ä¿¡å¿ƒ æˆ‘å€‘çœ‹ä¸æ…£ç„¡äººæ•´ç†çš„èˆŠæ¶æ§‹ï¼Œå°å…¥ terraform å¾Œï¼Œï¼ˆå¾ˆä¸è¦å‘½çš„ï¼‰æŠŠ production site æ¬éä¸€é æˆ‘æœ‰åæˆçš„ä¿¡å¿ƒè·Ÿä½ èªªæ–°èˆŠå…©å€‹ site å®Œå…¨ä¸€æ¨£ Our stories æˆ‘å€‘æ˜¯æ€è¯ç§‘æŠ€(ï¼¸ï¼¤) é–‹ç™¼åœ˜éšŠå¤§æ¦‚ 100+ å€‹å·¦å³ å°ˆæ¡ˆå¾ˆå¤šï¼Œè€Œä¸”è€é—†å¾ˆå–œæ­¡é–‹æ–°å°ˆæ¡ˆæ¸¬è©¦å•†æ¥­æ¨¡å‹ ç’°å¢ƒä¹Ÿè¶Šé–‹è¶Šå¤šï¼Œå¤§å¤§å°å°å¹¾ç™¾å° vmï¼Œå¹¾åå€‹è³‡æ–™åº«ï¼Œéƒ½æ˜¯ä¸åŒå°ˆæ¡ˆåœ¨è·‘ï¼Œè¦æ¨¡å¤§æ¦‚é€™æ¨£ æ¯é€±éƒ½æœ‰æ–°ç’°å¢ƒè¦äº¤ä»˜ äº¤æ¥ç¼ºå£ æˆ‘å€‘å…¬å¸æ±è¥¿å¤šï¼Œä½†æ±è¥¿å¤šä¸æ˜¯å•é¡Œï¼Œå•é¡Œæ˜¯ä»€éº¼å‘¢?\nå•é¡Œ æ‰‹å‹•éƒ¨å±¬æœ¬ä¾†ä¸æ˜¯å•é¡Œï¼Œä½†æ¼¸æ¼¸æˆç‚ºå•é¡Œ é–‹ infrastructure çš„æ–¹æ³•ï¼Œè·Ÿè‘— SOP ä¸Šå» GCP GUI ä»‹é¢ï¼Œé»ä¸€é»ï¼Œå¡«ä¸€å¡«ã€‚å…¬æœ‰é›²é–‹æ©Ÿå™¨å¾ˆæ–¹ä¾¿ã€‚ å¯æ˜¯ä¸åŒäººé–‹çš„ç’°å¢ƒæ¼¸æ¼¸å‡ºç¾ä¸€äº›ä¸åŒï¼Œå¯èƒ½å·®ä¸€å€‹è¨­å®šã€ä¸€å€‹åƒæ•¸ã€æˆ–æ˜¯å‘½åè¦å‰‡å·®ä¸€é»ã€‚é€™äº›ç´°ç¯€çš„ä¸åŒï¼Œå·®ä¸€å€‹ config æœ‰æ™‚å€™å°±æœƒé›·åˆ°äººã€‚ã€Œé€™æ©Ÿå™¨èª°å»ºçš„é˜¿ï¼Œæ ¹æœ¬æœ‰å•é¡Œå•Šã€ï¼Œè€Œä¸”é€™ç¨®é›·å¾ˆå¤šæ™‚å€™éƒ½æ˜¯è·‘ä¸‹å»å‡ºäº‹äº†ï¼Œæ‰ç™¼ç¾ã€Œé˜¿é åŸä¾†è¨­å®šä¸ä¸€æ¨£ã€ å‘½åå·®ä¸€é»ä¸å½±éŸ¿åŠŸèƒ½ï¼Œä½†çœ‹ä¹…äº†å°±å¾ˆç…©ï¼Œã€Œé˜¿å°±å°ä¸é½Šé˜¿ã€ï¼Œæœ‰å¼·è¿«ç—‡å°±å¾ˆç—›è‹¦ã€‚ç„¶å¾Œä½ ç¶­é‹çš„è‡ªå‹•åŒ–è…³æœ¬å°±çˆ†æ‰ï¼Œå‘½åå·®ä¸€å€‹å­—ï¼Œregex å°±è¦å¤§æ”¹ã€‚çªç„¶å¢åŠ ç¶­é‹æˆæœ¬ ç”Ÿç”¢ç’°å¢ƒå¤§å®¶éƒ½ä¸å¤ªæ•¢å‹•ã€‚æ¶æ§‹èª¿æ•´å¾ˆæ²’ä¿¡å¿ƒ èª°çŸ¥é“ç•¶åˆç’°å¢ƒè¨­å®šäº†é‚£äº›æ±è¥¿ï¼Œé–‹æ©Ÿå™¨çš„äººé›¢è·äº†ï¼Œä¹Ÿä¸çŸ¥é“ä»–ç‚ºå•¥è¨­å®šï¼Œã€Œä½ çŸ¥é“ä»–ç•¶åˆç‚ºä»€éº¼è¦è¨­å®šé€™å€‹å—?ã€ï¼Œä½ å•æˆ‘æˆ‘æ˜¯è¦å»æ“²èŒ­å–”ã€‚ æˆ‘å€‘é€™ä¸€å­£æŠŠæ‰€æœ‰ç¾æœ‰ç’°å¢ƒéƒ½æ¬åˆ°æ–°çš„æ¶æ§‹ä¸Šï¼Œå› ç‚ºæˆ‘å€‘å°èˆŠæ¶æ§‹ä¸çˆ½å¾ˆä¹…äº†(XD)ï¼Œé€™å€‹èƒ½åšåˆ°ç•¶ç„¶æœ‰ä½œæ³•ï¼Œå¾Œé¢ç´°è¬› æœ‰å¯¦éš›éœ€æ±‚æ‰æ‰¾è§£æ±ºæ–¹æ¡ˆï¼Œæ²’æœ‰éœ€æ±‚å°±ä¸ç”¨è¡å‹•å°å…¥æ–°æŠ€è¡“ï¼Œå°å…¥éç¨‹ä¸­é‚„æ˜¯è »ç´¯çš„\néœ€æ±‚ å¾ç¶­é‹çš„è§’åº¦ï¼Œéœ€æ±‚å¤§æ¦‚é•·é€™æ¨£\næå‡ç©©å®šåº¦\ninfra äº¤ä»˜æ¨™æº–åŒ– äº¤ä»˜è‡ªå‹•åŒ– æ¸¬è©¦ç’°å¢ƒ infra æäº¤è¦èƒ½å¤  review\næå‡æ•ˆç‡\nè€é—†è¦çš„ã€‚è¶…å¿«éƒ¨å±¬ï¼Œè…³æœ¬è·‘ä¸‹å»è¦å¿«ï¼Œé‚„è¦æ›´å¿« æ¬¡è¦ç›®æ¨™\næˆæœ¬ï¼Œæ•ˆèƒ½æœ€ä½³åŒ–ï¼Œå¸Œæœ›èƒ½åœ¨æ•´ç†éç¨‹ä¸­ï¼Œæ‰¾åˆ°æœ€é©åˆçš„å¯è¡Œæ¶æ§‹ æ–°äººå¥½ä¸Šæ‰‹ï¼ŒJunior åŒäº‹ä¹Ÿèƒ½ã€Œå®‰å…¨ã€çš„æ“ä½œï¼Œçœ‹åˆ°é€™å€‹å®‰å…¨å…©å€‹å­—äº†å—? å®‰å…¨ç¬¬ä¸€ï¼Œåœ¨è¨“ç·´æ–°çš„ op æ™‚è¦æ³¨æ„å®‰å…¨ï¼Œä¸ç„¶ä»–ä¸Šå» GUI é»ä¸€é»ï¼Œä¸€å€‹æ‰‹èµ·åˆ€è½ DB å°±ä¸è¦‹äº†ï¼Œæ•´å€‹ç¶­é‹åœ˜éšŠä¸€å‘¨ä¸ç”¨ç¡è¦ºã€‚å®‰å…¨ç¬¬ä¸€å¼ã€‚ æ¬Šé™æ§ç®¡ï¼ŒIAM ä¹Ÿç”¨ terraform ç®¡ç†ï¼Œæ¬Šé™ç®¡ç†äººå¤šæ‰‹é›œè¶Šç”¨è¶Šäº‚ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ IaCï¼Œä¸€è¦½ç„¡éº Programatical approach for infra å•Šä¸å°±æ˜¯ Infrastructure as code XD\nå°å…¥å‰ï¼Œå¤§å®¶éƒ½æœ‰è½éï¼Œå¤§å®¶éƒ½è¦ºå¾—å¾ˆæƒ³å°å…¥ï¼Œä½†æ²’äººæœ‰ç¶“é©—ï¼Œæ¯å€‹äººéƒ½è¶…æ€•ï¼Œä½†åˆä¸çŸ¥é“åœ¨æ€•ä¸‰å° é€™è¡¨æ˜äº†ä¸€ä»¶äº‹ï¼Œå¤§å®¶éƒ½çŸ¥é“è¦åšå°çš„äº‹æƒ…ï¼Œä½†ä¸æ˜¯æ¯å€‹äººéƒ½èƒ½æ”¹è®Šç¾æ³ï¼Œè®“åœ˜éšŠå°å‘å°çš„äº‹æƒ… è¨ˆç•«\nç¢ºå®šéœ€æ±‚ é–‹å§‹ survey ã€Œå°å¿ƒã€å°å…¥ æœ‰ç¶“é©—é ˜é ­ç¾Šå¾ˆæ£’ï¼Œä½†ä¸æ˜¯å¿…é ˆ æŠ€è¡“ç´°ç¯€ å…ˆç°¡å–®è¬›ä¸€ä¸‹ IaC (Yeah çµ‚æ–¼è¦è¬›æŠ€è¡“äº†)\nIaC ä¸Šé¢éƒ½è¬›æ¦‚å¿µè·Ÿå¿ƒæ³•ï¼Œç¾åœ¨å¯¦éš›è¬›ç”¨åˆ°çš„æŠ€è¡“ã€‚\né¦–å…ˆæ˜¯ Infrastructure as Codeï¼Œé€™å€‹æ¦‚å¿µå¾ˆä¹…äº†ï¼Œä½†å°å…¥çš„å…¬å¸å¥½åƒä¸æ˜¯é‚£éº¼å¤šã€‚æ‰€ä»¥æˆ‘ä»Šå¤©è¦ä¾†å‚³æ•™ï¼Œæ´—è…¦å¤§å®¶(XDï¼Œè·Ÿä½ æ¨è–¦é€™å€‹é…æ–¹ä¿è­‰å¿«åˆæœ‰æ•ˆ(XD)\nç°¡å–®ä¾†èªªå°±æ˜¯ç”¨ç¨‹å¼ä¾†æ“ä½œ infrastructureï¼Œä»Šå¤©ä¸»è¬›çš„ terraform æ˜¯ IaC å·¥å…·ä¸­çš„ä¸€å€‹ IaC å·¥å…·å¯ä»¥æ˜¯å®£å‘Šå¼ï¼Œæˆ–æ˜¯å‘½ä»¤å¼ï¼Œæˆ–æ˜¯å…©ç¨®éƒ½æ”¯æ´ ä¸€å€‹æ˜¯æˆ‘å‘Šè¨´ä½ çµæœï¼Œæ­¥é©Ÿæˆ‘ä¸ç®¡ï¼Œè«‹ä½ å¹«æˆ‘ç”Ÿå‡ºé€™æ¨£çš„çµæœã€‚ ä¸€å€‹æ˜¯æˆ‘å‘Šè¨´ä½ æ­¥é©Ÿï¼Œä½ ä¸€æ­¥ä¸€æ­¥å¹«æˆ‘åšå®Œï¼Œå°±æœƒå¾—åˆ°æˆ‘è¦çš„çµæœ terraform æ˜¯å®£å‘Šå¼ï¼Œèªªæ˜é‚è¼¯è·Ÿçµæœï¼Œä¾‹å¦‚æˆ‘è¦ 1 2 3 å°æ©Ÿå™¨ï¼Œterraform è‡ªå·±å»å¹«æˆ‘æ‰“ Google API é€™æ¨£ï¼ŒæŠŠæ©Ÿå™¨ç”Ÿå‡ºä¾† ansible æ˜¯å‘½ä»¤å¼ï¼Œæˆ‘æŠŠæ­¥é©Ÿå¯«æˆä¸€å †å‘½ä»¤è…³æœ¬ playbook ï¼Œansible å¹«æˆ‘ç…§è‘—è·‘ä¸‹å»ï¼Œç†è«–ä¸Šè·‘å®Œå¾Œæˆ‘çš„æ©Ÿå™¨ä¹Ÿæº–å‚™å¥½ Terraform å®˜ç¶²åœ¨é€™é‚Šï¼Œè‡ªå·±çœ‹ https://www.terraform.io/ å®£å‘Šå¼çš„ Iac å·¥å…· å–®ä¸€èªæ³•æè¿°å„å®¶ API é€é provider è½‰æ› tf æˆç‚º API call Terraform Core Workflow https://www.terraform.io/guides/core-workflow.html\nWrite æ’°å¯«æœŸå¾…ç‹€æ…‹ tf file plan è¨ˆç•«è©¦ç®—çµæœ apply ç”¨æœŸå¾…ç‹€æ…‹å»æ›´æ–°é ç«¯ tf fileï¼Œå°±æ˜¯å®£å‘Šå¼çš„è¡¨é” infra ï¼Œæè¿°æœŸå¾…çš„infraé•·é€™æ¨£ï¼Œex. tf file è£¡æœ‰é€™äº›æ©Ÿå™¨ 1 2 3 å°é€™æ¨£ resource ä¸€å€‹ä¸€å€‹ç‰©ä»¶æè¿°ï¼Œå¾Œé¢å¯èƒ½æ˜¯å°æ˜  provider çš„ API Endpoint (ex. GCP GKE API) remote resourcesï¼Œæ˜¯çœŸå¯¦å­˜åœ¨é ç«¯çš„æ©Ÿå™¨ï¼Œä¾‹å¦‚ GCP é›²ç«¯å¯¦éš›ä¸Šåªæœ‰ 1 2 å…©å°é€™æ¨£ã€‚ terraform diff tf vs remoteï¼Œç®—å‡º planï¼Œå°‘çš„ç”Ÿå‡ºä¾†ï¼Œå¤šçš„ä¸Šå»ç æ‰ Demo 1 (empty project)\nadd my-gce.tf\ngit diff\nstate\ncheck GUI remote\nexisting my-gce\nremove my-gce.tf\nplan\né€™é‚Šä¸ apply æˆ‘ demo é‚„è¦ç”¨\né€™é‚Šé€™æ¨£æœ‰ç†è§£ terraform çš„åŸºæœ¬æµç¨‹å—ï¼Ÿç·¨å¯«ï¼Œè¨ˆç•«ï¼Œapply ä¸‰æ­¥é©Ÿ å¾ˆå–®ç´” ç„¶å¾Œè¬›ä¸€é»ç´°ç¯€\nstate\nremove (out of scope)\nplan -\u0026gt; addd\napply (deplicated ID)\nmv state (Danger)\nrename state with the same ID -\u0026gt; destroy and recreate (Danger)\nState terraform ç¶“æ‰‹(apply) éçš„ resource æœƒç´å…¥ state (scope)\nä¸åœ¨ scope è£¡çš„ resource ä¸æœƒç´å…¥ planï¼Œä¸æœƒè¢« destroyï¼Œä½†å¯èƒ½æœƒ create duplicated ID\nterraform å…è¨±ç›´æ¥æ“ä½œ state\nimport remove ä½†æˆ‘ä¸å…è¨±XD æ³¨æ„æ˜¯ diff state å–”ï¼Œæ‰€ä»¥æ¯æ¬¡ plan æ™‚å€™æœƒè‡ªå‹• refresh state\nstate åˆæ˜¯ä»€éº¼? remote æ˜¯ä¸€å€‹å‹•æ…‹ç’°å¢ƒï¼Œå¯èƒ½æœƒå¤šæœƒå°‘ï¼Œé€™æ¨£æ²’è¾¦æ³• diffï¼Œstate æ˜¯æŠŠæˆ‘åŸ·è¡Œç•¶ä¸‹ï¼Œé ç«¯ç›¸é—œè³‡æºçš„ç‹€æ…‹å¿«ç…§å­˜èµ·ä¾†ï¼Œç„¶å¾Œæ ¹æ“šé€™å€‹ snapshop å» diff\napply åªæ˜¯æ‹¿ä½ çš„æœŸå¾…å» diff stateï¼Œterraform å¹«ä½ ç®—å‡ºä¾†å·®å¤šå°‘ï¼Œä¾‹å¦‚æˆ‘å€‘é€™é‚Šå°±æ˜¯é ç«¯å°‘ä¸€å°ã€‚terraform é€é provider å»çŸ¥é“ï¼Œå–”é€™ä¸€å°è¦å»æ‰“é‚£äº› GCP APIï¼ŒæŠŠé€™å°ç”Ÿå‡ºä¾†ã€‚\nStateï¼Œæ˜¯æ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ç•¶åˆè‡ªå·±å¡è§€å¿µæ˜¯å¡é€™é‚Šï¼Œæ‰€ä»¥æˆ‘ç‰¹åˆ¥æ‹‰å‡ºä¾†è¬›\né›²ç«¯ç©ºè•©è•©ï¼Œrefresh state ä¹Ÿæ˜¯ç©ºçš„ï¼Œtf file å¤šåŠ ä¸€å€‹ VMï¼Œplan è¦ºå¾—è¦ create é›²ç«¯æœ‰æ±è¥¿ï¼Œrefresh state æœªå¿…æœƒ refresh åˆ° ç›¸åŒ ID çš„è³‡æºä¹‹å‰ import åœ¨ state ä¸­ï¼Œrefresh stateï¼Œtf file æ²’æ±è¥¿ï¼Œplan è¦ºå¾—è¦ destroy ç›¸åŒ ID çš„è³‡æºä¸åœ¨ state ä¸­ï¼Œé€™äº› resource ä¸åœ¨ç•¶å‰ state çš„ scopor ä¸­ï¼Œrefresh state æ˜¯ç©ºçš„ï¼Œtf file æ²’æ±è¥¿ï¼Œplan è¦ºå¾—æ²’å¢æ²’æ¸› ç›¸åŒ ID çš„è³‡æºä¸åœ¨ state ä¸­ï¼Œé€™äº› resource ä¸åœ¨ç•¶å‰ state çš„ scopor ä¸­ï¼Œrefresh state æ˜¯ç©ºçš„ï¼Œtf file æœ‰ç›¸åŒ ID çš„è³‡æºï¼Œplan è¦ºå¾—è¦ createï¼Œä½†å¯¦éš› applyï¼ŒAPI error é ç«¯å·²ç¶“æœ‰ç›¸åŒ ID çš„è³‡æºå­˜åœ¨ å°çµ Write -\u0026gt; Plan -\u0026gt; Apply State å¤§å®¶éƒ½æœƒ terraform æƒ¹ åˆæ­¥ä½¿ç”¨æ„Ÿæƒ³ IaC åœ°ç«¯è·Ÿé›²ç«¯éƒ½èƒ½åšï¼Œä½†é›²ç«¯åšèµ·ä¾†æ•ˆæœè¶…ç´šå¥½ å®Œå…¨å±•ç¾é›²ç«¯é‹ç®—çš„ç‰¹æ€§ï¼Œè¿…é€Ÿã€å½ˆæ€§ã€éš¨ç”¨éš¨å«ï¼Œèª¿åº¦å¤§é‡çš„è™›æ“¬åŒ–è³‡æº æ–°å¢æ±è¥¿å¾ˆå¿«ï¼Œä¸è¦çš„è³‡æºï¼Œè¦åˆªæ‰ä¹Ÿå¾ˆå¿« ä¸å°å¿ƒåˆªéŒ¯ä¹Ÿå¾ˆå¿«(å¤§èª¤)ï¼Œæ‰€ä»¥æˆ‘èªªæ–°äººä¸€å€‹æ‰‹èµ·åˆ€è½å…¬å¸æ•´å€‹é›²å¼„ä¸è¦‹ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼Œã€Œå•Šæˆ‘çš„é›²å‹’ã€ã€Œè¢« terraform ç äº†ã€ã€‚ä¸è¦ç¬‘ï¼Œé‚£å€‹æ–°äººå°±æ˜¯æˆ‘ï¼Œæˆ‘è‡ªå·±å‰›å­¸çš„æ™‚å€™å°±æœ‰æŠŠæ•´å€‹ db è®Šä¸è¦‹éï¼Œå·®é»ä¸€åˆ°è·å°±å¼•å’è¾­è·(XDã€‚ç”¨é€™äº›æŠ€è¡“é‚„æ˜¯æœ‰å¾ˆå¤šå®‰å…¨è¦æ³¨æ„ï¼Œç¨å¾Œæœƒç´°è¬›æ³¨æ„çš„å®‰å…¨äº‹é …ã€‚ ç¸½ä¹‹ï¼ŒIac å°±æ˜¯ç”¨ç¨‹å¼åŒ–çš„èªæ³•ï¼Œç²¾æº–çš„æè¿°é›²ç«¯çš„ç‹€æ…‹æˆ–æ˜¯æ­¥é©Ÿï¼Œå®Œå…¨æ²’æœ‰æ¨¡ç³Šçš„åœ°å¸¶ã€‚å¸¶ä¾†çš„å¥½è™•ï¼Œé™ä½ç¶­é‹çš„éŒ¯èª¤é¢¨éšªï¼ŒåŠ å¿«ç¶­é‹æ•ˆç‡ï¼Œæœ€ä½³åŒ–ç¯€çœæˆæœ¬ã€‚\næ–°æ‰‹ state çš„é›· å¤šäººå”ä½œï¼ŒåŒæ™‚è®Šæ›´ state æœƒé€ æˆä¸å¯é æœŸçš„éŒ¯èª¤ é¿å…ç›´æ¥æ“ä½œ state state å¯èƒ½æœ‰ sensitive è³‡æ–™ æ¨è–¦ä½¿ç”¨å¤–éƒ¨å¸¶æœ‰ lock çš„ state storage å°å…¥ å°å…¥å·¥å…·ä¹‹å¾Œ æ–°å·¥å…·å°å…¥æ™‚è¦åšå¥½é¢¨éšªè©•ä¼°ï¼Œæ¯å€‹äººéƒ½æ˜¯ç¬¬ä¸€æ¬¡ç”¨ terraform ï¼Œç”¨èµ·ä¾†å¾ˆå¿«å¾ˆçˆ½çš„åŒæ™‚ä¹Ÿè¦ä¸æ–·å®£å°å®‰å…¨æ¦‚å¿µï¼Œé›·åœ¨å“ªè£¡å‘åœ¨å“ªè£¡ã€‚\nä½¿ç”¨ terraform çš„é¢¨éšª\næ‰“ DELET API è¶…å¿«ï¼Œç èµ·ä¾†å¾ˆæ–¹ä¾¿ï¼Œä½†å¾ˆå¤šæ™‚å€™æ–¹ä¾¿ = å±éšªã€‚çœ¼çœ‹å°æ˜ä¸€å€‹æ‰‹èµ·åˆ€è½ï¼Œè«‡ç¬‘é–“ï¼Œå…¬æœ‰é›²ç°é£›ç…™æ»…(XDï¼Œé€šé€šè®Šä¸è¦‹ã€‚ç¾åœ¨åœ¨è¬›æ•…äº‹å¾ˆé–‹å¿ƒï¼Œå¯¦éš›ç™¼ç”Ÿçš„è©±å¤§å®¶éƒ½ç¬‘ä¸å‡ºä¾†ï¼Œå…¨å…¬å¸ RD éƒ½è·‘ä¾†ç¶­é‹éƒ¨é–€æ’éšŠç›¯è‘—ä½ çœ‹ï¼Œå°±ç®—ä¿®å¥½ä¹Ÿè¦æ‡²è™•ã€‚å£“åŠ›è¶…å¤§ã€‚ä½†å°æ˜ç éŒ¯æ±è¥¿ä¸æ˜¯å°æ˜çš„éŒ¯ï¼Œæ˜¯å¤§ç’°å¢ƒçš„éŒ¯æ˜¯ SOP çš„éŒ¯(XDã€‚èªçœŸçš„ï¼Œåœ˜éšŠæ²’æœ‰æä¾› SOPï¼Œæ–°äººç éŒ¯æ±è¥¿ç•¶ç„¶æ˜¯åœ˜éšŠè² è²¬ã€‚æ‰€ä»¥æˆ‘å€‘ SOP ç¬¬ä¸€è¡Œå°±å¯«å¾—å¾ˆæ¸…æ¥šã€‚ çœ‹è¦‹ destroy å°±é›™æ‰‹é›¢é–‹éµç›¤ï¼Œç›´æ¥æ±‚æ•‘ï¼Œé€™æ¨£é‚„èƒ½å‡ºäº‹å— å†ä¾†ï¼Œçµ¦äºˆç‰¹æ®Šçš„ IAM æ¬Šé™ï¼Œä¾‹å¦‚åªèƒ½æ–°å¢ä¸èƒ½åˆªé™¤çš„æ¬Šé™ é€²ä¸€æ­¥å°å…¥ git-flowï¼Œpushã€reviewã€PRï¼Œè®“ä»–é€£çŠ¯éŒ¯çš„æ©Ÿæœƒéƒ½æ²’æœ‰ æ ¹æœ¬é‚„æ˜¯è¦çµ¦äºˆæ–°äººè¶³å¤ çš„è¨“ç·´ï¼Œç„¶å¾ŒåŒæ™‚ä¿éšœå…¬å¸å®‰å…¨ã€‚ çµ¦æ–°äººéå¤§æ¬Šé™ç éŒ¯æ±è¥¿ï¼Œæˆ–æ˜¯ â€¦","date":1592189936,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"9bf6153ba216ac1387faeea40f40fa95","permalink":"https://chechia.net/zh-hant/post/2020-06-15-terraform-infrastructure-as-code-transcript/","publishdate":"2020-06-15T10:58:56+08:00","relpermalink":"/zh-hant/post/2020-06-15-terraform-infrastructure-as-code-transcript/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","devops","iac"],"title":"Terraform Infrastructure as Code Transcript","type":"post"},{"authors":[],"categories":["kubernetes","terraform"],"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nOutlline our story: issues, steps, \u0026amp; results basics IaC, terraform benefits risks and å‘ to be or not to be experience oriented\nOur stories 100+ devs, many teams 25+ projects 50+ GKEs 80+ SQLs IAMs, redis, VPCs, load-balancers, â€¦ Issues Ops manually create resources through GUI by SOP. We have many isolated, separeated resources, VPCs. Itâ€™s our culture, and we (devops) want to change. Some projects have short life-cycle. Rapid resources created \u0026amp; destroy. Our user story As a devops, I would like to introduce terraform (IaC) so that I can\nreview all existing resources minimize error from manual operation ASAP!! As a devops, I would like to fully enforce terraform (IaC) so that I can\nminimize efforts to operate infra delegate infra operations to junior team members minimize IAM privilges Introduction import existing resources review existing resources code plan best practice resource templates create new resources with templates introduce git workflow, plan, commit, PR, and review add wrapper handler automation pipeline repeat 2-4 IaC Programatic way to operate infra declarative (functional) vs. imperative (procedural) Perfect for public cloud, cloud native, virtualized resources Benefits: cost (reduction), speed (faster execution) and risk (remove errors and security violations) Terraform Terraform\nDeclarative (functional) IaC Invoke API delegation State management providers: azure / aws / gcp /alicloud / â€¦ Demo https://github.com/chechiachang/terraform-playground\nScope Compute Instances\nKubernetes\nDatabases\nIAM\nNetworking\nLoad Balancer\nExpected benefits Minimize manual operation.\nZero manual operation error\nStandarized infra. Infra as a (stable) product. fast, really fast to duplicate envs\nInfra workflow with infra review\nEasy to create identical dev, staging, prod envs Reviewed infra. Better workflow. Code needs reviews, so do infra. Fully automized infra pipeline.\nOther Benefits Donâ€™t afraid to change prod sites anymore We made a massive infra migration in this quater!! Better readability to GUI. Allow comment everywhere. Risks Incorrect usage could cause massive destruction. å¦‚æœçœ‹è¦‹ destroy çš„æç¤ºï¼Œè«‹é›™æ‰‹é›¢é–‹éµç›¤ã€‚ ~ first line in our SOP If see â€œdestroyâ€, cancel operation \u0026amp; call for help. State management A little latency between infra version and terraform provider version Reduce Risks Sufficient understanding to infra \u0026amp; terraform Sufficient training to juniors Minimize IAM privilege: remove update / delete permissions Git-flow Our SOP\nedit tf push new branch commit PR, review \u0026amp; discussion merge \u0026amp; apply revert to previous tag if necessary (Utility) Provide template wrap resources for better accesibility lower operation risks uniform naming convention best practice suggested default value About introducing new tool The hardest part is always people Focus on critical issues (ç—›é») instead of tool itself. â€œWe introduce tool to solveâ€¦â€ Put result into statistics â€œThe outage due to misconfig is reduced byâ€¦â€ Overall, my IaC experience is GREAT! IaC to automation. Comment (for infra) is important. You have to write doc anyway. Why not put in IaC? Q\u0026amp;A Full transcript Presentation file Source Code on Github chechia.net \u0026lt;- full contents Follow my page to get notification Like it if you really like it :) Appendix.I more about terraform terraform validate terraform import terraform module terraform cloud \u0026amp; state management\nAppendix.I understand State conflict Shared but synced watch out for state conflicts when colaborating state diff. could cause terraform mis-plan Solution: synced state lock Colatorative edit (git branch \u0026amp; PR), synchronized terraform plan \u0026amp; apply or better: automation Appendix.II understand resources from API aspect GCP Load Balancer\nGCP Load Balancing understand resources from API aspect\nhow terraform work with GCP API internal\nregional pass-through: tcp / udp -\u0026gt; internal TCP/UDP proxy: http / https -\u0026gt; internal HTTP(S) external\nregional pass-through: tcp / udp -\u0026gt; tcp/udp network global / effective regional proxy tcp -\u0026gt; TCP Proxy ssl -\u0026gt; SSL Proxy http / https -\u0026gt; External HTTP(S) Terraform Resource forwarding_rule\nforwarding_rule: tcp \u0026amp; http global_forwarding_rule: only http backend_service\nbackend_service health_check http_health_check https_health_check region_backend_service region_health_check region_http_health_check region_https_health_check Some ways to do IaC Cloud Formation bash script with API / client å¼•è¨€ Infrastructure as Code å¾å­—é¢ä¸Šè§£é‡‹ï¼ŒIaC å°±æ˜¯ç”¨ç¨‹å¼ç¢¼æè¿° infrastructureã€‚é‚£ç‚ºä½•æœƒå‡ºç¾é€™å€‹æ¦‚å¿µï¼Ÿ\nå¦‚æœä¸ IaC æ˜¯ä»€éº¼ç‹€æ³ï¼Ÿæˆ‘å€‘é‚„æ˜¯å¯ä»¥é€é GUI æˆ–æ˜¯ API æ“ä½œã€‚éš¨å«éš¨ç”¨\né›²ç«¯é‹ç®—é¢¨è¡Œï¼Œå·¥ç¨‹å¸«å¯ä»¥å¾ˆåœ¨ GUI ä»‹é¢ä¸Šï¼Œå¾ˆè¼•æ˜“çš„éƒ¨ç½²è³‡æ–™ä¸­å¿ƒçš„æ¶æ§‹ã€‚è¼¸å…¥åŸºæœ¬è³‡è¨Šï¼Œæ»‘é¼ é»å€‹ä¸€å…©ä¸‹ï¼Œå°±å¯ä»¥åœ¨é ç«¯å•Ÿç”¨é‹ç®—æ©Ÿå™¨ï¼Œå•Ÿç”¨è³‡æ–™åº«ï¼Œè¨­ç½®è™›æ“¬ç¶²è·¯èˆ‡è·¯ç”±ï¼Œå¹¾åˆ†é˜å°±å¯ä»¥å®Œæˆæ¶è¨­æœå‹™çš„åŸºç¤å»ºè¨­(infrastructure)ï¼Œé–‹å§‹é‹è¡Œæœå‹™ã€‚\nç„¶è€Œéš¨è‘—\né›²å¹³å°æä¾›æ›´å¤šæ–°çš„ï¼ˆè¤‡é›œçš„ï¼‰æœå‹™ æœå‹™å½¼æ­¤å¯èƒ½æ˜¯æœ‰ç›¸ä¾æ€§ï¼ˆdependencyï¼‰ï¼Œæœå‹™éœ€è¦ä»°è³´å…¶ä»–æœå‹™ æˆ–æ˜¯å‹•æ…‹è€¦åˆï¼Œæ›´æ”¹æœå‹™æœƒé€£å‹•å…¶ä»–æœå‹™ï¼Œä¸€é«®å‹•å…¨èº« éœ€è¦ç¸å¯†çš„å­˜å–æ§ â€¦","date":1592124369,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"ee558e7e37b7ee900cf55266f42c7a79","permalink":"https://chechia.net/zh-hant/post/2020-06-14-terraform-infrastructure-as-code/","publishdate":"2020-06-14T16:46:09+08:00","relpermalink":"/zh-hant/post/2020-06-14-terraform-infrastructure-as-code/","section":"post","summary":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification.","tags":["kubernetes","terraform","devops","iac"],"title":"å¾é›¶é–‹å§‹çš„ Infrastructure as Code: Terraform - 01","type":"post"},{"authors":[],"categories":["murmur"],"content":"ä»Šå¹´çµæŸäº†ï¼Œå›é¡§ä¸€ä¸‹ä»Šå¹´åšçš„äº‹æƒ…\nâ€“ æˆ‘æ˜¯è»Ÿé«”å·¥ç¨‹å¸« â€“\n6 å ´å…¬é–‹æ¼”è¬›ï¼Œä¸¦ä¸”è¸å‡ºç†Ÿæ‚‰çš„ç¤¾ç¾¤èˆ’é©åœˆï¼Œå—ä¸‹é€²è»é«˜é›„XD\n37 ç¯‡æŠ€è¡“æ–‡ç«  å…¶ä¸­åŒ…å« 30 ç¯‡ Ithome 30å¤©(åƒè³½å°±ä¸ç”¨ç¡è¦º)éµäººè³½åƒè³½æ–‡ç«  çµè³½æ’¿åˆ°è³€å„ªé¸ç‹‚è³€?\næ­£è·å·¥ä½œæ–¹é¢ï¼Œé€²äº†å¹£åœˆï¼Œåˆ‡èº«äº†è§£æ•åœˆçœŸäº‚å¾Œï¼Œåˆè¸å‡ºäº†å¹£åœˆ\né–‹å‘ç¿»è­¯éº»çœç†å·¥å­¸é™¢çš„èª²ç¨‹ã€åˆ†æ•£å¼ç³»çµ±ã€ï¼Œå¥½èª²æªåœ˜ä¸€èµ·ä¿® é è¨ˆæœƒæœ‰ 22 ç¯‡æ–‡ç« ï¼Œæº–å‚™åœ¨å¯è¦‹çš„æœªä¾†ï¼ŒçŠ§ç‰²ç„¡æ•¸å€‹å¤œæ™šï¼Œé‚å‘ 2020\nâ€“ æˆ‘æ˜¯å°ˆæ¥­æ°´è‚ºæ½›æ°´æ•™ç·´ â€“ ä¹Ÿæ˜¯è‡ªç”±æ½›æ°´å“¡\nå¹´æœ«çš„å¹¾å¤©ï¼Œæ­£å¼é–‹å§‹åŸ·æ¥­ï¼Œå¸¶å­¸ç”Ÿä¸‹æµ·(?) å­¸ç¿’æ•™å°å­¸ç”Ÿï¼Œä¹Ÿå­¸ç¿’å°å­¸ç”Ÿçš„å®‰å…¨è² è²¬\næ–°å¹´å¾©å·¥å¾Œï¼Œæ­£è·ç¢¼è¾²ï¼Œå‰¯æ¥­æ½›æ°´ æœ‰äººè¦æ½›è«‹æ‰¾æˆ‘ï¼Œä¿è­‰å„ªæƒ ä¸è—ç§\nâ€“ æˆ‘æ˜¯æ•¸ä½è¡ŒéŠ·å¯¦ç¿’ç”Ÿ â€“\nè·Ÿå‰å…¬å¸ (é›–ç„¶éƒ½ä¸æ˜¯MKä½†å») è¶…å¼·çš„è¡ŒéŠ·åœ˜éšŠ\u0026lt;3å­¸ç¿’æ•¸ä½è¡ŒéŠ· å¾é›¶é–‹å§‹å¤§é€ å€‹äººå“ç‰Œï¼Œé‚Šå­¸é‚Šå¯¦ç¿’ é–‹äº†å…©å€‹ç²‰çµ²å°ˆé  ä¸€å€‹æ˜¯æŠ€è¡“æ–‡ç« åˆ†äº«ï¼Œä¸€å€‹åšæ½›æ°´å½±ç‰‡åˆ†äº« æ‰“é€ å€‹äººå“ç‰Œï¼Œè‡ªå·±æ¨å»£è¡ŒéŠ·ï¼Œå­¸ç¿’æ•¸ä½è¡ŒéŠ·\n","date":1577788731,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"e5454d17dc61a9ae80f287f0871536fa","permalink":"https://chechia.net/zh-hant/post/2019-12-31-say-goodbye-2019/","publishdate":"2019-12-31T18:38:51+08:00","relpermalink":"/zh-hant/post/2019-12-31-say-goodbye-2019/","section":"post","summary":"2019 å¹´åº¦å›é¡§","tags":[],"title":"Say Goodbye 2019","type":"post"},{"authors":[],"categories":["golang","distributed-system"],"content":"https://github.com/chechiachang/mit-6.824-distributed-system\nèª²ç¨‹è¬›ç¾©ä¸­æ–‡ç¿»è­¯ å€‹äººå¿ƒå¾— è·Ÿè‘— MIT 6.824 å­¸ç¿’åˆ†æ•£å¼ç³»çµ±\né€™å€‹å°ˆæ¡ˆå„²å­˜ MIT 6.824 åˆ†æ•£å¼ç³»çµ±ç·¨ç¨‹çš„ä¸Šèª²å…§å®¹ï¼Œæˆ‘å°‡å…§å®¹ç¿»è­¯ç¨‹ä¸­æ–‡ï¼ŒåŠ ä¸Šå€‹äººå­¸ç¿’ç­†è¨˜\næˆ‘æœƒåœ¨æˆ‘çš„å­¸ç¿’éç¨‹ä¸­ï¼ŒæŒçºŒç¿»è­¯èª²ç¨‹å…§å®¹ ä¸€æ–¹é¢æ·±å…¥å€‹äººå­¸ç¿’ å¦ä¸€æ–¹é¢ä¹Ÿå›é¥‹ç¤¾ç¾¤ ä¾ç…§èª²ç¨‹çš„é€²åº¦é€²è¡Œ è‹¥æœ‰é¤˜åŠ›ï¼Œæœƒå˜—è©¦ç¿»è­¯ä»¥ä¸‹å…§å®¹\nèª²å ‚ Q \u0026amp; A è«–æ–‡ lab å¯¦åš ","date":1576511206,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"6f1d968a21c0e558efb6937adbf8fabb","permalink":"https://chechia.net/zh-hant/post/2019-12-16-mit-6.824-distributed-system/","publishdate":"2019-12-16T23:46:46+08:00","relpermalink":"/zh-hant/post/2019-12-16-mit-6.824-distributed-system/","section":"post","summary":"è·Ÿè‘— MIT 6.824 æ·±å…¥æ·ºå‡ºåˆ†æ•£å¼ç³»çµ±","tags":["mit","lecture","distributed-system","golang"],"title":"MIT 6.824 Distributed System Learning Note","type":"post"},{"authors":[],"categories":["blockchain"],"content":"https://en.bitcoin.it/wiki/Atomic_swap\nAlgorithm 2 pay txs and 2 claim tx claim txs are singed at first, locked with time 2 pay txs are encrypted by x, affects only when x is reveal on the network Initialization A: random number x\ntx1: A pay B A Pay BTC to Bâ€™s public key if x known \u0026amp; singed by B or Signed by A \u0026amp; B\ntx2: A claim tx1 pay BTC to Aâ€™s public key locked 48 hours signed by A\nA -\u0026gt; B tx2 B -\u0026gt; A tx2 signed by A \u0026amp; B\nA -\u0026gt; submit tx1 tx3: B pay A alt-coin B Pay A alt-coin if x known \u0026amp; singed by A or signed by A \u0026amp; B\ntx4: B claim tx3 pay B alt-coins locked 48 hours signed by B\nB -\u0026gt; A tx4 A -\u0026gt; B tx4 signed by A \u0026amp; B\nB submit tx3 A spends tx3, reveal x B spends tx1 using x Specialized Alt-chain ","date":1573171410,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"75133f79dfdaadb1bef40840b227839a","permalink":"https://chechia.net/zh-hant/post/2019-11-08-blockchain-atomic-swap/","publishdate":"2019-11-08T08:03:30+08:00","relpermalink":"/zh-hant/post/2019-11-08-blockchain-atomic-swap/","section":"post","summary":"https://en.bitcoin.it/wiki/Atomic_swap\nAlgorithm 2 pay txs and 2 claim tx claim txs are singed at first, locked with time 2 pay txs are encrypted by x, affects only when x is reveal on the network Initialization A: random number x","tags":["blockchain","atomic-swap"],"title":"Ablockchain Atomic Swap","type":"post"},{"authors":[],"categories":["blockchain"],"content":"BEP3 Atomic Swap Binance åœ¨ BEP3: HTLC and Atomic Peg æåˆ°ï¼ŒBEP å³å°‡åœ¨ binance chain ä¸Šæ”¯æ´åŸç”Ÿçš„ Hash Timer Locked Transfer (HTLT) ï¼Œé€™ä½¿è·¨éˆçš„åŸå­æ€§äº¤æ› (atomic swap) è®Šå¾—å¯è¡Œï¼Œé€é HTLC åœ¨å…©é‚Šçš„éˆä¸Šé–ä½ (peg) tokensï¼Œç„¶å¾Œåªæœ‰åœ¨åŸ·è¡Œäº¤æ›çš„æ™‚å€™ï¼Œé€é hash äº¤æ›ï¼Œä¸€æ¬¡åŸ·è¡Œé›™é‚Šçš„äº¤æ˜“ã€‚\né—œæ–¼ Atomic Swap ç¶²è·¯æœ‰éå¸¸å¤šçš„è¨Šæ¯ï¼Œæœ‰èˆˆè¶£çš„è©±å¯ä»¥çœ‹é€™ç¯‡\näº¤æ˜“åªæœ‰åœ¨é›™é‚Šå®Œæˆå¾Œæ‰å®Œæˆï¼Œå®Œæˆä¹‹å‰ä¸èƒ½å‹•ç”¨äº¤æ›çš„è³‡ç”¢ åœ¨ä»»ä½•éšæ®µå¤±æ•ˆéƒ½å¯ä»¥å®Œå…¨ fallbackï¼Œä¸¦é€²è¡Œ refund äº¤æ˜“çš„èªè­‰æ˜¯å»ä¸­å¿ƒåŒ–çš„ é€™é‚Šæœ‰å€‹ä½†æ›¸ï¼ŒEthereum ä¸Šæ˜¯é€é smart contract å¯¦ç¾ï¼Œä½† Binance chain ä¸Šé‚„æ˜¯é  Binance èªè­‰ XD Binance åœ¨ BEP3 ä¸­æ”¯æ´ HTLCï¼Œæˆ‘å€‘é€™é‚Šä¸»è¦çš„è³‡è¨Šä¾†æºæ˜¯ binance.org çš„å®˜æ–¹èªªæ˜æ–‡ä»¶ï¼Œé€™é‚Šé‡å°æ–‡ç« é€²è¡Œé©—è­‰ï¼Œä¸¦ä¸”è£œè¶³æ–‡ä»¶ç¼ºæ¼çš„éƒ¨åˆ†ï¼Œæé†’éç¨‹ä¸­å¯èƒ½æœƒè¸©åˆ°çš„é›·ã€‚\nè·¨éŠ(Cross Chain) äº¤æ˜“ åœ¨éƒ¨ç½² asset / token çš„æ™‚å€™ï¼Œæˆ‘å€‘æœƒé¸æ“‡åˆé©çš„éˆä½œç‚ºç™¼å¸ƒè³‡ç”¢ä¸¦é‹è¡Œ block chain appã€‚å¸¸ç”¨çš„æ‡‰ç”¨éˆå¦‚ ethereum èˆ‡ binance chain ç­‰ç­‰ã€‚ä¸åŒçš„ä¸»éˆä¸Šæœ‰å„è‡ªçš„å„ªç¼ºé»ï¼Œä¾‹å¦‚ä½¿ç”¨ ethereum ï¼Œå¯ä»¥èˆ‡è¨±å¤š token èˆ‡æ‡‰ç”¨äº’å‹•ï¼Œä¹Ÿæ˜¯æœ€å¤šäººä½¿ç”¨çš„æ‡‰ç”¨ä¸»éˆã€‚è€Œåœ¨ binance éˆä¸ŠåŸ·è¡Œï¼Œå‰‡èƒ½å¤ å¿«é€Ÿçš„ç™¼ç”Ÿ transactionsï¼Œä¸¦ä¸”å¯ä»¥èˆ‡ binance ä¸Šçš„è³‡ç”¢èˆ‡äº¤æ˜“æ‰€äº’å‹•ã€‚\nåœ¨æŸäº›æ‡‰ç”¨å ´æ™¯ï¼Œæˆ‘å€‘æœƒå¸Œæœ›å…©å€‹ç¨ç«‹ä¸»éˆä¸Šçš„è³‡ç”¢èƒ½å¾Œäº’å‹•ï¼Œä¾‹å¦‚åœ¨ binance chain ä¸ŠåŸ·è¡Œå¿«é€Ÿçš„ transactionï¼Œç„¶è€Œä¹Ÿè¦ä½¿ç”¨ etheruem ä¸Šæ—¢æœ‰çš„ ERC-20 tokensï¼Œé€™æ™‚ä¾¿éœ€è¦ä¸€å€‹æºé€šå…©æ¢éˆçš„æ©Ÿåˆ¶ã€‚\næ–‡ç« åˆ†ç‚ºä¸‰å€‹éƒ¨åˆ† åœ¨ Binance Chain ä¸Šäº’æ›å…©å€‹ address çš„ binance asset å¾ ethereum token åˆ° binance å¾ binance chain åˆ° ethereum Atomic Swap on Binance Chain æˆ‘å€‘ä»Šå¤©æœƒå¯¦ä½œ Atomic Peg Swapï¼Œé€é HTLT é–ä½ Binance Chain ä¸Šå…©å€‹ address çš„è³‡ç”¢ï¼Œä¸¦é€²è¡ŒåŸå­æ€§çš„ä¸€æ¬¡äº¤æ˜“ï¼Œä¾†é”æˆéˆä¸Šçš„è³‡ç”¢äº’æ›ã€‚é€™é‚Šç›´æ¥ä½¿ç”¨ binance æä¾›çš„ bnbcli ä¾†åŸ·è¡Œã€‚\nä½¿ç”¨æƒ…å¢ƒ å…©å€‹åœ¨ Binance Chain ä¸Šçš„ address æƒ³äº¤æ›è³‡ç”¢\nClient: HTLT çš„ç™¼èµ·æ–¹ï¼Œæ“æœ‰ä¸€éƒ¨åˆ† assetï¼Œç™¼èµ· HTLT å¸Œæœ›åŸ·è¡Œè³‡ç”¢äº’æ› Recipient: HTLT çš„æ”¶å—æ–¹ï¼Œæ”¶åˆ° HTLTï¼Œéœ€è¦æ–¼æ™‚é™å…§ deposit æŒ‡å®šæ•¸é‡çš„è³‡ç”¢åˆ° swap ä¸­ æœå‹™å…ƒä»¶ HTLT transactions on binance chain: ä¾†é–ä½ä¸¦ claim assets Client tooling: tbnbcli è®“å®¢æˆ¶å¯ä»¥æ“ä½œï¼Œç›£æ¸¬éˆä¸Š swap çš„ç‹€æ³ æµç¨‹ Client ä½¿ç”¨ tbnbcli ç™¼èµ· HTLT Recipient æ”¶åˆ°ç™¼èµ·æ–¹é€ä¾†çš„ swap info èˆ‡ asset (frozen) Recipient Deposit æŒ‡å®šæ•¸é‡çš„ asset åˆ° swap ä¸­ Binance Chain è‡ªå‹•å®Œæˆ swapï¼Œå®Œæˆäº¤æ›ï¼Œè§£é–å…©é‚Šäº¤æ›çš„è³‡ç”¢ å–å¾— tbnbcli tbnbcli çš„èªªæ˜æ–‡ä»¶\nç”±æ–¼ bnbcli repo ä¸­ä½¿ç”¨ Git Large File Storage ä¾†å­˜æ”¾ binaryï¼Œé€™é‚Šè¦å•Ÿç”¨ git-lfs ä¾†ä¸‹è¼‰ binary\n# Mac port sudo port install git-lfs Git clone repo\ngit clone git@github.com:binance-chain/node-binary.git cd node-binary git chechout v0.6.2 git lfs pull --include cli/testnet/0.6.2/mac/tbnbcli sudo copy cli/testnet/0.6.2/mac/tbnbcli /usr/local/bin é€™é‚Šè¦æ³¨æ„ä½¿ç”¨ v0.6.2+ çš„ç‰ˆæœ¬ï¼Œä¸ç„¶æœƒæ²’æœ‰ HTLT çš„ subcommands\næ¸¬è©¦ tbnbcli tbnbcli status --node http://data-seed-pre-0-s3.binance.org:80 { \u0026#34;node_info\u0026#34;: { \u0026#34;protocol_version\u0026#34;: { \u0026#34;p2p\u0026#34;: \u0026#34;7\u0026#34;, \u0026#34;block\u0026#34;: \u0026#34;10\u0026#34;, \u0026#34;app\u0026#34;: \u0026#34;0\u0026#34; }, \u0026#34;id\u0026#34;: \u0026#34;34ac6eb6cd914014995b5929be8d7bc9c16f724d\u0026#34;, \u0026#34;listen_addr\u0026#34;: \u0026#34;aa13359cd244f11e988520ad55ba7f5a-c3963b80c9b991b7.elb.us-east-1.amazonaws.com:27146\u0026#34;, \u0026#34;network\u0026#34;: \u0026#34;Binance-Chain-Nile\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;0.31.5\u0026#34;, \u0026#34;channels\u0026#34;: \u0026#34;36402021222330380041\u0026#34;, \u0026#34;moniker\u0026#34;: \u0026#34;data-seed-0\u0026#34;, \u0026#34;other\u0026#34;: { \u0026#34;tx_index\u0026#34;: \u0026#34;on\u0026#34;, \u0026#34;rpc_address\u0026#34;: \u0026#34;tcp://0.0.0.0:27147\u0026#34; } }, \u0026#34;sync_info\u0026#34;: { \u0026#34;latest_block_hash\u0026#34;: \u0026#34;359AD9BF36B7DEEB069A86D53D3B65D9F4BB77A1A65E40E1289B5798D4C1094F\u0026#34;, \u0026#34;latest_app_hash\u0026#34;: \u0026#34;E748CFA5806B587D9678F55DFDDB336E3669CDF421191CDA6D2DF8AA7A3461F3\u0026#34;, \u0026#34;latest_block_height\u0026#34;: \u0026#34;45868456\u0026#34;, \u0026#34;latest_block_time\u0026#34;: \u0026#34;2019-10-23T07:36:38.176957281Z\u0026#34;, \u0026#34;catching_up\u0026#34;: false }, \u0026#34;validator_info\u0026#34;: { \u0026#34;address\u0026#34;: \u0026#34;1C360E22E04035E22A71A3765E4A8C5A6D586132\u0026#34;, \u0026#34;pub_key\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;tendermint/PubKeyEd25519\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;T56yDoH+B+OY8PP2tmeFtJtk+9ftnBUVHykKfLS45Es=\u0026#34; }, \u0026#34;voting_power\u0026#34;: \u0026#34;0\u0026#34; } } Acquire Valid Binance Testnet Account Check Testnet Doc\nGo to Binance Testnet Create a wallet Save address, mn, keystore, private key Use testnet faucet to fund testnet account Receive 200 BNB on testnet Client Create HTLT é€™é‚Šä½¿ç”¨ç°¡å–®çš„ç¯„ä¾‹ï¼Œé–ä½å…©å€‹ BEP2 tokens ä¾†é€²è¡Œäº¤æ›ï¼Œå±•ç¤ºä¸€ä¸‹ tbnbcli çš„ HTLT\næº–å‚™å…©å€‹ addressï¼Œé€™é‚Šæ˜¯æˆ‘è‡ªå·±çš„å…©å€‹ testnet address\ntbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p (179 BNB) Explorer ä¸ŠæŸ¥çœ‹ tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce (20 BNB) Exporler ä¸ŠæŸ¥çœ‹ ç›®æ¨™ï¼š\nHTLT tbnbâ€¦j9p -\u0026gt; 0.3 BNB -\u0026gt; tbnbâ€¦7ce tbnbâ€¦j9p \u0026lt;- 0.1 BNB \u0026lt;- tbnbâ€¦7ce tbnbcli åŸ·è¡Œ HTLTï¼Œå¾ from address åŸ·è¡Œ HTLTï¼Œçµ¦ recipient-addr 0.3 BNBï¼Œä¸¦é æœŸå°æ–¹å› 0.1 BNBï¼Œç­‰å¾… height-span å€‹ block æ™‚é–“(360 \u0026gt; 2 minutes)\ntbnbcli key å¯¦éš›åŸ·è¡Œå‰ï¼Œç”±æ–¼æˆ‘å€‘éœ€è¦é€é tbnbcli æ“ä½œ from-addressï¼Œè¦å…ˆé€é tbnbcli æŠŠ address çš„ key åŠ é€²åˆ°æœ¬åœ°\ntbnbcli keys add tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce --recover tbnbcli keys list NAME:\tTYPE:\tADDRESS:\tPUBKEY: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tlocal\ttbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tbnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4 å¯¦éš›åŸ·è¡Œ åƒæ•¸ï¼š\nFROM ADDR: tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\nRECIPIENT ADDR: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\nhightspan: 3600ï¼Œheight-span æ˜¯ç™¼èµ· HTLTï¼Œå—æ–¹ depositï¼Œç™¼èµ·æ–¹å» claim çš„æ™‚é™ã€‚\namount: asset * 10^8\ntbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p åŸ·è¡Œ HTLT\nçµ¦ tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce 0.3 BNB\né æœŸå°æ–¹å› 0.1 BNB\nç­‰å¾… 3600 å€‹ block æ™‚é–“\nFROM_ADDR=tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p RECIPIENT_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce HEIGHT_SPAN=3600 tbnbcli token HTLT \\ --recipient-addr ${RECIPIENT_ADDR} \\ --amount 30000000:BNB \\ --expected-income 10000000:BNB \\ --height-span ${HEIGHT_SPAN} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 ç”¢ç”Ÿ swap çš„çµæœï¼Œå¯ä»¥æ–¼Testnet Explorer ä¸Šçœ‹åˆ°\nCommitted at block 47218942 (tx hash: 8F865C5C9E5CD06239DE99746BCE73AACA2F3AD881C26765FB90C9465EF06EF0, response: {Code:0 Data:[77 138 29 51 186 65 213 125 105 217 5 102 170 194 248 149 189 188 56 208 166 93 48 159 188 196 143 111 31 66 151 249] Log:Msg 0: swapID: â€¦","date":1571711720,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"5d524ccf272a6720e6c3fb5ab8704ae7","permalink":"https://chechia.net/zh-hant/post/2019-10-22-blockchain-bep3-atomic-swap/","publishdate":"2019-10-22T10:35:20+08:00","relpermalink":"/zh-hant/post/2019-10-22-blockchain-bep3-atomic-swap/","section":"post","summary":"BEP3 Atomic Swap Binance åœ¨ BEP3: HTLC and Atomic Peg æåˆ°ï¼ŒBEP å³å°‡åœ¨ binance chain ä¸Šæ”¯æ´åŸç”Ÿçš„ Hash Timer Locked Transfer (HTLT) ï¼Œé€™ä½¿è·¨éˆçš„åŸå­æ€§äº¤æ› (atomic swap) è®Šå¾—å¯è¡Œï¼Œé€é HTLC åœ¨å…©é‚Šçš„éˆä¸Šé–ä½ (peg) tokensï¼Œç„¶å¾Œåªæœ‰åœ¨åŸ·è¡Œäº¤æ›çš„æ™‚å€™ï¼Œé€é hash äº¤æ›ï¼Œä¸€æ¬¡åŸ·è¡Œé›™é‚Šçš„äº¤æ˜“ã€‚","tags":["blockchain","bep3","binance","ethereum","erc-20"],"title":"Blockchain Bep3 Atomic Swap","type":"post"},{"authors":[],"categories":["kubernetes"],"content":"Deploy Kafka on Kubernetes Che-Chia Chang\nQRCode\nAbout Me David (Che-Chia) Chang\nBackend / Devops @ MachiX Golang Taipei Meetup 2020 Ithelp Ironman Challenge https://t.me/chechiachang Outline Introduction to Kafka Deploy Kafka with Helm Kafka Topology Ithelp Ironman 30 days Challenge (7th-12nd day) Introduction https://kafka.apache.org/\nDistributed streaming platform Publish \u0026amp; Subscribe: r/w data like messaging system Store data in distributed, replicated, fault-tolerant cluster Scalable Realtime Concepts Kafka run as a cluster Kafka cluster stores streams of records in categories called topics record = (key, value, timestamp) Kafka Diagram Topic Partitions Topic Partitions Data categorized by topic Data replicated in partitions Durability consumer able to r/w complete data from at least 1 partition in order Distributed Data Streaming Scalible r/w bandwith\nData Durability\nConsistency\nAvailability\nPartition Tolerance\nMulti Consumer Consumer Group Consumer Group Partition deliver record to one consumer within each subscribing consumer group Deployment Helm Kafka\nDeployment https://github.com/chechiachang/kafka-on-kubernetes\ncat install.sh #!/bin/bash # https://github.com/helm/charts/tree/master/incubator/kafka HELM_NAME=kafka-1 helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator helm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml Check values-staging.yaml before deployment\nHelm Chart Values cat values-staging.yaml # ------------------------------------------------------------------------------ # Kafka: # ------------------------------------------------------------------------------ ## The StatefulSet installs 3 pods by default replicas: 3 ## The kafka image repository image: \u0026#34;confluentinc/cp-kafka\u0026#34; ## The kafka image tag imageTag: \u0026#34;5.0.1\u0026#34; # Confluent image for Kafka 2.0.0 ## Specify a imagePullPolicy ## ref: http://kubernetes.io/docs/user-guide/images/#pre-pulling-images imagePullPolicy: \u0026#34;IfNotPresent\u0026#34; ## Configure resource requests and limits ## ref: http://kubernetes.io/docs/user-guide/compute-resources/ resources: {} # limits: # cpu: 200m # memory: 1536Mi # requests: # cpu: 100m # memory: 1024Mi kafkaHeapOptions: \u0026#34;-Xmx4G -Xms1G\u0026#34; ## The StatefulSet Update Strategy which Kafka will use when changes are applied. ## ref: https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#update-strategies updateStrategy: type: \u0026#34;OnDelete\u0026#34; ## Start and stop pods in Parallel or OrderedReady (one-by-one.) Note - Can not change after first release. ## ref: https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy podManagementPolicy: OrderedReady ## If RBAC is enabled on the cluster, the Kafka init container needs a service account ## with permissisions sufficient to apply pod labels rbac: enabled: false affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - kafka topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 50 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - zookeeper topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; ## Configuration Overrides. Specify any Kafka settings you would like set on the StatefulSet ## here in map format, as defined in the official docs. ## ref: https://kafka.apache.org/documentation/#brokerconfigs ## configurationOverrides: \u0026#34;default.replication.factor\u0026#34;: 3 \u0026#34;offsets.topic.replication.factor\u0026#34;: 1 # Increased from 1 to 2 for higher output # \u0026#34;offsets.topic.num.partitions\u0026#34;: 3 \u0026#34;confluent.support.metrics.enable\u0026#34;: false # Disables confluent metric submission # \u0026#34;auto.leader.rebalance.enable\u0026#34;: true # \u0026#34;auto.create.topics.enable\u0026#34;: true # \u0026#34;controlled.shutdown.enable\u0026#34;: true # \u0026#34;controlled.shutdown.max.retries\u0026#34;: 100 \u0026#34;message.max.bytes\u0026#34;: \u0026#34;16000000\u0026#34; # Extend global topic max message bytes to 16 Mb ## Persistence configuration. Specify if and how to persist data to a persistent volume. ## persistence: enabled: true ## Prometheus Exporters / Metrics ## prometheus: ## Prometheus JMX Exporter: exposes the majority of Kafkas metrics jmx: enabled: true ## Prometheus Kafka Exporter: exposes complimentary metrics to JMX Exporter kafka: enabled: true topics: [] # ------------------------------------------------------------------------------ # Zookeeper: # ------------------------------------------------------------------------------ zookeeper: ## If true, install the Zookeeper chart alongside Kafka ## ref: https://github.com/kubernetes/charts/tree/master/incubator/zookeeper enabled: true Kubernetes Configurations replicas resource pod affinity persistence Kafka Configurations zookeeper configurationOverrides \u0026#34;default.replication.factor\u0026#34;: 3 \u0026#34;offsets.topic.replication.factor\u0026#34;: 1 # Increased from 1 to 2 for higher output # \u0026#34;offsets.topic.num.partitions\u0026#34;: 3 # \u0026#34;auto.leader.rebalance.enable\u0026#34;: true # \u0026#34;auto.create.topics.enable\u0026#34;: true â€¦","date":1571356800,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"9c9c8e25feab5bb4ca9220fa3fb2b5d7","permalink":"https://chechia.net/zh-hant/slides/2019-10-18-kafka-on-k8s/","publishdate":"2019-10-18T00:00:00Z","relpermalink":"/zh-hant/slides/2019-10-18-kafka-on-k8s/","section":"slides","summary":"Deploy Kafka on Kubernetes Che-Chia Chang\nQRCode\nAbout Me David (Che-Chia) Chang\nBackend / Devops @ MachiX Golang Taipei Meetup 2020 Ithelp Ironman Challenge https://t.me/chechiachang Outline Introduction to Kafka Deploy Kafka with Helm Kafka Topology Ithelp Ironman 30 days Challenge (7th-12nd day) Introduction https://kafka.","tags":["kafka","kubernetes"],"title":"Deploy Kafka on Kubernetes","type":"slides"},{"authors":[],"categories":[],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ è¶…ç°¡çŸ­æ¨å‘ oeprator-sdk éµäººè³½å¿ƒå¾— æ‰¿ä¸Š ä¸Šç¯‡ä»‹ç´¹äº† crd èˆ‡ controllerï¼Œç„¶è€Œæ²’æœ‰èªªæ˜ controller çš„ç·¨å¯«èˆ‡æ“ä½œï¼Œå› ç‚º controller çš„éƒ¨åˆ†æ¯”è¼ƒè¤‡é›œï¼Œæˆ‘å€‘éµäººæŒ‘æˆ°è³½å°¾è²ï¼Œç¯‡å¹…èªªå¯¦åœ¨æ˜¯ä¸å¤ªå¤ ã€‚\næœ‰èˆˆè¶£è©³ç´°äº†è§£çš„å¤§å¾·ï¼Œè«‹åƒè€ƒç›¸åŒéµäººæŒ‘æˆ°åœ˜éšŠçš„éšŠå‹æ–‡ç« ï¼Œè£é ­å° controller æœ‰è©³ç´°ä»‹ç´¹ï¼Œé€™é‚Šå°±ä¸è´…è¿°ã€‚ç›´æ¥æä¾›å€‹äººä½¿ç”¨è¦ºå¾—æœ€ç°¡å–®ä¸Šæ‰‹çš„ operator sdk\nOperator SDK Operator SDK æ˜¯ Operator framework ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œèƒ½æœ‰æ•ˆä¸”è‡ªå‹•åŒ–çš„ç®¡ç† kubernetes native apps, operator çš„ç®¡ç†å·¥å…·ã€‚\nè¤‡é›œçš„ kubernetes application æ˜¯éå¸¸é›£ç®¡ç†çš„ï¼Œå¯« operator ä¹Ÿæ˜¯å¾ˆæœ‰æŒ‘æˆ°ï¼Œä¸åƒ…è¦è™•ç†å¤§é‡ kubernetes åº•å±¤çš„ APIï¼Œè¦å¯«å¾ˆå¤šæ¨£ç‰ˆã€‚ operator SDK ä½¿ç”¨ controller-runtime çš„ library è®“ç·¨å¯« native application è®Šå¾—ç°¡å–®è¨±å¤š\nå¯ä»¥ä½¿ç”¨ä¸Šå±¤çš„ API èˆ‡æŠ½è±¡ä¾†ç·¨å¯« operator é‚è¼¯ å¿«é€Ÿä½¿ç”¨ code generation æœ‰æ“´å……å¥—ä»¶ Workflow é€™é‚Šä»¥ golang ç‚ºä¾‹èªªæ˜\nå®‰è£ operator sdk å®šç¾©æ–°çš„ API resource (custom resource definition) å®šç¾© controller ä¾†ç›£æ¸¬ custom resource ç·¨å¯« reconciling é‚è¼¯ä¾† sync desired state èˆ‡ current state ä½¿ç”¨ sdk cli é€²è¡Œæ¸¬è©¦ ä½¿ç”¨ sdk cli ä¾† buildï¼Œä¸¦ç”¢ç”Ÿéƒ¨å±¬ç”¨çš„ manifests å®‰è£è«‹ä¾ç…§ å®‰è£èªªæ˜ æ“ä½œå³å¯ã€‚\né€™é‚Šä½¿ç”¨ sdk cli ä¾†å¢åŠ æ–°çš„ crd\n# Add a new API for the custom resource AppService $ operator-sdk add api --api-version=app.example.com/v1alpha1 --kind=AppService ç”¢ç”Ÿçš„ go æºç¢¼æœƒæ”¾åœ¨ pkg ä¸­ï¼Œå¯ä»¥ä¾è‡ªå·±éœ€æ±‚èª¿æ•´ crd çš„çµæ§‹\né€™é‚Šä½¿ç”¨ sdk cli ç”¢ç”Ÿå°æ‡‰ crd çš„ controllerï¼Œè£é ­å·²ç¶“å¯«å¥½å¤§éƒ¨åˆ†çš„ code gene èˆ‡ reconcile çš„æ¨£æ¿ï¼Œç›´æ¥ä¿®æ”¹å°±å¯ä½¿ç”¨ï¼Œéå¸¸æ–¹ä¾¿\n# Add a new controller that watches for AppService $ operator-sdk add controller --api-version=app.example.com/v1alpha1 --kind=AppService ä¿®æ”¹å®Œï¼Œç›´æ¥ä½¿ç”¨ sdk cli build æˆ imageï¼Œç„¶å¾Œæ¨åˆ° image hub ä¸Š\n# Build and push the app-operator image to a public registry such as quay.io $ operator-sdk build quay.io/example/app-operator $ docker push quay.io/example/app-operator éƒ¨å±¬å‰æª¢æŸ¥ä¸€ä¸‹ manefests æª”æ¡ˆï¼Œç‰¹åˆ¥æ˜¯ crd.yaml èˆ‡ operator.yamlï¼Œå¦‚æœæºç¢¼æœ‰èª¿æ•´è¨˜å¾—åšå°æ‡‰çš„ä¿®æ”¹ã€‚\n# Setup Service Account $ kubectl create -f deploy/service_account.yaml # Setup RBAC $ kubectl create -f deploy/role.yaml $ kubectl create -f deploy/role_binding.yaml # Setup the CRD $ kubectl create -f deploy/crds/app.example.com_appservices_crd.yaml # Deploy the app-operator $ kubectl create -f deploy/operator.yaml é€™æ¨£ä¾¿éƒ¨å±¬äº† operatorï¼Œoperator æœƒç›£çœ‹æŒ‡å®šçš„ custom resourceï¼Œä¸¦ä¾ç…§ controller çš„é‚è¼¯é€²è¡Œ reconcileã€‚\né€™é‚Šä»¥å¢åŠ  custom resource ç‚ºä¾‹\n# Create an AppService CR # The default controller will watch for AppService objects and create a pod for each CR $ kubectl create -f deploy/crds/app.example.com_v1alpha1_appservice_cr.yaml å¢åŠ ä¸€å€‹ cr åˆ° kubernetes ä¸Šï¼Œé€™æ™‚ operator æœƒåµæ¸¬åˆ° cr çš„è®ŠåŒ–ï¼Œä¸¦ä¸”ä¾ç…§ reconcile çš„é‚è¼¯ sync\næª¢æŸ¥ä¸€ä¸‹ cr èˆ‡ operator çš„ç‹€æ…‹\n# Verify that a pod is created $ kubectl get pod -l app=example-appservice NAME READY STATUS RESTARTS AGE example-appservice-pod 1/1 Running 0 1m è©³ç´°çš„æ“ä½œæ­¥é©Ÿå¯ä»¥çœ‹ é€™é‚Š\nå°çµ äº‹å¯¦ä¸Šï¼Œoperator sdk çš„åŠŸèƒ½é‚„æœ‰éå¸¸å¤šï¼Œç´°è¬›åˆè¦èŠ±å¥½å¹¾ç¯‡æ–‡ç« è¬›ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒæœƒæ”¾åœ¨æˆ‘çš„å€‹äººç¶²ç«™ä¸Šã€‚\nå¦å¤– operator sdk ä¹Ÿæ­¡è¿å¤–éƒ¨çš„ Issue èˆ‡ PRï¼Œåœ˜éšŠçš„äººéå¸¸ nice æœƒé¡˜æ„èŠ±æ™‚é–“è·Ÿç¤¾ç¾¤æœ‹å‹æºé€šï¼Œæœ‰èˆˆè¶£è«‹ä¾† contributeã€‚\né€™ç³»åˆ—éµäººæ–‡ç« ï¼Œèªªå¯¦åœ¨æ²’æœ‰ä»€éº¼å¾ˆæ·±å…¥çš„æŠ€è¡“è¨è«–ï¼Œå¤šåŠè³‡æ–™éƒ½æ˜¯å„å€‹é …ç›®çš„å®˜æ–¹æ–‡ä»¶ç¿»è­¯ï¼ŒåŠ ä¸Šä¸€äº›å€‹äººçš„ç¶“é©—èˆ‡è§£è®€ï¼Œä¸¦ä¸æ˜¯å«é‡‘é‡å¾ˆé«˜çš„æ–‡ç« ã€‚ç„¶è€Œæˆ‘å€‹äººåœ¨æ¥è§¸é€™äº›é …ç›®æ™‚ï¼Œå»å¾€å¾€å› ç‚ºæ‰¾ä¸åˆ°ç´°ç¯€æ“ä½œçš„æ­¥é©Ÿåˆ†äº«æ–‡ç« ï¼Œåœ¨è¨±å¤šå°ç´°ç¯€ä¸Šæ’ç‰†å¾ˆä¹…ï¼Œä¹Ÿå› æ­¤æ‰æœ‰äº†é€™ç³»åˆ—æ–‡ç« ã€‚\né€™ç³»åˆ—æ–‡å°±åªæ˜¯è¸©é›·ä¹‹æ—…ï¼Œè®“å¾Œäººå¦‚æœæœ‰ç”¨åˆ°é€™äº›æ–‡ç« ï¼Œç”Ÿæ´»èƒ½éå¾—é–‹å¿ƒä¸€é»ï¼Œé€™ 30 å¤©çš„æ™‚é–“å°±æœ‰äº†åƒ¹å€¼ã€‚\néµäººæŒ‘æˆ°è³½çš„æœ€å¾Œä¸€å¤©ï¼Œæ„Ÿè¬å„è·¯å¤§å¾·ä¸€è·¯ç›¸éš¨ï¼Œè®“æˆ‘åœ¨å‡æ—¥ä¹Ÿèƒ½å¿ƒç”˜æƒ…é¡˜åœ°åä¸‹ä¾†å¯«æ–‡ç« ã€‚æ¸¸æ–¼è—å¤©ä¸€ç¯‡çœŸçš„å¾ˆé€¼äººï¼Œæœ‰å¹¾å¤©çš„æ–‡ç« å“è³ªæ˜¯æœ‰è »å¤šå•é¡Œçš„ï¼Œä¹Ÿæ„Ÿè¬å¤§å¾·å€‘å”åŠ©æ‰éŒ¯ï¼Œçµ¦äºˆå¾ˆå¤šå»ºè­°ã€‚\nè¬è¬å„ä½ã€‚\n","date":1571131692,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"8c3adefbdce3373186b360c180f865b7","permalink":"https://chechia.net/zh-hant/post/2019-10-15-kubernetes-custom-resource-with-operator-sdk/","publishdate":"2019-10-15T17:28:12+08:00","relpermalink":"/zh-hant/post/2019-10-15-kubernetes-custom-resource-with-operator-sdk/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":[],"title":"Kubernetes Custom Resources with Operator SDK","type":"post"},{"authors":[],"categories":["kubernetes","crd"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ CRD å…§å®¹ Deploy CRD Use custom resource Recap åœ¨ä¸Šæ¬¡çš„ cert-manager å…§å®¹ä¸­æˆ‘å€‘èµ°é cert-manager çš„å®‰è£æ­¥é©Ÿï¼Œå…¶ä¸­æœ‰ä¸€å€‹æ­¥é©Ÿæ˜¯ apply cert-manager çš„ manigests æª”æ¡ˆ *.yaml)\nhttps://github.com/jetstack/cert-manager/tree/release-0.11/deploy/manifests\n$ git clone https://github.com/jetstack/cert-manager $ git checkout release-0.11 $ ls deploy/manifest 00-crds.yaml 01-namespace.yaml BUILD.bazel\tREADME.md\thelm-values.yaml æˆ‘å€‘å¿«é€Ÿçœ‹ä¸€ä¸‹é€™å€‹ 00-crds.yamlï¼Œé€™å€‹ yaml éå¸¸é•·ï¼Œç›´æ¥è·³åˆ° certificates.certmanager.k8s.io\nå¸Œæœ›çœ‹ golang æºç¢¼æ–‡ä»¶çš„è©±ï¼Œå¯ä»¥æ­é…godoc.org/k8s.io/apiextensions ä¾†é–±è®€ï¼Œæ›´èƒ½ç†è§£ definitionã€‚\nåœ¨çœ‹ä¹‹å‰å…ˆæ³¨æ„å¹¾ä»¶äº‹ï¼ŒCRD å…§é™¤äº† schema å¤–ï¼Œé‚„å®šç¾©äº†è¨±å¤šä¸åŒæƒ…å¢ƒçš„ä½¿ç”¨è³‡æ–™ã€‚\nCRD å…§å®šç¾©äº† custom resource çš„è³‡æ–™å„²å­˜ .spec.validation.openAPIV3Schemaï¼Œä½¿ç”¨ custom resource æœƒé€é validator é©—è­‰ .openAPIV3Schema å…§å®šç¾©äº† .specï¼Œä»¥åŠ rumtime ä¸­ç´€éŒ„ .status çš„è³‡æ–™ controller å¯ä»¥æŠŠç‹€æ…‹ sync åˆ° custom resource çš„ .status ä¸­ç´€éŒ„ controller å¯ä»¥æ¯”å° .spec èˆ‡ .status ä¾†æ±ºå®šæ˜¯å¦è¦ sync ä»¥åŠå¦‚ä½• sync CRD å…§å®šç¾©äº†èˆ‡ server ä»¥åŠ client äº’å‹•çš„æ–¹å¼ï¼Œ names ä¸­å®šç¾©å„ç¨®ä½¿ç”¨æƒ…å¢ƒçš„ custom resource åç¨± additionalPrinterColumns ä¸­æ·»åŠ  kubectl ä¸­çš„é¡¯ç¤ºå…§å®¹ // é€™é‚Šä½¿ç”¨çš„æ˜¯ v1beta1 çš„ API (deprecated at v1.16) ï¼Œæ–°ç‰ˆé–‹ç™¼å»ºè­°ä½¿ç”¨ apiextension.k8s.io/v1 çš„ api apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: creationTimestamp: null name: certificates.cert-manager.io spec: // ä½¿ç”¨ kubectl æœƒé¡å¤–é¡¯ç¤ºçš„è³‡è¨Šå…§å®¹ï¼Œé€é jsonpath å» parse é¡¯ç¤º additionalPrinterColumns: - JSONPath: .status.conditions[?(@.type==\u0026#34;Ready\u0026#34;)].status name: Ready type: string - JSONPath: .spec.secretName name: Secret type: string - JSONPath: .spec.issuerRef.name name: Issuer priority: 1 type: string - JSONPath: .status.conditions[?(@.type==\u0026#34;Ready\u0026#34;)].message name: Status priority: 1 type: string - JSONPath: .metadata.creationTimestamp description: CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. name: Age type: date group: cert-manager.io // å®šç¾© CRD åœ¨ä¸åŒæƒ…å¢ƒä¸‹ä½¿ç”¨çš„åç¨± names: kind: Certificate listKind: CertificateList plural: certificates shortNames: - cert - certs singular: certificate scope: Namespaced subresources: status: {} validation: // openAPIV3Schema ä¸­æ˜¯ custom resource å¯¦éš›æ“ä½œæœƒä½¿ç”¨çš„å…§å®¹ // properties ä½¿ç”¨ . .description .type ï¼Œåˆ†åˆ¥å®šç¾©åç¨±ï¼Œæè¿°ï¼Œæª¢æŸ¥å‹åˆ¥ openAPIV3Schema: description: Certificate is a type to represent a Certificate from ACME properties: apiVersion: description: \u0026#39;APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources\u0026#39; type: string kind: description: \u0026#39;Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds\u0026#39; type: string // custom resource runtime ä¸­çš„ metadata metadata: type: object // custom resource ä½¿ç”¨æ™‚çš„ specï¼Œå®šç¾© custom resoure çš„ desired status spec: ... // custom controller ç›£æ¸¬ custom resource çš„ current statusï¼Œé€™é‚Šçš„è³‡æ–™å®Œå…¨è¦– controller å¯¦ä½œä¾†ç”¢ç”Ÿï¼Œå¦‚æœæ²’æœ‰å¯¦ä½œ sync statusï¼Œä¹Ÿå¯ä»¥æ²’æœ‰è³‡æ–™ status: ... type: object // é€™å€‹æ˜¯ CRD ç‰©ä»¶çš„ versionï¼Œå¯ä»¥å®šç¾©å¤šå€‹ä¸åŒ version çš„ CRDï¼Œèª¿ç”¨æ™‚éœ€è¦è¨»æ˜ç‰ˆæœ¬ version: v1alpha2 versions: - name: v1alpha2 served: true storage: true // é€™å€‹æ˜¯ CRD ç‰©ä»¶çš„ statusï¼Œæè¿° CRD éƒ¨ç½²åˆ° API server çš„ç‹€æ…‹ï¼Œä¾‹å¦‚ CRD å„²å­˜é©ç”¨ configmap çš„å„²å­˜ç©ºé–“ï¼Œé€™é‚Šé¡¯ç¤ºåœ¨ API server ä¸Šçš„å„²å­˜ç‹€æ…‹ã€‚ä¸è¦è·Ÿ custom resource çš„ status å¼„æ··äº† status: acceptedNames: kind: \u0026#34;\u0026#34; plural: \u0026#34;\u0026#34; conditions: [] storedVersions: [] helm-values.yaml èˆ‡ 01-namespace.yaml å¾ˆå–®ç´”ï¼Œå‰è€…æ˜¯ä½¿ç”¨ helm éƒ¨ç½²çš„å¯è¨­å®šåƒæ•¸ï¼Œé è¨­åªæœ‰ kubernetes resourcesï¼Œå¾Œè€…å‰‡æ˜¯ç‚ºä¹‹å¾Œçš„ cert-manager å…ƒä»¶æ–°å¢ä¸€å€‹ kubernetes namespaceã€‚\nå°çµ CRD å…§å®¹ (apiextensions/v1beta1) CRD é¡¯ç¤ºåç¨±ï¼Œå…§å®¹ CRD spec é©—è­‰ custom resource custom resource schema CRD è‡ªèº«éƒ¨ç½²ç‹€æ…‹ éƒ¨ç½² éƒ¨ç½²ç›¸è¼ƒå®šç¾©æœ¬èº«å°±éå¸¸ç°¡å–®ï¼Œç›´æ¥ kubectl apply åˆ° kubernetes ä¸Š\nä½¿ç”¨ custom resource æœ‰äº† CRDï¼Œæˆ‘å€‘ä¾¿å¯ä»¥ä½¿ç”¨ CRUD APIï¼Œäº’å‹•æ¨¡å¼èˆ‡å…¶ä»– build-in kubernetes resources ç›¸åŒï¼Œåªæ˜¯å…§å®¹æœƒç…§ CRD ä¸Šçš„å®šç¾©èª¿æ•´\nkubectl get certificates.certmanager.k8s.io kubectl get certificates kubectl get certs --all-namespaces kubectl get cert -n cert-manager NAMESPACE NAME READY SECRET AGE cert-manager ingress-nginx-tls True ingress-nginx-tls 221d é€™é‚Šçœ‹åˆ°çš„å…§å®¹å¯èƒ½æœƒæœ‰äº›è½å·®ï¼Œå› ç‚ºæˆ‘ç•¶åˆç”¨çš„ç‰ˆæœ¬æ¯”è¼ƒèˆŠï¼Œä½†å…§å®¹å¤§åŒå°ç•°ã€‚\nåº•ä¸‹çš„ describe å…§å®¹å·²ç¶“è·Ÿä¸Šé¢çš„ CRD ç‰ˆæœ¬å·®å¤ªå¤šï¼Œå°ä¸èµ·ä¾†äº†ã€‚ä½†æˆ‘ä¹Ÿæ‡¶å¾—å†ä½ˆä¸€çµ„ï¼Œé‚„è¦é‡åš dnsName èˆ‡ authotization challenge\nç›´æ¥è®“å¤§å®¶æ„Ÿå—ä¸€ä¸‹èˆŠç‰ˆçš„å…§å®¹XD\n$ kubectl describe cert ingress-nginx-tls Name: â€¦","date":1570975388,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"c9449981dd25dbcce191863ae62972c7","permalink":"https://chechia.net/zh-hant/post/2019-10-13-kubernetes-custom-resource-deployment/","publishdate":"2019-10-13T22:03:08+08:00","relpermalink":"/zh-hant/post/2019-10-13-kubernetes-custom-resource-deployment/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","crd","gcp"],"title":"Kubernetes Custom Resource Deployment","type":"post"},{"authors":[],"categories":["kubernetes","crd"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ custom resources custom controllers ç°¡ä»‹ custom resources Kubernetes é å…ˆå®šç¾©è¨±å¤š resource ï¼Œé€™äº› resource æ˜¯ kubernetes API é å…ˆè¨­ç½®çš„ API objectsï¼Œä¾‹å¦‚ kubernetes pods resource åŒ…å«è¨±å¤š pods ç‰©ä»¶ã€‚\nCustom resoure å‰‡æ˜¯é€éæ“´å…… kubernetes API ï¼Œè®“è‡ªå®šç¾©çš„ç‰©ä»¶ä¹Ÿå¯ä»¥åœ¨ kubernetes ä¸Šä½¿ç”¨ã€‚ä¸Šç¯‡ cert-manager å°±ä½¿ç”¨äº†è¨±å¤š custom resourceï¼Œé€™äº› resource åœ¨ä¸€èˆ¬å®‰è£çš„ kubernetes ä¸Šæ²’æœ‰å®‰è£ï¼Œéœ€è¦å®‰è£ custom resource difinitionï¼Œå‘ kubernetes cluster å®šç¾©æ–°çš„ custom resourceã€‚ä¾‹å¦‚ certificates.certmanager.k8s.io å°±æ˜¯ cert-manager è‡ªå®šç¾©çš„è³‡æºï¼Œç”¨ä¾†ä»£è¡¨ç”¢ç”Ÿ x509 certificate çš„å…§å®¹ã€‚\nè¶Šä¾†è¶Šå¤šçš„ kubernetes core æ–¹æ³•ï¼Œå¦‚ä»Šä¹Ÿä½¿ç”¨ custom resources ä¾†å®šç¾©ï¼Œè®“ kubernetes æ ¸å¿ƒå…ƒä»¶æ›´åŠ æ¨¡çµ„åŒ–ã€‚\ncustom resource å¯ä»¥åœ¨é‹è¡Œä¸­çš„ kubernetes é›†ç¾¤ä¸­è¨»å†Š (registration) ï¼Œä¹Ÿå¯ä»¥å‹•æ…‹è¨»éŠ·ï¼Œcustom resource ä¸¦ä¸æœƒå½±éŸ¿é›†ç¾¤æœ¬èº«çš„é‹ä½œã€‚åªè¦å‘ kubernetes è¨»å†Šå®Œ custom resourceï¼Œå°±å¯ä»¥é€é API èˆ‡ kubectl æ§åˆ¶ custom resourceï¼Œå°±åƒæ“ä½œ Pod resource ä¸€æ¨£ã€‚\nCustom controllers custom resource ä¸€ä½†è¨»å†Šï¼Œå°±å¯ä»¥ä¾æ“š resource çš„ CRD (custom resource definition) ä¾†æ“ä½œï¼Œå› æ¬¡å¯ä»¥å„²å­˜å®¢è£½åŒ–çš„è³‡æ–™å…§å®¹ã€‚ç„¶è€Œåœ¨å¾ˆå¤šæƒ…å½¢ï¼Œæˆ‘å€‘ä¸¦ä¸åªè¦ custom resource ä¾†è®€å¯«ï¼Œè€Œæ˜¯å¸Œæœ› custom resource èƒ½åŸ·è¡Œå®šç¾©çš„å·¥ä½œï¼Œå¦‚åŒ Pod resource å¯ä»¥åœ¨ kubernetes é›†ç¾¤ä¸Šæ§åˆ¶ Podï¼Œåœ¨ Pod resource ä¸Šæè¿°çš„ desired state kubernetes æœƒé€éå®šç¾©åœ¨ Pod API ä¸­çš„ sync é‚è¼¯ï¼Œä¾†é”åˆ° current state èˆ‡ desired state çš„å¹³è¡¡ã€‚\næˆ‘å€‘å¸Œæœ› custom resource ä¹Ÿèƒ½åšåˆ°ä¸Šè¿°çš„åŠŸèƒ½ï¼Œæä¾› declarative APIï¼Œè®“ä½¿ç”¨è€…ä¸éœ€ç·¨å¯«å®Œæ•´çš„ç¨‹å¼é‚è¼¯ï¼Œåªè¦é€éæ§åˆ¶ custom resourceï¼Œå°±å¯ä»¥é€é controller å…§å®šç¾©çš„é‚è¼¯ï¼Œä¾†å¯¦ç¾ desired stateã€‚ä½¿ç”¨è€…åªéœ€è¦å°ˆæ³¨åœ¨æ§åˆ¶ custom resource ä¸Šçš„ desired stateï¼Œè®“ controller è™•ç†ç´°ç¯€å¯¦ä½œã€‚\nä¾‹å¦‚ï¼šæˆ‘å€‘åœ¨ cert-manager ä¸­è¨­å®š certificates.certmanager.k8s.io è³‡æºï¼Œä¾†æè¿°æˆ‘å€‘å¸Œæœ›å–å¾— x509 certificate çš„ desired stateï¼Œä½†æˆ‘å€‘åœ¨ certificates.certmanager ä¸Šé¢æ²’æœ‰å¯«ã€é€é Letâ€™s Encrypt å–å¾— x509 certificateã€çš„å¯¦ç¾é‚è¼¯ï¼Œä»ç„¶èƒ½é€é cert-manager ç”¢ç”Ÿ x509 certiticateï¼Œå› ç‚º cert-manager å…§éƒ¨å·²ç¶“å®šç¾© certificates.certmanager.k8s.io çš„ custom controllerã€‚\nåŸºæœ¬çš„ custom resource æ“ä½œ\nè¨»å†Š custom resource definitionï¼Œè®“ kubernetes API çœ‹å¾—æ‡‚ custom resource ä¸ç„¶ API æœƒå›è¦† error: the server doesnâ€™t have a resource type æœ‰ CRD ä¾¿å¯ä»¥ apply custom resource åˆ°é›†ç¾¤ä¸­ éƒ¨ç½² custom controllerï¼Œç›£æ¸¬ custom resource çš„ desired state å…§å®¹ï¼Œä¸¦å¯¦ç¾é”åˆ° desired state çš„æ¥­å‹™é‚è¼¯ æ²’æœ‰ custom controllerï¼Œcustom resource å°±åªæ˜¯å¯ä»¥ apply èˆ‡ update çš„è³‡æ–™å„²å­˜çµæ§‹ï¼Œæ²’æœ‰ cert-manager ä¸­ controller çš„é‚è¼¯ï¼Œä¹Ÿé‚„æ˜¯ç”Ÿä¸å‡º x509 certificateã€‚ kubectl get chechiachang error: the server doesn\u0026#39;t have a resource type \u0026#34;chechiachang\u0026#34; custom controller ä¹Ÿå¯ä»¥è·Ÿå…¶ä»–çš„ kubernetes resource äº’å‹•ï¼Œä¾‹å¦‚ cert-manager åœ¨ç”¢ç”Ÿ certificate çš„æ™‚å€™ï¼ŒæœƒæŠŠç”¢ç”Ÿçš„ certificate æª”æ¡ˆæ”¾åœ¨ secret ä¸­ï¼Œcert-manager æœƒä¾æ“š order ä¸­å®šç¾©çš„ lifecycle ï¼ŒæŒçºŒæª¢æŸ¥ certificate çš„æœ‰æ•ˆæ€§ï¼Œå¦‚æœæ¥è¿‘éæœŸï¼Œå‰‡æœƒè§¸ç™¼æ–°çš„ä¸€è¼ª orderã€‚\næˆ‘å€‘ä¹Ÿå¯ä»¥å¯«ä¸€å€‹æ“ä½œ Configmap èˆ‡ Deployment Resource çš„ custom controllerï¼Œä¾†é€²è¡Œ deploymnet çš„ Image æ›´æ–°ã€‚\næˆ‘éœ€è¦ custom resource å— kubernetes åœ¨should I add custom resource æœ‰åˆ—è¡¨åˆ†æè©²ä¸è©²ä½¿ç”¨ custom resource ï¼Œå°‡ä½ çš„ API é‚è¼¯æ•´åˆåˆ° kubernetes API ä¸Šã€‚å¹¾å€‹åˆ¤æ–·åƒè€ƒ:\nAPI æ˜¯ declarative modelï¼Œå¦‚æœä¸æ˜¯å¯èƒ½ä¸é©åˆè·Ÿ kubernetes API æ•´åˆï¼Œç¨ç«‹æˆç‚ºä¸€å€‹è‡ªå·±é‹è¡Œçš„æœå‹™å³å¯ éœ€è¦ä½¿ç”¨ kubernetes éœ€è¦ä½¿ç”¨ kubectl æ§åˆ¶ API éœ€è¦ä½¿ç”¨ kubernetes æ”¯æ´çš„åŠŸèƒ½ æ­£å“‰é–‹ç™¼å…¨æ–°åŠŸèƒ½ï¼Œå› ç‚ºæ•´åˆèˆŠçš„æœå‹™åˆ° kubernetes API å·¥ç¨‹æµ©å¤§ ä¹Ÿè¨± configmap/secret å°±å¯ä»¥è§£æ±º å¦‚æœåªæ˜¯éœ€è¦å°‡è³‡æ–™å„²å­˜åœ¨ kubernetes ä¸Šï¼Œæœ‰ä¸€å€‹ build-int çš„ kubernetes resource å¾ˆé©åˆï¼Œå°±æ˜¯ configmapã€‚å¯ä»¥ç˜€è€ƒä»¥ä¸‹æ¢ä»¶ï¼Œåˆ¤æ–·æ˜¯å¦ configmap æ­é…èƒ½ç›£çœ‹ configmap çš„ controller å°±å¯ä»¥é”æˆéœ€æ±‚ã€‚\nå·²ç¶“æœ‰å®Œæ•´çš„ config fileï¼Œä¾‹å¦‚ mysql.cnf, nginx.confâ€¦ ä¸»è¦ç”¨é€”æ˜¯æŠŠæª”æ¡ˆæ›è¼‰åˆ° Pod ä¸­çš„ process ä½¿ç”¨ ä½¿ç”¨æ™‚çš„æ ¼å¼ï¼Œæ˜¯æ•´å€‹æª”æ¡ˆæ”¾åœ¨ Pod ä¸­ï¼Œæˆ–æ˜¯ä½¿ç”¨ç’°å¢ƒè®Šæ•¸å¡åˆ° Pod è£¡é¢ï¼Œè€Œä¸æ˜¯é€é kubernetes API å­˜å– (ex ä½¿ç”¨ kubectl) æ›´æ–° configmpa æ™‚æ›´æ–° Podï¼Œæœƒæ¯”æ›´æ–° custom resource æ™‚æ›´æ–° Pod å®¹æ˜“ å¦‚æœä½¿ç”¨ CRD æˆ– Aggregated kubernetes APIï¼Œå¤§å¤šç¬¦åˆä¸‹åˆ—æ¢ä»¶\nä½¿ç”¨ kubernetes libraries èˆ‡å®¢æˆ¶ç«¯ (ex kubectl) æ“ä½œ custom resource éœ€è¦ top level çš„ kubernetes æ”¯æ´ï¼Œä¾‹å¦‚å¯ä»¥ kubectl get cheachiachang è‡ªå‹•åŒ– kubernetes ç‰©ä»¶ éœ€è¦ç”¨åˆ° .spec, .status, .metadataï¼Œé€™äº›æ¯”è¼ƒ desired state èˆ‡ currenty state çš„åŠŸèƒ½ éœ€è¦æŠ½è±¡é¡åˆ¥ä¾†ç®¡ç†ä¸€ç¾¤ controlled resource Custom Resource Definition Custom Resoure Definition è®“ä½¿ç”¨è€…å¯ä»¥å®šç¾© custom resourceï¼Œå®šç¾© custom resource çš„æ ¼å¼åŒ…æ‹¬åç¨±èˆ‡ data schemaï¼Œç„¶å¾Œäº¤çµ¦ kubernetes API å»è™•ç† custom resource çš„å„²å­˜ã€‚\nä¹Ÿå°±æ˜¯èªªï¼Œé€é CRD æˆ‘å€‘ä¸ç”¨å¯« custom resource çš„ APIï¼Œä¾‹å¦‚ cert-manager ä¸ç”¨å¯« certificates.certmanager.k8s.io çš„ APIï¼Œè€Œæ˜¯å‘ kubernetes API server è¨»å†Š CRDï¼Œè®“ kubernetes API server çœ‹å¾—æ‡‚ custom source çš„å®šç¾©ï¼Œä¸¦ä¸”ç›´æ¥ä½¿ç”¨ kubernetes API serverï¼Œé€²è¡Œ custom resource çš„ CRUDã€‚\næˆ‘å€‘å¯ä»¥é€é kubectl (API server) æ“ä½œ certificates.certmanager.k8s.ioï¼Œé€™å€‹è«‹æ±‚ä¹Ÿæ˜¯é€åˆ° kubernetes API serverã€‚\nAPI server aggregation èƒ½å¤ é€éè¨»å†Š CRD ï¼Œå°±å¯ä»¥ä½¿ç”¨åŸä¾†çš„ kubernetes API ä¾†é€²è¡Œ CRUD ï¼Œæ˜¯å› ç‚º kubernetes API å°æ–¼æ™®é€šçš„ API æ“ä½œæä¾›æ³›å‹ (generic) ä»‹é¢ï¼Œç›´æ¥ä½¿ç”¨ CRUD çš„é‚è¼¯ã€‚\nç”±æ–¼æ˜¯ kubernetes Aggregated API ï¼Œæ‰€æœ‰ kubernetes çš„ clients éƒ½ä¸€èµ·å…¼å®¹æ–°è¨»å†Šçš„ custom resourceï¼Œä¸ç”¨åœ¨ API è¦å®šç¾©ï¼Œåœ¨å†Šæˆ¶ç«¯ä¹Ÿè¦å®šç¾©ã€‚è¨»å†Šå®Œçš„ custom resource definitionï¼Œå¯ä»¥ç›´æ¥é€é kubectl å­˜å–ã€‚\nå°çµ custom resource ç°¡ä»‹ custom resource ä½¿ç”¨çš„æƒ…å¢ƒèˆ‡æ¢ä»¶ custom resource definition èˆ‡ Aggregated API ","date":1570958892,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"fd1007cf250cbf0a57589127e2a10a31","permalink":"https://chechia.net/zh-hant/post/2019-10-13-kubernetes-custom-resources-basic/","publishdate":"2019-10-13T17:28:12+08:00","relpermalink":"/zh-hant/post/2019-10-13-kubernetes-custom-resources-basic/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","crd","gcp"],"title":"Kubernetes Custom Resources Basic","type":"post"},{"authors":[],"categories":["kubernetes","cert-manager"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nRecap æ˜¨å¤©æˆ‘å€‘å¯¦éš›ä½¿ç”¨ cert-managerï¼Œç‚º nginx ingress controller ç”¢ç”Ÿ certificatesï¼Œéç¨‹ä¸­æˆ‘å€‘åšäº†å¹¾ä»¶äº‹\nè¨­ç½® Letâ€™s Encript prod site çš„ Issuer è¨­ç½® certificates.certmanager.k8s.io è³‡æºä¾†å®šç¾© certificate çš„å–å¾—æ–¹å¼ æˆ–æ˜¯åœ¨ ingress ä¸­é…ç½® tlsï¼Œè®“ cert-manager è‡ªå‹•é€é ingress-shim ç”¢ç”Ÿ certifcates.cert-managerï¼Œä¸¦ä¸”ç”¢ç”Ÿ certificate ä»¥ä¸Šæ˜¯ä½¿ç”¨ cert-manager ç”¢ç”Ÿ certificate çš„åŸºæœ¬æ“ä½œï¼Œå‰©ä¸‹çš„æ˜¯ç”± cert-manager å®Œæˆã€‚å¯¦éš›ä¸Š cert-manager åœ¨ç”¢ç”Ÿå‡º certificate ä¹‹å‰é‚„åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œæˆ‘å€‘ä»Šå¤©å°±è©³ç´°èµ°éå®Œæ•´æµç¨‹ï¼Œè—‰æ­¤äº†è§£ cert-manager é…åˆ issuing certificate çš„æµç¨‹\nä½¿ç”¨è€…è¨­ç½® Issuer\nä½¿ç”¨è€…è¨­å®š certificate -\u0026gt; cert-manager æ ¹æ“š certificate -\u0026gt; ç”¢ç”Ÿ certificate\nCertificateRequests certificaterequests.certmanager æ˜¯ cert-manager ç”¢ç”Ÿ certificate éç¨‹ä¸­æœƒä½¿ç”¨çš„è³‡æºï¼Œä¸æ˜¯è¨­è¨ˆä¾†è®“äººé¡æ“ä½œçš„è³‡æºã€‚\nç•¶ cert-manager ç›£æ¸¬åˆ° certificate ç”¢ç”Ÿå¾Œï¼Œæœƒç”¢ç”Ÿ certificaterequests.certmanager.k8s.io è³‡æºï¼Œä¾†å‘ issuer request certificateï¼Œé€™å€‹éç¨‹èˆ‡ä½¿ç”¨å…¶ä»–å®¢æˆ¶ç«¯ (ex. certbot) ä¾†å‘ 3rd party CA server request certificate æ™‚çš„å…§å®¹ç›¸åŒï¼Œåªæ˜¯é€™é‚Šæˆ‘å€‘ä½¿ç”¨ kubernetes resource ä¾†å®šç¾©ã€‚\nåŒ…å«çš„ certificate requestï¼Œæœƒä»¥ pem encoded çš„å½¢å¼ï¼Œå†è®Šæˆ base64 encoded å­˜æ”¾åœ¨ resource ä¸­ã€‚é€™å€‹ pem key ä¹Ÿæœƒå¾åˆ°é æ–¹çš„ CA sercer (Letâ€™s Encrypt prod) ä¾† request certificate\nå¦‚æœ issuance æˆåŠŸï¼Œcertificaterequest è³‡æºæ‡‰è©²æœƒè¢« cert-manager åƒæ‰ï¼Œä¸æœƒè¢«äººé¡çœ‹åˆ°ã€‚\nä¸€å€‹ certificaterequests.certmanager å¤§æ¦‚é•·é€™æ¨£\napiVersion: cert-manager.io/v1alpha2 kind: CertificateRequest metadata: name: my-ca-cr spec: csr: LS0tLS1CRUdJTiBDRVJUSUZJQ0FUR .................................. LQo= isCA: false duraton: 90d issuerRef: name: ca-issuer # We can reference ClusterIssuers by changing the kind here. # The default value is Issuer (i.e. a locally namespaced Issuer) kind: Issuer group: cert-manager.io é€™å€‹ certificaterequests.certmanager æœƒè®“ cert-manager å˜—è©¦å‘ Issuer (lets-encrypt-prod) request certificateã€‚\nOrder orders.certmanager.k8s.io è¢« ACME çš„ Issuer ä½¿ç”¨ï¼Œç”¨ä¾†ç®¡ç† signed TLD certificate çš„ ACME orderï¼Œé€™å€‹ resource ä¹Ÿæ˜¯ cert-manager è‡ªè¡Œç”¢ç”Ÿç®¡ç†çš„ resourceï¼Œä¸éœ€è¦äººé¡ä¾†æ›´æ”¹ã€‚\nç•¶ä¸€å€‹ certificates.certmanager ç”¢ç”Ÿï¼Œä¸”éœ€è¦ä½¿å‹‡ ACME isser æ™‚ï¼Œcertmanager æœƒç”¢ç”Ÿ orders.certmanager ï¼Œä¾†å–å¾— certificateã€‚\nChallenges challenges.certmanager è³‡æºæ˜¯ ACME Issuer ç®¡ç† issuing lifecycle æ™‚ï¼Œç”¨ä¾†å®Œæˆå–®ä¸€å€‹ DNS name/identifier authorization æ™‚æ‰€ä½¿ç”¨çš„ã€‚ç”¨ä¾†ç¢ºå®š issue certiticate çš„å®¢æˆ¶ç«¯çœŸçš„æ˜¯ DNS name çš„æ“æœ‰è€…ã€‚\nç•¶ cert-manager ç”¢ç”Ÿ order æ™‚ï¼Œorder controller æ¥åˆ° order ï¼Œå°±æœƒç‚ºæ¯ä¸€å€‹éœ€è¦ DNS certificate çš„ DNSname ï¼Œç”¢ç”Ÿ challenges.certmanagerã€‚\né€™æ®µä¹Ÿæ˜¯ order controller è‡ªå‹•ç”¢ç”Ÿï¼Œä¸¦ä¸éœ€è¦ä½¿ç”¨è€…åƒèˆ‡ã€‚\nACME certificate issuing user -\u0026gt; è¨­å®šå¥½ issuers.certmanager\nuser -\u0026gt; ç”¢ç”Ÿ certificates.certmanager -\u0026gt; é¸æ“‡ Issuer -\u0026gt;\ncert-manager -\u0026gt; ç”¢ç”Ÿ certificaterequest -\u0026gt;\ncert-manager æ ¹æ“š certiticfates.certmanager ç”¢ç”Ÿ orders.certmanager -\u0026gt;\norder controller æ ¹æ“š order ï¼Œä¸¦ä¸”è·Ÿæ¯ä¸€å€‹ DNS name targetï¼Œç”¢ç”Ÿä¸€å€‹ challenges.certmanager\nchallenges.certmanager ç”¢ç”Ÿå¾Œï¼Œæœƒé–‹å•Ÿé€™å€‹ DNS name challenge çš„ lifecycle\nchallenges ç‹€æ…‹ç‚º queued for processingï¼Œåœ¨ä½‡åˆ—ä¸­ç­‰å¾…ï¼Œ å¦‚æœæ²’æœ‰åˆ¥çš„ chellenges åœ¨é€²è¡Œï¼Œchallenges ç‹€æ…‹è®Šæˆ scheduledï¼Œé€™æ¨£å¯ä»¥é¿å…å¤šå€‹ DNS challenge åŒæ™‚ç™¼ç”Ÿï¼Œæˆ–æ˜¯ç›¸åŒåç¨±çš„ DNS challenge é‡è¤‡ challenges èˆ‡é ç«¯çš„ ACME server â€˜syncedâ€™ ç•¶å‰çš„ç‹€æ…‹ï¼Œæ˜¯å¦ valid å¦‚æœ ACME å›æ‡‰é€™å€‹ DNS name çš„ challenge é‚„æ˜¯æœ‰æ•ˆçš„ï¼Œå‰‡ç›´æ¥æŠŠ challenges çš„ç‹€æ…‹æ”¹æˆ validï¼Œç„¶å¾Œç§»å‡ºæ’ç¨‹ä½‡åˆ—ã€‚ å¦‚æœ challenges ç‹€æ…‹ä»ç„¶ç‚º pendingï¼Œchallenge controller æœƒä¾ç…§è¨­å®š present é€™å€‹ challengeï¼Œä½¿ç”¨ HTTP01 æˆ–æ˜¯ DNS01ï¼Œchallenges è¢«æ¨™è¨˜ç‚º presented challenges å…ˆåŸ·è¡Œ self checkï¼Œç¢ºå®š challenge ç‹€æ…‹å·²ç¶“å‚³æ’­çµ¦ dns serversï¼Œå¦‚æœ self check å¤±æ•—ï¼Œå‰‡æœƒä¾ç…§ interval retry ACME authorization é—œè¯åˆ° challenge cert-manager è™•ç† â€˜scheduledâ€™ challenges.certmanager -\u0026gt; ACME challenge\n","date":1570873285,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"738d6814d1bc59ec9865db3f97f1ba8a","permalink":"https://chechia.net/zh-hant/post/2019-10-12-cert-manager-complete-workflow/","publishdate":"2019-10-12T17:41:25+08:00","relpermalink":"/zh-hant/post/2019-10-12-cert-manager-complete-workflow/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","cert-manager","devops"],"title":"Cert Manager Complete Workflow","type":"post"},{"authors":[],"categories":["kubernetes","cert-manager"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nä»Šå¤©æˆ‘å€‘ä¾†å¯¦éš›ä½¿ç”¨ cert-managerï¼Œç‚º nginx ingress controller ç”¢ç”Ÿ certificates with ACME Issuer\nCA Terminology å…ˆæŠŠå¯¦éš›åŸ·è¡Œ CA ç°½ç™¼çš„åè©å®šç¾©ä¸€ä¸‹ï¼Œä»¥å…è·Ÿ cert-manager çš„è³‡æºææ··\nCertificate: æ†‘è­‰ï¼Œx509 certificateï¼Œcert-manager è‡ªå‹•ç®¡ç†çš„ç›®æ¨™ï¼Œé€é letâ€™s encript å–å¾—çš„ x509 certificates CA (Certificate Authority): issue signed certificate çš„æ©Ÿæ§‹ issue: é ’ç™¼ï¼ŒæŒ‡ CA ç”¢ç”Ÿ certificate èˆ‡ key (ä»Šå¤©çš„ç¯„ä¾‹æ ¼å¼æ˜¯ .crt èˆ‡ .key) Sign vs self-signed: ç°½æ ¸ï¼Œè‡ªå·±ç°½æ ¸ï¼Œä½¿ç”¨ä¿¡ä»»çš„ CA issue certificateï¼Œæˆ–æ˜¯ä½¿ç”¨è‡ªå·±ç”¢ç”Ÿçš„ CA self-signï¼Œç„¶å¾ŒæŠŠ CA åŠ åˆ°å¯ä»¥è¢«ä¿¡ä»»çš„ CA æ¸…å–®ä¸­ã€‚ Letâ€™s Encript CA issues signed certificates\nKubernetes in-cluster CA issues self-signed certificates\ncert-manager çš„ CRD è³‡æºï¼Œä½¿ç”¨ä¾†æè¿° cert-manager å¦‚ä½•åŸ·è¡Œä¸Šè¿°æ“ä½œï¼ŒCRD åº•ä¸‹éƒ½æœƒåŠ ä¸Š ``*.certmanager.k8s.io` æ–¹ä¾¿è¾¨è­˜ã€‚\nè¨­å®š Issuer Issuer è¦æ€éº¼ç¿»æˆä¸­æ–‡XDï¼Œæ†‘è­‰é ’ç™¼æ©Ÿæ§‹ï¼Ÿ\nç¸½ä¹‹åœ¨é–‹å§‹ç°½ç™¼ certificates å‰ï¼Œè¦å…ˆå®šç¾© issuers.certmanager.k8s.io ï¼Œä»£è¡¨ä¸€å€‹èƒ½ç°½ç™¼ certificate CAï¼Œä¾‹å¦‚ Letâ€™s Encriptï¼Œæˆ–æ˜¯ kubernetes å…§éƒ¨ä¹Ÿæœ‰å…§éƒ¨ä½¿ç”¨çš„æ†‘è­‰ç°½ç™¼ï¼Œæ”¾åœ¨ secrets ä¸­ã€‚\né€™äº› Issuer æœƒè®“ certificates.certmanager.k8s.i8o ä½¿ç”¨ï¼Œå®šç¾©å¦‚ä½•å–å¾— certificate æ™‚ï¼Œé¸æ“‡ Issuerã€‚\ncert-manager ä¸Šå¯ä»¥å®šç¾©å–®ä¸€ namespace çš„ issuers.certmanager èˆ‡é›†ç¾¤éƒ½å¯ä½¿ç”¨çš„ clusterissuers.certmanager\ncert-manager æœ‰æ”¯æ´å¹¾ç¨®çš„ issuer type\nCA: ä½¿ç”¨ x509 keypair ç”¢ç”Ÿcertificateï¼Œå­˜åœ¨ kubernetes secret Self signed: è‡ªç°½ certificate ACME: å¾ ACME (ex. Letâ€™s Encrypt) server å–å¾— ceritificate Vault: å¾ Vault PKI backend é ’ç™¼ certificate Venafi: Venafi Cloud Certificate æœ‰äº†ç°½ç™¼æ†‘è­‰çš„å–®ä½ï¼Œæ¥ä¸‹ä¾†è¦å®šç¾©å¦‚ä½•å–å¾— certificateã€‚certificates.certmanager.k8s.io æ˜¯ CRDï¼Œç”¨ä¾†å‘Šè¨´ cert-manager è¦å¦‚ä½•å–å¾— certificate\ncertifcates.certmanager.k8s.io æä¾›äº†ç°¡å–®ç¯„ä¾‹\napiVersion: cert-manager.io/v1alpha2 kind: Certificate metadata: name: acme-crt spec: secretName: acme-crt-secret duration: 90d renewBefore: 30d dnsNames: - foo.example.com - bar.example.com acme: config: - http01: ingressClass: nginx domains: - foo.example.com - bar.example.com issuerRef: name: letsencrypt-prod # We can reference ClusterIssuers by changing the kind here. # The default value is Issuer (i.e. a locally namespaced Issuer) kind: Issuer ä¸Šé¢é€™å€‹ certificate.certmanger å‘Šè¨´ cert-manager\né‡å° foo.example.com èˆ‡ bar.example.com å…©å€‹ domainsc ä½¿ç”¨ letsencript-prd Issuer å»å–å¾— certificate key pair æˆåŠŸå¾ŒæŠŠ ceritifcate èˆ‡ key å­˜åœ¨ secret/acme-crt-secret ä¸­(ä»¥ tls.key, tls.crt çš„å½¢å¼) èˆ‡ certificate.certmanager éƒ½æ”¾åœ¨ç›¸åŒ namespace ä¸­ï¼Œç”¢ç”Ÿ certificate.certmanager çš„æ™‚å€™è¦æ³¨æ„æ‰ä¸æœƒæ‰¾ä¸åˆ° secret é€™é‚ŠæŒ‡å®šäº† certificate çš„æœ‰æ•ˆæœŸé–“èˆ‡ renew æ™‚é–“ (é è¨­å€¼)ï¼Œæœ‰éœ€è¦å¯ä»¥æ›´æ”¹ é…åˆ Ingress è¨­ç½® tls æœ‰ä¸Šè¿°çš„è¨­å®šï¼Œæ¥ä¸‹ä¾†å¯ä»¥è«‹æ±‚ tls certificate\nè¨˜å¾—æˆ‘å€‘ä¸Šç¯‡ Nginx Ingress Controller æåˆ°çš„ ingreess è¨­å®šå—ï¼Ÿé€™é‚Šæº–å‚™äº†ä¸€å€‹é©åˆé…åˆ nginx ingress ä½¿ç”¨çš„ tls è¨­å®š\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: my-nginx-ingress annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; cert-manager.io/issuer: \u0026#34;letsencrypt-prod\u0026#34; spec: tls: - hosts: - foo.example.com secretName: my-nginx-ingrss-tls rules: - host: foo.example.com http: paths: - path: / backend: serviceName: chechiachang-backend servicePort: 80 é€™å€‹ ingress apply å¾Œï¼Œå°±æœƒæ ¹æ“š spec.tls çš„ hosts è¨­å®šï¼Œè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ certificate.certmanager è³‡æºï¼Œä¸¦åœ¨é€™å€‹è³‡æºä½¿ç”¨ letsencryp-prodã€‚\nä¸ç”¨æˆ‘å€‘æ‰‹å‹• apply æ–°çš„ ceritificateï¼Œé€™é‚Šæ˜¯ cert-manager ä½¿ç”¨äº† annotation ä¾†è§¸ç™¼ Ingress-shimï¼Œç°¡å–®ä¾†èªªï¼Œç•¶ ingress ä¸Šæœ‰ä½¿ç”¨ cert-manager.io çš„ annotation æ™‚ï¼Œcert-manager å°±æœƒæ ¹æ“š ingress è¨­å®šå…§å®¹ï¼ŒæŠ½å‡º spec.tls èˆ‡ isuer annotationï¼Œä¾†ç”¢ç”ŸåŒåçš„ certificates.certmanagerï¼Œé€™å€‹ certificateas.certmanager æœƒè§¸ç™¼æ¥ä¸‹çš„ certificate é ’ç™¼éœ€æ±‚ã€‚\nåªè¦éƒ¨ç½² Issuer èˆ‡ Ingress å°±å¯ä»¥è‡ªå‹•ç”¢ç”Ÿ certificateã€‚ç•¶ç„¶ï¼Œå¸Œæœ›æ‰‹å‹• apply certificates.certmanager ä¹Ÿæ˜¯è¡Œå¾—é€šã€‚\næŠŠç”¢ç”Ÿäº† certificate.certmanager æ‹‰å‡ºä¾†çœ‹\nkubectl describe certificate my-nginx-ingress Name: my-nginx-ingress Namespace: default API Version: cert-manager.io/v1alpha2 Kind: Certificate Metadata: Cluster Name: Creation Timestamp: 2019-10-10T17:58:37Z Generation: 0 Owner References: API Version: extensions/v1beta1 Block Owner Deletion: true Controller: true Kind: Ingress Name: my-nginx-ingress Resource Version: 9295 Spec: Dns Names: example.your-domain.com Issuer Ref: Kind: Issuer Name: letsencrypt-prod Secret Name: my-nginx-ingress-tls Status: Acme: Order: URL: https://acme-prod-v02.api.letsencrypt.org/acme/order/7374163/13665676 Conditions: Last Transition Time: 2019-10-10T18:05:57Z Message: Certificate issued successfully Reason: CertIssued Status: True Type: Ready Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal CreateOrder 1d cert-manager Created new ACME order, attempting validation... Normal DomainVerified 1d cert-manager Domain \u0026#34;foo.example.com\u0026#34; verified with \u0026#34;http-01\u0026#34; validation Normal IssueCert 1d cert-manager Issuing certificate... Normal CertObtained 1d cert-manager Obtained certificate from ACME server Normal CertIssued 1d cert-manager Certificate issued Successfully æŠŠ certificate å¾ secret æ’ˆå‡ºä¾†çœ‹\n$ kubectl â€¦","date":1570764274,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"5fa9fa6dd18847dd7859d28ba06d3e16","permalink":"https://chechia.net/zh-hant/post/2019-10-11-cert-manager-how-it-work/","publishdate":"2019-10-11T11:24:34+08:00","relpermalink":"/zh-hant/post/2019-10-11-cert-manager-how-it-work/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","cert-manager","devops"],"title":"Cert Manager How It Work","type":"post"},{"authors":[],"categories":["kubernetes","cert-manager"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Cert-manager Introduction Deploy cert-manager ç°¡ä»‹ cert-manager TLS certificate ç®¡ç†å¾ˆé‡è¦ï¼Œä½†åœ¨ kubernetes ä¸Šç®¡ç† TLS certificates å¾ˆéº»ç…©ã€‚\nä»¥å¾€æˆ‘å€‘ä½¿ç”¨ Letâ€™s Encrypt æä¾›çš„å…è²»è‡ªå‹•åŒ–æ†‘è­‰é ’ç™¼ï¼Œæ­é… kube-lego ä¾†è‡ªå‹•è™•ç† certificate issuingï¼Œç„¶è€Œéš¨è‘— kube-lego å·²ä¸å†æ›´æ–°å¾Œï¼Œå®˜æ–¹å»ºè­°æ”¹ä½¿ç”¨ Cert-manager ä¾†é€²è¡Œ kubernetes ä¸Šçš„æ†‘è­‰è‡ªå‹•åŒ–ç®¡ç†ã€‚\ncert-manager æ˜¯ kubernetes åŸç”Ÿçš„æ†‘è­‰ç®¡ç† controllerã€‚æ˜¯çš„ä»–çš„æ ¸å¿ƒä¹Ÿæ˜¯ä¸€å€‹ controllerï¼Œé€é kubernetes object å®šç¾© desired stateï¼Œç›£æ§é›†ç¾¤ä¸Šçš„å¯¦éš›ç‹€æ…‹ï¼Œç„¶å¾Œæ ¹æ“š resource object ç”¢ç”Ÿæ†‘è­‰ã€‚cert-manager åšå¹¾ä»¶äº‹æƒ…\nåœ¨ kubernetes ä¸Š ä½¿ç”¨ CRD (Customized Resource Definition) ä¾†å®šç¾© certificate issuing çš„ desired state å‘ letâ€™s encrypt å–å¾—å…¬é–‹çš„æ†‘è­‰ åœ¨ kubernetes ä¸Šè‡ªå‹•æª¢æŸ¥æ†‘è­‰çš„æœ‰æ•ˆæœŸé™ï¼Œä¸¦è‡ªå‹•åœ¨æœ‰æ•ˆæ™‚é™å…§ renew certificateã€‚ å®‰è£ å®˜æ–¹æ–‡ä»¶æœ‰æä¾› è©³ç´°æ­¥é©Ÿ å¯ä»¥ç›´æ¥ä½¿ç”¨ release çš„ yaml éƒ¨å±¬ï¼Œä¹Ÿå¯ä»¥é€é helmã€‚\nä½¿ç”¨ yaml éƒ¨å±¬ # Create a namespace to run cert-manager in kubectl create namespace cert-manager # Disable resource validation on the cert-manager namespace kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true é–‹ä¸€å€‹ç¨ç«‹çš„ namespace ä¾†ç®¡ç† cert-manager resources\nå–æ¶ˆ namespcae ä¸­çš„ kubernetes validating webhookã€‚ç”±æ–¼ cert-manager æœ¬èº«å°±æœƒä½¿ç”¨ ValidatingWebhookConfiguration ä¾†ç‚º cert-manager å®šç¾©çš„ Issuer, Certificate resource åš validatingã€‚ç„¶è€Œé€™æœƒé€ æˆ cert-manager èˆ‡ webhook çš„å¾ªç’°ä¾è³´ (circling dependency)\n# Install the CustomResourceDefinitions and cert-manager itself kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.10.1/cert-manager.yaml # Install the CustomResourceDefinitions and cert-manager itself kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.10.1/cert-manager.yaml é€™å€‹ yaml è£¡é¢é‚„æœ‰å¹¾å€‹å…ƒä»¶\nCluster Role-bindings CustomResourceDefinition certificaterequests.certmanager.k8s.io certificates.certmanager.k8s.io challenges.certmanager.k8s.io clusterissuers.certmanager.k8s.io issuers.certmanager.k8s.io orders.certmanager.k8s.io é€™äº›å…ƒä»¶çš„ç´°ç¯€ï¼Œç•™å¾…é‹ä½œåŸç†åˆ†ææ™‚å†è©³è§£ã€‚\nhelm deployment é€™é‚Šä¹Ÿé™„ä¸Šä½¿ç”¨ helm å®‰è£çš„æ­¥é©Ÿ\n#!/bin/bash # Install the CustomResourceDefinition resources separately kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.10/deploy/manifests/00-crds.yaml # Create the namespace for cert-manager kubectl create namespace cert-manager # Label the cert-manager namespace to disable resource validation kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true # Add the Jetstack Helm repository helm repo add jetstack https://charts.jetstack.io # Update your local Helm chart repository cache helm repo update # Install the cert-manager Helm chart helm install \\ --name cert-manager \\ --namespace cert-manager \\ --version v0.10.1 \\ jetstack/cert-managerNAMESPACE=cert-manager éƒ¨å±¬å®Œæª¢æŸ¥ä¸€ä¸‹\nkubectl get pods --namespace cert-manager NAME READY STATUS RESTARTS AGE cert-manager-5c6866597-zw7kh 1/1 Running 0 2m cert-manager-cainjector-577f6d9fd7-tr77l 1/1 Running 0 2m cert-manager-webhook-787858fcdb-nlzsq 1/1 Running 0 2m é€™é‚Šéƒ¨å±¬å®Œï¼Œæœƒç²å¾—å®Œæ•´çš„ cert-manager èˆ‡ cert-manager CRDï¼Œä½† certificate çš„ desired state object é‚„æ²’éƒ¨å±¬ã€‚ä¹Ÿå°±æ˜¯é—œæ–¼æˆ‘å€‘è¦å¦‚ä½• issue certificate çš„ç›¸é—œæè¿°ï¼Œéƒ½é‚„æ²’æœ‰ deployï¼Œ cert-manager è‡ªç„¶ä¸æœƒå·¥ä½œã€‚é—œæ–¼ issuing resources configurationï¼Œæˆ‘å€‘ä¸‹æ¬¡å†èŠã€‚\n","date":1570695130,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"4678aebc0f449b2a17c6af56d5feb0e0","permalink":"https://chechia.net/zh-hant/post/2019-10-10-cert-manager-deployment/","publishdate":"2019-10-10T16:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-10-cert-manager-deployment/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","cert-manager","devops"],"title":"Cert Manager Deployment on Kubernetes","type":"post"},{"authors":[],"categories":["kubernetes","nginx"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šè©²äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nNginx Ingress Controller ç°¡ä»‹ nginx \u0026amp; Ingress Controller éƒ¨å±¬ä¸¦è¨­å®š nginx ingress controller Nginx Introduction Nginx æ˜¯ä¸€æ¬¾é«˜æ•ˆèƒ½ã€è€ç”¨ã€ä¸”åŠŸèƒ½å¼·å¤§çš„ load balancer ä»¥åŠ web serverï¼Œä¹Ÿæ˜¯å¸‚å ç‡æœ€é«˜çš„ web server ä¹‹ä¸€ã€‚\né«˜æ•ˆèƒ½çš„ web serverï¼Œé å‹å‚³çµ± apache server çš„è³‡æºèˆ‡æ•ˆèƒ½ å¤§é‡çš„æ¨¡çµ„èˆ‡æ“´å……åŠŸèƒ½ æœ‰å……è¶³çš„å®‰å…¨æ€§åŠŸèƒ½èˆ‡è¨­å®š è¼•é‡ å®¹æ˜“æ°´å¹³æ“´å±• Ingress \u0026amp; Ingress Controller é€™é‚Šç°¡å–®è¬›ä¸€ä¸‹ kubernetes ingressã€‚ç•¶æˆ‘å€‘åœ¨ä½¿ç”¨ kubernetes æ™‚éœ€è¦å°‡å¤–éƒ¨æµé‡ route åˆ°é›†ç¾¤å…§éƒ¨ï¼Œé€™é‚Šä½¿ç”¨ Ingress é€™å€‹ api resourceï¼Œä¾†å®šç¾©å¤–éƒ¨åˆ°å…§éƒ¨çš„è¨­å®šï¼Œä¾‹å¦‚:\nservice é€£æ¥ load balance è¨­å®š SSL/TLS çµ‚ç«¯ è™›æ“¬ä¸»æ©Ÿè¨­å®š ä¸€å€‹ç°¡å–®çš„ ingress å¤§æ¦‚é•·é€™æ¨£\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: test-ingress annotations: nginx.ingress.kubernetes.io/rewrite-target: / spec: rules: - http: paths: - path: /testpath backend: serviceName: test servicePort: 80 é™¤äº†ä¸€èˆ¬çš„ k8s è³‡æºï¼Œnginx ä¸»è¦çš„è¨­å®šæœƒè½åœ¨ specï¼Œä»¥åŠä¾è³´åº•ä¸‹å¯¦ä½œä¸åŒï¼Œé¡å¤–è¨­å®šçš„ annotationã€‚\né€™é‚Šå¯ä»¥çœ‹åˆ° spec.rule å®šç¾©äº†å¤–éƒ¨ http æµé‡ï¼Œå¼•å°åˆ° backend service çš„è·¯å¾‘ã€‚\nannotations ä¸‹å·²ç¶“æ¨™è¨»çš„ nginx.ingress çš„ annotationï¼Œä¾†å¿«é€Ÿå¢åŠ é¡å¤–çš„è¨­å®šã€‚\nIngress \u0026amp; Ingress Controller é›–ç„¶å·²ç¶“æŒ‡å®š nginx çš„ annotationï¼Œä½†é€™é‚Šè¦æ³¨æ„ï¼Œingress resource æœ¬èº«æ˜¯ä¸æŒ‡å®šåº•å±¤çš„å¯¦ç¾ (ingress controller)ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œåº•ä¸‹æ˜¯ nginx ä¹Ÿå¥½ï¼Œtraefik ä¹Ÿè¡Œï¼Œåªè¦èƒ½å¤ å¯¦ç¾ ingress è£é ­è¨­å®šçš„ routing rules å°±å¯ä»¥ã€‚\nåªè¨­å®šå¥½ ingressï¼Œé›†ç¾¤ä¸Šæ˜¯ä¸æœƒæœ‰ä»»ä½•ä½œç”¨çš„ï¼Œé‚„éœ€è¦åœ¨é›†ç¾¤ä¸Šå®‰è£ ingress controller çš„å¯¦ä½œï¼Œå¯¦ä½œå®‰è£å®Œäº†ä»¥å¾Œï¼Œæœƒä¾æ“š ingress çš„è¨­å®šï¼Œåœ¨ controller è£é ­å¯¦ç¾ï¼Œä¸ç®¡æ˜¯ routingã€ssl/tls terminationã€load balancing ç­‰ç­‰åŠŸèƒ½ã€‚å¦‚åŒè¨±å¤š Kubernetes resource çš„è¨­è¨ˆç†å¿µä¸€æ¨£ï¼Œé€™é‚Šä¹Ÿå¾ˆå„ªé›…çš„ç”¨ ingress èˆ‡ ingress controllerï¼Œæ‹†åˆ†çš„éœ€æ±‚è¨­å®šèˆ‡å¯¦ä½œå¯¦ç¾å…©é‚Šçš„è·è²¬ã€‚\nä¾‹å¦‚ä»¥ nginx ingress controllerï¼Œå®‰è£å®Œå¾Œæœƒä¾æ“š ingress çš„è¨­å®šï¼Œåœ¨ nginx pod è£¡è¨­å®šå°æ‡‰çš„ routing rulesï¼Œå¦‚æœæœ‰ ssl/tls è¨­å®šï¼Œä¹Ÿä¸€ä½µè¼‰å…¥ã€‚\nKubernetes å®˜æ–¹æ–‡ä»¶æä¾›äº†è¨±å¤šä¸åŒçš„ controller å¯ä»¥ä¾ç…§éœ€æ±‚é¸æ“‡ã€‚\nä½†å¦‚æœä¸çŸ¥é“å¦‚ä½•é¸æ“‡ï¼Œå€‹äººæœƒæ¨è–¦ä½¿ç”¨ nginx ingress controllerï¼Œç©©å®šã€åŠŸèƒ½å¼·å¤§ã€è¨­å®šåˆä¸è‡³æ–¼å¤ªéè¤‡é›œï¼ŒåŸºæœ¬çš„è¨­å®šå°±èƒ½å¾ˆå¥½çš„æ”¯æ’æœå‹™ï¼Œä¸ç†Ÿæ‚‰çš„å¤§å¾·å€‘æ¯”è¼ƒä¸å®¹æ˜“è¢«é›·åˆ°ã€‚\nåº•ä¸‹æˆ‘å€‘å°±è¦ä¾†é–‹å§‹ä½¿ç”¨ nginx ingress controllerã€‚\nDeployment æˆ‘å€‘é€™é‚Šä½¿ç”¨çš„ ingress-nginx æ˜¯ kubernetes org å…§ç¶­è­·çš„å°ˆæ¡ˆï¼Œå°ˆæ¡ˆå…§å®¹ä¸»è¦æ˜¯å† k8s ä¸ŠåŸ·è¡Œ nginxï¼ŒæŠ½è±¡èˆ‡å¯¦ä½œçš„æ•´åˆï¼Œä¸¦é€é configmap ä¾†è¨­å®š nginxã€‚é‡å° nginx ingress kubernetes å®˜æ–¹æœ‰æä¾›éå¸¸è©³ç´°çš„èªªæ˜æ–‡ä»¶ ï¼Œå‰›æ¥è§¸ nginx çš„å¤§å¾·å¯ä»¥é€éé€™ä»½æ–‡ä»¶ï¼Œå¿«é€Ÿçš„æ“ä½œ nginx çš„è¨­å®šï¼Œè€Œä¸ç”¨ç›´æ¥å¯« nginx.conf çš„è¨­å®šæª”æ¡ˆã€‚\nrepo ç‰ˆæœ¬æ˜¯ nginx-0.26.1 Image ç‰ˆæœ¬æ˜¯ quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.26.1 Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼ŒNginx Ingress Controller Stable Chartï¼Œè®“å„ä½å¤§å¾·ç”¨æœ€ç°¡å–®çš„æ­¥é©Ÿï¼Œç²å¾—ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„ nginx ingress controllerã€‚\nèˆ‡å‰é¢å¹¾å€‹ helm chart ä¸€æ¨£ï¼Œæˆ‘å€‘å¯ä»¥å…ˆå–å¾— default values.yaml è¨­å®šæª”ï¼Œå†é€²è¡Œæ›´æ”¹ã€‚\n$ wget https://raw.githubusercontent.com/helm/charts/master/stable/nginx-ingress/values.yaml $ vim values.yaml å®‰è£æ™‚ä¹Ÿå¯ä»¥ä½¿ç”¨ â€“set ä¾†è®Šæ›´å®‰è£ chart æ™‚çš„ parameters\n$ helm install stable/nginx-ingress \\ --set controller.metrics.enabled=true \\ -f values.yaml å®‰è£å®Œå¾Œï¼Œresource å¾ˆå¿«å°±èµ·ä¾†ã€‚\nkubectl get all --selector app=nginx-ingress NAME READY STATUS RESTARTS AGE pod/nginx-ingress-controller-7bbcbdcf7f-tx69n 1/1 Running 0 216d pod/nginx-ingress-default-backend-544cfb69fc-rnn6h 1/1 Running 0 216d NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/nginx-ingress-controller LoadBalancer 10.15.246.22 34.35.36.37 80:30782/TCP,443:31933/TCP 216d service/nginx-ingress-default-backend ClusterIP 10.15.243.19 \u0026lt;none\u0026gt; 80/TCP 216d NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-ingress-controller 1/1 1 1 216d deployment.apps/nginx-ingress-default-backend 1/1 1 1 216d NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-ingress-controller-7bbcbdcf7f 1 1 1 216d replicaset.apps/nginx-ingress-default-backend-544cfb69fc 1 1 1 216d kubectl get configmap -l app=nginx-ingress NAME DATA AGE nginx-ingress-controller 2 216d kubectl get ingress NAME HOSTS ADDRESS PORTS AGE ingress-nginx api.chechiachang.com 34.35.36.37 80, 443 216d å…©å€‹ Pods\nNginx ingress controller æ˜¯ä¸»è¦çš„ nginx podï¼Œè£¡é¢è·‘çš„æ˜¯ nginx Nginx default backend è·‘çš„æ˜¯ default backendï¼Œnginx çœ‹ä¸æ‡‚äº† route request éƒ½å¾€é€™é‚Šé€ã€‚ Service\nnginx-ingress-contrller æ˜¯æˆ‘å€‘åœ¨ GCP ä¸Šï¼Œåœ¨é›†ç¾¤å¤–éƒ¨çš„ GCP ä¸Šçš„å°å¤–æ¥å£ã€‚å¦‚æœåœ¨ä¸åŒå¹³å°ä¸Šï¼Œä¾æ“šé è¨­ service load balancer æœ‰ä¸åŒå¯¦ä½œã€‚ åœ¨ gcp ä¸Šï¼Œæœƒéœ€è¦æ™‚é–“ä¾†å•Ÿå‹• load balancerï¼Œç­‰ load balancer å•Ÿå‹•å®Œæˆï¼Œservice é€™é‚Šå°±å¯ä»¥å–å¾—å¤–éƒ¨çš„ ipï¼Œæ¥å— load balancer ä¾†çš„æµé‡ å¦å¤–ä¸€å€‹ service å°±æ˜¯ default backend çš„ service è¸©é›· ç¬¬ä¸€å€‹é›·é»æ˜¯ helm chart install å¸¶å…¥çš„ parametersï¼Œæœ‰äº› parameter æ˜¯ç›´æ¥å½±éŸ¿ deployment çš„è¨­å®šï¼Œå¦‚æœæ²’æ³¨æ„åˆ°ï¼Œå®‰è£å®Œå¾Œæ²’è¾¦æ³•é€é hot reload ä¾†è™•ç†ï¼Œåªèƒ½å¹¹æ‰é‡ä¾†ã€‚å»ºè­°æŠŠé€™ä»½è¡¨æ ¼éƒ½çœ‹éä¸€æ¬¡ï¼Œå†ä¾ç…§ç’°å¢ƒèˆ‡éœ€æ±‚è£œä¸Šã€‚\n$ helm install stable/nginx-ingress \\ --set controller.metrics.enabled=true \\ --set controller.service.externalTrafficPolicy=Local \\ -f values.yaml é€™é‚Šé–‹äº† prometheus metrics exporterï¼Œä»¥åŠ source IP preservationã€‚\nNginx Config å†å®‰è£å®Œå¾Œï¼Œå¤–éƒ¨çš„ load balancer å•Ÿç”¨å¾Œï¼Œå°±å¯ä»¥é€é GCP çš„ external ip é€£å…¥ nginxï¼Œnginx ä¾ç…§è¨­å®šçš„ rule å‘å¾Œç«¯æœå‹™åšé›†ç¾¤å…§çš„ load balancing èˆ‡ routingã€‚\nå¦‚æœåœ¨ä½¿ç”¨éç¨‹ä¸­ï¼Œæœ‰éœ€è¦åŸ·è¡Œæ›´æ”¹è¨­å®šï¼Œæˆ–æ˜¯ hot reload configï¼Œåœ¨ kubernetes ä¸Šè¦å¦‚ä½•åšå‘¢? æˆ‘å€‘ä¸‹å›åˆ†è§£ã€‚\n","date":1570493530,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"d98ded7b05e4f7415ea2405ff8a0e2c5","permalink":"https://chechia.net/zh-hant/post/2019-10-08-kubernetes-nginx-ingress-controller/","publishdate":"2019-10-08T08:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-08-kubernetes-nginx-ingress-controller/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šè©²äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","nginx","ingress"],"title":"Kubernetes Nginx Ingress Controller","type":"post"},{"authors":[],"categories":["kubernetes","nginx"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Nginx Ingress Controller é‹ä½œåŸç† è¨­å®š Nginx Ingress Controller é‹ä½œåŸç† æ˜¨å¤©è¬›å®Œ nginx ingress controller éƒ¨å±¬ï¼Œä»Šå¤©ä¾†è«‡è«‡ controller æ˜¯å¦‚ä½•é‹ä½œçš„ã€‚\nNginx ä½¿ç”¨ config file (nginx.conf) åšå…¨åŸŸè¨­å®šï¼Œç‚ºäº†è®“ nginx èƒ½éš¨ config file æ›´æ–°ï¼Œcontroller è¦åµæ¸¬ config file è®Šæ›´ï¼Œä¸¦ä¸” reload nginx é‡å° upstream (å¾Œç«¯ app çš„ endpoint) è®Šæ›´ï¼Œä½¿ç”¨ lua-nginx-module ä¾†æ›´æ–°ã€‚å› ç‚º kubernetes ä¸Šï¼Œservice å¾Œçš„æœå‹™å¸¸å¸¸æœƒå‹•æ…‹çš„è®Šæ›´ï¼Œscalingï¼Œä½† endpint ip list åˆéœ€è¦æ›´æ–°åˆ° nginxï¼Œæ‰€ä»¥ä½¿ç”¨ lua é¡å¤–è™•ç† åœ¨ kubernetes ä¸Šè¦å¦‚ä½•åšåˆ°ä¸Šè¿°å…©ä»¶äº‹å‘¢?\nä¸€èˆ¬ controller éƒ½ä½¿ç”¨åŒæ­¥ loop ä¾†æª¢æŸ¥ current state æ˜¯å¦èˆ‡ desired state desired state ä½¿ç”¨ k8s object æè¿°ï¼Œä¾‹å¦‚ ingress, services, configmap ç­‰ç­‰ object Nginx ingress controller é€™é‚Šä½¿ç”¨çš„æ˜¯ client-go ä¸­çš„ Kubernetes Informer çš„ SharedInformerï¼Œå¯ä»¥æ ¹æ“š object çš„æ›´æ–°åŸ·è¡Œ callback ç”±æ–¼ç„¡æ³•æª¢æŸ¥æ¯ä¸€æ¬¡çš„ object æ›´å‹•ï¼Œæ˜¯å¦å° config ç”¢ç”Ÿå½±éŸ¿ï¼Œé€™é‚Šç›´æ¥æ¯æ¬¡æ›´å‹•éƒ½ç”¢ç”Ÿå…¨æ–°çš„ model å¦‚æœæ–°ç”¢ç”Ÿçš„ model èˆ‡ç¾æœ‰ç›¸åŒï¼Œå°±è·³é reload å¦‚æœ model åªå½±éŸ¿ endpointï¼Œä½¿ç”¨ nginx å…§éƒ¨çš„ lua handler ç”¢ç”Ÿæ–°çš„ endpoint listï¼Œä¾†é¿å…å› ç‚º upstream æœå‹™è®Šæ›´é€ æˆçš„é »ç¹ reload å¦‚æœæ–° Model å½±éŸ¿ä¸åª endpointï¼Œå‰‡å–ä»£ç¾æœ‰ modelï¼Œç„¶å¾Œè§¸ç™¼ reload å…·é«”æœƒè§¸ç™¼ reload çš„äº‹ä»¶ï¼Œè«‹è¦‹å®˜æ–¹æ–‡ä»¶\né™¤äº†ç›£æ¸¬ objectsï¼Œbuild modelï¼Œè§¸ç™¼ reloadï¼Œä¹‹å‰ controller é‚„æœƒå°‡ ingress é€åˆ° kubernetes validating admission webhook server åšé©—è­‰ï¼Œé¿å…æè¿° desired state çš„ ingress æœ‰ syntax errorï¼Œå°è‡´æ•´å€‹ controller çˆ†ç‚¸ã€‚\nConfiguration è¦é€é controller æ›´æ”¹ nginx è¨­å®šï¼Œæœ‰ä»¥ä¸‹ä¸‰ç¨®æ–¹å¼\næ›´æ”¹ configmapï¼Œå°å…¨åŸŸçš„ controller è¨­å®š æ›´æ”¹ ingress ä¸Šçš„ annotationï¼Œé€™äº› annotation é‡å°ç¨ç«‹ ingress ç”Ÿæ•ˆ æœ‰æ›´æ·±å…¥çš„å®¢è£½åŒ–ï¼Œæ˜¯ä¸Šè¿°å…©è€…é”ä¸åˆ°æˆ–å°šæœªå¯¦ä½œï¼Œå¯ä»¥ä½¿ç”¨ Custom Template ä¾†åšåˆ°ï¼ŒæŠŠ nginx.tmpl mount é€² controller Configmap ç”±æ–¼æŠŠå…¨åŸŸè¨­å®šæ”¾åˆ° configmap ä¸Šï¼Œnginx ingress controller éå¸¸å¥½èª¿åº¦èˆ‡æ“´å±•ï¼Œcontroller å®˜æ–¹èªªæ˜æ–‡ä»¶ é™¤äº†åˆ—å‡ºç›®å‰å·²ç¶“æ”¯æ´çš„è¨­å®šå¤–ï¼Œä¹Ÿç›´æ¥é™„ä¸Š nginx å®˜æ–¹çš„æ–‡ä»¶èªªæ˜é€£çµï¼Œè®“ä½¿ç”¨è€…æŸ¥è©¢æ™‚æ–¹ä¾¿æ¯”å°ã€‚\nç•¶éœ€è¦æ›´æ”¹éœ€æ±‚ï¼Œå¯ä»¥ google nginx çš„é—œéµå­—ï¼Œæ‰¾åˆ° nginx ä¸Šè¨­å®šçš„åŠŸèƒ½é¸é …å¾Œï¼Œä¾† controller çš„æ–‡ä»¶ï¼Œæ‰¾çœ‹çœ‹ç›®å‰æ˜¯å¦å·²ç¶“æ”¯æ´ã€‚æœ‰æ™‚å€™æœ‰éœ€è¦å°ç…§ nginx å®˜æ–¹æ–‡ä»¶ï¼Œä¾†æ­£ç¢ºè¨­å®š controllerã€‚\nAnnotation æœ‰å¾ˆå¤š Nginx çš„è¨­å®šæ˜¯æ ¹æ“š ingress ä¸åŒè€Œæœ‰èª¿æ•´ï¼Œä¾‹å¦‚é‡å°é€™å€‹ ingress åšç™½åå–®ï¼Œè¨­å®š sessionï¼Œè¨­å®š ssl ç­‰ç­‰ï¼Œé€™äº›é‡å°ç‰¹å®š ingress æ‰€åšçš„è¨­å®šï¼Œå¯ä»¥ç›´æ¥å¯«åœ¨ ingress annotation è£¡é¢ã€‚\nä¾‹å¦‚ä¸‹é¢é€™å€‹ Ingress\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: ingress-nginx annotations: kubernetes.io/ingress.class: nginx kubernetes.io/tls-acme: \u0026#39;true\u0026#39; certmanager.k8s.io/cluster-issuer: letsencrypt-prod kubernetes.io/ingress.allow-http: \u0026#34;true\u0026#34; ingress.kubernetes.io/force-ssl-redirect: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/whitelist-source-range: \u0026#34;34.35.36.37\u0026#34; nginx.ingress.kubernetes.io/proxy-body-size: \u0026#34;20m\u0026#34; ingress.kubernetes.io/proxy-body-size: \u0026#34;20m\u0026#34; # https://github.com/Shopify/ingress/blob/master/docs/user-guide/nginx-configuration/annotations.md#custom-nginx-upstream-hashing nginx.ingress.kubernetes.io/load-balance: \u0026#34;ip_hash\u0026#34; # https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/ nginx.org/server-snippets: gzip on; nginx.ingress.kubernetes.io/affinity: \u0026#34;cookie\u0026#34; nginx.ingress.kubernetes.io/session-cookie-name: \u0026#34;route\u0026#34; nginx.ingress.kubernetes.io/session-cookie-hash: \u0026#34;sha1\u0026#34; nginx.ingress.kubernetes.io/session-cookie-expires: \u0026#34;3600\u0026#34; nginx.ingress.kubernetes.io/session-cookie-max-age: \u0026#34;3600\u0026#34; nginx.ingress.kubernetes.io whitelist-source-range: åªå…è¨±ç™½åå–® ip load-balance: â€œip_hashâ€: æ›´æ”¹é è¨­ round_robin çš„ load balanceï¼Œç‚ºäº†åš session cookie affinity: â€œcookieâ€: è¨­å®š upstream çš„ session affinity session-cookie-name: â€œrouteâ€ session-cookie-hash: â€œsha1â€ session-cookie-expires: â€œ3600â€ session-cookie-max-age: â€œ3600â€ å¦‚æœå¾Œç«¯ server æœ‰ session éœ€æ±‚ï¼Œå¸Œæœ›ç›¸åŒ source ip ä¾†çš„ request èƒ½æŒçºŒåˆ°ç›¸åŒçš„ endpointã€‚æ‰åšäº†ä»¥ä¸Šè¨­å®šã€‚\nhelm configuration helm çš„ configuration ä¹Ÿæ˜¯é‡è¦çš„è¨­å®šï¼Œé€™è£¡åœ¨å®‰è£æ™‚æ±ºå®šäº† nginx ingress controller çš„ topologyã€replicasã€resourceã€k8s runtime è¨­å®šå¦‚ healthz \u0026amp; readinessã€å…¶å¯¦éƒ½æœƒå½±éŸ¿ nginx å…·é«”çš„è¨­å®šã€‚é€™éƒ¨åˆ†å°±æœƒæœ‰å¾ˆå¤šè€ƒé‡ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘å†ä¾†åˆ†äº«ã€‚\n","date":1570493530,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"aa53a03752ed3f5fcae7f89c9ecffbf5","permalink":"https://chechia.net/zh-hant/post/2019-10-08-kubernetes-nginx-ingress-config/","publishdate":"2019-10-08T08:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-08-kubernetes-nginx-ingress-config/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026 Operator-sdk (3) Introduction about custom resource Deployment \u0026 Usage Deployment \u0026 Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","nginx","ingress"],"title":"Kubernetes Nginx Ingress Controller Config","type":"post"},{"authors":[],"categories":["kubernetes","prometheus"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nå¦‚æœè¦é€é prometheus ä¾†ç›£æ§é›†ç¾¤çš„é‹è¡Œç‹€æ³ï¼Œæœ‰å…©å€‹ exporter æ˜¯å¿…è£çš„ï¼Œä¸€å€‹æ˜¯æŠŠ node ç‹€æ…‹ export å‡ºä¾†çš„ node exporterï¼Œä¸€å€‹æ˜¯æŠŠ kubernetes é›†ç¾¤ç‹€æ…‹ export å‡ºä¾†çš„ kube state metrics exporterã€‚\nNode Exporter ç°¡ä»‹ kube metrics exporter å®‰è£èˆ‡è¨­å®š Node Exporter Node Exporter æ˜¯ prometheus å®˜æ–¹ç¶­è­·çš„ä¸€å€‹å­é …ç›®ï¼Œä¸»è¦åœ¨æŠŠé¡ unix ç¡¬é«” kernel çš„ metrics é€å‡ºä¾†ã€‚å®˜æ–¹ä¹Ÿæ”¯æ´ windows node èˆ‡ nvidia gpu metricsï¼Œå¯ä»¥èªªæ˜¯åŠŸèƒ½å¼·å¤§ã€‚\nç‚ºäº†èƒ½å¤ ç›£æ¸¬ kubernetes node çš„åŸºç¤è¨­æ–½ç‹€æ…‹ï¼Œé€šå¸¸éƒ½æœƒä½¿ç”¨ node exporterã€‚\nnode exporter å®‰è£ï¼Œæˆ‘å€‘åœ¨å®‰è£ prometheus helm chart æ™‚å°±ä¸€ä¸¦å®‰è£äº†ã€‚é€™é‚Šçœ‹ä¸€ä¸‹è¨­å®šèˆ‡é‹è¡Œã€‚\nCollectors Node exporter æŠŠä¸åŒä½ç½®æ”¶é›†åˆ°çš„ä¸åŒé¡å‹çš„ metrics ï¼Œåšæˆå„è‡ªç¨ç«‹çš„ colletorï¼Œä½¿ç”¨è€…å¯ä»¥æ ¹æ“šæ±‚éœ€æ±‚ä¾†å•Ÿç”¨æˆ–æ˜¯ä¸å•Ÿç”¨ collectorï¼Œå®Œæ•´çš„ collector ç›®éŒ„ åœ¨é€™é‚Šã€‚\nå¦‚æœæœ‰çœ‹æˆ‘å€‘ç¬¬ä¸€éƒ¨ä»½çš„ ELK partï¼Œæ‡‰è©²æœƒè¦ºå¾—é€™è£¡çš„è¨­å®šï¼Œè·Ÿ metricbeat éå¸¸åƒï¼ŒåŸºæœ¬ä¸Šé€™å…©è€…åšçš„äº‹æƒ…æ˜¯å¤§åŒå°ç•°çš„ï¼Œæ”¶é›† metrics ä¾†æºéƒ½æ˜¯åŒæ¨£çš„é¡ unix ç³»çµ±ï¼Œåªæ˜¯å¾€å¾Œé€çš„ç›®æ¨™ä¸ä¸€æ¨£ (é›–ç„¶ç¾åœ¨å…©è€…éƒ½å¯ä»¥å…¼å®¹æ··æ­äº†)ã€‚å¦‚æœæœ‰æ¥è§¸éå…¶ä»–å¹³å°çš„ metrics collectorï¼Œä¹Ÿæœƒç™¼ç¾å…¶å¯¦å¤§å®¶åšçš„éƒ½å·®ä¸å¤šã€‚\nTextfile Collector Prometheus é™¤äº†æœ‰ scrape æ©Ÿåˆ¶ï¼Œè®“ prometheus å» exporter æ’ˆè³‡æ–™å¤–ï¼Œé‚„æœ‰å¦å¤–ä¸€å€‹æ©Ÿåˆ¶ï¼Œå«åš Pushgatewayï¼Œé€™å€‹æˆ‘å€‘åœ¨éƒ¨å±¬ prometheus æ™‚ä¹Ÿéƒ¨å±¬äº†ä¸€å€‹ã€‚é€™é‚Šç°¡å–®èªªæ˜ä¸€ä¸‹ã€‚\nç¶“å¸¸æ€§åŸ·è¡Œçš„æœå‹™(redis, kafka,â€¦)æœƒä¸€ç›´é‹è¡Œï¼Œprometheus é€éé€™äº›æœå‹™çš„ metrics å–å¾— runtime metricsï¼Œä½œç‚ºç›£æ§è³‡æ–™ã€‚å¯æ˜¯æœ‰ä¸€äº› job æ˜¯æš«æ™‚æ€§çš„ä»»å‹™ï¼Œä¾‹å¦‚æœä¸€å€‹ batch jobï¼Œé€™äº›æœå‹™ä¸æœƒæœ‰ä¸€ç›´é‹è¡Œçš„ runtime metricsï¼Œä¹Ÿä¸æœƒæœ‰ exporterã€‚ä½†é€™æ™‚åˆå¸Œæœ›ç›£æ§é€™äº› job çš„ç‹€æ…‹ï¼Œå°±å¯ä»¥ä½¿ç”¨ Pushgatewayã€‚\nPushgateway çš„ä½œç”¨æ©Ÿåˆ¶ï¼Œå°±æ˜¯æŒ‡å®šæ”¶é›†çš„ç›®æ¨™è³‡æ–™å¤¾ï¼Œéœ€è¦ç›£æ¸¬çš„ batch jobï¼Œåªè¦æŠŠå¸Œæœ›ç›£æ¸¬çš„è³‡æ–™ï¼Œå¯«åˆ°è©²è³‡æ–™å¤¾ã€‚Pushgateway æœƒä¾æ“šå¯«å…¥çš„è³‡æ–™ï¼Œè½‰æˆ time series metricsï¼Œä¸¦ä¸” export å‡ºä¾†ã€‚\né€™ç¨®å» tail æŒ‡å®šç›®éŒ„æª”æ¡ˆï¼Œç„¶å¾ŒæŠŠ metrics å¾Œé€çš„æ©Ÿåˆ¶ï¼Œæ˜¯å¦è·Ÿ filebeat æœ‰ä¸€é»é¡ä¼¼? åªæ˜¯ filebeat ä¸€èˆ¬å–å¾—è³‡æ–™å¾Œï¼Œæœƒä¸»å‹•æ¨é€åˆ° ELK ä¸Šï¼Œprometheus pushgateway æœƒæš´éœ²å‡º metrics å¾Œï¼Œè®“ prometheus server ä¾† scrapeã€‚\nPushgateway ä¹Ÿæœƒåœ¨æ”¶é›†è³‡æ–™æ™‚æ‰“ä¸Šéœ€è¦çš„ labelï¼Œæ–¹é¢å¾Œæ®µè™•ç†è³‡æ–™ã€‚\nKubernetes State Metrics (Exporter) Node Exporter å°‡ kubernetes é›†ç¾¤åº•ä¸‹çš„ Node çš„ç¡¬é«”ç‹€æ…‹ï¼Œä¾‹å¦‚ cpu, memory, storage,â€¦ expose å‡ºä¾†ï¼Œç„¶è€Œæˆ‘å€‘åœ¨ç¶­é‹ kubernetes é‚„éœ€è¦å¾ api server ç²å¾—é›†ç¾¤å…§éƒ¨çš„è³‡æ–™ï¼Œä¾‹å¦‚èªª pod state, container state, endpoints, service, â€¦ç­‰ï¼Œé€™é‚Šå¯ä»¥ä½¿ç”¨ kube-state-metrics ä¾†è™•ç†ã€‚\nkube-state-metrics æ˜¯ kubernetes å®˜æ–¹ç¶­è­·çš„å°ˆæ¡ˆï¼Œåšçš„äº‹æƒ…å°±æ˜¯å‘ api server è©¢å• kubernetes çš„ stateï¼Œä¾‹å¦‚ pod state, deployment stateï¼Œç„¶å¾Œè·Ÿ prometheus exporter ä¸€ï¼Œé–‹æ”¾ä¸€å€‹ http endpointï¼Œè®“éœ€è¦çš„æœå‹™ä¾† scrape metricsã€‚\nå·¥ä½œé›²è£¡ä¹Ÿå¾ˆå–®ç´”ï¼Œkubernetes api server å¯ä»¥æŸ¥è©¢ pod ç•¶ä¸‹çš„ç‹€æ…‹ï¼Œkube-state-metrics å‰‡æœƒæŠŠç•¶ä¸‹çš„ç‹€æ…‹ä¾ç…§æ™‚é–“åºï¼Œåšæˆ time series çš„ metricsï¼Œä¾‹å¦‚é€™å€‹ pod ä»€éº¼æ™‚å€™æ˜¯æ´»è‘—ï¼Œä»€éº¼æ™‚å€™å› ç‚ºæ•…éšœè€Œ errorã€‚\nkube-state-metrics é è¨­çš„è¼¸å‡ºæ ¼å¼æ˜¯ plaintextï¼Œç›´æ¥ç¬¦åˆ Prometheus client endpoint çš„æ ¼å¼\nDeployment å¦‚æœä¾ç…§ç¬¬ä¸€ç¯‡å®‰è£ prometheus helm çš„æ­¥é©Ÿï¼Œç¾åœ¨æ‡‰è©²å·²ç¶“å®‰è£å®Œ kube-state-metrics äº†ã€‚å¦‚æœæ²’æœ‰å®‰è£ï¼Œä¹Ÿå¯ä»¥ä¾ç…§å®˜æ–¹èªªæ˜çš„åŸºæœ¬ç¯„ä¾‹å®‰è£ã€‚\ngit clone git@github.com:kubernetes/kube-state-metrics.git cd kube-state-metrics kubectl apply -f examples/standard/*.yaml å®‰è£å®Œå¯ä»¥çœ‹åˆ°\n$ kubectl get pods --selector \u0026#39;app=prometheus,component=kube-state-metrics\u0026#39; NAME READY STATUS RESTARTS AGE prometheus-kube-state-metrics-85f6d75f8b-7vlkp 1/1 Running 0 201d $ kubectl get svc --selector \u0026#39;app=prometheus,component=kube-state-metrics\u0026#39; NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE prometheus-kube-state-metrics ClusterIP None \u0026lt;none\u0026gt; 80/TCP 201d æˆ‘å€‘å¯ä»¥é€é service æ‰“åˆ° pod çš„ /metrics ä¾†å–å¾— metricsã€‚\nkubectl exec -it busybox sh curl prometheus-kube-state-metrics:8080 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Kube Metrics Server\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Kube Metrics\u0026lt;/h1\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#39;/metrics\u0026#39;\u0026gt;metrics\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#39;/healthz\u0026#39;\u0026gt;healthz\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; curl prometheus-kube-state-metrics:8081 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Kube-State-Metrics Metrics Server\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Kube-State-Metrics Metrics\u0026lt;/h1\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt; \u0026lt;a href=\u0026#39;/metrics\u0026#39;\u0026gt;metrics\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; é€™é‚Šæœ‰å…©å¥— metricsï¼Œä¸€å€‹æ˜¯ kube-state-metrics è‡ªå·±è‡ªæˆ‘ç›£æ¸¬çš„ metricsï¼Œåœ¨ 8081ï¼Œå¦å¤–ä¸€å€‹æ‰æ˜¯ kube metricsï¼Œåœ¨ 8080ï¼Œå…©å€‹éƒ½è¦æ”¶ï¼Œè¨˜å¾—ä¸è¦æ”¶éŒ¯äº†ã€‚\n$ curl prometheus-kube-state-metrics:8080/metrics æ‰“ä¸‹å»å°±å¯ä»¥çœ‹åˆ°è¶…å¤š metrics ã€‚ Metrics çš„æ¸…å–®èˆ‡èªªæ˜æ–‡ä»¶ï¼Œæœ‰ç”¨åˆ°çš„ metrics ä½¿ç”¨å‰éƒ½å¯ä»¥ä¾†æŸ¥ä¸€ä¸‹å®šç¾©è§£é‡‹ã€‚\nç†è«–ä¸Šä¸ç”¨æ¯å€‹ metrics éƒ½ expose å‡ºä¾†ï¼Œæœ‰éœ€è¦å¯ä»¥æŠŠä¸æœƒç”¨åˆ°çš„ metrics é—œä¸€é—œï¼Œå¯ä»¥ç¯€çœ kube-state-metrics çš„ cpu æ¶ˆè€—ã€‚\nResource Recommendation kube-state-metrics å¾ˆè²¼å¿ƒçš„é‚„é™„ä¸Šå»ºè­°çš„è³‡æºåˆ†é…\nAs a general rule, you should allocate 200MiB memory 0.1 cores For clusters of more than 100 nodes, allocate at least 2MiB memory per node 0.001 cores per node Scaling kube-state-metrics é‚„æœ‰æä¾› horizontal scaling çš„è§£æ±ºæ–¹æ¡ˆï¼Œå¦‚æœä½ çš„é›†ç¾¤å¾ˆå¤§ï¼Œnode æ•¸é‡å·²ç¶“è®“ kube-state-metrics ç„¡æ³•è² è·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ sharding çš„æ©Ÿåˆ¶ï¼ŒæŠŠ metrics çš„å·¥ä½œæ•£å¸ƒåˆ°å¤šå€‹ kube-state-metricsï¼Œå†è®“ prometheus å»æ”¶é›†çµ±æ•´ã€‚é€™éƒ¨åˆ†æˆ‘è¦ºå¾—å¾ˆæœ‰è¶£ï¼Œä½†é‚„æ²’å¯¦ä½œéï¼Œæˆ‘æŠŠæ–‡ä»¶ æ”¾åœ¨é€™é‚Šï¼Œæœ‰ç·£å¤§å¾·æœ‰æ™‚åšéè«‹ä¾†è¨è«–åˆ†äº«ã€‚\nDashboard metrics æŠ“å‡ºä¾†ï¼Œç•¶ç„¶è¦é–‹ä¸€ä¸‹ dashboardï¼Œé€™é‚Šä½¿ç”¨çš„æ˜¯é€™å€‹kubernetes clusterï¼Œæ”¯æ´\nnode exporter kube state metrics nginx ingress controller ä¸‰å€‹é¡˜æœ›ä¸€æ¬¡æ»¿è¶³~\nå°çµ è·‘ kubernetes å‹™å¿…ä½¿ç”¨é€™å…©å€‹ exporter kube-state-metrics æ•´ç†å¾—å¾ˆèˆ’æœï¼Œæœ‰æ™‚é–“å¯ä»¥å¤šçœ‹çœ‹é€™å€‹å°ˆæ¡ˆ ","date":1570407130,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"d8e25e9e10d1154a1f430d9d6d39f376","permalink":"https://chechia.net/zh-hant/post/2019-10-07-prometheus-kube-state-metrics-exporter/","publishdate":"2019-10-07T08:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-07-prometheus-kube-state-metrics-exporter/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026 exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","prometheus","ithome"],"title":"Prometheus \u0026 Kubernetes State Metrics Exporter","type":"post"},{"authors":[],"categories":["kubernetes","prometheus"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Exporter å·¥ä½œåŸç†ç°¡ä»‹ Prometheus exporter library Exporter workflow ä¸Šæ¬¡è¬›åˆ° exporter å¯ä»¥å¾æœå‹™ç«¯æŠŠé‹è¡Œè³‡æ–™æŠ½å‡ºä¾†ï¼Œä¸¦é–‹æˆ http endpointï¼Œè®“ prometheus ä¾† scrape metricsã€‚é‚£ exporter æœ¬èº«æ˜¯å¦‚ä½•å–å¾—æœå‹™å…§éƒ¨çš„ metrics å‘¢? æˆ‘å€‘ä»Šå¤©å°±ç¨å¾®çœ‹ä¸€ä¸‹ã€‚\nRedis Exporter æˆ‘å€‘ä»Šå¤©ä»¥ Redis Exporter ç‚ºä¾‹ï¼Œç ”ç©¶ä¸€ä¸‹å¤–éƒ¨çš„ exporter æ˜¯å¦‚ä½•å–å¾— redis å…§éƒ¨çš„ metrcsã€‚\nRedis exporter æ˜¯ç”¨ golang å¯«çš„ä¸€å€‹å°ç¨‹å¼ï¼Œç¸½å…±ç®—ç®—æ‰ 1000 è¡Œï¼Œè€Œä¸”å¾ˆå¤šéƒ½æ˜¯å° redis å…§éƒ¨ metrics çš„æ¸…å–®ï¼Œä»¥åŠè½‰åŒ–æˆ prometheus metrics çš„ tool functionsï¼Œä¸»è¦çš„é‚è¼¯éå¸¸ç°¡å–®ã€‚æˆ‘å€‘ç°¡å–®çœ‹ä¸€ä¸‹æºç¢¼ã€‚\nCollect æ˜¯ä¸»è¦çš„æ”¶é›†é‚è¼¯ï¼Œå°±æ˜¯åŸ·è¡Œ scrapeRedisHost(ch) ï¼Œç„¶å¾ŒæŠŠæ”¶é›†åˆ°çš„è³‡è¨Šï¼Œä½¿ç”¨ Prometheus Go Client Library çš„å·¥å…·å°‡è³‡æ–™è¨»å†Šæˆ prometheus metrics\nfunc (e *Exporter) Collect(ch chan\u0026lt;- prometheus.Metric) { e.Lock() defer e.Unlock() e.totalScrapes.Inc() if e.redisAddr != \u0026#34;\u0026#34; { start := time.Now().UnixNano() var up float64 = 1 // å¾ host scrape è³‡æ–™ï¼Œç„¶å¾Œå¡é€² channel streaming å‡ºä¾†ã€‚ if err := e.scrapeRedisHost(ch); err != nil { up = 0 e.registerConstMetricGauge(ch, \u0026#34;exporter_last_scrape_error\u0026#34;, 1.0, fmt.Sprintf(\u0026#34;%s\u0026#34;, err)) } else { e.registerConstMetricGauge(ch, \u0026#34;exporter_last_scrape_error\u0026#34;, 0, \u0026#34;\u0026#34;) } e.registerConstMetricGauge(ch, \u0026#34;up\u0026#34;, up) e.registerConstMetricGauge(ch, \u0026#34;exporter_last_scrape_duration_seconds\u0026#34;, float64(time.Now().UnixNano()-start)/1000000000) } ch \u0026lt;- e.totalScrapes ch \u0026lt;- e.scrapeDuration ch \u0026lt;- e.targetScrapeRequestErrors } scrapeRedisHost å…§éƒ¨çš„ä¸»è¦é‚è¼¯ï¼Œåˆé›†ä¸­åœ¨åŸ·è¡Œ Info\n// åŸ·è¡Œ info infoAll, err := redis.String(doRedisCmd(c, \u0026#34;INFO\u0026#34;, \u0026#34;ALL\u0026#34;)) if err != nil { infoAll, err = redis.String(doRedisCmd(c, \u0026#34;INFO\u0026#34;)) if err != nil { log.Errorf(\u0026#34;Redis INFO err: %s\u0026#34;, err) return err } } ä¹Ÿå°±æ˜¯èªªç•¶æˆ‘å€‘åœ¨ redis-cli é€£å…¥ redis æ™‚ï¼Œå¯ä»¥åŸ·è¡Œ Info commandï¼Œå–å¾— redis å…§éƒ¨çš„è³‡è¨Šï¼ŒåŒ…å«ç¯€é»è¨­åº—èˆ‡ç‹€æ…‹ï¼Œé›†ç¾¤è¨­å®šï¼Œè³‡æ–™çš„çµ±è¨ˆæ•¸æ“šç­‰ç­‰ã€‚ç„¶å¾Œ exporter é€™é‚Šç¶­è­·æŒçºŒå»å‘ redis æ›´æ–° info ï¼Œä¸¦ä¸”æŠŠ info data è½‰åŒ–æˆ time series çš„ metrcsï¼Œå†é€é Prometheus Client promhttp æä¾›çš„ http endpoint libraryï¼Œè®Šæˆ http endpointã€‚\né¦–å…ˆçœ‹ä¸€ä¸‹ redis info command çš„æ–‡ä»¶ï¼Œé€™é‚Šæœ‰èªªæ˜ info çš„ option ï¼Œä»¥åŠ option å„è‡ªæä¾›çš„è³‡æ–™ï¼ŒåŒ…æ‹¬ server ç‹€æ…‹ï¼Œè³€æˆ¶ç«¯é€£ç·šç‹€æ³ï¼Œç³»çµ±è³‡æºï¼Œè¤‡æœ¬ç‹€æ…‹ç­‰ç­‰ã€‚æˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªå·±é€é info å–å¾—è³‡æ–™ã€‚\n$ kubectl get po | grep redis redis-2-redis-ha-server-0 3/3 Running 0 11d redis-2-redis-ha-server-1 3/3 Running 0 11d redis-2-redis-ha-server-2 3/3 Running 0 11d $ kubectl exec -it redis-2-redis-ha-server-0 sh $ redis-cli -h haproxy-service -a REDIS_PASSWORD $ haproxy-service:6379\u0026gt; $ haproxy-service:6379\u0026gt; info server # Server redis_version:5.0.5 redis_git_sha1:00000000 redis_git_dirty:0 redis_build_id:4d072dc1c62d5672 redis_mode:standalone os:Linux 4.14.127+ x86_64 arch_bits:64 multiplexing_api:epoll atomicvar_api:atomic-builtin gcc_version:8.3.0 process_id:1 run_id:63a97460b7c3745577931dad406df9609c4e2464 tcp_port:6379 uptime_in_seconds:976082 uptime_in_days:11 ... $ haproxy-service:6379\u0026gt; info clients # Clients connected_clients:100 client_recent_max_input_buffer:2 client_recent_max_output_buffer:0 blocked_clients:1 Redis exporter æ”¶é›†é€™äº›æ•¸æ“šï¼Œé€é prometheus client library æŠŠè³‡æ–™è½‰æˆ time series prometheus metricsã€‚ç„¶å¾Œé€é library æ”¾åœ¨ http enpoint ä¸Šã€‚\né…åˆä¸Šæ¬¡èªªéçš„ redis overview dashboardï¼Œå¯ä»¥ç›´æ¥åœ¨ Grafana ä¸Šä½¿ç”¨\né€™é‚Š dashboard é¡¯ç¤ºå¹¾å€‹é‡è¦çš„ metrics\nUptime Memory Usageï¼Œè¦è¨­å®šç”¨é‡å¤ªé«˜è‡ªå‹•å ±è­¦ Command çš„åŸ·è¡Œç‹€æ³ï¼Œå›æ‡‰æ™‚é–“ è¨Šæ¯çš„æµé‡ï¼Œä»¥åŠè¶…å‡º time-to-live çš„è³‡æ–™æ¸…é™¤ã€‚ éƒ½æ˜¯éœ€è¦å¥½å¥½åŠ ä¸Š alert çš„æ ¸å¿ƒ metrics\nè²¢ç» exporter å…¶ä»–æœå‹™çš„ exporter å·¥ä½œåŸç†ä¹Ÿç›¸ä¼¼ï¼Œå¦‚æœæœå‹™æœ¬èº«æœ‰å…§éƒ¨çš„ metricsï¼Œå¯ä»¥é€é client command æˆ–æ˜¯ API å–å¾—ï¼Œexporter çš„å·¥ä½œå°±åªæ˜¯è½‰æˆ time series dataã€‚\nå¦‚æœæœ‰æ¯”è¼ƒç‰¹æ®Šçš„ metrics æ²’æœ‰åŒ¯å‡ºï¼Œä¾‹å¦‚èªªè‡ªå®¶çš„ metrics ï¼Œä½†åˆå¸Œæœ›èƒ½æ”¾åˆ° prometheus ä¸Šç›£æ¸¬ï¼Œä¾‹å¦‚æ¯ç§’æ”¶åˆ°å¤šå°‘ request countï¼Œå›æ‡‰é€Ÿåº¦ï¼ŒéŒ¯èª¤è¨Šæ¯çš„çµ±è¨ˆâ€¦â€¦ç­‰ï¼Œé€™é»ä¹Ÿå¯ä»¥ä½¿ç”¨ client library è‡ªå¹¹ exporter ç„¶å¾Œ expose http endpointï¼Œé€™æ¨£åœ¨ prometheus ä¸Šä¹Ÿå¯ä»¥çœ‹åˆ°è‡ªå®¶ç”¢å“çš„ metricsï¼Œéå¸¸å¥½ç”¨ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘ä¾†èŠè‡ªå¹¹ exporterã€‚\n","date":1570320730,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"c7e19dd63fb38046554d73d7fedb225a","permalink":"https://chechia.net/zh-hant/post/2019-10-06-prometheus-exporter-library-redis-exporter/","publishdate":"2019-10-06T08:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-06-prometheus-exporter-library-redis-exporter/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026 exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","prometheus","ithome"],"title":"Prometheus Exporter Library \u0026 Redis Exporter","type":"post"},{"authors":[],"categories":["kubernetes","prometheus"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Prometheus Introduction Deploy Prometheus Prometheus Introduction ç”Ÿç”¢ç’°å¢ƒèˆ‡éç”Ÿç”¢ç’°å¢ƒï¼Œå…¶ä¸­çš„ä¸€æŒ‡æ¨™å°±æ˜¯æœ‰æ²’æœ‰è¶³å¤ å®Œæ•´çš„æœå‹™ç›£æ¸¬ç³»çµ±ï¼Œé€™å¥è©±å¯ä»¥çœ‹å‡ºæœå‹™ç›£æ¸¬å°æ–¼ç”¢å“åŒ–æ˜¯å¤šéº¼é‡è¦ã€‚è€Œç›£æ§è³‡æ–™ (metrics) çš„æ”¶é›†èˆ‡å¯è¦–åŒ–å·¥å…·å…¶å¯¦éå¸¸å¤šï¼Œä¾‹å¦‚ä¸Šå‘¨ä»‹ç´¹çš„ ELK Stackï¼Œé€™æ¬¡æˆ‘å€‘è¦ä¾†ä»‹ç´¹å¦å¤–ä¸€å€‹å¾ˆå¤šäººä½¿ç”¨çš„ prometheusã€‚\nPromethues åœ¨å®˜ç¶²ä¸Šæåˆ° æ˜¯ä¸€å€‹ Monitoring system and time series database\nå¯ä»¥æ”¶é›†é«˜ç¶­åº¦çš„è³‡æ–™ ä½¿ç”¨è‡ªå·±çš„ PromQL åšæœ‰æ•ˆä¸”ç²¾ç°¡çš„è³‡æ–™æŸ¥è©¢ å…§å»ºè³‡æ–™ç€è¦½å™¨ï¼Œä¸¦ä¸”èˆ‡ Grafana é«˜åº¦æ•´åˆ æ”¯æ´ sharding èˆ‡ federationï¼Œä¾†é”åˆ°æ°´å¹³æ“´å±• æœ‰è¨±å¤šéš¨æ’å³ç”¨çš„æ•´åˆ exporterï¼Œä¾‹å¦‚ redis-exporter, kafka-exporterï¼Œkubernetes-exporter ï¼Œéƒ½å¯ä»¥ç›´æ¥å–å¾—è³‡æ–™ æ”¯æ´ alertï¼Œä½¿ç”¨ PromQL ä»¥åŠå¤šåŠŸèƒ½çš„å‘Šè­¦ï¼Œå¯ä»¥è¨­å®šç²¾æº–çš„å‘Šè­¦æ¢ä»¶ èˆ‡ ELK åšæ¯”è¼ƒ åŸºæœ¬ä¸Š Prometheus è·Ÿ ELK æ¯”ï¼Œå…¶å¯¦æ˜¯å¾ˆå¥‡æ€ªçš„ä¸€ä»¶äº‹ï¼Œä½†é€™ä¹Ÿæ˜¯æœ€å¸¸è¢«å•çš„ä¸€å€‹å•é¡Œã€‚å…©è€…åœ¨æœ¬è³ªä¸Šæ˜¯å®Œå…¨ä¸åŒçš„ç³»çµ±ã€‚\nPrometheus æ˜¯ based on time series database çš„è³‡æ–™æ”¶é›†ç³»çµ± ELK æ˜¯åŸºæ–¼å…¨æ–‡æœç´¢å¼•æ“çš„è³‡æ–™æŸ¥è©¢ç³»çµ± æ˜¯çš„ï¼Œä»–å€‘éƒ½èƒ½åš metrics æ”¶é›†ï¼Œåœ¨æœ‰é™çš„å°ºåº¦ä¸‹ï¼Œèƒ½é”åˆ°ä¸€æ¨£çš„æ•ˆæœã€‚ä½†é€™æ¨£èªªçš„æ„æ€å°±ç­‰æ–¼æ˜¯åœ¨èªª mesos DC/OS èˆ‡ kubenetes éƒ½èƒ½è·‘ container cluster ä¸€æ¨£ï¼Œåº•ä¸‹æ˜¯å®Œå…¨ä¸ä¸€æ¨£çš„æ±è¥¿ã€‚\nå…©è€…çš„å·®ç•°ä½¿ç”¨ä¸Šå·®éå¸¸å¤š\nmetrics çµæ§‹: ELK å€ŸåŠ©å…¨æ–‡æœç´¢å¼•æ“ï¼ŒåŸºæœ¬ä¸Šé€ä»€éº¼è³‡æ–™è¿‘ä¾†éƒ½å¯ä»¥æŸ¥æ‰¾ã€‚Prometheus metrics æ‹‰é€²ä¾†æ˜¯ time series çš„ key-value pairsã€‚ ç¶­è­·åŒæ¨£çš„ metricsï¼Œprometheus çš„ä½¿ç”¨çš„å„²å­˜ç©ºé–“é å°æ–¼ elasticsearch prometheus é‡å° time based çš„æœå°‹åšäº†å¾ˆå¤šå„ªåŒ–ï¼Œæ•ˆèƒ½å¾ˆé«˜ Prometheus å°æ–¼è¨˜æ†¶é«”èˆ‡ cpu çš„æ¶ˆè€—ä¹Ÿå°‘å¾ˆå¤š Elasticsearch è³‡æºä¸Šå¾ˆè²´ï¼Œæ˜¯å› ç‚ºåœ¨è™•ç†å¤§é‡ text log çš„æ™‚å€™ï¼Œä»–èƒ½å¤ ç”¨å¾Œæ®µçš„ pipeline è™•ç†å…§å®¹ï¼Œå†é€²è¡Œäº¤å‰æ¯”å°ï¼Œå¯ä»¥å¾ text è£¡é¢æå–å¾ˆå¤šæœªäº‹å…ˆå®šç¾©çš„è³‡æ–™ Elasticsearch çš„ç¶­è­·å·¥ä½œä¹Ÿæ¯”è¼ƒè¤‡é›œå›°é›£ å¦‚æœè¦æ”¶é›†æœå‹™é‹è¡Œè³‡æ–™ï¼Œå¯ä»¥ç›´æ¥é¸ prometheusã€‚å¦‚æœæœ‰æ”¶é›† log é€²è¡Œäº¤å‰æ¯”å°ï¼Œå¯ä»¥è€ƒæ…® elkã€‚\nHelm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼Œä¹‹æ‰€ä»¥ç”¨ helm ï¼Œå› ç‚ºé€™æ˜¯æˆ‘æƒ³åˆ°æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œèƒ½è®“è¼•é¬†æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´çš„ prometheusã€‚æ‰€ä»¥æˆ‘å€‘å…ˆç”¨ã€‚\næ²’ç”¨é helm çš„å¤§å¾·å¯ä»¥åƒè€ƒ Helm Quickstartï¼Œå…ˆæŠŠ helm cli èˆ‡ kubernetes ä¸Šçš„ helm tiller éƒ½è¨­å®šå¥½\nDeploy Prometheus æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½æ”¾åœ¨é€™äº†https://github.com/chechiachang/prometheus-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash HELM_NAME=prometheus-1 helm upgrade --install ${HELM_NAME} stable/prometheus \\ --namespace default \\ --values values-staging.yaml Configuration Prometheus Stable Chart\nvalues.yaml å¾ˆé•·ï¼Œä½†å…¶å¯¦å„å€‹å…ƒä»¶è¨­å®šæ˜¯é‡è¤‡çš„,è¨­å®šå¥½å„è‡ªçš„ image, replicas, service, topology ç­‰ç­‰\nalertmanager: enabled: true kubeStateMetrics: enabled: true nodeExporter: enabled: true server: enabled: true pushgateway: enabled: true åº•ä¸‹æœ‰æ›´å¤š runtime çš„è¨­å®šæª”\nå®šç¾©å¥½ global çš„ scrape é–“è·ï¼Œè¶ŠçŸ­ metrics ç¶­åº¦å°±è¶Šç²¾æº– PersistenVolume å¼·è¬å»ºè­°é–‹èµ·ä¾†ï¼Œç¶­æŒæ­·å²çš„è³‡æ–™ åŠ ä¸Š storage usage çš„ self monitoringï¼ˆä¹‹å¾Œæœƒè¬›) æ‰ä¸æœƒæ»¿å‡ºä¾† server æ›æ‰ server çš„ scrapeConfigs æ˜¯ server å»æ”¶é›†çš„ job è¨­å®šã€‚ç¨å¾Œå†ä¾†ç´°è¬›ã€‚ server: global: ## How frequently to scrape targets by default ## scrape_interval: 10s ## How long until a scrape request times out ## scrape_timeout: 10s ## How frequently to evaluate rules ## evaluation_interval: 10s persistentVolume: ## If true, Prometheus server will create/use a Persistent Volume Claim ## If false, use emptyDir ## enabled: true ## Prometheus server data Persistent Volume access modes ## Must match those of existing PV or dynamic provisioner ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/ ## accessModes: - ReadWriteOnce ## Prometheus server data Persistent Volume annotations ## annotations: {} ## Prometheus server data Persistent Volume existing claim name ## Requires server.persistentVolume.enabled: true ## If defined, PVC must be created manually before volume will be bound existingClaim: \u0026#34;\u0026#34; ## Prometheus server data Persistent Volume mount root path ## mountPath: /data ## Prometheus server data Persistent Volume size ## size: 80Gi alertmanagerFiles: serverFiles: éƒ¨å±¬å®Œçœ‹ä¸€ä¸‹\nkubectl get pods --selector=\u0026#39;app=prometheus\u0026#39; NAME READY STATUS RESTARTS AGE prometheus-alertmanager-694d6694c6-dvkwd 2/2 Running 0 8d prometheus-kube-state-metrics-85f6d75f8b-7vlkp 1/1 Running 0 8d prometheus-node-exporter-2mpjc 1/1 Running 0 8d prometheus-node-exporter-kg7fj 1/1 Running 0 51d prometheus-node-exporter-snnn5 1/1 Running 0 8d prometheus-pushgateway-5cdfb4979c-dnmjn 1/1 Running 0 8d prometheus-server-59b8b8ccb4-bplkx 2/2 Running 0 8d kubectl get services --selector=\u0026#39;app=prometheus\u0026#39; NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE prometheus-alertmanager ClusterIP 10.15.241.66 \u0026lt;none\u0026gt; 80/TCP 197d prometheus-kube-state-metrics ClusterIP None \u0026lt;none\u0026gt; 80/TCP 197d prometheus-node-exporter ClusterIP None \u0026lt;none\u0026gt; 9100/TCP 197d prometheus-pushgateway ClusterIP 10.15.254.0 \u0026lt;none\u0026gt; 9091/TCP 197d prometheus-server ClusterIP 10.15.245.10 \u0026lt;none\u0026gt; 80/TCP 197d kubectl get endpoints --selector=\u0026#39;app=prometheus\u0026#39; NAME ENDPOINTS AGE prometheus-alertmanager 10.12.6.220:9093 197d prometheus-kube-state-metrics 10.12.6.222:8080 197d prometheus-node-exporter 10.140.0.30:9100,10.140.0.9:9100,10.140.15.212:9100 197d prometheus-pushgateway 10.12.6.211:9091 197d prometheus-server 10.12.3.14:9090 197d ç°¡å–®èªªæ˜ä¸€ä¸‹\nprometheus-server æ˜¯ä¸»è¦çš„ api-server ä»¥åŠ time series database alertmanager è² è²¬å‘Šè­¦å·¥ä½œ pushgateway æä¾› client ç«¯ä¸»å‹•æ¨é€ metrics çµ¦ server çš„ endpoint kube-state-metrics æ˜¯é–‹ä¾†æ”¶é›† cluster wide çš„ metrics, åƒæ˜¯ pods running counts, deployment ready count, total pods number ç­‰ç­‰ metrics node-exporter æ˜¯ daemonsets, æŠŠæ¯ä¸€å€‹ node çš„ metrics, åƒæ˜¯ memory, cpu, diskâ€¦ç­‰è³‡æ–™,æ”¶é›†å‡ºä¾† ä¸»è¦æœå‹™å­˜å–å°±æ˜¯é€é prometheus-server\nAccess Prometheus server â€¦","date":1570176730,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"6a855918d449bd83b2812d9ad1b3bb83","permalink":"https://chechia.net/zh-hant/post/2019-10-04-prometheus-deployment-on-kubernetes/","publishdate":"2019-10-04T16:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-04-prometheus-deployment-on-kubernetes/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026 exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","prometheus","ithome"],"title":"Prometheus Deployment on Kubernetes","type":"post"},{"authors":[],"categories":["kubernetes","prometheus"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Grafana Introduction Deploy Grafana Grafana Introduction ä¸Šåæˆ‘å€‘ç°¡å–®ä»‹ç´¹äº† Prometheusï¼Œprometheus çš„ Web Portol å·²ç¶“é™„ä¸Šç°¡å–®çš„ Query èˆ‡ Graph å·¥å…·ï¼Œä½†ä¸€èˆ¬æˆ‘å€‘åœ¨ä½¿ç”¨æ™‚ï¼Œé‚„æ˜¯æœƒæ­é… Grafana ä¾†ä½¿ç”¨ã€‚\nGrafana åœ¨å®˜ç¶²ä¸Šæåˆ° æ˜¯ä¸€å€‹ Analytics systemï¼Œå¯ä»¥å”åŠ©äº†è§£é‹è¡Œè³‡æ–™ï¼Œå»ºç«‹å®Œæ•´çš„ dashboardã€‚\næ”¯æ´è¨±å¤šåœ–è¡¨ï¼Œç›´ç·šåœ–ï¼Œé•·æ¢åœ–ï¼Œå€åŸŸåˆ†æï¼ŒåŸºæœ¬ä¸Šéœ€è¦çš„éƒ½æœ‰ åœ¨åœ–è¡¨ä¸Šå®šç¾© alterï¼Œä¸¦ä¸”ä¸»å‹•å‘Šè­¦ï¼Œæ•´åˆå…¶ä»–é€šè¨Šè»Ÿé«” å°å¾Œç«¯ data source çš„æ•´åˆï¼Œå¯ä»¥åŒæ™‚ä½¿ç”¨ ELK, prometheus, influxdb ç­‰ 30 å¤šç¨®çš„è³‡æ–™ä¾†æº æœ‰è¨±å¤šå…¬é–‹çš„ plugin èˆ‡ dashboard å¯ä»¥åŒ¯å…¥ä½¿ç”¨ ç¸½ä¹‹åŠŸèƒ½å¼·å¤§ï¼Œè‡³æ–¼ç”¨èµ·ä¾†çš„æ„Ÿè¦ºï¼Œå€‹äººæ˜¯éå¸¸æ¨è–¦ã€‚å¦‚æœæœ‰å¤§å¾—æƒ³è¦è©¦ç©çœ‹çœ‹ï¼Œå¯ä»¥ç›´æ¥åˆ° Grafana Live Demo ä¸Šé¢è©¦ç©\nä¸€èˆ¬ä½¿ç”¨éƒ½æœƒåœç¹ dashboard ç‚ºæ ¸å¿ƒï¼Œé€éå–®ä¸€ç•«é¢ï¼Œä¸€è¦½ç›®å‰ä½¿ç”¨è€…éœ€è¦è®€å–çš„è³‡æ–™ å·¦ä¸Šè§’çš„ä¸‹æ‹‰é¸å–®ï¼Œå¯ä»¥é¸æ“‡ä¸åŒçš„ dashboards èˆ‡ Kibana åšæ¯”è¼ƒ é›–ç„¶å¤§éƒ¨åˆ†ä½¿ç”¨ä¸Šï¼Œæˆ‘å€‘éƒ½æœƒä½¿ç”¨ ELK ä¸€å¥—ï¼Œè€Œ Prometheus + Grafana å¦ä¸€å¥—ã€‚ä½†å…¶å¯¦å…©é‚Šçš„ data source éƒ½å¯ä»¥äº’æ¥ã€‚ä¾‹å¦‚ grafana å¯ä»¥åƒ elasticsearch çš„ data sourceï¼Œè€Œ kibana æœ‰ prometheus moduleã€‚\næˆ‘å€‘é€™é‚ŠåŸºæ–¼å…©æ¬¾å‰ç«¯åˆ†æå·¥å…·ï¼Œç¨å¾®åšå€‹æ¯”è¼ƒï¼Œåº•å±¤çš„ data source å·®ç•°é€™é‚Šå…ˆä¸æã€‚\néƒ½æ˜¯é–‹æº: å…©è€…çš„é–‹æºç¤¾ç¾¤éƒ½éå¸¸å¼·å¤§ å…©è€…å…§å»ºçš„ dashboard éƒ½éå¸¸å®Œæ•´ï¼Œè€Œä¸”ä¸æ–·æ¨å‡ºæ–°åŠŸèƒ½ Log vs Metrics: Kibana çš„ metrics ä¹Ÿæ˜¯åƒ log ä¸€æ¨£çš„ key value pairsï¼Œèƒ½å¤  explore æœªå®šç¾©çš„ log Grafana çš„ UI å°ˆæ³¨æ–¼å‘ˆç¾ time series çš„ metricsï¼Œä¸¦æ²’æœ‰æä¾› data çš„æ¬„ä½æœå°‹ï¼Œè€Œæ˜¯ä½¿ç”¨èªæ³• Query ä¾†å–å¾—æ•¸æ“š Data source: Grafana å¯ä»¥æ”¶é›†å„ç¨®ä¸åŒçš„å¾Œç«¯è³‡æ–™ä¾†æº ELK ä¸»è¦æ ¸å¿ƒé‚„æ˜¯ ELK stackï¼Œç”¨å…¶ä»– Module è¼”åŠ©å…¶ä»–è³‡æ–™æº Deploy Grafana æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½æ”¾åœ¨é€™äº†https://github.com/chechiachang/prometheus-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncd grafana cat install.sh #!/bin/bash HELM_NAME=grafana-1 helm upgrade --install grafana stable/grafana \\ --namespace default \\ --values values-staging.yaml Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼ŒGrafana Stable Chart\nConfiguration ç°¡å–®çœ‹ä¸€ä¸‹è¨­å®šæª”\nvim values-staging.yaml replicas: 1 deploymentStrategy: RollingUpdate Grafana æ˜¯æ”¯æ´ Grafana HA ï¼Œå…¶å¯¦ä¹Ÿéå¸¸ç°¡å–®ï¼Œå°±æ˜¯æŠŠ grafana æœ¬èº«çš„ dashboard database å¾æ¯å€‹ grafana ä¸€å° SQLiteï¼Œè®Šæˆå¤–éƒ¨çµ±ä¸€çš„ MySQLï¼Œçµ±ä¸€è®€å–å¾Œç«¯è³‡æ–™ï¼Œå‰ç«¯å°±å¯æ°´å¹³æ“´å±•ã€‚\nreadinessProbe: httpGet: path: /api/health port: 3000 livenessProbe: httpGet: path: /api/health port: 3000 initialDelaySeconds: 60 timeoutSeconds: 30 failureThreshold: 10 image: repository: grafana/grafana tag: 6.0.0 pullPolicy: IfNotPresent ## Optionally specify an array of imagePullSecrets. ## Secrets must be manually created in the namespace. ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/ ## # pullSecrets: # - myRegistrKeySecretName ä¸€äº› Pod çš„åŸºæœ¬é…ç½®ï¼Œ health check ä½¿ç”¨å…§å»ºçš„ apiï¼Œæœ‰éœ€è¦ä¹Ÿå¯ä»¥ç›´æ¥æ‰“ api\nsecurityContext: runAsUser: 472 fsGroup: 472 extraConfigmapMounts: [] # - name: certs-configmap # mountPath: /etc/grafana/ssl/ # configMap: certs-configmap # readOnly: true æœ‰è¦é–‹å¤–éƒ¨ ingressï¼Œéœ€è¦ ssl çš„è©±å¯ä»¥å¾é€™é‚Šæ›é€²å»\n## Expose the grafana service to be accessed from outside the cluster (LoadBalancer service). ## or access it from within the cluster (ClusterIP service). Set the service type and the port to serve it. ## ref: http://kubernetes.io/docs/user-guide/services/ ## service: type: LoadBalancer port: 80 targetPort: 3000 # targetPort: 4181 To be used with a proxy extraContainer annotations: {} labels: {} ingress: enabled: false annotations: {} # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \u0026#34;true\u0026#34; labels: {} path: / hosts: - chart-example.local tls: [] # - secretName: chart-example-tls # hosts: # - chart-example.local é€™é‚Šå¯ä»¥é–‹ service load balancer, ä»¥åŠ ingressï¼Œçœ‹å¯¦éš›ä½¿ç”¨çš„éœ€æ±‚\npersistence: enabled: true initChownData: true # storageClassName: default accessModes: - ReadWriteOnce size: 10Gi # annotations: {} # subPath: \u0026#34;\u0026#34; # existingClaim: Persistent Volume ä½œç‚ºæœ¬åœ°å„²å­˜å»ºè­°éƒ½é–‹èµ·ä¾†ï¼Œ\n# Administrator credentials when not using an existing secret (see below) adminUser: admin # adminPassword: strongpassword # Use an existing secret for the admin user. admin: existingSecret: \u0026#34;\u0026#34; userKey: admin-user passwordKey: admin-password å¸³è™Ÿå¯†ç¢¼å»ºè­°ä½¿ç”¨ secret æ›é€²å»\ndatasources: {} # datasources.yaml: # apiVersion: 1 # datasources: # - name: Prometheus # type: prometheus # url: http://prometheus-prometheus-server # access: proxy # isDefault: true ## Configure grafana dashboard providers ## ref: http://docs.grafana.org/administration/provisioning/#dashboards ## ## `path` must be /var/lib/grafana/dashboards/\u0026lt;provider_name\u0026gt; ## dashboardProviders: {} # dashboardproviders.yaml: # apiVersion: 1 # providers: # - name: \u0026#39;default\u0026#39; # orgId: 1 # folder: \u0026#39;\u0026#39; # type: file # disableDeletion: false # editable: true # options: # path: /var/lib/grafana/dashboards/default ## Configure grafana dashboard to import ## NOTE: To use dashboards you must also enable/configure dashboardProviders ## ref: https://grafana.com/dashboards ## ## dashboards per provider, use provider name as key. ## dashboards: {} # default: # some-dashboard: # json: | # $RAW_JSON # custom-dashboard: # file: dashboards/custom-dashboard.json # prometheus-stats: # gnetId: 2 # revision: 2 # datasource: Prometheus # local-dashboard: # url: https://example.com/repository/test.json # local-dashboard-base64: # url: https://example.com/repository/test-b64.json # b64content: true Data source, Dashboard æƒ³è¦ç›´æ¥è¼‰å…¥ï¼Œå¯ä»¥åœ¨é€™é‚Šè¨­å®šï¼Œæˆ–æ˜¯ grafana èµ·ä¾†å¾Œï¼Œé€é Web UI é€²å»æ–° â€¦","date":1570147930,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"893ce8522120c565ca2b72e3e5c01d89","permalink":"https://chechia.net/zh-hant/post/2019-10-04-prometheus-deploy-grafana/","publishdate":"2019-10-04T08:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-04-prometheus-deploy-grafana/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026 exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","prometheus","ithome"],"title":"Prometheus Deploy Grafana","type":"post"},{"authors":[],"categories":["kubernetes","prometheus"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Prometheus scrape scrape_configs Node exporter Scrape Prometheus æ”¶é›† metrics çš„æ–¹å¼ï¼Œæ˜¯å¾è¢«ç›£æ¸¬çš„ç›®æ¨™çš„ http endpoints æ”¶é›† (scrape) metricsï¼Œç›®æ¨™æœå‹™æœ‰æä¾› export metrics çš„ endpoint çš„è©±ï¼Œç¨±ä½œ exporterã€‚ä¾‹å¦‚ kafka-exporter å°±æœƒæ”¶é›† kafka é‹è¡Œçš„ metricsï¼Œè®Šæˆ http endpoint instanceï¼Œprometheus å¾ instance ä¸Šé¢æ”¶é›†è³‡æ–™ã€‚\nPromethesu è‡ªå·±ä¹Ÿæ˜¯ä¹Ÿæä¾› metrics endpointï¼Œä¸¦ä¸”è‡ªå·±é€é scrape è‡ªå·±çš„ metrics endpoint ä¾†å–å¾— self-monitoring çš„ metricsã€‚æŠŠè‡ªå·±ç•¶ä½œå¤–éƒ¨æœå‹™ç›£æ¸¬ã€‚ä¸‹é¢çš„è¨­å®šå°±æ˜¯ç›´æ¥é€é http://localhost:9090/metrics å–å¾—ã€‚\nglobal: scrape_interval: 15s # By default, scrape targets every 15 seconds. # Attach these labels to any time series or alerts when communicating with # external systems (federation, remote storage, Alertmanager). external_labels: monitor: \u0026#39;codelab-monitor\u0026#39; # A scrape configuration containing exactly one endpoint to scrape: # Here it\u0026#39;s Prometheus itself. scrape_configs: # The job name is added as a label `job=\u0026lt;job_name\u0026gt;` to any timeseries scraped from this config. - job_name: \u0026#39;prometheus\u0026#39; # Override the global default and scrape targets from this job every 5 seconds. scrape_interval: 5s static_configs: - targets: [\u0026#39;localhost:9090\u0026#39;] é€é Grafana -\u0026gt; explore å°±å¯ä»¥çœ‹åˆ° Prometheus çš„ metrics\nè€Œä½¿ç”¨ metrics æ™‚æœ€å¥½å…ˆæŸ¥åˆ°èªªæ˜æ–‡ä»¶ï¼Œç¢ºå®š metrics çš„å®šç¾©èˆ‡è¨ˆç®—æ–¹æ³•ï¼Œæ‰å¯ä»¥æœ‰æ•ˆçš„è£½åœ–ã€‚é—œæ–¼ Prometheus Exporter çš„ metrics èªªæ˜ å¯ä»¥åˆ°é€™è£¡ä¾†æ‰¾ã€‚\nDashboard æ”¶é›†åˆ° metrics ä¹‹å¾Œå°±å¯ä»¥åœ¨ prometheus ä¸­ queryï¼Œä½†ä¸€èˆ¬ä½¿ç”¨ä¸æœƒä¸€ç›´è·‘é€²ä¾†ä¸‹ queryï¼Œè€Œæ˜¯æœƒç›´æ¥æ­é… dashboard è£½åœ–å‘ˆç¾ï¼Œè®“è³‡æ–™ä¸€è¦½ç„¡éºã€‚\nä¾‹å¦‚ prometheus è‡ªèº«çš„ metrics ä¹Ÿå·²ç¶“æœ‰æ­é…å¥½çš„ Prometheus overview dashboard å¯ä»¥ä½¿ç”¨ã€‚\nä½¿ç”¨æ–¹æ³•éå¸¸ç°¡å–®ï¼Œç›´æ¥é€é Grafana import dashboardï¼Œè£¡é¢å°±æŠŠé‡è¦çš„ prometheus metrics éƒ½æ”¾åœ¨ dashboard ä¸Šäº†ã€‚ä¸èƒ½æ›´æ–¹ä¾¿äº†ã€‚\nExporters Prometheus æ”¯æ´è¶…ç´šå¤š exporterï¼ŒåŒ…å« prometheus è‡ªèº«ç›´æ¥ç¶­è­·çš„ exporterï¼Œé‚„æœ‰éå¸¸å¤šå¤–éƒ¨æœå‹™å‹ä¹Ÿé–‹æºçš„ exporter å¯ä»¥ä½¿ç”¨ï¼Œæ¸…å–®å¯ä»¥åˆ°é€™è£¡çœ‹\næœ‰å¸Œæœ›è‡ªå·±å…¬å¸çš„æœå‹™ï¼Œä¹Ÿä½¿ç”¨ prometheus\nNode Exporter prometheus/node_exporter æ˜¯ Prometheus ç›´æ¥ç¶­è­·çš„ projectï¼Œä¸»è¦ç”¨é€”å°±æ˜¯å°‡ node / vm çš„é‹è¡Œ metrics export å‡ºä¾†ã€‚æœ‰é»é¡ä¼¼ ELK çš„ metricbeatã€‚\næˆ‘å€‘é€™é‚Šæ˜¯åœ¨ kubernetes ä¸ŠåŸ·è¡Œï¼Œæ‰€ä»¥ç›´æ¥åšæˆ daemonsets åœ¨ k8s ä¸Šè·‘ï¼Œéƒ¨å±¬æ–¹é¢åœ¨ deploy prometheus-server çš„ helm chart ä¸­ï¼Œå°±å·²ç¶“é™„å¸¶æ•´åˆï¼Œéƒ¨å±¬åˆ°æ¯ä¸€å° node ä¸Šã€‚\nå¦‚æœæ˜¯åœ¨ kubernetes å¤–çš„ç’°å¢ƒï¼Œä¾‹å¦‚èªª on premise serverï¼Œæˆ–æ˜¯ gcp instanceï¼Œå¸Œæœ›è‡ªå·±éƒ¨å±¬ node exporter çš„è©±ï¼Œå¯ä»¥åƒè€ƒé€™ç¯‡æ•™å­¸æ–‡ç« ã€‚\næˆ‘å€‘é€™é‚Šå¯ä»¥çœ‹ä¸€ä¸‹ configï¼Œä»¥åŠ job å®šç¾©ã€‚\nvim values-staging.yaml # Enable nodeExporter nodeExporter: create: true prometheus.yml: rule_files: - /etc/config/rules - /etc/config/alerts scrape_configs: # Add kubernetes node job - job_name: \u0026#39;kubernetes-nodes\u0026#39; # Default to scraping over https. If required, just disable this or change to # `http`. scheme: https # This TLS \u0026amp; bearer token file config is used to connect to the actual scrape # endpoints for cluster components. This is separate to discovery auth # configuration because discovery \u0026amp; scraping are two separate concerns in # Prometheus. The discovery auth config is automatic if Prometheus runs inside # the cluster. Otherwise, more config options have to be provided within the # \u0026lt;kubernetes_sd_config\u0026gt;. tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt # If your node certificates are self-signed or use a different CA to the # master CA, then disable certificate verification below. Note that # certificate verification is an integral part of a secure infrastructure # so this should only be disabled in a controlled environment. You can # disable certificate verification by uncommenting the line below. # insecure_skip_verify: true bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token kubernetes_sd_configs: - role: node relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/$1/proxy/metrics kubernetes_sd_config: å¯ä»¥é€é kubernetes API ä¾†å–å¾— scrape targetï¼Œä»¥é€™é‚Šçš„è¨­å®šï¼Œæ˜¯ä½¿ç”¨ node role å»é›†ç¾¤å–å¾— nodeï¼Œä¸¦ä¸”æ¯ä¸€å° node éƒ½ç•¶æˆä¸€å€‹ targetï¼Œé€™æ¨£å°±ä¸ç”¨æŠŠæ‰€æœ‰ node éƒ½æ‰‹å‹•åŠ åˆ° job çš„ instance list è£¡é¢ã€‚\nå¾ node role å–å¾—çš„ instance æœƒä½¿ç”¨ ip æ¨™è¨»æˆ–æ˜¯ hostname æ¨™è¨»ã€‚node role æœ‰æä¾› node ç¯„åœçš„ meta labelsï¼Œä¾‹å¦‚ __meta_kubernetes_node_name, _meta_kubernetes_node_address ç­‰ç­‰ï¼Œæ–¹ä¾¿æŸ¥æ‰¾æ•´ç†è³‡æ–™ã€‚\nrelabel_configs: é‡å°è³‡æ–™åšé¡å¤–æ¨™è¨˜ï¼Œæ–¹ä¾¿ä¹‹å¾Œåœ¨ grafana ä¸Šé¢ä¾æ“šéœ€æ±‚ queryã€‚\n","date":1570147930,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"09c8d9480383bba47799390a35fc2665","permalink":"https://chechia.net/zh-hant/post/2019-10-04-prometheus-scrape/","publishdate":"2019-10-04T08:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-04-prometheus-scrape/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026 exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","prometheus","ithome"],"title":"Prometheus Scrape","type":"post"},{"authors":[],"categories":["kubernetes","redis"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Failure Case Recovery Topology ä¸Šç¯‡çš„ä¾‹å­å®Œæˆæ‡‰è©²æ˜¯é€™æ¨£\n+-------+ +--------+ +------------+ +---------+ |Clients|---|HAProxys|----|redis master|----|sentinels| +-------+ +--------+ +------------+ +---------+ HAproxy ä½œç‚ºå¾Œç«¯ redis çš„ gateway Client é€é HAproxy é€£å…¥ redis master sentinel è² è²¬ç›£æ¸¬ redis ç‹€æ…‹èˆ‡ failoverï¼Œåªæ˜¯ client ä¸å†é€é sentinel å»å–å¾— masterï¼Œè€Œæ˜¯é€é HAProxyã€‚ é‚£ç¾åœ¨å°±ä¾†èŠèŠé€™äº›æœå‹™å¯èƒ½æ€éº¼æ­»çš„ï¼Œå›å¾©çš„æ©Ÿåˆ¶åˆæ˜¯å¦‚ä½•\nFailure Recovery Redis master æ•…éšœ é€™å€‹æ˜¯ç›®å‰æˆ‘å€‘é€™å€‹ Redis HAProxy é…ç½®ä¸»è¦æƒ³è§£æ±ºçš„å•é¡Œï¼Œæ•…éšœèˆ‡å›è¦†çš„æµç¨‹å¤§æ¦‚æ˜¯é€™æ¨£\nRedis Master failing Sentinels detect master failure sentinel ç­‰å¾… down-after-millisecondsï¼Œè¶…éæ‰åˆ¤å®š master failure sentinel å½¼æ­¤å–å¾— quorumï¼Œæˆæ¬Šå…¶ä¸­ä¸€å° sentinel åŸ·è¡Œ failover sentinel æŒ‡æ´¾æ–°çš„ master master æ•…éšœåŒæ™‚ï¼ŒHAProxy ä¹Ÿåµæ¸¬ master failure HAProxy ç™¼ç¾æ²’æœ‰å¯ç”¨çš„ master tcp checklist å†æ¬¡åŸ·è¡Œæ™‚ï¼Œç”±æ–¼æ–°çš„ master å°šæœªé¸å‡ºä¾†ï¼Œä»æœƒé¡¯ç¤ºä¸‰å° server éƒ½é›¢ç·š ç›´åˆ° master é¸å‡ºï¼Œrole:master çš„ tcp check æœ‰å›æ‡‰å¾Œï¼Œæ‰æœƒå°‡å¾Œç«¯æ¥åˆ°æ–°çš„ master Client ç”±æ–¼ HAProxy æ²’æœ‰å¯ç”¨çš„ masterï¼Œæ‰€ä»¥é€£ç·šæ–·æ‰ æŒçºŒä¸­æ–·åˆ° HAProxy å›å¾© é€™é‚Šçš„å¹¾å€‹é‡è¦çš„åƒæ•¸\nsentinel\ndown-after-milliseconds: æ–·ç·šå¤šä¹…æ‰æœƒè¦ºå¾— master æ­»äº†éœ€è¦ failoverï¼Œå¯ä»¥ç›¡é‡ç¸®çŸ­ï¼ŒåŠ é€Ÿ failure ç™¼ç”Ÿ failover çš„æ™‚é–“ haproxy.cfg\nserver check inter 1s: å¤šä¹…è·‘ä¸€æ¬¡ tcp-check è¶ŠçŸ­ï¼Œä¾¿èƒ½è¶Šæ—©æ¥å—åˆ° redis instance failure çš„ç™¼ç”Ÿ å¾é€™å€‹ä¾‹å­ä¾†çœ‹ï¼Œé€™å€‹é…ç½®çš„ HA å…¶å¯¦é‚„æ˜¯æœ‰é›¢ç·šæ™‚é–“\ndown-after-milliseconds è¨­å®šç‚º 2s ï¼Œé‚£å¾ failure ç™¼ç”Ÿï¼Œåˆ° sentinel é–‹å§‹ failover çš„æ™‚é–“å°±æœƒè¶…é 2sï¼Œé€™å…©ç§’å®¢æˆ¶ç«¯ç„¡æ³•å¯«å…¥ã€‚ äº‹å¯¦ä¸Šï¼Œé€™ä¹Ÿæ˜¯ redis master-slave çš„æ¨¡å¼çš„å•é¡Œï¼Œä¸¦ç„¡æ³•ç¢ºä¿ zero downtime èƒ½åšåˆ°çš„æ˜¯ç§’ç´šçš„ auto-recovery Sentinel Failure é€™å€‹æ˜¯å¾ˆå¥½è§£æ±ºçš„éŒ¯èª¤ï¼Œå¦‚åŒæˆ‘å€‘åœ¨ topology é€™ç¯‡æåˆ°çš„ï¼ŒåŸå‰‡ä¸Šåªè¦èƒ½ç¶­æŒ quorum ä»¥ä¸Šçš„ sentinel æ­£å¸¸é‹ä½œï¼Œå°±å¯ä»¥å®¹å¿å¤šå€‹ sentinel çš„éŒ¯èª¤\nä¾‹å¦‚ 5 sentinelï¼Œquorum 3ï¼Œå°±å¯ä»¥å…è¨±å…©å€‹ sentinel éŒ¯èª¤ æœå‹™éƒ½æ­£å¸¸ zero downtime ç­‰å¾…éŒ¯èª¤çš„ sentinels å¾©åŸ éŒ¯èª¤ä¸ä¸€å®šæ˜¯å…©å€‹ sentinel æ­»äº†ï¼Œå¯èƒ½æ˜¯ç¶²è·¯æ–·é–‹ï¼ŒæŠŠ 3 sentinels èˆ‡ 2 sentinels éš”é–‹ï¼Œç„¡æ³•æºé€šã€‚ é€™æ™‚ä¹Ÿä¸ç”¨æœƒæœ‰è¤‡æ•¸ failover ç”¢ç”Ÿï¼Œå› ç‚º quorum åªæœ‰ 3 sentinels çš„é€™ç«¯å¯ä»¥å–å¾—æˆæ¬Šï¼Œæ­£å¸¸åŸ·è¡Œ failover 2 sentinels çš„é€™é‚Šåªæœƒéœå¾…ç¶²è·¯å›å¾©ã€‚ HAProxy Failure é€™å€‹åœ¨ kubernetes ä¸Šä¹Ÿæ˜¯å¾ˆå¥½è§£æ±º\nHAProxy ä¸ç”¨çŸ¥é“å½¼æ­¤ï¼Œåªè¦èƒ½å¤ ç›£æ¸¬å¾Œç«¯æœå‹™ï¼Œä¸¦ä¸” proxy request å³å¯\næˆ‘å€‘å•Ÿå‹• HAProxy æ™‚æœƒä¸€æ¬¡å•Ÿå‹•å¤šå€‹ HAProxy\nHAProxy æ˜¯ç„¡ç‹€æ…‹çš„æœå‹™ï¼Œå¯ä»¥ç›´æ¥æ°´å¹³æ“´å±• (Horizontal Scale) ç®—æ˜¯æˆæœ¬çš„åœ°æ–¹ï¼Œå°±æ˜¯ HAProxy instance æœƒå„è‡ªå°å¾Œç«¯ redis åš tcp-checkï¼Œé »ç¹çš„ checkï¼Œé‚„æ˜¯æœƒæœ‰æˆæœ¬ï¼Œä½†ç›¸è¼ƒæ–¼ client request æ‡‰è©²æ˜¯æ¯”è¼ƒè¼• HAProxy æ˜¯é«˜æ•ˆèƒ½ï¼Œè€Œä¸”åªåš proxyï¼Œä¸€å¥”ä¾†èªªåªè¦ç¶­æŒæœ‰å¤šé¤˜çš„å‰¯æœ¬å‚™ç”¨å³å¯ï¼Œä¸ç”¨é–‹å¤ªå¤š Kubernetes æœƒè‡ªå‹•é€é stats portï¼Œå° HAPRoxy åš liveness checkï¼Œcheck å¤±æ•—å°±ä¸æœƒæŠŠæµé‡å°è¿‘ä¾†\nHAproxy å‰ç«¯çš„ kubernetes service æœƒè‡ªå‹• load balance client åˆ°æ­£å¸¸é‹ä½œçš„ HAProxy ä¸Š\nä¾‹å¦‚èµ·äº† 3 HAProxy\n3 HAProxy éƒ½å„è‡ªå‘ redis instance åš tcp-checkï¼Œæ¯ç§’ 3 * 3 çµ„ check\nå®¢æˆ¶ç«¯é€£å…¥ä»»ä¸€ HAProxyï¼Œéƒ½å¯ä»¥é€£å…¥æ­£ç¢ºçš„ master\nHAProxy åªè¦è‡³å°‘æœ‰ä¸€å€‹æ´»è‘—å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ­» 2 å€‹\nKubernetes service æœƒè‡ªå‹•å°å‘æ´»è‘—çš„ HAProxy\n2 HAPRoxy å›å¾©çš„æ™‚å€™ï¼Œå°±æ˜¯ HAProxy é‡å•Ÿå¾Œé‡æ–°é–‹å§‹æœå‹™\næ‹†åˆ† read write client ç”±æ–¼æ•ˆèƒ½ç“¶é ¸é‚„æ˜¯åœ¨ redis masterï¼Œç‚ºäº†èƒ½æ”¯æ’å¤ å¤š clientï¼Œæœ€å¥½æŠŠ client éœ€è¦è®€å¯«çš„æ‹†åˆ†é–‹ä¾†\nHAProxy çš„è¨­å®šï¼Œå°±æœƒéœ€è¦\næŠŠ frontend redis_gate æ‹†æˆ redis_slaves_gate: æ¥æ”¶è®€å–çš„ client redis_master_gate: æ¥æ”¶å¯«å…¥çš„ client æŠŠ redis_servers æ‹†æˆ redis_slaves: æ›´æ”¹ tcp-check å»æ‰¾ role:slave çš„ redisï¼Œæ‡‰è©²æœ‰å…©å° redis_master: ç¶­æŒæ‰¾å°‹ role:master çš„ redis é€™æ¨£å¯ä»¥è¼•æ˜“åœ°é€é scale slave ä¾†æ“´å¤§è®€å–çš„æµé‡å¸¶å¯¬\nRedis Cluster Intro çš„æ™‚å€™æœ‰æåˆ°ï¼Œredis cluster æ˜¯å¦ä¸€å€‹é¢å‘çš„ redis solutionã€‚\nä½¿ç”¨ redis cluster å°‡è³‡æ–™åš shardingï¼Œåˆ†æ•£åˆ°ä¸åŒç¾¤çµ„å…§ï¼Œpartitions ç”±è¤‡æ•¸çš„ master ä¾†å­˜å–\né€™éƒ¨ä»½æˆ‘å€‘ä¸‹å›å¾…çºŒ\n","date":1570090330,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"d1cd8f8440fcc4c1aa9d65d519bcfca8","permalink":"https://chechia.net/zh-hant/post/2019-10-03-redis-ha-failure-recovery/","publishdate":"2019-10-03T16:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-03-redis-ha-failure-recovery/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","redis","ithome"],"title":"Redis Ha Failure Recovery","type":"post"},{"authors":[],"categories":["kubernetes","redis"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ HAProxy Introduction Redis Sentinel with HAProxy HAProxy Intro HAproxy å…¨åæ˜¯ High Availability Proxyï¼Œæ˜¯ä¸€æ¬¾é–‹æº TCP/HTTP load balancerï¼Œä»–å¯ä»¥\nè½ tcp socketï¼Œé€£ serverï¼Œç„¶å¾ŒæŠŠ socket æ¥åœ¨ä¸€èµ·è®“é›™å‘æµé€š å¯åš Http reverse-proxy (Http gateway)ï¼Œè‡ªå·±ä½œç‚ºä»£ç† serverï¼ŒæŠŠæ¥å—åˆ°çš„ connection å‚³åˆ°å¾Œç«¯çš„ serverã€‚ SSL çµ‚ç«¯ï¼Œå¯æ”¯æ´ client-side èˆ‡ server-side çš„ ssl/tls ç•¶ tcp/http normalizer æ›´æ”¹ http çš„ request èˆ‡ response ç•¶ switchï¼Œæ±ºå®š request å¾Œé€çš„ç›®æ¨™ åš load balancerï¼Œç‚ºå¾Œç«¯ server åšè² è¼‰å‡è¡¡ èª¿ç¯€æµé‡ï¼Œè¨­å®š rate limitï¼Œæˆ–æ˜¯æ ¹æ“šå…§å®¹èª¿æ•´æµé‡ HAProxy é‚„æœ‰å…¶ä»–éå¸¸å¤šçš„åŠŸèƒ½ï¼Œæƒ³äº†è§£ç´°ç¯€å¯ä»¥ä¾†çœ‹åŸç†è§£èªªæ–‡ä»¶\nTopology æˆ‘å€‘ä»Šå¤©çš„ç¯„ä¾‹æ˜¯åœ¨å¾Œç«¯çš„ redis èˆ‡ clients ä¸­é–“å¤šæ”¾ä¸€å±¤ HAProxys\n+-------+ +--------+ +------------+ +---------+ |Clients|---|HAProxys|----|redis master|----|sentinels| +-------+ +--------+ +------------+ +---------+ å¯èƒ½æœ‰äººæœƒå•èªªï¼Œé‚£å‰å…©å¤©è¬›çš„ redis sentinelï¼Œè·‘å»å“ªè£¡äº†ã€‚\nsentinel é‚„åœ¨æ­£å¸¸é‹ä½œï¼Œè² è²¬ç›£æ¸¬ redis ç‹€æ…‹èˆ‡ failoverï¼Œåªæ˜¯ client ä¸å†é€é sentinel å»å–å¾— masterï¼Œè€Œæ˜¯é€é HAProxyã€‚\nDeploy HAProxy æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½åœ¨é€™äº†https://github.com/chechiachang/haproxy-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash # redis-db-credentials should already exists #kubectl create secret generic redis-db-credentials \\ --from-literal=REDIS_PASSWORD=123456 # Update haproxy.cfg as configmap kubectl create configmap haproxy-config \\ --from-file=haproxy.cfg \\ --output yaml \\ --dry-run | kubectl apply -f - kubectl apply -f deployment.yaml kubectl apply -f service.yaml é€™é‚Šåšçš„äº‹æƒ…æœ‰å¹¾ä»¶\nå–å¾— redis çš„ auth REDIS_PASSWORD æ”¾åœ¨ secret ä¸­ï¼Œå¦‚æœå‰é¢æ˜¯ç…§æˆ‘å€‘çš„ç¯„ä¾‹ï¼Œé‚£éƒ½å·²ç¶“è¨­å®šäº† æŠŠ haproxy.cfg çš„è¨­å®šæª”ï¼Œä½¿ç”¨ configmap çš„æ–¹å¼æ”¾åˆ° kubernetes ä¸Š éƒ¨å±¬ HAProxy deployment éƒ¨å±¬ HAProxy service ç°¡å–®çœ‹ä¸€ä¸‹ deployment\napiVersion: apps/v1beta1 kind: Deployment metadata: name: haproxy spec: replicas: 3 template: metadata: labels: app: haproxy app.kubernetes.io/name: haproxy component: haproxy spec: volumes: - name: haproxy-config configMap: name: haproxy-config affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: \u0026#34;app\u0026#34; operator: \u0026#34;In\u0026#34; values: - \u0026#34;haproxy\u0026#34; topologyKey: kubernetes.io/hostname containers: - name: haproxy image: haproxy:2.0.3-alpine command: [\u0026#34;haproxy\u0026#34;, \u0026#34;-f\u0026#34;, \u0026#34;/usr/local/etc/haproxy/config/haproxy.cfg\u0026#34;] readinessProbe: initialDelaySeconds: 15 periodSeconds: 5 timeoutSeconds: 1 successThreshold: 2 failureThreshold: 2 tcpSocket: port: 26999 port: 6379 volumeMounts: - name: haproxy-config mountPath: /usr/local/etc/haproxy/config resources: requests: cpu: 10m memory: 30Mi env: - name: REDIS_PASSWORD valueFrom: secretKeyRef: name: redis-db-credentials key: REDIS_PASSWORD ports: - containerPort: 8000 name: http - containerPort: 9000 name: https - containerPort: 26999 name: stats - containerPort: 6379 name: redis Replicas: 3 ï¼Œé–‹èµ·ä¾†æ˜¯ä¸‰å€‹ HAProxy podAntiAffinityï¼Œä¸‰å€‹åˆ†å¸ƒåˆ°ä¸åŒ node ä¸Šï¼Œç›¡é‡ç¶­æŒ HA readinessProbeï¼Œç­‰ tcpSocket 26999 (HAProxy Stats) èˆ‡ 6370 (Redis Proxy) é€šäº†æ‰ READY æŠŠ redis password æ›é€²å» æŠŠ haproxy.cfg æ›é€²å» é–‹å¹¾å€‹ port çœ‹ä¸€ä¸‹ service\nkind: Service apiVersion: v1 metadata: name: haproxy-service spec: sessionAffinity: ClientIP sessionAffinityConfig: clientIP: timeoutSeconds: 10800 # 3 hr selector: app: haproxy ports: - name: http protocol: TCP port: 8000 - name: https protocol: TCP port: 9000 - name: stats protocol: TCP port: 26999 - name: redis protocol: TCP port: 6379 - name: redis-exporter protocol: TCP port: 8404 å¾ˆå–®ç´”ï¼Œå°±æ˜¯æŠŠå¹¾å€‹ port æ¥å‡ºä¾† æŠŠ sessionAffinity é–‹èµ·ä¾† é€™é‚Šå¸Œæœ›ä¾†è‡ªç›¸åŒ clientIP (kubernetes å…§éƒ¨ app clients) çš„ session èƒ½æŒçºŒèµ°åŒä¸€å€‹ server å¯ä»¥é™ä½é€²åˆ° service å¾€å¾Œé€åˆ°ä¸€ç›´é‡é€£æµªè²»è³‡æº ä½†ä¸€ç›´é€£è‘—ä¹Ÿä¸å¥½ï¼Œå¯èƒ½æœƒ connection not closed ä¸€ç›´ä½”è‘— HAProxy1 HAProxy2 HAProxy3ï¼Œä¸Šæ¬¡ Client1 é€£ HAProxy1ï¼Œservice ä¹Ÿç›¡é‡è®“ä½ ä¸‹å€‹ request ä¹Ÿèµ° HAPRoxy1 kubectl get po | grep haproxy haproxy-56d94f857f-gmd4s 1/1 Running 0 47d haproxy-56d94f857f-p2vj6 1/1 Running 0 47d haproxy-56d94f857f-vhz8b 1/1 Running 0 47d HAProxy Config çœ‹ä¸€ä¸‹ haproxy.cfg\n# https://cbonte.github.io/haproxy-dconv/2.0/configuration.html # https://github.com/prometheus/haproxy_exporter # https://www.haproxy.com/blog/haproxy-exposes-a-prometheus-metrics-endpoint/ # curl http://localhost:8404/metrics # curl http://localhost:8404/stats frontend stats mode http timeout client 30s bind *:8404 option http-use-htx http-request use-service prometheus-exporter if { path /metrics } stats enable stats uri /stats stats refresh 10s # Redis frontend redis_gate mode tcp timeout client 7d bind 0.0.0.0:6379 name redis default_backend redis_servers backend redis_servers mode tcp timeout connect 3s timeout server 7d option tcp-check tcp-check connect tcp-check send AUTH\\ \u0026#34;${REDIS_PASSWORD}\u0026#34;\\r\\n tcp-check send PING\\r\\n tcp-check expect string PONG tcp-check send info\\ replication\\r\\n tcp-check expect string role:master tcp-check send QUIT\\r\\n tcp-check expect string +OK server R1 redis-2-redis-ha-announce-0:6379 check inter 1s server R2 â€¦","date":1570003930,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"f57b941b25bb6869ae3ceddbc24237e0","permalink":"https://chechia.net/zh-hant/post/2019-10-02-redis-ha-on-haproxy/","publishdate":"2019-10-02T16:12:10+08:00","relpermalink":"/zh-hant/post/2019-10-02-redis-ha-on-haproxy/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","redis","ithome","haproxy"],"title":"Redis Ha HAProxy","type":"post"},{"authors":[],"categories":["kubernetes","redis"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Redis Sentinel Topology Topology Masters: M1, M2, M3, â€¦, Mn. Slaves: R1, R2, R3, â€¦, Rn (R stands for replica). Sentinels: S1, S2, S3, â€¦, Sn. Clients: C1, C2, C3, â€¦, Cn. æ¯å€‹æ–¹æ ¼ä»£è¡¨ä¸€å°æ©Ÿå™¨æˆ–æ˜¯ VM 2 Sentinels DONâ€™T DO THIS\n+----+ +----+ | M1 |---------| R1 | | S1 | | S2 | +----+ +----+ Configuration: quorum = 1 é€™å€‹è¨­å®šä¸‹ï¼Œå¦‚æœ M1 æ›äº†éœ€è¦ failoverï¼Œå¾ˆæœ‰å¯èƒ½ S1 è·Ÿè‘—æ©Ÿå™¨ä¸€èµ·æ›äº†ï¼ŒS2 æœƒæ²’æœ‰è¾¦æ³•å–å¾—å¤šæ•¸ä¾†åŸ·è¡Œ failoverï¼Œæ•´å€‹ç³»çµ±æ›æ‰\n3 VM +----+ | M1 | | S1 | +----+ | +----+ | +----+ | R2 |----+----| R3 | | S2 | | S3 | +----+ +----+ Configuration: quorum = 2 é€™æ˜¯æœ€åŸºæœ¬çš„è›‹åˆå…¼é¡§å®‰å…¨è¨­å®šçš„è¨­ç½®\nå¦‚æœ M1 æ­»äº† S1 è·Ÿè‘—æ©Ÿå™¨æ•…éšœï¼ŒS2 èˆ‡ S3 é‚„å¯ä»¥å–å¾—å¤šæ•¸ï¼Œé †åˆ© failover åˆ° R2 æˆ–æ˜¯ R3ã€‚\nå¯«å…¥è³‡æ–™éºå¤± +----+ | M1 | | S1 | \u0026lt;- C1 (writes will be lost) +----+ | / / +------+ | +----+ | [M2] |----+----| R3 | | S2 | | S3 | +------+ +----+ failover ä¹‹å‰ï¼ŒM1 æ˜¯ masterï¼ŒClient çš„å¯«å…¥å¾€ M1 å¯« M1 ç¶²è·¯æ•…éšœï¼ŒM2 failover å¾Œæˆç‚ºæ–°çš„ masterï¼Œå¯æ˜¯ Client å¾€ M1 å¯«å…¥çš„è³‡æ–™ä¸¦ç„¡æ³• sync å› M2 ç­‰ç¶²è·¯ä¿®å¾©å¾Œï¼ŒM1 å›è¦†å¾Œæœƒè®Šæˆ R1 è®Šæˆ slaveï¼Œç”± M2 å» sync R1ï¼Œè®Šæˆ R1 åœ¨ master æ™‚æ”¶åˆ°çš„å¯«å…¥è³‡æ–™éºå¤± ç‚ºäº†é¿å…é€™ç¨®æƒ…å½¢ï¼Œåšé¡å¤–çš„è¨­å®š\nmin-slaves-to-write 1 min-slaves-max-lag 10 ç•¶ master ç™¼ç¾è‡ªå·±å†ä¹Ÿç„¡æ³• sync åˆ°è¶³å¤ çš„ slaveï¼Œè¡¨ç¤º master å¯èƒ½è¢«å­¤ç«‹ï¼Œé€™æ™‚ä¸»å‹•æ‹’çµ•å®¢æˆ¶ç«¯çš„å¯«å…¥è«‹æ±‚ã€‚å®¢æˆ¶ç«¯è¢«æ‹’çµ•å¾Œï¼Œæœƒå†å‘ sentinel å–å¾—æœ‰æ•ˆçš„ masterï¼Œé‡æ–°åŸ·è¡Œå¯«å…¥è«‹æ±‚ï¼Œç¢ºä¿è³‡æ–™å¯«åˆ°æœ‰æ•ˆçš„ master ä¸Šã€‚\nSentinel æ”¾åœ¨ Client ç«¯ +----+ +----+ | M1 |----+----| R1 | | | | | | +----+ | +----+ | +------------+------------+ | | | | | | +----+ +----+ +----+ | C1 | | C2 | | C3 | | S1 | | S2 | | S3 | +----+ +----+ +----+ æœ‰äº›æƒ…å½¢ï¼Œredis é€™ç«¯åªæœ‰å…©å°å¯ç”¨æ©Ÿå™¨ï¼Œé€™ç¨®æƒ…å½¢å¯ä»¥è€ƒæ…®æŠŠ sentinel æ”¾åœ¨å®¢æˆ¶ç«¯çš„æ©Ÿå™¨ä¸Š\nä»ç„¶ç¶­æŒäº†ç¨ç«‹çš„ 3 sentinels çš„ç©©å®š sentinel èˆ‡ client æ‰€è§€å¯Ÿåˆ°çš„ redis ç‹€æ…‹æ˜¯ç›¸åŒçš„ å¦‚æœ M1 æ­»äº†ï¼Œè¦ failover ï¼Œå®¢æˆ¶ç«¯çš„ 3 sentinel å¯ä»¥æ­£ç¢ºåœ°åŸ·è¡Œ failoverï¼Œä¸å—æ•…éšœå½±éŸ¿ å®¢æˆ¶ç«¯åˆä¸è¶³ 3 å€‹ +----+ +----+ | M1 |----+----| R1 | | S1 | | | S2 | +----+ | +----+ | +------+-----+ | | | | +----+ +----+ | C1 | | C2 | | S3 | | S4 | +----+ +----+ Configuration: quorum = 3 +----+ +----+ | M1 |----+----| R1 | | S1 | | | S2 | +----+ | +----+ | | | +----+ | C1 | | S3 | +----+ Configuration: quorum = 2 è·Ÿä¸Šå€‹ä¾‹å­é¡ä¼¼ï¼Œä½†åˆé¡å¤–ç¢ºä¿ 3 sentinels å¦‚æœ M1 æ­»äº†ï¼Œå‰©ä¸‹çš„ sentinel å¯ä»¥æ­£ç¢º failover ","date":1569831130,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"c9d2f08bd3e3201f8b6d1b428ffbdb59","permalink":"https://chechia.net/zh-hant/post/2019-09-30-redis-ha-topology/","publishdate":"2019-09-30T16:12:10+08:00","relpermalink":"/zh-hant/post/2019-09-30-redis-ha-topology/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","redis","ithome","haproxy"],"title":"Redis Ha Topology","type":"post"},{"authors":[],"categories":["kubernetes","redis"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ redis-sentinel redis sentinel èˆ‡ redis ä½¿ç”¨ç›¸å®¹çš„ apiï¼Œç›´æ¥ä½¿ç”¨ redis-cli é€é 26479 port é€£å…¥ï¼Œå¯ä»¥é€£åˆ° sentinelï¼Œé€é sentinel å¯ä»¥å–å¾— redis master çš„ç‹€æ…‹èˆ‡é€£ç·šè¨­å®šã€‚\nredis-cli -h redis-redis-ha -p 26479 ä¸Šç¯‡æˆ‘å€‘çš„ redis-ha å®‰è£å®Œè®Šé€™æ¨£\n$ kubectl get po | grep redis NAME READY STATUS RESTARTS AGE redis-1-redis-ha-server-0 3/3 Running 0 3d4h redis-1-redis-ha-server-1 3/3 Running 0 3d5h redis-1-redis-ha-server-2 3/3 Running 0 3d4h æœ‰ä¸‰å€‹ Podï¼Œè£¡é¢éƒ½æ˜¯ä¸€å€‹ redis, sentinel, è·Ÿ exporterï¼Œé€™ç¯‡æ–‡ç« æœƒå°ˆæ³¨è¬› sentinel çš„åŠŸèƒ½èˆ‡æ©Ÿåˆ¶\nRedis Sentinel redis-sentinel ç‚º Redis æä¾›é«˜å¯ç”¨æœå‹™ï¼Œå¯¦å‹™ä¸Šå¯ä»¥é€é sentinel åœ¨éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œè‡ªå‹•é€²è¡Œ failoverã€‚é™¤æ­¤ä¹‹å¤– sentinel ä¹Ÿæä¾›ç›£æ¸¬ï¼Œé€šçŸ¥ï¼Œèˆ‡ redis çš„è¨­å®šã€‚\nMonitoring: æŒçºŒæª¢æ¸¬ master èˆ‡ slave instances çš„ç‹€æ…‹ Notification: æœ‰äº‹ä»¶ç™¼ç”Ÿå¯ä»¥ç™¼å‡ºé€šçŸ¥ Automatic failover: å¦‚æœ master å¤±æ•ˆè‡ªå‹•å•Ÿå‹• failover ç¨‹åºï¼Œå°‡ä¸€å€‹ slave æŒ‡æ’ç‚º masterï¼Œä¸¦è¨­å®šå…¶ä»– slave ä½¿ç”¨æ–°çš„ master Configuration provider: ç‚ºå®¢æˆ¶ç«¯æä¾› service discoveryï¼Œå®¢æˆ¶å¯ä»¥é€šé sentinel å–å¾— master çš„é€£ç·šè³‡æ–™ã€‚ Distributed Sentinel æœ¬èº«æ˜¯ä¸€å€‹åˆ†æ•£å¼ç³»çµ±ï¼Œå¦‚æˆ‘å€‘çš„ç¯„ä¾‹æ‰€ç¤ºï¼Œä¸‰å€‹ Pod ç«‹é¢å€‹å«æœ‰ä¸€å€‹ sentinelï¼Œçµ„æˆ 3 å€‹ instace çš„ sentinel clusterã€‚\néŒ¯èª¤æª¢æ¸¬æ˜¯ç”±å¤šå€‹ sentinel åˆ¤å®šï¼Œè¦æœ‰å¤šå€‹ sentinel éƒ½æ¥æ”¶ master å·²å¤±æ•ˆçš„è¨Šæ¯ï¼Œæ‰æœƒåˆ¤å®šæˆå¤±æ•ˆã€‚é€™æ¨£å¯ä»¥é™ä½ false positive çš„æ©Ÿç‡ã€‚ åˆ†æ•£è®“ sentinel æœ¬èº«ä¹Ÿå…·å‚™é«˜å¯ç”¨æ€§ï¼Œå¯ä»¥æ‰¿å—ä¸€å®šç¨‹åº¦çš„éŒ¯èª¤ã€‚ç”¨ä¾† fail over çš„ç³»çµ±ï¼Œä¸èƒ½å› ç‚ºè‡ªèº«çš„å–®é»éŒ¯èª¤(single point failure) è€Œå€’æ˜¯æ•´å€‹ redis å¤±æ•ˆã€‚ Fundamental ä¸€å€‹è€ç”¨çš„ sentinel éœ€è¦è‡³å°‘ä¸‰å€‹ instance æœ€å¥½æŠŠ instance åˆ†æ•£åœ¨å¤šå€‹ç¨ç«‹çš„éš”é›¢å€åŸŸï¼Œæ„æ€æ˜¯èªªï¼Œä¸‰å€‹ä¸æœƒæ”¾åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šï¼Œæˆ–æ˜¯æ”¾åœ¨åŒä¸€å€‹å€åŸŸå…§ï¼Œå› ç‚ºä¸€å€‹å€åŸŸç¶²è·¯æ•…éšœå°±å…¨æ­»ã€‚ app ä½¿ç”¨ sentinel çš„è©±ï¼Œå®¢æˆ¶ç«¯è¦æ”¯æ´ æœ‰æ™‚å¸¸æ¸¬è©¦çš„ HA ç’°å¢ƒï¼Œæ‰æ˜¯æœ‰æ•ˆçš„ HA Configuration Sentinel specific configuration options åœ¨ä¸Šç¯‡æˆ‘å€‘è·³é sentinel çš„è¨­å®šï¼Œé€™é‚Šèªªæ˜ä¸€ä¸‹\nsentinel: port: 26379 quorum: 2 config: ## Additional sentinel conf options can be added below. Only options that ## are expressed in the format simialar to \u0026#39;sentinel xxx mymaster xxx\u0026#39; will ## be properly templated. ## For available options see http://download.redis.io/redis-stable/sentinel.conf down-after-milliseconds: 10000 ## Failover timeout value in milliseconds failover-timeout: 180000 parallel-syncs: 5 ## Custom sentinel.conf files used to override default settings. If this file is ## specified then the sentinel.config above will be ignored. # customConfig: |- # Define configuration here resources: {} # requests: # memory: 200Mi # cpu: 100m # limits: # memory: 200Mi Quorum quorum æ˜¯æ¯æ¬¡ç¢ºå®š master å¤±æ•ˆæ™‚ï¼Œéœ€è¦é”æˆå…±è­˜çš„ sentinel æ•¸é‡ã€‚ Quorum ä½¿ç”¨åœ¨éŒ¯èª¤æª¢æ¸¬ï¼Œç¢ºå®šéŒ¯èª¤çœŸçš„ç™¼ç”Ÿå¾Œï¼Œsentinel æœƒä»¥å¤šæ•¸æ±º(majority) çš„æ–¹å¼é¸å‡º sentinel leaderï¼Œè®“ leader è™•ç† failoverã€‚ ä»¥æˆ‘å€‘çš„ä¾‹å­ç‚ºä¾‹ï¼Œç¸½å…±ä¸‰å€‹ï¼Œç¢ºèª master æ­»æ‰åªè¦å…©å€‹ sentinel é”æˆå…±è­˜å³å¯å•Ÿå‹• failover ç¨‹åºã€‚å¯ä»¥ç›´æ¥æ¸¬è©¦ä¸€ä¸‹ã€‚\nkubectl logs -f redis-1-redis-ha-server-0 kubectl delete po redis-1-redis-ha-server-1 log ä¸€å€‹ Pod ï¼Œç„¶å¾Œç›´æ¥æŠŠå¦ä¸€å€‹ Pod å¹¹æ‰ é€™æ¨£æœƒæœ‰ 1/3 çš„æ©Ÿç‡ç åˆ° masterï¼Œç ä¸­çš„è©±å¯ä»¥çœ‹åˆ° redis failover ï¼Œé¸å‡ºæ–°çš„ master çš„éç¨‹ã€‚\né€™é‚Šè¦æ³¨æ„ï¼Œç”±æ–¼æˆ‘å€‘çš„ sentinel èˆ‡ redis æ˜¯æ”¾åœ¨åŒæ¨£ä¸€å€‹ Podï¼Œå¹¹æ‰çš„åŒæ™‚ä¹Ÿæ®ºäº†ä¸€å€‹ sentinelï¼Œåªå‰© 2 å€‹ï¼Œå‰›å¥½é”æˆå…±è­˜ã€‚å¦‚æœ quorum æ˜¯ä¸‰ï¼Œå°±è¦ç­‰ç¬¬ä¸‰å€‹ sentinel å›ä¾†æ‰èƒ½å–å¾— quorumã€‚\nsentinel èˆ‡ redis çš„é…ç½®ä½ç½®ï¼Œä¹‹å¾Œçš„ topology æœƒè¨è«–ã€‚\nConfigurations down-after-milliseconds: è¶…éå¤šå°‘æ™‚é–“æ²’å›æ‡‰ ping æˆ–æ­£ç¢ºå›æ‡‰ï¼Œæ‰è¦ºå¾— master å£äº† parallel-syncs: failover æ™‚ï¼Œè¦é‡æ–°èˆ‡æ–° master sync çš„ slave æ•¸é‡ã€‚æ•¸é‡è¶Šå¤š sync æ™‚é–“å°±è¶Šä¹…ï¼Œæ•¸é‡å°‘å°±æœ‰è¼ƒå¤š slave æ²’ sync è³‡æ–™ï¼Œå¯èƒ½æœƒè®“ client read åˆ°èˆŠçš„è³‡æ–™ é›–ç„¶ sync æ˜¯ non-blockingÂ ï¼Œä½†åœ¨ sync å¤§ç­†è³‡æ–™æ™‚ï¼Œslave å¯èƒ½æœƒæ²’æœ‰å›æ‡‰ã€‚è¨­å®šç‚º 1 çš„è©±ï¼Œæœ€å¤šåªæœƒæœ‰ä¸€å€‹ slave ä¸‹ç·š syncã€‚ é€™äº›åƒæ•¸ä¹Ÿå¯ä»¥é€é redis-cli ç›´æ¥é€£å…¥æ›´æ”¹ï¼Œä½†æˆ‘å€‘æ˜¯åœ¨ kubernetes ä¸Šè·‘ï¼Œè‡¨æ™‚çš„æ›´æ”¹ä¸æ˜“ä¿å­˜ï¼Œæ‰€ä»¥ç›¡å¯èƒ½æŠŠé€™äº›configurations æ”¾åœ¨ configmap è£¡é¢ã€‚\nSentinel command 6379 port é€£å…¥ redisï¼Œ26379 é€£å…¥ redis sentinelã€‚éƒ½æ˜¯ä½¿ç”¨ redis-cliï¼Œå…©è€…å…¼å®¹çš„ protocolã€‚\n# ä½¿ç”¨ kubectl é€£å…¥ï¼Œå¤šå€‹ container è¦æ˜ç¢ºæŒ‡å‡ºé€£å…¥çš„ container kubectl exec -it redis-1-redis-ha-server-0 --container redis sh redis-cli -h redis-redis-ha -p 26479 # è¿‘ä¾†å…ˆ ping ä¸€ä¸‹ $ ping PONG # åˆ—å‡ºæ‰€æœ‰ master çš„è³‡è¨Šï¼Œä»¥åŠè¨­å®šè³‡è¨Š sentinel master redis-2-redis-ha:26379\u0026gt; sentinel masters 1) 1) \u0026#34;name\u0026#34; 2) \u0026#34;mymaster\u0026#34; 3) \u0026#34;ip\u0026#34; 4) \u0026#34;10.15.242.245\u0026#34; 5) \u0026#34;port\u0026#34; 6) \u0026#34;6379\u0026#34; 7) \u0026#34;runid\u0026#34; 8) \u0026#34;63a97460b7c3745577931dad406df9609c4e2464\u0026#34; 9) \u0026#34;flags\u0026#34; 10) \u0026#34;master\u0026#34; 11) \u0026#34;link-pending-commands\u0026#34; 12) \u0026#34;0\u0026#34; 13) \u0026#34;link-refcount\u0026#34; 14) \u0026#34;1\u0026#34; 15) \u0026#34;last-ping-sent\u0026#34; 16) \u0026#34;0\u0026#34; 17) \u0026#34;last-ok-ping-reply\u0026#34; 18) \u0026#34;479\u0026#34; 19) \u0026#34;last-ping-reply\u0026#34; 20) \u0026#34;479\u0026#34; 21) \u0026#34;down-after-milliseconds\u0026#34; 22) \u0026#34;5000\u0026#34; 23) \u0026#34;info-refresh\u0026#34; 24) \u0026#34;5756\u0026#34; 25) \u0026#34;role-reported\u0026#34; 26) \u0026#34;master\u0026#34; 27) \u0026#34;role-reported-time\u0026#34; 28) \u0026#34;348144787\u0026#34; 29) \u0026#34;config-epoch\u0026#34; 30) \u0026#34;13\u0026#34; 31) \u0026#34;num-slaves\u0026#34; 32) \u0026#34;2\u0026#34; 33) \u0026#34;num-other-sentinels\u0026#34; 34) \u0026#34;2\u0026#34; 35) \u0026#34;quorum\u0026#34; 36) \u0026#34;2\u0026#34; 37) \u0026#34;failover-timeout\u0026#34; 38) \u0026#34;180000\u0026#34; 39) \u0026#34;parallel-syncs\u0026#34; 40) \u0026#34;5\u0026#34; # å–å¾—é›†ç¾¤ä¸­çš„ master è¨Šæ¯ï¼Œç›®å‰æœ‰ä¸€å€‹ master $ sentinel master mymaster # å–å¾—é›†ç¾¤ä¸­çš„ slaves è¨Šæ¯ï¼Œç›®å‰æœ‰å…©å€‹ slave $ sentinel slaves mymaster # å–å¾—é›†ç¾¤ä¸­çš„ master è¨Šæ¯ $ sentinel sentinels mymaster # æª¢æŸ¥ sentinel çš„ quorum $ sentinel ckquorum mymaster OK 3 usable Sentinels. Quorum and failover authorization can be reached # å¼·è¿«è§¸ç™¼ä¸€æ¬¡ failover sentinel failover mymaster Sentinel Connection æœ‰æ”¯æ´çš„å®¢æˆ¶ç«¯è¨­å®šï¼Œä»¥Golang FZambia/sentinel ç‚ºä¾‹ï¼Œé€é sentinel å–å¾— redis-poolã€‚\n# ä½¿ç”¨ç¨ç«‹çš„ pod service é€£å…¥ sentinelï¼Œå”åŠ©å½¼æ­¤è­˜åˆ¥ sntnl := \u0026amp;sentinel.Sentinel{ Addrs: []string{\u0026#34;redis-2-redis-ha-announce-0:26379\u0026#34;, \u0026#34;redis-2-redis-ha-announce-0:26379\u0026#34;, \u0026#34;redis-2-redis-ha-announce-0:26379\u0026#34;}, MasterName: \u0026#34;mymaster\u0026#34;, Dial: func(addr â€¦","date":1569748478,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"5070378573f76232b91acd55a45f345a","permalink":"https://chechia.net/zh-hant/post/2019-09-29-redis-ha-sentinel/","publishdate":"2019-09-29T17:14:38+08:00","relpermalink":"/zh-hant/post/2019-09-29-redis-ha-sentinel/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","redis","ithome","haproxy"],"title":"Redis Ha Sentinel","type":"post"},{"authors":[],"categories":["kubernetes","redis"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nä»Šå¤©çš„æ–‡æœƒæ¯”è¼ƒçŸ­ï¼Œå› ç‚ºæˆ‘æ—©ä¸Šåœ¨ç¶ å³¶å·²ç¶“æ°´è‚ºæ½›æ°´æ½›äº†ä¸‰è¶Ÿï¼Œæœ‰é»ç´¯å“ˆå“ˆ\nRedis introduction Redis æ˜¯å¸¸ç”¨çš„ in-memory çš„è³‡æ–™å„²å­˜åº«ï¼Œå¯ä½œç‚ºè³‡æ–™åº«ï¼Œå¿«å–ï¼Œmessage broker ä½¿ç”¨ï¼Œéƒ½éå¸¸å¥½ç”¨ã€‚Redis å®˜æ–¹æ”¯æ´ high availabilityï¼Œä½¿ç”¨çš„æ˜¯ redis-sentinel ï¼Œä»Šå¤©æˆ‘å€‘å°±ä¾†éƒ¨ç½²ä¸€å€‹æœ‰å®Œæ•´ sentinel çš„ redis-haã€‚\nRedis å¦å¤–æä¾›äº†ä¸€å€‹ solution Redis cluster (multiple writer solution)ï¼Œä½œç‚ºå¢åŠ è³‡æ–™è¼¸å‡ºå¸¶å¯¬ï¼Œèˆ‡å¢åŠ è³‡æ–™è€ç”¨åº¦çš„åˆ†æ•£å¼è§£æ±ºæ–¹æ¡ˆï¼Œèˆ‡ redis sentinel æ‰€è™•ç†çš„ ha å•é¡Œæ˜¯ä¸ç›¸åŒçš„ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘ä¹Ÿä¾†è«‡ã€‚\nDeploy æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½åœ¨é€™äº†https://github.com/chechiachang/go-redis-ha\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash HELM_NAME=redis-1 # Stable: chart version: redis-ha-3.6.1\tapp version: 5.0.5 helm upgrade --install ${HELM_NAME} stable/redis-ha --version 3.6.1 -f values-staging.yaml Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼Œä¹‹æ‰€ä»¥ç”¨ helm ï¼Œå› ç‚ºé€™æ˜¯æˆ‘æƒ³åˆ°æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œèƒ½è®“è¼•é¬†æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´çš„ kafkaã€‚æ‰€ä»¥æˆ‘å€‘å…ˆç”¨ã€‚\næ²’ç”¨é helm çš„å¤§å¾·å¯ä»¥åƒè€ƒ Helm Quickstartï¼Œå…ˆæŠŠ helm cli èˆ‡ kubernetes ä¸Šçš„ helm tiller éƒ½è¨­å®šå¥½\nRedis-ha helm chart github\nInstall é€™é‚Šæ˜¯ç”¨ upgrade â€“installï¼Œå·²å®‰è£å°± upgradeï¼Œæ²’å®‰è£å°± installï¼Œä¹‹å¾Œå¯ä»¥ç”¨é€™å€‹æŒ‡ä»¤å‡ç‰ˆ\nhelm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml values-staging å®Œæ•´çš„ values.yaml åœ¨ helm chart github\nimage: repository: redis tag: 5.0.5-alpine pullPolicy: IfNotPresent ## replicas number for each component replicas: 3 servers: serviceType: ClusterIP # [ClusterIP|LoadBalancer] annotations: {} auth: true ## Redis password ## Defaults to a random 10-character alphanumeric string if not set and auth is true ## ref: https://github.com/kubernetes/charts/blob/master/stable/redis-ha/templates/redis-auth-secret.yaml ## #redisPassword: ## Use existing secret containing key `authKey` (ignores redisPassword) existingSecret: redis-credentials ## Defines the key holding the redis password in existing secret. authKey: auth é€™é‚Šæœ‰æº–å‚™ secret/redis-credentials è£¡é¢çš„ key[auth] å­˜æ”¾ redis å¯†ç¢¼ï¼Œè¦é€£å…¥çš„ pod éœ€è¦æ›è¼‰ secret ä¸¦æŠŠ auth åŒ¯å…¥ã€‚\nVersion é€™é‚Šä½¿ç”¨çš„ç‰ˆæœ¬ï¼š\nchart version: redis-ha-3.6.1 app version: 5.0.5 Redis Image: redis:5.0.5-alpine Redis exporter: oliver006/redis_exporter:v0.31.0 å®‰è£å®Œè®Šé€™æ¨£\n$ kubectl get po | grep redis NAME READY STATUS RESTARTS AGE redis-1-redis-ha-server-0 3/3 Running 0 3d4h redis-1-redis-ha-server-1 3/3 Running 0 3d5h redis-1-redis-ha-server-2 3/3 Running 0 3d4h describe pod å¯ä»¥çœ‹åˆ°è£¡é¢æœ‰ä¸‰å€‹ container\nredis: ä¸»è¦çš„ redis sentinel: ç¶­è­· redis å¯ç”¨æ€§çš„æœå‹™ï¼Œæœƒç›£æ¸¬ redis ç‹€æ…‹ï¼Œä¸¦æŠŠé€£ç·šæŒ‡æ´¾åˆ°æ–°çš„ master redis-exporter: æŠŠ redis çš„é‹è¡Œè³‡æ–™(metrics) é€å‡ºåˆ° promethues Networking Service\nNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR redis-redis-ha ClusterIP None \u0026lt;none\u0026gt; 6379/TCP,26379/TCP,9121/TCP 46m app=redis-ha,release=redis redis-redis-ha-announce-0 ClusterIP 10.3.243.81 \u0026lt;none\u0026gt; 6379/TCP,26379/TCP 46m app=redis-ha,release=redis,statefulset.kubernetes.io/pod-name=redis-redis-ha-server-0 redis-redis-ha-announce-1 ClusterIP 10.3.250.151 \u0026lt;none\u0026gt; 6379/TCP,26379/TCP 46m app=redis-ha,release=redis,statefulset.kubernetes.io/pod-name=redis-redis-ha-server-1 redis-redis-ha-announce-2 ClusterIP 10.3.242.59 \u0026lt;none\u0026gt; 6379/TCP,26379/TCP 46m app=redis-ha,release=redis,statefulset.kubernetes.io/pod-name=redis-redis-ha-server-2 nslookup redis-redis-ha Name: redis-redis-ha Address 1: 10.0.0.42 redis-redis-ha-server-1.redis-redis-ha.default.svc.cluster.local Address 2: 10.0.1.13 redis-redis-ha-server-2.redis-redis-ha.default.svc.cluster.local Address 3: 10.0.2.8 redis-redis-ha-server-0.redis-redis-ha.default.svc.cluster.local Name: redis-redis-ha-server-1.redis-redis-ha.default.svc.cluster.local Address 1: 10.0.0.43 redis-redis-ha-server-1.redis-redis-ha.default.svc.cluster.local é€£ç·š æ‰€æœ‰é€£ç·šé€é redis-redis-ha service é€£å…¥\nredis-cli -h redis-redis-ha -p 6479 -a \u0026lt;password\u0026gt; æˆ–æ˜¯ç›´æ¥æŒ‡å®š redis instance é€£å…¥ã€‚\nredis-cli -h redis-redis-ha-announce-0 -p 6479 -a \u0026lt;password\u0026gt; redis-cli -h redis-redis-ha-announce-1 -p 6479 -a \u0026lt;password\u0026gt; redis-cli -h redis-redis-ha-announce-2 -p 6479 -a \u0026lt;password\u0026gt; ä½†ä¸Šé¢å…©è€…æœƒæœ‰å•é¡Œï¼Œredis åªæœ‰ master æ˜¯ writableï¼Œé€£å…¥ slave æœƒè®Šæˆ readonlyï¼Œå¦‚æœæ²’æœ‰ä»»ä½• probe æ©Ÿæ™ºï¼Œé‚£å°±æ˜¯æ¯æ¬¡é€£ç·šæ™‚æœ‰ 2/3 æ©Ÿç‡æœƒé€£åˆ° readonly çš„ redis slave ã€‚æ‰€ä»¥é€£ç·šå‰è¦å…ˆæ‰¾åˆ°æ­£ç¢ºçš„ master\nSentinel Sentinel æ˜¯ redis å®˜æ–¹æä¾›çš„ HA solutionï¼Œä¸»è¦è² è²¬ç›£æ§ redis çš„ç‹€æ…‹ï¼Œä¸¦æ§åˆ¶ redis master çš„ failover æ©Ÿåˆ¶ï¼Œä¸€ä½†è¶…é thresholdï¼Œsentinel å°±æœƒæŠŠ master failover åˆ°å…¶ä»– slave ä¸Šã€‚ä¸¦æŠŠ master é€£ç·šæŒ‡å‘æ–° masterã€‚\nredis sentinel èˆ‡ redis ä½¿ç”¨ç›¸å®¹çš„ apiï¼Œç›´æ¥ä½¿ç”¨ redis-cli é€é 26479 port é€£å…¥ï¼Œå¯ä»¥é€£åˆ° sentinelï¼Œé€é sentinel å¯ä»¥å–å¾— redis master çš„ç‹€æ…‹èˆ‡é€£ç·šè¨­å®šã€‚\nredis-cli -h redis-redis-ha -p 26479 App ç«¯æ”¯æ´ sentinel éœ€è¦æœ‰æ”¯æ´ sentinel çš„ redis client libraryï¼Œä¾‹å¦‚: python redis-py æœ‰æ”¯æ´ sentinel çš„è¨­å®šã€‚\né€™é‚Šå°±æœƒæ¯”è¼ƒéº»ç…©ï¼Œå› ç‚ºä¸æ˜¯æ‰€æœ‰çš„èªè¨€å° redis-sentinel çš„æ”¯æ´æ€§éƒ½å¤ å¥½ï¼Œæˆ–æ˜¯æ²’è¾¦æ³•è¨­å®šåˆ°å¦®æ—ºä½¿ç”¨çš„æƒ…å¢ƒä¸Šã€‚\nå¦‚æœä½ æ‰¾å¾—åˆ°æ”¯æ´æ€§è‰¯å¥½çš„å¥—ä»¶ï¼Œæ­å–œä½ ã€‚ä¸ç„¶å°±åƒæˆ‘å€‘å…¬å¸ï¼Œèˆ‡æˆ‘å€‘çš„éœ€æ±‚æœ‰è¡çªï¼Œåªå¥½è‡ªå·± fork libraryã€‚\næ‰€ä»¥èªªç›´æ¥ä½¿ç”¨æœ‰æ”¯æ´ redis-sentinel å¯èƒ½æœƒé‡åˆ°ä¸€äº›å•é¡Œã€‚é‚£ä¹Ÿæ²’æœ‰æ›´å¥½çš„è§£æ±ºæ–¹æ³•ï¼Ÿæˆ‘å€‘ä¸‹æ¬¡èªªæ˜ä½¿ç”¨ HAproxy çš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚\nBenchmark éƒ¨ç½²å®Œå¾Œï¼Œå¯ä»¥è·‘ä¸€ä¸‹ benchmarkï¼Œçœ‹çœ‹åœ¨ kubernetes ä¸Šé‹è¡Œçš„æ•ˆèƒ½æœ‰æ²’æœ‰ç¬¦åˆéœ€æ±‚ã€‚\nRun a redis pod with sleep command NOTE: CPU usage (rapidly) increasing during benchmark DONâ€™T DO THIS on PRODUCTION\nkubectl run test-redis --image redis:5.0.5-alpine â€¦","date":1569654863,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"c2720f7d8eae8100d8dc2ce98e49999b","permalink":"https://chechia.net/zh-hant/post/2019-09-28-redis-ha-deployment/","publishdate":"2019-09-28T15:14:23+08:00","relpermalink":"/zh-hant/post/2019-09-28-redis-ha-deployment/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kubernetes","redis","ithome"],"title":"Redis Ha Deployment","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Kafkaâ€™s quorum set Kafka çš„ quorum set é€™ç¯‡è·Ÿä¸Šç¯‡å…¶å¯¦å†è¬› quorumï¼Œæ‡‰è©²é€£åœ¨ä¸€èµ·ï¼Œä½†ç¤™æ–¼ç¯‡å¹…ï¼ˆä»¥åŠæˆ‘å€‹äººçš„æ™‚é–“ï¼±ï¼±ï¼‰æ‹†æˆäº†å…©ç¯‡ã€‚å„ä½æœ‰éœ€è¦å¯ä»¥å›é¡§ä¸€ä¸‹ã€‚\nReplicated log commit decision ä¸Šç¯‡æåˆ°äº†å…©å€‹ç¶­æŒ replicated log çš„ model\næœ‰æ›´æ–°é€²ä¾†ï¼Œleader ç­‰å¾…æ‰€æœ‰ follower éƒ½ ackï¼Œæ‰ commitã€‚ æœ‰æ›´æ–°é€²ä¾†ï¼Œleader å–å¾—æ‰€æœ‰ node (2n+1) ä¸­çš„å¤šæ•¸ node å›æ‡‰(n+1)ï¼Œå°± commitã€‚è€Œ leader election æ™‚ï¼Œå¿…é ˆæ¯”å° node ä¸Šçš„ logï¼Œæ±ºå®šèª°æ˜¯ electable leader(æœ‰æœ€å®Œæ•´ log çš„ follower)ï¼Œé€™æ¨£ç¨±ç‚ºå…±è­˜(Quorum) å‰è€…çš„å¥½è™•æ˜¯ï¼Œæ‰€æœ‰ node éƒ½æœ‰å®Œæ•´çš„ log å¾Œï¼Œleader æ‰æœƒ commitï¼Œå›è¦†çµ¦å®¢æˆ¶ commit çš„è³‡è¨Šï¼Œæ‰€ä»¥æ¯å€‹ follower éƒ½æ˜¯ leader electable äººäººéƒ½å¯ä»¥ç•¶ leaderï¼Œleader ä¸€æ•…éšœå°±é¸æ“‡æ–°çš„ leader å³å¯ã€‚å£è™•å°±æ˜¯ leader åœ¨ç­‰å¾…æ‰€æœ‰ follow ack çš„æ™‚é–“æœƒéå¸¸ä¹…ï¼Œè€Œä¸”æ™‚é–“è¤‡é›œåº¦å¯èƒ½æœƒéš¨ cluster size scaleï¼Œæˆ–æ˜¯è®Šæˆè¦ç­‰æœ€æ…¢çš„ node å›æ‡‰(worst case)ã€‚é€™æ¨£åœ¨ node æ•¸é‡å¤šçš„æ™‚å€™éå¸¸ä¸ç¶“æ¿Ÿã€‚\nå¾Œè€…çš„å¥½è™•æ˜¯ï¼Œn+1 node ack å¾Œå°± commitï¼Œleader commit çš„é€Ÿåº¦æ˜¯ç”±å‰æ®µç­çš„å›æ‡‰é€Ÿåº¦æ±ºå®šã€‚leader å‡ºç¾æ•…éšœï¼Œä»èƒ½ç¶­æŒå¤šæ•¸ node çš„è³‡æ–™æ­£ç¢ºã€‚\nLeader election decision Leader Election çš„å•é¡Œä¹Ÿæ˜¯é¡ä¼¼ï¼Œå¦‚æœé¸æ“‡ leader æ™‚ï¼Œæ‰€æœ‰çš„ follower éƒ½æ¯”å°é logï¼Œé€™æ¨£èŠ±çš„æ™‚é–“æœƒå¾ˆä¹…ã€‚è¦çŸ¥é“ï¼Œé€™æ˜¯å€‹åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œæ²’æœ‰ä¸­å¿ƒåŒ–çš„ controllerï¼Œä¹Ÿå°±æ˜¯ follower å½¼æ­¤éœ€è¦äº¤äº’æ¯”å°ã€‚è€Œä¸”æ™‚é–“éš¨ follower æ•¸é‡ scaleã€‚ é€ æˆtopic partition æ²’æœ‰ leader çš„æ™‚é–“(downtime)å¤ªé•·ã€‚\nå¦‚æœä½¿ç”¨ majorityï¼Œä¹Ÿå°±æ˜¯ç•¶ leader æ­»æ‰ï¼Œç”¢ç”Ÿæ–°çš„ leader election æ™‚ï¼Œåªè©¢å• n+1 å€‹ follower ï¼Œç„¶å¾Œå¾é¸å‡º log æœ€å®Œæ•´çš„äººç•¶ leaderï¼Œ é€™æ¨£éç¨‹ä¸­æ¯å€‹ follower å½¼æ­¤æ¯”å°ï¼Œç¢ºèªï¼Œç„¶å¾Œæ‰é¸å‡º leaderï¼Œç¢ºèª leader çš„çµæœï¼Œæ‰€èŠ±çš„æ™‚é–“æœƒå¤§å¹…ç¸®çŸ­ã€‚\nç•¶ç„¶ï¼Œé€™éº¼åšç”¢ç”Ÿçš„ tradeoffï¼Œå°±æ˜¯è¬ä¸€å–å¾—å¤šæ•¸æ±ºçš„ n+1 å€‹ follower è£¡é¢ï¼Œæ²’æœ‰æœ€å®Œæ•´çš„ log ï¼Œé‚£å¾è£¡é ­é¸å‡ºä¾†çš„ leader è‡ªç„¶ä¹Ÿæ²’æœ‰å®Œæ•´ logï¼Œé¸å‡ºä¾†çš„ leader å°±æœƒéºå¤±è³‡æ–™ã€‚\nä¸€å€‹å®Œæ•´çš„ Quorum æ©Ÿåˆ¶ é€™ä¸æ˜¯ kafka çš„æ©Ÿåˆ¶ï¼Œä½†æˆ‘å€‘é †å¸¶èŠèŠã€‚\ncommit decision ä½¿ç”¨å¤šæ•¸æ±º(majority) leader election ä¹Ÿä½¿ç”¨å¤šæ•¸æ±º ç¸½å…±æœ‰ 2n+1 replicasï¼Œleader å–å¾— n+1 ack æ‰èƒ½ commit messageã€‚ç„¶å¾Œ leader election æ™‚ï¼Œå¾è‡³å°‘ n+1 å€‹ follower ä¸­å–å¾—å¤šæ•¸æ±ºæ‰èƒ½é¸å‡º leaderã€‚æœ‰éåŠçš„å®Œæ•´logï¼ŒåŠ ä¸Šå–å¾—éåŠæ•¸çš„äººç¢ºèªï¼Œå…©è€…ç”¢ç”Ÿ overlapã€‚é€™æ¨£çš„å…±è­˜å°±ç¢ºä¿æœ‰å®Œæ•´çš„ log çš„ follower ä¸€å®šæœƒå‡ºç¾åœ¨ leader election ä¸­ï¼Œç¢ºä¿é¸å‡ºä¾†çš„ leader æœ‰å®Œæ•´ logã€‚\nå¥½è™•å¦‚å‰é¢æè¿°ï¼Œæ•´é«”æ•ˆèƒ½ç”±å‰æ®µç­çš„é€Ÿåº¦æ±ºå®šã€‚\nå£è™•æ˜¯ï¼Œå¾ˆå®¹æ˜“å°±æ²’æœ‰è¶³å¤ çš„ electable leaderã€‚è¦å®¹å¿ 1 å€‹éŒ¯èª¤ï¼Œéœ€è¦ 3 å€‹å®Œæ•´å‚™ä»½ï¼Œè¦å®¹å¿ 2 å€‹éŒ¯èª¤éœ€è¦ 5 å€‹å‚™ä»½ã€‚åœ¨å¯¦å‹™ä¸Šï¼Œåªé ä¾è³´å¤ å¤šçš„ redundency å®¹éŒ¯éå¸¸çš„ä¸å¯¦éš›ï¼šæ¯ä¸€æ¬¡å¯«å…¥éœ€è¦ 5 å€å¯«å…¥è·Ÿç¡¬ç¢Ÿç©ºé–“ï¼Œä½†æ•´é«”æ•ˆèƒ½åªæœ‰ 1/5ã€‚è³‡æ–™é‡å¤§å°±ç›´æ¥ï¼§ï¼§ã€‚æ‰€ä»¥ quorum æ‰æœƒåªå­˜åœ¨åˆ†æ•£å¼é›†ç¾¤(ex. zookeeper)ï¼Œè€Œä¸æœƒç›´æ¥ç”¨åœ¨å„²å­˜ç³»çµ±ã€‚\nKafkaâ€™s approach Kafka ä¸ä½¿ç”¨ majority voteï¼Œè€Œæ˜¯å»å‹•æ…‹ç¶­è­·ä¸€å¥— in-sync replicas(ISR) ï¼Œé€™äº› ISR æœƒè·Ÿä¸Š leader çš„é€²åº¦ï¼Œè€Œåªæœ‰é€™äº› ISR æ‰èƒ½æ˜¯ leader eligibleã€‚ä¸€å€‹ update åªæœ‰åœ¨æ‰€æœ‰ ISR éƒ½ ack å¾Œæ‰æœƒ commitã€‚\nISR çš„ç‹€æ…‹ä¸æ”¾åœ¨ kafka è€Œæ”¾åœ¨ zookeeper ä¸Šï¼Œä¹Ÿå°±æ˜¯ç›®å‰å“ªäº› node æ˜¯ ISR çš„è¨˜éŒ„å­˜åœ¨ zookeeperã€‚é€™ä»¶äº‹å°ç¶­æŒ kafka ç¯€é»ä¸Šï¼Œleader èƒ½å¤ åˆ†æ•£åœ¨å„å€‹ kafka node ä¸Š(leader rebalance)æ˜¯å¾ˆé‡è¦çš„ã€‚\nkafkaâ€™s approach èˆ‡ majority voteï¼Œåœ¨ç­‰å¾… message commit ack ä¸Šæ‰€èŠ±çš„æˆæœ¬æ˜¯ä¸€æ¨£çš„ã€‚ ç„¶è€Œåœ¨ leader election ä¸Šï¼Œkafka çš„ ISR ç¢ºä¿äº†æ›´å¤šå€‹ eligiable leader çš„æ•¸é‡ï¼ŒæŒçºŒç¶­æŒåœ¨åˆç†çš„æ•¸é‡ï¼Œè€Œä¸æœƒè¦ç¶­æŒå¤§é‡å€‹ redundencyã€‚ISR æ”¾åœ¨å¤–éƒ¨ï¼Œæ›´æ–¹ä¾¿ kafka åš leader rebalanceï¼Œå¢åŠ ç©©å®šåº¦ã€‚\nUnclean leader election å¦‚æœ leaders éƒ½æ­»å…‰äº†æœƒæ€æ¨£ï¼Ÿ\nåªè¦æœ‰ä¸€å€‹ replica in-syncï¼ŒKafka å°±ä¿è­‰è³‡æ–™çš„å®Œæ•´æ€§ã€‚ç„¶è€Œæ‰€æœ‰å¯ç”¨çš„ leaders éƒ½æ­»äº†ï¼Œé€™å€‹å°±ç„¡æ³•ä¿è­‰ã€‚\nå¦‚æœé€™å€‹æƒ…å½¢ç™¼ç”Ÿäº†ï¼Œkafka æœƒåšä»¥ä¸‹è™•ç†\nç­‰ ISR ä¸­æœ‰äººå®Œå…¨å›å¾©éä¾†ï¼Œç„¶å¾Œé¸é€™å€‹ node ä½œç‚º leader(æœ‰è³‡æ–™éºå¤±çš„é¢¨éšª) ç›´æ¥é¸æ“‡ç¬¬ä¸€å€‹å›è¦†çš„ node (ä¸ä¸€å®šåœ¨ ISR ä¸­)ï¼Œå…ˆå›è¦†çš„å°±æŒ‡æ´¾ç‚º leader å‰è€…çŠ§ç‰² availability ï¼ˆå›è¦†å‰æ²’æœ‰ leader å¯ä½œè®€å¯«ï¼‰ä¾†ç¢ºä¿è³‡æ–™æ˜¯ä¾†è‡ª ISRï¼Œé›–ç„¶éŒ¯èª¤ä¸­ç„¡æ³•è®€å¯«(downtime)ï¼Œä½†å¯ä»¥ç¢ºå®šéŒ¯èª¤å‰è·ŸéŒ¯èª¤å¾Œçš„è³‡æ–™éƒ½ä¾†è‡ª ISR\nå¾Œè€…çŠ§ç‰² consistency ï¼ˆä¾†è‡ªé ISR çš„ leader å¯èƒ½å°è‡´è³‡æ–™ä¸æ­£ç¢ºï¼‰ï¼Œç„¶è€Œå»èƒ½æ›´å¿«çš„å¾éŒ¯èª¤ä¸­å›è¦†ï¼Œæ¸›å°‘ downtime\n0.11.0.0 å¾Œçš„ kafka é è¨­æ˜¯é¸æ“‡å‰è€…ï¼Œä¹Ÿå°±æ˜¯ consistency over availabilityï¼Œç•¶ç„¶é€™å¯ä»¥åœ¨è¨­å®šæ›´æ”¹ã€‚\nAvailability and Durability Guarantees è¿‘ä¸€æ­¥è€ƒæ…® client çš„å½±éŸ¿ã€‚\nProducer åœ¨å¯«å…¥æ™‚å¯ä»¥é¸æ“‡ message éœ€è¦å¤šå°‘ acknowledgeï¼Œ0, 1 or allï¼Œack=all æŒ‡çš„æ˜¯ message æ”¶åˆ°æ‰€æœ‰ in-sync replicas çš„ ack\nå¦‚æœ 2 replicas ä¸­æœ‰ 1 å€‹æ•…éšœï¼Œé€™æ™‚å¯«å…¥åªè¦æ”¶åˆ° 1 å€‹ ISR çš„ ackï¼Œå°±é”æˆ ack=all ä½†å¦‚æœä¸å¹¸å‰©ä¸‹ä¸€å€‹ replicas ä¹Ÿæ­»äº† (0/0 ack)ï¼Œå¯«å…¥çš„è³‡æ–™å°±æœƒéºå¤± æœ‰äº›ä½¿ç”¨æƒ…å¢ƒï¼Œæœƒå¸Œæœ›è³‡æ–™çš„è€ç”¨åº¦(Durability)å„ªå…ˆæ–¼å¯ç”¨æ€§(Availability)ï¼Œå¯ä»¥é€éä»¥ä¸‹å…©å€‹æ–¹å¼è¨­å®š\nç¦ç”¨ unclean leader electionï¼Œæ•ˆæœæ˜¯å¦‚æœæ‰€æœ‰çš„ replicas éƒ½å¤±æ•ˆï¼Œå‰‡æ•´å€‹ partition éƒ½å¤±æ•ˆï¼Œç›´åˆ°å‰ä¸€å€‹ leader å›å¾©æ­£å¸¸ã€‚ æŒ‡å®šå¯æ¥å—çš„æœ€å°‘ ISRï¼Œå¦‚æœ partition ä¸­çš„ ISR ä½æ–¼é€™å€‹æ•¸é‡ï¼Œå°±åœæ­¢å¯«å…¥é€™å€‹ partitionï¼Œç›´åˆ° ISR çš„æ•¸é‡å›è¦†ã€‚ é€™æ¨£é›–ç„¶çŠ§ç‰²äº†å¯ç”¨æ€§ï¼Œå»å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°ç¢ºä¿è³‡æ–™çš„å¯é æ€§ã€‚\nè¤‡æœ¬ç®¡ç† ä¸Šé¢çš„è¨è«–éƒ½åªæ˜¯å†èªªä¸€å€‹ topicï¼Œå¯¦å‹™ä¸­ kafka ä¸­æœƒæœ‰å¤§é‡çš„ topic ï¼Œä¹˜ä¸Š partition number èˆ‡ replication factorï¼Œæˆåƒä¸Šè¬çš„è¤‡æœ¬åˆ†æ•£åœ¨é›†ç¾¤ä¸­ï¼Œkafka æœƒè©¦åœ–åˆ†æ•£ replicas åˆ°é›†ç¾¤ä¸­ï¼Œä¸¦è®“ leader çš„æ•¸é‡å¹³å‡åœ¨ node ä¸Š\n","date":1569509432,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"bf29f4e12b744c76b549485f2ae693db","permalink":"https://chechia.net/zh-hant/post/2019-09-26-kafka-ha-continued/","publishdate":"2019-09-26T22:50:32+08:00","relpermalink":"/zh-hant/post/2019-09-26-kafka-ha-continued/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes","ithome"],"title":"Kafka HA Continued","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Zookeeper Multi-server setup Kafka Multi-broker setup Zookeeper Multi-Server ç‚ºäº†ç¶­æŒ zookeeper æœ‰æ•ˆé‹ä½œï¼Œcluster å¿…é ˆç¶­æŒ majority (å¤šæ•¸)ï¼Œä¹Ÿå°±æ˜¯è‡³å°‘ä¸€åŠçš„æ©Ÿå™¨åœ¨ç·šã€‚å¦‚æœç¸½å…± 3 å°ï¼Œä¾¿å¯ä»¥å¿å— 1 å°æ•…éšœä»ä¿æœ‰ majorityã€‚å¦‚æœæ˜¯ 5 å°å°±å¯ä»¥å®¹å¿ 2 å°æ•…éšœã€‚ä¸€èˆ¬ä¾†èªªéƒ½å»ºè­°ä½¿ç”¨åŸºæ•¸æ•¸é‡ã€‚Zookeeper Multi Server Setup\næ™®éæƒ…æ³ï¼Œ3 å° zookeeper å·²ç¶“æ˜¯ production ready çš„ç‹€æ…‹ï¼Œä½†å¦‚æœç‚ºäº†æ›´é«˜çš„å¯ç”¨æ€§ï¼Œä»¥æ–¹ä¾¿é€²è¡Œå–®ç¯€é»åœæ©Ÿç¶­è­·ï¼Œå¯ä»¥å¢åŠ ç¯€é»æ•¸é‡ã€‚\nTopology éœ€è¦å°‡ zookeeper æ”¾åœ¨ä¸åŒçš„æ©Ÿå™¨ä¸Šï¼Œä¸åŒçš„ç¶²è·¯ç’°å¢ƒï¼Œç”šè‡³æ˜¯ä¸åŒçš„é›²å¹³å°å€åŸŸä¸Šï¼Œä»¥æ‰¿å—ä¸åŒç¨‹åº¦çš„æ•…éšœã€‚ä¾‹å¦‚å–®å°æ©Ÿå™¨æ•…éšœï¼Œæˆ–æ˜¯å€åŸŸæ€§çš„ç¶²è·¯æ•…éšœã€‚\næˆ‘å€‘é€™é‚Šæœƒä½¿ç”¨ Kubernetes PodAntiAffinityï¼Œè¦æ±‚ scheduler åœ¨éƒ¨å±¬æ™‚ï¼Œå¿…é ˆå°‡ zookeeper åˆ†æ•£åˆ°ä¸åŒçš„æ©Ÿå™¨ä¸Šã€‚è¨­å®šå¦‚ä¸‹ï¼š\nvim values-staging.yaml zookeeper: enabled: true resources: ~ env: ZK_HEAP_SIZE: \u0026#34;1G\u0026#34; persistence: enabled: false image: PullPolicy: \u0026#34;IfNotPresent\u0026#34; url: \u0026#34;\u0026#34; port: 2181 ## Pod scheduling preferences (by default keep pods within a release on separate nodes). ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity ## By default we don\u0026#39;t set affinity: affinity: # Criteria by which pod label-values influence scheduling for zookeeper pods. podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; labelSelector: matchLabels: release: zookeeper ä½¿ç”¨ podAntiAffinity.requiredDuringSchedulingIgnoredDuringExecutionï¼Œå¦‚æœ topologyKey å·²ç¶“æœ‰æŒ‡å®š label çš„ pod å­˜åœ¨ï¼Œå‰‡ç„¡æ³•éƒ¨ç½²ï¼Œéœ€è¦æ•¸åˆ°å…¶ä»–å°æ©Ÿå™¨ã€‚\nkubectl get pods --output wide | grep zookeeper NAME READY STATUS RESTARTS AGE IP NODE kafka-0-zookeeper-0 1/1 Running 0 42d 10.8.12.4 gke-chechiachang-pool-1-e06e6d00-pc98 kafka-0-zookeeper-1 1/1 Running 0 42d 10.8.4.4 gke-chechiachang-pool-1-e06e6d00-c29q kafka-0-zookeeper-2 1/1 Running 0 42d 10.8.3.6 gke-chechiachang-pool-1-e06e6d00-krwc æ•ˆæœæ˜¯ zookeeper éƒ½åˆ†é…åˆ°ä¸åŒçš„æ©Ÿå™¨ä¸Šã€‚\nGuarantees Zookeeper å°æ–¼è³‡æ–™ä¸€è‡´æ€§ï¼Œæœ‰é€™äº›ä¿éšœ Consistency Guarantees\né †åºä¸€è‡´æ€§ï¼šè³‡æ–™æ›´æ–°çš„é †åºï¼Œèˆ‡ç™¼é€çš„é †åºä¸€è‡´ åŸå­æ€§ï¼šè³‡æ–™æ›´æ–°åªæœ‰æˆåŠŸæˆ–å¤±æ•—ï¼Œæ²’æœ‰éƒ¨ä»½æ•ˆæœ ç³»çµ±ä¸€è‡´æ€§ï¼šå¯æˆ¶ç«¯é€£åˆ° server çœ‹åˆ°çš„æ±è¥¿éƒ½æ˜¯ä¸€æ¨£ï¼Œç„¡é—œé€£å…¥å“ªå€‹ server å¯é æ€§ï¼š å®¢æˆ¶ç«¯çš„æ›´æ–°è«‹æ±‚ï¼Œä¸€ä½†æ”¶åˆ° server å›è¦†æ›´æ–°æˆåŠŸï¼Œä¾¿æœƒæŒçºŒä¿å­˜ç‹€æ…‹ã€‚æŸäº›éŒ¯èª¤æœƒé€ æˆå®¢æˆ¶ç«¯æ”¶ä¸åˆ°å›è¦†ï¼ŒÂ å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œï¼Œæˆ–æ˜¯ server å…§éƒ¨å•é¡Œï¼Œé€™é‚Šå°±ç„¡æ³•ç¢ºå®š server ä¸Šçš„ç‹€æ…‹ï¼Œæ˜¯å¦è¢«æ›´æ–°äº†ï¼Œæˆ–æ˜¯è«‹æ±‚å·²ç¶“éºå¤±äº†ã€‚ å¾å®¢æˆ¶è®€å–åˆ°çš„è³‡æ–™éƒ½æ˜¯ä»¥ç¢ºèªçš„è³‡æ–™ï¼Œä¸æœƒå› ç‚º server æ•…éšœå›æ»¾(Roll back)è€Œå›åˆ°èˆŠçš„ç‹€æ…‹ Kafka çš„è¨­å®š ## The StatefulSet installs 3 pods by default replicas: 3 resources: limits: cpu: 200m memory: 4096Mi requests: cpu: 100m memory: 1024Mi kafkaHeapOptions: \u0026#34;-Xmx4G -Xms1G\u0026#34; è¨­å®š broker çš„æ•¸é‡ï¼Œä»¥åŠ Pod æä¾›çš„ resourceï¼Œä¸¦ä¸”é€é heapOption æŠŠè¨˜æ†¶é«”è¨­å®šå¡é€² JVM\naffinity: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - kafka topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 50 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - zookeeper é€™é‚Šä¸‹äº†å…©å€‹ affinity\npodAntiAffinity ç›¡é‡è®“ kafka-broker åˆ†æ•£åˆ°ä¸åŒæ©Ÿå™¨ä¸Š podAffinity è®“ broker prefer è·Ÿ zookeeper æ”¾åœ¨ä¸€èµ· åˆ†æ•£çš„ç†ç”±åŒä¸Šï¼Œä¸å¸Œæœ›ä¸€å°æ©Ÿå™¨æ­»äº†ï¼Œå°±è®“å¤šå€‹ broker è·Ÿè‘—æ­»\nè¦å’Œ zookeeper æ”¾åœ¨ä¸€èµ·ï¼Œå°±è¦çœ‹éœ€æ±‚èˆ‡å¯¦éš›ç’°å¢ƒèª¿æ•´\nconfigurationOverrides: \u0026#34;default.replication.factor\u0026#34;: 3 \u0026#34;offsets.topic.replication.factor\u0026#34;: 2 # Increased from 1 to 2 for higher output \u0026#34;offsets.topic.num.partitions\u0026#34;: 3 \u0026#34;confluent.support.metrics.enable\u0026#34;: false # Disables confluent metric submission \u0026#34;auto.leader.rebalance.enable\u0026#34;: true \u0026#34;auto.create.topics.enable\u0026#34;: true \u0026#34;message.max.bytes\u0026#34;: \u0026#34;16000000\u0026#34; # Extend global topic max message bytes to 16 Mb é€™é‚Šå†æŠŠ broker é‹è¡Œçš„è¨­å®šåƒæ•¸å¡é€²å»ï¼Œåƒæ•¸çš„ç”¨é€”å¤§å¤šèˆ‡è¤‡æœ¬èˆ‡é«˜å¯ç”¨æ©Ÿåˆ¶æœ‰é—œä¸‹é¢éƒ½æœƒæåˆ°ã€‚\nKafka çš„è¤‡æœ¬æ©Ÿåˆ¶ kafka çš„å‰¯æœ¬æ©Ÿåˆ¶ é è¨­å°‡å„å€‹ topic partition çš„ log åˆ†æ•£åˆ° server ä¸Šï¼Œå¦‚æœå…¶ä¸­ä¸€å° server æ•…éšœï¼Œè³‡æ–™ä»ç„¶å¯ç”¨ã€‚\nå…©å€‹é‡è¦çš„è¨­å®š\nnum.partitions=N default.replication.factor=M kafka é è¨­ä½¿ç”¨è¤‡æœ¬ï¼Œæ‰€æœ‰æ©Ÿåˆ¶èˆ‡è¨­è¨ˆéƒ½åœç¹è‘—è¤‡æœ¬ã€‚å¦‚æœï¼ˆå› ç‚ºæŸäº›åŸå› ï¼‰ä¸å¸Œæœ›ä½¿ç”¨è¤‡æœ¬ï¼Œå¯å°‡ replication factor è¨­ç‚º 1ã€‚\nreplication çš„å–®ä½æ˜¯ topic partitionï¼Œæ­£å¸¸ç‹€æ³ä¸‹\nä¸€å€‹ partition æœƒæœ‰ä¸€å€‹ leaderï¼Œä»¥åŠé›¶å€‹æˆ–ä»¥ä¸Šå€‹ follower leader + follower ç¸½æ•¸æ˜¯ replication factor æ‰€æœ‰è®€å¯«éƒ½æ˜¯å° leader è®€å¯« leader çš„ log æœƒåŒæ­¥åˆ° follower ä¸Šï¼Œleader èˆ‡ follower ç‹€æ…‹æ˜¯ä¸€æ¨£çš„ Election \u0026amp; Load balance é€šå¸¸ä¸€å€‹ topic æœƒæœ‰å¤šå€‹ partitionï¼Œä¹Ÿå°±æ˜¯èªªï¼Œæ¯å€‹ topic æœƒæœ‰å¤šå€‹ partition leaderï¼Œåˆ†æ•£è² è¼‰\né€šå¸¸ topic partition çš„ç¸½æ•¸æœƒæ¯” broker çš„æ•¸é‡å¤š\nä»¥ä¸Šä¸€ç¯‡ç¯„ä¾‹ï¼Œæˆ‘å€‘æœ‰ä¸‰å€‹ kafka-0-broker å„è‡ªæ˜¯ä¸€å€‹ Pod æœ‰ topic: ticker è·Ÿé è¨­çš„ __consumer_offset__ï¼Œä¹˜ä¸Š partition number çš„è¨­å®šå€¼(N)ï¼Œæœƒæœ‰ 2N å€‹ partitions partitiion æœƒæœ‰å„è‡ªçš„è¤‡æœ¬ï¼Œkafka æœƒç›¡é‡å°‡ç›¸åŒ topic çš„è¤‡æœ¬åˆ†æ•£åˆ°ä¸åŒ broker ä¸Š kafka ä¹Ÿæœƒç›¡é‡ç¶­æŒ partition çš„ leader åˆ†æ•£åœ¨ä¸åŒçš„ broker ä¸Šï¼Œé€™å€‹éƒ¨åˆ† kafka æœƒé€éç®—æ³•åš leader electionï¼Œä¹Ÿå¯æ‰‹å‹•ä½¿ç”¨è…³æœ¬åš Balancing leadership ç¸½ä¹‹ï¼Œtopic çš„ partition èˆ‡ leader æœƒåˆ†æ•£åˆ° broker ä¸Šï¼Œç¶­æŒ partition çš„å¯ç”¨æ€§ã€‚\nsync node è¦èƒ½å¤ ç¶­æŒ zookeeper çš„ session (zookeeper æœ‰ heartbeat æ©Ÿåˆ¶) follower ä¸èƒ½è½å¾Œ leader å¤ªå¤š kafka èƒ½ä¿éšœè³‡æ–™ä¸æœƒéºå¤±ï¼Œåªè¦è‡³å°‘ä¸€å€‹ node æ˜¯åœ¨ sync çš„ç‹€æ…‹ã€‚ä¾‹å¦‚æœ¬ä¾†æœ‰ä¸‰å€‹ partitionï¼Œå…¶ä¸­å…©å€‹ partition ä¸åŒæ­¥ï¼Œåªè¦å…¶ä¸­ä¸€å€‹ partition æ˜¯åŒæ­¥ï¼Œä¾¿èƒ½ä½œç‚º leader æŒçºŒæä¾›æ­£ç¢ºçš„ messageã€‚\nReplicated Logs kafka é€é replicated log ç¶­æŒåˆ†æ•£å¼çš„ partition\nè¤‡æœ¬é–“è¦ç¶­æŒå…±è­˜(consensus)çš„æœ€ç°¡å–®æ©Ÿåˆ¶ï¼Œå°±æ˜¯å–®ä¸€ leader æ±ºå®šï¼Œå…¶ä»– follower è·Ÿéš¨ã€‚ç„¶è€Œè¬ä¸€ leader æ­» â€¦","date":1569423032,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"12d41ac554ed14ce53a27a90a7c4c6a3","permalink":"https://chechia.net/zh-hant/post/2019-09-25-kafka-ha-topology/","publishdate":"2019-09-25T22:50:32+08:00","relpermalink":"/zh-hant/post/2019-09-25-kafka-ha-topology/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes"],"title":"Kafka HA Topology","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ å¾ Zookeeper ç²å–è³‡è¨Š å–å¾—ä¸¦è™•ç† topic benchmark kafka zookeeper zookeeper æ˜¯ kafka çš„åˆ†æ•£å¼å”èª¿ç³»çµ±ï¼Œåœ¨ kafka ä¸Šå¤šå€‹ç¯€é»é–“éœ€è¦å”èª¿çš„å…§å®¹ï¼Œä¾‹å¦‚ï¼šå½¼æ­¤ç¯€é»çš„IDï¼Œä½ç½®èˆ‡ç•¶å‰ç‹€æ…‹ï¼Œæˆ–æ˜¯è·¨ç¯€é» topic çš„è¨­å®šèˆ‡ç‹€æ…‹ã€‚å–åå«åš zookeeper å°±æ˜¯åœ¨å”èª¿æ··äº‚çš„åˆ†æ•£å¼ç³»çµ±ï¼Œ,è£¡é¢å„ç¨®ä¸åŒç¨®é¡çš„æœå‹™éƒ½è¦å”èª¿ï¼Œè±¡å€‹å‹•ç‰©åœ’ç®¡ç†å“¡ã€‚Zookeeper çš„å®˜æ–¹æ–‡ä»¶ æœ‰æ›´è©³ç´°çš„èªªæ˜ã€‚\nKafka çš„ç¯€é»è³‡è¨Šï¼Œèˆ‡ç•¶å‰ç‹€æ…‹ï¼Œæ˜¯æ”¾åœ¨ zookeeper ä¸Šï¼Œæˆ‘å€‘å¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤å–å¾—\n# é¦–å…ˆå…ˆå–å¾— zkCli çš„ cliï¼Œé€™å€‹åªæœ‰é€£é€²ä»»ä½•ä¸€å° zookeeper å…§éƒ¨éƒ½æœ‰ kubectl exec -it kafka-0-zookeeper-0 --container kafka-broker bash # ç”±æ–¼æ˜¯åœ¨ Pod å…§éƒ¨ï¼Œç›´æ¥ localhost è©¢å•æœ¬åœ° /usr/bin/zkCli.sh -server localhost:2181 Connecting to localhost:2181 2019-09-25 15:02:36,089 [myid:] - INFO [main:Environment@100] - Client environment:zookeeper.version=3.4.10-39d3a4f269333c922ed3db283be479f9deacaa0f, built on 03/23/2017 10:13 GMT 2019-09-25 15:02:36,096 [myid:] - INFO [main:Environment@100] - Client environment:host.name=kafka-0-zookeeper-0.kafka-0-zookeeper-headless.default.svc.cluster.local 2019-09-25 15:02:36,096 [myid:] - INFO [main:Environment@100] - Client environment:java.version=1.8.0_131 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.vendor=Oracle Corporation 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.home=/usr/lib/jvm/java-8-openjdk-amd64/jre 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.class.path=/usr/bin/../build/classes:/usr/bin/../build/lib/*.jar:/usr/bin/../share/zookeeper/zookeeper-3.4.10.jar:/usr/bin/../share/zookeeper/slf4j-log4j12-1.6.1.jar:/usr/bin/../share/zookeeper/slf4j-api-1.6.1.jar:/usr/bin/../share/zookeeper/netty-3.10.5.Final.jar:/usr/bin/../share/zookeeper/log4j-1.2.16.jar:/usr/bin/../share/zookeeper/jline-0.9.94.jar:/usr/bin/../src/java/lib/*.jar:/usr/bin/../etc/zookeeper: 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib/x86_64-linux-gnu/jni:/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/usr/lib/jni:/lib:/usr/lib 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.io.tmpdir=/tmp 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.compiler=\u0026lt;NA\u0026gt; 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:os.name=Linux 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:os.arch=amd64 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:os.version=4.14.127+ 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:user.name=zookeeper 2019-09-25 15:02:36,102 [myid:] - INFO [main:Environment@100] - Client environment:user.home=/home/zookeeper 2019-09-25 15:02:36,102 [myid:] - INFO [main:Environment@100] - Client environment:user.dir=/ 2019-09-25 15:02:36,105 [myid:] - INFO [main:ZooKeeper@438] - Initiating client connection, connectString=localhost:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@42110406 Welcome to ZooKeeper! 2019-09-25 15:02:36,160 [myid:] - INFO [main-SendThread(localhost:2181):ClientCnxn$SendThread@1032] - Opening socket connection to server localhost/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error) JLine support is enabled 2019-09-25 15:02:36,374 [myid:] - INFO [main-SendThread(localhost:2181):ClientCnxn$SendThread@876] - Socket connection established to localhost/127.0.0.1:2181, initiating session 2019-09-25 15:02:36,393 [myid:] - INFO [main-SendThread(localhost:2181):ClientCnxn$SendThread@1299] - Session establishment complete on server localhost/127.0.0.1:2181, sessionid = 0x16d67baf1310001, negotiated timeout = 30000 WATCHER:: WatchedEvent state:SyncConnected type:None path:null [zk: localhost:2181(CONNECTED) 0] å–å¾— kafka broker è³‡æ–™\n# List root Nodes $ ls / [cluster, controller, controller_epoch, brokers, zookeeper, admin, isr_change_notification, consumers, log_dir_event_notification, latest_producer_id_block, config] # Brokers çš„è³‡æ–™ç¯€é» $ ls /brokers [ids, topics, seqid] # List /brokers/ids å¾—åˆ°ä¸‰å€‹ kafka broker $ ls /brokers/ids [0, 1, 2] # åˆ—å‡ºæ‰€æœ‰ topic åç¨± ls /brokers/topics [ticker] ticker æ˜¯ä¸Šç¯‡ç¯„åˆ©ç”¨åˆ°çš„ topic\nç°¡å–®ä¾†èªªï¼Œzookeeper å­˜æ”¾é€™äº›ç‹€æ…‹èˆ‡ topic çš„ metadata\nå„²å­˜æ ¸å¿ƒçš„ç‹€æ…‹èˆ‡è³‡æ–™ï¼Œç‰¹åˆ¥æ˜¯ broker è¬ä¸€æ›æ‰ï¼Œä¹Ÿé‚„éœ€è¦ç¶­æŒçš„è³‡æ–™ å”èª¿å·¥ä½œï¼Œä¾‹å¦‚å”åŠ© broker è™•ç† quorumï¼Œç´€éŒ„ partition master ç­‰ # é›¢é–‹ zkCli quit Kafka é€™é‚Šä¸€æ¨£å…ˆé€£ç·šé€²å»ä¸€å° brokerï¼Œå–å¾— kafka binary\nkubectl exec -it kafka-0-0 --container kafka-broker bash ls /usr/bin/ | grep kafka kafka-acls â€¦","date":1569423032,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"37788bcddae4226839899d43afcb10ad","permalink":"https://chechia.net/zh-hant/post/2019-09-25-kafka-operation-scripts/","publishdate":"2019-09-25T22:50:32+08:00","relpermalink":"/zh-hant/post/2019-09-25-kafka-operation-scripts/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes","ithome"],"title":"Kafka Operation Scripts","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ åœ¨ Kubernetes ä¸­é€£ç·š kafka ä½¿ç”¨ golang library é€£ç·šåˆ° Kafka é€é kafka script æ“ä½œ kafka kubernetes ä¸­é€£ç·š kafka å…ˆçœ‹ä¸€çœ‹ kafka pods\n$ kubectl get pods --selector=\u0026#39;app=kafka\u0026#39; NAME READY STATUS RESTARTS AGE kafka-1-0 1/1 Running 1 26d kafka-1-1 1/1 Running 0 26d kafka-1-2 1/1 Running 0 26d $ kubectl get pods -l \u0026#39;app=zookeeper\u0026#39; NAME READY STATUS RESTARTS AGE kafka-1-zookeeper-0 1/1 Running 0 26d kafka-1-zookeeper-1 1/1 Running 0 26d kafka-1-zookeeper-2 1/1 Running 0 26d $ kubectl get pods -l \u0026#39;app=kafka-exporter\u0026#39; NAME READY STATUS RESTARTS AGE kafka-1-exporter-88786d84b-z954z 1/1 Running 5 26d kubectl describe pods kafka-1-0 Name: kafka-1-0 Namespace: default Priority: 0 Node: gke-chechiachang-pool-1-e4622744-wcq0/10.140.15.212 Labels: app=kafka controller-revision-hash=kafka-1-69986d7477 release=kafka-1 statefulset.kubernetes.io/pod-name=kafka-1-0 Annotations: kubernetes.io/limit-ranger: LimitRanger plugin set: cpu request for container kafka-broker Status: Running IP: 10.12.6.178 Controlled By: StatefulSet/kafka-1 Containers: kafka-broker: Image: confluentinc/cp-kafka:5.0.1 Port: 9092/TCP Host Port: 0/TCP Command: sh -exc unset KAFKA_PORT \u0026amp;\u0026amp; \\ export KAFKA_BROKER_ID=${POD_NAME##*-} \u0026amp;\u0026amp; \\ export KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://${POD_IP}:9092 \u0026amp;\u0026amp; \\ exec /etc/confluent/docker/run Requests: cpu: 100m Liveness: exec [sh -ec /usr/bin/jps | /bin/grep -q SupportedKafka] delay=30s timeout=5s period=10s #success=1 #failure=3 Readiness: tcp-socket :kafka delay=30s timeout=5s period=10s #success=1 #failure=3 Environment: POD_IP: (v1:status.podIP) POD_NAME: kafka-1-0 (v1:metadata.name) POD_NAMESPACE: default (v1:metadata.namespace) KAFKA_HEAP_OPTS: -Xmx4G -Xms1G KAFKA_ZOOKEEPER_CONNECT: kafka-1-zookeeper:2181 KAFKA_LOG_DIRS: /opt/kafka/data/logs KAFKA_CONFLUENT_SUPPORT_METRICS_ENABLE: false KAFKA_DEFAULT_REPLICATION_FACTOR: 3 KAFKA_MESSAGE_MAX_BYTES: 16000000 KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 KAFKA_JMX_PORT: 5555 Mounts: /opt/kafka/data from datadir (rw) /var/run/secrets/kubernetes.io/serviceaccount from default-token-2tm8c (ro) Conditions: Volumes: datadir: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: datadir-kafka-1-0 ReadOnly: false default-token-2tm8c: Type: Secret (a volume populated by a Secret) SecretName: default-token-2tm8c Optional: false è¬›å¹¾å€‹é‡é»ï¼š\né€™é‚Šè·‘èµ·ä¾†çš„æ˜¯ kafka-brokerï¼Œæ¥æ”¶ producer èˆ‡ consumer ä¾†çš„ request é€™é‚Šç”¨çš„æ˜¯ statefulsetsï¼Œä¸æ˜¯å®Œå…¨ç„¡ç‹€æ…‹çš„ kafka brokerï¼Œè€ŒæŠŠ message è¨˜åœ¨ datadir ä¸Šï¼Œé™ä½æ•…éšœé‡å•Ÿæ™‚å¯èƒ½éºå¤±è³‡æ–™çš„é¢¨éšªã€‚ å•Ÿå‹•æ™‚ï¼ŒæŠŠ kubernetes æŒ‡å®šçš„ pod name å¡é€²ç’°å¢ƒè®Šæ•¸ï¼Œç„¶å¾Œä½œç‚ºç•¶å‰ broker çš„ ID æ²’æœ‰è¨­å®š Pod antiAffinityï¼Œæ‰€ä»¥æœ‰å¯èƒ½æœƒå•Ÿä¸‰å€‹ kafka çµæœä¸‰å€‹è·‘åœ¨åŒä¸€å° node ä¸Šï¼Œé€™æ¨£ node æ•…éšœå°±å…¨æ­»ï¼Œæ²’æœ‰HA Service \u0026amp; Endpoints çœ‹ä¸€ä¸‹ service èˆ‡ endpoints zookeeper èˆ‡ exporter æˆ‘å€‘é€™é‚Šå…ˆæ éä¸è«‡ï¼Œåˆ°å°ˆç« è¬›é«˜å¯ç”¨æ€§èˆ‡æœå‹™ç›£æ¸¬æ™‚ï¼Œå†ä¾†è¨è«–ã€‚\n$ kubectl get service -l \u0026#39;app=kafka\u0026#39; NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kafka-1 ClusterIP 10.15.242.178 \u0026lt;none\u0026gt; 9092/TCP 26d kafka-1-headless ClusterIP None \u0026lt;none\u0026gt; 9092/TCP 26d å…©å€‹ services\nä¸€å€‹æ˜¯ cluster-ip serviceï¼Œæœ‰ single cluster IP èˆ‡ load-balanceï¼ŒDNS æœƒé kube-proxyã€‚ ä¸€å€‹æ˜¯ headless serviceï¼ŒDNS æ²’æœ‰é kube-proxyï¼Œè€Œæ˜¯ç”± endpoint controller ç›´æ¥ address recordï¼ŒæŒ‡å‘æŠŠç¬¦åˆ service selector çš„ podã€‚é©åˆåš service discoveryï¼Œä¸æœƒä¾è³´æ–¼ kubernetes çš„å¯¦ç¾ã€‚ è©³ç´°èªªæ˜åœ¨å®˜æ–¹æ–‡ä»¶\nç°¡å–®ä¾†èªªï¼Œkafka broker æœƒåš auto service discoveryï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ headless serviceã€‚\nå®¢æˆ¶ç«¯(consumer \u0026amp; producer) é€£å…¥æ™‚ï¼Œå‰‡ä½¿ç”¨ cluster-ip serviceï¼Œåš load balancingã€‚\n$ kubectl get endpoints -l \u0026#39;app=kafka\u0026#39; NAME ENDPOINTS AGE kafka-1 10.12.1.14:9092,10.12.5.133:9092,10.12.6.178:9092 26d kafka-1-headless 10.12.1.14:9092,10.12.5.133:9092,10.12.6.178:9092 26d Golang Example é™„ä¸Šç°¡å–®çš„ Golang å®¢æˆ¶ç«¯ï¼Œå®Œæ•´ Github Repository åœ¨é€™é‚Š\npackage main import ( \u0026#34;context\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/segmentio/kafka-go\u0026#34; // ä½¿ç”¨çš„å¥—ä»¶ ) func main() { topic := \u0026#34;ticker\u0026#34; // æŒ‡å®š message è¦ä½¿ç”¨çš„ topic partition := 0 // æŒ‡å®š partitionï¼Œç”±æ–¼åº•ä¸‹é€£ç·šæŒ‡å®šé€£ç·šåˆ° partition çš„ leaderï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®š partition kafkaURL := \u0026#34;kafka-0:9092\u0026#34; // æŒ‡å®š kafkaURLï¼Œä¹Ÿå¯ä»¥é€é os.GetEnv() å¾ç’°å¢ƒè®Šæ•¸è£¡æ‹¿åˆ°ã€‚ // producer å°æŒ‡å®š topic, partition çš„ leader ç”¢ç”Ÿé€£ç·š producerConn, _ := kafka.DialLeader(context.Background(), \u0026#34;tcp\u0026#34;, kafkaURL, topic, partition) // ç¨‹å¼çµæŸæœ€å¾ŒæŠŠ connection é—œæ‰ã€‚ä¸é—œæœƒé€ æˆ broker ç´¯ç©å¤§é‡ connectionï¼Œéœ€è¦ç­‰å¾… broker ç«¯ timeout æ‰æœƒé‡‹æ”¾ã€‚ defer producerConn.Close() //producerConn.SetWriteDeadline(time.Now().Add(10 * time.Second)) // ä½¿ç”¨ go routine è·‘ä¸€å€‹ subprocess for loopï¼Œä¸€ç›´ç”¢ç”Ÿ message åˆ° kafka topicï¼Œé€™é‚Šçš„ç¯„ä¾‹æ˜¯æ¯ç§’æ¨ä¸€å€‹ç§’æ•¸ã€‚ go func() { for { producerConn.WriteMessages( kafka.Message{ Value: []byte(strconv.Itoa(time.Now().Second())), }, ) time.Sleep(1 * time.Second) } }() // make a new â€¦","date":1569333589,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"51c2041a8a32cbc46e22519634c523f9","permalink":"https://chechia.net/zh-hant/post/2019-09-24-kafka-basic-usage/","publishdate":"2019-09-24T21:59:49+08:00","relpermalink":"/zh-hant/post/2019-09-24-kafka-basic-usage/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes","ithome"],"title":"Kafka-basic-usage","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nå¯«äº†éƒ¨å±¬ï¼Œæœ¬æƒ³è«‡ä¸€ä¸‹ kafka çš„é«˜å¯ç”¨æ€§é…ç½®ï¼Œçœ‹åˆ°å¤§å¾·çš„ç•™è¨€ï¼Œæ‰æƒ³åˆ°æ‡‰è©²è¦å…ˆè·Ÿå„ä½ä»‹ç´¹ä¸€ä¸‹ kafkaï¼Œè·Ÿ kafka çš„ç”¨é€”ã€‚ä¹Ÿæ„Ÿè¬å¤§å¾·è·¯éç™¼å•ï¼Œæˆ‘ä¹Ÿæœƒé †ä»£èª¿æ•´å…§å®¹ã€‚ä»Šå¤©å°±èªªæ˜ä½•ç‚º kafkaï¼Œä»¥åŠåœ¨ä»€éº¼æ¨£çš„ç‹€æ³ä½¿ç”¨ã€‚\næ‘˜è¦ ç°¡ä»‹ kafka åŸºæœ¬å…ƒä»¶ Kafka çš„å·¥ä½œæµç¨‹ ç°¡ä»‹ Kafka Kafka æ˜¯åˆ†æ•£å¼çš„ streaming platformï¼Œå¯ä»¥ subscribe \u0026amp; publish è¨Šæ¯ï¼Œå¯ä»¥ç•¶ä½œæ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„ message queue ç³»çµ±ï¼Œç”±æ–¼åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œè®“ kafka æœ‰å¾ˆå¤§ç¨‹åº¦çš„ fault toleranceã€‚åŸç‰ˆçš„èªªæ˜åœ¨é€™é‚Š\né€™é‚Šæœ‰å¹¾å€‹æ±è¥¿è¦è§£é‡‹ã€‚\nMessage Queue System ç•¶ä¸€å€‹ç³»çµ±é–‹å§‹é‹ä½œæ™‚ï¼Œè£¡é ­æœƒæœ‰å¾ˆå¤šè®Šæ•¸ï¼Œé€™äº›è®Šæ•¸å…¶å¯¦å°±æ˜¯åœ¨ä¸€å®šçš„ç¯„åœ(scopeï¼‰å…§ï¼Œåšè¨Šæ¯(message)çš„å‚³éã€‚ä¾‹å¦‚åœ¨ app å¯«äº†ä¸€å€‹ function ï¼Œå‚³å…¥ä¸€å€‹è®Šæ•¸çš„å€¼çµ¦ functionã€‚\nåœ¨è¤‡é›œçš„ç³»çµ±ä¸­ï¼Œæœå‹™å…ƒä»¶å½¼æ­¤ä¹Ÿæœƒæœ‰å‚³éè¨Šæ¯çš„éœ€æ±‚ã€‚ä¾‹å¦‚æˆ‘åŸæœ¬æœ‰ä¸€å€‹ api-serverï¼Œå…¶ä¸­ä¸€æ®µç¨‹å¼ç¢¼æ˜¯æ•ˆèƒ½ç“¶é ¸ï¼Œæˆ‘æŠŠå®ƒåˆ‡å‡ºä¾†ç¨ç«‹æˆä¸€å€‹ worker çš„å…ƒä»¶ï¼Œè®“å®ƒå¯ä»¥åœ¨æ›´é«˜æ•ˆèƒ½åœ°æ–¹åŸ·è¡Œï¼Œç”šè‡³ horizontal scalingã€‚é€™ç¨®æƒ…å¢ƒï¼Œè¾¨å¯èƒ½æ­²éœ€è¦æŠŠä¸€éƒ¨åˆ†çš„ message å¾ api-server å‚³åˆ° workerï¼Œworker æŠŠåƒæ•ˆèƒ½çš„å·¥ä½œåšå®Œï¼Œå†æŠŠçµæœå›å‚³çµ¦ api-serverã€‚é€™æ™‚å°±æœƒéœ€è¦ä¸€å€‹ç©©å®šçš„ message queue systemï¼Œä¾†ç©©å®šï¼Œä¸”é«˜æ•ˆèƒ½çš„å‚³éé€™äº› messageã€‚\nMessage Queue System å¯¦åšå¾ˆå¤šï¼ŒActiveMQ, RabbitMQ, â€¦ ç­‰ï¼Œä¸€äº› database åš message queue åœ¨æŸäº›æ‡‰ç”¨å ´æ™¯ä¸‹ä¹Ÿååˆ†é©åˆï¼Œä¾‹å¦‚ Redis æ˜¯ in-memory key-value databaseï¼Œå…§éƒ¨ä¹Ÿå¯¦åš pubsubï¼Œèƒ½å¤ åœ¨æŸäº›ç’°å¢ƒç©©å®šçš„å‚³é€ messageã€‚\nRequest-Response vs Publish-Subscribe è¨Šæ¯çš„å‚³é€æœ‰å¾ˆå¤šæ–¹å¼ï¼Œä¾‹å¦‚ Http request-response å¾ˆé©åˆ server åœ¨ç„¡ç‹€æ…‹(stateless) ä¸‹æ¥å—ä¾†è‡ªå®¢æˆ¶ç«¯çš„è¨Šæ¯ï¼Œæ¯æ¬¡å‚³é€éƒ½é‡æ–°å»ºç«‹æ–°çš„ http connectionï¼Œé€™æ¨£åšæœ‰å¾ˆå¤šå¥½è™•ä¹Ÿå¾ˆå¤šå£è™•ã€‚å…¶ä¸­æ˜é¡¯çš„å£è™•æ˜¯ç¶²è·¯è³‡æºçš„æµªè²»ï¼Œä»¥åŠè¨Šæ¯çš„ä¸å¤ å³æ™‚ï¼ŒæŒ‡å®šç‰¹å®šæ”¶ä»¶äººæ™‚ç™¼ä»¶äººæœƒé€ æˆé¡å¤–è² æ“”ç­‰ã€‚\nä½¿ç”¨ Pub-sub patternçš„å¥½è™•ï¼Œæ˜¯ publisher ä¸éœ€è¦é¡å¤–è™•ç†ã€é€™å€‹è¨Šæ¯è¦é€çµ¦èª°ã€çš„å·¥ä½œï¼Œè€Œæ˜¯è®“ subscriber ä¾†è¨‚é–±éœ€è¦çš„è¨Šæ¯é¡åˆ¥ï¼Œä¸€æœ‰æ–°çš„ event é€åˆ°è©²è¨Šæ¯é¡åˆ¥ï¼Œç›´æ¥é€é broker æ¨æ’­çµ¦ subscriberã€‚ä¸åƒ…å³æ™‚ï¼Œç¯€çœæ•ˆèƒ½ï¼Œè€Œä¸”è¨‚é–±çš„å½ˆæ€§å¾ˆå¤§ã€‚\nKafka producer \u0026amp; Consumer API Kafka ä½œç‚º client èˆ‡ server å…©é‚Šçš„æºé€šå¹³å°ï¼Œæä¾›äº†è¨±å¤š API è‘›ä¸åŒè§’è‰²ä½¿ç”¨ã€‚Producer ç”¢ç”Ÿ message åˆ°ç‰¹å®š topic ä¸Šï¼Œconsumer è¨‚é–±ç‰¹å®š topicsï¼Œkafak æŠŠç¬¦åˆæ¢ä»¶çš„è¨Šæ¯æ¨æ’­çµ¦ consumerã€‚\nProducer API: è®“ app publish ä¸€é€£çš„è¨Šæ¯ Consumer API: è®“ app subscribe è¨±å¤šç‰¹å®š topicï¼Œä¸¦è™•ç†è¨Šæ¯ä¸²æµ(stream) Stream API: è®“ app ä½œç‚ºä¸²æµä¸­ä»‹è™•ç†(stream processor) Connect API: èˆ‡ producer èˆ‡ consumer å¯ä»¥å°å¤–éƒ¨æœå‹™é€£çµ Topics \u0026amp; Logs Topic æ˜¯ kafka ç‚ºè¨Šæ¯ä¸²æµæä¾›çš„æŠ½è±¡ï¼Œtopic æ˜¯è¨Šæ¯å‚³é€åˆ° kafka æ™‚è³¦äºˆçš„é¡åˆ¥(category)ï¼Œä½œç‚º publish èˆ‡ consume çš„åˆ¤æ–·ä¾æ“šã€‚\nPartition è¨Šæ¯ä¾æ“š topic åˆ†é¡å­˜æ”¾ï¼Œä¸¦å¯ä»¥ä¾æ“š replication factor è¨­å®šï¼Œåœ¨ kafka ä¸­å­˜æ”¾å¤šå€‹è¨Šæ¯åˆ†å‰²(partition)ã€‚partition å¯ä»¥æƒ³æˆæ˜¯ message queue çš„å¹³è¡ŒåŒ– (parallel)ï¼Œä½µç™¼è™•ç†è¨Šæ¯å¯ä»¥å¤§å¹…ææ˜‡è¨Šæ¯æ¥æ”¶èˆ‡ç™¼é€çš„é€Ÿåº¦ï¼Œä¸¦ä¸”å¤šå€‹å‰¯æœ¬ä¹Ÿæé«˜è³‡æ–™çš„å¯ç”¨æ€§ã€‚\nç”±æ–¼è¨Šæ¯ç™¼é€è·Ÿæ¥æ”¶éç¨‹å¯èƒ½å› ç‚ºç¶²è·¯èˆ‡ç’°å¢ƒè€Œä¸ç©©å®šï¼Œé€™äº›ç›¸åŒ topic çš„ partition ä¸ä¸€å®šæœƒå®Œå…¨ä¸€æ¨£ã€‚ä½† kafka ç¢ºä¿äº†ä»¥ä¸‹å¹¾é»ã€‚\nGuarantees è‰¯å¥½é…ç½®çš„ kafka æœ‰ä»¥ä¸‹ä¿è­‰\nè¨Šæ¯åœ¨ç³»çµ±ä¸­é€å‡ºè·Ÿè¢«æ”¶åˆ°çš„æ™‚é–“ä¸ä¸€å®šï¼Œä½†kafakä¸­ï¼Œå¾ç›¸åŒ producer é€å‡ºçš„è¨Šæ¯ï¼Œé€åˆ° topic partition æœƒç¶­æŒé€å‡ºçš„é †åº Consumer çœ‹è¦‹çš„è¨Šæ¯æ˜¯èˆ‡ kafka ä¸­çš„å­˜æ”¾é †åºä¸€è‡´ æœ‰ replication factor ç‚º N çš„ topic ï¼Œå¯ä»¥å®¹å¿(fault-tolerance) N-1 å€‹ kafka-server å£æ‰ï¼Œè€Œä¸å½±éŸ¿è³‡æ–™ã€‚ ç•¶ç„¶ï¼Œé€™é‚Šçš„å‰ææ˜¯æœ‰è‰¯å¥½é…ç½®ã€‚éŒ¯èª¤çš„é…ç½®å¯èƒ½æœƒå°è‡´è¨Šæ¯ä¸ç©©å®šï¼Œæ•ˆèƒ½ä½è½ï¼Œç”šè‡³éºå¤±ã€‚\nProducer Producer è² è²¬æŠŠè¨Šæ¯æ¨å‘ä¸€å€‹ topicï¼Œä¸¦æŒ‡å®šè¨Šæ¯æ‡‰è©²æ”¾åœ¨ topic çš„å“ªå€‹ partitionã€‚\nConsumer Consumer æœƒè‡ªè¡Œæ¨™è¨˜ï¼Œå½¢æˆ consumer groupï¼Œé€é consumer group ä¾†ä¿éšœè¨Šæ¯å‚³éçš„æ¬¡åºï¼Œå®¹éŒ¯ï¼Œä»¥åŠæ“´å±•çš„æ•ˆç‡ã€‚\nConsumer é€é consumer group å…±äº«ä¸€å€‹ group.idã€‚ Consumer group å»æ‰€æœ‰ partitions è£¡æ‹¿è¨Šæ¯ï¼Œæ‰€æœ‰ partitions çš„è¨Šæ¯åˆ†é…åˆ° consumer group ä¸­çš„ consumerã€‚ app åœ¨æ¥æ”¶è¨Šæ¯æ™‚ï¼Œè¨­ç½®æ­£ç¢ºçš„åŒ–ï¼Œåœ¨ä¸€å€‹ consumer group ä¸­ï¼Œå¯ä»¥å®¹å¿ consumer å¤±æ•ˆï¼Œä»èƒ½ç¢ºä¿è¨Šæ¯ä¸€æŒ‡å®šçš„æ¬¡åºé€é”ã€‚åœ¨éœ€è¦å¤§æµé‡æ™‚ï¼Œä¹Ÿå¯èª¿æ•´ consumer çš„æ•¸é‡æé«˜è² è¼‰ã€‚\nç”¨ä¾‹ kafka çš„ä½¿ç”¨ä¾‹å­éå¸¸çš„å¤šï¼Œä½¿ç”¨ç¯„åœéå¸¸å»£æ³›ã€‚\nåŸºæœ¬ä¸Šæ˜¯è¨Šæ¯å‚³éçš„ä½¿ç”¨ä¾‹å­ï¼Œkafka å¤§å¤šèƒ½å‹ä»»ã€‚\nå°çµ é€™é‚Šåªæäº† kafka çš„åŸºæœ¬æ¦‚å¿µï¼ŒåŸºæœ¬å…ƒä»¶ï¼Œä»¥åŠ consumer group æ©Ÿåˆ¶ï¼Œç‚ºæˆ‘å€‘åº•ä¸‹è¦è«‡çš„ configuration èˆ‡ topology é‹ªè·¯ã€‚\n","date":1569247189,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"5fa88f73dbb752d54cb84b12b6b543e2","permalink":"https://chechia.net/zh-hant/post/2019-09-23-kafka-introduction/","publishdate":"2019-09-23T21:59:49+08:00","relpermalink":"/zh-hant/post/2019-09-23-kafka-introduction/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes","ithome"],"title":"Kafka-introduction","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\n","date":1569246929,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"a277ceed046b13f94110a7b4096388f1","permalink":"https://chechia.net/zh-hant/post/2019-09-23-kafka-helm-configuration/","publishdate":"2019-09-23T21:55:29+08:00","relpermalink":"/zh-hant/post/2019-09-23-kafka-helm-configuration/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes","ithome"],"title":"Kafka Helm Configuration","type":"post"},{"authors":[],"categories":["kubernetes","kafka"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nç¢å¿µ 30 å¤©æ¯å¤©ä¸€æ–‡çœŸçš„è »é€¼äººçš„ï¼Œæ¯ä¸€ç¯‡éƒ½æ˜¯æ–°å¯«ï¼Œé‚„è¦ç›¡å¯èƒ½é¡§åŠæ–‡ç« å“è³ªï¼Œä¸‹ç­è¶•æ–‡ç« ï¼Œå„ä½å¤§å¾·å¯«çœ‹çœ‹å°±çŸ¥é“\né€™é‚Šèª¿æ•´äº†ç•¶åˆæƒ³å¯«çš„æ–‡ç« ï¼Œå…§å®¹æ‡‰è©²éƒ½æœƒå¸¶åˆ° elk kafka-ha reids-ha prometheus kubernetes on gcp ä½†ä¸æœƒå†ä¸€ç¯‡ 10000 å­—äº†ï¼Œé€¼æ­»æˆ‘å§â€¦ å¯«ä¸å®Œçš„éƒ¨ä»½ 30 å¤©å€™æœƒåœ¨ITé‚¦å¹«å¿™ï¼Œæˆ–æ˜¯æˆ‘çš„ Github Page https://chechia.net/è£œå®Œ å¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\næ‘˜è¦ ç°¡ä»‹ kafka éƒ¨å±¬ kafka åˆ° kubernetes ä¸Š ç°¡ä»‹ kafka Kafka æ˜¯åˆ†æ•£å¼çš„ streaming platformï¼Œå¯ä»¥ subscribe \u0026amp; publish è¨Šæ¯ï¼Œå¯ä»¥ç•¶ä½œæ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„ message queue ç³»çµ±ï¼Œç”±æ–¼åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œè®“ kafka æœ‰å¾ˆå¤§ç¨‹åº¦çš„ fault toleranceã€‚\næˆ‘å€‘ä»Šå¤©å°±ä¾†éƒ¨å±¬ä¸€å€‹ kafkaã€‚\nDeploy æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½åœ¨é€™äº†https://github.com/chechiachang/kafka-on-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash # # https://github.com/helm/charts/tree/master/incubator/kafka #HELM_NAME=kafka HELM_NAME=kafka-1 helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator # Stable: chart version: kafka-0.16.2\tapp version: 5.0.1 helm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼Œä¹‹æ‰€ä»¥ç”¨ helm ï¼Œå› ç‚ºé€™æ˜¯æˆ‘æƒ³åˆ°æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œèƒ½è®“è¼•é¬†æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´çš„ kafkaã€‚æ‰€ä»¥æˆ‘å€‘å…ˆç”¨ã€‚\næ²’ç”¨é helm çš„å¤§å¾·å¯ä»¥åƒè€ƒ Helm Quickstartï¼Œå…ˆæŠŠ helm cli èˆ‡ kubernetes ä¸Šçš„ helm tiller éƒ½è¨­å®šå¥½\nhelm init Helm Chart ä¸€å€‹ helm chart å¯ä»¥ç•¶æˆä¸€å€‹ç¨ç«‹çš„å°ˆæ¡ˆï¼Œä¸åŒçš„ chart å¯ä»¥åœ¨ kubernetes ä¸Šå”åŠ©éƒ¨å±¬ä¸åŒçš„é …ç›®ã€‚\né€™é‚Šä½¿ç”¨äº†é‚„åœ¨ incubator çš„chartï¼Œé›–ç„¶æ˜¯ prod readyï¼Œä¸éä½¿ç”¨ä¸Šé‚„æ˜¯è¦æ³¨æ„ã€‚\nä½¿ç”¨å‰å…ˆæŠŠ incubator çš„ helm repo åŠ é€²ä¾†\nhelm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator Install é€™é‚Šæ˜¯ç”¨ upgrade â€“installï¼Œå·²å®‰è£å°± upgradeï¼Œæ²’å®‰è£å°± installï¼Œä¹‹å¾Œå¯ä»¥ç”¨é€™å€‹æŒ‡ä»¤å‡ç‰ˆ\nhelm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml Version é€™é‚Šä½¿ç”¨çš„ç‰ˆæœ¬ï¼š\nchart version: kafka-0.16.2 app version: 5.0.1 kafka Image: confluentinc/cp-kafka:5.0.1 zookeeper Image: gcr.io/google_samples/k8szk:v3 kafka exporter: danielqsj/kafka-exporter:v1.2.0 values-staging é€é helm chartï¼ŒæŠŠå•Ÿå‹•åƒæ•¸å¸¶é€²å»ï¼Œé€™é‚Šæˆ‘å€‘çœ‹å¹¾å€‹æ¯”è¼ƒé‡è¦çš„ï¼Œç´°ç¯€ä¹‹å¾Œçš„æ–‡ç« åœ¨ä¸€èµ·è¨è«–ã€‚\nhttps://github.com/chechiachang/kafka-on-kubernetes/blob/master/values-staging.yaml\nreplicas: 3 å®‰è£ä¸‰å€‹ kafkaï¼Œtopology çš„æ±è¥¿ä¹Ÿæ˜¯æ•¬å¾…ä¸‹ç¯‡XD\n## The kafka image repository image: \u0026#34;confluentinc/cp-kafka\u0026#34; ## The kafka image tag åº•å±¤åŸ·è¡Œçš„ kafka æ˜¯ conluent kafka Configure resource requests and limits ref: http://kubernetes.io/docs/user-guide/compute-resources/ resources: {}\nlimits: cpu: 200m memory: 4096Mi requests: cpu: 100m memory: 1024Mi kafkaHeapOptions: â€œ-Xmx4G -Xms1Gâ€\né€™é‚Šå¯ä»¥èª¿æ•´åœ¨ kubernetes ä¸Šé¢çš„ limit è·Ÿ request * Deploy æœƒå…ˆå»è·Ÿ node å•å¤ ä¸å¤ ï¼Œå¤ çš„è©±è¦æ±‚ node ä¿ç•™é€™äº›è³‡æºçµ¦ Pod * Runtime è¶…é limitï¼ŒPod æœƒè¢« kubernetes å¹¹æ‰ï¼Œä¸éæˆ‘å€‘æ˜¯ JVMï¼Œå¤–éƒ¨ resource çˆ†æ‰å‰ï¼Œæ‡‰è©²æœƒå…ˆå›  heap æ»¿è€Œæ­»ã€‚ä¸€å€‹æ–½ä¸»è‡ªç›¡çš„æ„Ÿè¦ºã€‚ * CPU è »çœçš„ï¼Œåƒæ¯”è¼ƒå¤šæ˜¯ memoryã€‚ä½†ä¹Ÿè¦çœ‹ä½ çš„ä½¿ç”¨æƒ…å¢ƒ prometheus\nå°æˆ‘å€‘æœ‰ä¸Š promethuesï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ kafka-exporter æŠŠ kafka metrics å€’å‡ºå» prometheusï¼Œé€™å€‹ä¹Ÿæ˜¯è©³è¦‹ä¸‹å›åˆ†è§£ã€‚ # è·‘èµ·ä¾†äº† $ kubectl get po | grep kafka\nNAME READY STATUS RESTARTS AGE kafka-1-0 1/1 Running 0 224d kafka-1-1 1/1 Running 0 224d kafka-1-2 1/1 Running 0 224d kafka-1-exporter-88786d84b-z954z 1/1 Running 0 224d kafka-1-zookeeper-0 1/1 Running 0 224d kafka-1-zookeeper-1 1/1 Running 0 224d kafka-1-zookeeper-2 1/1 Running 0 224d\n","date":1569117521,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"91c33ff59ad95668815c7c944f7eb9ef","permalink":"https://chechia.net/zh-hant/post/2019-09-22-kafka-deployment-on-kubernetes/","publishdate":"2019-09-22T09:58:41+08:00","relpermalink":"/zh-hant/post/2019-09-22-kafka-deployment-on-kubernetes/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚","tags":["éµäººè³½2019","kafka","kubernetes","ithome"],"title":"Kafka Deployment on Kubernetes","type":"post"},{"authors":[],"categories":["kubernetes","elasticsearch"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\næ‘˜è¦ ç°¡ä»‹ logstash å°‡ logstash éƒ¨å±¬åˆ° kubernetes ä¸Š è¨­å®š logstash pipeline è™•ç† nginx access log ä»‹ç´¹ Logstash Logstash æ˜¯é–‹å…ƒçš„è³‡æ–™è™•ç†å¼•æ“ï¼Œå¯ä»¥å‹•æ…‹çš„å°‡è¼¸å…¥çš„è³‡æ–™åšå¤§é‡çš„è™•è£¡ã€‚åŸå…ˆçš„ç›®çš„æ˜¯è™•ç† log ï¼Œä½†ç›®å‰ä»¥ä¸é™æ–¼è™•ç† log ï¼Œå„ç¨® ELK beat æˆ–æ˜¯å…¶ä»–ä¾†æºçš„ä¸åŒç›£æ¸¬æ•¸æ“šï¼Œéƒ½èƒ½è™•ç†ã€‚\nLogastash å…§éƒ¨çš„åŠŸèƒ½ä¹Ÿå¤§å¤šæ¨¡çµ„åŒ–ï¼Œå› æ­¤å¯ä»¥çµ„è£ä¸åŒçš„ pluginï¼Œä¾†å¿«é€Ÿè™•ç†ä¸åŒä¾†æºè³‡æ–™ã€‚\nåŸºæœ¬ä¸Šå¸¸è¦‹çš„è³‡æ–™ä¾†æºï¼Œlogstash éƒ½èƒ½å¤ è™•ç†ï¼Œä¸¦ä¸”æœ‰å¯«å¥½çš„ plugin å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œç´°ç¯€è«‹è¦‹logstash å®˜æ–¹æ–‡ä»¶\nå¾Œé€è³‡æ–™åº«èˆ‡æœ€çµ‚å„²å­˜åº« åœ¨é–‹å§‹æ¶è¨­ logstash è¦å…ˆè€ƒæ…® pipeline è™•ç†éå¾Œé€çš„è³‡æ–™åº«ï¼Œå¯ä½¿ç”¨çš„è³‡æ–™åº«éå¸¸å¤šï¼Œé€™é‚Šæœƒå±•ç¤ºçš„æœ‰ï¼š\nELK Stack æ¨™æº–é…å‚™é€åˆ° Elasticsearch å­˜æ”¾æœƒæ™‚å¸¸æŸ¥è©¢çš„ç†±è³‡æ–™ï¼Œåªå­˜æ”¾ä¸€æ®µæ™‚é–“å‰çš„è³‡æ–™ å¤ªèˆŠçš„è³‡æ–™è‡ªå‹• Rollout æœ€çµ‚ archieving çš„è³‡æ–™åº«ï¼Œé€™é‚Šä½¿ç”¨ GCP çš„ Big Query å­˜æ”¾æŸ¥æ‰¾æ¬¡æ•¸å°‘ï¼Œä½†éå¸¸å¤§é‡çš„æ­·å²ç´€éŒ„ã€‚ Elasticsearch åœ¨å‰å¹¾ç¯‡å·²ç¶“æ¶è¨­å¥½ï¼ŒGCP Big Query çš„è¨­å®šä¹Ÿäº‹å…ˆé–‹å¥½ã€‚\néƒ¨å±¬ Logstash kubernetes resource çš„ yaml è«‹åƒè€ƒ æˆ‘çš„ github elk-kubernetes\nkubectl apply -f config-configmap.yaml kubectl apply -f pipelines-configmap.yam kubectl apply -f deployment.yaml kubectl apply -f service.yaml æ”¾ä¸Šå»çš„ resource\nconfig-configmap: Logstash æœå‹™æœ¬èº«å•Ÿå‹•çš„è¨­å®šåƒæ•¸ pipelines-configmap: Logstash çš„ pipelines è¨­å®šæª”æ¡ˆ Lostagh Deployment Logastash çš„æœå‹™ instance å¯ä»¥å‹•æ…‹ scalingï¼Œä¹Ÿå°±æ˜¯æœƒæœ‰è¤‡æ•¸ Logstash instance åšè² è¼‰å‡è¡¡ Logstash service å¯é€é kubernetes å…§éƒ¨çš„ kube-dns æœå‹™ é›†ç¾¤å…§çš„ filebeat å¯ä»¥ç›´æ¥é€é logstash.default.svc.chechiachang-cluster.local çš„ dns é€£ç·š logstash é›†ç¾¤å…§çš„ç¶²è·¯ï¼Œç›´æ¥ä½¿ç”¨ httpï¼ˆç•¶ç„¶ä½¿ç”¨ https ä¹Ÿæ˜¯å¯ä»¥ï¼Œç›¸é—œæ­¥é©Ÿè«‹è¦‹å‰å¹¾ç¯‡æ–‡ç« ï¼‰ ç°¡å–®è¬›ä¸€ä¸‹ kubernetes service çš„è² è¼‰å‡è¡¡ï¼Œé—œæ–¼ kubernetes service ç´°ç¯€é€™ç¯‡é™„ä¸Šæ–‡ä»¶\n$ kubectl get services NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE logstash ClusterIP 10.15.254.47 \u0026lt;none\u0026gt; 5044/TCP 182d $ kubectl get endpoints NAME ENDPOINTS AGE logstash 10.12.0.132:5044,10.12.10.162:5044,10.12.9.167:5044 + 12 more... 182d åœ¨ Kubernetes å…§éƒ¨æ¯å€‹ Pod éƒ½èƒ½çœ‹åˆ° logstash, logstash.default.svc.chechiachang-cluster.local é€™å…©å€‹ dns DNS ç›´æ¥æŒ‡å‘è¤‡æ•¸çš„ logstash endpointsï¼Œ æ¯ä¸€å€‹ ip éƒ½æ˜¯ kubernetes å…§éƒ¨é…ç½®çš„ä¸€å€‹ Pod çš„ IPï¼Œé–‹å•Ÿ 5044 çš„ logstash port Service çš„ load balance æ©Ÿåˆ¶è¦– service è¨­å®šï¼Œç´°ç¯€å¯ä»¥çœ‹é€™é‚Š è¬›åˆ°æœ€ç™½ï¼Œå°±æ˜¯ filebeat LOGSTASH URL è¨­å®šç‚º http://logstash å°±æœƒæ‰“åˆ°å…¶ä¸­ä¸€å° logstash\næ›´æ”¹ filebeat configmap\n$ kubectl edit configmap filebeat-configmap # Disable output to elasticsearch output.elasticsearch: enabled: false # Output to logstash output.logstash: hosts: [\u0026#34;logstash:5044\u0026#34;] protocol: \u0026#34;http\u0026#34; username: \u0026#34;elastic\u0026#34; password: è¨­å®š logstash é€™é‚Šè¦å…ˆèªªï¼Œlogstash ä¹Ÿæ”¯æ´ centralized configurationï¼Œå¦‚æœä½ çš„ logstash ä¸æ˜¯è·‘åœ¨ Kubernetes ä¸Šï¼Œæ²’è¾¦æ³•é…ç½®ä¸€å¥— configmap å°±æ‡‰ç”¨åˆ°å…¨éƒ¨çš„ instanceï¼Œè¨˜çš„ä¸€å®šè¦ä½¿ç”¨ã€‚\nLogastash çš„é‹è¡Œè¨­å®š logstash.ymlï¼Œé€™é‚Šæˆ‘å€‘æ²’æœ‰åšè¨­å®šï¼Œéƒ½æ˜¯é è¨­å€¼ï¼Œæœ‰éœ€æ±‚å¯ä»¥è‡ªè¡Œæ›´æ”¹\nç•¶ç„¶ä¹‹å¾Œè¦èª¿æ•´ batch size æˆ–æ˜¯ queue, cache ç­‰ç­‰æ•ˆèƒ½èª¿æ ¡ï¼Œä¹Ÿæ˜¯ä¾†é€™é‚Šæ”¹ï¼Œæ”¹å®Œ configmap ï¼Œrolling update logstash å°±å¯ä»¥ã€‚\né€™é‚Šä¸»è¦æ˜¯ä¾†è¬› pipeline è¨­å®šã€‚\n$ kubectl describe configmap pipelines-configmap apiVersion: v1 kind: ConfigMap metadata: name: logstash-pipelines namespace: elk labels: k8s-app: logstash data: # Nginx Template # https://www.elastic.co/guide/en/logstash/7.3/logstash-config-for-filebeat-modules.html#parsing-nginx nginx.conf: | ... Configmap è£¡é¢åªæœ‰ä¸€å€‹ pipelineï¼Œå°±æ˜¯ nginx.confï¼Œæˆ‘å€‘é€™é‚Šå°±åªæœ‰ä¸€æ¢ï¼Œé€™é‚Šä¸€æ®µä¸€æ®µçœ‹\nInput input { beats { # The lisening port of logstash port =\u0026gt; 5044 host =\u0026gt; \u0026#34;0.0.0.0\u0026#34; } } è¨­å®š Input ä¾†æºï¼Œæ˜¯ beat å¾ 5044 é€²ä¾†\nFilter æ¥ä¸‹ä¾†ä¸€å¤§æ®µæ˜¯ filterï¼Œæ¯å€‹ filter ä¸­é–“çš„ block éƒ½æ˜¯ä¸€å€‹ pluginï¼Œlogstash æ”¯æ´éå¸¸å¤šæœ‰è¶£çš„ plugin ï¼Œè™•ç†ä¸åŒä¾†æºçš„å·¥ä½œï¼Œç´°ç¯€è«‹çœ‹é€™ç¯‡\nfilter { # Ignore data from other source in case filebeat input is incorrectly configured. if [kubernetes][container][name] == \u0026#34;nginx-ingress-controller\u0026#34; { # Parse message with grok # Use grok debugger in kibana -\u0026gt; dev_tools -\u0026gt; grok_debugger grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; \u0026#34;%{IPORHOST:[nginx][access][remote_ip]} - \\[%{IPORHOST:[nginx][access][remote_ip_list]}\\] - %{DATA:[nginx][access][user_name]} \\[%{HTTPDATE:[nginx][access][time]}\\] \\\u0026#34;%{WORD:[nginx][access][method]} %{DATA:[nginx][access][request_url]} HTTP/%{NUMBER:[nginx][access][http_version]}\\\u0026#34; %{NUMBER:[nginx][access][response_code]} %{NUMBER:[nginx][access][body_sent][bytes]} \\\u0026#34;%{DATA:[nginx][access][referrer]}\\\u0026#34; \\\u0026#34;%{DATA:[nginx][access][agent]}\\\u0026#34; %{NUMBER:[nginx][access][request_length]} %{NUMBER:[nginx][access][request_time]} \\[%{DATA:[nginx][access][proxy_upstream_name]}\\] %{DATA:[nginx][access][upstream_addr]} %{NUMBER:[nginx][access][upstream_response_length]} %{NUMBER:[nginx][access][upstream_response_time]} %{NUMBER:[nginx][access][upstream_status]} %{DATA:[nginx][access][req_id]}\u0026#34; } } # Match url parameters if has params grok { match =\u0026gt; { \u0026#34;[nginx][access][request_url]\u0026#34; =\u0026gt; \u0026#34;%{DATA:[nginx][access][url]}\\?%{DATA:[nginx][access][url_params]}\u0026#34; } } # Remove and add fields mutate { remove_field =\u0026gt; \u0026#34;[nginx][access][request_url]\u0026#34; add_field =\u0026gt; { \u0026#34;read_timestamp\u0026#34; =\u0026gt; \u0026#34;%{@timestamp}\u0026#34; } # Add fileset.module:nginx to fit nginx dashboard add_field =\u0026gt; { \u0026#34;[fileset][module]\u0026#34; =\u0026gt; \u0026#34;nginx\u0026#34;} add_field =\u0026gt; { \u0026#34;[fileset][name]\u0026#34; =\u0026gt; \u0026#34;access\u0026#34;} } # Parse date string into timestamp date { match =\u0026gt; [ \u0026#34;[nginx][access][time]\u0026#34;, \u0026#34;dd/MMM/YYYY:H:m:s Z\u0026#34; ] remove_field =\u0026gt; \u0026#34;[nginx][access][time]\u0026#34; } # Split url_parameters with \u0026amp; # /api?uuid=123\u0026amp;query=456 # become # nginx.access.url_params.uuid=123 nginx.access.url_params.query=456 kv { source =\u0026gt; â€¦","date":1569050543,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"cb81847665ce4fb1036e4f4760a2ff02","permalink":"https://chechia.net/zh-hant/post/2019-09-21-logstash-on-gke/","publishdate":"2019-09-21T15:22:23+08:00","relpermalink":"/zh-hant/post/2019-09-21-logstash-on-gke/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.","tags":["éµäººè³½2019","elasticsearch","devops","logstash"],"title":"Logstash on GKE","type":"post"},{"authors":[],"categories":["kubernetes","logstash"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\né€™ç¯‡ä¾†è¦ Kubernetes ç’°å¢ƒ(GKE)è£¡é¢çš„ log æŠ“å‡ºä¾†ï¼Œé€åˆ° ELK ä¸Šã€‚\nå®˜æ–¹æ–‡ä»¶ ï¼Œå¯«å¾—å¾ˆç°¡æ˜“ï¼Œå¦‚æœå·²ç¶“å¾ˆç†Ÿ kubernetes çš„äººå¯ä»¥ç›´æ¥è…¦è£œå…¶ä»–çš„éƒ¨å±¬è¨­å®šã€‚\né€™é‚Šæœ‰å¹¾å€‹åšæ³•ï¼Œä¾ç…§ filebeat éƒ¨ç½²çš„ä½ç½®èˆ‡æ”¶é›†ç›®æ¨™ç°¡å–®åˆ†ç‚ºï¼š\nnode: è™•ç†æ¯ä¸€å° node çš„ log ï¼ŒåŒ…å« system log èˆ‡ node ç›£æ¸¬è³‡æ–™(metrics) cluster: è™•ç† cluster ç­‰ç´šçš„ log, event æˆ–æ˜¯ metrics pod: é‡å°ç‰¹å®š pod ç›´æ¥å»æ›ä¸€å€‹ sidecar ä¸Šé¢çš„æ–¹æ³•æ˜¯å¯ä»¥æ··æ­çš„ï¼Œkubernetes å€‹å€‹å±¤ç´šæœ‰log è™•ç†æµç¨‹ï¼Œæˆ‘å€‘é€™é‚ŠæŠŠ log é€å¾€ç¬¬ä¸‰æ–¹å¹³å°ï¼Œä¹Ÿæ˜¯éœ€è¦ä¾ç…§åŸæœ¬çš„ log æµç¨‹ï¼Œå»æ”¶å–æˆ‘å€‘æƒ³æ”¶é›†çš„ logã€‚\nç°¡å–®ä¾†èªªï¼Œæ˜¯å»å°çš„åœ°æ–¹æ‰¾å°çš„ logã€‚åœ¨æ¶æ§‹ä¸Šè¦æ³¨æ„ scalability èˆ‡ resource åˆ†é…ï¼Œä¸è¦å½±éŸ¿æœ¬èº«æä¾›æœå‹™çš„ GKE ï¼Œä½†åˆèƒ½ç²å¾—ç›¡é‡å³æ™‚çš„ logã€‚\næˆ‘å€‘é€™é‚Šç›´æ¥é€²å…¥ kubernetes resource çš„è¨­å®šï¼Œåº•ä¸‹æœƒé™„ä¸Šåœ¨ GKE æ‰¾ log çš„éç¨‹ã€‚\nNode level log harvest ç‚ºæ¯ä¸€å€‹ node é…ç½® filebeatï¼Œç„¶å¾Œåœ¨ node ä¸Šé¢å°‹æ‰¾ logï¼Œç„¶å¾Œå¦‚æˆ‘å€‘ä¸Šç¯‡æ‰€æ•˜è¿°åŠ åˆ° input ï¼Œå°±å¯ä»¥æŠŠ log å€’å‡ºä¾†ã€‚\nç›´è¦ºæƒ³åˆ°å°±æ˜¯é€é daemonsets ç‚ºæ¯å€‹ node éƒ¨ç½²ä¸€å€‹ filebeat podï¼Œç„¶å¾Œ mount node çš„ log è³‡æ–™å¤¾ï¼Œåœ¨è¨­ç½® inputã€‚\nDeploy daemonsets kubernetes resource çš„ yaml è«‹åƒè€ƒ æˆ‘çš„ github elk-kubernetes\nçµ¦äºˆè¶³å¤ çš„ clusterrolebinding åˆ° elk\nkubectl apply -f filebeat/7.3.1/clusterrolebinding.yaml å…ˆæ›´æ”¹ filebeat çš„è¨­å®šï¼Œå¦‚ä½•è¨­å®š elasticsearch èˆ‡ kibanaï¼Œè«‹åƒè€ƒä¸Šç¯‡ã€‚è‡³æ–¼ input çš„éƒ¨ä»½å·²ç¶“é…ç½®å¥½äº†ã€‚\nvim filebeat/7.3.1/daemonsets-config-configmap.yaml kubectl apply -f filebeat/7.3.1/daemonsets-config-configmap.yaml éƒ¨å±¬ filebeat daemonsetsï¼Œæœƒæ¯ä¸€å€‹ node éƒ¨å±¬ä¸€å€‹ filebeat\nkubectl apply -f filebeat/7.3.1/daemonsets.yaml å–å¾— daemonsets çš„ç‹€æ…‹\nkubectl --namespcae elk get pods NAME READY STATUS RESTARTS AGE filebeat-bjfp9 1/1 Running 0 6m56s filebeat-fzr9n 1/1 Running 0 6m56s filebeat-vpkm7 1/1 Running 0 6m56s ... æœ‰è¨­å®šæˆåŠŸçš„è©±ï¼Œkibana é€™é‚Šå°±æœƒæ”¶åˆ° kubernetes ä¸Šé¢ pod çš„ log\nlog havest for specific pods ç”±æ–¼ kubernetes ä¸Šæˆ‘å€‘å¯ä»¥ä¾¿åˆ©çš„èª¿åº¦ filebeat çš„éƒ¨å±¬æ–¹å¼ï¼Œé€™é‚Šä¹Ÿå¯ä»¥ä¹Ÿå¯ä»¥ä½¿ç”¨ deployment ï¼Œé…åˆ pod affinityï¼ŒæŠŠ filebeat æ”¾åˆ°æŸå€‹æƒ³è¦ç›£æ¸¬çš„ podï¼Œé€™é‚Šçš„ä¾‹å­æ˜¯ nginx-ingress-controllerã€‚\nKubernetes ä¸Šæœ‰ä¸€å€‹æˆ–å¤šå€‹ nginx ingress controller éƒ¨å±¬ä¸€å€‹æˆ–å¤šå€‹ filebeat åˆ°æœ‰ nginx çš„ node ä¸Š filebeat å»æŠ“å– nginx çš„ inputï¼Œ ä¸¦ä½¿ç”¨ filebeat çš„ nginx module åšé è™•ç† nginx module é è¨­è·¯å¾‘éœ€è¦èª¿æ•´ï¼Œé€™é‚Šä½¿ç”¨ filebeat autodiscover ä¾†è™•ç† ä¸€æ¨£ apply å‰è¨˜å¾—å…ˆæª¢æŸ¥è·Ÿè¨­å®š\nvim filebeat/7.3.1/nginx-config-configmap.yaml kubectl apply -f filebeat/7.3.1/nginx-config-configmap.yaml éƒ¨å±¬ filebeat deployment ç”±æ–¼æœ‰è¨­å®š pod affinity ï¼Œé€™å€‹ filebeat åªæœƒè¢«æ”¾åˆ°æœ‰ nginx ingress controller çš„é€™å€‹ç¯€é»ä¸Šï¼Œä¸¦ä¸”ä¾ç…§ autodiscover è¨­å®šçš„æ¢ä»¶å»è’é›† nginx çš„ log\nkubectl apply -f filebeat/7.3.1/nginx-deployment.yaml æœ‰è¨­å®šæˆåŠŸçš„è©±ï¼Œkibana é€™é‚Šå°±æœƒæ”¶åˆ° kubernetes ä¸Šé¢ pod çš„ log\nå¦å¤–ï¼Œç”±æ–¼æœ‰å•Ÿå‹• nginx moduleï¼Œlogstash æ”¶åˆ°çš„å…§å®¹å·²ç¶“æ˜¯è™•ç†éå¾—å…§å®¹ã€‚\nGCP fluentd å¦‚æœæ˜¯ä½¿ç”¨ GKE çš„æœ‹å‹ï¼Œå¯ä»¥æŠ•éé–‹å•Ÿ stackdriver logging çš„åŠŸèƒ½ï¼ŒæŠŠé›†ç¾¤ä¸­æœå‹™çš„ log å€’åˆ° stackdriverï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ node -\u0026gt; (daemonsets) fluentd -\u0026gt; stackdriverã€‚\né€™å€‹ fluentd æ˜¯ GCP å¦‚æœæœ‰å•Ÿå‹• Stackdriver Logging çš„è©±ï¼Œè‡ªå‹•å¹«ä½ ç¶­è­·çš„ daemonsetsï¼Œè¨­å®šä¸å¯æ”¹ï¼Œæ”¹äº†æœƒè¢« overwrite æœƒå»ï¼Œæ‰€ä»¥ä¸å¤ªæ–¹ä¾¿å¾é€™é‚Šå‹•æ‰‹è…³ã€‚\nBtw stackdriver æœ€è¿‘å¥½åƒæ”¹ç‰ˆï¼Œç›®å‰åš example çš„ç‰ˆæœ¬å·²ç¶“è®Šæˆ lagency ï¼ˆæ·š\nä½†æˆ‘å€‘å…ˆå‡è¨­æˆ‘å€‘å°é€™å€‹ pod çš„ log å¾ˆæœ‰èˆˆè¶£ï¼Œç„¶å¾ŒæŠŠé€™é‚Šçš„ log é€é filebeat é€åˆ° ELK ä¸ŠXD\nå› ç‚º GKE é€é fluentd æŠŠ GKE ä¸Šé¢çš„ log å€’åˆ° stackdriverï¼Œè€Œæˆ‘å€‘æ˜¯æƒ³æŠŠ log å€’åˆ° ELKï¼Œæ—¢ç„¶é€™æ¨£æˆ‘å€‘çš„ input ä¾†æºæ˜¯ç›¸åŒçš„ï¼Œè€Œä¸”å¾ˆå¤šè™•ç†æ­¥é©Ÿéƒ½å¯ä»¥åœ¨ ELK ä¸Šé¢äº’é€šï¼ŒçœŸçš„å¯ä»¥å·çœ‹ä¸€ä¸‹ fluentd æ˜¯å»å“ªæ”¶é›† log ï¼Œæ€éº¼è™•ç† log pipelineï¼Œæˆ‘å€‘åªè¦åšç›¸æ‡‰è¨­å®šå°±å¥½ã€‚\nç•¢ç«Ÿ google éƒ½å¹«æˆ‘å€‘å¼„å¾—å¦¥å¦¥çš„ï¼Œä¸åƒè€ƒä¸€ä¸‹ä»–çš„æµç¨‹å¤ªå¯æƒœã€‚\nå·çœ‹ä¸€ä¸‹ GKE ä¸Š fluentd æ˜¯å»å“ªæ‰¾ log ï¼Œé€™å€‹æ˜¯ fluentd gcp configmapï¼Œé›–ç„¶çœ‹åˆ°é€™é‚Šæ„Ÿè¦ºæ‰¯é äº†ï¼Œä½†å› ç‚ºå¾ˆæœ‰è¶£æ‰€æœ‰æˆ‘å°±ç¹¼çºŒçœ‹ä¸‹å»ï¼Œå„ä½å¤§å¾·å¯ä»¥è·³éXD\nconfigmap ä¸­çš„é€™å€‹ input è¨­å®šæª”ï¼Œå…¶ä¸­ä¸€å€‹ source å°±æ˜¯ä¸€å€‹è³‡æ–™ä¾†æºï¼Œç›¸ç•¶æ–¼ filebeat çš„ inputã€‚é€™é‚Šé€™å€‹ source å°±æ˜¯å» /var/log/containers/*.log æ”¶ log\né€™é‚Šé‚„åšäº†å¹¾ä»¶äº‹ï¼š\næ‰“ä¸Š reform.* tagï¼Œè®“ä¸‹å€‹ match å¯ä»¥ æ”¶é€²å» pipeline è™•ç† é™„å¸¶ parse å‡º time containers.input.conf \u0026lt;source\u0026gt; @type tail path /var/log/containers/*.log pos_file /var/log/gcp-containers.log.pos # Tags at this point are in the format of: # reform.var.log.containers.\u0026lt;POD_NAME\u0026gt;_\u0026lt;NAMESPACE_NAME\u0026gt;_\u0026lt;CONTAINER_NAME\u0026gt;-\u0026lt;CONTAINER_ID\u0026gt;.log tag reform.* read_from_head true \u0026lt;parse\u0026gt; @type multi_format \u0026lt;pattern\u0026gt; format json time_key time time_format %Y-%m-%dT%H:%M:%S.%NZ \u0026lt;/pattern\u0026gt; \u0026lt;pattern\u0026gt; format /^(?\u0026lt;time\u0026gt;.+) (?\u0026lt;stream\u0026gt;stdout|stderr) [^ ]* (?\u0026lt;log\u0026gt;.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z \u0026lt;/pattern\u0026gt; \u0026lt;/parse\u0026gt; \u0026lt;/source\u0026gt; ä»–é€™é‚Šåšä¸€äº› error handlingï¼Œç„¶å¾Œç”¨ ruby (!) parseï¼Œé€™é‚Šå°±çœŸçš„å¤ªé ï¼Œç´°ç¯€å¤§å®¶å¯ä»¥ google ï¼¸ï¼¤ã€‚ä¸éé€™é‚Šä½¿ç”¨çš„ pattern matching æˆ‘å€‘å¾Œå¹¾ç¯‡åœ¨ logstash pipeline ä¸Šï¼Œä¹Ÿæœƒæœ‰æ©Ÿæœƒæåˆ°ï¼Œæ©Ÿåˆ¶æ˜¯é¡ä¼¼çš„ã€‚\n\u0026lt;filter reform.**\u0026gt; @type parser format /^(?\u0026lt;severity\u0026gt;\\w)(?\u0026lt;time\u0026gt;\\d{4} [^\\s]*)\\s+(?\u0026lt;pid\u0026gt;\\d+)\\s+(?\u0026lt;source\u0026gt;[^ \\]]+)\\] (?\u0026lt;log\u0026gt;.*)/ reserve_data true suppress_parse_error_log true emit_invalid_record_to_error false key_name log \u0026lt;/filter\u0026gt; \u0026lt;match reform.**\u0026gt; @type record_reformer enable_ruby true \u0026lt;record\u0026gt; # Extract local_resource_id from tag for \u0026#39;k8s_container\u0026#39; monitored # resource. The format is: # \u0026#39;k8s_container.\u0026lt;namespace_name\u0026gt;.\u0026lt;pod_name\u0026gt;.\u0026lt;container_name\u0026gt;\u0026#39;. \u0026#34;logging.googleapis.com/local_resource_id\u0026#34; ${\u0026#34;k8s_container.#{tag_suffix[4].rpartition(\u0026#39;.\u0026#39;)[0].split(\u0026#39;_\u0026#39;)[1]}.#{tag_suffix[4].rpartition(\u0026#39;.\u0026#39;)[0].split(\u0026#39;_\u0026#39;)[0]}.#{tag_suffix[4].rpartition(\u0026#39;.\u0026#39;)[0].split(\u0026#39;_\u0026#39;)[2].rpartition(\u0026#39;-\u0026#39;)[0]}\u0026#34;} # Rename the field \u0026#39;log\u0026#39; to a more generic field \u0026#39;message\u0026#39;. This way the # fluent-plugin-google-cloud knows to flatten the field as textPayload # instead of jsonPayload after extracting \u0026#39;time\u0026#39;, \u0026#39;severity\u0026#39; and # \u0026#39;stream\u0026#39; from the record. message ${record[\u0026#39;log\u0026#39;]} # If \u0026#39;severity\u0026#39; is not set, assume stderr is ERROR and stdout is INFO. severity ${record[\u0026#39;severity\u0026#39;] â€¦","date":1568883989,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"c82138a78b70f3c89d82c9eb81002374","permalink":"https://chechia.net/zh-hant/post/2019-09-19-monitoring-gke-with-elk/","publishdate":"2019-09-19T17:06:29+08:00","relpermalink":"/zh-hant/post/2019-09-19-monitoring-gke-with-elk/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.","tags":["éµäººè³½2019","kubernetes","logstash","ithome","filebeat","fluentd"],"title":"Monitoring GKE With Elk","type":"post"},{"authors":[],"categories":["kubernetes","logstash"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nELK çš„ beats æ˜¯è¼•é‡ç´šçš„ç³»çµ±ç›£æ¸¬æ”¶é›†å™¨ï¼Œbeats æ”¶é›†åˆ°çš„ data ç¶“é mapping å¯ä»¥é€åˆ° Elasticsearch å¾Œï¼Œé€²è¡Œå½ˆæ€§çš„æœå°‹æ¯”å°ã€‚\nbeat æœ‰è¨±å¤šç¨®é¡ï¼Œä¾æ“šæ”¶é›†çš„ data å€åˆ¥ï¼š\nAuditbeat: Audit data Filebeat: Log files Functionbeat: Cloud data Heartbeat: Availability Journalbeat: Systemd journals Metricbeat: Metrics Packetbeat: Network traffic Winlogbeat: Windows event logs é€™é‚Šå…ˆä»¥ filebeat ç‚ºä¾‹ï¼Œåœ¨ GCE ä¸Šæ”¶é›†åœ“ç«¯æœå‹™ç¯€é»ä¸Šçš„æœå‹™æ—¥èªŒèˆ‡ç³»çµ±æ—¥èªŒï¼Œä¸¦åœ¨ ELK ä¸­å‘ˆç¾ã€‚\nInstallation å®‰è£åŠ filebeat å®‰å…¨æ€§è¨­å®šçš„æ­¥é©Ÿï¼Œåœ¨é€™ç¯‡Secure ELK Stack ä¸­å·²ç¶“èªªæ˜ã€‚é€™é‚ŠæŒ‡é™„ä¸Šé€£çµï¼Œä»¥åŠå®˜æ–¹æ–‡ä»¶ æä¾›åƒè€ƒã€‚\nConfiguration é€™é‚Šè«‡å¹¾å€‹ä½¿ç”¨æ–¹é¢çš„è¨­å®šã€‚\né¦–å…ˆï¼Œapt å®‰è£çš„ filebeat é è¨­çš„ /etc/filebeat/filebeat.yml ä¸å¤ å®Œæ•´ï¼Œæˆ‘å€‘å…ˆåˆ° github æŠŠå°æ‡‰ç‰ˆæœ¬çš„å®Œæ•´è¼‰ä¸‹ä¾†ã€‚\nwget https://raw.githubusercontent.com/elastic/beats/master/filebeat/filebeat.reference.yml sudo mv filebeat.reference.yml /etc/filebeat/filebeat.yml Beats central management beats é€éæ‰‹å‹•æ›´æ”¹ config éƒ½å¯ä»¥ç›´æ¥è¨­å®šï¼Œä½†é€™é‚Šä¸æ¨è–¦åœ¨æ­¤è¨­å®šï¼Œç†ç”±æ˜¯\nç³»çµ±ä¸­é€šå¸¸æœƒæœ‰å¤§é‡çš„ filebeatï¼Œæ¯å€‹éƒ½è¦è¨­å®šï¼Œæ•¸é‡å¤šæ™‚æ ¹æœ¬ä¸å¯èƒ½ æ›´æ”¹è¨­å®šæ™‚ï¼Œå¦‚æœä¸ä¸€èµ·æ›´æ”¹ï¼Œæœƒé€ æˆè³‡æ–™æ ¼å¼ä¸çµ±ä¸€ï¼Œä¹‹å¾Œæ¸…ç†ä¹Ÿå¾ˆéº»ç…© æ¨è–¦çš„æ–¹å¼æ˜¯é€é Kibana å°æ‰€æœ‰ filebeat åšé›†ä¸­å¼çš„çš„ç®¡ç†é…ç½®ï¼Œåªè¦åˆå§‹è¨­å®šé€£ä¸Š kibanaï¼Œå‰©ä¸‹çš„éƒ½é€é kibana è¨­å®šã€‚æ–‡ä»¶åœ¨æ­¤ï¼Œæˆ‘å€‘æœ‰ç©ºæœ‰å¯ä»¥åˆ†ç¯‡è«‡é€™å€‹ä¸»é¡Œã€‚\nä¸éé€™é‚Šé‚„æ˜¯å¾…å¤§å®¶éä¸€ä¸‹å¹¾å€‹é‡è¦çš„è¨­å®šã€‚ç•¢ç«Ÿè¦åœ¨ kibana ä¸Šé…ç½®ï¼Œfilebeat çš„è¨­å®šæ¦‚å¿µé‚„æ˜¯è¦æœ‰ã€‚\nmodules filebeat æœ‰è¨±å¤šæ¨¡çµ„ï¼Œè£¡é¢å·²ç¶“åŒ…å«è¨±å¤šé è¨­çš„ template ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ default çš„è¨­å®šå»ç³»çµ±é è¨­çš„è·¯å¾‘æŠ“å–æª”æ¡ˆï¼Œä¸¦ä¸”å…ˆé€²ä¸€æ­¥è™•ç†ï¼Œæ¸›å°‘æˆ‘å€‘è¼¸å‡ºåˆ° logstash é‚„è¦å†åš pipeline é è™•ç†ï¼Œéå¸¸æ–¹ä¾¿ã€‚\nä¾‹å¦‚é€™å€‹ system module æœƒè™•ç†ç³»çµ±é è¨­çš„ log è·¯å¾‘ï¼Œåªè¦é–‹å•Ÿ module ï¼Œå°±æœƒè‡ªå‹•è™•ç†å°æ‡‰çš„ inputã€‚\n- module: system syslog: enabled: true å‰©ä¸‹çš„å°±æ˜¯ç…§éœ€æ±‚å•Ÿç”¨ module ï¼Œä¸¦ä¸”çµ¦äºˆå°æ‡‰çš„ inputã€‚\nELK ç‚ºè‡ªå·±çš„æœå‹™è¨­å®šäº†ä¸å°‘ module ï¼Œç›´æ¥å•Ÿç”¨å°±å¯ä»¥ç²å–é€™å”æœå‹™å…ƒä»¶é‹è¡Œçš„ log èˆ‡ç›£æ¸¬æ•¸å€¼ã€‚é€™ä¹Ÿæ˜¯ self-monitoring ç›£æ¸¬æ•¸æ“šçš„ä¸»è¦ä¾†æºã€‚\n- module: kibana - module: elasticsearch - module: logstash ... input filebeat æ”¯æ´è¤‡æ•¸ inputsï¼Œæ¯å€‹ input æœƒå•Ÿå‹•ä¸€å€‹æ”¶é›†å™¨ï¼Œè€Œ filebeat æ”¶é›†ç›®æ¨™æ˜¯ log æª”æ¡ˆã€‚åŸºæœ¬ä¸Šå¯ä»¥ç°¡å–®ç†è§£ç‚º filebeat å»è®€å–é€™äº› log æª”æ¡ˆï¼Œä¸¦ä¸”åœ¨ç³»çµ±ä¸Šç´€éŒ„è®€å–çš„é€²åº¦ï¼Œåµæ¸¬åˆ° log æœ‰å¢åŠ ï¼Œè®Šç¹¼çºŒè®€å–æ–°çš„ logã€‚\nfilebeat å…·é«”çš„å·¥ä½œæ©Ÿåˆ¶ï¼Œå¯ä»¥çœ‹é€™ç¯‡How Filebeat works?\né€™ç¯‡æ–‡ä»¶ä¹Ÿæåˆ° filebeat æ˜¯ç¢ºä¿è‡³å°‘ä¸€æ¬¡(at-least-once delivery)çš„æ•¸æ“šè®€å–ï¼Œä½¿ç”¨æ™‚è¦ç‰¹åˆ¥æ³¨æ„é‡è¤‡ç²å–çš„å¯èƒ½ã€‚\né¦–å…ˆæŠŠ input åŠ ä¸Š ubuntu é è¨­çš„ log è·¯å¾‘\nfilebeat.inputs: - type: log enabled: true paths: - /var/log/*.log é€™é‚Šæ³¨æ„ input æ”¯æ´å¤šç¨® typeï¼Œåƒç…§å®Œæ•´è¨­å®šæª”æ¡ˆçš„èªªæ˜é…åˆè‡ªå·±çš„éœ€æ±‚ä½¿ç”¨ã€‚\nProcessor åœ¨ filebeat ç«¯å…ˆé€²è¡Œè³‡æ–™çš„ç¬¬ä¸€å±¤è™•ç†ï¼Œå¯ä»¥å¤§å¹…è¬›å°‘ä¸å¿…è¦çš„è³‡æ–™ï¼Œé™ä½æª”æ¡ˆå‚³è¼¸ï¼Œä»¥åŠå° elasticsearch server çš„è² æ“”ã€‚\noutput output ä¹Ÿæ˜¯ filebeat ååˆ†é‡è¦çš„ä¸€ç’°ï¼Œå¥½çš„ filebeat output è¨­å®šï¼Œå¯ä»¥å¤§å¹…é™ä½æ•´é«” ELK stack çš„è² æ“”ã€‚å£çš„è¨­å®šä¹Ÿæœƒç›´æ¥å¡çˆ† ELK staskã€‚\noutput.elasticsearch: ç›´æ¥å‘å¾Œé€é€² elasticsearch output.logstash: å…ˆå‘å¾Œé€åˆ° logstash\né€™é‚Šéå¸¸æ¨è–¦å¤§å®¶ï¼Œæ‰€æœ‰çš„ beat å¾€å¾Œé€é€² elasticsearch ä¹‹å‰éƒ½å…ˆéä¸€å±¤ logstashï¼Œå°±ç®—ä½ çš„ logstash å…§éƒ¨å®Œå…¨ä¸æ›´æ”¹ dataï¼Œæ²’æœ‰ pipeline mutationï¼Œé‚„æ˜¯ä¸è¦çœé€™ä¸€å±¤ã€‚\nbeat çš„æ•¸é‡æœƒéš¨æ‡‰ç”¨æ„ˆä¾†è¶Šå¤šè€Œç·šæ€§å¢åŠ ï¼Œelasticsearch å¾ˆé›£ç·šæ€§ scaleï¼Œæˆ–æ˜¯ scale æˆæœ¬å¾ˆå¤§ filebeat æ²’æœ‰å¥½å¥½èª¿æ ¡çš„è©±ï¼Œå°æ–¼è¼¸å‡ºç«¯çš„ç¶²è·¯è² æ“”å¾ˆå¤§ï¼Œä¸åƒ…ä½”ç”¨å¤§é‡é€£ç·šï¼Œå‚³è¼¸æª”æ¡ˆçš„å¤§å°ä¹Ÿå¾ˆå¤§ã€‚ logstash çš„ queue èˆ‡å¾Œé€çš„ batch æ©Ÿåˆ¶æ¯” filebeat å¥½ä½¿ç”¨ filebeat æ˜¯æ”¶ log çš„ï¼Œé€šå¸¸ log çˆ†ç‚¸çš„æ™‚å€™ï¼Œæ˜¯æ‡‰ç”¨å‡ºå•é¡Œçš„æ™‚å€™ï¼Œé€™æ™‚å€™éœ€è¦ log äº¤å‰æ¯”å°ï¼Œç™¼ç¾ elasticsearch æµé‡ä¹Ÿçˆ†è¡ï¼Œåæ‡‰å¾ˆæ‡‰ç”¨ logstash é€éä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥å¾ˆè¼•æ˜“çš„ scaleï¼Œç”±æ–¼ pipeline æœ¬èº«å¯ä»¥åˆ†æ•£æ˜¯å¹³è¡Œè™•ç†ï¼Œscale logstash ä¸¦ä¸æœƒå½±éŸ¿è³‡æ–™æœ€çµ‚ç‹€æ…‹ã€‚ load balance æœ‰ç¶²å‹ç•™è¨€è©¢å• logstash å‰é¢çš„ load balance å¦‚ä½•è™•ç†æ¯”è¼ƒå¥½ï¼Œæˆ‘é€™é‚Šä¹Ÿé †ä¾¿é™„ä¸Šã€‚ä¸åªæ˜¯ logstash ï¼Œæ‰€æœ‰è‡ªèº«ç„¡ç‹€æ…‹(stateless) çš„æœå‹™éƒ½å¯ä»¥ç…§é€™æ¨£å» scaleã€‚\nåœ¨ kubernetes ä¸Šå¾ˆå¥½è™•ç†ï¼Œä½¿ç”¨ k8s é è¨­çš„ service å°±è¼•æ˜“ä½œåˆ°ç°¡æ˜“çš„ load balance\nè¨­ç½®è¤‡æ•¸ logstash instances ä½¿ç”¨ kubernetes å…§éƒ¨ç¶²è·¯ service å¯¦ç¾ load balancingã€‚ åœ¨ GCE ä¸Šå¯¦ç¾çš„è©±ï¼Œæˆ‘èªªå¯¦è©±æ²’å¯¦ä½œéï¼Œæ‰€ä»¥ä»¥ä¸‹æ˜¯éµç›¤å¯¦ç¾XDã€‚\nå®˜æ–¹æ–‡ä»¶ å»ºè­°ä½¿ç”¨ beats ç«¯è¨­å®šå¤šå€‹ logstash url ä¾†åš load balancingã€‚\nä½†æˆ‘ä¸æ˜¯å¾ˆå–œæ­¡ beat å»é…ç½®å¤šå€‹ logstash url çš„ä½œæ³•ï¼šbeat è¦æ„ŸçŸ¥ logstash æ•¸é‡è·Ÿ url ï¼Œå¢åŠ æ¸›å°‘ logstash instance é‚„è¦æ›´æ”¹ beats é…ç½®ï¼Œç”¢ç”Ÿé…ç½®çš„ä¾è³´è·Ÿè€¦åˆã€‚\næœ€å¥½æ˜¯åœ¨ logstash å‰éä¸€å±¤ HAproxy æˆ–æ˜¯é›²ç«¯æœå‹™çš„ Load balancerï¼ˆex. GCP https/tcp load balancerï¼‰ï¼Œbeat ç›´æ¥é€é€² load balance çš„ç«¯é»ã€‚\nautodiscover å¦‚æœæœ‰ä½¿ç”¨ container ï¼Œä¾‹å¦‚ docker æˆ– kubernetesï¼Œç”±æ–¼ container å…§çš„ log åœ¨ä¸»æ©Ÿä¸Šçš„ä½ç½®æ˜¯å‹•æ…‹è·¯å¾‘ï¼Œé€™é‚Šå¯ä»¥ä½¿ç”¨ autodiscover å»å°‹æ‰¾ã€‚\nåœ¨ kubernetes ä¸Šé¢çš„è¨­å®šï¼Œä¹‹å¾Œæœƒå¦é–‹ä¸€å¤©è¨è«–ã€‚\ndashboard kibana é è¨­æ˜¯ç©ºçš„ï¼Œæ²’æœ‰é å…ˆè¼‰å…¥ dashboardï¼Œä½†æˆ‘å€‘æœƒå¸Œæœ›è³‡æ–™é€é€²å»ï¼Œå°±æœ‰è¨­å®šå¥½çš„ dashboard ï¼Œåœ–åƒåŒ–æŠŠè³‡æ–™å‘ˆç¾å‡ºä¾†ã€‚é€™éƒ¨ä»½éœ€è¦å¾ beat é€™é‚Šå‘ kibana å¯«å…¥ã€‚\nåœ¨ä¸Šé¢çš„éƒ¨ä»½è¨­å®šå¥½ kibana çš„é€£ç·šè³‡æ–™ï¼Œæ²’æœ‰è¨­å®šçš„è©± beat å•Ÿå‹•æœƒè­¦å‘Šã€‚\nsetup.dashboards.enabled: true ä¸€èµ·ä¸­å°±æœƒæª¢æŸ¥ kibana æ˜¯å¦æœ‰åŒ¯å…¥ dashboardï¼Œæ²’æœ‰çš„è©±å°±åŒ¯å…¥ã€‚\nä¹Ÿæœƒä¸€ä½µåŒ¯å…¥ modules çš„ dashboardï¼Œä¾‹å¦‚å¦‚æœæœ‰å•Ÿç”¨ nginx module è™•ç† nginx çš„ access logï¼Œnginx module æœƒè™•ç† request source ip ï¼Œä¸¦é€é geoip database, å°‡ ip è½‰æœƒæˆç¶“ç·¯åº¦åº§æ¨™ã€‚é€™æ™‚å¦‚æœåœ¨ kibana ä¸Šæœ‰åŒ¯å…¥ nginx dashboardï¼Œå°±å¯ä»¥çœ‹åˆ°åœ–åƒåŒ–çš„å…¨çƒ request åˆ†ä½ˆåœ–ã€‚\nå°çµ å–å¾—å®Œæ•´ filebeat è¨­å®šæª”æ¡ˆä¸¦è¨­å®š filebeat ç›¡é‡é€é beat central management ä¾†ç®¡ç† beat çš„è¨­å®šæª” å•Ÿç”¨å°æ‡‰ module ä¾†æ›´å„ªé›…çš„è™•ç† log å¾Œé€åˆ° elasticsearch å‰çš„è³‡æ–™éƒ½å¿…é ˆç¶“éç²¾ç´°çš„è™•ç†ï¼Œé€é€²å»å¾Œå°±ä¸å¥½åˆªæ”¹äº† ","date":1568805050,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"a17489478b4b0757bc9a9a46d28cf313","permalink":"https://chechia.net/zh-hant/post/2019-09-18-monitoring-gce-with-elk/","publishdate":"2019-09-18T19:10:50+08:00","relpermalink":"/zh-hant/post/2019-09-18-monitoring-gce-with-elk/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.","tags":["éµäººè³½2019","elasticsearch","devops","logstash","ithome"],"title":"Monitoring GCE With ELK","type":"post"},{"authors":[],"categories":["kubernetes","elasticsearch"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP å°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næœ‰æ¿å‹å•åˆ°ï¼Œè¦å¦‚ä½•é¸æ“‡è¦ä¸è¦ç”¨ ELKï¼Œå…¶å¯¦ä¹Ÿé€™æ˜¯æ•´ç¯‡ ELK çš„åˆè¡·ã€‚é€™é‚Šåˆ†äº«ä¸€ä¸‹ ELK èˆ‡å…¶ä»–é¸æ“‡ï¼Œä»¥åŠé¸æ“‡è§£æ±ºæ–¹æ¡ˆæ‡‰è©²è€ƒæ…®çš„äº‹æƒ…ã€‚\nå…¶ä»–å¸¸ç”¨çš„æœå‹™ Prometheus: é–‹æºçš„ time series metrics æ”¶é›†ç³»çµ±\nStackdriver: GCP çš„ log èˆ‡ metrics å¹³å°\nElastic Cloud: ELK çš„ Sass\nSelf-hosted ELK\næˆ–æ˜¯ä¾ç…§éœ€æ±‚æ··æ­ï¼Œå„å€‹æœå‹™ä½¿ç”¨çš„å„å±¤å¥—ä»¶æ˜¯å¯ä»¥ç›¸å®¹ï¼Œä¾‹å¦‚\nåœ¨ GKE ä¸Šä¸ç”¨ beat å¯ä»¥ç”¨ fluentd\nPrometheus -\u0026gt; Stackdriver\nELK -\u0026gt; Stackdriver\nFluentd -\u0026gt; Prometheus â€¦\nSass vs cloud self-hosted vs on-premised\nMetrics: ELK vs Prometheus vs Stackdriver\nLogging: ELK vs Stackdriver\nå–æ¨åŸå‰‡ å„å€‹æ–¹æ³•éƒ½å„æœ‰åˆ©å¼Šï¼Œå®Œå…¨å–æ±ºæ–¼éœ€æ±‚\nå·²çŸ¥æ¢ä»¶é™åˆ¶ï¼Œä¾‹å¦‚å®‰å…¨æ€§è€ƒé‡å°±æ˜¯è¦æ”¾åœ¨ç§æœ‰ç¶²è·¯é˜²ç«ç‰†å…§ï¼Œæˆ–æ˜¯é ç®— è³‡æ–™è®€å–æ–¹å¼ï¼Œæœ‰æ²’æœ‰è¦äº¤å‰æ¯”å°æ”¶é›†çš„è³‡æ–™ï¼Œé‚„æ˜¯å–®ç´”ä¾ç…§æ™‚é–“åºæŸ¥è©¢ æˆ–æ˜¯è³‡æ–™é‡éå¸¸å¤§ï¼Œæ‡‰ç”¨æ•¸é‡éå¸¸å¤š ç¶­è­·çš„åœ˜éšŠï¼Œæœ‰æ²’æœ‰æƒ³ï¼Œæˆ–æœ‰æ²’æœ‰èƒ½åŠ›è‡ªå·±é¤Š self-host æœå‹™ Sass vs Self-hosted vs On-premised Sass: æŒ‡çš„æ˜¯ç›´æ¥ç”¨ Elasitc Cloudï¼Œæˆ–æ˜¯ç›´æ¥ä½¿ç”¨å…¬æœ‰é›²çš„æœå‹™(ex. åœ¨ GCP ä¸Šä½¿ç”¨ stackdriver)\nCloud Self-hosted: åœ¨å…¬æœ‰é›²ä¸Šä½¿ç”¨ ELK\nOn-Premised: è‡ªå·±åœ¨æ©Ÿæˆ¿æ­è¨­\nå®‰å…¨æ€§ çœ‹å…¬å¸çš„å®‰å…¨æ”¿ç­–ï¼Œå…è¨±å°‡æ—¥èªŒåŠç›£æ§æ•¸æ“šï¼Œé€åˆ°ç§æœ‰ç¶²è·¯ä»¥å¤–çš„åœ°æ–¹å—ï¼Ÿå¦‚æœåœ¨é˜²ç«ç‰†å…§ï¼Œæä¸å¥½ port æ ¹æœ¬å°±ä¸é–‹çµ¦ä½ ï¼Œæ ¹æœ¬ä¸ç”¨è€ƒæ…®ä½¿ç”¨å¤–éƒ¨æœå‹™ã€‚\nè¦çŸ¥é“æœå‹™çš„ log å…¶å¯¦å¯ä»¥çœ‹å‡ºå¾ˆå¤šæ±è¥¿ï¼å¦‚æœæœ‰ç‰¹åˆ¥åšè³‡æ–™åˆ†æï¼Œæ•æ„Ÿçš„è³‡æ–™ï¼Œé‡‘æµç›¸é—œæ•¸æ“šï¼Œé€šå¸¸ä¸æœƒæƒ³è¦å€’åˆ°ç¬¬ä¸‰æ–¹æœå‹™å¹³å°ã€‚\nå¯èƒ½æœ‰åšé‡‘æµçš„ï¼Œå…‰æ˜¯å®‰å…¨æ€§é€™é»ï¼Œå°±å¿…é ˆé¸æ“‡è‡ªæ¶ã€‚\næˆæœ¬ é‡‘éŒ¢æˆæœ¬ + ç¶­è­·æˆæœ¬\né‡‘éŒ¢æˆæœ¬å°±çœ‹å„å€‹æœå‹™çš„è¨ˆè²»æ–¹å¼\nElastic Cloud Pricing Self-hosted ELK \u0026amp; Prometheusï¼šæ©Ÿå™¨æˆæœ¬ å…¬æœ‰é›²æœå‹™(ex. GCP Stackdriver): ç”¨é‡è¨ˆè²» ç¶­è­·æˆæœ¬: å·¥ç¨‹å¸«çš„æœˆè–ª * æ¯å€‹æœˆè¦èŠ±åœ¨ç¶­è­·æœå‹™çš„å·¥æ™‚æ¯”ä¾‹\nä¸€èˆ¬ Sass ä»£ç®¡çš„æœå‹™ï¼Œæœƒé™ä½ç¶­è­·æˆæœ¬ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯åšåˆ°ç¶²é é»ä¸€é»å°±å¯ä»¥ç”¨ã€‚\nå¦‚æœå…¬å¸æœ‰å®Œæ•´çš„ç¶­è­·åœ˜éšŠï¼Œæœ‰æ©Ÿæˆ¿ï¼Œæœå‹™çš„ä½¿ç”¨é‡ä¹Ÿå¾ˆå¤§ï¼Œç•¶ç„¶ self-hosted æ˜¯æ¯”è¼ƒçœã€‚ ä¸­å°å‹ä¼æ¥­ä»¥åŠæ–°å‰µï¼Œæœå‹™åœ¨å…¬æœ‰é›²ä¸Šçš„ï¼Œç›´æ¥ä½¿ç”¨Sass æœå‹™å¾€å¾€æ¯”è¼ƒç¯€çœæˆæœ¬ï¼Œæœå‹™ç›´æ¥ç”± Sass ç¶­è­·ï¼Œç¯€çœå¾ˆå¤šæ©Ÿå™¨ä¸Šç®¡ç†è·Ÿæ—¥å¸¸ç¶­è­·ã€‚\né¿å…è¿·æ€ï¼Œè²·å¤–éƒ¨æœå‹™çš„å¸³å–®æ˜¯é¡¯æ€§çš„ï¼Œå ±å¸³æ™‚çœ‹å¾—åˆ°ï¼Œè€Œå·¥ç¨‹å¸«ç¶­è­·çš„æ™‚é–“æˆæœ¬æ˜¯éš±æ€§çš„ã€‚self-host å¯èƒ½çœä¸‹ Sass è²»ç”¨ï¼Œä½†å·¥ç¨‹å› ç‚ºåˆ†äº†æ™‚é–“å»ç¶­è­·ï¼Œè€Œå½±éŸ¿é€²åº¦ã€‚é€™éƒ¨åˆ†å°±çœ‹åœ˜éšŠå¦‚ä½•å–æ¨ã€‚\næ˜“ç”¨æ€§ å¦‚æœæ‡‰ç”¨éƒ½è·‘åœ¨å…¬æœ‰é›²ä¸Šï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨é›²å¹³å°æä¾›çš„ç›£æ¸¬æœå‹™ï¼Œä½¿ç”¨ä¾¿åˆ©ï¼Œè€Œä¸”æ•´åˆåº¦é«˜ã€‚ex GCP ä¸Šï¼Œè¦å•Ÿç”¨ Stackdriver æ˜¯éå¸¸è¼•é¬†çš„äº‹æƒ…ï¼Œåªæ˜¯æ”¹ä¸€å…©å€‹é¸é …ï¼Œå°±å¯ä»¥é–‹å•Ÿ / é—œé–‰ logging èˆ‡ metrics\nå¦‚æœæ˜¯ On-premised è‡ªå®¶æ©Ÿæˆ¿ï¼Œä¹Ÿè¨± self-hosted æœƒæ›´ç‚ºé©åˆã€‚\nå®¢è£½åŒ–ç¨‹åº¦ åœ¨å¤§å¤šæ•¸æ™‚å€™ï¼Œæ²’æœ‰éœ€è¦æ›´æ”¹åˆ°æœå‹™çš„æ ¸å¿ƒè¨­å®šï¼Œéƒ½å¯ä»¥ä¸å¯å¾‹å®¢è£½åŒ–ç¨‹åº¦ï¼Œç›´æ¥ä½¿ç”¨ Sass çš„è¨­å®šï¼Œå°±èƒ½æ»¿è¶³å¤§éƒ¨åˆ†éœ€æ±‚ã€‚å¯ä»¥ç­‰æœ‰æœ‰æ˜ç¢ºéœ€æ±‚å¾Œå†è€ƒæ…®é€™ä¸€é»ã€‚çŸ­æœŸå…§æ²’æœ‰ç‰¹æ®Šéœ€æ±‚å°±å¯ä»¥å¾ç°¡ä½¿ç”¨ã€‚\nä½¿ç”¨GKE åˆ° Stackdriver çš„è©±ï¼Œå°ä¸»æ©Ÿæœ¬èº«çš„æ©Ÿå™¨æ˜¯æ²’æœ‰æ§åˆ¶æ¬Šçš„ï¼ŒåŸ·è¡Œçš„ pipeline ä¹Ÿä¸å¤ªèƒ½æ›´æ”¹ Elastic Cloud æœ‰æä¾›ä¸Šå‚³ elasticsearch config æª”æ¡ˆçš„ä»‹é¢ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ›´æ”¹ server é‹è¡Œçš„åƒæ•¸è¨­å®š Self-Hosted é™¤äº†ä¸Šè¿°çš„è¨­å®šï¼Œé‚„å¯ä»¥ä¾ç…§éœ€æ±‚æ›´æ”¹ ELK / prometheus æœå‹™ï¼Œåœ¨å¯¦é«”æ©Ÿå™¨ä¸Šçš„ topologyï¼Œcpu è¨˜æ†¶é«”çš„è³‡æºé…ç½®ï¼Œå„²å­˜ç©ºé–“é…ç½®ç­‰ï¼Œå¯ä»¥æœ€å¤§åŒ–æ©Ÿå™¨çš„æ•ˆèƒ½ã€‚\nScalability è³‡æ–™æµé‡å¤§ï¼Œå„²å­˜ç©ºé–“æ¶ˆè€—å¤šï¼Œæœå‹™è² æ“”å¤§ï¼Œå¯èƒ½å°±æœƒéœ€è¦æ“´å±•ã€‚\nä¸€å€‹æ˜¯è³‡æ–™é‡çš„æ“´å±•ã€‚ä¸€å€‹æ˜¯ç‚ºäº†æ‡‰ä»˜æœå‹™çš„è² æ“”ï¼Œå° ELK æœå‹™å…ƒä»¶åšæ°´å¹³æ“´å±•ã€‚\né™¤äº† elasticsearch ä»¥çˆ²çš„å…ƒä»¶ï¼Œä¾‹å¦‚ kibanaï¼Œapm-server, beats éƒ½å¯ä»¥é€é kubernetes è¼•æ˜“çš„æ“´å±•ï¼Œå”¯æœ‰ elasticsearch ï¼Œç”±æ–¼åˆç‰½æ‰¯ä¸Šè¿°è³‡æ–™é‡çš„æ“´å±•ï¼Œä»¥åŠåˆ†ä½ˆï¼Œé‚„æœ‰å‰¯æœ¬ç®¡ç†ï¼Œindex æœ¬èº«çš„ lifecycle ç®¡ç†ã€‚Elasticsearch çš„ scaling è¨­å®šä¸Šæ˜¯è »è¤‡é›œçš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šå·¥è¦åšã€‚index çš„ shards / replicas è¨­å®šéƒ½è¦æ³¨æ„åˆ°ã€‚å¦å‰‡ä¸€è·¯ scale ä¸Šå»ï¼Œé›†ç¾¤å¤§çš„æ™‚å€™å½¼æ­¤ sharding sync çš„æ•ˆèƒ½æ¶ˆè€—æ˜¯å¦æœƒå¤ªé‡ã€‚\nStackdriver å¾ä½¿ç”¨è€…çš„è§’åº¦ï¼Œæ˜¯ä¸å­˜åœ¨æœå‹™ç¯€é»çš„æ“´å±•å•é¡Œï¼Œç¯€é»çš„ç¶­è­·å…¨éƒ½çµ¦ Sass ç®¡ç†ã€‚è³‡æ–™é‡çš„æ“´å±•å•é¡Œä¹Ÿä¸å¤§ï¼Œåªè¦æ•´ç†è³‡æ–™ pipelineï¼Œè®“æœ€å¾Œå„²å­˜çš„è³‡æ–™å®¹æ˜“è¢«æŸ¥æ‰¾ã€‚\nTimeseries vs non-timeseriese Prometheus æ˜¯è‡ªå¸¶ time series databaseï¼Œstackdriver ä¹Ÿæ˜¯ time series çš„å„²å­˜ã€‚ELK çš„ elasticsearch æ˜¯å…¨æ–‡æœç´¢å¼•æ“ï¼Œç”¨äº† timestamp åšåˆ†ææ‰€ä»¥å¯ä»¥åšåˆ° time series çš„è³‡æ–™ç´€éŒ„èˆ‡åˆ†æã€‚é€™é»åœ¨æœ¬è³ªä¸Šæ˜¯å®Œå…¨ä¸åŒçš„ã€‚\nå…‰åªè™•ç† time series dataï¼ŒPrometheus çš„ query æ•ˆèƒ½æ˜¯æ¯” elasticsearch å¥½å¾ˆå¤š Elasticsearch æœ‰å¤§é‡çš„ index ç¶­è­·ï¼Œéœ€è¦è¼ƒå¤šç³»çµ±è³‡æºè™•ç†ï¼Œåœ¨æ²’æœ‰ query å£“åŠ›çš„æƒ…å½¢ä¸‹æœƒæœ‰ç³»çµ±è‡ªå‹•ç¶­è­·çš„æ•ˆèƒ½æ¶ˆè€— ELK çš„è³‡æ–™ä¸éœ€è¦é å…ˆå»ºæ¨¡ï¼Œå°±å¯ä»¥åšåˆ°éå¸¸å½ˆæ€§çš„æœå°‹æŸ¥æ‰¾ã€‚Stackdriver çš„è©±ï¼Œç„¡æ³•ç”¨æœªå»ºæ¨¡çš„è³‡æ–™æ¬„ä½äº¤å‰æŸ¥æ‰¾ã€‚ Log æ”¶é›†æ–¹é¢ Elasticsearch ä¸­çš„è³‡æ–™æ¬„ä½é€é tempalte åŒ¯å…¥å¾Œï¼Œéƒ½æ˜¯æœ‰åš index ï¼Œæ‰€ä»¥äº¤å‰æŸ¥æ‰¾ï¼Œä¾‹å¦‚å¯ä»¥å¾ log text ä¸­åŒ…å«ç‰¹å®šå­—ä¸²çš„ç´€éŒ„ï¼Œåœ¨åš aggregate ç®—å‡ºå…¶ä»–æ¬„ä½çš„è³‡æ–™åˆ†ä½ˆã€‚æœƒæ¯”è¼ƒæ…¢ï¼Œä½†æ˜¯æ˜¯åšå¾—åˆ°çš„å…¨æ–‡æœç´¢ Stackdriver å¯ä»¥åšåŸºæœ¬çš„ filter ï¼Œä¾‹å¦‚ filter æŸå€‹æ¬„ä½ï¼Œä½†ä¸èƒ½åšå¤ªè¤‡é›œçš„äº¤å‰æ¯”å°ï¼Œä¹Ÿä¸èƒ½é‡å° text å…§å®¹ä½œäº¤äº’æŸ¥æ‰¾ï¼Œéœ€è¦æ›å‡ºä¾†å¦å¤–è™•ç†ã€‚ Metrics æ”¶é›†æ–¹é¢ (åŒä¸Š) Elasticsearch å¯ä»¥ç”¨å…¨æ–‡æœç´¢ï¼Œåšåˆ°å¾ˆè¤‡é›œçš„äº¤å‰æ¯”å°ï¼Œä¾‹å¦‚ï¼šå¾ metrics æ•¸å€¼ï¼Œè¨ˆç®—åœ¨æ™‚é–“ç¯„åœçš„åˆ†ä½ˆæƒ…å½¢(cpu è¶…é 50% è½åœ¨ä¸€å¤© 24 å°æ™‚ï¼Œå„å€‹å°æ™‚çš„æ¬¡æ•¸) Stackdriver åªèƒ½åšåŸºæœ¬çš„ time series æŸ¥æ‰¾ï¼Œç„¶å¾Œé€éé å…ˆå®šç¾©å¥½çš„ field filter è³‡æ–™ï¼Œå†å„è‡ªåœ–åƒåŒ–ã€‚ Prometheus ä¹Ÿæ˜¯å¿…é ˆä¾ç…§ time series æŸ¥æ‰¾ï¼Œèªæ³•ä¸Šå½ˆæ€§æ¯” stackdriver å¤šå¾ˆå¤šï¼Œä½†ä¾æ¨£ä¸èƒ½æœå°‹æ²’æœ‰ index çš„æ¬„ä½ é€™é‚Šè¦æ›¿åˆ¥æï¼Œé›–ç„¶ Elasticsearch èƒ½ç”¨å…¨æ–‡æœç´¢è¼•æ˜“åœ°åšåˆ°è¤‡é›œçš„æŸ¥è©¢èªæ³•ï¼Œä½†ä»¥ metrics ä¾†èªªï¼Œå…¶å¯¦æ²’æœ‰å¤ªå¤šè·³è„« time series æŸ¥æ‰¾çš„éœ€æ±‚ã€‚èƒ½åšåˆ°ï¼Œä½†æœ‰æ²’æœ‰å¿…è¦é€™æ¨£åšï¼Œå¯ä»¥æ‰“å€‹å•è™Ÿã€‚ å€‹äººå¿ƒå¾—ï¼Œå¦‚æœé©—è­‰å…¨æ–°çš„ business modelï¼Œæˆ–æ˜¯é‚„ä¸ç¢ºå®šçš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ ELK åšå„ç¨®è¤‡é›œçš„æŸ¥è©¢\nå¦‚æœéœ€æ±‚æ˜ç¢ºï¼Œæ”¶é€²ä¾†çš„ log è™•ç†æµç¨‹éƒ½å¾ˆæ˜ç¢ºï¼Œä¹Ÿè¨±ä¸ç”¨ä½¿ç”¨ ELKã€‚\nè«–ç³»çµ±è³‡æº CP å€¼ä»¥åŠæ•ˆèƒ½ï¼Œtime series çš„ db éƒ½æœƒæ¯” Elasticsearch å¥½ä¸Šä¸å°‘ã€‚ Elasticsearch ä¸­ä¹Ÿä¸å¤ªé©åˆä¸€ç›´å­˜æ”¾å¤§é‡çš„è³‡æ–™åœ¨ hot å¯å¯«å¯è®€ç‹€æ…‹ï¼Œç¹ªå¸Œå¥½å¾ˆå¤šç³»çµ±è³‡æºã€‚ å…¶ä»–æœå‹™ Elastic æœ‰å‡ºè¨±å¤šä¸åŒçš„å¢å€¼æœå‹™\nApplication Performance Monitoring(APM) Realtime User Monitoring(RUM) Machine Learning(ELK ML) è€Œ ELK ä»¥å¤–ä¹Ÿéƒ½æœ‰ä¸åŒçš„è§£æ±ºæ–¹æ¡ˆï¼Œä¾‹å¦‚\nGCP ä¹Ÿå‡ºäº†è‡ªå·±çš„ APM Sass Google Analytics(GA) ä¸åƒ…èƒ½åšå¤šæ¨£çš„å‰ç«¯ä½¿ç”¨è€…è¡Œç‚ºåˆ†æï¼Œé‚„èƒ½æ•´åˆ Google æ”¶é›†åˆ°çš„ä½¿ç”¨è€…è¡Œç‚ºï¼Œåšæ›´å¤šç¶­åº¦çš„åˆ†æ ç›¸è¼ƒä¹‹ä¸‹ ELK åœ¨é€™å¡Šå…¶å¯¦æ²’æœ‰ç‰¹åˆ¥å„ªå‹¢ã€‚\nElastic Cloud æˆ‘é€™é‚Šè¦ç‰¹åˆ¥èªª Elastic Cloud vs ELK\nElatic Cloud çš„é‹è¡Œæ–¹å¼ï¼Œæ˜¯ä»£ç‚ºå‘å…¬èˆ‡æ©å¹³å°(aaws, gcp,â€¦)ï¼Œå¸¶å®¢æˆ¶å‘å¹³å°ç§Ÿç”¨æ©Ÿå™¨ï¼Œç„¶å¾ŒæŠŠ ELK æœå‹™éƒ¨ç½²åˆ°ç§Ÿç”¨çš„æ©Ÿå™¨ä¸Šã€‚ç”¨æˆ¶é€™é‚Šç„¡æ³•ç›´æ¥å­˜å–æ©Ÿå™¨ï¼Œåªèƒ½é€é ELK ä»‹é¢æˆ–æ˜¯ Kibana , API é€²å…¥ ELKã€‚Elastic Cloud æœƒç›£æ§ç„¡èª¤ç¯€é»çš„ç‹€æ³ï¼Œä¸¦åšåˆ°ä¸€å®šç¨‹åº¦çš„ä»£ç®¡ã€‚\né€™é‚ŠæŒ‡çš„ä¸€å®šç¨‹åº¦çš„ä»£ç®¡ï¼Œæ˜¯ Elastic Cloud åªæ˜¯ä»£ç‚ºéƒ¨ç½²æœå‹™ï¼Œç›£æ§ã€‚æœ‰æ•…éšœæ™‚ä¸¦ä¸è² è²¬æ’é™¤ï¼Œå¦‚æœ ELK æ•…éšœï¼Œç°¡å–®çš„å•é¡Œï¼ˆex. è¨˜æ†¶é«”è³‡æºä¸è¶³ï¼‰æœƒä»£ç‚ºé‡é–‹æ©Ÿå™¨ï¼Œä½†å¦‚æœæ˜¯è¤‡é›œçš„å•é¡Œï¼Œé‚„æ˜¯è¦ç”¨æˆ¶è‡ªå·±è™•ç†ï¼ä½†æ˜¯ç”¨æˆ¶åˆæ²’æœ‰ä¸»æ©Ÿç¯€é»çš„ç›´æ¥å­˜å–æ¬Šé™ï¼Œæ‰€ä»¥å¯èƒ½æœƒé€ æˆæœå‹™å¡ä½ç„¡æ³•å•Ÿå‹•ï¼Œåªèƒ½é€é Elastic Cloud çš„ç®¡ç†ä»‹é¢å˜—è©¦ä¿®å¾©ã€‚\nä½¿ç”¨æœå‹™é™¤äº†æŠŠæœå‹™éƒ½æ¶è¨­å®Œä»¥å¤–ï¼Œé‚„æ˜¯éœ€è¦å®šæœŸè¦èŠ±æ™‚é–“è™•ç† performance tuningï¼Œè¨­å®šå®šæœŸæ¸…ç†è·Ÿç¶­è­·ã€‚åŒ…æ‹¬ kafka, redis, mongoDB, cassandra, SQLsâ€¦éƒ½æ˜¯ä¸€æ¨£ï¼Œæ¶æ§‹è¶Šè¤‡é›œï¼Œæ•ˆèƒ½è¦æ±‚è¶Šé«˜ï¼Œé€™éƒ¨åˆ†çš„å·¥éƒ½æœƒæ›´å¤šã€‚å¦‚æœå…¬å¸æœ‰ DBAï¼Œæˆ–æ˜¯å°ˆè·ç¶­è­·å·¥ç¨‹å¸«ï¼Œé‚£æ­å–œå°±ä¸ç”¨ç…©æƒ±ã€‚\nElasticsearch server ç›®å‰ç”¨èµ·ä¾†ï¼Œç®—æ˜¯æ˜¯æ•¸æœå‹™ä¸­ï¼Œç¶­è­·ä¸ŠæœƒèŠ±æ¯”è¼ƒå¤šæ™‚é–“çš„æœå‹™ã€‚\nå› ç‚ºå¼•æ“æœ¬èº«è¨­è¨ˆçš„æ¶æ§‹ï¼Œä¸¦ä¸æ˜¯å¾ˆå¤šäººéƒ½ç†Ÿæ‚‰ã€‚åœ¨ä½¿ç”¨ELKåŒæ™‚ï¼Œå°ELKåº•å±¤å¼•æ“çš„é‹ä½œæµç¨‹æœ‰å¤šç†Ÿæ‚‰ï¼Œæœƒç›´æ¥å½±éŸ¿ç©©å®šæ€§è·Ÿè·‘å‡ºä¾†çš„æ•ˆèƒ½ã€‚ éœ€è¦å¥½å¥½è™•ç†è¨­è¨ˆè³‡æ–™çš„å„²å­˜ï¼Œå¦‚æœä½¿ç”¨ä¸Šæ²’è™•ç†å¥½ï¼Œæœƒç›´æ¥è®“æ•´å€‹ELK æ›æ‰ã€‚ ç„¶å¾Œç”¢å“æœ¬èº«çš„ç¶­è­·ä»‹é¢ï¼Œç›®å‰åªæ˜¯åœ¨å ªç”¨ï¼Œè¨±å¤šé‡è¦çš„åŠŸèƒ½ä¹Ÿé‚„åœ¨é–‹ç™¼ä¸­ã€‚ å¦‚æœå…¬å¸æœ‰äººæœƒç®¡ ELKï¼Œå€‹äººå»ºè­°æ˜¯å¯ä»¥ self-host\nå°çµ å¼„æ¸…æ¥šéœ€æ±‚ï¼Œå¦‚æœæ²’æœ‰ç‰¹æ®Šéœ€æ±‚å¯ä»¥èµ° general solution Sass vs Self-hosted vs On-premised Time series vs non time series ","date":1568803900,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"87215dda18fd365acbb8f996f725c08c","permalink":"https://chechia.net/zh-hant/post/2019-09-18-elastic-or-not-elastic/","publishdate":"2019-09-18T18:51:40+08:00","relpermalink":"/zh-hant/post/2019-09-18-elastic-or-not-elastic/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP å°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.","tags":["éµäººè³½2019","elasticsearch","devops"],"title":"ELK or Not ELK","type":"post"},{"authors":[],"categories":["kubernetes","certificate"],"content":"ç°¡å–®è¬›ä¸€ä¸‹ certificate X.509 æ˜¯å…¬é‘°æ†‘è­‰(public key certificate) çš„ä¸€å¥—æ¨™æº–ï¼Œç”¨åœ¨å¾ˆå¤šç¶²è·¯é€šè¨Šå”å®š (åŒ…å« TLS/SSL)\ncertificate åŒ…å«å…¬é‘°åŠè­˜åˆ¥è³‡è¨Š(hostname, organization, â€¦ç­‰è³‡è¨Š)\ncertificate æ˜¯ç”± certificate authority(CA) ç°½ç½²ï¼Œæˆ–æ˜¯è‡ªç°½(Self-signed)\nä½¿ç”¨ browser é€£å…¥ https serveræ™‚ï¼Œæœƒæª¢æŸ¥ server çš„ certificate æ˜¯å¦æœ‰æ•ˆï¼Œç¢ºå®šé€™å€‹ server çœŸçš„æ˜¯åˆæ³•çš„ site\nåœ¨ elastic stack ä¸Šï¼Œå¦‚æœæœ‰å¤šå€‹ elasticsearch server node å½¼æ­¤é€£ç·šï¼Œç”±æ–¼ node å½¼æ­¤æ˜¯ client ä¹Ÿæ˜¯ server\nä½¿ç”¨ self-signed CA ç”¢å‡ºä¾†çš„ certificateï¼Œé€£å…¥æ™‚æœƒæª¢æŸ¥ä½¿ç”¨çš„ certificate æ˜¯å¦ç”±åŒä¸€çµ„ CA ç°½ç½² server ä½¿ç”¨ certificateï¼Œç¢ºå®šé€£å…¥ server çš„ client éƒ½å¸¶æœ‰æ­£ç¢ºçš„ç§é‘°èˆ‡ public certificateï¼Œæ˜¯ authenticated user é™„å¸¶èªªæ˜ï¼ŒX.509 æœ‰å¤šç¨®æª”æ¡ˆæ ¼å¼\n.pem .cer, .crt, .der .p12 .p7b, .p7c â€¦ å¦å¤–æª”æ¡ˆæ ¼å¼å¯ä»¥æœ‰å…¶ä»–ç”¨é€”ï¼Œä¹Ÿå°±æ˜¯èªªè£¡é¢è£çš„ä¸ä¸€å®šæ˜¯ X.509 æ†‘è­‰\nCA $ openssl pkcs12 -in /etc/elasticsearch/config/elastic-stack-ca.p12 -info -nokeys MAC: sha1, Iteration 100000 MAC length: 20, salt length: 20 PKCS7 Data Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration 50000 PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration 50000 Certificate bag Bag Attributes friendlyName: ca localKeyID: subject=CN = Elastic Certificate Tool Autogenerated CA issuer=CN = Elastic Certificate Tool Autogenerated CA -----BEGIN CERTIFICATE----- -----END CERTIFICATE----- issuer command name ç‚º Elastic autogen CA subject command name ç‚º Elastic autogen CA\nhttps://shazi.info/openssl-%E6%AA%A2%E6%B8%AC-ssl-%E7%9A%84%E6%86%91%E8%AD%89%E4%B8%B2%E9%8D%8A-certificate-chain/\nopenssl s_client -connect google.com https://medium.com/@superseb/get-your-certificate-chain-right-4b117a9c0fce\nopenssl verify -CAfile client-ca.cer client.cer openssl verify -show_chain -CAfile client-ca.cer client.cer Certificate ç”¨ openssl å·¥å…·çœ‹ä¸€ä¸‹å…§å®¹ï¼Œå¦‚æœæœ‰å¯†ç¢¼é€™é‚Šè¦ç”¨å¯†ç¢¼è§£é–\n$ openssl pkcs12 -in /etc/elasticsearch/config/elastic-certificates.p12 -info -nokeys MAC: sha1, Iteration 100000 MAC length: 20, salt length: 20 PKCS7 Data Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration 50000 PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration 50000 Certificate bag Bag Attributes friendlyName: elk.asia-east1-b.c.machi-x.internal localKeyID: subject=CN = elk.asia-east1-b.c.machi-x.internal issuer=CN = Elastic Certificate Tool Autogenerated CA -----BEGIN CERTIFICATE----- -----END CERTIFICATE----- Certificate bag Bag Attributes friendlyName: ca 2.16.840.1.113894.746875.1.1: \u0026lt;Unsupported tag 6\u0026gt; subject=CN = Elastic Certificate Tool Autogenerated CA issuer=CN = Elastic Certificate Tool Autogenerated CA -----BEGIN CERTIFICATE----- -----END CERTIFICATE----- ","date":1568686536,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"6404fe1bfa57bcb3873536bc50dedd6a","permalink":"https://chechia.net/zh-hant/post/2020-09-17-x.509-certificate/","publishdate":"2019-09-17T10:15:36+08:00","relpermalink":"/zh-hant/post/2020-09-17-x.509-certificate/","section":"post","summary":"ç°¡å–®è¬›ä¸€ä¸‹ certificate X.509 æ˜¯å…¬é‘°æ†‘è­‰(public key certificate) çš„ä¸€å¥—æ¨™æº–ï¼Œç”¨åœ¨å¾ˆå¤šç¶²è·¯é€šè¨Šå”å®š (åŒ…å« TLS/SSL)\ncertificate åŒ…å«å…¬é‘°åŠè­˜åˆ¥è³‡è¨Š(hostname, organization, â€¦ç­‰è³‡è¨Š)\ncertificate æ˜¯ç”± certificate authority(CA) ç°½ç½²ï¼Œæˆ–æ˜¯è‡ªç°½(Self-signed)\nä½¿ç”¨ browser é€£å…¥ https serveræ™‚ï¼Œæœƒæª¢æŸ¥ server çš„ certificate æ˜¯å¦æœ‰æ•ˆï¼Œç¢ºå®šé€™å€‹ server çœŸçš„æ˜¯åˆæ³•çš„ site","tags":["kubernetes","tls","certificate"],"title":"X.509 certificate","type":"post"},{"authors":[],"categories":["kubernetes","elasticsearch"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP å°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nâ€“\nä¸Šç¯‡Self-host ELK stack on GCP ä»‹ç´¹äº†ï¼Œelk stack åŸºæœ¬çš„å®‰è£ï¼Œå®‰è£å®Œç²å¾—ä¸€å€‹åªæ”¯æ´ http (è£¸å¥”)çš„ elk stackï¼Œæ²’æœ‰ https åœ¨å…¬é–‹ç¶²è·¯ä¸Šä½¿ç”¨æ˜¯éå¸¸å±éšªçš„ã€‚é€™ç¯‡è¦ä¾†ä»‹ç´¹å¦‚ä½•åšå®‰å…¨æ€§è¨­å®šã€‚\nå®˜æ–¹çš„æ–‡ä»¶åœ¨é€™è£¡ï¼Œç¢å¿µä¸€ä¸‹ï¼Œé™¤éå° ELK çš„åŠŸèƒ½æœ‰ä¸€å®šäº†è§£ï¼Œä¸ç„¶é€™ä»½çœŸçš„ä¸æ˜¯å¾ˆå‹å–„ã€‚å»ºè­°å¾å®˜æ–¹æ–‡ä»¶åº•ä¸‹çš„Tutorial: Getting started with security é–‹å§‹ï¼Œéç¨‹æ¯”è¼ƒä¸æœƒé€™éº¼è¡€å°¿ã€‚\nç¸½ä¹‹ç‚ºäº†å•Ÿç”¨ authentication \u0026amp; httpsï¼Œé€™ç¯‡è¦åšçš„äº‹æƒ…ï¼š\nenable x-pack \u0026amp; activate basic license Generate self-signed ca, server certificate, client certificate Configure Elasticsearch, Kibana, \u0026amp; other components to use server certificate when act as server use client certificate when connect to an ELK server å•Ÿç”¨ X-pack Elasticsearch çš„å®‰å…¨æ€§æ¨¡çµ„ç”± x-pack extension æä¾›ï¼Œåœ¨ 6.3.0 ä¹‹å¾Œçš„ç‰ˆæœ¬ï¼Œå®‰è£ elasticsearch çš„éç¨‹ä¸­å°±é è¨­å®‰è£ x-packã€‚\né™„ä¸Šå•Ÿç”¨çš„å®˜æ–¹æ–‡ä»¶\nç„¶è€Œï¼Œç”±æ–¼èˆŠç‰ˆçš„ x-pack æ˜¯ä»˜è²»å…§å®¹ï¼Œç›®å‰çš„ elasticsearch å®‰è£å®Œå¾Œï¼Œelasticsearch.yml è¨­å®šé è¨­ä¸å•Ÿç”¨ x-packï¼Œä¹Ÿå°±æ˜¯èªªæ²’çœ‹åˆ°é€™ç¯‡å®˜æ–¹æ–‡ä»¶çš„è©±ï¼Œå¾ˆå®¹æ˜“å°±ç²å¾—æ²’æœ‰ä»»ä½• security åŠŸèƒ½çš„ ELKã€‚\né›–ç„¶ç›®å‰å·²ç¶“å¯ä»¥ä½¿ç”¨å…è²»çš„ basic license ä½¿ç”¨ security åŠŸèƒ½ï¼Œé‚„æ˜¯å¸Œæœ›å®˜æ–¹å¯ä»¥ default å•Ÿç”¨ securityã€‚\n$ sudo vim /etc/elasticsearch/elasticsearch.yml xpack.security.enabled: true xpack.license.self_generated.type: basic discovery.type: single-node æˆ‘å€‘é€™é‚Šå•Ÿç”¨ xpack.securityï¼ŒåŒæ™‚å°‡ self-generated license ç”Ÿå‡ºä¾†ï¼Œæˆ‘å€‘é€™é‚Šåªä½¿ç”¨åŸºæœ¬çš„ basic subscriptionã€‚è‹¥å¸Œæœ›å•Ÿç”¨æ›´å¤šåŠŸèƒ½ï¼Œå¯ä»¥çœ‹å®˜æ–¹subcription æ–¹æ¡ˆä»‹ç´¹\nå¦å¤–ï¼Œå¦‚æœä¸åŒæ™‚è¨­å®šç‚º single-node çš„è©±ï¼Œé è¨­æœƒå°‹æ‰¾å…¶ä»–elasticsearch node ä¾†çµ„æˆ clusterï¼Œè€Œæˆ‘å€‘å°±å¿…é ˆè¦åœ¨æ‰€æœ‰ node ä¸Šå•Ÿç”¨ securityï¼Œé€™ç¯‡åªå¸¶å¤§å®¶åšä¸€å€‹ single node clusterï¼Œç°¡åŒ–æ­¥é©Ÿã€‚\né‡å•Ÿ elasticsearch ï¼Œæª¢æŸ¥ logï¼Œçœ‹å•Ÿå‹•æ™‚æœ‰æ²’æœ‰è¼‰å…¥ x-pack\nsudo systemctl restart elasticsearch $ tail -f /var/log/elasticsearch/elasticsearch.log [2019-09-16T07:39:49,467][INFO ][o.e.e.NodeEnvironment ] [elk] using [1] data paths, mounts [[/mnt/disks/elk (/dev/sdb)]], net usable_space [423.6gb], net total_space [491.1gb], types [ext4] [2019-09-16T07:39:49,474][INFO ][o.e.e.NodeEnvironment ] [elk] heap size [3.9gb], compressed ordinary object pointers [true] [2019-09-16T07:39:50,858][INFO ][o.e.n.Node ] [elk] node name [elk], node ID [pC22j9D4R6uiCM7oTc1Fiw], cluster name [elasticsearch] [2019-09-16T07:39:50,866][INFO ][o.e.n.Node ] [elk] version[7.3.1], pid[17189], build[default/deb/4749ba6/2019-08-19T20:19:25.651794Z], OS[Linux/4.15.0-1040-gcp/amd64], JVM[Oracle Corporation/OpenJDK 64-Bit Server VM/12.0.2/12.0.2+10] [2019-09-16T07:39:50,878][INFO ][o.e.n.Node ] [elk] JVM home [/usr/share/elasticsearch/jdk] ... [2019-09-16T07:39:59,108][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-ccr] [2019-09-16T07:39:59,109][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-core] ... [2019-09-16T07:39:59,111][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-logstash] [2019-09-16T07:39:59,113][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-voting-only-node] [2019-09-16T07:39:59,114][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-watcher] [2019-09-16T07:39:59,115][INFO ][o.e.p.PluginsService ] [elk] no plugins loaded [2019-09-16T07:40:07,964][INFO ][o.e.x.s.a.s.FileRolesStore] [elk] parsed [0] roles from file [/etc/elasticsearch/roles.yml] [2019-09-16T07:40:10,369][INFO ][o.e.x.m.p.l.CppLogMessageHandler] [elk] [controller/17314] [Main.cc@110] controller (64 bit): Version 7.3.1 (Build 1d93901e09ef43) Copyright (c) 2019 Elasticsearch BV [2019-09-16T07:40:11,776][DEBUG][o.e.a.ActionModule ] [elk] Using REST wrapper from plugin org.elasticsearch.xpack.security.Security [2019-09-16T07:40:14,396][INFO ][o.e.d.DiscoveryModule ] [elk] using discovery type [single-node] and seed hosts providers [settings] [2019-09-16T07:40:16,222][INFO ][o.e.n.Node ] [elk] initialized [2019-09-16T07:40:16,224][INFO ][o.e.n.Node ] [elk] starting ... [2019-09-16T07:40:16,821][INFO ][o.e.t.TransportService ] [elk] publish_address {10.140.0.10:9300}, bound_addresses {[::]:9300} [2019-09-16T07:40:16,872][INFO ][o.e.c.c.Coordinator ] [elk] cluster UUID [1CB6_Lt-TUWEmRoN9SE49w] [2019-09-16T07:40:17,088][INFO ][o.e.c.s.MasterService ] [elk] elected-as-master ([1] nodes joined)[{elk}{pC22j9D4R6uiCM7oTc1Fiw}{Os-2FBjgSTOd1G_I3QYwVQ}{10.140.0.10}{10.140.0.10:9300}{dim}{ml.machine_memory=7836028928, xpack.installed=true, ml.max_open_jobs=20} elect leader, _BECOME_MASTER_TASK_, _FINISH_ELECTION_], term: 9, version: 921, reason: master node changed {previous [], current [{elk}{pC22j9D4R6uiCM7oTc1Fiw}{Os-2FBjgSTOd1G_I3QYwVQ}{10.140.0.10}{10.140.0.10:9300}{dim}{ml.machine_memory=7836028928, xpack.installed=true, ml.max_open_jobs=20}]} [2019-09-16T07:40:17,819][INFO ][o.e.c.s.ClusterApplierService] [elk] master node changed {previous [], current [{elk}{pC22j9D4R6uiCM7oTc1Fiw}{Os-2FBjgSTOd1G_I3QYwVQ}{10.140.0.10}{10.140.0.10:9300}{dim}{ml.machine_memory=7836028928, xpack.installed=true, ml.max_open_jobs=20}]}, term: 9, version: 921, reason: Publication{term=9, version=921} [2019-09-16T07:40:17,974][INFO ][o.e.h.AbstractHttpServerTransport] [elk] publish_address {10.140.0.10:9200}, bound_addresses {[::]:9200} â€¦","date":1568559633,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"251492a4ac45b0e56225488343f29cc8","permalink":"https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/","publishdate":"2019-09-15T23:00:33+08:00","relpermalink":"/zh-hant/post/2019-09-15-secure-elk-stack/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP å°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.","tags":["éµäººè³½2019","tls","elasticsearch","devops","logstash"],"title":"Secure Elk Stack","type":"post"},{"authors":[],"categories":["kubernetes","elasticsearch"],"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nâ€“\nç°¡ä»‹ ELK stack å®˜æ–¹èªªæ˜æ–‡ä»¶\nELK çš„å…ƒä»¶ Elasticsearch: åŸºæ–¼ Lucene çš„åˆ†æ•£å¼å…¨æ–‡æœç´¢å¼•æ“ Logstash: æ•¸æ“šè™•ç† pipeline Kibana: ELK stack çš„ç®¡ç†å¾Œå°èˆ‡æ•¸æ“šè¦–è¦ºåŒ–å·¥å…· Beats: è¼•é‡ç´šçš„æ‡‰ç”¨ç«¯æ•¸æ“šæ”¶é›†å™¨ï¼Œæœƒå¾è¢«ç›£æ§ç«¯æ”¶é›† log èˆ‡ç›£æ§æ•¸æ“š(metrics) ELK çš„å·¥ä½œæµç¨‹ beats -\u0026gt; (logstash) -\u0026gt; elasticsearch -\u0026gt; kibana\nå°‡ beats æ”¾åœ¨æ‡‰ç”¨ç«¯çš„ä¸»æ©Ÿä¸Šï¼Œæˆ–æ˜¯åœ¨å®¹å™¨åŒ–ç’°å¢ƒç¨®ä½œç‚º sidecarï¼Œè·Ÿæ‡‰ç”¨æ”¾åœ¨ä¸€èµ· è¨­å®š beats å¾æŒ‡å®šçš„è·¯å¾‘æ”¶é›† log èˆ‡ metrics è¨­å®š beats å‘å¾Œè¼¸å‡ºçš„é ç«¯ç›®æ¨™ (Optional) beats è¼¸å‡ºåˆ° logstash ï¼Œå…ˆé€²è¡Œæ•¸æ“šçš„è®Šæ›´ã€æ ¼å¼æ•´ç†ï¼Œåœ¨å¾Œé€åˆ° elasticsearch beats å‘å¾Œè¼¸å‡ºåˆ° elasticsearchï¼Œå„²å­˜æ•¸æ“šæ–‡ä»¶(document)ï¼Œä¸¦ä¾ç…§æ¨£å¼(template)èˆ‡ç´¢å¼•(index)å„²å­˜ï¼Œä¾¿å¯åœ¨ elasticsearch ä¸Šå…¨æ–‡æœç´¢æ•¸æ“š é€é Kibanaï¼Œå°‡ elasticsearch ä¸Šçš„ log é¡¯ç¤º å®˜æ–¹ä¸æ˜¯æœ‰å‡ºæ–‡ä»¶å— Elastic å®˜æ–¹æº–å‚™äº†å¤§é‡çš„æ–‡ä»¶ï¼Œç†è«–ä¸Šè¦è·Ÿè‘—æ–‡ä»¶ä¸€æ­¥ä¸€æ­¥æ¶è¨­é€™æ•´å¥—å·¥å…·æ‡‰è©²æ˜¯ååˆ†å®¹æ˜“ã€‚ç„¶è€Œå¯¦éš›ç…§è‘—åšå»é‡ä¸Šå¾ˆå¤šå›°é›£ã€‚ç”±æ–¼ç¼ºä¹ get-started çš„ç¯„ä¾‹æ–‡ä»¶ï¼Œä¸ç†Ÿæ‚‰ ELK è¨­å®šçš„ä½¿ç”¨è€…ï¼Œå¸¸å¸¸éœ€è¦åœä¸‹ä¾†é™¤éŒ¯ï¼Œç”šè‡³å› ç‚ºæ¼æ‰æŸå€‹æ­¥é©Ÿï¼Œè€Œéœ€è¦å›é ­é‡åšä¸€éã€‚\nèªªç©¿äº†æœ¬ç¯‡çš„æŠ€è¡“å«é‡ä¸é«˜ï¼Œå°±åªæ˜¯ä¸€å€‹è¸©é›·éç¨‹ã€‚\nLets get our hands dirty.\nWARNING é€™ç¯‡å®‰è£éç¨‹æ²’æœ‰åšå®‰å…¨æ€§è¨­å®šï¼Œç”±æ–¼ ELK stack çš„å®‰å…¨æ€§åŠŸèƒ½æ¨¡çµ„ï¼Œåœ¨v6.3.0 ä»¥å‰çš„ç‰ˆæœ¬æ˜¯ä¸åŒ…å«å®‰å…¨æ€§æ¨¡çµ„çš„ï¼Œå®˜æ–¹çš„å®‰è£èªªæ˜æ–‡ä»¶å°‡å®‰å…¨æ€§è¨­å®šå¦æˆä¸€ç¯‡ã€‚æˆ‘ç¬¬ä¸€æ¬¡å®‰è£ï¼Œå…¨éƒ¨å®‰è£å®Œå¾Œï¼Œæ‰ç™¼ç¾è£é ­æ²’æœ‰ä»»ä½•å®‰å…¨æ€§è¨­å®šï¼ŒåŒ…å«å¸³è™Ÿå¯†ç¢¼ç™»å…¥ã€api secret tokenã€https/tls é€šé€šæ²’æœ‰ï¼Œæ•´çµ„ elk è£¸å¥”ã€‚\næˆ‘é€™é‚Šåˆ†é–‹çš„ç›®çš„ï¼Œä¸æ˜¯è®“å¤§å®¶éƒ½è·Ÿæˆ‘ä¸€æ¨£è¢«é›·(XD)ï¼Œè€Œæ˜¯å› ç‚º\nå¦èµ·ä¸€ç¯‡å°å®‰å…¨æ€§è¨­å®šå¤šåŠ èªªæ˜ åœ¨å®‰å…¨çš„å…§ç¶²ä¸­ï¼Œæ²’æœ‰å®‰å…¨æ€§è¨­å®šï¼Œå¯ä»¥å¤§å¹…åŠ é€Ÿé–‹ç™¼èˆ‡é™¤éŒ¯ é›–ç„¶æ²’æœ‰å®‰å…¨æ€§è¨­å®šï¼Œä½†ä»ç„¶æœ‰å®Œæ•´çš„åŠŸèƒ½ï¼Œå¦‚æœåªæ˜¯åœ¨æ¸¬è©¦ç’°å¢ƒï¼Œæˆ–æ˜¯æƒ³è¦è©•ä¼°è©¦ç”¨ self-hosted ELKï¼Œé€™ç¯‡çš„èªªæ˜å·²è¶³å¤ ã€‚ä½†åƒè¬ä¸è¦ç”¨é€™ç¯‡ä¸Š public network æˆ–æ˜¯ç”¨åœ¨ production ç’°å¢ƒå–”ã€‚\nå¦‚æœå¸Œæœ›ç¬¬ä¸€æ¬¡å®‰è£å°±æœ‰å®Œæ•´çš„ security è¨­å®šï¼Œè«‹ç­‰å¾…ä¸‹ç¯‡ Secure ELK Stask\nè¨è«–éœ€æ±‚èˆ‡è¦æ ¼ é€™é‚Šåªæ˜¯å¸¶å¤§å®¶éä¸€ä¸‹åŸºç¤å®‰è£æµç¨‹ï¼Œæˆ‘å€‘åœ¨ç§æœ‰ç¶²è·¯ä¸­æ­å»ºä¸€å° standalone çš„ ELK stackï¼Œé€šé€šæ”¾åœ¨ä¸€å°ç¯€é»(node)ä¸Šã€‚\nelk-node-standalone 10.140.0.10 app-node-1 10.140.0.11 ... ... æœ¬æ©Ÿçš„ ELK stack å…ƒä»¶ï¼Œå½¼æ­¤é€é localhost é€£ç·š\nElasticsearch: localhost:9200 Kibana: localhost:5601 Apm-server: localhost:8200 Self Monitoring Services ç§æœ‰ç¶²è·¯ä¸­çš„å¤–éƒ¨æœå‹™é€é 10.140.0.10\nbeats å¾å…¶ä»– node è¼¸å‡ºåˆ° Elasticsearch: 10.140.0.10:9200 beats å¾å…¶ä»– node è¼¸å‡ºåˆ° Apm-server: 10.140.0.10:8200 åœ¨å…§éƒ¨ç¶²è·¯ä¸­ é€é browser å­˜å– Kibana: 10.140.0.10:5601 standalone çš„å¥½è™•:\næ–¹ä¾¿ (å†æ¬¡å¼·èª¿é€™ç¯‡åªæ˜¯ç¤ºç¯„ï¼Œå¯¦å‹™ä¸Šä¸è¦è²ªä¸€æ™‚æ–¹ä¾¿ï¼Œç¶­é‹å´©æ½°) æœ€ç°¡åŒ–è¨­å®šï¼ŒELK æœ‰éå¸¸å¤§é‡çš„è¨­å®šå¯ä»¥èª¿æ•´ï¼Œé€™ç¯‡ç°¡åŒ–äº†å¤§éƒ¨åˆ† Standaloneå¯èƒ½é€ æˆçš„å•é¡Œ:\nNo High Availablity: æ²’æœ‰ä»»ä½•å®¹éŒ¯å‚™æ´å¯ä»¥ failoverï¼Œé€™å°æ›å°±å…¨æ› å¤–éƒ¨æœå‹™å¤šçš„è©±ï¼Œå¾ˆå®¹æ˜“å°±è¶…é node ä¸Šå°æ–¼ç¶²è·¯å­˜å–çš„é™åˆ¶ï¼Œé€ æˆ tcp drop æˆ– delayã€‚éœ€è¦èª¿æ•´ ulimit ä¾†å¢åŠ ç¶²è·¯ï¼Œç•¶ç„¶é€™åœ¨é›²ç«¯ä¸Šæœƒçµ¦ç¶­é‹å¸¶ä¾†æ›´å¤šéº»ç…©ï¼Œä¸æ˜¯ä¸€å€‹å¥½è§£æ³•ã€‚ å¦‚æœè¦æœ‰ production ready çš„ ELK\nHA é–‹èµ·ä¾† æŠŠæœå‹™åˆ†æ•£åˆ°ä¸åŒ node ä¸Š, æ–¹ä¾¿ä¹‹å¾Œ scale out å¤šé–‹å¹¾å° elasticsearch-1, elasticsearch-2, elasticsearch-3â€¦ kibana-1 apm-server-1, apm-server-2, â€¦ å¦‚æœæ‡‰ç”¨åœ¨å·²ç¶“å®¹å™¨åŒ–, é€™äº›æœå‹™å…ƒä»¶ä¹Ÿå¯ä»¥ä¸Š Kubernetes åšå®¹å™¨è‡ªå‹•åŒ–ï¼Œé€™å€‹éƒ¨ä»½è »å¥½ç©ï¼Œå¦‚æœæœ‰æ™‚é–“æˆ‘å€‘ä¾†èŠé€™ç¯‡ ä¸»æ©Ÿè¨­å®š Elasticsearch å„²å­˜æ•¸æ“šæœƒä½”ç”¨ä¸å°‘ç¡¬ç¢Ÿç©ºé–“ï¼Œæˆ‘å€‹äººçš„ç¿’æ…£æ˜¯åªè¦æœ‰é¡å¤–å ç”¨å„²å­˜ç©ºé–“ï¼Œéƒ½è¦å¦å¤–æ›è¼‰ç¡¬ç¢Ÿï¼Œä¸è¦å ç”¨ rootï¼Œæ‰€ä»¥é€™é‚Šæœƒéœ€è¦å¦å¤–æ›è¼‰ç¡¬ç¢Ÿã€‚\nGCP ä¸Šä½¿ç”¨ Google Compote Engine çš„æœ‹å‹ï¼Œå¯ä»¥ç…§ Google å®˜æ–¹æ“ä½œæ­¥é©Ÿæ“ä½œ\nå®Œæˆå¾Œæ¥è¿‘é€™æ¨£\n$ df -h $ df --human-readable Filesystem Size Used Avail Use% Mounted on /dev/sda1 9.6G 8.9G 682M 93% / /dev/sdb 492G 63G 429G 13% /mnt/disks/elk $ ls /mnt/disks/elk /mnt/disks/elk/elasticsearch /mnt/disks/elk/apm-server /mnt/disks/elk/kibana è‡³æ–¼éœ€è¦å¤šå°‘å®¹é‡ï¼Œå–æ±ºæ”¶é›†æ•¸æ“šçš„æ•¸é‡ï¼Œè½å·®éå¸¸å¤§ï¼Œå¯ä»¥å…ˆä¸Šå€‹ 100Gb ï¼Œè©¦è·‘ä¸€æ®µæ™‚é–“ï¼Œå†è¦–æƒ…æ³ scale storage diskã€‚\né–‹é˜²ç«ç‰† éœ€è¦é–‹æ”¾ 10.140.0.10 é€™å°æ©Ÿå™¨çš„å¹¾å€‹ port\nelasticsearch :9200 ä¾†æºåªé–‹æ”¾ç§æœ‰ç¶²è·¯å…¶ä»– ip 10.140.0.0/9 apm-server :8200 (åŒä¸Š) kibana :5601 (åŒä¸Š)ï¼Œå¦‚æœæƒ³å¾å¤–éƒ¨é€é browseré–‹ï¼Œéœ€è¦ whitelist ip GCP ä¸Šæœ‰ default çš„é˜²ç«ç‰†å…è¨±è¦å‰‡ï¼Œç§æœ‰ç¶²è·¯å¯ä»¥å½¼æ­¤é€£ç·š\ndefault-allow-internal: :all :10.140.0.0/9 tcp:0-65535 Install Elasticsearch Install Elasticsearch å®˜æ–¹æ–‡ä»¶ 7.3\næˆ‘å€‘é€™é‚Šç›´æ¥åœ¨ ubuntu 18.04 ä¸Šä½¿ç”¨ apt ä½œç‚ºå®‰è£\nsudo apt-get install apt-transport-https wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - add-apt-repository \u0026#34;deb https://artifacts.elastic.co/packages/7.x/apt stable main\u0026#34; sudo apt-get update sudo apt-get install elasticsearch å®‰è£å®Œå¾Œè·¯å¾‘é•·é€™æ¨£\n/etc/elasticsearch /etc/elasticsearch/elasticsearch.yml /etc/elasticsearch/jvm.options # Utility /usr/share/elasticsearch/bin/ # Log /var/log/elasticsearch/elasticsearch.log æœ‰éœ€è¦ä¹Ÿå¯ä»¥è¤‡å¯«è¨­å®šæª”ï¼ŒæŠŠ log ä¹Ÿç§»åˆ° /mnt/disks/elk/elasticsearch/logs\næœå‹™æ§åˆ¶ é€é systemd ç®¡ç†ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ systemctl æ§åˆ¶ï¼Œ ç”¨æˆ¶ elasticsearch:elasticsearchï¼Œæ“ä½œæ™‚æœƒéœ€è¦ sudo æ¬Šé™ã€‚\nä½†åœ¨å•Ÿå‹•å‰è¦å…ˆèª¿æ•´æ•¸æ“šå„²å­˜è·¯å¾‘ï¼Œä¸¦æŠŠæ¬Šé™ç§»è½‰çµ¦ä½¿ç”¨è€…ã€‚\nmkdir -p /mnt/disks/elk/elasticsearch chown elasticsearch:elasticsearch /mnt/disks/elk/elasticsearch è¨­å®šæª”æ¡ˆ ELK æä¾›äº†è¨±å¤šå¯è¨­å®šèª¿æ•´çš„è¨­å®š,ä½†é¾å¤§çš„è¨­å®šæª”æ¡ˆä¹Ÿååˆ†é›£ä¸Šæ‰‹ã€‚æˆ‘å€‘é€™é‚Šå…ˆç°¡å–®æ›´æ”¹ä»¥ä¸‹è¨­å®šæª”æ¡ˆ\nsudo vim /etc/elasticsearch/elasticsearch.yml # Change Network network.host: 0.0.0.0 # Change data path path.data: /mnt/disks/elk/elasticsearch vim /etc/elasticsearch/jvm-options # Adjust heap to 4G -Xms4g -Xmx4g # Enable xpack.security discovery.seed_hosts: [\u0026#34;10.140.0.10\u0026#34;] discovery.type: \u0026#34;single-node\u0026#34; xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.license.self_generated.type: basic 6.3.0 å¾Œçš„ç‰ˆæœ¬å·²ç¶“é™„ä¸Šå®‰å…¨æ€§æ¨¡çµ„ xpackï¼Œé€™é‚Šé †ä¾¿é–‹èµ·ä¾†ã€‚é—œæ–¼ xpack çš„å®‰å…¨æ€§è¨­å®šï¼Œé€™é‚Šå…ˆç•¥éä¸æã€‚\næœ‰å•Ÿç”¨ xpack ï¼Œå¯ä»¥è®“æˆ‘å€‘é€é elasticsearch é™„å¸¶çš„å·¥å…·ï¼Œç”¢ç”Ÿä½¿ç”¨è€…èˆ‡å¸³è™Ÿå¯†ç¢¼ã€‚\n/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto # Keep your passwords safe ç„¶å¾ŒæŠŠå•Ÿå‹• Elasticsearch\nsudo systemctl enable elasticsearch.service sudo systemctl start elasticsearch.service sudo systemctl status elasticsearch.service çœ‹ä¸€ä¸‹ logï¼Œç¢ºå®šæœå‹™æœ‰åœ¨æ­£å¸¸å·¥ä½œ\ntail -f /var/log/elasticsearch/elasticsearch.log åœ¨ node ä¸Šè©¦æ‰“ Elasticsearch API\n$ curl localhost:9200 { \u0026#34;name\u0026#34; : \u0026#34;elk\u0026#34;, \u0026#34;cluster_name\u0026#34; : \u0026#34;elasticsearch\u0026#34;, \u0026#34;cluster_uuid\u0026#34; : \u0026#34;uiMZe7VETo-H6JLFLF4SZg\u0026#34;, \u0026#34;version\u0026#34; : { â€¦","date":1568518983,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"89b94a9f78ad2ba6feb1029b40b9f2b2","permalink":"https://chechia.net/zh-hant/post/2019-09-15-self-host-elk-stack-on-gcp/","publishdate":"2019-09-15T11:43:03+08:00","relpermalink":"/zh-hant/post/2019-09-15-self-host-elk-stack-on-gcp/","section":"post","summary":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.","tags":["éµäººè³½2019","gcp","tls","elasticsearch","devops","logstash"],"title":"Self-host ELK stack - Installation","type":"post"},{"authors":[],"categories":["kubernetes"],"content":"å„ä½å¥½ï¼Œæˆ‘æ˜¯Che-Chia Changï¼Œç¤¾ç¾¤ä¸Šå¸¸ç”¨çš„åå­æ˜¯ David Changã€‚æ˜¯å€‹è»Ÿé«”å·¥ç¨‹å¸«ï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ç›®å‰ç‚º Golang Taiwan Meetup çš„ organizerã€‚\nå—åˆ°å‹äººå€‘é‚€è«‹ï¼ˆæ¨å‘ï¼‰åƒåŠ äº†2020 Ité‚¦å¹«å¿™éµäººè³½ï¼ŒæŒ‘æˆ°åœ¨30å¤©å…§ï¼Œæ¯å¤©ç™¼ä¸€ç¯‡æŠ€è¡“åˆ†äº«æ–‡ç« ã€‚ä¸€æ–¹é¢å°‡å·¥ä½œä¸Šé‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•åˆ†äº«çµ¦ç¤¾ç¾¤ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯çµ¦è‡ªå·±ä¸€é»æˆé•·çš„å£“åŠ›ï¼ŒæŠŠé€™æ®µæ™‚é–“çš„å¿ƒå¾—æ²ˆæ¾±ä¸‹ä¾†ï¼Œå› æ­¤ä¹Ÿäº†é€™ç³»åˆ—æ–‡ç« ã€‚\næœ¬ç³»åˆ—æ–‡ç« é‡é»æœ‰ä¸‰ï¼š\næä¾›çš„è§£æ±ºæ–¹æ¡ˆï¼Œé™„ä¸Šä¸€æ­¥æ­¥çš„æ“ä½œæ­¥é©Ÿã€‚å¸Œæœ›è®“è®€è€…å¯ä»¥é‡ç¾å®Œæ•´æ“ä½œæ­¥é©Ÿï¼Œç›´æ¥ä½¿ç”¨ï¼Œæˆ–æ˜¯åŠ ä»¥ä¿®æ”¹\nè‘—é‡ Google Cloud Platformï¼Œç‰¹åˆ¥æ˜¯Google Compute Engine (GCE) èˆ‡Google Kubernetes Engine (GKE) å…©å¤§æœå‹™ã€‚é€™ä¹Ÿæ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„å¹³å°ï¼Œé †ä¾¿æ¨å»£ï¼Œä¸¦åˆ†äº«ä¸€äº›é›·é»ã€‚\nå¾ç¶­é‹çš„è§’åº¦é™¤éŒ¯ï¼Œåˆ†æå•é¡Œï¼Œæå‡ç©©å®šæ€§ã€‚\né å®šçš„ä¸»é¡Œå¦‚ä¸‹ï¼ˆå¯èƒ½æœƒä¾ç…§å¯¦éš›æ’°å¯«ç‹€æ³å¾®èª¿ï¼‰\nELK Stask on GCP (8) Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ åœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter Prometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š Nginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage æ–‡ç« ç™¼è¡¨æ–¼éµäººæŒ‘æˆ°é é¢ï¼ŒåŒæ™‚ç™¼å¸ƒèˆ‡æœ¬ç«™å‚™ä»½ã€‚æœ‰ä»»ä½•è¬¬èª¤ï¼Œé‚„ç…©è«‹å„æ–¹å¤§å¾·\u0026lt;3é€éåº•ä¸‹çš„è¯çµ¡æ–¹å¼è¯çµ¡æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nFeatures\nstep-by-step guide for deployment: guarentee a running deployment on GCP basic configuration, usage, monitoring, networking on GKE debugging, stability analysis in an aspect of devop Topics\nELK stack(8) Deploy self-hosted ELK stack on GCE instance Secure ELK stack with SSL and role-based authentication Monitoring services on Kubernetes with ELK beats Monitoring services on GCE instances Logstash pipelines and debugging walk through Elasticsearch operations: house-cleaning, tuning, pernament storage Elasticsearch maitainence, trouble shooting Get-Started with Elastic Cloud SASS General operations on Kubernetes(4) Kubernetes Debug SOP Kubectl cheat sheet Secure services with SSL by cert-manager Speed up container updating with operator My operator example Deploy Kafka HA on Kubernetes(4) deploy kafka-ha on Kubernertes with helm in-cluster networking configuration for high availability basic app-side usage, performance tuning Operate Kafka: update config, upgrade version, migrate data Promethus / grafana(5) Deploy Prometheus / Grafana stack on GCE instance Monitoring services on Kubernetes with exporters Export Kubernetes metrics to Prometheus Export Redis-ha metrics to Prometheus Export Kafka metrics to Prometheus GCP networking(4) Firewall basic concept for private network with GCE instances \u0026amp; Kubernetes Load balancer for Kubernetes service \u0026amp; ingress DNS on GCP from Kube-dns to GCP DNS service GCP log management(3) Basic usage about GCP logging \u0026amp; GCP Error Report Stackdriver, metrics, alerts Logging on GKE from gcp-fluentd to stackdriver ","date":1568019363,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"66dad33329f6f9234dead62f90905865","permalink":"https://chechia.net/zh-hant/post/2019-09-09-ithome-ironman-challenge/","publishdate":"2019-09-09T16:56:03+08:00","relpermalink":"/zh-hant/post/2019-09-09-ithome-ironman-challenge/","section":"post","summary":"2019 ITé‚¦å¹«å¿™éµäººè³½","tags":["éµäºº2019","kubernetes","elk","kafka","redis","nginx","cert-manager","crd"],"title":"2019 ITé‚¦å¹«å¿™éµäººè³½","type":"post"},{"authors":[],"categories":null,"content":"å„ä½å¥½ï¼Œæˆ‘æ˜¯Che-Chia Changï¼Œå°ˆé•· DevOps \u0026amp; Kubernetes\nä»Šå¹´ä¸ä¿è­‰ä¸çˆ›å°¾çš„ 2021 éµäººæŒ‘æˆ°é é¢ ç¬¬ä¸€æ‰‹æ¶ˆæ¯ç™¼å¸ƒï¼Œå…è²»ç·šä¸Šè«®è©¢ï¼Œè«‹è¦‹ FB å¾€å¹´å›é¡§ 4 è¬é¤˜å­—çš„è¡€æ·š 30 æ—¥ - 2020 éµäººæŒ‘æˆ° å„ªç­‰ å›åˆ° 2021 å¹´ï¼Œæœ¬ç³»åˆ—æœƒå¯«å¾—å¾ˆéš¨èˆˆï¼Œè®€è€…æœ‰å¹«åŠ©ç‚ºç›®çš„æ’°å¯«ï¼Œ\nå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®ï¼Œæˆ–æ˜¯å¥½å¥‡æƒ³å•å•é¡Œï¼Œæ­¡è¿åº•ä¸‹ç•™è¨€ï¼Œæˆ–åˆ°æˆ‘çš„ FB ç§è¨Šï¼Œæˆ‘éƒ½æœƒä¸€å°ä¸€å›å¾©ã€‚åŸºæ–¼ã€Œå–ä¹‹ç¤¾ç¾¤å›é¥‹ç¤¾ç¾¤ã€çš„ç²¾ç¥ï¼Œè«®è©¢èŠå¤©éƒ½æ˜¯æ°¸é å…è²»ã€‚\nåŸºæ–¼æ˜ç¢ºéœ€æ±‚ï¼Œè¨è«–è§£æ±ºæ–¹æ¡ˆ è·Ÿ Kubernetes æœ‰é—œ æä¾›æ‰‹æŠŠæ‰‹ SOP å–œæ­¡ä¹Ÿè«‹å¹«æˆ‘é»å€‹è®šï¼Œæˆ–æ˜¯ç•™è¨€è®“æˆ‘çŸ¥é“ï¼Œè®“æˆ‘æœ‰é»å‹•åŠ›ç¹¼çºŒå¯«ï¼Œå¤§å¹…é™ä½æˆ‘å·æ‡¶çˆ›å°¾çš„æ©Ÿç‡(XD)\né å®šçš„ä¸»é¡Œï¼ˆå¯èƒ½æœƒå¾®èª¿æˆ–å¤§æ”¹XDï¼‰\nå¥½æ–‡ç¿»è­¯åˆ†äº« Borg, Omega, Kubernetes - Google å®¹å™¨åŒ–é–‹ç™¼åå¹´ç¶“é©—ï¼ŒKubernetes çš„å‰æ—¥ä»Šç”Ÿ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - æˆ‘é€™é‚Šæœ‰ä¸€æ‰¹ä¾¿å®œçš„å¥½ VM æ‰“ä¸‰æŠ˜è³£ä½ ï¼ŒPreemptible / Spot Instance å…ˆå ç¯€é»å¯¦æˆ°åˆ†äº« å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼ŒåŸç†ç°¡ä»‹èˆ‡è¦æ ¼ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼Œé©ç”¨æ¡ˆä¾‹å¯¦æˆ°åˆ†æ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼Œä½¿ç”¨ç¯„ä¾‹ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼Œç¶“é©—åˆ†äº«ï¼Œé›·é» å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - æˆ‘è·‘äº†ä¸€å€‹ botï¼Œ24 å°æ™‚ä¸Šç·šï¼Œ GCP ä¸€å¤©æ”¶ä½  4 å…ƒå°å¹£ å¤§å®¶éƒ½ä¾†ç”¨ Terraformï¼ŒInfrastructure as Code æ¼”è¬›å…¨æ–‡åˆ†äº« iThome Cloud Summit è¬›åˆ°æ™‚é–“è¶…éï¼Œä¸€å°æ±è¥¿æ²’è¬›ï¼Œæ‰€ä»¥ä¾†é€™é‚Šç™¼æ–‡ çœŸçš„å¥½ç”¨ï¼Œå¯¦æˆ°ç¶“é©—åˆ†äº« è§£ç­”ç²‰å°ˆç§è¨Šå•é¡Œèˆ‡è§€çœ¾ç™¼å• åˆ†æ•£å¼å·¥å…·å¯¦é©—å®¤ - Scalable Database on Kubernetes Thanos - Scalable HA Prometheus ç°¡ä»‹ éœ€æ±‚åˆ†æï¼ŒUnlimited Retention éµä¸€èˆ¬çš„éœ€æ±‚ ä¸€æ­¥æ­¥å¸¶ä½ æ¶ Scalable DB å¯¦é©—- Cockroach DB - è€ç”¨æ‰“ä¸æ­»åˆé«˜æ•ˆèƒ½çš„å°å¼·è³‡æ–™åº« å‰è¨€ï¼Œåˆ†æ•£å¼ç³»çµ±ä¸‹çš„å›°å¢ƒï¼Œè³‡æ–™åº«ç“¶é ¸ Cockroach DB åŸºæœ¬åŸç†ç°¡ä»‹ Cockroach DB Free Trial ç©èµ·ä¾† Cassandra - æ”¯æ’ç™¾è¬ç´šå¯«å…¥çš„åˆ†æ•£å¼è³‡æ–™åº« Cassandra ç°¡ä»‹ Cassandra ç´°éƒ¨åŸç†ï¼Œåˆ†æ•£å¼çš„è³‡æ–™åº«è¨­è¨ˆè¶…å¥½ç© Cassandra ç´°éƒ¨åŸç†ï¼ŒConsistency Hashing Cassandra ç´°éƒ¨åŸç†ï¼ŒData modeling Netflix case study - å·å­¸ Netflix èƒ½å­¸åˆ°å¹¾æˆåŠŸåŠ›å‘¢ æœ‰ä»»ä½•è¬¬èª¤ï¼Œé‚„ç…©è«‹å„æ–¹å¤§å¾·\u0026lt;3è¯çµ¡æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\n","date":1568019363,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"9831314c60d0890d9f8d13ad808717b1","permalink":"https://chechia.net/zh-hant/post/2020-09-09-ithome-ironman-challenge/","publishdate":"2019-09-09T16:56:03+08:00","relpermalink":"/zh-hant/post/2020-09-09-ithome-ironman-challenge/","section":"post","summary":"2020 ITé‚¦å¹«å¿™éµäººè³½","tags":["éµäººè³½2020","kubernetes","borg"],"title":"2020 ITé‚¦å¹«å¿™éµäººè³½","type":"post"},{"authors":[],"categories":["quantum-computing"],"content":"This post is about my learning steps for quantum-computing.\nFor a quick-start tutorial, check my workshop project throught the project link above.\nResources Courses\nCoursera\non MIT x pro\nQuantum Information Processing from UW Madison\nQuantum Computation by John Preskill\nIBM Q Experience\nhttps://github.com/Qiskit/openqasm\nhttps://github.com/Qiskit/qiskit-tutorials\nIBM Q Experience Day 1 Getting Started with Circuit Composer\nHello Quantum World circuit transformed two qubits, from $ \\vert0\\rangle $ to $ \\frac{\\vert00\\rangle + \\vert11\\rangle}{\\sqrt{2}} $\nQuestions\n[] Hadamard Gate [] Bell states [] Annotations ","date":1559442097,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"d21581c66d8270f0b5118fcec7e7d711","permalink":"https://chechia.net/zh-hant/post/2019-06-02-journey-to-quantum-computing/","publishdate":"2019-06-02T10:21:37+08:00","relpermalink":"/zh-hant/post/2019-06-02-journey-to-quantum-computing/","section":"post","summary":"This post is about my learning steps for quantum-computing.\nFor a quick-start tutorial, check my workshop project throught the project link above.\nResources Courses\nCoursera\non MIT x pro\nQuantum Information Processing from UW Madison","tags":["quantum-computing","ibm-q-experience","tutorial"],"title":"Journey to Quantum Computing","type":"post"},{"authors":[],"categories":["kubernetes","istio"],"content":"Create GKE gcloud beta container --project \u0026#34;istio-playground-239810\u0026#34; clusters create \u0026#34;istio-playground\u0026#34; \\ --zone \u0026#34;asia-east1-b\u0026#34; \\ --username \u0026#34;admin\u0026#34; \\ --cluster-version \u0026#34;1.11.8-gke.6\u0026#34; \\ --machine-type \u0026#34;n1-standard-2\u0026#34; \\ --image-type \u0026#34;COS\u0026#34; \\ --disk-type \u0026#34;pd-standard\u0026#34; \\ --disk-size \u0026#34;100\u0026#34; \\ --preemptible \\ --num-nodes \u0026#34;1\u0026#34; \\ --enable-cloud-logging \\ --enable-cloud-monitoring \\ --no-enable-ip-alias \\ --addons HorizontalPodAutoscaling,HttpLoadBalancing,KubernetesDashboard,Istio \\ --istio-config auth=MTLS_PERMISSIVE \\ --no-enable-autoupgrade \\ --enable-autorepair Take a Peek $ kubectl get namespaces NAME STATUS AGE default Active 2m istio-system Active 1m kube-public Active 2m kube-system Active 2m $ kubectl get po -n istio-system NAME READY STATUS RESTARTS AGE istio-citadel-7f6f77cd7b-nxfbf 1/1 Running 0 3m istio-cleanup-secrets-h454m 0/1 Completed 0 3m istio-egressgateway-7c56db84cc-nlrwq 1/1 Running 0 3m istio-galley-6c747bdb4f-45jrp 1/1 Running 0 3m istio-ingressgateway-6ff68cf95d-tlkq4 1/1 Running 0 3m istio-pilot-8ff66f8c4-q9chz 2/2 Running 0 3m istio-policy-69b78b7d6-c8pld 2/2 Running 0 3m istio-sidecar-injector-558996c897-hr6q4 1/1 Running 0 3m istio-telemetry-f96459fb-5cbpg 2/2 Running 0 3m promsd-ff878d44b-hv8nh 2/2 Running 1 3m Deploy app kubectl label namespace default istio-injection=enabled Bookinfo Application\nkubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/bookinfo/platform/kube/bookinfo.yaml kubectl get pods kubectl get services Gateway\nkubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/bookinfo/networking/bookinfo-gateway.yaml kubectl get gateways kubectl get svc istio-ingressgateway -n istio-system Go to ingress public ip\nexport INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0026#39;{.status.loadBalancer.ingress[0].ip}\u0026#39;) export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0026#39;{.spec.ports[?(@.name==\u0026#34;http2\u0026#34;)].port}\u0026#39;) export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0026#39;{.spec.ports[?(@.name==\u0026#34;https\u0026#34;)].port}\u0026#39;) curl -v ${INGRESS_HOST}:{$INGRESS_PORT}/productpage 404 Not Found Apply destination rules\nkubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/bookinfo/networking/destination-rule-all.yaml curl -v ${INGRESS_HOST}:{$INGRESS_PORT}/productpage Brief review kubectl get virtualservices kubectl get destinationrules kubectl get gateways Istio Tasks https://istio.io/docs/tasks/traffic-management/\n","date":1557137535,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"1693002988c5b0fb96505223edb59a21","permalink":"https://chechia.net/zh-hant/post/2019-05-06-service-mesh-for-microservice-on-kubernetes/","publishdate":"2019-05-06T18:12:15+08:00","relpermalink":"/zh-hant/post/2019-05-06-service-mesh-for-microservice-on-kubernetes/","section":"post","summary":"åŸºæ–¼ Kubernetes å¹³å°ä¸Šçš„ Istio ï¼Œå¯¦éš›éƒ¨ç½²ï¼Œä¸¦ä¸€æ­¥ä¸€æ­¥æ“ä½œIstio çš„åŠŸèƒ½ã€‚","tags":["kubernetes","istio"],"title":"Istio ä¸‰åˆ†é˜å°±å…¥å‘ ä½ˆç½²ç¯‡","type":"post"},{"authors":[],"categories":["kubernetes","devops","jenkins"],"content":"Jenkins is one of the earliest open source antomation server and remains the most common option in use today. Over the years, Jenkins has evolved into a powerful and flexible framework with hundreds of plugins to support automation for any project.\nJenkins X, on the other hand, is a CI/CD platform (Jenkins Platform) for modern cloud applications on Kubernetes.\nHere we talk about some basic concepts about Jenkins X and provide a hand-to-hand guide to deploy jenkins-x on Kubernetes.\nArchitecture of Jenkins X Install Jenkins with jx Create a Pipeline with jx Develope with jx client For more information about jx itself, check Jenkins-X Github Repo\nArchitecture Check this beautiful diagram.\nhttps://jenkins-x.io/architecture/diagram/ Install Create GKE cluster \u0026amp; Get Credentials gcloud init gcloud components update CLUSTER_NAME=jenkins-server #CLUSTER_NAME=jenkins-serverless gcloud container clusters create ${CLUSTER_NAME} \\ --num-nodes 1 \\ --machine-type n1-standard-4 \\ --enable-autoscaling \\ --min-nodes 1 \\ --max-nodes 2 \\ --zone asia-east1-b \\ --preemptible # After cluster initialization, get credentials to access cluster with kubectl gcloud container clusters get-credentials ${CLUSTER_NAME} # Check cluster stats. kubectl get nodes Install jx on Local Machine [Jenkins X Release](https://github.com/jenkins-x/jx/releases](https://github.com/jenkins-x/jx/releases)\nJX_VERSION=v2.0.2 OS_ARCH=darwin-amd64 #OS_ARCH=linux-amd64 curl -L https://github.com/jenkins-x/jx/releases/download/\u0026#34;${JX_VERSION}\u0026#34;/jx-\u0026#34;${OS_ARCH}\u0026#34;.tar.gz | tar xzv sudo mv jx /usr/local/bin jx version NAME VERSION jx 2.0.2 Kubernetes cluster v1.11.7-gke.12 kubectl v1.11.9-dispatcher helm client v2.11.0+g2e55dbe helm server v2.11.0+g2e55dbe git git version 2.20.1 Operating System Mac OS X 10.14.4 build 18E226 (Option 1) Install Serverless Jenkins Pipeline DEFAULT_PASSWORD=mySecretPassWord123 jx install \\ --default-admin-password=${DEFAULT_PASSWORD} \\ --provider=\u0026#39;gke\u0026#39; Options:\nEnter Github user name Enter Github personal api token for CI/CD Enable Github as Git pipeline server Select Jenkins installation type: Serverless Jenkins X Pipelines with Tekon Static Master Jenkins Pick default workload build pack Kubernetes Workloads: Automated CI+CD with GitOps Promotion Library Workloads: CI+Release but no CD Select the organization where you want to create the environment repository: chechiachang Your Kubernetes context is now set to the namespace: jx INFO[0231] To switch back to your original namespace use: jx namespace jx INFO[0231] Or to use this context/namespace in just one terminal use: jx shell INFO[0231] For help on switching contexts see: https://jenkins-x.io/developing/kube-context/ INFO[0231] To import existing projects into Jenkins: jx import INFO[0231] To create a new Spring Boot microservice: jx create spring -d web -d actuator INFO[0231] To create a new microservice from a quickstart: jx create quickstart (Option 2) Install Static Jenkins Server DEFAULT_PASSWORD=mySecretPassWord123 jx install \\ --default-admin-password=${DEFAULT_PASSWORD} \\ --provider=\u0026#39;gke\u0026#39; Options:\nEnter Github user name Enter Github personal api token for CI/CD Enable Github as Git pipeline server Select Jenkins installation type: Serverless Jenkins X Pipelines with Tekon Static Master Jenkins Pick default workload build pack Kubernetes Workloads: Automated CI+CD with GitOps Promotion Library Workloads: CI+Release but no CD Select the organization where you want to create the environment repository: chechiachang INFO[0465]Your Kubernetes context is now set to the namespace: jx INFO[0465] To switch back to your original namespace use: jx namespace default INFO[0465] Or to use this context/namespace in just one terminal use: jx shell INFO[0465] For help on switching contexts see: https://jenkins-x.io/developing/kube-context/ INFO[0465] To import existing projects into Jenkins: jx import INFO[0465] To create a new Spring Boot microservice: jx create spring -d web -d actuator INFO[0465] To create a new microservice from a quickstart: jx create quickstart Access Static Jenkins Server through Domain with username and password Domain http://jenkins.jx.11.22.33.44.nip.io/\nUninstall jx uninstall # rm -rf ~/.jx Setup CI/CD Pipeline Create Quickstart Repository kubectl get pods --namespace jx --watch # cd workspace jx create quickstart Options:\nWhich organisation do you want to use? chechiachang Enter the new repository name: serverless-jenkins-quickstart select the quickstart you wish to create [Use arrows to move, type to filter] angular-io-quickstart aspnet-app dlang-http golang-http jenkins-cwp-quickstart jenkins-quickstart node-http\nINFO[0121] Watch pipeline activity via: jx get activity -f serverless-jenkins-quickstart -w INFO[0121] Browse the pipeline log via: jx get build logs chechiachang/serverless-jenkins-quickstart/master INFO[0121] Open the Jenkins console via jx console INFO[0121] You can list the pipelines via: jx get pipelines INFO[0121] Open the Jenkins console via jx â€¦","date":1555647341,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"e6fd32ec536b4d36f5f015b1d2b76cc0","permalink":"https://chechia.net/zh-hant/post/2019-04-19-jenkins-x-on-kubernetes/","publishdate":"2019-04-19T12:15:41+08:00","relpermalink":"/zh-hant/post/2019-04-19-jenkins-x-on-kubernetes/","section":"post","summary":"Jenkins is one of the earliest open source antomation server and remains the most common option in use today. Over the years, Jenkins has evolved into a powerful and flexible framework with hundreds of plugins to support automation for any project.","tags":["jenkins","ci","cd","kubernetes"],"title":"Jenkins X on Kubernetes","type":"post"},{"authors":null,"categories":["kubernetes"],"content":"","date":1538798820,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"751c6ae47d075143b976bf2c3cd443d5","permalink":"https://chechia.net/zh-hant/post/2018-10-06-kubernetes-container-runtime-interface/","publishdate":"2018-10-06T12:07:00+08:00","relpermalink":"/zh-hant/post/2018-10-06-kubernetes-container-runtime-interface/","section":"post","summary":"","tags":["kubernetes","container","docker","cri"],"title":"Kubernetes Container Runtime Interface","type":"post"},{"authors":null,"categories":null,"content":"","date":1461715200,"expirydate":-62135596800,"kind":"page","lang":"zh-hant","lastmod":1694442834,"objectID":"fcd4fd6219c1229c77d4228beb208235","permalink":"https://chechia.net/zh-hant/project/terraform-30-days/","publishdate":"2016-04-27T00:00:00Z","relpermalink":"/zh-hant/project/terraform-30-days/","section":"project","summary":"æ‰€æœ‰é—œæ–¼å…¬æœ‰é›² (Public Cloud) çš„å•é¡Œï¼Œæˆ‘ä¸€ç‡å»ºè­° Terraformã€‚Hashicorp Terraform æ˜¯é–‹æºçš„å®£å‘Šå¼ IaC ç®¡ç†å·¥å…·ï¼Œå°å…¬æœ‰é›²æ”¯æ´åº¦é«˜ã€‚æœ¬èª²ç¨‹å¦‚ä½•ä½¿ç”¨ Terraform ç®¡ç†å…¬æœ‰é›²ç«¯è³‡æºï¼Œå°å…¥ PR review / git-flow ç­‰è»Ÿé«”é–‹ç™¼æµç¨‹ï¼Œå¤§å¹…æå‡åœ˜éšŠæ•ˆç‡ï¼Œé™ä½äººç‚ºéŒ¯èª¤ã€‚æ˜¯å…¬æœ‰é›²ç®¡ç†å¿…å­¸å·¥å…·ã€‚","tags":["éµäººè³½2021","iac","azure","terraform"],"title":"Terraform 30 days Workshop - IaC for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©","type":"project"}]