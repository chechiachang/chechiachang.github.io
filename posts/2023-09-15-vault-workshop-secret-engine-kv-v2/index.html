<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Vault Workshop 04: Secret Engine KV V2 | Che-Chia Chang</title><meta name=keywords content="vault,iac,workshop,terraform,鐵人賽2023,chatgpt"><meta name=description content="如果你希望追蹤最新的草稿，請見鐵人賽2023
本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證
整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground
Day 04：Secret Engine KV V2
KV秘密引擎，用於在Vault的已配置物理Storage中，存儲任意秘密。
key 名稱必須始終是字符串。如果你直接通過CLI編寫非字串 value，它們將被轉換為字串。但是，你可以通過從JSON文件中將key-value pair寫入Vault，或使用HTTP API來保留非字串 value。
此秘密引擎遵照ACL policy中，創建(create)和更新(update)權限之間的設定。它還支持patch功能，用於表示部分更新(patch)，而更新功能(update)則表示完全覆蓋。
設置
大多數秘密引擎必須在執行其功能之前事先配置。這些步驟通常由操作人員或配置管理工具完成。
啟用v2 kv秘密引擎：
啟動一個乾淨的本地的開發模式 Vault Server，全新的 Vault Server 包含底下預設啟用的引擎
vault server -dev

export VAULT_ADDR='http://127.0.0.1:8200'

vault secrets list

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_57a4ca51    per-token private secret storage
identity/     identity     identity_c2ecbd49     identity store
secret/       kv           kv_c41afde8           key/value secret storage
sys/          system       system_c063e514       system endpoints used for control, policy and debugging

你可以在指定的路徑下，啟用一個新的 v2 kv 秘密引擎。若不指定 -path 參數，則預設 path 為 type，也就是 path=kv。"><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chechia.net/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Vault Workshop 04: Secret Engine KV V2"><meta property="og:description" content="如果你希望追蹤最新的草稿，請見鐵人賽2023
本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證
整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground
Day 04：Secret Engine KV V2 KV秘密引擎，用於在Vault的已配置物理Storage中，存儲任意秘密。
key 名稱必須始終是字符串。如果你直接通過CLI編寫非字串 value，它們將被轉換為字串。但是，你可以通過從JSON文件中將key-value pair寫入Vault，或使用HTTP API來保留非字串 value。
此秘密引擎遵照ACL policy中，創建(create)和更新(update)權限之間的設定。它還支持patch功能，用於表示部分更新(patch)，而更新功能(update)則表示完全覆蓋。
設置 大多數秘密引擎必須在執行其功能之前事先配置。這些步驟通常由操作人員或配置管理工具完成。
啟用v2 kv秘密引擎：
啟動一個乾淨的本地的開發模式 Vault Server，全新的 Vault Server 包含底下預設啟用的引擎
vault server -dev export VAULT_ADDR='http://127.0.0.1:8200' vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging 你可以在指定的路徑下，啟用一個新的 v2 kv 秘密引擎。若不指定 -path 參數，則預設 path 為 type，也就是 path=kv。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-14T00:42:26+08:00"><meta property="article:modified_time" content="2023-09-14T00:42:26+08:00"><meta property="article:tag" content="Vault"><meta property="article:tag" content="Iac"><meta property="article:tag" content="Workshop"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="鐵人賽2023"><meta property="article:tag" content="Chatgpt"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Vault Workshop 04: Secret Engine KV V2"><meta name=twitter:description content="如果你希望追蹤最新的草稿，請見鐵人賽2023
本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證
整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground
Day 04：Secret Engine KV V2
KV秘密引擎，用於在Vault的已配置物理Storage中，存儲任意秘密。
key 名稱必須始終是字符串。如果你直接通過CLI編寫非字串 value，它們將被轉換為字串。但是，你可以通過從JSON文件中將key-value pair寫入Vault，或使用HTTP API來保留非字串 value。
此秘密引擎遵照ACL policy中，創建(create)和更新(update)權限之間的設定。它還支持patch功能，用於表示部分更新(patch)，而更新功能(update)則表示完全覆蓋。
設置
大多數秘密引擎必須在執行其功能之前事先配置。這些步驟通常由操作人員或配置管理工具完成。
啟用v2 kv秘密引擎：
啟動一個乾淨的本地的開發模式 Vault Server，全新的 Vault Server 包含底下預設啟用的引擎
vault server -dev

export VAULT_ADDR='http://127.0.0.1:8200'

vault secrets list

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_57a4ca51    per-token private secret storage
identity/     identity     identity_c2ecbd49     identity store
secret/       kv           kv_c41afde8           key/value secret storage
sys/          system       system_c063e514       system endpoints used for control, policy and debugging

你可以在指定的路徑下，啟用一個新的 v2 kv 秘密引擎。若不指定 -path 參數，則預設 path 為 type，也就是 path=kv。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Vault Workshop 04: Secret Engine KV V2","item":"https://chechia.net/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Vault Workshop 04: Secret Engine KV V2","name":"Vault Workshop 04: Secret Engine KV V2","description":"如果你希望追蹤最新的草稿，請見鐵人賽2023\n本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證\n整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground\nDay 04：Secret Engine KV V2 KV秘密引擎，用於在Vault的已配置物理Storage中，存儲任意秘密。\nkey 名稱必須始終是字符串。如果你直接通過CLI編寫非字串 value，它們將被轉換為字串。但是，你可以通過從JSON文件中將key-value pair寫入Vault，或使用HTTP API來保留非字串 value。\n此秘密引擎遵照ACL policy中，創建(create)和更新(update)權限之間的設定。它還支持patch功能，用於表示部分更新(patch)，而更新功能(update)則表示完全覆蓋。\n設置 大多數秘密引擎必須在執行其功能之前事先配置。這些步驟通常由操作人員或配置管理工具完成。\n啟用v2 kv秘密引擎：\n啟動一個乾淨的本地的開發模式 Vault Server，全新的 Vault Server 包含底下預設啟用的引擎\nvault server -dev export VAULT_ADDR='http://127.0.0.1:8200' vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging 你可以在指定的路徑下，啟用一個新的 v2 kv 秘密引擎。若不指定 -path 參數，則預設 path 為 type，也就是 path=kv。\n","keywords":["vault","iac","workshop","terraform","鐵人賽2023","chatgpt"],"articleBody":"如果你希望追蹤最新的草稿，請見鐵人賽2023\n本 workshop 也接受網友的許願清單，如果有興趣的題目可於第一篇底下留言，筆者會盡力實現，但不做任何保證\n整篇 Workshop 會使用的範例與原始碼，放在 Github Repository: vault-playground\nDay 04：Secret Engine KV V2 KV秘密引擎，用於在Vault的已配置物理Storage中，存儲任意秘密。\nkey 名稱必須始終是字符串。如果你直接通過CLI編寫非字串 value，它們將被轉換為字串。但是，你可以通過從JSON文件中將key-value pair寫入Vault，或使用HTTP API來保留非字串 value。\n此秘密引擎遵照ACL policy中，創建(create)和更新(update)權限之間的設定。它還支持patch功能，用於表示部分更新(patch)，而更新功能(update)則表示完全覆蓋。\n設置 大多數秘密引擎必須在執行其功能之前事先配置。這些步驟通常由操作人員或配置管理工具完成。\n啟用v2 kv秘密引擎：\n啟動一個乾淨的本地的開發模式 Vault Server，全新的 Vault Server 包含底下預設啟用的引擎\nvault server -dev export VAULT_ADDR='http://127.0.0.1:8200' vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging 你可以在指定的路徑下，啟用一個新的 v2 kv 秘密引擎。若不指定 -path 參數，則預設 path 為 type，也就是 path=kv。\nvault secrets enable -version=2 -path=kv kv Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store kv/ kv kv_904eee17 n/a secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging 或者，你可以將kv-v2作為秘密引擎類型，以參數傳遞：\nvault secrets enable kv-v2 上面的指令與下面的指令等效，重複執行會出現路徑重複錯誤\nvault secrets enable -path kv-v2 -version=2 kv-v2 Error enabling: Error making API request. URL: POST http://127.0.0.1:8200/v1/sys/mounts/kv-v2 Code: 400. Errors: * path is already in use at kv-v2/ 你可以停用一個秘密引擎\nvault secrets disable kv-v2 為了學習效果，往後課程都會使用更完整的指令，作為示範。\n更多啟用秘密引擎的指令，你可以參考 vault secrets enable –help 的協助指令\nvault secrets enable --help Usage: vault secrets enable [options] TYPE Enables a secrets engine. By default, secrets engines are enabled at the path corresponding to their TYPE, but users can customize the path using the -path option. 啟用秘密引擎。預設情況下，秘密引擎會在與其類型相對應的路徑啟用，但使用者可以使用 -path 選項自訂路徑。 Once enabled, Vault will route all requests which begin with the path to the secrets engine. 一旦啟用，Vault 將將所有以該路徑開頭的請求路由到秘密引擎。 Enable the AWS secrets engine at aws/: $ vault secrets enable aws Enable the SSH secrets engine at ssh-prod/: $ vault secrets enable -path=ssh-prod ssh Enable the database secrets engine with an explicit maximum TTL of 30m: $ vault secrets enable -max-lease-ttl=30m database Enable a custom plugin (after it is registered in the plugin registry): $ vault secrets enable -path=my-secrets -plugin-name=my-plugin plugin OR (preferred way): $ vault secrets enable -path=my-secrets my-plugin 從上面的內容，可以看到秘密引擎支援各種不同的秘密類型，例如以下都是一個秘密引擎類型：aws，ssh，database，plugin。\n注意，請不要弄混 path=aws 的秘密引擎，以及 type=aws 的秘密引擎。底下是一個十分混淆的例子：\nvault secrets enable --version=2 --path=kv-v1 kv vault secrets enable --version=1 --path=kv-v2 kv vault secrets list --detailed Path Plugin Accessor Default TTL Max TTL Force No Cache Replication Seal Wrap External Entropy Access Options Description UUID Version Running Version Running SHA256 Deprecation Status ---- ------ -------- ----------- ------- -------------- ----------- --------- ----------------------- ------- ----------- ---- ------- --------------- -------------- ------------------ cubbyhole/ cubbyhole cubbyhole_57a4ca51 n/a n/a false local false false map[] per-token private secret storage cee0001e-95f8-efaa-6a9a-a3d5c3573abc n/a v1.14.3+builtin.vault n/a n/a identity/ identity identity_c2ecbd49 system system false replicated false false map[] identity store 3b481e0d-1c6d-6698-85c3-c52839b4d6e4 n/a v1.14.3+builtin.vault n/a n/a kv-v1/ kv kv_c8de7a39 system system false replicated false false map[version:2] n/a 98289587-5b5d-06f3-c3cf-469e830eda9e n/a v0.15.0+builtin n/a supported kv-v2/ kv kv_f83d9acd system system false replicated false false map[version:1] n/a 5fc 請不要做這種不良的命名，誤導自己也誤導別人。不建議把 engine type 當作 path，實務上也沒有必要這個做。\nvault secrets disable kv-v1 vault secrets disable kv-v2 使用公司組織，團隊，專案名稱，作為 engine path 的命名，是個不錯的起點。\norg = chechia.net team = sre project = workshop vault secrets enable --version=2 --path=chechia-net/sre/workshop kv 使用 v2 kv 在秘密引擎配置完成，且用戶/機器具備具有適當權限的Vault token後，它可以生成憑證。KV秘密引擎允許將任意vvalue寫入指定的key。\n在KV-v2中仍然可以使用類似路徑的KV-v1語法來引用秘密（secret/foo），但我們建議使用-flag的語法以避免將其錯誤認為是秘密的實際路徑（secret/data/foo是真正的路徑）。\n寫入/讀取任意資料 寫入任意資料：\nvault kv put -mount=chechia-net/sre/workshop my-secret foo=a bar=b ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata deletion_time n/a destroyed false version 1 讀取任意資料：\nvault kv get -mount=chechia-net/sre/workshop my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata deletion_time n/a destroyed false version 1 === Data === Key Value --- ----- bar b foo a 多版本控制 v2 kv 支援記錄多版本的秘密。請提供另一個版本，以前的版本仍然可訪問。\n可以選擇傳遞-cas flag以執行寫入前檢查(check-and-set)。如果未設置，將直接允許寫入。\n為了使寫入成功，cas必須設置為秘密的當前版本。如果設置為0，只有在密鑰不存在時才允許寫入，因為未設置的密鑰沒有任何版本信息。\n還要記住，soft delete 不會從存儲中刪除任何底層版本數據。為了寫入 soft delete 的密鑰，cas參數必須匹配密鑰的當前版本。\nvault kv put -mount=chechia-net/sre/workshop -cas=1 my-secret foo=aa bar=bb ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:50:26.621978Z custom_metadata deletion_time n/a destroyed false version 2 讀取會回傳最新版本的秘密\nvault kv get -mount=chechia-net/sre/workshop my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:50:26.621978Z custom_metadata deletion_time n/a destroyed false version 2 === Data === Key Value --- ----- bar bb foo aa 可以使用vault kv patch命令進行部分更新。\n該命令將首先嘗試進行HTTP PATCH請求，該請求需要patch ACL功能。如果使用的 token 沒有允許patch功能的policy，則PATCH請求將失敗。\n在現在的範例，完整的PATCH命令將執行讀取、本地更新和後續寫入，這需要讀取和更新ACL policy權限。\n可以選擇傳遞-cas flag 以執行寫入前檢查(check-and-set)。-cas 只會在初始PATCH請求的情況下生效。\nvault kv patch -mount=chechia-net/sre/workshop -cas=2 my-secret bar=bbb ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:54:03.925959Z custom_metadata deletion_time n/a destroyed false version 3 vault kv patch命令還支持一個 -method 標誌，可用於指定兩種 method\nHTTP PATCH 讀取後寫入(read-and-write) 支持的值分別是patch和rw 使用patch方法\nvault kv patch -mount=chechia-net/sre/workshop -method=patch -cas=3 my-secret bar=bbb ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:02:55.522095Z custom_metadata deletion_time n/a destroyed false version 4 使用read-and-write\n如果使用讀取後寫入(read-and-write)流程，將使用讀取返回的秘密版本值，在後續寫入中，執行寫入前檢查(check-and-set)。\nvault kv patch -mount=chechia-net/sre/workshop -method=rw my-secret bar=ccc ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z custom_metadata deletion_time n/a destroyed false version 5 你可以使用 -version flag 來存取更早的版本\nvault kv get -mount=chechia-net/sre/workshop -version=1 my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata deletion_time n/a destroyed false version 1 === Data === Key Value --- ----- bar b foo a 刪除資料 在刪除資料時，標準的 vault kv delete 命令將執行 soft delet。它將標記版本為已刪除並填充 deletion_time timestamp。soft delete 不會從存儲中刪除底層版本資料，這允許版本可以被還原\n還原版本\nvault kv undelete 只有當秘密的版本數超過 max-versions 設置允許的版本數時，或者使用 vault kv destroy 時，版本的資料才會永久刪除。\n使用 destroy 命令時，底層版本資料將被刪除，並將密鑰 metadata 標記為已銷毀。如果通過超過 max-versions 來清理版本，則版本 metadata 也將從密鑰中刪除。\n可以使用 delete 命令刪除密鑰的最新版本，這也可以使用 -versions 標誌刪除之前的版本：\nvault kv delete -mount=chechia-net/sre/workshop my-secret Success! Data deleted (if it existed) at: chechia-net/sre/workshop/data/my-secret 讀取 version=5 時，只回傳 metadata，無法讀取資料\nvault kv get -mount=chechia-net/sre/workshop -version=5 my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z custom_metadata deletion_time 2023-09-15T17:10:01.558586Z destroyed false version 5 讀取 version=4 時，可以順利讀取資料\nvault kv get -mount=chechia-net/sre/workshop -version=4 my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:02:55.522095Z custom_metadata deletion_time n/a destroyed false version 4 === Data === Key Value --- ----- bar bbb foo aa 你可以復原一個刪除的版本 version=5\nvault kv undelete -versions=5 chechia-net/sre/workshop/my-secret Success! Data written to: chechia-net/sre/workshop/undelete/my-secret 這邊 undelete 使用了 legacy 的 secret path，而不使用 -mount flag，是因為 v2 kv 在處理多層 mount path 的 bug Github Issue: #19811，PR #19811 is comming lol。\nvault kv undelete -versions=5 -mount=chechia-net/sre/workshop my-secret Error writing data to workshop/undelete/my-secret: Error making API request. URL: PUT http://127.0.0.1:8200/v1/workshop/undelete/my-secret Code: 404. Errors: * no handler for route \"workshop/undelete/my-secret\". route entry not found. metadata 所有版本和密鑰 metadata 可以使用 metadata 命令和API 進行檢查。\n刪除 metadata 密鑰將導致該密鑰的所有 metadata 和版本永久刪除。\n有關更多信息，请參見以下命令：\n可以查看密鑰的所有元數據和版本：\nvault kv metadata get -mount=chechia-net/sre/workshop my-secret ============== Metadata Path ============== chechia-net/sre/workshop/metadata/my-secret ========== Metadata ========== Key Value --- ----- cas_required false created_time 2023-09-15T16:48:45.817265Z current_version 5 custom_metadata delete_version_after 0s max_versions 0 oldest_version 0 updated_time 2023-09-15T17:03:37.331182Z ====== Version 1 ====== Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z deletion_time n/a destroyed false ====== Version 2 ====== Key Value --- ----- created_time 2023-09-15T16:50:26.621978Z deletion_time n/a destroyed false ====== Version 3 ====== Key Value --- ----- created_time 2023-09-15T16:54:03.925959Z deletion_time n/a destroyed false ====== Version 4 ====== Key Value --- ----- created_time 2023-09-15T17:02:55.522095Z deletion_time n/a destroyed false ====== Version 5 ====== Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z deletion_time 2023-09-15T17:15:40.767682Z destroyed false 你可以透過更改 metadata API 調整 secret 的屬性\nvault kv metadata put -mount=chechia-net/sre/workshop \\ -max-versions 2 \\ -delete-version-after=\"3h25m19s\" my-secret Success! Data written to: secret/metadata/my-secret Delete-version-after 只會應用在新的版本上，Max versions changes 會應用在下次寫入\nvault kv put -mount=chechia-net/sre/workshop my-secret new=123 ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:34:09.61954Z custom_metadata deletion_time 2023-09-15T20:59:28.61954Z destroyed false version 6 根據 max-version 的設定結果，只保留 version=5 與 version=6，更舊的版本都被刪除\nvault kv metadata get -mount=chechia-net/sre/workshop my-secret ============== Metadata Path ============== chechia-net/sre/workshop/metadata/my-secret ========== Metadata ========== Key Value --- ----- cas_required false created_time 2023-09-15T16:48:45.817265Z current_version 6 custom_metadata delete_version_after 3h25m19s max_versions 2 oldest_version 5 updated_time 2023-09-15T17:34:09.61954Z ====== Version 5 ====== Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z deletion_time 2023-09-15T17:15:40.767682Z destroyed false ====== Version 6 ====== Key Value --- ----- created_time 2023-09-15T17:34:09.61954Z deletion_time 2023-09-15T20:59:28.61954Z destroyed false Vault 命名空間(namespace) 和掛載(mount)結構 命名空間是功能上創建“Vault中的Vault”的隔離環境。它們具有獨立的登錄路徑，並支持創建和管理與其命名空間隔離的數據。此功能使你能夠將Vault作為服務提供給租戶。\n為什麼這個主題很重要？\nVault中的一切都是基於路徑的。每個路徑對應於Vault中的操作或秘密，Vault API endpoint映射到這些路徑。因此，編寫 policy 會配置對特定秘密 path 的允許操作。\n例如，為了授予管理根命名空間中的令牌的訪問權限，策略路徑是auth/token/。要管理教育命名空間中的令牌，完全合格的路徑在功能上變為education/auth/token/。\n以下圖表示了基於授權方法和秘密引擎啟用位置的API路徑。\n你可以使用命名空間，或為每個Vault客戶端專用的掛載來隔離秘密。\n例如，你可以為每個獨立的租戶創建一個命名空間，他們負責管理其命名空間下的資源。或者，你可以在組織內的每個團隊專用的路徑上安裝專用秘密引擎。\n根據如何隔離秘密，確定了誰負責管理這些秘密，更重要的是與這些秘密相關的策略。\nPrerequisites 如果你對Vault命名空間還不熟悉，請查看帶有命名空間的安全多租戶教程。\n注意\n創建命名空間應由具有高度特權令牌（例如root）的用戶執行，以為每個組織、團隊或應用程序設置隔離環境。\n部署注意事項 要計劃和設計Vault命名空間、授權方法路徑和秘密引擎路徑，你需要考慮如何為你的組織，設計Vault的邏輯對象。\n組織結構 - 你的組織結構是什麼？\n部門、團隊、服務、應用程序之間的層級，在Vault最終設計中需要反映什麼？\nVault policy 如何管理？\n團隊是否需要直接管理其負責範圍的 policy？\nchatGPT 本段內容使用 chatGPT-3.5 翻譯 https://developer.hashicorp.com/vault/docs/secrets/kv/kv-v2 https://developer.hashicorp.com/vault/tutorials/recommended-patterns/namespace-structure 內容，並由筆者人工校驗\nbase context\n我希望你能充當一名繁體中文翻譯，拼寫修正者和改進者。我將用英文與程式語言與你對話，你將翻譯它，並以已糾正且改進的版本回答，以繁體中文表達。我希望你能用更美麗和優雅、高級的繁體中文詞語和句子替換我簡化的詞語和句子。保持意義不變。我只希望你回答糾正和改進，不要寫解釋。不要使用敬語，請用你取代你。 result correction\n部分英文內容為專有名詞，產生的繁體中文翻譯結果中，這些名詞維持英文，不需要翻譯成中文：key，value，certificate，token，policy，policy rule，path，path-based，key rolling，audit，audit trail，plain text，key value，Consul，S3 bucket，Leasing，Renewal，binary，prefix，instance，metadata。 修正下列翻譯：數據改為資料，數據庫改為資料庫，數據改為資料，訪問改為存取，源代碼改為原始碼，信息改為資訊，命令改為指令，禁用改為停用，默認改為預設。 ","wordCount":"1269","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-09-14T00:42:26+08:00","dateModified":"2023-09-14T00:42:26+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://chechia.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chechia.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Vault Workshop 04: Secret Engine KV V2</h1><div class=post-meta><span title='2023-09-14 00:42:26 +0800 CST'>September 14, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1269 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/index.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#設置>設置</a></li><li><a href=#使用-v2-kv>使用 v2 kv</a></li><li><a href=#寫入讀取任意資料>寫入/讀取任意資料</a></li><li><a href=#多版本控制>多版本控制</a></li><li><a href=#刪除資料>刪除資料</a></li><li><a href=#metadata>metadata</a></li><li><a href=#vault-命名空間namespace-和掛載mount結構>Vault 命名空間(namespace) 和掛載(mount)結構</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#部署注意事項>部署注意事項</a></li><li><a href=#chatgpt>chatGPT</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>如果你希望追蹤最新的草稿，請見<a href=https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/>鐵人賽2023</a></p><p>本 workshop 也接受網友的許願清單，<a href=https://ithelp.ithome.com.tw/articles/10317378>如果有興趣的題目可於第一篇底下留言</a>，筆者會盡力實現，但不做任何保證</p><p>整篇 Workshop 會使用的範例與原始碼，放在 <a href=http://chechia.net/zh-hant/#projects>Github Repository: vault-playground</a></p><h1 id=day-04secret-engine-kv-v2>Day 04：Secret Engine KV V2<a hidden class=anchor aria-hidden=true href=#day-04secret-engine-kv-v2>#</a></h1><p>KV秘密引擎，用於在Vault的已配置物理Storage中，存儲任意秘密。</p><p>key 名稱必須始終是字符串。如果你直接通過CLI編寫非字串 value，它們將被轉換為字串。但是，你可以通過從JSON文件中將key-value pair寫入Vault，或使用HTTP API來保留非字串 value。</p><p>此秘密引擎遵照ACL policy中，創建(create)和更新(update)權限之間的設定。它還支持patch功能，用於表示部分更新(patch)，而更新功能(update)則表示完全覆蓋。</p><h3 id=設置>設置<a hidden class=anchor aria-hidden=true href=#設置>#</a></h3><p>大多數秘密引擎必須在執行其功能之前事先配置。這些步驟通常由操作人員或配置管理工具完成。</p><p>啟用v2 kv秘密引擎：</p><p>啟動一個乾淨的本地的開發模式 Vault Server，全新的 Vault Server 包含底下預設啟用的引擎</p><pre><code class=language-bash>vault server -dev

export VAULT_ADDR='http://127.0.0.1:8200'

vault secrets list

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_57a4ca51    per-token private secret storage
identity/     identity     identity_c2ecbd49     identity store
secret/       kv           kv_c41afde8           key/value secret storage
sys/          system       system_c063e514       system endpoints used for control, policy and debugging
</code></pre><p>你可以在指定的路徑下，啟用一個新的 v2 kv 秘密引擎。若不指定 -path 參數，則預設 path 為 type，也就是 path=kv。</p><pre><code class=language-bash>vault secrets enable -version=2 -path=kv kv

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_57a4ca51    per-token private secret storage
identity/     identity     identity_c2ecbd49     identity store
kv/           kv           kv_904eee17           n/a
secret/       kv           kv_c41afde8           key/value secret storage
sys/          system       system_c063e514       system endpoints used for control, policy and debugging
</code></pre><p>或者，你可以將kv-v2作為秘密引擎類型，以參數傳遞：</p><pre><code class=language-bash>vault secrets enable kv-v2
</code></pre><p>上面的指令與下面的指令等效，重複執行會出現路徑重複錯誤</p><pre><code class=language-bash>vault secrets enable -path kv-v2 -version=2 kv-v2

Error enabling: Error making API request.

URL: POST http://127.0.0.1:8200/v1/sys/mounts/kv-v2
Code: 400. Errors:

* path is already in use at kv-v2/
</code></pre><p>你可以停用一個秘密引擎</p><pre><code class=language-bash>vault secrets disable kv-v2
</code></pre><p>為了學習效果，往後課程都會使用更完整的指令，作為示範。</p><p>更多啟用秘密引擎的指令，你可以參考 vault secrets enable &ndash;help 的協助指令</p><pre><code class=language-bash>vault secrets enable --help

Usage: vault secrets enable [options] TYPE

  Enables a secrets engine. By default, secrets engines are enabled at the path
  corresponding to their TYPE, but users can customize the path using the
  -path option.

  啟用秘密引擎。預設情況下，秘密引擎會在與其類型相對應的路徑啟用，但使用者可以使用
  -path 選項自訂路徑。

  Once enabled, Vault will route all requests which begin with the path to the
  secrets engine.

  一旦啟用，Vault 將將所有以該路徑開頭的請求路由到秘密引擎。

  Enable the AWS secrets engine at aws/:

      $ vault secrets enable aws

  Enable the SSH secrets engine at ssh-prod/:

      $ vault secrets enable -path=ssh-prod ssh

  Enable the database secrets engine with an explicit maximum TTL of 30m:

      $ vault secrets enable -max-lease-ttl=30m database

  Enable a custom plugin (after it is registered in the plugin registry):

      $ vault secrets enable -path=my-secrets -plugin-name=my-plugin plugin

  OR (preferred way):

      $ vault secrets enable -path=my-secrets my-plugin
</code></pre><p>從上面的內容，可以看到秘密引擎支援各種不同的秘密類型，例如以下都是一個秘密引擎類型：aws，ssh，database，plugin。</p><p>注意，請不要弄混 path=aws 的秘密引擎，以及 type=aws 的秘密引擎。底下是一個十分混淆的例子：</p><pre><code class=language-bash>vault secrets enable --version=2 --path=kv-v1 kv
vault secrets enable --version=1 --path=kv-v2 kv

vault secrets list --detailed

Path          Plugin       Accessor              Default TTL    Max TTL    Force No Cache    Replication    Seal Wrap    External Entropy Access    Options           Description                                                UUID                                    Version    Running Version          Running SHA256    Deprecation Status
----          ------       --------              -----------    -------    --------------    -----------    ---------    -----------------------    -------           -----------                                                ----                                    -------    ---------------          --------------    ------------------
cubbyhole/    cubbyhole    cubbyhole_57a4ca51    n/a            n/a        false             local          false        false                      map[]             per-token private secret storage                           cee0001e-95f8-efaa-6a9a-a3d5c3573abc    n/a        v1.14.3+builtin.vault    n/a               n/a
identity/     identity     identity_c2ecbd49     system         system     false             replicated     false        false                      map[]             identity store                                             3b481e0d-1c6d-6698-85c3-c52839b4d6e4    n/a        v1.14.3+builtin.vault    n/a               n/a
kv-v1/        kv           kv_c8de7a39           system         system     false             replicated     false        false                      map[version:2]    n/a                                                        98289587-5b5d-06f3-c3cf-469e830eda9e    n/a        v0.15.0+builtin          n/a               supported
kv-v2/        kv           kv_f83d9acd           system         system     false             replicated     false        false                      map[version:1]    n/a                                                        5fc
</code></pre><p>請不要做這種不良的命名，誤導自己也誤導別人。不建議把 engine type 當作 path，實務上也沒有必要這個做。</p><pre><code class=language-bash>vault secrets disable kv-v1
vault secrets disable kv-v2
</code></pre><p>使用公司組織，團隊，專案名稱，作為 engine path 的命名，是個不錯的起點。</p><ul><li>org = chechia.net</li><li>team = sre</li><li>project = workshop</li></ul><pre><code class=language-bash>vault secrets enable --version=2 --path=chechia-net/sre/workshop kv
</code></pre><h3 id=使用-v2-kv>使用 v2 kv<a hidden class=anchor aria-hidden=true href=#使用-v2-kv>#</a></h3><p>在秘密引擎配置完成，且用戶/機器具備具有適當權限的Vault token後，它可以生成憑證。KV秘密引擎允許將任意vvalue寫入指定的key。</p><p>在KV-v2中仍然可以使用類似路徑的KV-v1語法來引用秘密（secret/foo），但我們建議使用-flag的語法以避免將其錯誤認為是秘密的實際路徑（secret/data/foo是真正的路徑）。</p><h3 id=寫入讀取任意資料>寫入/讀取任意資料<a hidden class=anchor aria-hidden=true href=#寫入讀取任意資料>#</a></h3><p>寫入任意資料：</p><pre><code class=language-bash>vault kv put -mount=chechia-net/sre/workshop my-secret foo=a bar=b

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T16:48:45.817265Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            1
</code></pre><p>讀取任意資料：</p><pre><code class=language-bash>vault kv get -mount=chechia-net/sre/workshop my-secret

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T16:48:45.817265Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            1

=== Data ===
Key    Value
---    -----
bar    b
foo    a
</code></pre><h3 id=多版本控制>多版本控制<a hidden class=anchor aria-hidden=true href=#多版本控制>#</a></h3><p>v2 kv 支援記錄多版本的秘密。請提供另一個版本，以前的版本仍然可訪問。</p><p>可以選擇傳遞-cas flag以執行寫入前檢查(check-and-set)。如果未設置，將直接允許寫入。</p><p>為了使寫入成功，cas必須設置為秘密的當前版本。如果設置為0，只有在密鑰不存在時才允許寫入，因為未設置的密鑰沒有任何版本信息。</p><p>還要記住，soft delete 不會從存儲中刪除任何底層版本數據。為了寫入 soft delete 的密鑰，cas參數必須匹配密鑰的當前版本。</p><pre><code class=language-bash>vault kv put -mount=chechia-net/sre/workshop -cas=1 my-secret foo=aa bar=bb

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T16:50:26.621978Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            2
</code></pre><p>讀取會回傳最新版本的秘密</p><pre><code class=language-bash>vault kv get -mount=chechia-net/sre/workshop my-secret

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T16:50:26.621978Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            2

=== Data ===
Key    Value
---    -----
bar    bb
foo    aa
</code></pre><p>可以使用vault kv patch命令進行部分更新。</p><p>該命令將首先嘗試進行HTTP PATCH請求，該請求需要patch ACL功能。如果使用的 token 沒有允許patch功能的policy，則PATCH請求將失敗。</p><p>在現在的範例，完整的PATCH命令將執行讀取、本地更新和後續寫入，這需要讀取和更新ACL policy權限。</p><p>可以選擇傳遞-cas flag 以執行寫入前檢查(check-and-set)。-cas 只會在初始PATCH請求的情況下生效。</p><pre><code class=language-bash>vault kv patch -mount=chechia-net/sre/workshop -cas=2 my-secret bar=bbb

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T16:54:03.925959Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            3
</code></pre><p>vault kv patch命令還支持一個 -method 標誌，可用於指定兩種 method</p><ul><li>HTTP PATCH</li><li>讀取後寫入(read-and-write)
支持的值分別是patch和rw</li></ul><p>使用patch方法</p><pre><code class=language-bash>vault kv patch -mount=chechia-net/sre/workshop -method=patch -cas=3 my-secret bar=bbb

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T17:02:55.522095Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            4
</code></pre><p>使用read-and-write</p><p>如果使用讀取後寫入(read-and-write)流程，將使用讀取返回的秘密版本值，在後續寫入中，執行寫入前檢查(check-and-set)。</p><pre><code class=language-bash>vault kv patch -mount=chechia-net/sre/workshop -method=rw my-secret bar=ccc

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T17:03:37.331182Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            5
</code></pre><p>你可以使用 -version flag 來存取更早的版本</p><pre><code class=language-bash>vault kv get -mount=chechia-net/sre/workshop -version=1 my-secret

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T16:48:45.817265Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            1

=== Data ===
Key    Value
---    -----
bar    b
foo    a
</code></pre><h3 id=刪除資料>刪除資料<a hidden class=anchor aria-hidden=true href=#刪除資料>#</a></h3><p>在刪除資料時，標準的 vault kv delete 命令將執行 soft delet。它將標記版本為已刪除並填充 <code>deletion_time</code> timestamp。soft delete 不會從存儲中刪除底層版本資料，這允許版本可以被還原</p><p>還原版本</p><pre><code class=language-bash>vault kv undelete
</code></pre><p>只有當秘密的版本數超過 max-versions 設置允許的版本數時，或者使用 vault kv destroy 時，版本的資料才會永久刪除。</p><p>使用 destroy 命令時，底層版本資料將被刪除，並將密鑰 metadata 標記為已銷毀。如果通過超過 max-versions 來清理版本，則版本 metadata 也將從密鑰中刪除。</p><p>可以使用 delete 命令刪除密鑰的最新版本，這也可以使用 -versions 標誌刪除之前的版本：</p><pre><code class=language-bash>vault kv delete -mount=chechia-net/sre/workshop my-secret

Success! Data deleted (if it existed) at: chechia-net/sre/workshop/data/my-secret
</code></pre><p>讀取 version=5 時，只回傳 metadata，無法讀取資料</p><pre><code class=language-bash>vault kv get -mount=chechia-net/sre/workshop -version=5 my-secret

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T17:03:37.331182Z
custom_metadata    &lt;nil&gt;
deletion_time      2023-09-15T17:10:01.558586Z
destroyed          false
version            5
</code></pre><p>讀取 version=4 時，可以順利讀取資料</p><pre><code class=language-bash>vault kv get -mount=chechia-net/sre/workshop -version=4 my-secret

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T17:02:55.522095Z
custom_metadata    &lt;nil&gt;
deletion_time      n/a
destroyed          false
version            4

=== Data ===
Key    Value
---    -----
bar    bbb
foo    aa
</code></pre><p>你可以復原一個刪除的版本 version=5</p><pre><code class=language-bash>vault kv undelete -versions=5  chechia-net/sre/workshop/my-secret

Success! Data written to: chechia-net/sre/workshop/undelete/my-secret
</code></pre><p>這邊 undelete 使用了 legacy 的 secret path，而不使用 -mount flag，是因為 v2 kv 在處理多層 mount path 的 bug <a href=https://github.com/hashicorp/vault/pull/19811>Github Issue: #19811</a>，<a href=https://github.com/hashicorp/vault/pull/19811>PR #19811</a> is comming lol。</p><pre><code class=language-bash>vault kv undelete -versions=5 -mount=chechia-net/sre/workshop my-secret

Error writing data to workshop/undelete/my-secret: Error making API request.

URL: PUT http://127.0.0.1:8200/v1/workshop/undelete/my-secret
Code: 404. Errors:

* no handler for route &quot;workshop/undelete/my-secret&quot;. route entry not found.
</code></pre><h3 id=metadata>metadata<a hidden class=anchor aria-hidden=true href=#metadata>#</a></h3><p>所有版本和密鑰 metadata 可以使用 metadata 命令和API 進行檢查。</p><p>刪除 metadata 密鑰將導致該密鑰的所有 metadata 和版本永久刪除。</p><p>有關更多信息，请參見以下命令：</p><p>可以查看密鑰的所有元數據和版本：</p><pre><code class=language-bash>vault kv metadata get -mount=chechia-net/sre/workshop my-secret

============== Metadata Path ==============
chechia-net/sre/workshop/metadata/my-secret

========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2023-09-15T16:48:45.817265Z
current_version         5
custom_metadata         &lt;nil&gt;
delete_version_after    0s
max_versions            0
oldest_version          0
updated_time            2023-09-15T17:03:37.331182Z

====== Version 1 ======
Key              Value
---              -----
created_time     2023-09-15T16:48:45.817265Z
deletion_time    n/a
destroyed        false

====== Version 2 ======
Key              Value
---              -----
created_time     2023-09-15T16:50:26.621978Z
deletion_time    n/a
destroyed        false

====== Version 3 ======
Key              Value
---              -----
created_time     2023-09-15T16:54:03.925959Z
deletion_time    n/a
destroyed        false

====== Version 4 ======
Key              Value
---              -----
created_time     2023-09-15T17:02:55.522095Z
deletion_time    n/a
destroyed        false

====== Version 5 ======
Key              Value
---              -----
created_time     2023-09-15T17:03:37.331182Z
deletion_time    2023-09-15T17:15:40.767682Z
destroyed        false
</code></pre><p>你可以透過更改 metadata API 調整 secret 的屬性</p><pre><code class=language-bash>vault kv metadata put -mount=chechia-net/sre/workshop \
    -max-versions 2 \
    -delete-version-after=&quot;3h25m19s&quot; my-secret

Success! Data written to: secret/metadata/my-secret
</code></pre><p>Delete-version-after 只會應用在新的版本上，Max versions changes 會應用在下次寫入</p><pre><code class=language-bash>vault kv put -mount=chechia-net/sre/workshop my-secret new=123

============= Secret Path =============
chechia-net/sre/workshop/data/my-secret

======= Metadata =======
Key                Value
---                -----
created_time       2023-09-15T17:34:09.61954Z
custom_metadata    &lt;nil&gt;
deletion_time      2023-09-15T20:59:28.61954Z
destroyed          false
version            6
</code></pre><p>根據 max-version 的設定結果，只保留 version=5 與 version=6，更舊的版本都被刪除</p><pre><code class=language-bash>vault kv metadata get -mount=chechia-net/sre/workshop my-secret

============== Metadata Path ==============
chechia-net/sre/workshop/metadata/my-secret

========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2023-09-15T16:48:45.817265Z
current_version         6
custom_metadata         &lt;nil&gt;
delete_version_after    3h25m19s
max_versions            2
oldest_version          5
updated_time            2023-09-15T17:34:09.61954Z

====== Version 5 ======
Key              Value
---              -----
created_time     2023-09-15T17:03:37.331182Z
deletion_time    2023-09-15T17:15:40.767682Z
destroyed        false

====== Version 6 ======
Key              Value
---              -----
created_time     2023-09-15T17:34:09.61954Z
deletion_time    2023-09-15T20:59:28.61954Z
destroyed        false
</code></pre><h3 id=vault-命名空間namespace-和掛載mount結構>Vault 命名空間(namespace) 和掛載(mount)結構<a hidden class=anchor aria-hidden=true href=#vault-命名空間namespace-和掛載mount結構>#</a></h3><p>命名空間是功能上創建“Vault中的Vault”的隔離環境。它們具有獨立的登錄路徑，並支持創建和管理與其命名空間隔離的數據。此功能使你能夠將Vault作為服務提供給租戶。</p><p>為什麼這個主題很重要？</p><p>Vault中的一切都是基於路徑的。每個路徑對應於Vault中的操作或秘密，Vault API endpoint映射到這些路徑。因此，編寫 policy 會配置對特定秘密 path 的允許操作。</p><p>例如，為了授予管理根命名空間中的令牌的訪問權限，策略路徑是auth/token/。要管理教育命名空間中的令牌，完全合格的路徑在功能上變為education/auth/token/。</p><p>以下圖表示了基於授權方法和秘密引擎啟用位置的API路徑。</p><p><img loading=lazy src="https://developer.hashicorp.com/_next/image?url=https%3A%2F%2Fcontent.hashicorp.com%2Fapi%2Fassets%3Fproduct%3Dtutorials%26version%3Dmain%26asset%3Dpublic%252Fimg%252Fvault%252Fdiagram_namespaces_paths.png%26width%3D1273%26height%3D582&w=3840&q=75"></p><p>你可以使用命名空間，或為每個Vault客戶端專用的掛載來隔離秘密。</p><p>例如，你可以為每個獨立的租戶創建一個命名空間，他們負責管理其命名空間下的資源。或者，你可以在組織內的每個團隊專用的路徑上安裝專用秘密引擎。</p><p><img alt=命名空間最佳實踐 loading=lazy src="https://developer.hashicorp.com/_next/image?url=https%3A%2F%2Fcontent.hashicorp.com%2Fapi%2Fassets%3Fproduct%3Dtutorials%26version%3Dmain%26asset%3Dpublic%252Fimg%252Fvault%252Fdiagram_namespaces_intro.png%26width%3D953%26height%3D444&w=1920&q=75"></p><p>根據如何隔離秘密，確定了誰負責管理這些秘密，更重要的是與這些秘密相關的策略。</p><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><p>如果你對Vault命名空間還不熟悉，請查看帶有命名空間的安全多租戶教程。</p><p>注意</p><p>創建命名空間應由具有高度特權令牌（例如root）的用戶執行，以為每個組織、團隊或應用程序設置隔離環境。</p><h3 id=部署注意事項>部署注意事項<a hidden class=anchor aria-hidden=true href=#部署注意事項>#</a></h3><p>要計劃和設計Vault命名空間、授權方法路徑和秘密引擎路徑，你需要考慮如何為你的組織，設計Vault的邏輯對象。</p><p>組織結構 - 你的組織結構是什麼？</p><p>部門、團隊、服務、應用程序之間的層級，在Vault最終設計中需要反映什麼？</p><p>Vault policy 如何管理？</p><p>團隊是否需要直接管理其負責範圍的 policy？</p><h3 id=chatgpt>chatGPT<a hidden class=anchor aria-hidden=true href=#chatgpt>#</a></h3><p>本段內容使用 chatGPT-3.5 翻譯
<a href=https://developer.hashicorp.com/vault/docs/secrets/kv/kv-v2>https://developer.hashicorp.com/vault/docs/secrets/kv/kv-v2</a>
<a href=https://developer.hashicorp.com/vault/tutorials/recommended-patterns/namespace-structure>https://developer.hashicorp.com/vault/tutorials/recommended-patterns/namespace-structure</a>
內容，並由筆者人工校驗</p><p>base context</p><pre><code>我希望你能充當一名繁體中文翻譯，拼寫修正者和改進者。我將用英文與程式語言與你對話，你將翻譯它，並以已糾正且改進的版本回答，以繁體中文表達。我希望你能用更美麗和優雅、高級的繁體中文詞語和句子替換我簡化的詞語和句子。保持意義不變。我只希望你回答糾正和改進，不要寫解釋。不要使用敬語，請用你取代你。
</code></pre><p>result correction</p><pre><code>部分英文內容為專有名詞，產生的繁體中文翻譯結果中，這些名詞維持英文，不需要翻譯成中文：key，value，certificate，token，policy，policy rule，path，path-based，key rolling，audit，audit trail，plain text，key value，Consul，S3 bucket，Leasing，Renewal，binary，prefix，instance，metadata。

修正下列翻譯：數據改為資料，數據庫改為資料庫，數據改為資料，訪問改為存取，源代碼改為原始碼，信息改為資訊，命令改為指令，禁用改為停用，默認改為預設。
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/vault/>Vault</a></li><li><a href=https://chechia.net/tags/iac/>Iac</a></li><li><a href=https://chechia.net/tags/workshop/>Workshop</a></li><li><a href=https://chechia.net/tags/terraform/>Terraform</a></li><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/>鐵人賽2023</a></li><li><a href=https://chechia.net/tags/chatgpt/>Chatgpt</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2023-09-16-vault-workshop-authentication/><span class=title>« Prev</span><br><span>Vault Workshop 05: Authentication</span>
</a><a class=next href=https://chechia.net/posts/2023-09-14-vault-workshop-secret-engine/><span class=title>Next »</span><br><span>Vault Workshop 03: Secret Engine</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on x" href="https://x.com/intent/tweet/?text=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f&amp;hashtags=vault%2ciac%2cworkshop%2cterraform%2c%e9%90%b5%e4%ba%ba%e8%b3%bd2023%2cchatgpt"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f&amp;title=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2&amp;summary=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f&title=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on whatsapp" href="https://api.whatsapp.com/send?text=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2%20-%20https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on telegram" href="https://telegram.me/share/url?text=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vault Workshop 04: Secret Engine KV V2 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Vault%20Workshop%2004%3a%20Secret%20Engine%20KV%20V2&u=https%3a%2f%2fchechia.net%2fposts%2f2023-09-15-vault-workshop-secret-engine-kv-v2%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>