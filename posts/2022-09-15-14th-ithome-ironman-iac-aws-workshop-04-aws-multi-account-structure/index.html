<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS Multi-Accounts Structure | Che-Chia Chang</title><meta name=keywords content="terraform,iac,aws,鐵人賽2022"><meta name=description content="Article description."><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="AWS Multi-Accounts Structure"><meta property="og:description" content="Article description."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-18T09:35:25+08:00"><meta property="article:modified_time" content="2022-09-18T09:35:25+08:00"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Iac"><meta property="article:tag" content="Aws"><meta property="article:tag" content="鐵人賽2022"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="AWS Multi-Accounts Structure"><meta name=twitter:description content="Article description."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"AWS Multi-Accounts Structure","item":"https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Multi-Accounts Structure","name":"AWS Multi-Accounts Structure","description":"Article description.","keywords":["terraform","iac","aws","鐵人賽2022"],"articleBody":"昨天設定了多個 aws organization accounts，但我們還沒有說明為什麼要這樣做\n今天會先講 Gruntwork 提出的 Production-Grade Design: multi-account security strategy\n拆分多個 account 的用意 多 account 下如何統一管理 IAM User access control 與安全性控管 iThome 鐵人賽好讀版\n賽後文章會整理放到個人的部落格上 http://chechia.net/\n追蹤粉專可以收到文章的主動推播\nProduction-grade Design IAM Gruntwork 提出的 Production-Grade Design: multi-account security strategy，我們這邊一一講解\nRoot Account 的用途 位於 diagram 圖中的最上層 是整個架構的創世帳號，權限最大 root account 裡面沒有任何 infrastructure 元件， i.e. aws ec2 不會長在裡面，是一個空 account root account 的存取最嚴格 只有很少數的 admin 可以存取 i.e 只有 SRE 部門主管有自己的 IAM User，其他 SRE 沒有權限存取 root account root account 的工作最少 設定 child account 管理 billing IAM policy 管理，不要把 policy 直接綁在 User 上，應該要\n為不同權責的成員設定 IAM Group，ex. dev-admin / dev-user / stag-admin / qa / billing / … 把 policy 綁在 Group 上，ex. ReadPermission -\u003e dev-user / Read+Write -\u003e dev-admin 把 User 加進 / 移除 Group，來管理人員權限 Group 通常會接近公司團隊的職責分配 root account 內部只會有 full-access 的管理員 group billing 的會計出帳 group Child Account 的用途 透過 root account 創建 child accounts 後，這裡說明各個 account 的設計用途\nSecurity 用來管理 authentication 與 authorization\n底下一樣沒有任何 infrastructure 元件 定義所有 IAM User 與 IAM Group，所有團隊成員的 User 在這邊設定 所有的 User 放在 Security 底下統一管理 其他的 child account 不會設定 IAM User，ex. dev / stag / prod 裡面都沒有 IAM User child account 中設定 IAM roles，讓 security/user assume role 存取其他 child account ex. security/dev-admin/chechia assume role dev/admin，透過 aws STS(Security Token Service) 暫時取得 dev/admin 這個 role 的權限來控制 dev 團隊主管也會有一個 security IAM User，平時開發 infrastructure 使用這個 IAM User，只有需要調整 root account 時才會動用 root account IAM User。反正 root account 是能不用就不用 這個做法有非常多好處，但又不會造成工作上的負擔\n使用方面：所有的團隊成員只會有一個 User，透過 security 登入。不會一個人有好幾個帳號密碼很煩 管理方面：管理員只要在 security 內管理 User，而不用一直切換 account 去調整 IAM User 安全方面：只要在 security 內落實安全性設定，就可以很好的控制所有 account 的存取權限 dev / stag / prod 用來存放 infrastructure 與跑 application\n開發時使用 dev / stag 環境，測試都完成後，才自動推倒 prod 公開給用戶使用 dev / stag 環境是內部環境，架構與 prod 類似，來模擬 prod 的環境方便開發與測試 可能機器數量或規格比 prod 小很多，來節省成本 有些團隊會有更多 account，例如 qa / uat / …，都可以依照需求建立 prod 有些團隊會有複數 prod 環境，可以供災難發生時做備援切換 shared 裡面放跨 application account 共用的元件\n例如 AWS ECR 可能不想要每個 account 都開，想放一起的話可以放在 shared，然後讓其他 account 存取 shared 版本控制系統 Git / github 可能會只有一組大家共用 CI/CD pipeline / Jenkins …等等跨環境共用的資源，可以放 shared 每個 account 都開也是有許多好處，例如更獨立更安全，這就看看各個團隊災安全與成本上的取捨 管理上由於 prod 會使用到 shared 的元件，建議要把 shared 的安全等級當作 prod 來管理，嚴格限制 shared 的存取，以保護 prod 環境的安全 很多個 sandbox account 讓工程師自由的測試功能\n如果有需求與預算，一個完全獨立的 sandbox 讓工程師可以做各種實驗，對於促進團隊內部的創新會有非常大的幫助 如果在 dev 上做這測試，有可能會影響到其他團隊成員，而覺得綁手綁腳的事情，都可以盡情在 sandbox 上操作 可以為 sandbox 的帳號設定更嚴格的 billing / cost 設定，避免工程師玩太嗨超過預算 黃金準則是一個工程師一個 sandbox 來達到 100% 開發獨立 testing account 用來測試 infrastructure 的測試\n如果有使用 Gruntwork/Terratest 來測試 terraform tf code 的朋友，應該知道 terratest 會把 terraform module 中的 infrastrcuture 真的在 aws 開出來，做功能測試，然後測試完成後再把 infrastrcture 全部刪掉 是的 IaC terraform module 也是需要單元測試 testing 就是用來讓 IaC 做自動化測試的環境，裡面的 infrastructure 都是常常 create + destroy，不會有常駐的服務 與 sandbox 不同的是 testing 是跑自動化 CI/CD pipeline 的測試 sandbox 是讓工程師做規模較小的手動測試與開發，因為我們也不希望一堆測試用 infrastructure 散落在 sandbox 裡面，感覺很貴 logs 用來收集 log 到單一 account 底下，方便查閱\n所有 child account 的 log 都收到這裡，而不用跑到各個 account 去查 log aws account 內部的 log，cloud trail 都可以透過客訂與工具轉發，集中收集 如果公司規模很大，有多個 business unit 的話，也可以多建幾個 organization，來對應公司組織\n透過 web console switch role 我是一個開發工程師（不是 admin），那在 multi-account 下的環境我應該如何工作？\n如何存取 aws\nIAM User 可以透過帳號密碼來存取 aws web console，登入之後會發現自己處在 security account 底下 第一次登入的話需要重設密碼，需要符合 IAM Password Policy 會需要輸入 MFA，會需要符合 IAM MFA Policy 兩面的安全性 policy 在實際公司帳號裡是必備，但在 workshop 中，我們還沒做，先留個坑之後來補 programatic access 如同 day03 的 root account IAM User 步驟，我們也是使用 aws-vault 搭配 aws access key，來讓 terraform 執行 web console 如何 switch role\n可以在 aws web console -\u003e 右上角 user -\u003e switch role 填入\n目標 account ID (ex dev: 123456789012) 目標的 role 給自己看的好辨識名稱 如果 admin 有設定 IAM role 與 assume role 權限，就可以切換到 dev account 下的 IAM role 身分 透過 web console switch role 如同 day03 使用 root account IAM User，我們也是使用 aws-vault 搭配 aws access key，來讓 terraform 執行) 來跑 terraform 建立 child accounts 一樣，我們也需要設定 aws-vault，讓我們可以在 local 機上 assume 不同 account role，來使用各個 child account\naws-vault Roles and MFA 需要調整 ~/.aws/config 的設定\nsecurity 管理員設定完 iam role + assume policy 後，會提供登入資訊給其他團隊成員 cat ~/.aws/config # 這是 root account IAM User 不要再拿來用了 # aws access key 收在本機的 aws-vault 內 [profile terraform-30day-root-iam-user] region=ap-northeast-1 # 這是 security account (111111111111) IAM User（還沒建立） # aws access key 收在本機的 aws-vault 內 [profile chechia-security-iam-user] region=ap-northeast-1 # 這是 dev account (333333333333) IAM Role（還沒建立） [profile dev-admin] source_profile = chechia-security-iam-user role_arn = arn:aws:iam::333333333333:role/dev-admin mfa_serial = arn:aws:iam::111111111111:mfa/chechia-security-iam-user 上面這些都還沒建立，所以都還不能用，只是先說一下之後要怎麼操作\nsecurity 管理員要設定一大堆東西，但工程師使用非常簡單，只要透過 aws-vault 切換就可以在不同 account 下操作 terraform\naws-vault exec dev-admin -- aws sts get-caller-identity { \"UserId\": \"xxxxxxxxxxxxxxxx\", \"Account\": \"333333333333\", \"Arn\": \"arn:aws:iam::333333333333:role/dev-admin\" } aws-vault exec dev-admin -- terragrunt plan aws-vault exec stag-admin -- terragrunt plan ... 其他 Cloudtrail\n12 month free-tier 是可以免費使用的 log 存放在 s3 上，會需要收取 s3 的費用，12 month free-tier s3 是 5G，我們這個 workshop 不會超過 note: terraform state 也是放在 s3 上 TODO 與進度 透過 root account 設定一組 IAM User 透過 root account 設定多個 aws child accounts security 中設定 IAM User security 設定 password policy security 設定 MFA policy security 中設定 IAM Policy \u0026 Group dev 中設定 IAM role 允許 security assume dev IAM role ","wordCount":"717","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-09-18T09:35:25+08:00","dateModified":"2022-09-18T09:35:25+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=categories><span>categories</span></a></li><li><a href=https://chechia.net/tags/ title=tags><span>tags</span></a></li><li><a href=https://chechia.net/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">AWS Multi-Accounts Structure</h1><div class=post-description>Article description.</div><div class=post-meta><span title='2022-09-18 09:35:25 +0800 CST'>September 18, 2022</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;717 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#root-account-的用途><a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/the-root-account>Root Account</a> 的用途</a></li><li><a href=#child-account-的用途><a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/child-accounts>Child Account</a> 的用途</a></li><li><a href=#透過-web-console-switch-role>透過 web console switch role</a></li><li><a href=#透過-web-console-switch-role-1>透過 web console switch role</a></li><li><a href=#其他>其他</a></li><li><a href=#todo-與進度>TODO 與進度</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>昨天設定了多個 aws organization accounts，但我們還沒有說明為什麼要這樣做</p><p>今天會先講 Gruntwork 提出的 <a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/intro>Production-Grade Design: multi-account security strategy</a></p><ul><li>拆分多個 account 的用意</li><li>多 account 下如何統一管理 IAM User</li><li>access control 與安全性控管</li></ul><hr><p><a href=https://ithelp.ithome.com.tw/articles/10290931>iThome 鐵人賽好讀版</a></p><p><a href=http://chechia.net/>賽後文章會整理放到個人的部落格上 http://chechia.net/</a></p><p><a href=https://www.facebook.com/engineer.from.scratch>追蹤粉專可以收到文章的主動推播</a></p><p><img alt=https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg></p><h1 id=production-grade-design-iam>Production-grade Design IAM<a hidden class=anchor aria-hidden=true href=#production-grade-design-iam>#</a></h1><p>Gruntwork 提出的 <a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/intro>Production-Grade Design: multi-account security strategy</a>，我們這邊一一講解</p><p><img alt="Multi-account security strategy" loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20220918/20120327GL49e7CTD0.png></p><h3 id=root-account-的用途><a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/the-root-account>Root Account</a> 的用途<a hidden class=anchor aria-hidden=true href=#root-account-的用途>#</a></h3><ul><li>位於 diagram 圖中的最上層</li><li>是整個架構的創世帳號，權限最大</li><li>root account 裡面沒有任何 infrastructure 元件， i.e. aws ec2 不會長在裡面，是一個空 account</li><li>root account 的存取最嚴格<ul><li>只有很少數的 admin 可以存取<ul><li>i.e 只有 SRE 部門主管有自己的 IAM User，其他 SRE 沒有權限存取 root account</li></ul></li></ul></li><li>root account 的工作最少<ul><li>設定 child account</li><li>管理 billing</li></ul></li></ul><p>IAM policy 管理，不要把 policy 直接綁在 User 上，應該要</p><ul><li>為不同權責的成員設定 IAM Group，ex. dev-admin / dev-user / stag-admin / qa / billing / &mldr;</li><li>把 policy 綁在 Group 上，ex. ReadPermission -> dev-user / Read+Write -> dev-admin</li><li>把 User 加進 / 移除 Group，來管理人員權限</li><li>Group 通常會接近公司團隊的職責分配</li><li>root account 內部只會有<ul><li>full-access 的管理員 group</li><li>billing 的會計出帳 group</li></ul></li></ul><h3 id=child-account-的用途><a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/child-accounts>Child Account</a> 的用途<a hidden class=anchor aria-hidden=true href=#child-account-的用途>#</a></h3><p>透過 root account 創建 child accounts 後，這裡說明各個 account 的設計用途</p><p><code>Security</code> 用來管理 authentication 與 authorization</p><ul><li>底下一樣沒有任何 infrastructure 元件</li><li>定義所有 IAM User 與 IAM Group，所有團隊成員的 User 在這邊設定<ul><li>所有的 User 放在 <code>Security</code> 底下統一管理</li><li>其他的 child account 不會設定 IAM User，ex. dev / stag / prod 裡面都沒有 IAM User<ul><li>child account 中設定 IAM roles，讓 security/user <a href=https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html>assume role</a> 存取其他 child account</li><li>ex. <code>security</code>/dev-admin/chechia assume role <code>dev</code>/admin，透過 aws STS(Security Token Service) 暫時取得 dev/admin 這個 role 的權限來控制 <code>dev</code></li></ul></li></ul></li><li>團隊主管也會有一個 security IAM User，平時開發 infrastructure 使用這個 IAM User，只有需要調整 root account 時才會動用 root account IAM User。反正 root account 是能不用就不用</li></ul><p>這個做法有非常多好處，但又不會造成工作上的負擔</p><ul><li>使用方面：所有的團隊成員只會有一個 User，透過 <code>security</code> 登入。不會一個人有好幾個帳號密碼很煩</li><li>管理方面：管理員只要在 <code>security</code> 內管理 User，而不用一直切換 account 去調整 IAM User</li><li>安全方面：只要在 <code>security</code> 內落實安全性設定，就可以很好的控制所有 account 的存取權限</li></ul><p><code>dev</code> / <code>stag</code> / <code>prod</code> 用來存放 infrastructure 與跑 application</p><ul><li>開發時使用 dev / stag 環境，測試都完成後，才自動推倒 <code>prod</code> 公開給用戶使用</li><li>dev / stag 環境是內部環境，架構與 prod 類似，來模擬 prod 的環境方便開發與測試<ul><li>可能機器數量或規格比 prod 小很多，來節省成本</li><li>有些團隊會有更多 account，例如 qa / uat / &mldr;，都可以依照需求建立</li></ul></li><li>prod 有些團隊會有複數 prod 環境，可以供災難發生時做備援切換</li></ul><p><code>shared</code> 裡面放跨 application account 共用的元件</p><ul><li>例如<ul><li>AWS ECR 可能不想要每個 account 都開，想放一起的話可以放在 <code>shared</code>，然後讓其他 account 存取 <code>shared</code></li><li>版本控制系統 Git / github 可能會只有一組大家共用</li><li>CI/CD pipeline / Jenkins</li><li>&mldr;等等跨環境共用的資源，可以放 <code>shared</code></li></ul></li><li>每個 account 都開也是有許多好處，例如更獨立更安全，這就看看各個團隊災安全與成本上的取捨</li><li>管理上由於 <code>prod</code> 會使用到 <code>shared</code> 的元件，建議要把 <code>shared</code> 的安全等級當作 <code>prod</code> 來管理，嚴格限制 <code>shared</code> 的存取，以保護 <code>prod</code> 環境的安全</li></ul><p>很多個 <code>sandbox</code> account 讓工程師自由的測試功能</p><ul><li>如果有需求與預算，一個完全獨立的 <code>sandbox</code> 讓工程師可以做各種實驗，對於促進團隊內部的創新會有非常大的幫助<ul><li>如果在 <code>dev</code> 上做這測試，有可能會影響到其他團隊成員，而覺得綁手綁腳的事情，都可以盡情在 <code>sandbox</code> 上操作</li><li>可以為 <code>sandbox</code> 的帳號設定更嚴格的 billing / cost 設定，避免工程師玩太嗨超過預算</li></ul></li><li>黃金準則是一個工程師一個 <code>sandbox</code> 來達到 100% 開發獨立</li></ul><p><code>testing</code> account 用來測試 infrastructure 的測試</p><ul><li>如果有使用 <a href="https://blog.gruntwork.io/open-sourcing-terratest-a-swiss-army-knife-for-testing-infrastructure-code-5d883336fcd5?gi=141873b58326">Gruntwork/Terratest</a> 來測試 terraform tf code 的朋友，應該知道 terratest 會把 terraform module 中的 infrastrcuture 真的在 aws 開出來，做功能測試，然後測試完成後再把 infrastrcture 全部刪掉<ul><li>是的 IaC terraform module 也是需要單元測試</li></ul></li><li><code>testing</code> 就是用來讓 IaC 做自動化測試的環境，裡面的 infrastructure 都是常常 create + destroy，不會有常駐的服務</li><li>與 <code>sandbox</code> 不同的是<ul><li><code>testing</code> 是跑自動化 CI/CD pipeline 的測試</li><li><code>sandbox</code> 是讓工程師做規模較小的手動測試與開發，因為我們也不希望一堆測試用 infrastructure 散落在 <code>sandbox</code> 裡面，感覺很貴</li></ul></li></ul><p><code>logs</code> 用來收集 log 到單一 account 底下，方便查閱</p><ul><li>所有 child account 的 log 都收到這裡，而不用跑到各個 account 去查 log</li><li>aws account 內部的 log，cloud trail 都可以透過客訂與工具轉發，集中收集</li></ul><p>如果公司規模很大，有多個 business unit 的話，也可以多建幾個 organization，來對應公司組織</p><h3 id=透過-web-console-switch-role>透過 web console switch role<a hidden class=anchor aria-hidden=true href=#透過-web-console-switch-role>#</a></h3><p>我是一個開發工程師（不是 admin），那在 multi-account 下的環境我應該如何工作？</p><p>如何存取 aws</p><ul><li>IAM User 可以透過帳號密碼來存取 aws web console，登入之後會發現自己處在 <code>security</code> account 底下<ul><li>第一次登入的話需要重設密碼，需要符合 <a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/password-policy>IAM Password Policy</a></li><li>會需要輸入 MFA，會需要符合 <a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/mfa-policy>IAM MFA Policy</a></li><li>兩面的安全性 policy 在實際公司帳號裡是必備，但在 workshop 中，我們還沒做，先留個坑之後來補</li></ul></li><li>programatic access 如同 <a href=https://ithelp.ithome.com.tw/articles/10292900>day03 的 root account IAM User 步驟</a>，我們也是使用 aws-vault 搭配 aws access key，來讓 terraform 執行</li></ul><p>web console 如何 switch role</p><ul><li>可以在 aws web console -> 右上角 user -> switch role</li></ul><p><img alt="AWS Console: switch role" loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20220918/20120327WzL2o9OCng.png>
<img alt="AWS Console: switch role" loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20220918/20120327KR6vRGyAxe.png></p><p>填入</p><ul><li>目標 account ID (ex dev: 123456789012)</li><li>目標的 role</li><li>給自己看的好辨識名稱
如果 admin 有設定 IAM role 與 assume role 權限，就可以切換到 <code>dev</code> account 下的 IAM role 身分</li></ul><p><img alt="AWS Console: switch role" loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20220918/20120327YSjdG8mJE1.png></p><h3 id=透過-web-console-switch-role-1>透過 web console switch role<a hidden class=anchor aria-hidden=true href=#透過-web-console-switch-role-1>#</a></h3><p>如同 <a href=https://ithelp.ithome.com.tw/articles/10292900>day03 使用 root account IAM User</a>，我們也是使用 aws-vault 搭配 aws access key，來讓 terraform 執行) 來跑 terraform 建立 child accounts 一樣，我們也需要設定 aws-vault，讓我們可以在 local 機上 assume 不同 account role，來使用各個 child account</p><ul><li><a href=https://github.com/99designs/aws-vault#roles-and-mfa>aws-vault Roles and MFA</a></li></ul><p>需要調整 <code>~/.aws/config</code> 的設定</p><ul><li>security 管理員設定完 iam role + assume policy 後，會提供登入資訊給其他團隊成員</li></ul><pre><code>cat ~/.aws/config

# 這是 root account IAM User 不要再拿來用了
# aws access key 收在本機的 aws-vault 內
[profile terraform-30day-root-iam-user]
region=ap-northeast-1

# 這是 security account (111111111111) IAM User（還沒建立）
# aws access key 收在本機的 aws-vault 內
[profile chechia-security-iam-user]
region=ap-northeast-1

# 這是 dev account (333333333333) IAM Role（還沒建立）
[profile dev-admin]
source_profile = chechia-security-iam-user
role_arn = arn:aws:iam::333333333333:role/dev-admin
mfa_serial = arn:aws:iam::111111111111:mfa/chechia-security-iam-user
</code></pre><p>上面這些都還沒建立，所以都還不能用，只是先說一下之後要怎麼操作</p><p>security 管理員要設定一大堆東西，但工程師使用非常簡單，只要透過 aws-vault 切換就可以在不同 account 下操作 terraform</p><pre><code>aws-vault exec dev-admin -- aws sts get-caller-identity

{
    &quot;UserId&quot;: &quot;xxxxxxxxxxxxxxxx&quot;,
    &quot;Account&quot;: &quot;333333333333&quot;,
    &quot;Arn&quot;: &quot;arn:aws:iam::333333333333:role/dev-admin&quot;
}

aws-vault exec dev-admin -- terragrunt plan
aws-vault exec stag-admin -- terragrunt plan
...

</code></pre><h3 id=其他>其他<a hidden class=anchor aria-hidden=true href=#其他>#</a></h3><p>Cloudtrail</p><ul><li>12 month free-tier 是可以免費使用的</li><li>log 存放在 s3 上，會需要收取 s3 的費用，12 month free-tier s3 是 5G，我們這個 workshop 不會超過<ul><li>note: terraform state 也是放在 s3 上</li></ul></li></ul><h3 id=todo-與進度>TODO 與進度<a hidden class=anchor aria-hidden=true href=#todo-與進度>#</a></h3><ul><li><input checked disabled type=checkbox> 透過 root account 設定一組 IAM User</li><li><input checked disabled type=checkbox> 透過 root account 設定多個 aws child accounts</li><li><input disabled type=checkbox> security 中設定 IAM User<ul><li><input disabled type=checkbox> security 設定 password policy</li><li><input disabled type=checkbox> security 設定 MFA policy</li></ul></li><li><input disabled type=checkbox> security 中設定 IAM Policy & Group</li><li><input disabled type=checkbox> dev 中設定 IAM role</li><li><input disabled type=checkbox> 允許 security assume dev IAM role</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/terraform/>Terraform</a></li><li><a href=https://chechia.net/tags/iac/>Iac</a></li><li><a href=https://chechia.net/tags/aws/>Aws</a></li><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2022/>鐵人賽2022</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2022-09-16-14th-ithome-ironman-iac-aws-workshop-05-provision-iam-user/><span class=title>« Prev</span><br><span>Provision Iam User</span>
</a><a class=next href=https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/><span class=title>Next »</span><br><span>Provision Child AWS Accounts</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on x" href="https://x.com/intent/tweet/?text=AWS%20Multi-Accounts%20Structure&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f&amp;hashtags=terraform%2ciac%2caws%2c%e9%90%b5%e4%ba%ba%e8%b3%bd2022"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f&amp;title=AWS%20Multi-Accounts%20Structure&amp;summary=AWS%20Multi-Accounts%20Structure&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f&title=AWS%20Multi-Accounts%20Structure"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on whatsapp" href="https://api.whatsapp.com/send?text=AWS%20Multi-Accounts%20Structure%20-%20https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on telegram" href="https://telegram.me/share/url?text=AWS%20Multi-Accounts%20Structure&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AWS Multi-Accounts Structure on ycombinator" href="https://news.ycombinator.com/submitlink?t=AWS%20Multi-Accounts%20Structure&u=https%3a%2f%2fchechia.net%2fposts%2f2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>