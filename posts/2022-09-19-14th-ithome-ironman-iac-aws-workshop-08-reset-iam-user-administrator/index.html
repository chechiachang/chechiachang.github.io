<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Reset Iam User Administrator | Che-Chia Chang</title><meta name=keywords content="terraform,iac,aws,鐵人賽2022"><meta name=description content="Article description."><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYR8JCDGM9"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYR8JCDGM9")}</script><meta property="og:url" content="https://chechia.net/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Reset Iam User Administrator"><meta property="og:description" content="Article description."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-20T23:56:47+08:00"><meta property="article:modified_time" content="2022-09-20T23:56:47+08:00"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Iac"><meta property="article:tag" content="Aws"><meta property="article:tag" content="鐵人賽2022"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Reset Iam User Administrator"><meta name=twitter:description content="Article description."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Reset Iam User Administrator","item":"https://chechia.net/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Reset Iam User Administrator","name":"Reset Iam User Administrator","description":"Article description.","keywords":["terraform","iac","aws","鐵人賽2022"],"articleBody":"昨天處理完 Accounting 的 reset password，今天要來 reset root account Administrator 的權限\n本日進度\nroot 中設定 IAM User 將手動產生的 Administrator 的 IAM User import terraform 中 補上 root account IAM Policy 補上 root account IAM Group reset root account IAM user login profile \u0026 pgp key iThome 鐵人賽好讀版\n賽後文章會整理放到個人的部落格上 http://chechia.net/\n追蹤粉專可以收到文章的主動推播\nReset IAM root user Administrator Password 依照上面的步驟，我們確定可以正常登入，於是可以來可以新建 Administrator 的 login profile\n由於 Administrator 會需要 access key，所以我們也把他設成 true # terragrunt.hcl users = { Administrator = { groups = [\"full-access\"] pgp_key = \"keybase:chechiachang\" create_login_profile = true create_access_keys = true }, Accounting = { groups = [\"billing\"] pgp_key = \"keybase:chechiachang\" create_login_profile = true create_access_keys = false # accounting always use web console, won't use access key } } 記得更改 module/output.tf，增加 secret key 的 output，而不要只留在 terraform state 裡面\n# output.tf output \"keybase_secret_key_decrypt_command\" { description = \"Decrypt access secret key command\" value = { for key, value in module.iam_user : key =\u003e value.keybase_secret_key_decrypt_command } } output \"keybase_secret_key_pgp_message\" { description = \"Encrypted access secret key\" value = { for key, value in module.iam_user : key =\u003e value.keybase_secret_key_pgp_message } } 試著 plan 一下，預期\nAdministrator 會產生一組新的 login profile Administrator 會產生一組新的 access key aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # module.iam_user[\"Administrator\"].aws_iam_access_key.this[0] will be created + resource \"aws_iam_access_key\" \"this\" { + create_date = (known after apply) + encrypted_secret = (known after apply) + encrypted_ses_smtp_password_v4 = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + pgp_key = \"keybase:chechiachang\" + secret = (sensitive value) + ses_smtp_password_v4 = (sensitive value) + status = \"Active\" + user = \"Administrator\" } # module.iam_user[\"Administrator\"].aws_iam_user_login_profile.this[0] will be created + resource \"aws_iam_user_login_profile\" \"this\" { + encrypted_password = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 + password_reset_required = false + pgp_key = \"keybase:chechiachang\" + user = \"Administrator\" } Plan: 2 to add, 0 to change, 0 to destroy. Changes to Outputs: + iam_access_key_id = { + Accounting = \"\" + Administrator = null -\u003e (known after apply) } ~ keybase_password_decrypt_command = { ~ Administrator = null -\u003e (known after apply) # (1 unchanged element hidden) } ~ keybase_password_pgp_message = { ~ Administrator = null -\u003e (known after apply) # (1 unchanged element hidden) } + keybase_secret_key_decrypt_command = { + Accounting = null + Administrator = (known after apply) } + keybase_secret_key_pgp_message = { + Accounting = null + Administrator = (known after apply) } 符合預期!! 可喜可賀\n但是我們已經有 access key 在使用了，我又不想要走 day 3 aws-vault add key 的步驟換一組新的，這時該怎辦\n沒錯，我們可以像 Day3 一樣，使用 import 匯入已經存在的 resource 到 address 裡面\ngoogle “terraform aws iam user access key”，找到 aws iam user access key 的說明頁面 address 是 module.iam_user[\"Administrator\"].aws_iam_access_key.this[0] access key ID 可以在密碼管理器查看 或是在 aws web console -\u003e IAM -\u003e User -\u003e Administrator -\u003e Security Credential -\u003e Access Keys 查到 aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import 'module.iam_user[\"Administrator\"].aws_iam_access_key.this[0]' AKIA1234567890 module.iam_user[\"Administrator\"].aws_iam_access_key.this[0]: Importing from ID \"AKIA2I2H7ERWKI4RIF4Z\"... module.iam_user[\"Administrator\"].aws_iam_access_key.this[0]: Import prepared! Prepared aws_iam_access_key for import module.iam_user[\"Administrator\"].aws_iam_access_key.this[0]: Refreshing state... [id=AKIA2I2H7ERWKI4RIF4Z] Import successful! The resources that were imported are shown above. These resources are now in your Terraform state and will henceforth be managed by Terraform. Releasing state lock. This may take a few moments... 順便 login profile 也 import 近來\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import 'module.iam_user[\"Administrator\"].aws_iam_user_login_profile.this[0]' Administrator 再次 plan 就不需要新建一把 access key 了…吧？！\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create -/+ destroy and then create replacement Terraform will perform the following actions: # module.iam_user[\"Administrator\"].aws_iam_access_key.this[0] must be replaced -/+ resource \"aws_iam_access_key\" \"this\" { ~ create_date = \"2022-09-16T13:05:35Z\" -\u003e (known after apply) + encrypted_secret = (known after apply) + encrypted_ses_smtp_password_v4 = (known after apply) ~ id = \"AKIA2I2H7ERWKI4RIF4Z\" -\u003e (known after apply) + key_fingerprint = (known after apply) + pgp_key = \"keybase:chechiachang\" # forces replacement + secret = (sensitive value) + ses_smtp_password_v4 = (sensitive value) # (2 unchanged attributes hidden) } # module.iam_user[\"Administrator\"].aws_iam_user_login_profile.this[0] must be replaced -/+ resource \"aws_iam_user_login_profile\" \"this\" { + encrypted_password = (known after apply) ~ id = \"Administrator\" -\u003e (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 # forces replacement + pgp_key = \"keybase:chechiachang\" # forces replacement # (2 unchanged attributes hidden) } Plan: 2 to add, 0 to change, 2 to destroy. Changes to Outputs: + iam_access_key_id = { + Accounting = \"\" + Administrator = \"AKIA2I2H7ERWARJJWIVK\" } ~ keybase_password_decrypt_command = { ~ Administrator = null -\u003e (known after apply) # (1 unchanged element hidden) } ~ keybase_password_pgp_message = { ~ Administrator = null -\u003e (known after apply) # (1 unchanged element hidden) } ~ keybase_secret_key_decrypt_command = { ~ Administrator = null -\u003e (known after apply) # (1 unchanged element hidden) } ~ keybase_secret_key_pgp_message = { ~ Administrator = null -\u003e (known after apply) # (1 unchanged element hidden) } 誒結果不符合預期，\naws_iam_access_key.this 需要重建 原因是我們更改了 pgp_key = \"keybase:chechiachang\" 造成 forces replacement 因為 想一想也很合理 第一次創建 access key 的時候，keybase 是亂寫的，這時用 module 的 code 去跑，產生無加密的 access key 放在 state 中 這次 import 後，module 中的 .tf code 已經改過，不再存無加密的 access key，而是加密後儲存 GPG Encrypted Message 這個改變讓 provider 覺得沒有辦法符合，只好刪掉重建 .aws_iam_user_login_profile.this 需要重建，原因也是一樣，因為我們改了 .tf code 邏輯，造成 provider 勢必要重建 login profile 執行 terraform apply\nNOTE: 注意有 destroy 的 terraform plan 都要特別小心 review，因為很多 aws API delete 發出去就是無法復原了\n例如 access key 與 password 刪掉後，是無法 recover 的 有些 API request 會有副作用 reset password 後，aws web console 會被登出 access key 換掉 terraform 就不能用，有可能導致 terraform 進行到一半被 permission denied (這個 apply 不會，只是提醒大家要注意) 有 destroy 的部分都要小心 review，看不懂就找 peering review 有 destroy 的部分都要小心 review，看不懂就找 peering review 有 destroy 的部分都要小心 review，看不懂就找 peering review\n很重要所以說三次\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt apply Apply complete! Resources: 2 added, 0 changed, 2 destroyed. Outputs: keybase_password_decrypt_command = { \"Accounting\" = \u003c\u003c-EOT echo \"wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A==\" | base64 --decode | keybase pgp decrypt EOT \"Administrator\" = \u003c\u003c-EOT echo \"wcFMA4U4ylYlNYTfAQ/+JcRNkO9SxMm9U196p2WuuXdSWo9ooktKJMp3q4Xf5xMG5z/ccphl5+fVDmkp2Pr76UJ9NmiBw8rzScFUEU4U+xZepNojSdN/rmZPWB6PKCdJMyItw6HOnn7OSa0i1arr0PHaC0bpVs4Bc+9Oqtw1SuU8uvwBpCeM+h33qOROnvKnGgvOHV2Zk1XcgT+sg7xMTv8q77KePoNLTK3joQL7fXdPWUGWCp8srWpxzJ8LD4aNMmsrjA/s/7sNbAAdhffRwwA6diuZfeYscZ6MlURUtrSx3iAuNV33kmhuyYimlmXstbfs/nIJVI5OfcVexPKzHK5O9DikXApAzbf/YACz0OebOcxnzh6+rQw9+XWwRtARcK3tViMhxqnEu4PHROmj1sNmLZLJqCniwN91J2iry7BAx2Zoyvvw7vd7Sw9LddaM+j2XHhSf21250sNMn/9R6beUlkWQgPci8mU51rnqBffbOJnvVh7QCTLssoMTgKRrgxb+oZbSsKLLQO/621ZcTY9rzC74w2kZWJTS7nx5G/0KQkwXP4NGRSTXYg3/6TcwT7LefQiJpWB2z92zT1sp5lPhtpNneqrtFFnirplfP5coeelRSlTEbHDwbHSX1LfHU7A5WHjf7oEHvn2hMhdgTlvGt4vL7rXiy9p8GWjcudGxZs+/WNs8CCkZd8j2gVvSRQEmNNtCd/U3jmq+o2VncJjBhetJ7eCyvKOAMwcCLHE0zleX77mXVtq7UVLXrcypxIbVjJAIko8y71fATyrRomcijS7Sgw==\" | base64 --decode | keybase pgp decrypt EOT } keybase_password_pgp_message = { \"Accounting\" = \u003c\u003c-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A== -----END PGP MESSAGE----- EOT \"Administrator\" = \u003c\u003c-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfAQ/+JcRNkO9SxMm9U196p2WuuXdSWo9ooktKJMp3q4Xf5xMG5z/ccphl5+fVDmkp2Pr76UJ9NmiBw8rzScFUEU4U+xZepNojSdN/rmZPWB6PKCdJMyItw6HOnn7OSa0i1arr0PHaC0bpVs4Bc+9Oqtw1SuU8uvwBpCeM+h33qOROnvKnGgvOHV2Zk1XcgT+sg7xMTv8q77KePoNLTK3joQL7fXdPWUGWCp8srWpxzJ8LD4aNMmsrjA/s/7sNbAAdhffRwwA6diuZfeYscZ6MlURUtrSx3iAuNV33kmhuyYimlmXstbfs/nIJVI5OfcVexPKzHK5O9DikXApAzbf/YACz0OebOcxnzh6+rQw9+XWwRtARcK3tViMhxqnEu4PHROmj1sNmLZLJqCniwN91J2iry7BAx2Zoyvvw7vd7Sw9LddaM+j2XHhSf21250sNMn/9R6beUlkWQgPci8mU51rnqBffbOJnvVh7QCTLssoMTgKRrgxb+oZbSsKLLQO/621ZcTY9rzC74w2kZWJTS7nx5G/0KQkwXP4NGRSTXYg3/6TcwT7LefQiJpWB2z92zT1sp5lPhtpNneqrtFFnirplfP5coeelRSlTEbHDwbHSX1LfHU7A5WHjf7oEHvn2hMhdgTlvGt4vL7rXiy9p8GWjcudGxZs+/WNs8CCkZd8j2gVvSRQEmNNtCd/U3jmq+o2VncJjBhetJ7eCyvKOAMwcCLHE0zleX77mXVtq7UVLXrcypxIbVjJAIko8y71fATyrRomcijS7Sgw== -----END PGP MESSAGE----- EOT } keybase_secret_key_decrypt_command = { \"Accounting\" = tostring(null) \"Administrator\" = \u003c\u003c-EOT echo \"wcFMA4U4ylYlNYTfARAAivQzF+bh6N6OH/3a1S7XQCrIceoLn9EXsc8Gr0p09TVieSqwwv1RojaCULjYXYu5UnxRFwaavN+ULxrl2c4hRBIMgNEAo1Nxy16vfDEj4W7S9l+yA/TU3ewbs8WqKHIFrO8+AcjxUV4Ol5cmziDu70UR0H1/f0w7lqC/s36Zqa1Rz5Mb1n7ATLfs4jiPDQiFlr+E6gSe+I23sAQqdDS/WEbwAVz6o2B9mvs+OznNzeDoTwd7nE2ca+jYDZKjEjD6+qfDAnVzftwSrJIb2yJYlKIeSKJLC9loEQk2wdR5fkKrPg//9S4gYQJjzkwWyJAQsc6AuOPZXjqVe5yV9EpG2r0938G/acR3SEjt53ckXjh6Fi0/EgOjfeTVMO0EH6Se/vurdXBRyMggTieyN76Ts8nnn32GBldTZBUgWTL1Udj6B9ueqFCFuB8LFGNNNoHYjp3hAeGEQdtgI9TQ9r+jRDKpO8zcDoRMFK7wv4DJ31Nl/aS++a8nFEwJp7D5XkiSPbJ9JE1MwvuufldAHqr8iRbt3LmKeB4qC3TFbIhNWY4gs2VZ5LTepIn18sQfQ4f5s9o1lpem4yQw2XeEA7Fd1sPVypVeOj4z8Y080duGES896LiGpsAZdQ3bm/RiuIMLSabArgWCP/0LgrOQU8SwrIdN3k4682nw41KVnhjY2IDSWQHfEUCTNkgNfdj8v7FiD/OHX5G6VX/NAOwiAQ7Qh9u6UOmyAVY3QTjgVYEF4+oUyX+zZWprhhJkvHRDTTTNqozxVBfbYqrKTxSa00MRwAFIwQJh3xXbvmlF\" | base64 --decode | keybase pgp decrypt EOT } keybase_secret_key_pgp_message = { \"Accounting\" = tostring(null) \"Administrator\" = \u003c\u003c-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfARAAivQzF+bh6N6OH/3a1S7XQCrIceoLn9EXsc8Gr0p09TVieSqwwv1RojaCULjYXYu5UnxRFwaavN+ULxrl2c4hRBIMgNEAo1Nxy16vfDEj4W7S9l+yA/TU3ewbs8WqKHIFrO8+AcjxUV4Ol5cmziDu70UR0H1/f0w7lqC/s36Zqa1Rz5Mb1n7ATLfs4jiPDQiFlr+E6gSe+I23sAQqdDS/WEbwAVz6o2B9mvs+OznNzeDoTwd7nE2ca+jYDZKjEjD6+qfDAnVzftwSrJIb2yJYlKIeSKJLC9loEQk2wdR5fkKrPg//9S4gYQJjzkwWyJAQsc6AuOPZXjqVe5yV9EpG2r0938G/acR3SEjt53ckXjh6Fi0/EgOjfeTVMO0EH6Se/vurdXBRyMggTieyN76Ts8nnn32GBldTZBUgWTL1Udj6B9ueqFCFuB8LFGNNNoHYjp3hAeGEQdtgI9TQ9r+jRDKpO8zcDoRMFK7wv4DJ31Nl/aS++a8nFEwJp7D5XkiSPbJ9JE1MwvuufldAHqr8iRbt3LmKeB4qC3TFbIhNWY4gs2VZ5LTepIn18sQfQ4f5s9o1lpem4yQw2XeEA7Fd1sPVypVeOj4z8Y080duGES896LiGpsAZdQ3bm/RiuIMLSabArgWCP/0LgrOQU8SwrIdN3k4682nw41KVnhjY2IDSWQHfEUCTNkgNfdj8v7FiD/OHX5G6VX/NAOwiAQ7Qh9u6UOmyAVY3QTjgVYEF4+oUyX+zZWprhhJkvHRDTTTNqozxVBfbYqrKTxSa00MRwAFIwQJh3xXbvmlF -----END PGP MESSAGE----- EOT } 這時嘗試在使用 terraform plan，會無法取得 state s3 bucket\n因為 access key 已經重建，現在 terraform 使用舊的 access key 連 s3 會 404 not found aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Remote state S3 bucket chechia-root-ap-northeast-1-terraform-state does not exist or you don't have permissions to access it. Would you like Terragrunt to create it? (y/n) n ERRO[0004] remote state S3 bucket chechia-root-ap-northeast-1-terraform-state does not exist or you don't have permissions to access it ERRO[0004] Unable to determine underlying exit code, so Terragrunt will exit with error code 1 取得 output 後，一樣做 gpg decrypt 取得\npassword access key 完成後使用 aws-vault 移除舊的 profile + credential，再從新匯入 access key\naws-vault remove terraform-30day-root-iam-user Delete credentials for profile \"terraform-30day-root-iam-user\"? (y|N) y Deleted credentials. aws-vault add terraform-30day-root-iam-user Enter Access Key ID: Enter Secret Access Key: Added credentials to profile \"terraform-30day-root-iam-user\" in vault 完成後就可以正常使用 aws-vault plan 了\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan 上面的變更我們的 PR 如下\nterragrunt-infrastructure-modules PR terragrunt-infrastructure-live-example PR TODO 與進度 透過 root account 設定一組 IAM User 透過 root account 設定多個 aws child accounts root 中設定 IAM User 將手動產生的 Administrator 的 IAM User import terraform 中 補上 root account IAM Policy 補上 root account IAM Group reset root account IAM user login profile \u0026 pgp key security 中設定 IAM User security 設定 password policy security 設定 MFA policy security 中設定 IAM Policy \u0026 Group dev 中設定 IAM role 允許 security assume dev IAM role ","wordCount":"1292","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-09-20T23:56:47+08:00","dateModified":"2022-09-20T23:56:47+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://chechia.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chechia.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Reset Iam User Administrator</h1><div class=post-description>Article description.</div><div class=post-meta><span title='2022-09-20 23:56:47 +0800 CST'>September 20, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1292 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#reset-iam-root-user-administrator-password>Reset IAM root user Administrator Password</a></li><li><a href=#todo-與進度>TODO 與進度</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>昨天處理完 Accounting 的 reset password，今天要來 reset root account Administrator 的權限</p><p>本日進度</p><ul><li><input checked disabled type=checkbox> root 中設定 IAM User<ul><li><input checked disabled type=checkbox> 將手動產生的 Administrator 的 IAM User import terraform 中</li><li><input checked disabled type=checkbox> 補上 root account IAM Policy</li><li><input checked disabled type=checkbox> 補上 root account IAM Group</li><li><input disabled type=checkbox> reset root account IAM user login profile & pgp key</li></ul></li></ul><p><a href=https://ithelp.ithome.com.tw/articles/10290931>iThome 鐵人賽好讀版</a></p><p><a href=http://chechia.net/>賽後文章會整理放到個人的部落格上 http://chechia.net/</a></p><p><a href=https://www.facebook.com/engineer.from.scratch>追蹤粉專可以收到文章的主動推播</a></p><p><img alt=https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg></p><hr><h3 id=reset-iam-root-user-administrator-password>Reset IAM root user Administrator Password<a hidden class=anchor aria-hidden=true href=#reset-iam-root-user-administrator-password>#</a></h3><p>依照上面的步驟，我們確定可以正常登入，於是可以來可以新建 Administrator 的 login profile</p><ul><li>由於 Administrator 會需要 access key，所以我們也把他設成 true</li></ul><pre><code># terragrunt.hcl
  users = {
    Administrator = {
      groups               = [&quot;full-access&quot;]
      pgp_key              = &quot;keybase:chechiachang&quot;
      create_login_profile = true
      create_access_keys   = true
    },
    Accounting = {
      groups               = [&quot;billing&quot;]
      pgp_key              = &quot;keybase:chechiachang&quot;
      create_login_profile = true
      create_access_keys   = false # accounting always use web console, won't use access key
    }
  }
</code></pre><p>記得更改 module/output.tf，增加 secret key 的 output，而不要只留在 terraform state 裡面</p><pre><code># output.tf
output &quot;keybase_secret_key_decrypt_command&quot; {
  description = &quot;Decrypt access secret key command&quot;
  value       = {
     for key, value in module.iam_user : key =&gt; value.keybase_secret_key_decrypt_command
  }
}

output &quot;keybase_secret_key_pgp_message&quot; {
  description = &quot;Encrypted access secret key&quot;
  value       = {
     for key, value in module.iam_user : key =&gt; value.keybase_secret_key_pgp_message
  }
}
</code></pre><p>試著 plan 一下，預期</p><ul><li>Administrator 會產生一組新的 login profile</li><li>Administrator 會產生一組新的 access key</li></ul><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt plan

Terraform used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # module.iam_user[&quot;Administrator&quot;].aws_iam_access_key.this[0] will be created
  + resource &quot;aws_iam_access_key&quot; &quot;this&quot; {
      + create_date                    = (known after apply)
      + encrypted_secret               = (known after apply)
      + encrypted_ses_smtp_password_v4 = (known after apply)
      + id                             = (known after apply)
      + key_fingerprint                = (known after apply)
      + pgp_key                        = &quot;keybase:chechiachang&quot;
      + secret                         = (sensitive value)
      + ses_smtp_password_v4           = (sensitive value)
      + status                         = &quot;Active&quot;
      + user                           = &quot;Administrator&quot;
    }

  # module.iam_user[&quot;Administrator&quot;].aws_iam_user_login_profile.this[0] will be created
  + resource &quot;aws_iam_user_login_profile&quot; &quot;this&quot; {
      + encrypted_password      = (known after apply)
      + id                      = (known after apply)
      + key_fingerprint         = (known after apply)
      + password                = (known after apply)
      + password_length         = 20
      + password_reset_required = false
      + pgp_key                 = &quot;keybase:chechiachang&quot;
      + user                    = &quot;Administrator&quot;
    }

Plan: 2 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + iam_access_key_id = {
      + Accounting    = &quot;&quot;
      + Administrator = null -&gt; (known after apply)
    }
  ~ keybase_password_decrypt_command   = {
      ~ Administrator = null -&gt; (known after apply)
        # (1 unchanged element hidden)
    }
  ~ keybase_password_pgp_message       = {
      ~ Administrator = null -&gt; (known after apply)
        # (1 unchanged element hidden)
    }
  + keybase_secret_key_decrypt_command = {
      + Accounting    = null
      + Administrator = (known after apply)
    }
  + keybase_secret_key_pgp_message     = {
      + Accounting    = null
      + Administrator = (known after apply)
    }
</code></pre><p>符合預期!! 可喜可賀</p><p>但是我們已經有 access key 在使用了，我又不想要走 day 3 aws-vault add key 的步驟換一組新的，這時該怎辦</p><p>沒錯，我們可以像 Day3 一樣，使用 import 匯入已經存在的 resource 到 address 裡面</p><ul><li>google &ldquo;terraform aws iam user access key&rdquo;，<a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_access_key#import>找到 aws iam user access key 的說明頁面</a></li><li>address 是 <code>module.iam_user["Administrator"].aws_iam_access_key.this[0]</code></li><li>access key ID<ul><li>可以在密碼管理器查看</li><li>或是在 aws web console -> IAM -> User -> Administrator -> Security Credential -> Access Keys 查到</li></ul></li></ul><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt import 'module.iam_user[&quot;Administrator&quot;].aws_iam_access_key.this[0]' AKIA1234567890

module.iam_user[&quot;Administrator&quot;].aws_iam_access_key.this[0]: Importing from ID &quot;AKIA2I2H7ERWKI4RIF4Z&quot;...
module.iam_user[&quot;Administrator&quot;].aws_iam_access_key.this[0]: Import prepared!
  Prepared aws_iam_access_key for import
module.iam_user[&quot;Administrator&quot;].aws_iam_access_key.this[0]: Refreshing state... [id=AKIA2I2H7ERWKI4RIF4Z]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.

Releasing state lock. This may take a few moments...
</code></pre><p>順便 <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_user_login_profile#import>login profile 也 import 近來</a></p><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt import 'module.iam_user[&quot;Administrator&quot;].aws_iam_user_login_profile.this[0]' Administrator
</code></pre><p>再次 plan 就不需要新建一把 access key 了&mldr;吧？！</p><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt plan

Terraform used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  + create
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # module.iam_user[&quot;Administrator&quot;].aws_iam_access_key.this[0] must be replaced
-/+ resource &quot;aws_iam_access_key&quot; &quot;this&quot; {
      ~ create_date                    = &quot;2022-09-16T13:05:35Z&quot; -&gt; (known after apply)
      + encrypted_secret               = (known after apply)
      + encrypted_ses_smtp_password_v4 = (known after apply)
      ~ id                             = &quot;AKIA2I2H7ERWKI4RIF4Z&quot; -&gt; (known after apply)
      + key_fingerprint                = (known after apply)
      + pgp_key                        = &quot;keybase:chechiachang&quot; # forces replacement
      + secret                         = (sensitive value)
      + ses_smtp_password_v4           = (sensitive value)
        # (2 unchanged attributes hidden)
    }

  # module.iam_user[&quot;Administrator&quot;].aws_iam_user_login_profile.this[0] must be replaced
-/+ resource &quot;aws_iam_user_login_profile&quot; &quot;this&quot; {
      + encrypted_password      = (known after apply)
      ~ id                      = &quot;Administrator&quot; -&gt; (known after apply)
      + key_fingerprint         = (known after apply)
      + password                = (known after apply)
      + password_length         = 20 # forces replacement
      + pgp_key                 = &quot;keybase:chechiachang&quot; # forces replacement
        # (2 unchanged attributes hidden)
    }

Plan: 2 to add, 0 to change, 2 to destroy.

Changes to Outputs:
  + iam_access_key_id = {
      + Accounting    = &quot;&quot;
      + Administrator = &quot;AKIA2I2H7ERWARJJWIVK&quot;
    }
  ~ keybase_password_decrypt_command   = {
      ~ Administrator = null -&gt; (known after apply)
        # (1 unchanged element hidden)
    }
  ~ keybase_password_pgp_message       = {
      ~ Administrator = null -&gt; (known after apply)
        # (1 unchanged element hidden)
    }
  ~ keybase_secret_key_decrypt_command = {
      ~ Administrator = null -&gt; (known after apply)
        # (1 unchanged element hidden)
    }
  ~ keybase_secret_key_pgp_message     = {
      ~ Administrator = null -&gt; (known after apply)
        # (1 unchanged element hidden)
    }
</code></pre><p>誒結果不符合預期，</p><ul><li><code>aws_iam_access_key.this</code> 需要重建<ul><li>原因是我們更改了 <code>pgp_key = "keybase:chechiachang"</code> 造成 forces replacement</li><li>因為</li><li>想一想也很合理<ul><li>第一次創建 access key 的時候，keybase 是亂寫的，這時用 module 的 code 去跑，產生無加密的 access key 放在 state 中</li><li>這次 import 後，module 中的 .tf code 已經改過，不再存無加密的 access key，而是加密後儲存 GPG Encrypted Message</li><li>這個改變讓 provider 覺得沒有辦法符合，只好刪掉重建</li></ul></li></ul></li><li><code>.aws_iam_user_login_profile.this</code> 需要重建，原因也是一樣，因為我們改了 .tf code 邏輯，造成 provider 勢必要重建 login profile</li></ul><p>執行 terraform apply</p><p>NOTE: 注意有 destroy 的 terraform plan 都要特別小心 review，因為很多 aws API delete 發出去就是無法復原了</p><ul><li>例如 access key 與 password 刪掉後，是無法 recover 的</li><li>有些 API request 會有副作用<ul><li>reset password 後，aws web console 會被登出</li><li>access key 換掉 terraform 就不能用，有可能導致 terraform 進行到一半被 permission denied (這個 apply 不會，只是提醒大家要注意)</li></ul></li></ul><p>有 destroy 的部分都要小心 review，看不懂就找 peering review
有 destroy 的部分都要小心 review，看不懂就找 peering review
有 destroy 的部分都要小心 review，看不懂就找 peering review</p><p>很重要所以說三次</p><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt apply

Apply complete! Resources: 2 added, 0 changed, 2 destroyed.

Outputs:

keybase_password_decrypt_command = {
  &quot;Accounting&quot; = &lt;&lt;-EOT
  echo &quot;wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A==&quot; | base64 --decode | keybase pgp decrypt

  EOT
  &quot;Administrator&quot; = &lt;&lt;-EOT
  echo &quot;wcFMA4U4ylYlNYTfAQ/+JcRNkO9SxMm9U196p2WuuXdSWo9ooktKJMp3q4Xf5xMG5z/ccphl5+fVDmkp2Pr76UJ9NmiBw8rzScFUEU4U+xZepNojSdN/rmZPWB6PKCdJMyItw6HOnn7OSa0i1arr0PHaC0bpVs4Bc+9Oqtw1SuU8uvwBpCeM+h33qOROnvKnGgvOHV2Zk1XcgT+sg7xMTv8q77KePoNLTK3joQL7fXdPWUGWCp8srWpxzJ8LD4aNMmsrjA/s/7sNbAAdhffRwwA6diuZfeYscZ6MlURUtrSx3iAuNV33kmhuyYimlmXstbfs/nIJVI5OfcVexPKzHK5O9DikXApAzbf/YACz0OebOcxnzh6+rQw9+XWwRtARcK3tViMhxqnEu4PHROmj1sNmLZLJqCniwN91J2iry7BAx2Zoyvvw7vd7Sw9LddaM+j2XHhSf21250sNMn/9R6beUlkWQgPci8mU51rnqBffbOJnvVh7QCTLssoMTgKRrgxb+oZbSsKLLQO/621ZcTY9rzC74w2kZWJTS7nx5G/0KQkwXP4NGRSTXYg3/6TcwT7LefQiJpWB2z92zT1sp5lPhtpNneqrtFFnirplfP5coeelRSlTEbHDwbHSX1LfHU7A5WHjf7oEHvn2hMhdgTlvGt4vL7rXiy9p8GWjcudGxZs+/WNs8CCkZd8j2gVvSRQEmNNtCd/U3jmq+o2VncJjBhetJ7eCyvKOAMwcCLHE0zleX77mXVtq7UVLXrcypxIbVjJAIko8y71fATyrRomcijS7Sgw==&quot; | base64 --decode | keybase pgp decrypt

  EOT
}
keybase_password_pgp_message = {
  &quot;Accounting&quot; = &lt;&lt;-EOT
  -----BEGIN PGP MESSAGE-----
  Version: Keybase OpenPGP v2.0.76
  Comment: https://keybase.io/crypto

  wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A==
  -----END PGP MESSAGE-----

  EOT
  &quot;Administrator&quot; = &lt;&lt;-EOT
  -----BEGIN PGP MESSAGE-----
  Version: Keybase OpenPGP v2.0.76
  Comment: https://keybase.io/crypto

  wcFMA4U4ylYlNYTfAQ/+JcRNkO9SxMm9U196p2WuuXdSWo9ooktKJMp3q4Xf5xMG5z/ccphl5+fVDmkp2Pr76UJ9NmiBw8rzScFUEU4U+xZepNojSdN/rmZPWB6PKCdJMyItw6HOnn7OSa0i1arr0PHaC0bpVs4Bc+9Oqtw1SuU8uvwBpCeM+h33qOROnvKnGgvOHV2Zk1XcgT+sg7xMTv8q77KePoNLTK3joQL7fXdPWUGWCp8srWpxzJ8LD4aNMmsrjA/s/7sNbAAdhffRwwA6diuZfeYscZ6MlURUtrSx3iAuNV33kmhuyYimlmXstbfs/nIJVI5OfcVexPKzHK5O9DikXApAzbf/YACz0OebOcxnzh6+rQw9+XWwRtARcK3tViMhxqnEu4PHROmj1sNmLZLJqCniwN91J2iry7BAx2Zoyvvw7vd7Sw9LddaM+j2XHhSf21250sNMn/9R6beUlkWQgPci8mU51rnqBffbOJnvVh7QCTLssoMTgKRrgxb+oZbSsKLLQO/621ZcTY9rzC74w2kZWJTS7nx5G/0KQkwXP4NGRSTXYg3/6TcwT7LefQiJpWB2z92zT1sp5lPhtpNneqrtFFnirplfP5coeelRSlTEbHDwbHSX1LfHU7A5WHjf7oEHvn2hMhdgTlvGt4vL7rXiy9p8GWjcudGxZs+/WNs8CCkZd8j2gVvSRQEmNNtCd/U3jmq+o2VncJjBhetJ7eCyvKOAMwcCLHE0zleX77mXVtq7UVLXrcypxIbVjJAIko8y71fATyrRomcijS7Sgw==
  -----END PGP MESSAGE-----

  EOT
}
keybase_secret_key_decrypt_command = {
  &quot;Accounting&quot; = tostring(null)
  &quot;Administrator&quot; = &lt;&lt;-EOT
  echo &quot;wcFMA4U4ylYlNYTfARAAivQzF+bh6N6OH/3a1S7XQCrIceoLn9EXsc8Gr0p09TVieSqwwv1RojaCULjYXYu5UnxRFwaavN+ULxrl2c4hRBIMgNEAo1Nxy16vfDEj4W7S9l+yA/TU3ewbs8WqKHIFrO8+AcjxUV4Ol5cmziDu70UR0H1/f0w7lqC/s36Zqa1Rz5Mb1n7ATLfs4jiPDQiFlr+E6gSe+I23sAQqdDS/WEbwAVz6o2B9mvs+OznNzeDoTwd7nE2ca+jYDZKjEjD6+qfDAnVzftwSrJIb2yJYlKIeSKJLC9loEQk2wdR5fkKrPg//9S4gYQJjzkwWyJAQsc6AuOPZXjqVe5yV9EpG2r0938G/acR3SEjt53ckXjh6Fi0/EgOjfeTVMO0EH6Se/vurdXBRyMggTieyN76Ts8nnn32GBldTZBUgWTL1Udj6B9ueqFCFuB8LFGNNNoHYjp3hAeGEQdtgI9TQ9r+jRDKpO8zcDoRMFK7wv4DJ31Nl/aS++a8nFEwJp7D5XkiSPbJ9JE1MwvuufldAHqr8iRbt3LmKeB4qC3TFbIhNWY4gs2VZ5LTepIn18sQfQ4f5s9o1lpem4yQw2XeEA7Fd1sPVypVeOj4z8Y080duGES896LiGpsAZdQ3bm/RiuIMLSabArgWCP/0LgrOQU8SwrIdN3k4682nw41KVnhjY2IDSWQHfEUCTNkgNfdj8v7FiD/OHX5G6VX/NAOwiAQ7Qh9u6UOmyAVY3QTjgVYEF4+oUyX+zZWprhhJkvHRDTTTNqozxVBfbYqrKTxSa00MRwAFIwQJh3xXbvmlF&quot; | base64 --decode | keybase pgp decrypt

  EOT
}
keybase_secret_key_pgp_message = {
  &quot;Accounting&quot; = tostring(null)
  &quot;Administrator&quot; = &lt;&lt;-EOT
  -----BEGIN PGP MESSAGE-----
  Version: Keybase OpenPGP v2.0.76
  Comment: https://keybase.io/crypto

  wcFMA4U4ylYlNYTfARAAivQzF+bh6N6OH/3a1S7XQCrIceoLn9EXsc8Gr0p09TVieSqwwv1RojaCULjYXYu5UnxRFwaavN+ULxrl2c4hRBIMgNEAo1Nxy16vfDEj4W7S9l+yA/TU3ewbs8WqKHIFrO8+AcjxUV4Ol5cmziDu70UR0H1/f0w7lqC/s36Zqa1Rz5Mb1n7ATLfs4jiPDQiFlr+E6gSe+I23sAQqdDS/WEbwAVz6o2B9mvs+OznNzeDoTwd7nE2ca+jYDZKjEjD6+qfDAnVzftwSrJIb2yJYlKIeSKJLC9loEQk2wdR5fkKrPg//9S4gYQJjzkwWyJAQsc6AuOPZXjqVe5yV9EpG2r0938G/acR3SEjt53ckXjh6Fi0/EgOjfeTVMO0EH6Se/vurdXBRyMggTieyN76Ts8nnn32GBldTZBUgWTL1Udj6B9ueqFCFuB8LFGNNNoHYjp3hAeGEQdtgI9TQ9r+jRDKpO8zcDoRMFK7wv4DJ31Nl/aS++a8nFEwJp7D5XkiSPbJ9JE1MwvuufldAHqr8iRbt3LmKeB4qC3TFbIhNWY4gs2VZ5LTepIn18sQfQ4f5s9o1lpem4yQw2XeEA7Fd1sPVypVeOj4z8Y080duGES896LiGpsAZdQ3bm/RiuIMLSabArgWCP/0LgrOQU8SwrIdN3k4682nw41KVnhjY2IDSWQHfEUCTNkgNfdj8v7FiD/OHX5G6VX/NAOwiAQ7Qh9u6UOmyAVY3QTjgVYEF4+oUyX+zZWprhhJkvHRDTTTNqozxVBfbYqrKTxSa00MRwAFIwQJh3xXbvmlF
  -----END PGP MESSAGE-----

  EOT
}
</code></pre><p>這時嘗試在使用 terraform plan，會無法取得 state s3 bucket</p><ul><li>因為 access key 已經重建，現在 terraform 使用舊的 access key 連 s3 會 404 not found</li></ul><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt plan

Remote state S3 bucket chechia-root-ap-northeast-1-terraform-state does not exist or you don't have permissions to access it. Would you like Terragrunt to create it? (y/n) n
ERRO[0004] remote state S3 bucket chechia-root-ap-northeast-1-terraform-state does not exist or you don't have permissions to access it
ERRO[0004] Unable to determine underlying exit code, so Terragrunt will exit with error code 1
</code></pre><p>取得 output 後，一樣做 gpg decrypt 取得</p><ul><li>password</li><li>access key</li></ul><p>完成後使用 aws-vault 移除舊的 profile + credential，再從新匯入 access key</p><pre><code>aws-vault remove terraform-30day-root-iam-user
Delete credentials for profile &quot;terraform-30day-root-iam-user&quot;? (y|N) y
Deleted credentials.

aws-vault add terraform-30day-root-iam-user
Enter Access Key ID:
Enter Secret Access Key:
Added credentials to profile &quot;terraform-30day-root-iam-user&quot; in vault
</code></pre><p>完成後就可以正常使用 aws-vault plan 了</p><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  --  terragrunt plan
</code></pre><p>上面的變更我們的 PR 如下</p><ul><li><a href=https://github.com/chechiachang/terragrunt-infrastructure-modules/pull/3>terragrunt-infrastructure-modules PR</a></li><li><a href=https://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/3>terragrunt-infrastructure-live-example PR</a></li></ul><h3 id=todo-與進度>TODO 與進度<a hidden class=anchor aria-hidden=true href=#todo-與進度>#</a></h3><ul><li><input checked disabled type=checkbox> 透過 root account 設定一組 IAM User</li><li><input checked disabled type=checkbox> 透過 root account 設定多個 aws child accounts</li><li><input checked disabled type=checkbox> root 中設定 IAM User<ul><li><input checked disabled type=checkbox> 將手動產生的 Administrator 的 IAM User import terraform 中</li><li><input checked disabled type=checkbox> 補上 root account IAM Policy</li><li><input checked disabled type=checkbox> 補上 root account IAM Group</li><li><input checked disabled type=checkbox> reset root account IAM user login profile & pgp key</li></ul></li><li><input disabled type=checkbox> security 中設定 IAM User<ul><li><input disabled type=checkbox> security 設定 password policy</li><li><input disabled type=checkbox> security 設定 MFA policy</li></ul></li><li><input disabled type=checkbox> security 中設定 IAM Policy & Group</li><li><input disabled type=checkbox> dev 中設定 IAM role</li><li><input disabled type=checkbox> 允許 security assume dev IAM role</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/terraform/>Terraform</a></li><li><a href=https://chechia.net/tags/iac/>Iac</a></li><li><a href=https://chechia.net/tags/aws/>Aws</a></li><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2022/>鐵人賽2022</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2022-09-20-14th-ithome-ironman-iac-aws-workshop-09-terraform-module-and-password-security/><span class=title>« Prev</span><br><span>Modules and password security</span>
</a><a class=next href=https://chechia.net/posts/2022-09-18-14th-ithome-ironman-iac-aws-workshop-07-reset-iam-user/><span class=title>Next »</span><br><span>Reset Iam User</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on x" href="https://x.com/intent/tweet/?text=Reset%20Iam%20User%20Administrator&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f&amp;hashtags=terraform%2ciac%2caws%2c%e9%90%b5%e4%ba%ba%e8%b3%bd2022"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f&amp;title=Reset%20Iam%20User%20Administrator&amp;summary=Reset%20Iam%20User%20Administrator&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f&title=Reset%20Iam%20User%20Administrator"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on whatsapp" href="https://api.whatsapp.com/send?text=Reset%20Iam%20User%20Administrator%20-%20https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on telegram" href="https://telegram.me/share/url?text=Reset%20Iam%20User%20Administrator&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Reset Iam User Administrator on ycombinator" href="https://news.ycombinator.com/submitlink?t=Reset%20Iam%20User%20Administrator&u=https%3a%2f%2fchechia.net%2fposts%2f2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>