<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Provision Child AWS Accounts | Che-Chia Chang</title><meta name=keywords content="terraform,iac,aws,鐵人賽2022"><meta name=description content="Article description."><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Provision Child AWS Accounts"><meta property="og:description" content="Article description."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-16T17:16:21+08:00"><meta property="article:modified_time" content="2022-09-16T17:16:21+08:00"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Iac"><meta property="article:tag" content="Aws"><meta property="article:tag" content="鐵人賽2022"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Provision Child AWS Accounts"><meta name=twitter:description content="Article description."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Provision Child AWS Accounts","item":"https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Provision Child AWS Accounts","name":"Provision Child AWS Accounts","description":"Article description.","keywords":["terraform","iac","aws","鐵人賽2022"],"articleBody":"今天要使用 terraform 設定 AWS account structure\niThome 鐵人賽好讀版\n賽後文章會整理放到個人的部落格上 http://chechia.net/\n追蹤粉專可以收到文章的主動推播\n–\nProvision AWS Account\n今天要把 aws account 設定完成，並且開始使用 live-repository 來搭建 aws 元件\n我們自己的 module repository 開一個權限的 repository fork 我自幹的 modules repository terragrunt-infrastructure-modules https://github.com/chechiachang/terragrunt-infrastructure-modules 上面這個是放 terraform module 的 repository，是兩個 repository 不要跟執行 terragrunt repository 搞混，是兩個 repository https://github.com/chechiachang/terragrunt-infrastructure-live-example 今天的進度與 code base\nterraform-live-example PR 在此 terragrunt-infrastructure-modules 請直接看 tag v0.0.1 因為有地方嚴重寫錯，我有 force push 東西 :tear:，如果已經提早下載的朋友可能會需要清掉 repository main branch + tag 重拉 orz 對，我們且戰且走常常會這樣，發現昨天寫的東西寫錯臨時改，請大家見諒\n為何使用 aws modules X) 因為我們沒有付錢，不能用 gruntwork 的 priviate repository (大誤\nO) 因為我們想要使用開源版本的 terraform module (XD)\n我們快速看一下 module 裡面的內容 https://github.com/chechiachang/terragrunt-infrastructure-modules/tree/v0.0.1/aws/modules/account-baseline-root\nresource \"aws_organizations_organization\" \"org\" { aws_service_access_principals = [ \"cloudtrail.amazonaws.com\", \"config.amazonaws.com\", ] feature_set = \"ALL\" } resource \"aws_organizations_account\" \"account\" { for_each = var.child_accounts name = each.key email = each.value[\"email\"] depends_on = [ aws_organizations_organization.org ] } 我們的需求\n在 root account 下 provision 一個 aws organization 為每個環境 provision 一個 aws organization account 使用 terraform for_each function 來迭代 variabel 傳入的 organization accounts (型別是 map) each.key 會拿到每個 map element 的 key，例如 child_accounts = { logs = {}, security = {}, shared = {}, dev = {}, stage = {}, prod = {} } 跑出來 each.key 就會是 [logs, security, shared, dev, stage, prod] 正好是我們這次需要 provision 的六個 aws organization accounts，滿足目前的需求 each.value[“email”] 則依序帶入各自的 email 到 account 中 NOTE: 這些 email 請使用你收得到的 email\n在現實中這會是六組不同的 email，email 重複的話會被 aws api reject，所以需要使用不同的 email 或是跟 gruntwork guide 一樣，使用 gmail 帳號後+ 的字元會 ignore 如果設定了收不到信的 email 作為 account email 就會有點麻煩 不要像我一樣設了 6 個收不到 email，只好再多開一個 account XD，還好我們是在 workshop 這個 terraform module 的寫法完全忽略其他 each.value 內的值\n我們並不清楚 gruntwork 在 private 的 terraform module 中，遮些參數的確切用途，以及對 aws organization account 設定有何影響 但以筆者使用 aws 的經驗，大概猜得出來這些參數的用途，以及 terraform module 應該如何調整，為了課程進度安排，我們先暫時忽略。繼續照著 gruntwork 的文件做下去，之後有用到再來補 Terragrunt Plan \u0026 apply 在跑 terragrunt 之前，我們先要切換成 root account 的 iam User，昨天新建的 IAM User，存放在密碼企理，還記得嗎？\n使用 aws-vault 拿 IAM User 的 access key 做 programatic 登入，提供 terraform credential。而非透過 aws web console 記住：我們不能用 root account 做這些工作\naws-vault 由於我們現在要使用 IAM User 做 terraform 來創建新的 child accounts，未來會使用新的 child accounts 來做各個環境中的 terraform 元件操作，我們需要一個工具來協助切換這些 account\n我們使用的工具是 aws-vault\nhttps://github.com/99designs/aws-vault 支援很多安裝平台，選自己喜歡用的，或是直接在 github release 頁面下載 binary $ aws-vault --help usage: aws-vault [] [ ...] A vault for securely storing and accessing AWS credentials in development environments. ... 使用 Root Account IAM User 身份執行 terragrunt\n在本機紀錄 access key (請好好保護本機的安全)\naws-vault add terraform-30day-root-iam-user Enter Access Key Id: XXXXXXXXXXXX Enter Secret Key: YYYYYYYYYYYY 透過 aws-cli 取得 caller identity，也就是現在的身份是誰，確定是 Administrator\n從 aws 的角度，所有操作都是 IAM User: Administrator 操作的 只能操作當初建立 IAM User 時 attach 的權限（蘇然也是很大）但已經比 root account 小很多 之後我們會進一步限縮每一個 IAM User 的 permission aws-vault exec terraform-30day-root-iam-user -- aws sts get-caller-identity { \"UserId\": \"AIDAxxxxxxxxxxxKGW\", \"Account\": \"706136188012\", \"Arn\": \"arn:aws:iam::706136188012:user/Administrator\" } 然後透過 aws-vault 來執行 terragunt，這樣 terragrunt 就會使用 IAM User 的 credential 來操作 provider 去呼叫 aws api\naws-vault exec terraform-30day-root-iam-user -- terragrunt init aws-vault exec terraform-30day-root-iam-user -- terragrunt plan Terraform will perform the following actions: # aws_organizations_account.account[\"dev\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"terraform30days@outlook.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"dev\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\"logs\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"terraform30days@outlook.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"logs\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\"prod\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"terraform30days@outlook.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"prod\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\"security\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"terraform30days@outlook.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"security\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\"shared\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"terraform30days@outlook.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"shared\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\"stage\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"terraform30days@outlook.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"stage\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\"prod\"] will be created + resource \"aws_organizations_account\" \"account\" { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \"chechiachang999+terraform-test@gmail.com\" + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \"prod\" + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_organization.org will be created + resource \"aws_organizations_organization\" \"org\" { + accounts = (known after apply) + arn = (known after apply) + aws_service_access_principals = [ + \"cloudtrail.amazonaws.com\", + \"config.amazonaws.com\", ] + feature_set = \"ALL\" + id = (known after apply) + master_account_arn = (known after apply) + master_account_email = (known after apply) + master_account_id = (known after apply) + non_master_accounts = (known after apply) + roots = (known after apply) } Plan: 8 to add, 0 to change, 0 to destroy. Terragrunt plan 後產生 terraform plan，我們要仔細 review\n0 change / 0 delete，這邊很重要，確定我們不會改錯或是誤刪已經存在的 aws 元件 7 to add，新增了 7 個 aws 元件 一個 aws_organization 六個 aws_organization_account，對應未來的六個環境 一個 aws_organization_account，因為上面 email 設錯卡住，而多開一個 test 環境XD review 沒問題後，我們進行 apply\naws-vault exec terraform-30day-root-iam-user -- terragrunt apply aws_organizations_account.account[\"logs\"]: Creating... aws_organizations_account.account[\"stage\"]: Creating... aws_organizations_account.account[\"prod\"]: Creating... aws_organizations_account.account[\"security\"]: Creating... aws_organizations_account.account[\"dev\"]: Creating... aws_organizations_account.account[\"shared\"]: Creating... aws_organizations_account.account[\"prod\"]: Creating... aws_organizations_account.account[\"logs\"]: Creating... aws_organizations_account.account[\"logs\"]: Still creating... [10s elapsed] aws_organizations_account.account[\"prod\"]: Still creating... [10s elapsed] aws_organizations_account.account[\"logs\"]: Creation complete after 14s [id=557659608246] aws_organizations_account.account[\"prod\"]: Creation complete after 14s [id=420896464212] 創建完成 organization 與 organization accounts 後，我們可以進行檢查\n到 aws console -\u003e organization 頁面，可以看到新建的 organization 與 accounts\n也可以使用 aws-cli 列出 organization 的 accounts\naws-vault exec terraform-30day-root-iam-user --no-session -- aws organizations list-accounts 使用 external module 二三事 使用開源的 terraform module 也是有很多好處\n首先我們使用的是 aws 維護的 terraform module，如果 aws api 有更新通常都跟得很快 開源 module 會有大量的社群幫忙發 issue 討論與 PR review 遇到問題可以直接開 issue 問 gruntwork enterprise 的 module 是 enterprise 等級的解決方案，有相當的 code 品質，但在上面幾點自然是不如開源 repository 順便提一下，如果之後要自己動手寫其他元件，應該如何找到適合的 external terraform module?\n有需要導入其他公有雲的元件 (ex. azure / gcp / …)，可以在 registry.terraform.io 上面搜尋找到 通常比較大間的 Cloud provider 為了方便使用者，都會維護自家產品的 terraform module，方便使用這直接使用 IaC 的方式導入，可以直接使用自己家推出的 terraform module 因為 aws 最熟悉自己家的元件，比較不會出 bug 遇到問題可以直接發 issue 讓 aws 的工程師來看 如果 registry.terraform.io 上，某個元件找不到自己公司出的 terraform module，那可能就要找看看社群版本的 如果 registry.terraform.io 上搜尋不到，可以上 Github 搜尋 “terraform + 元件名稱” 可能找到沒有收錄在 registry 的 terraform module。或是直接 google，偶爾也會有意外收穫 沒有 terraform official validated module 就要特別注意安全性 一個好的 terraform module 通常有幾個特徵\n有良好的更新紀錄在 commit history 中 有活躍的社群 發 issue 討論 / PR / review 有完整的 changelog 紀錄變更如何時升版，也方便讓使用者升版時檢查 時常更新，能夠符合新版的 terraform core version 規格 會鎖定 dependency 版本，ex. terraform core version 與依賴的 provider version 反之，如果發現一個 terraform module 年久失修，很少人討論，也沒有跟上 terraform core 版本 (ex. 不支援 1.x) 可能就要考慮一下是否要使用 使用外部 module 應該注意的事情 有時候某些外部 module 會有雷，導致我們去引用時出現錯誤\n更改已經存在的 tag / 竄改 commit history / … 等 或是 repository 移除變不見 / 改名 / 改 url 為了避免我們原本好好的 terraform code 受到影響，如果有使用外部 module，我們可以先 fork 一份外部 module 到 internal repository (clone 一份再 push 到自家的 cvs 上面），然後把 source url 改成 fork internal repository\n例如本來是 github.com/chechiachang/terragrunt-infrastructure-modules fork (clone \u0026 push) 變成 chechia.bitbucket.com/chechia/terragrunt-infrastructure-modules source url 中使用 git tag reference，明確指定 internal module (不用 github.com 而用 chechia.bitchecket) 需要更新時，在從 github 上 pull 最新的 code，push 到 bitbucket 上，修改 source url 就完成升版 這樣可以將對 external module 的依賴轉乘 loose coupling，降低耦合程度，如果 external module 整個壞掉，我們的 terraform module 使用不受影響。但又能 trace 原先的 external module remote，方便接收更新。 缺點是會花一些人力整理這些 forked module repositories 使用 external module 也要注意資訊安全\n要小心來路不明的 terraform module，terraform module 可以取得很多遠端的私密訊息，可能會有安群性的隱憂 沒有 terraform validated 的 terraform module，使用前自己要看過內容 看到使用不熟悉的 terraform provider，也應該去檢查 provider 的出處與內容 避免用自己的 aws account 身份執行後，發現被偷埋東西，或是資料洩漏出去 如果發現自己使用的元件比較冷門，符合自己需求的 external module 也年久失修，也可以考慮 hard fork 一版，由團隊自己維護\n可以參考現有的架構與內容，根據內部的需求去修改 terraform module，最後在自己引用 內部維護，自己控制升版與發佈 如果不是太複雜的 module 其實可以做 做完記得用安全性工具檢查，確保沒有安全隱憂（這個我們稍後幾天的內容會提） ","wordCount":"1420","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-09-16T17:16:21+08:00","dateModified":"2022-09-16T17:16:21+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://chechia.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chechia.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Provision Child AWS Accounts</h1><div class=post-description>Article description.</div><div class=post-meta><span title='2022-09-16 17:16:21 +0800 CST'>September 16, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1420 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#我們自己的-module-repository>我們自己的 module repository</a></li><li><a href=#為何使用-aws-modules>為何使用 aws modules</a></li><li><a href=#terragrunt-plan--apply>Terragrunt Plan & apply</a></li><li><a href=#aws-vault>aws-vault</a></li><li><a href=#使用-external-module-二三事>使用 external module 二三事</a></li><li><a href=#使用外部-module-應該注意的事情>使用外部 module 應該注意的事情</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>今天要使用 terraform 設定 AWS account structure</p><p><a href=https://ithelp.ithome.com.tw/articles/10290931>iThome 鐵人賽好讀版</a></p><p><a href=http://chechia.net/>賽後文章會整理放到個人的部落格上 http://chechia.net/</a></p><p><a href=https://www.facebook.com/engineer.from.scratch>追蹤粉專可以收到文章的主動推播</a></p><p><img alt=https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg></p><p>&ndash;</p><p>Provision AWS Account</p><p>今天要把 aws account 設定完成，並且開始使用 live-repository 來搭建 aws 元件</p><hr><h3 id=我們自己的-module-repository>我們自己的 module repository<a hidden class=anchor aria-hidden=true href=#我們自己的-module-repository>#</a></h3><ul><li>開一個權限的 repository</li><li>fork 我自幹的 modules repository terragrunt-infrastructure-modules <a href=https://github.com/chechiachang/terragrunt-infrastructure-modules>https://github.com/chechiachang/terragrunt-infrastructure-modules</a></li><li>上面這個是放 terraform module 的 repository，是兩個 repository</li><li>不要跟執行 terragrunt repository 搞混，是兩個 repository <a href=https://github.com/chechiachang/terragrunt-infrastructure-live-example>https://github.com/chechiachang/terragrunt-infrastructure-live-example</a></li></ul><p>今天的進度與 code base</p><ul><li><a href=https://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/1>terraform-live-example PR 在此</a></li><li><a href>terragrunt-infrastructure-modules 請直接看 tag v0.0.1</a><ul><li>因為有地方嚴重寫錯，我有 force push 東西 :tear:，如果已經提早下載的朋友可能會需要清掉 repository main branch + tag 重拉 orz</li></ul></li></ul><p>對，我們且戰且走常常會這樣，發現昨天寫的東西寫錯臨時改，請大家見諒</p><h3 id=為何使用-aws-modules>為何使用 aws modules<a hidden class=anchor aria-hidden=true href=#為何使用-aws-modules>#</a></h3><p>X) 因為我們沒有付錢，不能用 gruntwork 的 priviate repository (大誤</p><p>O) 因為我們想要使用開源版本的 terraform module (XD)</p><p>我們快速看一下 module 裡面的內容
<a href=https://github.com/chechiachang/terragrunt-infrastructure-modules/tree/v0.0.1/aws/modules/account-baseline-root>https://github.com/chechiachang/terragrunt-infrastructure-modules/tree/v0.0.1/aws/modules/account-baseline-root</a></p><pre><code>resource &quot;aws_organizations_organization&quot; &quot;org&quot; {
  aws_service_access_principals = [
    &quot;cloudtrail.amazonaws.com&quot;,
    &quot;config.amazonaws.com&quot;,
  ]

  feature_set = &quot;ALL&quot;
}

resource &quot;aws_organizations_account&quot; &quot;account&quot; {
  for_each = var.child_accounts
  name  = each.key
  email = each.value[&quot;email&quot;]

  depends_on = [
    aws_organizations_organization.org
  ]
}
</code></pre><p>我們的需求</p><ul><li>在 root account 下 provision 一個 aws organization<ul><li>為每個環境 provision 一個 aws organization account</li><li>使用 terraform <code>for_each</code> function 來迭代 variabel 傳入的 organization accounts (型別是 map)</li><li>each.key 會拿到每個 map element 的 key，例如</li></ul></li></ul><pre><code>  child_accounts = {
    logs = {},
    security = {},
    shared = {},
    dev = {},
    stage = {},
    prod = {}
  }
</code></pre><ul><li>跑出來 each.key 就會是 [logs, security, shared, dev, stage, prod] 正好是我們這次需要 provision 的六個 aws organization accounts，滿足目前的需求</li><li>each.value[&ldquo;email&rdquo;] 則依序帶入各自的 email 到 account 中</li></ul><p>NOTE: 這些 email 請使用你收得到的 email</p><ul><li>在現實中這會是六組不同的 email，email 重複的話會被 aws api reject，所以需要使用不同的 email<ul><li>或是跟 <a href=https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/deployment-walkthrough/configure-the-security-baseline-for-the-root-account>gruntwork guide</a> 一樣，使用 gmail 帳號後+ 的字元會 ignore</li></ul></li><li>如果設定了收不到信的 email 作為 account email 就會有點麻煩</li><li>不要像我一樣設了 6 個收不到 email，只好再多開一個 account XD，還好我們是在 workshop</li></ul><p>這個 terraform module 的寫法完全忽略其他 each.value 內的值</p><ul><li>我們並不清楚 gruntwork 在 private 的 terraform module 中，遮些參數的確切用途，以及對 aws organization account 設定有何影響</li><li>但以筆者使用 aws 的經驗，大概猜得出來這些參數的用途，以及 terraform module 應該如何調整，為了課程進度安排，我們先暫時忽略。繼續照著 gruntwork 的文件做下去，之後有用到再來補</li></ul><h3 id=terragrunt-plan--apply>Terragrunt Plan & apply<a hidden class=anchor aria-hidden=true href=#terragrunt-plan--apply>#</a></h3><p>在跑 terragrunt 之前，我們先要切換成 root account 的 iam User，昨天新建的 IAM User，存放在密碼企理，還記得嗎？</p><ul><li>使用 aws-vault 拿 IAM User 的 access key 做 programatic 登入，提供 terraform credential。而非透過 aws web console</li></ul><p>記住：我們不能用 root account 做這些工作</p><h3 id=aws-vault>aws-vault<a hidden class=anchor aria-hidden=true href=#aws-vault>#</a></h3><p>由於我們現在要使用 IAM User 做 terraform 來創建新的 child accounts，未來會使用新的 child accounts 來做各個環境中的 terraform 元件操作，我們需要一個工具來協助切換這些 account</p><p>我們使用的工具是 aws-vault</p><ul><li><a href=https://github.com/99designs/aws-vault>https://github.com/99designs/aws-vault</a></li><li>支援很多安裝平台，選自己喜歡用的，或是直接在 github release 頁面下載 binary</li></ul><pre><code>$ aws-vault --help

usage: aws-vault [&lt;flags&gt;] &lt;command&gt; [&lt;args&gt; ...]

A vault for securely storing and accessing AWS credentials in development environments.
...

</code></pre><p>使用 Root Account IAM User 身份執行 terragrunt</p><p>在本機紀錄 access key (請好好保護本機的安全)</p><pre><code>aws-vault add terraform-30day-root-iam-user
Enter Access Key Id: XXXXXXXXXXXX
Enter Secret Key: YYYYYYYYYYYY
</code></pre><p>透過 aws-cli 取得 caller identity，也就是現在的身份是誰，確定是 Administrator</p><ul><li>從 aws 的角度，所有操作都是 IAM User: Administrator 操作的</li><li>只能操作當初建立 IAM User 時 attach 的權限（蘇然也是很大）但已經比 root account 小很多<ul><li>之後我們會進一步限縮每一個 IAM User 的 permission</li></ul></li></ul><pre><code>aws-vault exec terraform-30day-root-iam-user -- aws sts get-caller-identity

{
    &quot;UserId&quot;: &quot;AIDAxxxxxxxxxxxKGW&quot;,
    &quot;Account&quot;: &quot;706136188012&quot;,
    &quot;Arn&quot;: &quot;arn:aws:iam::706136188012:user/Administrator&quot;
}
</code></pre><p>然後透過 aws-vault 來執行 terragunt，這樣 terragrunt 就會使用 IAM User 的 credential 來操作 provider 去呼叫 aws api</p><pre><code>aws-vault exec terraform-30day-root-iam-user -- terragrunt init

aws-vault exec terraform-30day-root-iam-user -- terragrunt plan

Terraform will perform the following actions:

  # aws_organizations_account.account[&quot;dev&quot;] will be created
  + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;terraform30days@outlook.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;dev&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

  # aws_organizations_account.account[&quot;logs&quot;] will be created
  + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;terraform30days@outlook.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;logs&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

  # aws_organizations_account.account[&quot;prod&quot;] will be created
  + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;terraform30days@outlook.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;prod&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

  # aws_organizations_account.account[&quot;security&quot;] will be created
  + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;terraform30days@outlook.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;security&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

  # aws_organizations_account.account[&quot;shared&quot;] will be created
  + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;terraform30days@outlook.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;shared&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

  # aws_organizations_account.account[&quot;stage&quot;] will be created
  + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;terraform30days@outlook.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;stage&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

    # aws_organizations_account.account[&quot;prod&quot;] will be created
    + resource &quot;aws_organizations_account&quot; &quot;account&quot; {
      + arn               = (known after apply)
      + close_on_deletion = false
      + create_govcloud   = false
      + email             = &quot;chechiachang999+terraform-test@gmail.com&quot;
      + govcloud_id       = (known after apply)
      + id                = (known after apply)
      + joined_method     = (known after apply)
      + joined_timestamp  = (known after apply)
      + name              = &quot;prod&quot;
      + parent_id         = (known after apply)
      + status            = (known after apply)
      + tags_all          = (known after apply)
    }

    # aws_organizations_organization.org will be created
    + resource &quot;aws_organizations_organization&quot; &quot;org&quot; {
      + accounts                      = (known after apply)
      + arn                           = (known after apply)
      + aws_service_access_principals = [
          + &quot;cloudtrail.amazonaws.com&quot;,
          + &quot;config.amazonaws.com&quot;,
        ]
      + feature_set                   = &quot;ALL&quot;
      + id                            = (known after apply)
      + master_account_arn            = (known after apply)
      + master_account_email          = (known after apply)
      + master_account_id             = (known after apply)
      + non_master_accounts           = (known after apply)
      + roots                         = (known after apply)
    }

Plan: 8 to add, 0 to change, 0 to destroy.
</code></pre><p>Terragrunt plan 後產生 terraform plan，我們要仔細 review</p><ul><li>0 change / 0 delete，這邊很重要，確定我們不會改錯或是誤刪已經存在的 aws 元件</li><li>7 to add，新增了 7 個 aws 元件<ul><li>一個 aws_organization</li><li>六個 aws_organization_account，對應未來的六個環境</li><li>一個 aws_organization_account，因為上面 email 設錯卡住，而多開一個 test 環境XD</li></ul></li></ul><p>review 沒問題後，我們進行 apply</p><pre><code>aws-vault exec terraform-30day-root-iam-user -- terragrunt apply

aws_organizations_account.account[&quot;logs&quot;]: Creating...
aws_organizations_account.account[&quot;stage&quot;]: Creating...
aws_organizations_account.account[&quot;prod&quot;]: Creating...
aws_organizations_account.account[&quot;security&quot;]: Creating...
aws_organizations_account.account[&quot;dev&quot;]: Creating...
aws_organizations_account.account[&quot;shared&quot;]: Creating...
aws_organizations_account.account[&quot;prod&quot;]: Creating...
aws_organizations_account.account[&quot;logs&quot;]: Creating...
aws_organizations_account.account[&quot;logs&quot;]: Still creating... [10s elapsed]
aws_organizations_account.account[&quot;prod&quot;]: Still creating... [10s elapsed]
aws_organizations_account.account[&quot;logs&quot;]: Creation complete after 14s [id=557659608246]
aws_organizations_account.account[&quot;prod&quot;]: Creation complete after 14s [id=420896464212]
</code></pre><p>創建完成 organization 與 organization accounts 後，我們可以進行檢查</p><p>到 aws console -> organization 頁面，可以看到新建的 organization 與 accounts</p><p><img alt="AWS Organization & Accounts" loading=lazy src=https://ithelp.ithome.com.tw/upload/images/20220917/20120327PXmDKamKOs.png></p><p>也可以使用 aws-cli 列出 organization 的 accounts</p><pre><code>aws-vault exec terraform-30day-root-iam-user --no-session  -- aws organizations list-accounts
</code></pre><h3 id=使用-external-module-二三事>使用 external module 二三事<a hidden class=anchor aria-hidden=true href=#使用-external-module-二三事>#</a></h3><p>使用開源的 terraform module 也是有很多好處</p><ul><li>首先我們使用的是 aws 維護的 terraform module，如果 aws api 有更新通常都跟得很快</li><li>開源 module 會有大量的社群幫忙發 issue 討論與 PR review</li><li>遇到問題可以直接開 issue 問
gruntwork enterprise 的 module 是 enterprise 等級的解決方案，有相當的 code 品質，但在上面幾點自然是不如開源 repository</li></ul><p>順便提一下，如果之後要自己動手寫其他元件，應該如何找到適合的 external terraform module?</p><ul><li>有需要導入其他公有雲的元件 (ex. azure / gcp / &mldr;)，可以在 <a href=https://registry.terraform.io/>registry.terraform.io</a> 上面搜尋找到</li><li>通常比較大間的 Cloud provider 為了方便使用者，都會維護自家產品的 terraform module，方便使用這直接使用 IaC 的方式導入，可以直接使用自己家推出的 terraform module<ul><li>因為 aws 最熟悉自己家的元件，比較不會出 bug</li><li>遇到問題可以直接發 issue 讓 aws 的工程師來看</li></ul></li><li>如果 <a href=https://registry.terraform.io/>registry.terraform.io</a> 上，某個元件找不到自己公司出的 terraform module，那可能就要找看看社群版本的</li><li>如果 <a href=https://registry.terraform.io/>registry.terraform.io</a> 上搜尋不到，可以上 Github 搜尋 &ldquo;terraform + 元件名稱&rdquo; 可能找到沒有收錄在 registry 的 terraform module。或是直接 google，偶爾也會有意外收穫<ul><li>沒有 terraform official validated module 就要特別注意安全性</li></ul></li></ul><p>一個好的 terraform module 通常有幾個特徵</p><ul><li>有良好的更新紀錄在 commit history 中</li><li>有活躍的社群 發 issue 討論 / PR / review</li><li>有完整的 changelog 紀錄變更如何時升版，也方便讓使用者升版時檢查</li><li>時常更新，能夠符合新版的 terraform core version 規格</li><li>會鎖定 dependency 版本，ex. terraform core version 與依賴的 provider version
反之，如果發現一個 terraform module 年久失修，很少人討論，也沒有跟上 terraform core 版本 (ex. 不支援 1.x) 可能就要考慮一下是否要使用</li></ul><h3 id=使用外部-module-應該注意的事情>使用外部 module 應該注意的事情<a hidden class=anchor aria-hidden=true href=#使用外部-module-應該注意的事情>#</a></h3><p>有時候某些外部 module 會有雷，導致我們去引用時出現錯誤</p><ul><li>更改已經存在的 tag / 竄改 commit history / &mldr; 等</li><li>或是 repository 移除變不見 / 改名 / 改 url</li></ul><p>為了避免我們原本好好的 terraform code 受到影響，如果有使用外部 module，我們可以先 fork 一份外部 module 到 internal repository (clone 一份再 push 到自家的 cvs 上面），然後把 source url 改成 fork internal repository</p><ul><li>例如本來是 <a href=https://github.com/chechiachang/terragrunt-infrastructure-modules>github.com/chechiachang/terragrunt-infrastructure-modules</a> fork (clone & push) 變成 chechia.bitbucket.com/chechia/terragrunt-infrastructure-modules</li><li>source url 中使用 git tag reference，明確指定 internal module (不用 github.com 而用 chechia.bitchecket)</li><li>需要更新時，在從 github 上 pull 最新的 code，push 到 bitbucket 上，修改 source url 就完成升版
這樣可以將對 external module 的依賴轉乘 loose coupling，降低耦合程度，如果 external module 整個壞掉，我們的 terraform module 使用不受影響。但又能 trace 原先的 external module remote，方便接收更新。</li><li>缺點是會花一些人力整理這些 forked module repositories</li></ul><p>使用 external module 也要注意資訊安全</p><ul><li>要小心來路不明的 terraform module，terraform module 可以取得很多遠端的私密訊息，可能會有安群性的隱憂</li><li>沒有 terraform validated 的 terraform module，使用前自己要看過內容</li><li>看到使用不熟悉的 terraform provider，也應該去檢查 provider 的出處與內容
避免用自己的 aws account 身份執行後，發現被偷埋東西，或是資料洩漏出去</li></ul><p>如果發現自己使用的元件比較冷門，符合自己需求的 external module 也年久失修，也可以考慮 hard fork 一版，由團隊自己維護</p><ul><li>可以參考現有的架構與內容，根據內部的需求去修改 terraform module，最後在自己引用</li><li>內部維護，自己控制升版與發佈</li><li>如果不是太複雜的 module 其實可以做</li><li>做完記得用安全性工具檢查，確保沒有安全隱憂（這個我們稍後幾天的內容會提）</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/terraform/>Terraform</a></li><li><a href=https://chechia.net/tags/iac/>Iac</a></li><li><a href=https://chechia.net/tags/aws/>Aws</a></li><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2022/>鐵人賽2022</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/><span class=title>« Prev</span><br><span>AWS Multi-Accounts Structure</span>
</a><a class=next href=https://chechia.net/posts/2022-09-13-14th-ithome-ironman-iac-aws-workshop-02-aws-account-structure/><span class=title>Next »</span><br><span>AWS Account Struture</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on x" href="https://x.com/intent/tweet/?text=Provision%20Child%20AWS%20Accounts&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f&amp;hashtags=terraform%2ciac%2caws%2c%e9%90%b5%e4%ba%ba%e8%b3%bd2022"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f&amp;title=Provision%20Child%20AWS%20Accounts&amp;summary=Provision%20Child%20AWS%20Accounts&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f&title=Provision%20Child%20AWS%20Accounts"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on whatsapp" href="https://api.whatsapp.com/send?text=Provision%20Child%20AWS%20Accounts%20-%20https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on telegram" href="https://telegram.me/share/url?text=Provision%20Child%20AWS%20Accounts&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Provision Child AWS Accounts on ycombinator" href="https://news.ycombinator.com/submitlink?t=Provision%20Child%20AWS%20Accounts&u=https%3a%2f%2fchechia.net%2fposts%2f2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>