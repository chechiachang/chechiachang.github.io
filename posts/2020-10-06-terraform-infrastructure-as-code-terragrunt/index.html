<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform Infrastructure as Code: Terragrunt | Che-Chia Chang</title><meta name=keywords content="kubernetes,terraform,鐵人賽2020,iac,aws"><meta name=description content="This article is part of 從零開始的 Infrastructu as Code: Terraform

Get-started examples / SOP on Github
Introducation to Terraform Iac: Speaker transcript
Presentation

Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)

上面講解 Terraform 的基本操作流程，提供範本原始碼，以及一步一步導入的詳細步驟。各位應該都可以依照上面幾篇的說明，開始快樂的使用 Terraform 了。
而當使用 Terraform 的規模越來越大，管理的資料越來越多時，開始會出現一些問題，例如重複的 terraform code 越來越多，協同工作 review 不太容易，state 的內容管理與鎖管理，等等。這些問題可以透過一些工作流程的改進，或是導入新的小工具，來改善工作效率。
接下來筆者推薦幾個心得與工具，希望能提升使用 Terraform 的效率與產值
以下幾篇文章，適合已經使用過 terraform 一點時間，有經驗的團隊，並打算更大規模導入 terraform，正在尋求改善的方向。

心得

CI/CD 全自動化
State backend 選擇
最佳實踐 https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html


工具

Terraform Atlantis
Terragrunt



問題與需求
當團隊已經開始大規模使用 terraform，tf 檔案越來越多。我們為了增加程式碼的重複利用性，會使用 terraform module 將常用的 tf 檔案封裝。"><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chechia.net/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Terraform Infrastructure as Code: Terragrunt"><meta property="og:description" content="This article is part of 從零開始的 Infrastructu as Code: Terraform
Get-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)
上面講解 Terraform 的基本操作流程，提供範本原始碼，以及一步一步導入的詳細步驟。各位應該都可以依照上面幾篇的說明，開始快樂的使用 Terraform 了。
而當使用 Terraform 的規模越來越大，管理的資料越來越多時，開始會出現一些問題，例如重複的 terraform code 越來越多，協同工作 review 不太容易，state 的內容管理與鎖管理，等等。這些問題可以透過一些工作流程的改進，或是導入新的小工具，來改善工作效率。
接下來筆者推薦幾個心得與工具，希望能提升使用 Terraform 的效率與產值
以下幾篇文章，適合已經使用過 terraform 一點時間，有經驗的團隊，並打算更大規模導入 terraform，正在尋求改善的方向。
心得 CI/CD 全自動化 State backend 選擇 最佳實踐 https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html 工具 Terraform Atlantis Terragrunt 問題與需求 當團隊已經開始大規模使用 terraform，tf 檔案越來越多。我們為了增加程式碼的重複利用性，會使用 terraform module 將常用的 tf 檔案封裝。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-06T11:15:48+08:00"><meta property="article:modified_time" content="2020-10-06T11:15:48+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="鐵人賽2020"><meta property="article:tag" content="Iac"><meta property="article:tag" content="Aws"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Terraform Infrastructure as Code: Terragrunt"><meta name=twitter:description content="This article is part of 從零開始的 Infrastructu as Code: Terraform

Get-started examples / SOP on Github
Introducation to Terraform Iac: Speaker transcript
Presentation

Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)

上面講解 Terraform 的基本操作流程，提供範本原始碼，以及一步一步導入的詳細步驟。各位應該都可以依照上面幾篇的說明，開始快樂的使用 Terraform 了。
而當使用 Terraform 的規模越來越大，管理的資料越來越多時，開始會出現一些問題，例如重複的 terraform code 越來越多，協同工作 review 不太容易，state 的內容管理與鎖管理，等等。這些問題可以透過一些工作流程的改進，或是導入新的小工具，來改善工作效率。
接下來筆者推薦幾個心得與工具，希望能提升使用 Terraform 的效率與產值
以下幾篇文章，適合已經使用過 terraform 一點時間，有經驗的團隊，並打算更大規模導入 terraform，正在尋求改善的方向。

心得

CI/CD 全自動化
State backend 選擇
最佳實踐 https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html


工具

Terraform Atlantis
Terragrunt



問題與需求
當團隊已經開始大規模使用 terraform，tf 檔案越來越多。我們為了增加程式碼的重複利用性，會使用 terraform module 將常用的 tf 檔案封裝。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Terraform Infrastructure as Code: Terragrunt","item":"https://chechia.net/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform Infrastructure as Code: Terragrunt","name":"Terraform Infrastructure as Code: Terragrunt","description":"This article is part of 從零開始的 Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\n上面講解 Terraform 的基本操作流程，提供範本原始碼，以及一步一步導入的詳細步驟。各位應該都可以依照上面幾篇的說明，開始快樂的使用 Terraform 了。\n而當使用 Terraform 的規模越來越大，管理的資料越來越多時，開始會出現一些問題，例如重複的 terraform code 越來越多，協同工作 review 不太容易，state 的內容管理與鎖管理，等等。這些問題可以透過一些工作流程的改進，或是導入新的小工具，來改善工作效率。\n接下來筆者推薦幾個心得與工具，希望能提升使用 Terraform 的效率與產值\n以下幾篇文章，適合已經使用過 terraform 一點時間，有經驗的團隊，並打算更大規模導入 terraform，正在尋求改善的方向。\n心得 CI/CD 全自動化 State backend 選擇 最佳實踐 https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html 工具 Terraform Atlantis Terragrunt 問題與需求 當團隊已經開始大規模使用 terraform，tf 檔案越來越多。我們為了增加程式碼的重複利用性，會使用 terraform module 將常用的 tf 檔案封裝。\n","keywords":["kubernetes","terraform","鐵人賽2020","iac","aws"],"articleBody":"This article is part of 從零開始的 Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\n上面講解 Terraform 的基本操作流程，提供範本原始碼，以及一步一步導入的詳細步驟。各位應該都可以依照上面幾篇的說明，開始快樂的使用 Terraform 了。\n而當使用 Terraform 的規模越來越大，管理的資料越來越多時，開始會出現一些問題，例如重複的 terraform code 越來越多，協同工作 review 不太容易，state 的內容管理與鎖管理，等等。這些問題可以透過一些工作流程的改進，或是導入新的小工具，來改善工作效率。\n接下來筆者推薦幾個心得與工具，希望能提升使用 Terraform 的效率與產值\n以下幾篇文章，適合已經使用過 terraform 一點時間，有經驗的團隊，並打算更大規模導入 terraform，正在尋求改善的方向。\n心得 CI/CD 全自動化 State backend 選擇 最佳實踐 https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html 工具 Terraform Atlantis Terragrunt 問題與需求 當團隊已經開始大規模使用 terraform，tf 檔案越來越多。我們為了增加程式碼的重複利用性，會使用 terraform module 將常用的 tf 檔案封裝。\n隨著導入的規模越來越大，這些 module 會越來越多，而且使用這些 module 的 project 也增加 隨著管理的 infrastructure 越來越複雜，為了描述這些本來就很複雜的 infrastructure，module 不只越來越多，還會出現 module 引用其他 module，大 module 使用小 module 的 nested module 這點在複雜的 provider 中常出現，例如 使用 terraform 描述網路架構 描述複雜的 IAM \u0026 Role terraform vault-provider 管理的環境越來越多，例如 dev, staging, prod,…，每個環境都需要獨立的工作空間，造成大量重複的 tf code 使用一段時間 terraform ，很快就會發現的第一個問題是：不論怎麼從 tf 檔案中提取重複部分，做成 module，還是有很多部分的 tf code 是完全重複的，例如：\n每個 module 會定義的 variable (argument)，使用這個 module 的上層會需要提供傳入 variable 每個 module 都會需要提供 provider Terraform 的語法要求上面這些參數都明確的定義，這讓整個 module 或資料夾的描述非常清楚。但會處就是，這些描述的參數道出都是，而且不斷的重複，每個 module 或資料夾都要提供，不然在 terraform validate 時會因為應提供參數未提供，導致錯誤。雖然立意良好，但卻嚴重違反 DRY (Don’t Repeat Yourself) 的原則\nmodule 多層引用，project 引用大 module，大 module 又引用小 module 開始感覺 backend 與 provider 的 code 比其他功能 code 多了 有沒有可能用其他工具，避免這些重複的參數，backend，provider 等等？\nTerragrunt 推薦有大量使用的團隊，直接使用 Terragrunt 這款工具。\n他是一層 terraform 的 wrapper\ni.e. 執行 terraform plan -\u003e terragrunt plan terragrunt 會先解析，產生重複的 code，然後再執行 terraform 編輯時只要寫一次，terragrunt 代為在其他地方產生重複的 code 產生的 code 會被隱藏與 cache Terragrunt 有許多功能，例如\n處理 Backend，provider，與其他不斷重複的 tf code 處理多環境下重複的 tf …完整功能請見官方文件 導入 Terragrunt 可以避免重複代碼，降低維護成本，提升生產效率\n使用情境 上述說明可能不太清楚，我們實際看範例，以前幾篇我們使用的範例 repository 為例子，把 gcp 的資料夾目錄應該長這樣：\n可以很清楚見到底下幾個東西不斷重複 由於 my-new-project, gke-playground, national-team-5g 三個專案是獨立的專案，各自可以獨立運行。但其實同屬於同公司的專案，可能許多內容都是重複的。\ntree gcp gcp ├── README.md ├── Makefile ├── my-new-project/ │ ├── terraform.tf │ ├── terraform.tfvars │ ├── variable.tf │ └── provider.tf ├── gke-playground/ │ ├── terraform.tf │ ├── terraform.tfvars │ ├── variable.tf │ └── provider.tf ├── national-team-5g/ │ ├── dev │ │ ├── terraform.tf │ │ ├── terraform.tfvars │ │ ├── variable.tf │ │ └── provider.tf │ ├── stag │ │ ├── terraform.tf │ │ ├── terraform.tfvars │ │ ├── variable.tf │ │ └── provider.tf │ └── prod │ ├── terraform.tf │ ├── terraform.tfvars │ ├── variable.tf │ └── provider.tf ├── templates/ └── modules/ 可以很清楚見到底下幾個東西不斷重複\nprovider.tf 這裡描述使用的 provider，這邊只有使用 gcp provider，所以是完全一樣重複 variable.tf 是定義的參數 terraform.tfvars 是傳入的參數，也就是實際各專案各自的執行參數 national-team-5g 的專案下，又各自拆分多個執行環境，每個環境獨立，所以又有許多重複的 code 這邊的目的，是有系統化的處理這些重複的代碼\ngcp ├── terraform.tfvars # gcp 共用的參數 ├── terragrunt.hcl # gcp 共用的程式碼 ├── national-team-5g/ │ ├── terraform.tfvars # national-team-5g 共用的參數 │ ├── terragrunt.hcl # national-team-5g 共用的程式碼 │ ├── dev │ │ ├── terraform.tfvars # dev 的參數 │ │ └── terragrunt.hcl # dev 環境自己的程式碼 │ ├── staging │ │ ├── terraform.tfvars # staging 的參數 │ │ └── terragrunt.hcl # staging 環境自己的程式碼 │ └── prod │ ├── terraform.tfvars # prod 的參數 │ └── terragrunt.hcl # prod 環境自己的程式碼 差異非常多是吧，但這邊只是從資料目錄結構看，其實如果從 tf 檔案內部的程式碼看，裡面的代碼更是精簡到不行，用起來非常的爽XD\n安裝 去 release 頁面找適合的執行檔案 下載 chmod u+x terragrunt mv terragrunt /usr/local/bin/terragrunt 詳細文件請見\n範例 Terragrunt 的 DRY feature，其實內容都大同小異\n├── national-team-5g/ │ ├── dev │ │ ├── terraform.tfvars # staging 的參數 │ │ └── provider.tf │ ├── stag │ │ ├── terraform.tfvars # staging 的參數 │ │ └── provider.tf │ └── prod │ ├── terraform.tfvars # prod 的參數 │ └── provider.tf\n例如\nnational-team-5g/dev/provider.tf\nprovider \"google\" { version = \"~\u003ev3.25.0\" credentials = file(var.credential_json) project = var.project region = var.region } 改成\nnational-team-5g/dev/terragrunt.hcl\ngenerate \"provider\" { path = \"provider.tf\" if_exists = \"overwrite\" contents = \u003c","wordCount":"608","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2020-10-06T11:15:48+08:00","dateModified":"2020-10-06T11:15:48+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=categories><span>categories</span></a></li><li><a href=https://chechia.net/tags/ title=tags><span>tags</span></a></li><li><a href=https://chechia.net/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Terraform Infrastructure as Code: Terragrunt</h1><div class=post-meta><span title='2020-10-06 11:15:48 +0800 CST'>October 6, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;608 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents></nav></div></details></div><div class=post-content><p>This article is part of <a href=https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/>從零開始的 Infrastructu as Code: Terraform</a></p><ul><li><a href=https://github.com/chechiachang/terraform-playground>Get-started examples / SOP on Github</a></li><li><a href=https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/>Introducation to Terraform Iac: Speaker transcript</a></li><li><a href=https://slides.com/chechiachang/terraform-introduction/edit>Presentation</a></li></ul><p>Check my website <a href=https://chechia.net>chechia.net</a> for other blog. <a href=https://www.facebook.com/engineer.from.scratch>Follow my page to get notification</a>. Like my page if you really like it :)</p><hr><p>上面講解 Terraform 的基本操作流程，提供範本原始碼，以及一步一步導入的詳細步驟。各位應該都可以依照上面幾篇的說明，開始快樂的使用 Terraform 了。</p><p>而當使用 Terraform 的規模越來越大，管理的資料越來越多時，開始會出現一些問題，例如重複的 terraform code 越來越多，協同工作 review 不太容易，state 的內容管理與鎖管理，等等。這些問題可以透過一些工作流程的改進，或是導入新的小工具，來改善工作效率。</p><p>接下來筆者推薦幾個心得與工具，希望能提升使用 Terraform 的效率與產值</p><p>以下幾篇文章，適合已經使用過 terraform 一點時間，有經驗的團隊，並打算更大規模導入 terraform，正在尋求改善的方向。</p><ul><li>心得<ul><li>CI/CD 全自動化</li><li>State backend 選擇</li><li>最佳實踐 <a href=https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html>https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html</a></li></ul></li><li>工具<ul><li>Terraform Atlantis</li><li>Terragrunt</li></ul></li></ul><h1 id=問題與需求>問題與需求<a hidden class=anchor aria-hidden=true href=#問題與需求>#</a></h1><p>當團隊已經開始大規模使用 terraform，tf 檔案越來越多。我們為了增加程式碼的重複利用性，會使用 terraform module 將常用的 tf 檔案封裝。</p><ul><li>隨著導入的規模越來越大，這些 module 會越來越多，而且使用這些 module 的 project 也增加</li><li>隨著管理的 infrastructure 越來越複雜，為了描述這些本來就很複雜的 infrastructure，module 不只越來越多，還會出現 module 引用其他 module，大 module 使用小 module 的 nested module<ul><li>這點在複雜的 provider 中常出現，例如<ul><li>使用 terraform 描述網路架構</li><li>描述複雜的 IAM & Role</li><li>terraform vault-provider</li></ul></li></ul></li><li>管理的環境越來越多，例如 dev, staging, prod,&mldr;，每個環境都需要獨立的工作空間，造成大量重複的 tf code</li></ul><p>使用一段時間 terraform ，很快就會發現的第一個問題是：不論怎麼從 tf 檔案中提取重複部分，做成 module，還是有很多部分的 tf code 是完全重複的，例如：</p><ul><li>每個 module 會定義的 variable (argument)，使用這個 module 的上層會需要提供傳入 variable</li><li>每個 module 都會需要提供 provider</li></ul><p>Terraform 的語法要求上面這些參數都明確的定義，這讓整個 module 或資料夾的描述非常清楚。但會處就是，這些描述的參數道出都是，而且不斷的重複，每個 module 或資料夾都要提供，不然在 terraform validate 時會因為應提供參數未提供，導致錯誤。雖然立意良好，但卻嚴重違反 DRY (Don&rsquo;t Repeat Yourself) 的原則</p><ul><li>module 多層引用，project 引用大 module，大 module 又引用小 module</li><li>開始感覺 backend 與 provider 的 code 比其他功能 code 多了</li></ul><p>有沒有可能用其他工具，避免這些重複的參數，backend，provider 等等？</p><h1 id=terragrunt>Terragrunt<a hidden class=anchor aria-hidden=true href=#terragrunt>#</a></h1><p>推薦有大量使用的團隊，直接使用 <a href=https://terragrunt.gruntwork.io/>Terragrunt</a> 這款工具。</p><p>他是一層 terraform 的 wrapper</p><ul><li>i.e. 執行 terraform plan -> terragrunt plan</li><li>terragrunt 會先解析，產生重複的 code，然後再執行 terraform</li><li>編輯時只要寫一次，terragrunt 代為在其他地方產生重複的 code</li><li>產生的 code 會被隱藏與 cache</li></ul><p>Terragrunt 有許多功能，例如</p><ul><li>處理 Backend，provider，與其他不斷重複的 tf code</li><li>處理多環境下重複的 tf</li><li>&mldr;<a href=https://terragrunt.gruntwork.io/docs/>完整功能請見官方文件</a></li></ul><p>導入 Terragrunt 可以避免重複代碼，降低維護成本，提升生產效率</p><h1 id=使用情境>使用情境<a hidden class=anchor aria-hidden=true href=#使用情境>#</a></h1><p>上述說明可能不太清楚，我們實際看範例，以<a href=https://github.com/chechiachang/terraform-playground>前幾篇我們使用的範例 repository</a> 為例子，把 gcp 的資料夾目錄應該長這樣：</p><p>可以很清楚見到底下幾個東西不斷重複
由於 my-new-project, gke-playground, national-team-5g 三個專案是獨立的專案，各自可以獨立運行。但其實同屬於同公司的專案，可能許多內容都是重複的。</p><pre><code>tree gcp

gcp
├── README.md
├── Makefile
├── my-new-project/
│   ├── terraform.tf
│   ├── terraform.tfvars
│   ├── variable.tf
│   └── provider.tf
├── gke-playground/
│   ├── terraform.tf
│   ├── terraform.tfvars
│   ├── variable.tf
│   └── provider.tf
├── national-team-5g/
│   ├── dev
│   │   ├── terraform.tf
│   │   ├── terraform.tfvars
│   │   ├── variable.tf
│   │   └── provider.tf
│   ├── stag
│   │   ├── terraform.tf
│   │   ├── terraform.tfvars
│   │   ├── variable.tf
│   │   └── provider.tf
│   └── prod
│       ├── terraform.tf
│       ├── terraform.tfvars
│       ├── variable.tf
│       └── provider.tf
├── templates/
└── modules/
</code></pre><p>可以很清楚見到底下幾個東西不斷重複</p><ul><li>provider.tf 這裡描述使用的 provider，這邊只有使用 gcp provider，所以是完全一樣重複</li><li>variable.tf 是定義的參數</li><li>terraform.tfvars 是傳入的參數，也就是實際各專案各自的執行參數</li><li>national-team-5g 的專案下，又各自拆分多個執行環境，每個環境獨立，所以又有許多重複的 code</li></ul><p>這邊的目的，是有系統化的處理這些重複的代碼</p><pre><code>gcp
├── terraform.tfvars        # gcp 共用的參數
├── terragrunt.hcl          # gcp 共用的程式碼
├── national-team-5g/
│   ├── terraform.tfvars    # national-team-5g 共用的參數
│   ├── terragrunt.hcl      # national-team-5g 共用的程式碼
│   ├── dev
│   │   ├── terraform.tfvars  # dev 的參數
│   │   └── terragrunt.hcl    # dev 環境自己的程式碼
│   ├── staging
│   │   ├── terraform.tfvars  # staging 的參數
│   │   └── terragrunt.hcl    # staging 環境自己的程式碼
│   └── prod
│       ├── terraform.tfvars  # prod 的參數
│       └── terragrunt.hcl    # prod 環境自己的程式碼
</code></pre><p>差異非常多是吧，但這邊只是從資料目錄結構看，其實如果從 tf 檔案內部的程式碼看，裡面的代碼更是精簡到不行，用起來非常的爽XD</p><h1 id=安裝>安裝<a hidden class=anchor aria-hidden=true href=#安裝>#</a></h1><ul><li>去 release 頁面找適合的執行檔案</li><li>下載</li></ul><pre><code>chmod u+x terragrunt
mv terragrunt /usr/local/bin/terragrunt
</code></pre><p><a href=https://terragrunt.gruntwork.io/docs/getting-started/quick-start/>詳細文件請見</a></p><h1 id=範例>範例<a hidden class=anchor aria-hidden=true href=#範例>#</a></h1><p>Terragrunt 的 DRY feature，其實內容都大同小異</p><p>├── national-team-5g/
│   ├── dev
│   │   ├── terraform.tfvars # staging 的參數
│   │   └── provider.tf
│   ├── stag
│   │   ├── terraform.tfvars # staging 的參數
│   │   └── provider.tf
│   └── prod
│   ├── terraform.tfvars # prod 的參數
│   └── provider.tf</p><p>例如</p><p>national-team-5g/dev/provider.tf</p><pre><code>provider &quot;google&quot; {
  version = &quot;~&gt;v3.25.0&quot;
  credentials = file(var.credential_json)
  project = var.project
  region  = var.region
}
</code></pre><p>改成</p><p>national-team-5g/dev/terragrunt.hcl</p><pre><code>generate &quot;provider&quot; {
  path      = &quot;provider.tf&quot;
  if_exists = &quot;overwrite&quot;
  contents = &lt;&lt;EOF
provider &quot;google&quot; {
  version = &quot;~&gt;v3.25.0&quot;
  credentials = file(var.credential_json)
  project = var.project
  region  = var.region
}
EOF
}
</code></pre><p>執行</p><pre><code>cd national-team-5g/dev
terragrunt plan
</code></pre><p>關於參數</p><ul><li>var.region 是本地參數，可以依據 dev/staging/prod 參數各自設定</li><li>var.project 這個是整個 national-team-5g 都共用的參數，可以進一步提高到更上層<ul><li>i.g. 放在 national-team-5g/terraform.tfvars 檔案裡面，透過 terragrunt.hcl 傳遞。</li></ul></li></ul><h1 id=functions>Functions<a hidden class=anchor aria-hidden=true href=#functions>#</a></h1><p>tf 檔案，在許多 block 中禁止使用 variable，這層限制有其考量，但是缺點是造成許多 hard coded 的程式碼。</p><p>Terragrunt 產生的程式碼，由於是在 terragrunt 執行後，terraform 執行前，因次沒有這層限制，可以做許多事情，例如 code generate 以及 function 運算，terragrunt 提供許多內建 function，這邊只介紹常用幾個。</p><ul><li><a href>find_in_parent_folder()</a></li><li><a href>path_relative_to_include()</a></li></ul><p>範例兩個檔案</p><p>project/dev/terraform.hcl</p><pre><code>include {
  path = find_in_parent_folders()
}
</code></pre><p>project/terraform.hcl</p><pre><code>env = path_relative_to_include()
</code></pre><p>最後 parse 後的結果</p><p>project/dev/terraform.hcl</p><pre><code>env = &quot;dev&quot;
</code></pre><p>做了兩件事</p><ul><li>要求 project/dev 去上層尋找 terraform.hcl，並且引入其中的設定 (env="")<ul><li>子專案可以 include 母資料夾的程式碼</li></ul></li><li>匯入上層 project 時，寫入相對的路徑 (dev)，並且帶入 (env=&ldquo;dev&rdquo;)<ul><li>母專案可以為各個子目錄配置相對路徑</li></ul></li></ul><p><a href=https://terragrunt.gruntwork.io/docs/reference/built-in-functions/>其他內建 function 請見官方文件</a></p><h1 id=小結>小結<a hidden class=anchor aria-hidden=true href=#小結>#</a></h1><p>Terragrunt 可以精簡程式碼，大福提升生產效率，然而在還不熟悉 terraform 核心功能之前，不建議過早導入，會導致多餘的學習成本。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/kubernetes/>Kubernetes</a></li><li><a href=https://chechia.net/tags/terraform/>Terraform</a></li><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2020/>鐵人賽2020</a></li><li><a href=https://chechia.net/tags/iac/>Iac</a></li><li><a href=https://chechia.net/tags/aws/>Aws</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2020-10-07-terraform-infrastructure-as-code-atlantis/><span class=title>« Prev</span><br><span>Terraform Infrastructure as Code: Atlantis</span>
</a><a class=next href=https://chechia.net/posts/2020-10-05-terraform-infrastructure-as-code-recommended-practices/><span class=title>Next »</span><br><span>Terraform Infrastructure as Code: Recommended Practices</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on x" href="https://x.com/intent/tweet/?text=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f&amp;hashtags=kubernetes%2cterraform%2c%e9%90%b5%e4%ba%ba%e8%b3%bd2020%2ciac%2caws"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f&amp;title=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt&amp;summary=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f&title=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on whatsapp" href="https://api.whatsapp.com/send?text=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt%20-%20https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on telegram" href="https://telegram.me/share/url?text=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Terraform Infrastructure as Code: Terragrunt on ycombinator" href="https://news.ycombinator.com/submitlink?t=Terraform%20Infrastructure%20as%20Code%3a%20Terragrunt&u=https%3a%2f%2fchechia.net%2fposts%2f2020-10-06-terraform-infrastructure-as-code-terragrunt%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>