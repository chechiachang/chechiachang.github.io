[{"content":"ğŸ“… æ´»å‹•æ™‚é–“ï¼š2025-10-22T (å¾…å®š) ğŸ”— æ´»å‹•é€£çµ ğŸ“˜ è¯ç¹«æˆ‘ Facebook ğŸ“‘ æŠ•å½±ç‰‡ Workshop Workshop: Get started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s Components\nOutline K8sGPT æ˜¯ä¸€å€‹çµåˆ AI çš„ Kubernetes å¢é›†è¨ºæ–·èˆ‡è‡ªå‹•åŒ–æ’éŒ¯å·¥å…·ï¼Œèƒ½è‡ªå‹•æƒæå¢é›†ç‹€æ…‹ã€è¾¨è­˜ç•°å¸¸ä¸¦ç”¨è‡ªç„¶èªè¨€è§£é‡‹å•é¡Œï¼Œæä¾›å¯åŸ·è¡Œçš„ä¿®å¾©å»ºè­°ï¼Œç”šè‡³æ”¯æ´è‡ªå‹•ä¿®å¾©ã€‚K8sGPT è®“ä½¿ç”¨è€…ç”¨æ›´ä½é–€æª»æŒæ¡å¢é›†å¥åº·ç‹€æ³ï¼ŒåŠ é€Ÿå•é¡Œå®šä½èˆ‡æ’é™¤ï¼Œæ˜¯ DevOps èˆ‡ SRE åœ˜éšŠæå‡ç‡Ÿé‹æ•ˆç‡çš„å¯¦ç”¨å·¥å…·ã€‚\nåœ¨æ’æŸ¥å•é¡Œæ™‚ï¼Œæ¯”èµ·äººé¡å·¥ç¨‹å¸«ï¼ŒK8sGPT ç¼ºä¹å° workload æ¶æ§‹çš„æ·±å…¥äº†è§£ï¼Œä¹Ÿç„¡æ³•å­˜å–å…§éƒ¨æ¶æ§‹è¨­è¨ˆæ–‡ä»¶ï¼Œæˆ–æ˜¯ Runbook èˆ‡ SOPã€‚é€™é™åˆ¶äº†å…¶è¨ºæ–·èƒ½åŠ›ä¸¦å¯èƒ½å› ç‚ºå¹»è¦ºï¼ˆhallucinationï¼‰è€Œæä¾›ä¸æ­£ç¢ºçš„å»ºè­°ã€‚K8sGPT ä¸»è¦ä¾è³´ Kubernetes API èˆ‡å¢é›†ç‹€æ…‹è³‡è¨Šä¾†é€²è¡Œè¨ºæ–·ï¼Œä½†é€™äº›è³‡è¨Šä¸¦ä¸è¶³ä»¥æ¶µè“‹æ‰€æœ‰å¯èƒ½çš„å•é¡Œæƒ…å¢ƒã€‚\næœ¬æ¬¡æ¼”è¬›å±•ç¾ä¸€å€‹ä½¿ç”¨æ¡ˆä¾‹ï¼Œå˜—è©¦é€é RAGï¼ˆRetrieval-Augmented Generation æª¢ç´¢å¢å¼·ç”Ÿæˆï¼‰æŠ€è¡“ä¾†å¢å¼·å…¶è¨ºæ–·èƒ½åŠ›ï¼Œå±•ç¾ç›®å‰åŸºæ–¼å¤§èªè¨€æ¨¡å‹çš„è§£æ±ºæ–¹æ¡ˆï¼Œé¢å° Kubernetes å¢é›†å•é¡Œæ™‚çš„å„ªå‹¢èˆ‡æŒ‘æˆ°ã€‚\nåƒè€ƒè³‡æ–™\nhttps://k8sgpt.ai/ KubeCon Europe 2025/04/02 Superpowers for Humans of Kubernetes: How K8sGPT Is Transforming Enter\u0026hellip; Alex Jones \u0026amp; Anais Urlichs Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n","permalink":"https://chechia.net/posts/2025-10-23-k8s-summit/","summary":"\u003ch3 id=\"-æ´»å‹•æ™‚é–“2025-10-22t-å¾…å®š\"\u003eğŸ“… æ´»å‹•æ™‚é–“ï¼š2025-10-22T (å¾…å®š)\u003c/h3\u003e\n\u003ch3 id=\"-æ´»å‹•é€£çµ\"\u003eğŸ”— \u003ca href=\"https://k8s.ithome.com.tw/2024/workshop-page/3259\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-è¯ç¹«æˆ‘-facebook\"\u003eğŸ“˜ è¯ç¹«æˆ‘ \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-æŠ•å½±ç‰‡\"\u003eğŸ“‘ æŠ•å½±ç‰‡\u003c/h3\u003e\n\u003chr\u003e\n\u003ch2 id=\"workshop\"\u003eWorkshop\u003c/h2\u003e\n\u003cp\u003eWorkshop: Get started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s Components\u003c/p\u003e\n\u003ch3 id=\"outline\"\u003eOutline\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eK8sGPT\u003c/strong\u003e æ˜¯ä¸€å€‹çµåˆ AI çš„ Kubernetes å¢é›†è¨ºæ–·èˆ‡è‡ªå‹•åŒ–æ’éŒ¯å·¥å…·ï¼Œèƒ½è‡ªå‹•æƒæå¢é›†ç‹€æ…‹ã€è¾¨è­˜ç•°å¸¸ä¸¦ç”¨è‡ªç„¶èªè¨€è§£é‡‹å•é¡Œï¼Œæä¾›å¯åŸ·è¡Œçš„ä¿®å¾©å»ºè­°ï¼Œç”šè‡³æ”¯æ´è‡ªå‹•ä¿®å¾©ã€‚K8sGPT è®“ä½¿ç”¨è€…ç”¨æ›´ä½é–€æª»æŒæ¡å¢é›†å¥åº·ç‹€æ³ï¼ŒåŠ é€Ÿå•é¡Œå®šä½èˆ‡æ’é™¤ï¼Œæ˜¯ DevOps èˆ‡ SRE åœ˜éšŠæå‡ç‡Ÿé‹æ•ˆç‡çš„å¯¦ç”¨å·¥å…·ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨æ’æŸ¥å•é¡Œæ™‚ï¼Œæ¯”èµ·äººé¡å·¥ç¨‹å¸«ï¼ŒK8sGPT ç¼ºä¹å° workload æ¶æ§‹çš„æ·±å…¥äº†è§£ï¼Œä¹Ÿç„¡æ³•å­˜å–å…§éƒ¨æ¶æ§‹è¨­è¨ˆæ–‡ä»¶ï¼Œæˆ–æ˜¯ Runbook èˆ‡ SOPã€‚é€™é™åˆ¶äº†å…¶è¨ºæ–·èƒ½åŠ›ä¸¦å¯èƒ½å› ç‚ºå¹»è¦ºï¼ˆhallucinationï¼‰è€Œæä¾›ä¸æ­£ç¢ºçš„å»ºè­°ã€‚K8sGPT ä¸»è¦ä¾è³´ Kubernetes API èˆ‡å¢é›†ç‹€æ…‹è³‡è¨Šä¾†é€²è¡Œè¨ºæ–·ï¼Œä½†é€™äº›è³‡è¨Šä¸¦ä¸è¶³ä»¥æ¶µè“‹æ‰€æœ‰å¯èƒ½çš„å•é¡Œæƒ…å¢ƒã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›å±•ç¾ä¸€å€‹ä½¿ç”¨æ¡ˆä¾‹ï¼Œå˜—è©¦é€é RAGï¼ˆRetrieval-Augmented Generation æª¢ç´¢å¢å¼·ç”Ÿæˆï¼‰æŠ€è¡“ä¾†å¢å¼·å…¶è¨ºæ–·èƒ½åŠ›ï¼Œå±•ç¾ç›®å‰åŸºæ–¼å¤§èªè¨€æ¨¡å‹çš„è§£æ±ºæ–¹æ¡ˆï¼Œé¢å° Kubernetes å¢é›†å•é¡Œæ™‚çš„å„ªå‹¢èˆ‡æŒ‘æˆ°ã€‚\u003c/p\u003e\n\u003cp\u003eåƒè€ƒè³‡æ–™\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://k8sgpt.ai/\"\u003ehttps://k8sgpt.ai/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.youtube.com/watch?v=EXtCejkOJB0\"\u003eKubeCon Europe 2025/04/02 Superpowers for Humans of Kubernetes: How K8sGPT Is Transforming Enter\u0026hellip; Alex Jones \u0026amp; Anais Urlichs\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"author\"\u003eAuthor\u003c/h2\u003e\n\u003cp\u003eChe-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\u003c/p\u003e","title":"K8s Summit 2025: RAG + k8sGPT æª¢ç´¢å¢å¼·ç”Ÿæˆèˆ‡ K8sGPT"},{"content":"ğŸ“… æ´»å‹•æ™‚é–“ï¼š2025-10-22T (å¾…å®š) ğŸ”— æ´»å‹•é€£çµ ğŸ“˜ è¯ç¹«æˆ‘ Facebook ğŸ“‘ æŠ•å½±ç‰‡ â—Etcd workshop è¡Œå‰æº–å‚™â— æœ¬æ¬¡å·¥ä½œåŠæœ‰è¡Œå‰æº–å‚™ï¼Œè«‹åœ¨æ´»å‹•æ—¥å‰å®Œæˆä¸Šæ–¹æŠ•å½±ç‰‡ä¸­çš„è¡Œå‰æº–å‚™ã€‚\nå·¥ä½œåŠå ´æ¬¡ å¾…å®š\nWorkshop Workshop: Get started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s Components\nOutline Etcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ Etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ Etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚è®“åƒèˆ‡è€…é€éæœ¬æ¬¡å·¥ä½œåŠï¼Œå¯ä»¥æœ‰æ“ä½œ k8s control plane çš„ç¶“é©—ï¼Œæ›´äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œï¼Œä»¥åŠäº†è§£ Kubernetes çš„åŸºæœ¬æ¶æ§‹ã€‚\né è¨ˆå…§å®¹ï¼š\ndocker å•Ÿå‹• etcd etcdctl å­˜å– etcd docker å•Ÿå‹• etcd cluster docker å•Ÿå‹• k8s control plane kubectl å­˜å– k8s control plane ç¶­é‹ k8s æ‰€éœ€çš„ etcd operation ï¼ˆè¦åŠƒä¸­ï¼‰æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\næœ¬æ¬¡å·¥ä½œåŠæœ‰è¡Œå‰æº–å‚™ï¼Œè«‹åœ¨æ´»å‹•æ—¥å‰å®Œæˆã€‚ https://chechia.net/posts/2025-10-22-k8s-summit/\nå¿…å‚™çŸ¥è­˜ï¼šLinux æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼ŒDocker æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼Œæœƒä½¿ç”¨ SSH é€£ç·š / Bash / dockerã€‚\nåƒè€ƒè³‡æ–™\nEtcd å®˜æ–¹æ–‡ä»¶ v3.6 Etcd Playground Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n","permalink":"https://chechia.net/posts/2025-10-22-k8s-summit/","summary":"\u003ch3 id=\"-æ´»å‹•æ™‚é–“2025-10-22t-å¾…å®š\"\u003eğŸ“… æ´»å‹•æ™‚é–“ï¼š2025-10-22T (å¾…å®š)\u003c/h3\u003e\n\u003ch3 id=\"-æ´»å‹•é€£çµ\"\u003eğŸ”— \u003ca href=\"https://k8s.ithome.com.tw/2024/workshop-page/3259\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-è¯ç¹«æˆ‘-facebook\"\u003eğŸ“˜ è¯ç¹«æˆ‘ \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-æŠ•å½±ç‰‡\"\u003eğŸ“‘ \u003ca href=\"/slides/2025-10-22-etcd-workshop/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/h3\u003e\n\u003chr\u003e\n\u003ch3 id=\"etcd-workshop-è¡Œå‰æº–å‚™\"\u003eâ—Etcd workshop è¡Œå‰æº–å‚™â—\u003c/h3\u003e\n\u003cp\u003eæœ¬æ¬¡å·¥ä½œåŠæœ‰è¡Œå‰æº–å‚™ï¼Œè«‹åœ¨æ´»å‹•æ—¥å‰å®Œæˆä¸Šæ–¹æŠ•å½±ç‰‡ä¸­çš„è¡Œå‰æº–å‚™ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"å·¥ä½œåŠå ´æ¬¡\"\u003eå·¥ä½œåŠå ´æ¬¡\u003c/h2\u003e\n\u003cp\u003eå¾…å®š\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"workshop\"\u003eWorkshop\u003c/h2\u003e\n\u003cp\u003eWorkshop: Get started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s Components\u003c/p\u003e\n\u003ch3 id=\"outline\"\u003eOutline\u003c/h3\u003e\n\u003cp\u003eEtcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ Etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ Etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚è®“åƒèˆ‡è€…é€éæœ¬æ¬¡å·¥ä½œåŠï¼Œå¯ä»¥æœ‰æ“ä½œ k8s control plane çš„ç¶“é©—ï¼Œæ›´äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œï¼Œä»¥åŠäº†è§£ Kubernetes çš„åŸºæœ¬æ¶æ§‹ã€‚\u003c/p\u003e\n\u003cp\u003eé è¨ˆå…§å®¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003edocker å•Ÿå‹• etcd\u003c/li\u003e\n\u003cli\u003eetcdctl å­˜å– etcd\u003c/li\u003e\n\u003cli\u003edocker å•Ÿå‹• etcd cluster\u003c/li\u003e\n\u003cli\u003edocker å•Ÿå‹• k8s control plane\u003c/li\u003e\n\u003cli\u003ekubectl å­˜å– k8s control plane\u003c/li\u003e\n\u003cli\u003eç¶­é‹ k8s æ‰€éœ€çš„ etcd operation\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eï¼ˆè¦åŠƒä¸­ï¼‰æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\u003c/p\u003e","title":"K8s Summit 2025: Workshop: Get started with Etcd \u0026 Kubernetes"},{"content":"ğŸ“… æ´»å‹•æ™‚é–“ï¼š2025-08-09T12:45:00Z ğŸ”— æ´»å‹•é€£çµ ğŸ“˜ è¯ç¹«æˆ‘ Facebook ğŸ“‘ æŠ•å½±ç‰‡WIP Info Model Context Protocolï¼ˆMCPï¼‰æ˜¯ä¸€é …ç”± Anthropic æ¨å‡ºçš„é–‹æ”¾æ¨™æº–ï¼Œæ—¨åœ¨ç‚ºå¤§å‹èªè¨€æ¨¡å‹ï¼ˆLLMsï¼‰æä¾›ä¸€ç¨®æ¨™æº–åŒ–çš„æ–¹å¼ï¼Œä»¥é€£æ¥å’Œæ“ä½œå„ç¨®è³‡æ–™ä¾†æºï¼ˆå¦‚æœ¬åœ°æª”æ¡ˆã€è³‡æ–™åº«ï¼‰å’Œå·¥å…·ï¼ˆå¦‚ GitHubã€Google Mapsï¼‰ã€‚MCP çš„ç›®æ¨™æ˜¯ç°¡åŒ– AI æ‡‰ç”¨èˆ‡å¤–éƒ¨è³‡æºçš„æ•´åˆéç¨‹ï¼Œé¡ä¼¼æ–¼ USB-C ç‚ºå¯¦é«”è¨­å‚™æä¾›é€šç”¨é€£æ¥ä»‹é¢ã€‚\néš¨è‘— AI æŠ€è¡“çš„å¿«é€Ÿç™¼å±•ï¼ŒAI åŠ©æ‰‹éœ€è¦èˆ‡å„ç¨®è³‡æ–™ä¾†æºå’Œå·¥å…·é€²è¡Œäº’å‹•ï¼Œä»¥æä¾›æ›´è±å¯Œå’Œå€‹æ€§åŒ–çš„æœå‹™ã€‚Model Context Protocolï¼ˆMCPï¼‰ä½œç‚ºä¸€ç¨®é–‹æ”¾æ¨™æº–ï¼Œç‚º AI æ‡‰ç”¨æä¾›äº†ä¸€ç¨®çµ±ä¸€ä¸”å®‰å…¨çš„æ–¹å¼ï¼Œé€£æ¥åˆ°ä¸åŒçš„è³‡æ–™ä¾†æºå’Œå·¥å…·ã€‚\næœ¬å ´æ¼”è¬›å°‡ä»‹ç´¹ MCP çš„æ¶æ§‹ã€è¨­è¨ˆåŸå‰‡èˆ‡å¯¦ä½œç¯„ä¾‹ï¼Œä¸¦å±•ç¤ºå¦‚ä½•ä½¿ç”¨é–‹æº mcp-server å¿«é€Ÿæ‰“é€ ä¸€å¥—å…·å‚™ä¸Šä¸‹æ–‡å…±äº«ã€å·¥å…·èª¿ç”¨èˆ‡å¤šæ¨¡å‹å”ä½œèƒ½åŠ›çš„ Agent Serverã€‚æœ€å¾Œå°‡é€éå¯¦æ©Ÿ Demo å±•ç¾ MCP åœ¨çœŸå¯¦ AI Workflow ä¸­çš„æ‡‰ç”¨æ½›åŠ›ã€‚\næ¼”è¬›å¤§ç¶±\nå•é¡ŒèƒŒæ™¯èˆ‡å‹•æ©Ÿ AI åŠ©æ‰‹åœ¨å¯¦éš›æ‡‰ç”¨ä¸­é¢è‡¨çš„æŒ‘æˆ°ï¼šéœ€è¦è¨ªå•å¤šç¨®è³‡æ–™ä¾†æºå’Œå·¥å…·ï¼Œç¾æœ‰æ•´åˆæ–¹å¼çš„é™åˆ¶ï¼šé–‹ç™¼æˆæœ¬é«˜ã€ç¶­è­·å›°é›£ èªè­˜ Model Context Protocolï¼ˆMCPï¼‰MCP çš„å®šç¾©èˆ‡ç›®æ¨™ MCP çš„æ ¸å¿ƒæ¶æ§‹ï¼šä¸»æ©Ÿã€å®¢æˆ¶ç«¯ã€ä¼ºæœå™¨ MCP å¦‚ä½•ç°¡åŒ– AI æ‡‰ç”¨èˆ‡å¤–éƒ¨è³‡æºçš„æ•´åˆ MCP çš„å·¥ä½œåŸç† MCP å¦‚ä½•å»ºç«‹ AI æ‡‰ç”¨èˆ‡è³‡æ–™ä¾†æº/å·¥å…·ä¹‹é–“çš„æ©‹æ¨‘ MCP çš„æ¨¡çµ„åŒ–è¨­è¨ˆå¦‚ä½•æ”¯æŒåŠŸèƒ½æ“´å±• ä½¿ç”¨ mcp-server å¿«é€Ÿå»ºç«‹å¤šå·¥ Agent Server mcp-server çš„åŠŸèƒ½èˆ‡æ¶æ§‹ å¦‚ä½•ä½¿ç”¨ mcp-server æ•´åˆå¤šå€‹ Agent å’Œå·¥å…· å¯¦ä½œç¤ºç¯„ï¼šå»ºç«‹ä¸€å€‹èƒ½å¤ å”ä½œå®Œæˆä»»å‹™çš„å¤š Agent ç³»çµ± å¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹èˆ‡æœªä¾†å±•æœ› MCP åœ¨ä¼æ¥­åŠ©æ‰‹ã€é–‹ç™¼å·¥å…·ç­‰é ˜åŸŸçš„æ‡‰ç”¨ MCP çš„å®‰å…¨æ€§èˆ‡æ“´å±•æ€§ æœªä¾† AI ç³»çµ±èˆ‡ MCP çš„æ•´åˆè¶¨å‹¢ Target group Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\nReferences https://arxiv.org/pdf/2504.16736v2 ","permalink":"https://chechia.net/posts/2025-08-09-coscup/","summary":"\u003ch3 id=\"-æ´»å‹•æ™‚é–“2025-08-09t124500z\"\u003eğŸ“… æ´»å‹•æ™‚é–“ï¼š2025-08-09T12:45:00Z\u003c/h3\u003e\n\u003ch3 id=\"-æ´»å‹•é€£çµ\"\u003eğŸ”— \u003ca href=\"https://coscup.org/2025/\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-è¯ç¹«æˆ‘-facebook\"\u003eğŸ“˜ è¯ç¹«æˆ‘ \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-æŠ•å½±ç‰‡wip\"\u003eğŸ“‘ æŠ•å½±ç‰‡WIP\u003c/h3\u003e\n\u003chr\u003e\n\u003ch1 id=\"info\"\u003eInfo\u003c/h1\u003e\n\u003cp\u003eModel Context Protocolï¼ˆMCPï¼‰æ˜¯ä¸€é …ç”± Anthropic æ¨å‡ºçš„é–‹æ”¾æ¨™æº–ï¼Œæ—¨åœ¨ç‚ºå¤§å‹èªè¨€æ¨¡å‹ï¼ˆLLMsï¼‰æä¾›ä¸€ç¨®æ¨™æº–åŒ–çš„æ–¹å¼ï¼Œä»¥é€£æ¥å’Œæ“ä½œå„ç¨®è³‡æ–™ä¾†æºï¼ˆå¦‚æœ¬åœ°æª”æ¡ˆã€è³‡æ–™åº«ï¼‰å’Œå·¥å…·ï¼ˆå¦‚ GitHubã€Google Mapsï¼‰ã€‚MCP çš„ç›®æ¨™æ˜¯ç°¡åŒ– AI æ‡‰ç”¨èˆ‡å¤–éƒ¨è³‡æºçš„æ•´åˆéç¨‹ï¼Œé¡ä¼¼æ–¼ USB-C ç‚ºå¯¦é«”è¨­å‚™æä¾›é€šç”¨é€£æ¥ä»‹é¢ã€‚\u003c/p\u003e\n\u003cp\u003eéš¨è‘— AI æŠ€è¡“çš„å¿«é€Ÿç™¼å±•ï¼ŒAI åŠ©æ‰‹éœ€è¦èˆ‡å„ç¨®è³‡æ–™ä¾†æºå’Œå·¥å…·é€²è¡Œäº’å‹•ï¼Œä»¥æä¾›æ›´è±å¯Œå’Œå€‹æ€§åŒ–çš„æœå‹™ã€‚Model Context Protocolï¼ˆMCPï¼‰ä½œç‚ºä¸€ç¨®é–‹æ”¾æ¨™æº–ï¼Œç‚º AI æ‡‰ç”¨æä¾›äº†ä¸€ç¨®çµ±ä¸€ä¸”å®‰å…¨çš„æ–¹å¼ï¼Œé€£æ¥åˆ°ä¸åŒçš„è³‡æ–™ä¾†æºå’Œå·¥å…·ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬å ´æ¼”è¬›å°‡ä»‹ç´¹ MCP çš„æ¶æ§‹ã€è¨­è¨ˆåŸå‰‡èˆ‡å¯¦ä½œç¯„ä¾‹ï¼Œä¸¦å±•ç¤ºå¦‚ä½•ä½¿ç”¨é–‹æº mcp-server å¿«é€Ÿæ‰“é€ ä¸€å¥—å…·å‚™ä¸Šä¸‹æ–‡å…±äº«ã€å·¥å…·èª¿ç”¨èˆ‡å¤šæ¨¡å‹å”ä½œèƒ½åŠ›çš„ Agent Serverã€‚æœ€å¾Œå°‡é€éå¯¦æ©Ÿ Demo å±•ç¾ MCP åœ¨çœŸå¯¦ AI Workflow ä¸­çš„æ‡‰ç”¨æ½›åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eæ¼”è¬›å¤§ç¶±\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå•é¡ŒèƒŒæ™¯èˆ‡å‹•æ©Ÿ\n\u003cul\u003e\n\u003cli\u003eAI åŠ©æ‰‹åœ¨å¯¦éš›æ‡‰ç”¨ä¸­é¢è‡¨çš„æŒ‘æˆ°ï¼šéœ€è¦è¨ªå•å¤šç¨®è³‡æ–™ä¾†æºå’Œå·¥å…·ï¼Œç¾æœ‰æ•´åˆæ–¹å¼çš„é™åˆ¶ï¼šé–‹ç™¼æˆæœ¬é«˜ã€ç¶­è­·å›°é›£\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eèªè­˜ Model Context Protocolï¼ˆMCPï¼‰MCP çš„å®šç¾©èˆ‡ç›®æ¨™\n\u003cul\u003e\n\u003cli\u003eMCP çš„æ ¸å¿ƒæ¶æ§‹ï¼šä¸»æ©Ÿã€å®¢æˆ¶ç«¯ã€ä¼ºæœå™¨\u003c/li\u003e\n\u003cli\u003eMCP å¦‚ä½•ç°¡åŒ– AI æ‡‰ç”¨èˆ‡å¤–éƒ¨è³‡æºçš„æ•´åˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eMCP çš„å·¥ä½œåŸç†\n\u003cul\u003e\n\u003cli\u003eMCP å¦‚ä½•å»ºç«‹ AI æ‡‰ç”¨èˆ‡è³‡æ–™ä¾†æº/å·¥å…·ä¹‹é–“çš„æ©‹æ¨‘\u003c/li\u003e\n\u003cli\u003eMCP çš„æ¨¡çµ„åŒ–è¨­è¨ˆå¦‚ä½•æ”¯æŒåŠŸèƒ½æ“´å±•\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨ mcp-server å¿«é€Ÿå»ºç«‹å¤šå·¥ Agent Server\n\u003cul\u003e\n\u003cli\u003emcp-server çš„åŠŸèƒ½èˆ‡æ¶æ§‹\u003c/li\u003e\n\u003cli\u003eå¦‚ä½•ä½¿ç”¨ mcp-server æ•´åˆå¤šå€‹ Agent å’Œå·¥å…·\u003c/li\u003e\n\u003cli\u003eå¯¦ä½œç¤ºç¯„ï¼šå»ºç«‹ä¸€å€‹èƒ½å¤ å”ä½œå®Œæˆä»»å‹™çš„å¤š Agent ç³»çµ±\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹èˆ‡æœªä¾†å±•æœ›\n\u003cul\u003e\n\u003cli\u003eMCP åœ¨ä¼æ¥­åŠ©æ‰‹ã€é–‹ç™¼å·¥å…·ç­‰é ˜åŸŸçš„æ‡‰ç”¨\u003c/li\u003e\n\u003cli\u003eMCP çš„å®‰å…¨æ€§èˆ‡æ“´å±•æ€§\u003c/li\u003e\n\u003cli\u003eæœªä¾† AI ç³»çµ±èˆ‡ MCP çš„æ•´åˆè¶¨å‹¢\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"target-group\"\u003eTarget group\u003c/h1\u003e\n\u003ch1 id=\"author\"\u003eAuthor\u003c/h1\u003e\n\u003cp\u003eChe-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\u003c/p\u003e","title":"COSCUP: å¾ Model Context Protocol åˆæ¢ AI Agent Protocolï¼šå¿«é€Ÿæ‰“é€ å¤šå·¥ Agent Server"},{"content":"ğŸ“… æ´»å‹•æ™‚é–“: 2025-07-03T12:45:00Z ğŸ”— æ´»å‹•é€£çµ ğŸ“˜ è¯ç¹«æˆ‘ Facebook ğŸ“‘ æŠ•å½±ç‰‡ WIP Info é–‹ç™¼åœ˜éšŠéœ€è¦å°‡ç¶“é©—èˆ‡çŸ¥è­˜ï¼Œé€éæ–‡ä»¶åŒ–çš„æ–¹å¼ä¿å­˜ä¸‹ä¾†ï¼Œä»¥ä¾¿æœªä¾†æŸ¥è©¢èˆ‡å­¸ç¿’ã€‚ç„¶è€Œï¼Œä¼æ¥­å…§éƒ¨æ–‡ä»¶å¾€å¾€åˆ†æ•£æ–¼ Confluenceã€Google Driveã€Notion ç­‰å¹³å°ï¼Œå‚³çµ±é—œéµå­—æœå°‹é›£ä»¥å¿«é€Ÿç²å–æº–ç¢ºè³‡è¨Šï¼Œå°è‡´æºé€šæˆæœ¬é«˜ã€é–‹ç™¼æµç¨‹å—é˜»ã€‚åˆæˆ–æ˜¯ï¼Œç•¶é–‹ç™¼åœ˜éšŠéœ€è¦æŸ¥è©¢ç‰¹å®šçŸ¥è­˜æ™‚ï¼Œå¾€å¾€éœ€è¦é€é Slackã€Email ç­‰æ–¹å¼è©¢å•åŒäº‹ï¼Œé€™æ¨£çš„æºé€šæˆæœ¬ä¸åƒ…æµªè²»æ™‚é–“ï¼Œä¹Ÿå®¹æ˜“é€ æˆè³‡è¨Šä¸å°ç¨±ã€‚\næœ¬æ¼”è¬›å°‡ä»‹ç´¹å¦‚ä½•é‹ç”¨ RAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€è¡“ï¼Œçµåˆ OpenAI åŠå‘é‡æ•¸æ“šåº«ï¼Œå°‡ä¼æ¥­å…§éƒ¨æ–‡æª”è½‰ç‚ºæ™ºèƒ½çŸ¥è­˜åº«ã€‚\næˆ‘å€‘å°‡æ¢è¨æ–‡ä»¶è§£æã€åµŒå…¥ç´¢å¼•ã€AI å•ç­”ç³»çµ±çš„æŠ€è¡“æ¶æ§‹èˆ‡å¯¦ä½œï¼Œå¹«åŠ©é–‹ç™¼åœ˜éšŠæ§‹å»ºé«˜æ•ˆ AI åŠ©æ‰‹ï¼Œç¯€çœæºé€šæˆæœ¬ï¼ŒåŠ é€Ÿé–‹ç™¼æµç¨‹ï¼Œæå‡æ±ºç­–èˆ‡å•é¡Œè§£æ±ºèƒ½åŠ›ã€‚\nå¤§ç¶±ï¼š\nç‚ºä»€éº¼ä¼æ¥­çŸ¥è­˜ç®¡ç†é›£ï¼Ÿ æ–‡ä»¶åˆ†æ•£ï¼ˆConfluenceã€Google Driveã€Notionã€SharePointï¼‰ æœç´¢é«”é©—ä¸ä½³ï¼Œé–‹ç™¼è€…æ‰¾ä¸åˆ°é—œéµè³‡è¨Š çŸ¥è­˜é›£ä»¥æ²‰æ¾±ï¼Œå“¡å·¥æµå¤±å³çŸ¥è­˜æµå¤± RAG å¦‚ä½•è§£æ±ºé€™äº›å•é¡Œï¼Ÿ é€éæª¢ç´¢å¢å¼·ç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼‰æå‡ç­”æ¡ˆæº–ç¢ºæ€§ æŠŠå…§éƒ¨æ–‡ä»¶è½‰ç‚ºå¯æŸ¥è©¢çš„çŸ¥è­˜åº« è®“ AI æä¾›å…·é«”ã€æº–ç¢ºã€å³æ™‚çš„å›è¦† æŠ€è¡“æ¶æ§‹èˆ‡å¯¦ä½œæŒ‡å— æ–‡ä»¶è§£æèˆ‡åµŒå…¥ï¼ˆHTMLã€Markdownã€Confluence APIï¼‰ ä½¿ç”¨å‘é‡æ•¸æ“šåº«å¯¦ç¾é«˜æ•ˆæª¢ç´¢ OpenAI API + LangChain æ‰“é€ æ™ºèƒ½å•ç­”ç³»çµ± æ¡ˆä¾‹åˆ†äº«èˆ‡è½åœ°ç¶“é©— Target group Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n","permalink":"https://chechia.net/posts/2025-07-02-cloud-summit/","summary":"\u003ch3 id=\"-æ´»å‹•æ™‚é–“-2025-07-03t124500z\"\u003eğŸ“… æ´»å‹•æ™‚é–“: 2025-07-03T12:45:00Z\u003c/h3\u003e\n\u003ch3 id=\"-æ´»å‹•é€£çµ\"\u003eğŸ”— \u003ca href=\"https://cloudsummit.ithome.com.tw/2025/session-page/3668\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-è¯ç¹«æˆ‘-facebook\"\u003eğŸ“˜ è¯ç¹«æˆ‘ \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-æŠ•å½±ç‰‡-wip\"\u003eğŸ“‘ \u003ca href=\"/slides/2025-07-02-cloud-summit-rag/\"\u003eæŠ•å½±ç‰‡ WIP\u003c/a\u003e\u003c/h3\u003e\n\u003chr\u003e\n\u003ch2 id=\"info\"\u003eInfo\u003c/h2\u003e\n\u003cp\u003eé–‹ç™¼åœ˜éšŠéœ€è¦å°‡ç¶“é©—èˆ‡çŸ¥è­˜ï¼Œé€éæ–‡ä»¶åŒ–çš„æ–¹å¼ä¿å­˜ä¸‹ä¾†ï¼Œä»¥ä¾¿æœªä¾†æŸ¥è©¢èˆ‡å­¸ç¿’ã€‚ç„¶è€Œï¼Œä¼æ¥­å…§éƒ¨æ–‡ä»¶å¾€å¾€åˆ†æ•£æ–¼ Confluenceã€Google Driveã€Notion ç­‰å¹³å°ï¼Œå‚³çµ±é—œéµå­—æœå°‹é›£ä»¥å¿«é€Ÿç²å–æº–ç¢ºè³‡è¨Šï¼Œå°è‡´æºé€šæˆæœ¬é«˜ã€é–‹ç™¼æµç¨‹å—é˜»ã€‚åˆæˆ–æ˜¯ï¼Œç•¶é–‹ç™¼åœ˜éšŠéœ€è¦æŸ¥è©¢ç‰¹å®šçŸ¥è­˜æ™‚ï¼Œå¾€å¾€éœ€è¦é€é Slackã€Email ç­‰æ–¹å¼è©¢å•åŒäº‹ï¼Œé€™æ¨£çš„æºé€šæˆæœ¬ä¸åƒ…æµªè²»æ™‚é–“ï¼Œä¹Ÿå®¹æ˜“é€ æˆè³‡è¨Šä¸å°ç¨±ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ¼”è¬›å°‡ä»‹ç´¹å¦‚ä½•é‹ç”¨ RAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€è¡“ï¼Œçµåˆ OpenAI åŠå‘é‡æ•¸æ“šåº«ï¼Œå°‡ä¼æ¥­å…§éƒ¨æ–‡æª”è½‰ç‚ºæ™ºèƒ½çŸ¥è­˜åº«ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘å€‘å°‡æ¢è¨æ–‡ä»¶è§£æã€åµŒå…¥ç´¢å¼•ã€AI å•ç­”ç³»çµ±çš„æŠ€è¡“æ¶æ§‹èˆ‡å¯¦ä½œï¼Œå¹«åŠ©é–‹ç™¼åœ˜éšŠæ§‹å»ºé«˜æ•ˆ AI åŠ©æ‰‹ï¼Œç¯€çœæºé€šæˆæœ¬ï¼ŒåŠ é€Ÿé–‹ç™¼æµç¨‹ï¼Œæå‡æ±ºç­–èˆ‡å•é¡Œè§£æ±ºèƒ½åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå¤§ç¶±ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç‚ºä»€éº¼ä¼æ¥­çŸ¥è­˜ç®¡ç†é›£ï¼Ÿ\n\u003cul\u003e\n\u003cli\u003eæ–‡ä»¶åˆ†æ•£ï¼ˆConfluenceã€Google Driveã€Notionã€SharePointï¼‰\u003c/li\u003e\n\u003cli\u003eæœç´¢é«”é©—ä¸ä½³ï¼Œé–‹ç™¼è€…æ‰¾ä¸åˆ°é—œéµè³‡è¨Š\u003c/li\u003e\n\u003cli\u003eçŸ¥è­˜é›£ä»¥æ²‰æ¾±ï¼Œå“¡å·¥æµå¤±å³çŸ¥è­˜æµå¤±\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eRAG å¦‚ä½•è§£æ±ºé€™äº›å•é¡Œï¼Ÿ\n\u003cul\u003e\n\u003cli\u003eé€éæª¢ç´¢å¢å¼·ç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼‰æå‡ç­”æ¡ˆæº–ç¢ºæ€§\u003c/li\u003e\n\u003cli\u003eæŠŠå…§éƒ¨æ–‡ä»¶è½‰ç‚ºå¯æŸ¥è©¢çš„çŸ¥è­˜åº«\u003c/li\u003e\n\u003cli\u003eè®“ AI æä¾›å…·é«”ã€æº–ç¢ºã€å³æ™‚çš„å›è¦†\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eæŠ€è¡“æ¶æ§‹èˆ‡å¯¦ä½œæŒ‡å—\n\u003cul\u003e\n\u003cli\u003eæ–‡ä»¶è§£æèˆ‡åµŒå…¥ï¼ˆHTMLã€Markdownã€Confluence APIï¼‰\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨å‘é‡æ•¸æ“šåº«å¯¦ç¾é«˜æ•ˆæª¢ç´¢\u003c/li\u003e\n\u003cli\u003eOpenAI API + LangChain æ‰“é€ æ™ºèƒ½å•ç­”ç³»çµ±\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eæ¡ˆä¾‹åˆ†äº«èˆ‡è½åœ°ç¶“é©—\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"target-group\"\u003eTarget group\u003c/h2\u003e\n\u003ch2 id=\"author\"\u003eAuthor\u003c/h2\u003e\n\u003cp\u003eChe-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\u003c/p\u003e\n\u003cp\u003eå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\u003c/p\u003e","title":"Cloud Summit 2025: ç”¨ RAG æ‰“é€ ä¼æ¥­å¯å°è©± AI çŸ¥è­˜åº«ã€Šæœ‰å•é¡Œå•é AI å¾Œå†ä¾†å•æˆ‘ã€‹"},{"content":"ğŸ“… æ´»å‹•æ™‚é–“: 2025-06-05T12:45:00Z ğŸ”— æ´»å‹•é€£çµ ğŸ“˜ è¯ç¹«æˆ‘ Facebook ğŸ“‘ æŠ•å½±ç‰‡ RAG workshop è¡Œå‰é€šçŸ¥ æœ¬æ¬¡ workshop ä»¥ hands-on çš„æ–¹å¼é€²è¡Œï¼Œç´¯ç©æ“ä½œç¶“é©—ç‚ºä¸»ï¼Œè¬›è§£èˆ‡èªªæ˜ç‚ºè¼”ã€‚è§€å¿µå…§å®¹æœ‰æº–å‚™æ•™æï¼Œéœ€è¦åƒèˆ‡è€…è‡ªè¡Œé–±è®€ã€‚è¬›å¸«æœƒå…è²»æä¾›\nAzure OpenAI models API key (gpt-4.1, gpt-4.1-mini, text-embedding-3, text-embedding-ada-002\u0026hellip;) Azure VM ä¾›åŒå­¸é ç«¯æ“ä½œä½¿ç”¨ \u0026ndash;\u0026gt; æŠ•å½±ç‰‡èˆ‡æ•™æ \u0026lt;\u0026ndash; Workshop åŸºæœ¬éœ€æ±‚ æœ‰è‡ªå·±çš„é›»è…¦ï¼Œå¯ä»¥ä¸Šç¶² é¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ï¼Œåœ¨ docker å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ é¸é …2: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ï¼Œé ç«¯é€£ç·šè¬›å¸«æä¾›çš„ VMï¼Œåœ¨VM ä¸­å•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒ æœƒä½¿ç”¨ docker æœƒä½¿ç”¨ python èˆ‡ jupyter notebook æœƒä½¿ç”¨ chatgpt.com å”åŠ©é™¤éŒ¯ é¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ åœ¨ workshop é–‹å§‹å‰ï¼Œåœ¨è‡ªå·±çš„é›»è…¦ä¸Š\nå®‰è£ docker git clone github repository å•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒï¼Œä¸‹è¼‰ docker images é–‹å•Ÿç€è¦½å™¨ï¼Œé€£ç·šåˆ° Jupyter Notebookï¼Œtoken workshop1234! åœ¨ Jupyter Notebook ä¸­ï¼Œå®‰è£æ‰€éœ€çš„ Python å¥—ä»¶ git clone https://github.com/chechiachang/rag-workshop.git cd rag-workshop docker compose up -d docker exec -it notebook pip install pandas openai qdrant_client tqdm tenacity wget tenacity unstructured markdown ragas sacrebleu langchain_qdrant langchain-openai langchain_openai langchain_community tiktoken é¸é …2: ä½¿ç”¨é ç«¯ VM å»ºè­°ä½¿ç”¨å€‹äººé›»è…¦ï¼Œç•¢ç«Ÿå…è²» VM åé¡ç¾å ´æœ‰é™ éœ€è¦æœ‰è‡ªå·±çš„é›»è…¦ï¼Œæœ‰ç©©å®šçš„ç¶²è·¯ï¼Œå¯ä»¥é€£ç·šåˆ°é ç«¯ VM éœ€è¦è¨»å†Š tunnel å·¥å…·ï¼ˆæ²’æœ‰æ¥­é…ï¼‰ngrok ç™»å…¥ Login -\u0026gt; å·¦æ‰‹é‚Š Identity \u0026amp; Access -\u0026gt; Authtokens -\u0026gt; Add Tunnel authtoken -\u0026gt; è¨˜åœ¨å®‰å…¨çš„åœ°æ–¹ ä¹Ÿå¯ä»¥ä½¿ç”¨ pinggyï¼Œä½†å…è²»æœ‰é™æ™‚ æŠ•å½±ç‰‡èˆ‡æ•™ææœƒæ”¾åœ¨ç¶²ç«™ä¸Š https://chechia.net/zh-hant/slides/2025-06-05-devops-rag-internal-ai/\nå¦‚ä½•å­˜å– VM ä¹Ÿæœƒæ”¾åœ¨æ•¨å½±ç‰‡è£¡\nRAG workshop è¡Œå‰é€šçŸ¥å®Œï¼Œå¤§å®¶ç•¶å¤©ç¾å ´è¦‹ Info é–‹ç™¼åœ˜éšŠéœ€è¦å°‡ç¶“é©—èˆ‡çŸ¥è­˜ï¼Œé€éæ–‡ä»¶åŒ–çš„æ–¹å¼ä¿å­˜ä¸‹ä¾†ï¼Œä»¥ä¾¿æœªä¾†æŸ¥è©¢èˆ‡å­¸ç¿’ã€‚ç„¶è€Œï¼Œä¼æ¥­å…§éƒ¨æ–‡ä»¶å¾€å¾€åˆ†æ•£æ–¼ Confluenceã€Google Driveã€Notion ç­‰å¹³å°ï¼Œå‚³çµ±é—œéµå­—æœå°‹é›£ä»¥å¿«é€Ÿç²å–æº–ç¢ºè³‡è¨Šï¼Œå°è‡´æºé€šæˆæœ¬é«˜ã€é–‹ç™¼æµç¨‹å—é˜»ã€‚åˆæˆ–æ˜¯ï¼Œç•¶é–‹ç™¼åœ˜éšŠéœ€è¦æŸ¥è©¢ç‰¹å®šçŸ¥è­˜æ™‚ï¼Œå¾€å¾€éœ€è¦é€é Slackã€Email ç­‰æ–¹å¼è©¢å•åŒäº‹ï¼Œé€™æ¨£çš„æºé€šæˆæœ¬ä¸åƒ…æµªè²»æ™‚é–“ï¼Œä¹Ÿå®¹æ˜“é€ æˆè³‡è¨Šä¸å°ç¨±ã€‚\nå­¸å“¡å°‡å­¸æœƒå¦‚ä½•åˆ©ç”¨ RAG æŠ€è¡“ï¼Œçµåˆ OpenAIã€LangChainã€Qdrant å‘é‡æ•¸æ“šåº«ï¼Œæ§‹å»ºä¼æ¥­å…§éƒ¨æ–‡æª”çš„æ™ºèƒ½çŸ¥è­˜åº«ï¼Œä¸¦èƒ½è¨­è¨ˆèˆ‡å¯¦ä½œä¸€å€‹åŸºæ–¼è‡ªç„¶èªè¨€è™•ç†ï¼ˆNLPï¼‰çš„æŸ¥è©¢ç³»çµ±ï¼Œä¾†æå‡é–‹ç™¼åœ˜éšŠçš„æ•ˆç‡èˆ‡çŸ¥è­˜ç®¡ç†èƒ½åŠ›ã€‚\nä»€éº¼æ˜¯ RAGï¼Ÿ ä»‹ç´¹ RAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€è¡“å¦‚ä½•çµåˆæª¢ç´¢èˆ‡ç”Ÿæˆæå‡å•ç­”æº–ç¢ºæ€§ã€‚ ç‚ºä»€éº¼ä¼æ¥­éœ€è¦æ™ºèƒ½çŸ¥è­˜åº«ï¼Ÿ RAG çš„æ‡‰ç”¨å ´æ™¯ï¼šçŸ¥è­˜åº«å»ºç«‹ã€é–‹ç™¼æ”¯æ´ã€æŠ€è¡“æ±ºç­–ç­‰ã€‚ Python èˆ‡ OpenAIï¼š ä½¿ç”¨ OpenAI API æ¶æ§‹èˆ‡èªè¨€æ¨¡å‹ï¼Œå¿«é€Ÿæ§‹å»ºç”Ÿæˆæ¨¡å‹ LangChainï¼šä»‹ç´¹ LangChain æ¡†æ¶å¦‚ä½•ç°¡åŒ– RAG å¯¦ç¾ å¦‚ä½•åˆ©ç”¨ LangChain æ•´åˆå¤šç¨®æ•¸æ“šæºèˆ‡ç”Ÿæˆæ¨¡å‹ Qdrant å‘é‡æ•¸æ“šåº«ï¼š å‘é‡æ•¸æ“šåº«çš„æ¦‚å¿µèˆ‡ä½œç”¨ å¦‚ä½•åˆ©ç”¨ Qdrant å„²å­˜èˆ‡æª¢ç´¢å…§éƒ¨æ–‡æª”çš„åµŒå…¥å‘é‡ æ§‹å»º RAG ç³»çµ±ï¼šå¯¦ä½œæ­¥é©Ÿèˆ‡æ¼”ç¤º æ•¸æ“šé è™•ç†èˆ‡æ–‡æª”è½‰æ› å°‡è™•ç†å¾Œçš„æ–‡æœ¬è½‰æ›ç‚ºå‘é‡è¡¨ç¤ºï¼ˆembeddingï¼‰ åˆ©ç”¨ Qdrant å‘é‡æ•¸æ“šåº«å„²å­˜é€™äº›åµŒå…¥ä¸¦åŸ·è¡Œæª¢ç´¢ ä½¿ç”¨ LangChain çµåˆ OpenAI æ¨¡å‹èˆ‡ Qdrantï¼Œè£½ä½œè‡ªå‹•åŒ–å•ç­”ç³»çµ± Target group æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†å¯¦ä½œåŸºæœ¬ RAG AI Agentã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\nå¿…å‚™çŸ¥è­˜ï¼šLinux æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼ŒDocker æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼Œæœƒä½¿ç”¨ SSH é€£ç·š / Bash / dockerã€‚\nå·¥ä½œåŠçµæŸå¾Œï¼Œå­¸å“¡å°‡èƒ½å¤ ï¼š\nç†è§£ä¸¦å¯¦ä½œ RAG æŠ€è¡“ï¼Œå°‡å…§éƒ¨æ–‡æª”è½‰åŒ–ç‚ºæ™ºèƒ½çŸ¥è­˜åº« ä½¿ç”¨ Pythonã€LangChain å’Œ OpenAI æ§‹å»ºåŸºæ–¼æª¢ç´¢çš„å•ç­”ç³»çµ± åˆ©ç”¨ Qdrant å‘é‡æ•¸æ“šåº«é€²è¡Œé«˜æ•ˆæª¢ç´¢ï¼Œæå‡é–‹ç™¼æµç¨‹ä¸­çš„çŸ¥è­˜ç®¡ç†æ•ˆç‡ã€‚ é€™æ¨£çš„å·¥ä½œåŠçµæ§‹èƒ½å¤ å¹³è¡¡ç†è«–èˆ‡å¯¦è¸ï¼Œä¸¦ç‚ºå­¸å“¡æä¾›å¯¦éš›å‹•æ‰‹æ“ä½œçš„æ©Ÿæœƒã€‚ Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n","permalink":"https://chechia.net/posts/2025-06-06-devops-rag-internal-ai/","summary":"\u003ch3 id=\"-æ´»å‹•æ™‚é–“-2025-06-05t124500z\"\u003eğŸ“… æ´»å‹•æ™‚é–“: 2025-06-05T12:45:00Z\u003c/h3\u003e\n\u003ch3 id=\"-æ´»å‹•é€£çµ\"\u003eğŸ”— \u003ca href=\"https://devopsdays.tw/2025/workshop-page/3788\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-è¯ç¹«æˆ‘-facebook\"\u003eğŸ“˜ è¯ç¹«æˆ‘ \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"-æŠ•å½±ç‰‡\"\u003eğŸ“‘ \u003ca href=\"/slides/2025-06-05-devops-rag-internal-ai/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/h3\u003e\n\u003chr\u003e\n\u003ch2 id=\"rag-workshop-è¡Œå‰é€šçŸ¥\"\u003eRAG workshop è¡Œå‰é€šçŸ¥\u003c/h2\u003e\n\u003cp\u003eæœ¬æ¬¡ workshop ä»¥ hands-on çš„æ–¹å¼é€²è¡Œï¼Œç´¯ç©æ“ä½œç¶“é©—ç‚ºä¸»ï¼Œè¬›è§£èˆ‡èªªæ˜ç‚ºè¼”ã€‚è§€å¿µå…§å®¹æœ‰æº–å‚™æ•™æï¼Œéœ€è¦åƒèˆ‡è€…è‡ªè¡Œé–±è®€ã€‚è¬›å¸«æœƒå…è²»æä¾›\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eAzure OpenAI models API key (gpt-4.1, gpt-4.1-mini, text-embedding-3, text-embedding-ada-002\u0026hellip;)\u003c/li\u003e\n\u003cli\u003eAzure VM ä¾›åŒå­¸é ç«¯æ“ä½œä½¿ç”¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"-æŠ•å½±ç‰‡èˆ‡æ•™æ-\"\u003e\u0026ndash;\u0026gt; \u003ca href=\"/slides/2025-06-05-devops-rag-internal-ai/\"\u003eæŠ•å½±ç‰‡èˆ‡æ•™æ\u003c/a\u003e \u0026lt;\u0026ndash;\u003c/h1\u003e\n\u003chr\u003e\n\u003ch3 id=\"workshop-åŸºæœ¬éœ€æ±‚\"\u003eWorkshop åŸºæœ¬éœ€æ±‚\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eæœ‰è‡ªå·±çš„é›»è…¦ï¼Œå¯ä»¥ä¸Šç¶²\u003c/li\u003e\n\u003cli\u003eé¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ï¼Œåœ¨ docker å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ\u003c/li\u003e\n\u003cli\u003eé¸é …2: ä½¿ç”¨è‡ªå·±çš„é›»è…¦ï¼Œé ç«¯é€£ç·šè¬›å¸«æä¾›çš„ VMï¼Œåœ¨VM ä¸­å•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒ\u003c/li\u003e\n\u003cli\u003eæœƒä½¿ç”¨ docker\u003c/li\u003e\n\u003cli\u003eæœƒä½¿ç”¨ python èˆ‡ jupyter notebook\u003c/li\u003e\n\u003cli\u003eæœƒä½¿ç”¨ chatgpt.com å”åŠ©é™¤éŒ¯\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch3 id=\"é¸é …1-ä½¿ç”¨è‡ªå·±çš„é›»è…¦\"\u003eé¸é …1: ä½¿ç”¨è‡ªå·±çš„é›»è…¦\u003c/h3\u003e\n\u003cp\u003eåœ¨ workshop é–‹å§‹å‰ï¼Œåœ¨è‡ªå·±çš„é›»è…¦ä¸Š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®‰è£ docker\u003c/li\u003e\n\u003cli\u003egit clone github repository\u003c/li\u003e\n\u003cli\u003eå•Ÿå‹• docker é–‹ç™¼ç’°å¢ƒï¼Œä¸‹è¼‰ docker images\u003c/li\u003e\n\u003cli\u003eé–‹å•Ÿç€è¦½å™¨ï¼Œé€£ç·šåˆ° Jupyter Notebookï¼Œtoken \u003ccode\u003eworkshop1234!\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eåœ¨ Jupyter Notebook ä¸­ï¼Œå®‰è£æ‰€éœ€çš„ Python å¥—ä»¶\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003egit clone https://github.com/chechiachang/rag-workshop.git\n\ncd rag-workshop\n\ndocker compose up -d\n\ndocker exec -it notebook pip install pandas openai qdrant_client tqdm tenacity wget tenacity unstructured markdown ragas sacrebleu langchain_qdrant langchain-openai langchain_openai langchain_community tiktoken\n\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch3 id=\"é¸é …2-ä½¿ç”¨é ç«¯-vm\"\u003eé¸é …2: ä½¿ç”¨é ç«¯ VM\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eå»ºè­°ä½¿ç”¨å€‹äººé›»è…¦ï¼Œç•¢ç«Ÿå…è²» VM åé¡ç¾å ´æœ‰é™\u003c/li\u003e\n\u003cli\u003eéœ€è¦æœ‰è‡ªå·±çš„é›»è…¦ï¼Œæœ‰ç©©å®šçš„ç¶²è·¯ï¼Œå¯ä»¥é€£ç·šåˆ°é ç«¯ VM\u003c/li\u003e\n\u003cli\u003eéœ€è¦è¨»å†Š tunnel å·¥å…·ï¼ˆæ²’æœ‰æ¥­é…ï¼‰\u003ca href=\"https://dashboard.ngrok.com/login\"\u003engrok\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eç™»å…¥ Login -\u0026gt; å·¦æ‰‹é‚Š Identity \u0026amp; Access -\u0026gt; Authtokens -\u0026gt; Add Tunnel authtoken -\u0026gt; è¨˜åœ¨å®‰å…¨çš„åœ°æ–¹\u003c/li\u003e\n\u003cli\u003eä¹Ÿå¯ä»¥ä½¿ç”¨ \u003ca href=\"https://pinggy.io/\"\u003epinggy\u003c/a\u003eï¼Œä½†å…è²»æœ‰é™æ™‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch3 id=\"æŠ•å½±ç‰‡èˆ‡æ•™ææœƒæ”¾åœ¨ç¶²ç«™ä¸Š\"\u003eæŠ•å½±ç‰‡èˆ‡æ•™ææœƒæ”¾åœ¨ç¶²ç«™ä¸Š\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://chechia.net/zh-hant/slides/2025-06-05-devops-rag-internal-ai/\"\u003ehttps://chechia.net/zh-hant/slides/2025-06-05-devops-rag-internal-ai/\u003c/a\u003e\u003c/p\u003e","title":"Workshop: DevOpsDay 2025: RAGæ‰“é€ ä¼æ¥­AIçŸ¥è­˜åº«ï¼šæŠŠä¸€ç”²å­åŠŸåŠ›å‚³çµ¦æ–°äºº"},{"content":" æ´»å‹•æ™‚é–“: 2023-10-25T13:20:00Z æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ Presentation Upgrade A VM Based Clustermin\nTarget group æ”¶ç©« æœ¬æ¬¡æ¼”è¬›æœƒè¬›è§£å‡ç´šæ“ä½œï¼Œä½†ä¸ä¾·é™åœ¨å…·é«”æ­¥é©Ÿï¼Œè€Œæ˜¯å¸Œæœ›èƒ½è¬›è§£æ›´å¤š k8s æ¶æ§‹èˆ‡è¨­è¨ˆï¼Œè®“è§€çœ¾æœ‰ä»¥ä¸‹æ”¶ç©«ï¼šå¦‚ä½•å‡ç´š Kubernetes Cluster çš„ç‰ˆæœ¬ï¼Œå‡ç´šæ™‚æ‡‰è€ƒé‡çš„äº‹é …æœ‰å“ªäº›ï¼Œæœ‰ä»€éº¼å·¥å…·å¯ä»¥å”åŠ©å‡ç´šæµç¨‹ï¼Œé€éå‡ç´šæ›´äº†è§£ Kubernetes çš„æ¶æ§‹\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2024 Cloud Summit 2024 SRE Conference 2023 DevOpsDay Taipei 2023 Kubernetes Summit 2022 COSCUP 2022 Cloud Summit 2021 Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Cloud Summit 2019 Cloud Summit 2018 Cloud Summit 2018 Kubernetes Summit ","permalink":"https://chechia.net/posts/2024-10-23-k8s-summit/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2023-10-25T13:20:00Z\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://k8s.ithome.com.tw/2023/session-page/2331\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2024-10-23-upgrade-k8s-cluster/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch1 id=\"presentation\"\u003ePresentation\u003c/h1\u003e\n\u003cp\u003eUpgrade A VM Based Clustermin\u003c/p\u003e\n\u003ch3 id=\"target-group-æ”¶ç©«\"\u003eTarget group æ”¶ç©«\u003c/h3\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›æœƒè¬›è§£å‡ç´šæ“ä½œï¼Œä½†ä¸ä¾·é™åœ¨å…·é«”æ­¥é©Ÿï¼Œè€Œæ˜¯å¸Œæœ›èƒ½è¬›è§£æ›´å¤š k8s æ¶æ§‹èˆ‡è¨­è¨ˆï¼Œè®“è§€çœ¾æœ‰ä»¥ä¸‹æ”¶ç©«ï¼šå¦‚ä½•å‡ç´š Kubernetes Cluster çš„ç‰ˆæœ¬ï¼Œå‡ç´šæ™‚æ‡‰è€ƒé‡çš„äº‹é …æœ‰å“ªäº›ï¼Œæœ‰ä»€éº¼å·¥å…·å¯ä»¥å”åŠ©å‡ç´šæµç¨‹ï¼Œé€éå‡ç´šæ›´äº†è§£ Kubernetes çš„æ¶æ§‹\u003c/p\u003e\n\u003ch1 id=\"author\"\u003eAuthor\u003c/h1\u003e\n\u003cp\u003eChe-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚\nMicrosoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\u003c/p\u003e\n\u003cp\u003eç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\u003c/p\u003e\n\u003cp\u003eChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup.\nMicrosoft Most Valuable Professional since 2020.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e2024 Cloud Summit\u003c/li\u003e\n\u003cli\u003e2024 SRE Conference\u003c/li\u003e\n\u003cli\u003e2023 DevOpsDay Taipei\u003c/li\u003e\n\u003cli\u003e2023 Kubernetes Summit\u003c/li\u003e\n\u003cli\u003e2022 COSCUP\u003c/li\u003e\n\u003cli\u003e2022 Cloud Summit\u003c/li\u003e\n\u003cli\u003e2021 Cloud Summit\u003c/li\u003e\n\u003cli\u003e2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform\u003c/li\u003e\n\u003cli\u003e2020 Cloud Native Taiwan å¹´æœ«èšæœƒ\u003c/li\u003e\n\u003cli\u003e2020 Cloud Summit\u003c/li\u003e\n\u003cli\u003e2019 Cloud Summit\u003c/li\u003e\n\u003cli\u003e2018 Cloud Summit\u003c/li\u003e\n\u003cli\u003e2018 Kubernetes Summit\u003c/li\u003e\n\u003c/ul\u003e","title":"Kubernetes Summit: Upgrade A VM Based Cluster"},{"content":" æ´»å‹•æ™‚é–“: 2024-10-23T13:20:00Z æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ å·¥ä½œåŠå…§å®¹ å…©å€‹å ´æ¬¡\n2024-10-23T13:20-14:50 @ 603+604 2024-10-24T13:20-14:50 @ 605 Get Started è«‹é»æ“Šæœ¬é ä¸Šæ–¹æŠ•å½±ç‰‡é€£çµ Git clone æœ¬æ¬¡ workshop è³‡æº https://github.com/chechiachang/etcd-playground æ´»å‹•ç•¶å¤©ç¾å ´ï¼Œæœƒæä¾›ä¸€å° Linux VM åšä½¿ç”¨ Workshop Get started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s\nOutline Etcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ Etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ Etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚\né è¨ˆå…§å®¹ï¼šç’°å¢ƒè¨­å®šï¼ŒEtcd è¨­å®šèˆ‡éƒ¨ç½²ï¼ŒEtcd åŸºç¤æ“ä½œï¼Œéƒ¨ç½² kube-apiserver / kube-controller-manager / kube-schedulerï¼Œä½¿ç”¨ kubectl æ“ä½œ Kubernetes Clusterã€‚è®“åƒèˆ‡è€…é€éæœ¬æ¬¡å·¥ä½œåŠï¼Œå¯ä»¥æœ‰æ“ä½œ k8s control plane çš„ç¶“é©—ï¼Œæ›´äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œï¼Œä»¥åŠäº†è§£ Kubernetes çš„åŸºæœ¬æ¶æ§‹ã€‚\nï¼ˆè¦åŠƒä¸­ï¼‰æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\nå¿…å‚™çŸ¥è­˜ï¼šLinux æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼ŒDocker æ“ä½œåŸºæœ¬çŸ¥è­˜ï¼Œæœƒä½¿ç”¨ SSH é€£ç·š / Bash / dockerã€‚ å·¥ä½œåŠæ™‚é–“ä¸å¤šï¼Œç¾å ´ä¸æœƒç´°è¬›æ¦‚å¿µå•é¡Œï¼Œåƒèˆ‡è€…éœ€è¦äº‹å‰é ç¿’åŸºæœ¬æ¦‚å¿µ https://etcd.io/ èˆ‡ http://play.etcd.io/play\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n","permalink":"https://chechia.net/posts/2024-10-24-k8s-summit/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2024-10-23T13:20:00Z\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://k8s.ithome.com.tw/2024/workshop-page/3259\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2024-10-24-etcd-workshop/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"å·¥ä½œåŠå…§å®¹\"\u003eå·¥ä½œåŠå…§å®¹\u003c/h2\u003e\n\u003cp\u003eå…©å€‹å ´æ¬¡\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e2024-10-23T13:20-14:50 @ 603+604\u003c/li\u003e\n\u003cli\u003e2024-10-24T13:20-14:50 @ 605\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"get-started\"\u003eGet Started\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eè«‹é»æ“Šæœ¬é ä¸Šæ–¹æŠ•å½±ç‰‡é€£çµ\u003c/li\u003e\n\u003cli\u003eGit clone æœ¬æ¬¡ workshop è³‡æº \u003ca href=\"https://github.com/chechiachang/etcd-playground\"\u003ehttps://github.com/chechiachang/etcd-playground\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eæ´»å‹•ç•¶å¤©ç¾å ´ï¼Œæœƒæä¾›ä¸€å° Linux VM åšä½¿ç”¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"workshop\"\u003eWorkshop\u003c/h2\u003e\n\u003cp\u003eGet started with Etcd \u0026amp; Kubernetes / æ‰‹æŠŠæ‰‹æ­å»º Etcd èˆ‡ K8s\u003c/p\u003e\n\u003ch3 id=\"outline\"\u003eOutline\u003c/h3\u003e\n\u003cp\u003eEtcd æ˜¯ Kubernetes çš„é‡è¦å…ƒä»¶ä¹‹ä¸€ï¼Œæœ¬æ¬¡å·¥ä½œåŠå°‡å¸¶é ˜è§€çœ¾åˆæ¢ Etcdï¼ŒåŒ…å«å®‰è£ï¼Œè¨­å®šï¼Œä»¥åŠæ“ä½œã€‚ä¸¦è—‰ç”±æœ¬åœ°çš„ Etcd ä¾†æ¶è¨­ä¸€å€‹æœ€ç°¡å–®çš„ Kubernetes Clusterã€‚\u003c/p\u003e\n\u003cp\u003eé è¨ˆå…§å®¹ï¼šç’°å¢ƒè¨­å®šï¼ŒEtcd è¨­å®šèˆ‡éƒ¨ç½²ï¼ŒEtcd åŸºç¤æ“ä½œï¼Œéƒ¨ç½² kube-apiserver / kube-controller-manager / kube-schedulerï¼Œä½¿ç”¨ kubectl æ“ä½œ Kubernetes Clusterã€‚è®“åƒèˆ‡è€…é€éæœ¬æ¬¡å·¥ä½œåŠï¼Œå¯ä»¥æœ‰æ“ä½œ k8s control plane çš„ç¶“é©—ï¼Œæ›´äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œï¼Œä»¥åŠäº†è§£ Kubernetes çš„åŸºæœ¬æ¶æ§‹ã€‚\u003c/p\u003e\n\u003cp\u003eï¼ˆè¦åŠƒä¸­ï¼‰æœ¬æ¬¡å·¥ä½œåŠæœƒæä¾›åƒèˆ‡è€…ä¸€å€‹ç°¡å–®çš„ç’°å¢ƒï¼Œè®“åƒèˆ‡è€…å¯ä»¥é€éé ç«¯æ“ä½œä¾†äº†è§£ Etcd çš„åŸºæœ¬æ“ä½œã€‚åƒèˆ‡è€…å¿…å‚™å€‹äººç­†é›»ï¼Œé€é SSH æ“æ§é ç«¯æ©Ÿå™¨ã€‚\u003c/p\u003e","title":"Workshop: Kubernetes Summit: Get started with Etcd \u0026 Kubernetes"},{"content":" æ´»å‹•æ™‚é–“: 2024-08-28T11:00:00Z æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ Info è³‡æ–™åº«ç®¡ç†æ˜¯ä¸€å€‹å¾ˆå¤§çš„è­°é¡Œï¼šå¦‚ä½•ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œå¦‚ä½•ç²¾ç¢ºçš„ç”¨æˆ¶è¨­å®šæ¬Šé™ï¼Œå‚³éå¯†ç¢¼çµ¦ç”¨æˆ¶ï¼Œä¸¦è‡ªå‹•åŒ–å®šæœŸæ›´æ–°å¯†ç¢¼ã€‚æœ¬å ´æ¼”è¬›å°‡åˆ†äº«å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œå¦‚ä½•å®‰å…¨çš„å‚³éå¯†ç¢¼ï¼Œä¸¦å®‰å…¨åœ°é€£ç·šåˆ°è³‡æ–™åº«\næ¶µè“‹ä»¥ä¸‹å…§å®¹ï¼š\ndatabase å¸³è™Ÿå¯†ç¢¼ç®¡ç†çš„é›£é¡Œ ç°¡ä»‹ Vault èˆ‡ database secret engine åœ¨ vault ä¸­è¨­å®š database secret engine vault åœ¨éœ€è¦æ™‚è‡ªå‹•ç”¢ç”Ÿè³‡æ–™åº«å¸³è™Ÿå¯†ç¢¼ vault é€éå®‰å…¨ä¾†æºèªè­‰ app èº«ä»½(ä½¿ç”¨ k8s service account èˆ‡ public cloud èªè­‰(aws iam role)) å®Œæˆ app é€£ç·šè‡³ database çš„å·¥ä½œé€±æœŸ monitoring / auditï¼švault audit log + prometheus / grafana dashboard / alert manager ç¯„ä¾‹ï¼šå¦‚ä½•ä½¿ç”¨ terraform è¨­å®š vault èˆ‡ database secret engine Target group æœ‰è³‡æ–™åº«ç®¡ç†éœ€æ±‚çš„å·¥ç¨‹å¸«ï¼Œæƒ³è¦å­¸ç¿’å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œå¦‚ä½•å®‰å…¨çš„å‚³éå¯†ç¢¼ï¼Œä¸¦å®‰å…¨åœ°é€£ç·šåˆ°è³‡æ–™åº«ã€‚\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","permalink":"https://chechia.net/posts/2024-08-28-hashicorp-vault-database/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2024-08-28T11:00:00Z\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.omniwaresoft.com.tw/all-events/aicloud-webinar-20240814-0828/\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2024-08-28-hashicorp-vault-database/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch1 id=\"info\"\u003eInfo\u003c/h1\u003e\n\u003cp\u003eè³‡æ–™åº«ç®¡ç†æ˜¯ä¸€å€‹å¾ˆå¤§çš„è­°é¡Œï¼šå¦‚ä½•ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œå¦‚ä½•ç²¾ç¢ºçš„ç”¨æˆ¶è¨­å®šæ¬Šé™ï¼Œå‚³éå¯†ç¢¼çµ¦ç”¨æˆ¶ï¼Œä¸¦è‡ªå‹•åŒ–å®šæœŸæ›´æ–°å¯†ç¢¼ã€‚æœ¬å ´æ¼”è¬›å°‡åˆ†äº«å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œå¦‚ä½•å®‰å…¨çš„å‚³éå¯†ç¢¼ï¼Œä¸¦å®‰å…¨åœ°é€£ç·šåˆ°è³‡æ–™åº«\u003c/p\u003e\n\u003cp\u003eæ¶µè“‹ä»¥ä¸‹å…§å®¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003edatabase å¸³è™Ÿå¯†ç¢¼ç®¡ç†çš„é›£é¡Œ\u003c/li\u003e\n\u003cli\u003eç°¡ä»‹ Vault èˆ‡ database secret engine\u003c/li\u003e\n\u003cli\u003eåœ¨ vault ä¸­è¨­å®š database secret engine\u003c/li\u003e\n\u003cli\u003evault åœ¨éœ€è¦æ™‚è‡ªå‹•ç”¢ç”Ÿè³‡æ–™åº«å¸³è™Ÿå¯†ç¢¼\u003c/li\u003e\n\u003cli\u003evault é€éå®‰å…¨ä¾†æºèªè­‰ app èº«ä»½(ä½¿ç”¨ k8s service account èˆ‡ public cloud èªè­‰(aws iam role))\u003c/li\u003e\n\u003cli\u003eå®Œæˆ app é€£ç·šè‡³ database çš„å·¥ä½œé€±æœŸ\u003c/li\u003e\n\u003cli\u003emonitoring / auditï¼švault audit log + prometheus / grafana dashboard / alert manager\u003c/li\u003e\n\u003cli\u003eç¯„ä¾‹ï¼šå¦‚ä½•ä½¿ç”¨ terraform è¨­å®š vault èˆ‡ database secret engine\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"target-group\"\u003eTarget group\u003c/h1\u003e\n\u003cp\u003eæœ‰è³‡æ–™åº«ç®¡ç†éœ€æ±‚çš„å·¥ç¨‹å¸«ï¼Œæƒ³è¦å­¸ç¿’å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ç®¡ç†è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œä¸¦é€é AWS IAM Role èˆ‡ Kubernetes Service Account é€²è¡Œé©—è­‰ï¼Œå¦‚ä½•å®‰å…¨çš„å‚³éå¯†ç¢¼ï¼Œä¸¦å®‰å…¨åœ°é€£ç·šåˆ°è³‡æ–™åº«ã€‚\u003c/p\u003e","title":"Hashicorp: managed database credentials with Hashicorp Vault"},{"content":" æ´»å‹•æ™‚é–“: 2024-07-03 æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ Info Title: SRE Conference: Cloud Infrastructure Saving Engineering é›²ç«¯çœéŒ¢å·¥ç¨‹\nä½¿ç”¨ AWS èˆ‡ Kubernetes å°±æ˜¯è¦èŠ±éŒ¢ï¼Œå¦‚ä½•çœéŒ¢ï¼Ÿ åˆç†çš„è¨­å®šè³‡æºï¼Œä¸åƒ…çœéŒ¢ï¼Œé‚„æå‡æ•´é«”æœå‹™ç©©å®šåº¦ï¼Ÿ æ—¢æœ‰æœå‹™å·²ç¶“å­˜åœ¨ï¼Œå¦‚ä½•é€æ­¥æ”¹è®Šï¼Œé™ä½æˆæœ¬ï¼Ÿ\næœ¬æ¬¡æ¼”è¬›ä»¥å¯¦å‹™çš„ç¯„ä¾‹ï¼Œåˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan\u0026hellip;ï¼Œä¸¦åˆ†äº«å¦‚ä½•æ”¹è®Šæ–‡åŒ–ï¼Œæé«˜åœ˜éšŠçš„æˆæœ¬æ„è­˜ï¼Œå¯¦éš›çš„é™ä½é–‹éŠ·\nTarget group AWS \u0026amp; Kubernetes User who want to decrease overall cost of infrastructure\nå°å…¥å·¥å…·ï¼šæœ‰å“ªäº›å·¥å…·å¯ä»¥ä½¿ç”¨ åˆ†æç¾æ³ï¼šç²¾ç®—å„åœ˜éšŠèˆ‡å„å°ˆæ¡ˆæˆæœ¬ æ”¹è®Šç¾æ³ï¼šå¾æ—¢æœ‰çš„æ¶æ§‹ä¸­ï¼Œæ‰¾å°‹å¯ä»¥ç¯€çœæˆæœ¬çš„åœ°æ–¹ æ”¹å–„æµç¨‹ï¼šæœ‰æ•ˆç‡çš„ç¶­æŒçœéŒ¢ workflow æ”¹è®Šæ–‡åŒ–ï¼šæŒçºŒæ€§ä½ç¶­æŒæ–°æœå‹™èˆ‡èˆŠæœå‹™çš„åˆç†æˆæœ¬ Author Che-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\næ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\nå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\nChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\nActively engaged in the Taiwanese tech community, he frequently shares insights on DevOps, SRE, Kubernetes, and cloud computing at CNTUG, DevOps Taipei, GDG Taipei, and Golang Taipei Meetup. Passionate about promoting best practices in development and operations, he continuously explores and applies the latest advancements in cloud and AI technologies.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","permalink":"https://chechia.net/posts/2024-07-03-cloud-summit/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2024-07-03\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://cloudsummit.ithome.com.tw/2024/session-page/2620\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2024-07-03-saving-money-on-cloud-k8s/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"info\"\u003eInfo\u003c/h2\u003e\n\u003cp\u003eTitle: SRE Conference: Cloud Infrastructure Saving Engineering é›²ç«¯çœéŒ¢å·¥ç¨‹\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨ AWS èˆ‡ Kubernetes å°±æ˜¯è¦èŠ±éŒ¢ï¼Œå¦‚ä½•çœéŒ¢ï¼Ÿ\nåˆç†çš„è¨­å®šè³‡æºï¼Œä¸åƒ…çœéŒ¢ï¼Œé‚„æå‡æ•´é«”æœå‹™ç©©å®šåº¦ï¼Ÿ\næ—¢æœ‰æœå‹™å·²ç¶“å­˜åœ¨ï¼Œå¦‚ä½•é€æ­¥æ”¹è®Šï¼Œé™ä½æˆæœ¬ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›ä»¥å¯¦å‹™çš„ç¯„ä¾‹ï¼Œåˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan\u0026hellip;ï¼Œä¸¦åˆ†äº«å¦‚ä½•æ”¹è®Šæ–‡åŒ–ï¼Œæé«˜åœ˜éšŠçš„æˆæœ¬æ„è­˜ï¼Œå¯¦éš›çš„é™ä½é–‹éŠ·\u003c/p\u003e\n\u003ch2 id=\"target-group\"\u003eTarget group\u003c/h2\u003e\n\u003cp\u003eAWS \u0026amp; Kubernetes User who want to decrease overall cost of infrastructure\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå°å…¥å·¥å…·ï¼šæœ‰å“ªäº›å·¥å…·å¯ä»¥ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eåˆ†æç¾æ³ï¼šç²¾ç®—å„åœ˜éšŠèˆ‡å„å°ˆæ¡ˆæˆæœ¬\u003c/li\u003e\n\u003cli\u003eæ”¹è®Šç¾æ³ï¼šå¾æ—¢æœ‰çš„æ¶æ§‹ä¸­ï¼Œæ‰¾å°‹å¯ä»¥ç¯€çœæˆæœ¬çš„åœ°æ–¹\u003c/li\u003e\n\u003cli\u003eæ”¹å–„æµç¨‹ï¼šæœ‰æ•ˆç‡çš„ç¶­æŒçœéŒ¢ workflow\u003c/li\u003e\n\u003cli\u003eæ”¹è®Šæ–‡åŒ–ï¼šæŒçºŒæ€§ä½ç¶­æŒæ–°æœå‹™èˆ‡èˆŠæœå‹™çš„åˆç†æˆæœ¬\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"author\"\u003eAuthor\u003c/h2\u003e\n\u003cp\u003eChe-Chia Chang æ˜¯ä¸€åå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼ã€é–‹ç™¼ç¶­é‹ã€å®¹å™¨åŒ–æ‡‰ç”¨åŠ Kubernetes é–‹ç™¼èˆ‡ç®¡ç†çš„æŠ€è¡“å°ˆå®¶ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ Microsoft æœ€æœ‰åƒ¹å€¼å°ˆæ¥­äººå£«ï¼ˆMVPï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ´»èºæ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤ï¼Œç¶“å¸¸åœ¨ CNTUGã€DevOps Taipeiã€GDG Taipeiã€Golang Taipei Meetup ç­‰ç¤¾ç¾¤åˆ†äº« DevOpsã€SREã€Kubernetes åŠé›²ç«¯é‹ç®—ç›¸é—œæŠ€è¡“ã€‚è‡´åŠ›æ–¼æ¨å‹•é–‹ç™¼èˆ‡ç¶­é‹çš„æœ€ä½³å¯¦è¸ï¼Œä¸¦ç†±è¡·æ–¼ç ”ç©¶èˆ‡æ‡‰ç”¨æœ€æ–°çš„é›²ç«¯èˆ‡ AI æŠ€è¡“ã€‚\u003c/p\u003e\n\u003cp\u003eå€‹äººéƒ¨è½æ ¼ï¼šhttps://chechia.net\u003c/p\u003e\n\u003cp\u003eChe-Chia Chang is a technology expert specializing in backend development, DevOps, site reliability engineering (SRE), containerized applications, and Kubernetes development and management. He is also recognized as a Microsoft Most Valuable Professional (MVP).\u003c/p\u003e","title":"Cloud Summit: Cloud Infrastructure Saving EngineeringÂ  é›²ç«¯çœéŒ¢å·¥ç¨‹"},{"content":"Get-Started Google \u0026ldquo;how to contribute to kubernetes\u0026rdquo; click the first link you like in every page do what the page says Get-Started https://www.kubernetes.dev https://www.kubernetes.dev/docs/guide/ Contributor Playground Youtube: New Contributor Series 2018-2019 Join the Kubernetes Slack Contribute to kubernetes Documentation Join Group https://www.kubernetes.dev/community/community-groups/ SIG-DOCS Find Issue on Github https://github.com/kubernetes/website/issues/38681 Contributing to Kubernetes Documentation Join sig-docs google groupd Prerequisites In my opinion, the following are the prerequisites to contribute to Kubernetes:\nEnglish proficiency Unorganized Links Community-membership actively contributer Community Forums ","permalink":"https://chechia.net/posts/2024-04-27-contribute-to-k8s/","summary":"\u003ch1 id=\"get-started\"\u003eGet-Started\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eGoogle \u0026ldquo;how to contribute to kubernetes\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eclick the first link you like in every page\u003c/li\u003e\n\u003cli\u003edo what the page says\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"get-started-1\"\u003eGet-Started\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.kubernetes.dev\"\u003ehttps://www.kubernetes.dev\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.kubernetes.dev/docs/guide/\"\u003ehttps://www.kubernetes.dev/docs/guide/\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kubernetes-sigs/contributor-playground/blob/master/README.md\"\u003eContributor Playground\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.youtube.com/playlist?list=PL69nYSiGNLP3M5X7stuD7N4r3uP2PZQUx\"\u003eYoutube: New Contributor Series 2018-2019\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://communityinviter.com/apps/kubernetes/community\"\u003eJoin the Kubernetes Slack\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://kubernetes.io/docs/contribute/docs/\"\u003eContribute to kubernetes Documentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"join-group\"\u003eJoin Group\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.kubernetes.dev/community/community-groups/\"\u003ehttps://www.kubernetes.dev/community/community-groups/\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kubernetes/community/blob/master/sig-docs/README.md\"\u003eSIG-DOCS\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"find-issue-on-github\"\u003eFind Issue on Github\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kubernetes/website/issues/38681\"\u003ehttps://github.com/kubernetes/website/issues/38681\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kubernetes/website/blob/36fa877ba3be67cb0a8c508757bdc8849cbdb5af/CONTRIBUTING.md\"\u003eContributing to Kubernetes Documentation\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://groups.google.com/g/kubernetes-sig-docs\"\u003eJoin sig-docs google groupd\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"prerequisites\"\u003ePrerequisites\u003c/h1\u003e\n\u003cp\u003eIn my opinion, the following are the prerequisites to contribute to Kubernetes:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eEnglish proficiency\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"unorganized-links\"\u003eUnorganized Links\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kubernetes/community/blob/master/community-membership.md#member\"\u003eCommunity-membership\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eactively contributer\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://discuss.kubernetes.io/\"\u003eCommunity Forums\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"2024 04 27 Contribute to K8s"},{"content":" æ´»å‹•æ™‚é–“: 2024-04-26 æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ Info Title: SRE Conference: Cloud Infrastructure Saving Engineering é›²ç«¯çœéŒ¢å·¥ç¨‹\nä½¿ç”¨ AWS èˆ‡ Kubernetes å°±æ˜¯è¦èŠ±éŒ¢ï¼Œå¦‚ä½•çœéŒ¢ï¼Ÿ åˆç†çš„è¨­å®šè³‡æºï¼Œä¸åƒ…çœéŒ¢ï¼Œé‚„æå‡æ•´é«”æœå‹™ç©©å®šåº¦ï¼Ÿ æ—¢æœ‰æœå‹™å·²ç¶“å­˜åœ¨ï¼Œå¦‚ä½•é€æ­¥æ”¹è®Šï¼Œé™ä½æˆæœ¬ï¼Ÿ\næœ¬æ¬¡æ¼”è¬›ä»¥å¯¦å‹™çš„ç¯„ä¾‹ï¼Œåˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan\u0026hellip;ï¼Œä¸¦åˆ†äº«å¦‚ä½•æ”¹è®Šæ–‡åŒ–ï¼Œæé«˜åœ˜éšŠçš„æˆæœ¬æ„è­˜ï¼Œå¯¦éš›çš„é™ä½é–‹éŠ·\nTarget group AWS \u0026amp; Kubernetes User who want to decrease overall cost of infrastructure\nå°å…¥å·¥å…·ï¼šæœ‰å“ªäº›å·¥å…·å¯ä»¥ä½¿ç”¨ åˆ†æç¾æ³ï¼šç²¾ç®—å„åœ˜éšŠèˆ‡å„å°ˆæ¡ˆæˆæœ¬ æ”¹è®Šç¾æ³ï¼šå¾æ—¢æœ‰çš„æ¶æ§‹ä¸­ï¼Œæ‰¾å°‹å¯ä»¥ç¯€çœæˆæœ¬çš„åœ°æ–¹ æ”¹å–„æµç¨‹ï¼šæœ‰æ•ˆç‡çš„ç¶­æŒçœéŒ¢ workflow æ”¹è®Šæ–‡åŒ–ï¼šæŒçºŒæ€§ä½ç¶­æŒæ–°æœå‹™èˆ‡èˆŠæœå‹™çš„åˆç†æˆæœ¬ Author Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","permalink":"https://chechia.net/posts/2024-04-26-sre-conference/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2024-04-26\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://sre.ithome.com.tw/2024/session-page/2548\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2024-04-26-saving-money-on-cloud-k8s/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"info\"\u003eInfo\u003c/h2\u003e\n\u003cp\u003eTitle: SRE Conference: Cloud Infrastructure Saving Engineering é›²ç«¯çœéŒ¢å·¥ç¨‹\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨ AWS èˆ‡ Kubernetes å°±æ˜¯è¦èŠ±éŒ¢ï¼Œå¦‚ä½•çœéŒ¢ï¼Ÿ\nåˆç†çš„è¨­å®šè³‡æºï¼Œä¸åƒ…çœéŒ¢ï¼Œé‚„æå‡æ•´é«”æœå‹™ç©©å®šåº¦ï¼Ÿ\næ—¢æœ‰æœå‹™å·²ç¶“å­˜åœ¨ï¼Œå¦‚ä½•é€æ­¥æ”¹è®Šï¼Œé™ä½æˆæœ¬ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›ä»¥å¯¦å‹™çš„ç¯„ä¾‹ï¼Œåˆ†äº«å¹¾å€‹ç¯€çœé›²ç«¯é–‹éŠ·çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼šå°å…¥ spot instanceï¼Œæˆæœ¬è¨ˆç®—èˆ‡é æ¸¬å·¥å…·ï¼Œå‹•æ…‹è³‡æºèª¿æ•´HPAèˆ‡VPAï¼Œsaving plan\u0026hellip;ï¼Œä¸¦åˆ†äº«å¦‚ä½•æ”¹è®Šæ–‡åŒ–ï¼Œæé«˜åœ˜éšŠçš„æˆæœ¬æ„è­˜ï¼Œå¯¦éš›çš„é™ä½é–‹éŠ·\u003c/p\u003e\n\u003ch2 id=\"target-group\"\u003eTarget group\u003c/h2\u003e\n\u003cp\u003eAWS \u0026amp; Kubernetes User who want to decrease overall cost of infrastructure\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå°å…¥å·¥å…·ï¼šæœ‰å“ªäº›å·¥å…·å¯ä»¥ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eåˆ†æç¾æ³ï¼šç²¾ç®—å„åœ˜éšŠèˆ‡å„å°ˆæ¡ˆæˆæœ¬\u003c/li\u003e\n\u003cli\u003eæ”¹è®Šç¾æ³ï¼šå¾æ—¢æœ‰çš„æ¶æ§‹ä¸­ï¼Œæ‰¾å°‹å¯ä»¥ç¯€çœæˆæœ¬çš„åœ°æ–¹\u003c/li\u003e\n\u003cli\u003eæ”¹å–„æµç¨‹ï¼šæœ‰æ•ˆç‡çš„ç¶­æŒçœéŒ¢ workflow\u003c/li\u003e\n\u003cli\u003eæ”¹è®Šæ–‡åŒ–ï¼šæŒçºŒæ€§ä½ç¶­æŒæ–°æœå‹™èˆ‡èˆŠæœå‹™çš„åˆç†æˆæœ¬\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"author\"\u003eAuthor\u003c/h2\u003e\n\u003cp\u003eChe-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚\nMicrosoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\u003c/p\u003e\n\u003cp\u003eç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\u003c/p\u003e\n\u003cp\u003eChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup.\nMicrosoft Most Valuable Professional since 2020.\u003c/p\u003e","title":"SRE Conference: Cloud Infrastructure Saving EngineeringÂ  é›²ç«¯çœéŒ¢å·¥ç¨‹"},{"content":" æ´»å‹•æ™‚é–“: 2023-10-25T13:20:00Z æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ Info Title: Resource as Code for Kubernetes: stop kubectl apply\nhttps://k8s.ithome.com.tw/CFP\nInfrastrure as Code (IaC) èˆ‡ PaCï¼Œåœ¨è¬ç‰©éƒ½è©² as Code å¾—æ™‚ä»£ï¼Œä½ é‚„åœ¨ä¸æ–·çš„ kubectl apply å—ï¼Ÿ\næ‰‹å‹• apply çš„ç—›é»ï¼š äººå°±æ˜¯æœƒå¿˜ï¼šæ˜¯èª° apply é€™å€‹åœ¨ k8s ä¸Šçš„ï¼Ÿæ˜¯èª°ä¸Šæ¬¡æ¼ apply æ‰€ä»¥å£äº†ï¼Ÿ äººå°±æ˜¯æœƒå¯«éŒ¯ï¼šèƒ½å¦ apply ç®¡ç†å¤§é‡çš„ label, taint, annotation å®‰å…¨ï¼šapply è®Šæ›´å…§å®¹æ˜¯å¦æœ‰ç¶“éè³‡è¨Šå®‰å…¨çš„ review ç•¶æœå‹™çš„ app code base éƒ½å·²ç¶“ç”¨ chart æ‰“åŒ…ï¼Œä½¿ç”¨ vcs ç®¡ç†å¾Œï¼Œç‚ºä½•ä¾è³´çš„ k8s resource (namespace, secret, label, crd, \u0026hellip;) ä¸éœ€è¦æ¨ä¸Š vcs ç®¡ç†çš„ï¼Ÿ\næœ¬æ¬¡æ¼”è¬›é›†åˆå¹¾å€‹ç®¡ç† k8s çš„ç¯„ä¾‹ï¼Œå°‡ k8s resource ä»¥ code ç®¡ç†ï¼Œæ¨ä¸Š vcsï¼Œä¸¦ä½¿ç”¨ argoCD, secret operator, \u0026hellip; ç­‰å·¥å…·é€²è¡Œç®¡ç†ï¼Œä¾†è®“é¿å…ä½ç´šçš„äººå·¥æ“ä½œéŒ¯èª¤ï¼Œé™ä½åœ˜éšŠæ•´é«”å¤±èª¤ç‡ï¼Œä¸¦é™ä½ k8s admin ç®¡ç†çš„æˆæœ¬ï¼Œæé«˜ç®¡ç†æ•ˆç‡\ntarget group Kubernetes User who want to increase performance in k8s management\n","permalink":"https://chechia.net/posts/2023-10-25-k8s-summit/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2023-10-25T13:20:00Z\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://k8s.ithome.com.tw/2023/session-page/2331\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2023-10-25-k8s-resource-as-code/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"info\"\u003eInfo\u003c/h2\u003e\n\u003cp\u003eTitle: Resource as Code for Kubernetes: stop kubectl apply\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://k8s.ithome.com.tw/CFP\"\u003ehttps://k8s.ithome.com.tw/CFP\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eInfrastrure as Code (IaC) èˆ‡ PaCï¼Œåœ¨è¬ç‰©éƒ½è©² as Code å¾—æ™‚ä»£ï¼Œä½ é‚„åœ¨ä¸æ–·çš„ kubectl apply å—ï¼Ÿ\u003c/p\u003e\n\u003ch2 id=\"æ‰‹å‹•-apply-çš„ç—›é»\"\u003eæ‰‹å‹• apply çš„ç—›é»ï¼š\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eäººå°±æ˜¯æœƒå¿˜ï¼šæ˜¯èª° apply é€™å€‹åœ¨ k8s ä¸Šçš„ï¼Ÿæ˜¯èª°ä¸Šæ¬¡æ¼ apply æ‰€ä»¥å£äº†ï¼Ÿ\u003c/li\u003e\n\u003cli\u003eäººå°±æ˜¯æœƒå¯«éŒ¯ï¼šèƒ½å¦ apply\u003c/li\u003e\n\u003cli\u003eç®¡ç†å¤§é‡çš„ label, taint, annotation\u003c/li\u003e\n\u003cli\u003eå®‰å…¨ï¼šapply è®Šæ›´å…§å®¹æ˜¯å¦æœ‰ç¶“éè³‡è¨Šå®‰å…¨çš„ review\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç•¶æœå‹™çš„ app code base éƒ½å·²ç¶“ç”¨ chart æ‰“åŒ…ï¼Œä½¿ç”¨ vcs ç®¡ç†å¾Œï¼Œç‚ºä½•ä¾è³´çš„ k8s resource (namespace, secret, label, crd, \u0026hellip;) ä¸éœ€è¦æ¨ä¸Š vcs ç®¡ç†çš„ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›é›†åˆå¹¾å€‹ç®¡ç† k8s çš„ç¯„ä¾‹ï¼Œå°‡ k8s resource ä»¥ code ç®¡ç†ï¼Œæ¨ä¸Š vcsï¼Œä¸¦ä½¿ç”¨ argoCD, secret operator, \u0026hellip; ç­‰å·¥å…·é€²è¡Œç®¡ç†ï¼Œä¾†è®“é¿å…ä½ç´šçš„äººå·¥æ“ä½œéŒ¯èª¤ï¼Œé™ä½åœ˜éšŠæ•´é«”å¤±èª¤ç‡ï¼Œä¸¦é™ä½ k8s admin ç®¡ç†çš„æˆæœ¬ï¼Œæé«˜ç®¡ç†æ•ˆç‡\u003c/p\u003e","title":"Kubernetes Summit: Resource as Code for Kubernetes: Stop kubectl apply"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay ??: Integrated Backend é›†æˆå­˜å„²\nVault æ”¯æ´å¤šç¨®å­˜å„²é¸é …ï¼Œç”¨æ–¼æŒä¹…å­˜å„² Vault è³‡è¨Šã€‚è‡ª Vault 1.4 èµ·ï¼Œæä¾›äº†æ•´åˆå¼å­˜å„²é¸é …ã€‚æ­¤å­˜å„²å¾Œç«¯ä¸ä¾è³´æ–¼ä»»ä½•ç¬¬ä¸‰æ–¹ç³»çµ±ï¼Œå¯¦ç¾é«˜å¯ç”¨æ€§èªç¾©ï¼Œæ”¯æ´ä¼æ¥­è¤‡è£½åŠŸèƒ½ï¼Œä¸¦æä¾›å‚™ä»½/é‚„åŸå·¥ä½œæµã€‚\nè©²é¸é …å°‡ Vault çš„æ•¸æ“šå­˜å„²åœ¨æœå‹™å™¨çš„æ–‡ä»¶ç³»çµ±ä¸Šï¼Œä¸¦ä½¿ç”¨å…±è­˜å”è­°å°‡æ•¸æ“šè¤‡è£½åˆ°é›†ç¾¤ä¸­çš„æ¯å€‹æœå‹™å™¨ã€‚æœ‰é—œæ•´åˆå¼å­˜å„²å…§éƒ¨çš„æ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–±æ•´åˆå¼å­˜å„²å…§éƒ¨æ–‡æª”ã€‚æ­¤å¤–ï¼Œé…ç½®æ–‡æª”å¯ä»¥å¹«åŠ©é…ç½® Vault ä»¥ä½¿ç”¨æ•´åˆå¼å­˜å„²ã€‚\nä»¥ä¸‹å„ç¯€å°‡è©³ç´°ä»‹ç´¹å¦‚ä½•ä½¿ç”¨æ•´åˆå¼å­˜å„²æ“ä½œ Vaultã€‚\næœå‹™å™¨é–“é€šä¿¡ ä¸€æ—¦ç¯€é»åŠ å…¥åˆ°å½¼æ­¤ï¼Œå®ƒå€‘é–‹å§‹ä½¿ç”¨ Vault çš„å¢é›†ç«¯å£é€²è¡Œ mTLS é€šä¿¡ã€‚å¢é›†ç«¯å£çš„é»˜èªå€¼ç‚º 8201ã€‚TLS ä¿¡æ¯åœ¨åŠ å…¥æ™‚äº¤æ›ï¼Œä¸¦æŒ‰ä¸€å®šçš„ç¯€å¥é€²è¡Œè¼ªæ›ã€‚\næ•´åˆå¼å­˜å„²çš„è¦æ±‚ä¹‹ä¸€æ˜¯å¿…é ˆè¨­ç½® cluster_addr é…ç½®é¸é …ã€‚é€™å…è¨± Vault åœ¨åŠ å…¥æ™‚ç‚ºç¯€é» ID åˆ†é…åœ°å€ã€‚\nå¢é›†æˆå“¡è³‡æ ¼ æœ¬ç¯€å°‡æ¦‚è¿°å¦‚ä½•å¼•å°å’Œç®¡ç†é‹è¡Œæ•´åˆå¼å­˜å„²çš„ Vault ç¯€é»é›†ç¾¤ã€‚\næ•´åˆå¼å­˜å„²åœ¨åˆå§‹åŒ–éç¨‹ä¸­å¼•å°ï¼Œä¸¦ä¸”çµæœæ˜¯å¤§å°ç‚º 1 çš„é›†ç¾¤ã€‚æ ¹æ“šæ‰€éœ€çš„éƒ¨ç½²å¤§å°ï¼Œå¯ä»¥å°‡ç¯€é»åŠ å…¥åˆ°æ´»å‹• Vault ç¯€é»ä¸­ã€‚\nåŠ å…¥ç¯€é» åŠ å…¥æ˜¯å°‡æœªåˆå§‹åŒ–çš„ Vault ç¯€é»ä¸¦ä½¿å…¶æˆç‚ºç¾æœ‰é›†ç¾¤æˆå“¡çš„éç¨‹ã€‚ç‚ºäº†å°‡æ–°ç¯€é»é©—è­‰åˆ°é›†ç¾¤ï¼Œå®ƒå¿…é ˆä½¿ç”¨ç›¸åŒçš„å¯†å°æ©Ÿåˆ¶ã€‚å¦‚æœä½¿ç”¨è‡ªå‹•è§£å°ï¼Œå‰‡å¿…é ˆé…ç½®æ–°ç¯€é»ä»¥ä½¿ç”¨èˆ‡å…¶å˜—è©¦åŠ å…¥çš„é›†ç¾¤ç›¸åŒçš„ KMS æä¾›ç¨‹åºå’Œå¯†é‘°ã€‚å¦‚æœä½¿ç”¨ Shamir å¯†å°ï¼Œå‰‡å¿…é ˆåœ¨åŠ å…¥éç¨‹å®Œæˆä¹‹å‰ç‚ºæ–°ç¯€é»æä¾›è§£å°å¯†é‘°ã€‚ä¸€æ—¦ç¯€é»æˆåŠŸåŠ å…¥ï¼Œä¾†è‡ªæ´»å‹•ç¯€é»çš„æ•¸æ“šå°±å¯ä»¥é–‹å§‹è¤‡åˆ¶åˆ°å®ƒã€‚ä¸€æ—¦ç¯€é»åŠ å…¥ï¼Œå‰‡ä¸èƒ½é‡æ–°åŠ å…¥åˆ°ä¸åŒçš„é›†ç¾¤ã€‚\næ‚¨å¯ä»¥é€šéé…ç½®æ–‡ä»¶è‡ªå‹•åŠ å…¥ç¯€é»ï¼Œä¹Ÿå¯ä»¥é€šé API æ‰‹å‹•åŠ å…¥ï¼ˆä¸‹é¢æè¿°äº†é€™å…©ç¨®æ–¹æ³•ï¼‰ã€‚åœ¨åŠ å…¥ç¯€é»æ™‚ï¼Œå¿…é ˆä½¿ç”¨é ˜å°ç¯€é»çš„ API åœ°å€ã€‚æˆ‘å€‘å»ºè­°åœ¨æ‰€æœ‰ç¯€é»ä¸Šè¨­ç½® api_addr é…ç½®é¸é …ï¼Œä»¥ä½¿åŠ å…¥éç¨‹æ›´ç°¡å–®ã€‚\nretry_join é…ç½® æ­¤æ–¹æ³•å…è¨±åœ¨é…ç½®æ–‡ä»¶ä¸­è¨­ç½®ä¸€å€‹æˆ–å¤šå€‹ç›®æ¨™é ˜å°ç¯€é»ã€‚ç•¶æœªåˆå§‹åŒ–çš„ Vault æœå‹™å™¨å•Ÿå‹•æ™‚ï¼Œå®ƒå°‡å˜—è©¦åŠ å…¥æ¯å€‹å·²å®šç¾©çš„æ½›åœ¨é ˜å°è€…ï¼Œç›´åˆ°æˆåŠŸã€‚ç•¶æŒ‡å®šçš„é ˜å°è€…ä¹‹ä¸€è®Šç‚ºæ´»å‹•ç‹€æ…‹æ™‚ï¼Œæ­¤ç¯€é»å°‡æˆåŠŸåŠ å…¥ã€‚ç•¶ä½¿ç”¨ Shamir å¯†å°æ™‚ï¼Œå·²åŠ å…¥çš„ç¯€é»ä»ç„¶éœ€è¦æ‰‹å‹•è§£å°ã€‚ç•¶ä½¿ç”¨è‡ªå‹•è§£å°æ™‚ï¼Œç¯€é»å°‡èƒ½å¤ è‡ªå‹•åŠ å…¥ä¸¦è‡ªå‹•è§£å°ã€‚\nä¸‹é¢æ˜¯ä¸€å€‹ç¤ºä¾‹ retry_join é…ç½®ï¼š\nstorage \u0026quot;raft\u0026quot; { path = \u0026quot;/var/raft/\u0026quot; node_id = \u0026quot;node3\u0026quot; retry_join { leader_api_addr = \u0026quot;https://node1.vault.local:8200\u0026quot; } retry_join { leader_api_addr = \u0026quot;https://node2.vault.local:8200\u0026quot; } } storage \u0026quot;raft\u0026quot; { path = \u0026quot;/var/raft/\u0026quot; node_id = \u0026quot;node3\u0026quot; retry_join { auto_join = \u0026quot;provider=aws region=eu-west-1 tag_key=vault tag_value=... access_key_id=... secret_access_key=...\u0026quot; } } chatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/concepts/integrated-storage å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-10-10-vault-workshop-integrated-storage/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day--integrated-backend\"\u003eDay ??: Integrated Backend\u003c/h1\u003e\n\u003cp\u003eé›†æˆå­˜å„²\u003c/p\u003e\n\u003cp\u003eVault æ”¯æ´å¤šç¨®å­˜å„²é¸é …ï¼Œç”¨æ–¼æŒä¹…å­˜å„² Vault è³‡è¨Šã€‚è‡ª Vault 1.4 èµ·ï¼Œæä¾›äº†æ•´åˆå¼å­˜å„²é¸é …ã€‚æ­¤å­˜å„²å¾Œç«¯ä¸ä¾è³´æ–¼ä»»ä½•ç¬¬ä¸‰æ–¹ç³»çµ±ï¼Œå¯¦ç¾é«˜å¯ç”¨æ€§èªç¾©ï¼Œæ”¯æ´ä¼æ¥­è¤‡è£½åŠŸèƒ½ï¼Œä¸¦æä¾›å‚™ä»½/é‚„åŸå·¥ä½œæµã€‚\u003c/p\u003e\n\u003cp\u003eè©²é¸é …å°‡ Vault çš„æ•¸æ“šå­˜å„²åœ¨æœå‹™å™¨çš„æ–‡ä»¶ç³»çµ±ä¸Šï¼Œä¸¦ä½¿ç”¨å…±è­˜å”è­°å°‡æ•¸æ“šè¤‡è£½åˆ°é›†ç¾¤ä¸­çš„æ¯å€‹æœå‹™å™¨ã€‚æœ‰é—œæ•´åˆå¼å­˜å„²å…§éƒ¨çš„æ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–±æ•´åˆå¼å­˜å„²å…§éƒ¨æ–‡æª”ã€‚æ­¤å¤–ï¼Œé…ç½®æ–‡æª”å¯ä»¥å¹«åŠ©é…ç½® Vault ä»¥ä½¿ç”¨æ•´åˆå¼å­˜å„²ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹å„ç¯€å°‡è©³ç´°ä»‹ç´¹å¦‚ä½•ä½¿ç”¨æ•´åˆå¼å­˜å„²æ“ä½œ Vaultã€‚\u003c/p\u003e\n\u003cp\u003eæœå‹™å™¨é–“é€šä¿¡\nä¸€æ—¦ç¯€é»åŠ å…¥åˆ°å½¼æ­¤ï¼Œå®ƒå€‘é–‹å§‹ä½¿ç”¨ Vault çš„å¢é›†ç«¯å£é€²è¡Œ mTLS é€šä¿¡ã€‚å¢é›†ç«¯å£çš„é»˜èªå€¼ç‚º 8201ã€‚TLS ä¿¡æ¯åœ¨åŠ å…¥æ™‚äº¤æ›ï¼Œä¸¦æŒ‰ä¸€å®šçš„ç¯€å¥é€²è¡Œè¼ªæ›ã€‚\u003c/p\u003e\n\u003cp\u003eæ•´åˆå¼å­˜å„²çš„è¦æ±‚ä¹‹ä¸€æ˜¯å¿…é ˆè¨­ç½® cluster_addr é…ç½®é¸é …ã€‚é€™å…è¨± Vault åœ¨åŠ å…¥æ™‚ç‚ºç¯€é» ID åˆ†é…åœ°å€ã€‚\u003c/p\u003e\n\u003cp\u003eå¢é›†æˆå“¡è³‡æ ¼\næœ¬ç¯€å°‡æ¦‚è¿°å¦‚ä½•å¼•å°å’Œç®¡ç†é‹è¡Œæ•´åˆå¼å­˜å„²çš„ Vault ç¯€é»é›†ç¾¤ã€‚\u003c/p\u003e\n\u003cp\u003eæ•´åˆå¼å­˜å„²åœ¨åˆå§‹åŒ–éç¨‹ä¸­å¼•å°ï¼Œä¸¦ä¸”çµæœæ˜¯å¤§å°ç‚º 1 çš„é›†ç¾¤ã€‚æ ¹æ“šæ‰€éœ€çš„éƒ¨ç½²å¤§å°ï¼Œå¯ä»¥å°‡ç¯€é»åŠ å…¥åˆ°æ´»å‹• Vault ç¯€é»ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003eåŠ å…¥ç¯€é»\nåŠ å…¥æ˜¯å°‡æœªåˆå§‹åŒ–çš„ Vault ç¯€é»ä¸¦ä½¿å…¶æˆç‚ºç¾æœ‰é›†ç¾¤æˆå“¡çš„éç¨‹ã€‚ç‚ºäº†å°‡æ–°ç¯€é»é©—è­‰åˆ°é›†ç¾¤ï¼Œå®ƒå¿…é ˆä½¿ç”¨ç›¸åŒçš„å¯†å°æ©Ÿåˆ¶ã€‚å¦‚æœä½¿ç”¨è‡ªå‹•è§£å°ï¼Œå‰‡å¿…é ˆé…ç½®æ–°ç¯€é»ä»¥ä½¿ç”¨èˆ‡å…¶å˜—è©¦åŠ å…¥çš„é›†ç¾¤ç›¸åŒçš„ KMS æä¾›ç¨‹åºå’Œå¯†é‘°ã€‚å¦‚æœä½¿ç”¨ Shamir å¯†å°ï¼Œå‰‡å¿…é ˆåœ¨åŠ å…¥éç¨‹å®Œæˆä¹‹å‰ç‚ºæ–°ç¯€é»æä¾›è§£å°å¯†é‘°ã€‚ä¸€æ—¦ç¯€é»æˆåŠŸåŠ å…¥ï¼Œä¾†è‡ªæ´»å‹•ç¯€é»çš„æ•¸æ“šå°±å¯ä»¥é–‹å§‹è¤‡åˆ¶åˆ°å®ƒã€‚ä¸€æ—¦ç¯€é»åŠ å…¥ï¼Œå‰‡ä¸èƒ½é‡æ–°åŠ å…¥åˆ°ä¸åŒçš„é›†ç¾¤ã€‚\u003c/p\u003e\n\u003cp\u003eæ‚¨å¯ä»¥é€šéé…ç½®æ–‡ä»¶è‡ªå‹•åŠ å…¥ç¯€é»ï¼Œä¹Ÿå¯ä»¥é€šé API æ‰‹å‹•åŠ å…¥ï¼ˆä¸‹é¢æè¿°äº†é€™å…©ç¨®æ–¹æ³•ï¼‰ã€‚åœ¨åŠ å…¥ç¯€é»æ™‚ï¼Œå¿…é ˆä½¿ç”¨é ˜å°ç¯€é»çš„ API åœ°å€ã€‚æˆ‘å€‘å»ºè­°åœ¨æ‰€æœ‰ç¯€é»ä¸Šè¨­ç½® api_addr é…ç½®é¸é …ï¼Œä»¥ä½¿åŠ å…¥éç¨‹æ›´ç°¡å–®ã€‚\u003c/p\u003e\n\u003cp\u003eretry_join é…ç½®\næ­¤æ–¹æ³•å…è¨±åœ¨é…ç½®æ–‡ä»¶ä¸­è¨­ç½®ä¸€å€‹æˆ–å¤šå€‹ç›®æ¨™é ˜å°ç¯€é»ã€‚ç•¶æœªåˆå§‹åŒ–çš„ Vault æœå‹™å™¨å•Ÿå‹•æ™‚ï¼Œå®ƒå°‡å˜—è©¦åŠ å…¥æ¯å€‹å·²å®šç¾©çš„æ½›åœ¨é ˜å°è€…ï¼Œç›´åˆ°æˆåŠŸã€‚ç•¶æŒ‡å®šçš„é ˜å°è€…ä¹‹ä¸€è®Šç‚ºæ´»å‹•ç‹€æ…‹æ™‚ï¼Œæ­¤ç¯€é»å°‡æˆåŠŸåŠ å…¥ã€‚ç•¶ä½¿ç”¨ Shamir å¯†å°æ™‚ï¼Œå·²åŠ å…¥çš„ç¯€é»ä»ç„¶éœ€è¦æ‰‹å‹•è§£å°ã€‚ç•¶ä½¿ç”¨è‡ªå‹•è§£å°æ™‚ï¼Œç¯€é»å°‡èƒ½å¤ è‡ªå‹•åŠ å…¥ä¸¦è‡ªå‹•è§£å°ã€‚\u003c/p\u003e","title":"Vault Workshop ??: Integrated Storage"},{"content":" æ´»å‹•æ™‚é–“: 2023-09-26T13:20:00Z æ´»å‹•é€£çµ Facebook Twitter æŠ•å½±ç‰‡ HashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢ æœ¬æ¬¡æ¼”è¬›å¾å°å…¥ HashiCorp Vault ä½œç‚ºèµ·é»ï¼Œç›´æ¥æä¾›å¯¦å‹™ä¸Šç¶“é©—ï¼Œåˆ†äº«å»ºè­°çš„è¨­å®šèˆ‡è·¯ä¸Šå¯èƒ½æœ‰çš„é›·ã€‚\nVault å…¥å‘çš„å›°é›£ Vault + Terraform ä¸€å…¥å‘å°± IaC mount path + role + policy å‘½åèˆ‡ç®¡ç† å‡ç´šèˆ‡ç¶­è­· æœƒä¾æ“šä¼æ¥­éœ€æ±‚æä¾›å¯¦éš›ç”¨ä¾‹ demoï¼Œç•¶å¤©æä¾› github code example ä¸­éš\né æœŸè½çœ¾æ˜¯æœ‰ Vault ä½¿ç”¨ç¶“é©—ï¼Œå¸Œæœ›èƒ½æ›´æœ‰æ•ˆç‡ç®¡ç† Vault çš„äºº ä¸æœƒè¬›å¤ªå¤šåŸºæœ¬åŠŸèƒ½ä»‹ç´¹ vault ä»‹ç´¹ ","permalink":"https://chechia.net/posts/2023-09-26-devopsday/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ™‚é–“: 2023-09-26T13:20:00Z\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://devopsdays.tw/2023/session-page/2279\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFacebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/slides/2023-09-26-devopsday-2023-vault/\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"hashicorp-vault-è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢\"\u003eHashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢\u003c/h2\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›å¾å°å…¥ HashiCorp Vault ä½œç‚ºèµ·é»ï¼Œç›´æ¥æä¾›å¯¦å‹™ä¸Šç¶“é©—ï¼Œåˆ†äº«å»ºè­°çš„è¨­å®šèˆ‡è·¯ä¸Šå¯èƒ½æœ‰çš„é›·ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eVault å…¥å‘çš„å›°é›£\u003c/li\u003e\n\u003cli\u003eVault + Terraform ä¸€å…¥å‘å°± IaC\u003c/li\u003e\n\u003cli\u003emount path + role + policy å‘½åèˆ‡ç®¡ç†\u003c/li\u003e\n\u003cli\u003eå‡ç´šèˆ‡ç¶­è­·\u003c/li\u003e\n\u003cli\u003eæœƒä¾æ“šä¼æ¥­éœ€æ±‚æä¾›å¯¦éš›ç”¨ä¾‹ demoï¼Œç•¶å¤©æä¾› github code example\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸­éš\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé æœŸè½çœ¾æ˜¯æœ‰ Vault ä½¿ç”¨ç¶“é©—ï¼Œå¸Œæœ›èƒ½æ›´æœ‰æ•ˆç‡ç®¡ç† Vault çš„äºº\u003c/li\u003e\n\u003cli\u003eä¸æœƒè¬›å¤ªå¤šåŸºæœ¬åŠŸèƒ½ä»‹ç´¹ vault ä»‹ç´¹\u003c/li\u003e\n\u003c/ul\u003e","title":"DevOpsDay: HashiCorp Vault è‡ªå»ºé‡‘é‘°ç®¡ç†æœ€ä½³å…¥å‘å§¿å‹¢"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 09: Deploy with Docker Local with Docker minikube r=https://api.github.com/repos/kubernetes/minikube/releases curl -LO $(curl -s $r | grep -o 'http.*download/v.*beta.*/minikube-darwin-arm64' | head -n1) sudo install minikube-darwin-arm64 /usr/local/bin/minikube å¦‚ä½•é¸æ“‡ VM or Docker or Kubernetes å‡è­°é¡Œ\nchatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/install å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-09-21-vault-workshop-deploy-on-kubernetes/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-09-deploy-with-docker\"\u003eDay 09: Deploy with Docker\u003c/h1\u003e\n\u003ch3 id=\"local-with-docker\"\u003eLocal with Docker\u003c/h3\u003e\n\u003ch3 id=\"minikube\"\u003eminikube\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003er=https://api.github.com/repos/kubernetes/minikube/releases\ncurl -LO $(curl -s $r | grep -o 'http.*download/v.*beta.*/minikube-darwin-arm64' | head -n1)\nsudo install minikube-darwin-arm64 /usr/local/bin/minikube\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"å¦‚ä½•é¸æ“‡-vm-or-docker-or-kubernetes\"\u003eå¦‚ä½•é¸æ“‡ VM or Docker or Kubernetes\u003c/h3\u003e\n\u003cp\u003eå‡è­°é¡Œ\u003c/p\u003e\n\u003ch3 id=\"chatgpt\"\u003echatGPT\u003c/h3\u003e\n\u003cp\u003eæœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯\n\u003ca href=\"https://developer.hashicorp.com/vault/docs/install\"\u003ehttps://developer.hashicorp.com/vault/docs/install\u003c/a\u003e\nå…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\u003c/p\u003e\n\u003cp\u003ebase context\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eæˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚\n\nå¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eresult correction\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eéƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚\n\nä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚\n\u003c/code\u003e\u003c/pre\u003e","title":"Vault Workshop 10: Deploy with Docker"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 09: Deploy with Docker Vault configuration chatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/install å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-09-20-vault-workshop-ha-docker/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-09-deploy-with-docker\"\u003eDay 09: Deploy with Docker\u003c/h1\u003e\n\u003ch3 id=\"vault-configuration\"\u003eVault configuration\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"chatgpt\"\u003echatGPT\u003c/h3\u003e\n\u003cp\u003eæœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯\n\u003ca href=\"https://developer.hashicorp.com/vault/docs/install\"\u003ehttps://developer.hashicorp.com/vault/docs/install\u003c/a\u003e\nå…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\u003c/p\u003e\n\u003cp\u003ebase context\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eæˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚\n\nå¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eresult correction\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eéƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚\n\nä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚\n\u003c/code\u003e\u003c/pre\u003e","title":"Vault Workshop 09: Vault HA"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 08: Vault in Docker and Initialization Vault in container å‰å¹¾å¤©æˆ‘å€‘ä½¿ç”¨ vault dev Server ä¾†å•Ÿç”¨æ¸¬è©¦ç”¨çš„ Vault serverã€‚\nåœ¨ production ç’°å¢ƒæˆ‘å€‘ä¸æœƒä½¿ç”¨ dev Serverã€‚Vault æä¾›è¨±å¤šå®‰è£æ–¹æ³•\nå¯ä»¥ä½¿ç”¨ binary ç›´æ¥å®‰è£åœ¨VMä¸Š ä¹Ÿå¯ä»¥é€é hashicorp/vault official docker imageï¼Œåœ¨container ç’°å¢ƒä¸­åŸ·è¡Œ æˆ–æ˜¯ä½¿ç”¨ hashicorp official helm chartï¼Œå®‰è£åœ¨kuberntesä¸Š ä½¿ç”¨ç¯„ä¾‹ repository ä½ å¯ä»¥ä½¿ç”¨ç­†è€…æº–å‚™çš„ç¯„ä¾‹ repository https://github.com/chechiachang/vault-playground\ngit clone git@github.com:chechiachang/vault-playground.git cd deploy/00-docker-dev/ ä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤å•Ÿå‹• vault in docker\nä¸¦ä½¿ç”¨ -v flag ä¾†æ›è¼‰ ./config/ volume åˆ° container ä¸­çš„ /vault/config.d/ docker run --cap-add=IPC_LOCK \\ --volume ./vault/config/:/vault/config.d \\ --volume ./vault/file/:/vault/file \\ --volume ./vault/logs/:/vault/logs \\ -p 8200:8200 \\ --name vault_1 \\ -d \\ hashicorp/vault:1.14.3 \\ vault server -config=/vault/config.d/vault.hcl ç„¶å¾Œä½¿ç”¨ docker logs æŒ‡ä»¤æª¢è¦– vault server log\ndocker logs -f vault_1 output\n==\u0026gt; Vault server configuration: Administrative Namespace: Api Address: https://0.0.0.0:8200 Cgo: disabled Cluster Address: https://0.0.0.0:8201 Environment Variables: GODEBUG, GOTRACEBACK, HOME, HOSTNAME, NAME, PATH, PWD, SHLVL, VERSION Go Version: go1.20.8 Listener 1: tcp (addr: \u0026quot;0.0.0.0:8200\u0026quot;, cluster address: \u0026quot;0.0.0.0:8201\u0026quot;, max_request_duration: \u0026quot;1m30s\u0026quot;, max_request_size: \u0026quot;33554432\u0026quot;, tls: \u0026quot;disabled\u0026quot;) Log Level: Mlock: supported: true, enabled: false Recovery Mode: false Storage: file Version: Vault v1.14.3, built 2023-09-11T21:23:55Z Version Sha: 56debfa71653e72433345f23cd26276bc90629ce ==\u0026gt; Vault server started! Log data will stream in below: 2023-09-20T13:38:25.914Z [INFO] proxy environment: http_proxy=\u0026quot;\u0026quot; https_proxy=\u0026quot;\u0026quot; no_proxy=\u0026quot;\u0026quot; 2023-09-20T13:38:25.920Z [INFO] core: Initializing version history cache for core ä½ æœƒç™¼ç¾ï¼Œvault server ä¸æ˜¯ä»¥ dev server çš„ç‹€æ…‹å•Ÿå‹•çš„ï¼Œéœ€è¦é€²è¡Œé¡å¤–çš„åˆå§‹åŒ–è¨­å®š\nexport VAULT_ADDR='http://127.0.0.1:8200' æª¢æŸ¥ vault status\nvault status outputï¼Œé¡¯ç¤ºä¸€å€‹ä¸Šæœªåˆå§‹åŒ–çš„ vault server èˆ‡å…¶ storage backend \u0026ldquo;filesyste\u0026rdquo;\nå¯ä»¥åœ¨ ./vault/config/vault.hcl ä¸Šçœ‹åˆ°æˆ‘å€‘ä½¿ç”¨æ–°çš„ Storage Backend \u0026ldquo;file\u0026rdquo; è¨­å®š vault server çš„ storage backend ç›®å‰æ˜¯ sealed ç‹€æ…‹ ä¸æ˜¯ vault server sealedï¼Œè€Œæ˜¯æ²’æœ‰æä¾› vault server åˆå§‹åŒ–è¨­å®š / unseal keysï¼Œæ‰€ä»¥ vault server ç„¡æ³•è§£å¯† storage backend Key Value --- ----- Seal Type shamir Initialized false Sealed true Total Shares 0 Threshold 0 Unseal Progress 0/0 Unseal Nonce n/a Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type file HA Enabled false Storage Backend: filesystem https://developer.hashicorp.com/vault/docs/configuration/storage/filesystem\nfilesystem storage backendå°‡ Vault çš„è³‡æ–™å­˜å„²åœ¨æ–‡ä»¶ç³»çµ±ä¸Šï¼Œä½¿ç”¨æ¨™æº–çš„ç›®éŒ„çµæ§‹ã€‚\nå®ƒå¯ä»¥ç”¨æ–¼æŒä¹…çš„Single Serveræƒ…æ³ï¼Œæˆ–è€…åœ¨æœ¬åœ°é–‹ç™¼æ™‚ï¼Œè€ä¹…æ€§ä¸æ˜¯é—œéµå•é¡Œçš„æƒ…æ³ä¸‹ä½¿ç”¨ã€‚\nfilesystem storage backend ä¸æ”¯æ´é«˜å¯ç”¨æ€§ - æª”æ¡ˆç³»çµ±å¾Œç«¯ä¸æ”¯æ´é«˜å¯ç”¨æ€§ã€‚\nfilesystem storage backend ç”±HashiCorp å®˜æ–¹æ”¯æ´ - æª”æ¡ˆç³»çµ±å¾Œç«¯æ˜¯ç”± HashiCorp å®˜æ–¹æ”¯æ´ç¶­è­·çš„ã€‚\nåˆå§‹åŒ– Vault åˆå§‹åŒ–æ˜¯é…ç½® Vault çš„éç¨‹ã€‚åƒ…å°ç¬¬ä¸€æ¬¡ä½¿ç”¨åœ¨ Vault server ä¸Šçš„ Backend ä¸ŠåŸ·è¡Œä¸€æ¬¡ã€‚åœ¨é«˜å¯ç”¨(HA)æ¨¡å¼ä¸‹é‹è¡Œæ™‚ï¼Œé€™åƒ…åœ¨æ¯å€‹å¢é›†(Vault Cluster)ä¸­åŸ·è¡Œä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯å°Serverã€‚\nåœ¨åˆå§‹åŒ–æœŸé–“ï¼Œå°‡ç”ŸæˆåŠ å¯†é‡‘é‘°ã€å‰µå»º unseal keysï¼Œä¸¦å‰µå»º init root tokenã€‚\nåˆå§‹åŒ–ä¸éœ€èº«ä»½é©—è­‰ï¼Œåƒ…é©ç”¨æ–¼å…¨æ–°çš„ Vaultï¼Œæœ‰è³‡æ–™å­˜åœ¨çš„ Storage Backend ç„¡æ³•ç”¨åˆå§‹åŒ–è§£é–ã€‚\nè¦åˆå§‹åŒ– Vaultï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤\nvault operator init output\nUnseal Key 1: 9AYJ...kNCn Unseal Key 2: RqDx...odRU Unseal Key 3: uHUv...lws4 Unseal Key 4: f+KD...aHgL Unseal Key 5: AKyF...e6vd Initial Root Token: hvs.8yU3...7esX Vault initialized with 5 key shares and a key threshold of 3. Please securely distribute the key shares printed above. When the Vault is re-sealed, restarted, or stopped, you must supply at least 3 of these keys to unseal it before it can start servicing requests. # Vault ä½¿ç”¨äº† 5 å€‹é‡‘é‘°ä»½é¡encryption key shareå’Œ 3 çš„ key threshold é€²è¡Œåˆå§‹åŒ–ã€‚è«‹å®‰å…¨åœ°åˆ†ç™¼ä¸Šé¢çš„é‡‘é‘°ä»½é¡ã€‚ # ç•¶ Vault è¢«é‡æ–°å¯†å°ã€é‡æ–°å•Ÿå‹•æˆ–åœæ­¢æ™‚ï¼Œä½ å¿…é ˆæä¾›è‡³å°‘ 3 å€‹é€™äº›é‡‘é‘°ä¾†å°å…¶é€²è¡Œè§£å°ï¼Œç„¶å¾Œå®ƒæ‰èƒ½é–‹å§‹è™•ç†è«‹æ±‚ã€‚ Vault does not store the generated root key. Without at least 3 keys to reconstruct the root key, Vault will remain permanently sealed! # Vault ä¸å­˜å„²ç”Ÿæˆçš„æ ¹é‡‘é‘°ã€‚å¦‚æœæ²’æœ‰è‡³å°‘ 3 å€‹é‡‘é‘°ä¾†é‡å»ºæ ¹é‡‘é‘°ï¼ŒVault å°‡ä¿æŒæ°¸ä¹…å¯†å°ï¼ It is possible to generate new unseal keys, provided you have a quorum of existing unseal keys shares. See \u0026quot;vault operator rekey\u0026quot; for more information. # å¦‚æœä½ æœ‰è¶³å¤ çš„ç¾æœ‰è§£å°é‡‘é‘°ä»½é¡ï¼Œå‰‡å¯ä»¥ç”Ÿæˆæ–°çš„è§£å°é‡‘é‘°ã€‚æœ‰é—œæ›´å¤šä¿¡æ¯ï¼Œè«‹åƒé–± \u0026quot;vault operator rekey\u0026quot;ã€‚ åˆå§‹åŒ–éç¨‹è¼¸å‡ºäº†å…©å€‹éå¸¸é‡è¦çš„ä¿¡æ¯ï¼šè§£å°é‡‘é‘°å’Œ init root tokenã€‚é€™æ˜¯å”¯ä¸€ä¸€æ¬¡ Vault é¡¯ç¤ºé€™äº›è³‡æ–™ã€‚\nç‚ºäº†é€™å€‹å…¥é–€èª²ç¨‹ï¼Œè«‹å°‡é€™äº›é‡‘é‘°ä¿å­˜åœ¨æŸå€‹åœ°æ–¹ï¼Œç„¶å¾Œç¹¼çºŒé€²è¡Œæ“ä½œã€‚\nVault backend storage èª key ä¸èªäººï¼Œè«‹æ”¶å¥½é€™äº”éš» unseal keyï¼Œæ”¾ç½®åœ¨äº”å€‹ä¸åŒå®‰å…¨çš„åœ°æ–¹ æœ‰ 3/5 çš„ unseal key å°±èƒ½é‡å»º encryption keyï¼Œä¹Ÿå°±æ˜¯èƒ½å¤ è§£å¯† storage backend å¯ä»¥ç”¨ 3/5 unseal key ç”¢ç”Ÿ root token vault operator generate-root æ›å¥è©±èªªï¼Œunseal key æ˜¯æ¯” root é‚„å¤§çš„è¶…ç´šç®¡ç†å“¡ key åœ¨å¯¦éš›çš„éƒ¨ç½²æƒ…æ³ä¸‹ï¼Œä½ æ°¸é ä¸æ‡‰è©²å°‡é€™äº›é‡‘é‘°ä¿å­˜åœ¨ä¸€èµ·ã€‚ ä½ å¯èƒ½æœƒä½¿ç”¨ Vault çš„ PGP å’Œ Keybase.io æ”¯æ´ï¼Œä½¿ç”¨ä½¿ç”¨è€…çš„ PGP é‡‘é‘°åŠ å¯†æ¯å€‹è§£å°é‡‘é‘°ã€‚ é€™å¯ä»¥é˜²æ­¢å–®å€‹äººæ“æœ‰æ‰€æœ‰çš„è§£å°é‡‘é‘°ã€‚ vault server logï¼Œå¯ä»¥çœ‹åˆ° vault server é–‹å§‹é€²è¡Œåˆå§‹åŒ–æµç¨‹\n2023-09-20T13:47:05.113Z [INFO] core: security barrier not initialized 2023-09-20T13:47:05.117Z [INFO] core: seal configuration missing, not initialized 2023-09-20T14:03:28.506Z [INFO] core: security barrier not initialized 2023-09-20T14:03:28.512Z [INFO] core: seal configuration missing, not initialized 2023-09-20T14:03:28.521Z [INFO] core: security barrier not initialized 2023-09-20T14:03:28.557Z [INFO] core: security barrier initialized: stored=1 shares=5 threshold=3 2023-09-20T14:03:28.589Z [INFO] core: post-unseal setup starting 2023-09-20T14:03:28.609Z [INFO] core: loaded wrapping token key 2023-09-20T14:03:28.609Z [INFO] core: successfully setup plugin catalog: plugin-directory=\u0026quot;\u0026quot; 2023-09-20T14:03:28.613Z [INFO] core: no mounts; adding default mount table 2023-09-20T14:03:28.629Z [INFO] core: successfully mounted: type=cubbyhole version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=cubbyhole/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:03:28.631Z [INFO] core: successfully mounted: type=system version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=sys/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:03:28.631Z [INFO] core: successfully mounted: type=identity version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=identity/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:03:28.686Z [INFO] core: successfully mounted: type=token version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=token/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:03:28.696Z [INFO] rollback: starting rollback manager 2023-09-20T14:03:28.697Z [INFO] core: restoring leases 2023-09-20T14:03:28.698Z [INFO] expiration: lease restore complete 2023-09-20T14:03:28.713Z [INFO] identity: entities restored 2023-09-20T14:03:28.714Z [INFO] identity: groups restored 2023-09-20T14:03:28.720Z [INFO] core: usage gauge collection is disabled 2023-09-20T14:03:28.733Z [INFO] core: Recorded vault version: vault version=1.14.3 upgrade time=\u0026quot;2023-09-20 14:03:28.720230178 +0000 UTC\u0026quot; build date=2023-09-11T21:23:55Z 2023-09-20T14:03:29.120Z [INFO] core: post-unseal setup complete 2023-09-20T14:03:29.146Z [INFO] core: root token generated 2023-09-20T14:03:29.146Z [INFO] core: pre-seal teardown starting 2023-09-20T14:03:29.146Z [INFO] rollback: stopping rollback manager 2023-09-20T14:03:29.146Z [INFO] core: pre-seal teardown complete ä½ å¯ä»¥åœ¨é€™æ™‚æª¢è¦– ./vault/file è£¡é¢çš„å…§å®¹ï¼Œ./vault/file åœ¨ vault operator init å‰æ˜¯ç©ºç™½çš„\nls -al ./vault/file outputï¼Œå¯ä»¥çœ‹åˆ° ./vault/file å…§å·²ç¶“åˆå§‹åŒ– filesystem storage backend çš„å…§å®¹\ncore logical sys ä½ å¯ä»¥æª¢è¦– ./vault/file/* å…§çš„æª”æ¡ˆå…§å®¹ï¼Œæœƒç™¼ç¾å…§å®¹éƒ½æ˜¯ json ç›¸å®¹æ ¼å¼ï¼Œè€Œä¸”éƒ½ç¶“éåŠ å¯†\nåœ¨æ­£å¸¸çš„æ¢ä»¶ä¸‹ï¼Œæ²’æœ‰ unseal key çš„äººï¼Œæ˜¯ç„¡æ³•åœ¨æœ‰æ•ˆæ™‚é–“å…§è§£é–é€™äº› filesystem ä¸­çš„å…§å®¹ï¼Œå…§å®¹é‚„æ˜¯å—åˆ°ä¿è­· é€™ä¸¦ä¸ä»£è¡¨ä½ å¯ä»¥éš¨æ„æ”¾ç½® filesystem storage backend çš„å…§å®¹ ä¾‹å¦‚å°‡ä»– commit åˆ° repository ä¸­(vault-playground å·²ç¶“æ·»åŠ  .gitignore) è«‹é¸æ“‡å®‰å…¨ï¼Œç¶“é vault è³‡å®‰åœ˜éšŠæ¸¬è©¦éçš„ backendï¼Œä¾†ä¿éšœè³‡æ–™å®‰å…¨èˆ‡å¯ç”¨ç¨‹åº¦ Unseal æ¯å€‹åˆå§‹åŒ–çš„ Vault Server éƒ½å§‹æ–¼å¯†å°ç‹€æ…‹ã€‚æ ¹æ“šé…ç½®ï¼ŒVault å¯ä»¥è¨ªå• storage backendï¼Œä½†å®ƒç„¡æ³•è®€å–å…¶ä¸­çš„ä»»ä½•è³‡æ–™ï¼Œå› ç‚ºå®ƒä¸çŸ¥é“å¦‚ä½•è§£å¯†å®ƒã€‚æ•™æœƒ Vault å¦‚ä½•è§£å¯†æ•¸æ“šç¨±ç‚ºè§£å°(unseal) Vaultã€‚\næ¯æ¬¡ Vault é–‹å§‹é‹è¡Œæ™‚éƒ½å¿…é ˆé€²è¡Œè§£å°ã€‚å¯ä»¥é€šé API å’Œå‘½ä»¤è¡Œä¾†åŸ·è¡Œè§£å°æ“ä½œã€‚\nè¦è§£å° Vaultï¼Œä½ å¿…é ˆæ“æœ‰è§£å°é‡‘é‘°çš„é–¾å€¼æ•¸é‡(threshold)ã€‚åœ¨ä¸Šé¢çš„è¼¸å‡ºä¸­ï¼Œè«‹æ³¨æ„ \u0026ldquo;key threshold\u0026rdquo; æ˜¯ 3ã€‚é€™æ„å‘³è‘—è¦è§£å° Vaultï¼Œä½ éœ€è¦ 5 å€‹ç”Ÿæˆçš„é‡‘é‘°ä¸­çš„ 3 å€‹ã€‚\næ³¨æ„\nVault ä¸å­˜å„²ä»»ä½•è§£å°é‡‘é‘°ç‰‡æ®µ(key share)ã€‚Vault ä½¿ç”¨ä¸€ç¨®ç¨±ç‚º Shamir\u0026rsquo;s Secret Sharing çš„ç®—æ³•ä¾†å°‡ root encryption key åˆ†æˆç‰‡æ®µ(share)ã€‚åªæœ‰æ“æœ‰thresholdæ•¸é‡çš„é‡‘é‘°ï¼Œæ‰èƒ½å°‡å…¶é‡å»ºï¼Œæœ€çµ‚è¨ªå•ä½ çš„è³‡æ–™ã€‚\né–‹å§‹è§£å° Vaultï¼š\nvault operator unseal output\nUnseal Key (will be hidden): Key Value --- ----- Seal Type shamir Initialized true Sealed true Total Shares 5 Threshold 3 Unseal Progress 1/3 Unseal Nonce 9d03a4e0-bb4f-cfd5-326b-5afb55fdce53 Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type file HA Enabled false ç¹¼çºŒæ“ä½œï¼Œè¼¸å…¥3/5æŠŠ unseal key å°±å¯é †åˆ©è§£å° storage backend\nUnseal Key (will be hidden): Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 5 Threshold 3 Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type file Cluster Name vault-cluster-f90273e8 Cluster ID 5ecc63c9-11eb-c384-355d-dffea2dd6484 HA Enabled false vault server logï¼ŒæˆåŠŸè§£å°å¾Œ\n2023-09-20T14:57:17.077Z [INFO] core.cluster-listener.tcp: starting listener: listener_address=0.0.0.0:8201 2023-09-20T14:57:17.078Z [INFO] core.cluster-listener: serving cluster requests: cluster_listen_address=[::]:8201 2023-09-20T14:57:17.089Z [INFO] core: post-unseal setup starting 2023-09-20T14:57:17.115Z [INFO] core: loaded wrapping token key 2023-09-20T14:57:17.115Z [INFO] core: successfully setup plugin catalog: plugin-directory=\u0026quot;\u0026quot; 2023-09-20T14:57:17.127Z [INFO] core: successfully mounted: type=system version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=sys/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:57:17.128Z [INFO] core: successfully mounted: type=identity version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=identity/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:57:17.128Z [INFO] core: successfully mounted: type=cubbyhole version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=cubbyhole/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:57:17.148Z [INFO] core: successfully mounted: type=token version=\u0026quot;v1.14.3+builtin.vault\u0026quot; path=token/ namespace=\u0026quot;ID: root. Path: \u0026quot; 2023-09-20T14:57:17.154Z [INFO] rollback: starting rollback manager 2023-09-20T14:57:17.154Z [INFO] core: restoring leases 2023-09-20T14:57:17.156Z [INFO] expiration: lease restore complete 2023-09-20T14:57:17.158Z [INFO] identity: entities restored 2023-09-20T14:57:17.159Z [INFO] identity: groups restored 2023-09-20T14:57:17.166Z [INFO] core: usage gauge collection is disabled 2023-09-20T14:57:17.178Z [INFO] core: post-unseal setup complete 2023-09-20T14:57:17.178Z [INFO] core: vault is unsealed Hashicorp Vault docker ä½¿ç”¨å®¹å™¨(container) å‰éœ€è¦æŸ¥é–± image çš„å®˜æ–¹èªªæ˜ https://hub.docker.com/r/hashicorp/vaultï¼Œå¹¾ä»¶äº‹æƒ…è¦æ³¨æ„\nBase Image æ˜¯é¸æ“‡ä½¿ç”¨ Alpineï¼Œæ¯”èµ·å…¶ä»– linux distributions å…·æœ‰ç›¸å°è¼ƒå°çš„å®‰å…¨é¢¨éšªï¼Œä½†åŠŸèƒ½è¶³å¤ ç”¨æ–¼é–‹ç™¼å’Œæ¸¬è©¦ã€‚\nVault å§‹çµ‚åœ¨ dumb-init ä¸‹é‹è¡Œï¼Œå°‡ process èˆ‡ SIG å‚³éçµ¦å®¹å™¨ä¸­é‹è¡Œçš„æ‰€æœ‰processã€‚\nä½¿ç”¨çš„ Binary ç”± HashiCorp æ§‹å»ºï¼Œä¸¦ä½¿ç”¨ GPG é‡‘é‘°ç°½åï¼Œå› æ­¤ä½ å¯ä»¥é©—è­‰Binaryã€‚\nåœ¨ä¸å¸¶ä»»ä½•åƒæ•¸çš„æƒ…æ³ä¸‹é‹è¡Œ Vaultï¼Œå®¹å™¨å°‡ç‚ºä½ æä¾›ä¸€å€‹è™•æ–¼dev modeçš„ Vault Serverã€‚\nå®¹å™¨å…¬é–‹äº†å…©å€‹å¯é¸çš„volumeï¼š\n/vault/logsï¼Œç”¨æ–¼å¯«å…¥ audit logã€‚é è¨­æƒ…æ³ä¸‹ï¼Œé€™è£¡ä¸æœƒå¯«å…¥ä»»ä½•å…§å®¹ï¼›å¿…é ˆåœ¨Vault config ä¸­å•Ÿç”¨æ–‡ä»¶audit backendã€‚\n/vault/fileï¼Œç”¨æ–¼åœ¨ä½¿ç”¨è³‡æ–™storage pluginæ™‚ï¼Œå°‡è³‡æ–™å¯«å…¥persistencyã€‚é è¨­æƒ…æ³ä¸‹ï¼Œé€™è£¡ä¸å¯«å…¥ä»»ä½•å…§å®¹ï¼ˆdev modeä½¿ç”¨ in-memory storageï¼‰ï¼›åœ¨å•Ÿå‹•å®¹å™¨ä¹‹å‰ï¼Œå¿…é ˆåœ¨ Vault çš„é…ç½®ä¸­å•Ÿç”¨æ–‡ä»¶ data storagebackendã€‚\nå®¹å™¨åœ¨ /vault/config è¨­ç½®äº†ä¸€å€‹ Vault é…ç½®ç›®éŒ„ï¼ŒServer å°‡é€šévolumeï¼Œè¼‰å…¥é€™è£¡æ”¾ç½®çš„ä»»ä½• hcl æˆ– json config fileã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä»¥é€šéé€šéç’°å¢ƒè®Šæ•¸ VAULT_LOCAL_CONFIG å‚³éé…ç½® json ä¾†æ·»åŠ configã€‚\nVault configuration å¦‚åŒå‰é¢èªªæ˜ï¼Œé€é --volume ./config/:/vault/config.d flag å°‡ ./config/vault.hcl è¨­å®šæª”æ¡ˆæ›è¼‰é€²å®¹å™¨ä¸­\nä½ å¯ä»¥æª¢è¦–ç›®å‰çš„ vault server configurationï¼Œæ˜¯ä»¥ vault.hcl æ ¼å¼è¡¨ç¤º\ncat ./config/vault.hcl outputï¼Œåœ¨é€™è£¡å¯ä»¥è¨­ç½® vault server çš„å•Ÿå‹•åƒæ•¸\né…ç½®ä¸€å€‹ listener \u0026ldquo;tcp\u0026rdquo;ï¼Œç›£è½å®¹å™¨å…§ 0.0.0.0:8200 é€²ä¾†çš„ request ç”±æ–¼ docker run ä¹Ÿè¨­å®š -p 8200:8200 å°‡ä¸»æ©Ÿç¶²è·¯çš„ 8200 port bind åˆ°å®¹å™¨çš„ 8200 portï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨ä¸»æ©Ÿç¶²è·¯ä¸­å­˜å– vaultã€‚ ui = true disable_mlock = true api_addr = \u0026quot;https://0.0.0.0:8200\u0026quot; default_lease_ttl = \u0026quot;168h\u0026quot; max_lease_ttl = \u0026quot;720h\u0026quot; storage \u0026quot;file\u0026quot; { path = \u0026quot;/vault/file\u0026quot; } listener \u0026quot;tcp\u0026quot; { address = \u0026quot;0.0.0.0:8200\u0026quot; tls_disable = \u0026quot;true\u0026quot; } æ“ä½œ Vault Vault in Docker ä½¿ç”¨èµ·ä¾†èˆ‡é€é binary åŸ·è¡Œçš„ dev server ä¸€æ¨£ã€‚\nä½ å¯ä»¥åƒç…§å‰å¹¾å¤©æ–‡ç« çš„å…§å®¹ï¼Œå° vault server é€²è¡Œæ“åšï¼Œä¹Ÿç®—æ˜¯åšå€‹ç·´ç¿’\nvault login vault secrets list vault secrets enable -version=2 -path=chechia-net kv åœ¨å¾Œé¢çš„å…§å®¹ï¼Œæˆ‘å€‘æœƒç”¨æ›´æœ‰æ•ˆç‡çš„æ–¹å¼ç®¡ç†ï¼Œè¨­å®š vault\né—œé–‰ vault container ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤é—œé–‰ vaultå®¹å™¨\ndocker stop vault_1 outputï¼Œserver æ¥å—åˆ°å¾Œæœƒé€²è¡Œ docker å°é–\n==\u0026gt; Vault shutdown triggered 2023-09-20T13:06:28.627Z [INFO] core: marked as sealed 2023-09-20T13:06:28.627Z [INFO] core: pre-seal teardown starting 2023-09-20T13:06:28.627Z [INFO] rollback: stopping rollback manager 2023-09-20T13:06:28.628Z [INFO] core: pre-seal teardown complete 2023-09-20T13:06:28.628Z [INFO] core: stopping cluster listeners 2023-09-20T13:06:28.628Z [INFO] core.cluster-listener: forwarding rpc listeners stopped 2023-09-20T13:06:28.641Z [INFO] core.cluster-listener: rpc listeners successfully shut down 2023-09-20T13:06:28.641Z [INFO] core: cluster listeners successfully shut down 2023-09-20T13:06:28.641Z [INFO] core: vault is sealed å¦‚æœæœ‰å•Ÿç”¨ storage backend çš„è©±ï¼Œvault è³‡æ–™æˆ–ç•™å­˜åœ¨ storage \u0026ldquo;file\u0026rdquo; ä¸Šï¼Œé‡å•Ÿä¸æœƒå¦‚ dev server in-memory storage ä¸€æ¨£ï¼Œè¢«æ¸…ç©º\nvault operator ä½ å¯ä»¥ä½¿ç”¨ vault operator æŒ‡ä»¤ä¾†åšæ›´å¤š vault cluster ç›¸é—œçš„æ“ä½œ\nvault operator -h ä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ç”¢ç”Ÿæ–°çš„ root token\nvault operator generate-root -generate-otp output\nA One-Time-Password has been generated for you and is shown in the OTP field. You will need this value to decode the resulting root token, so keep it safe. Nonce 13ed8986-7b01-323c-0d06-2c32536fb8c1 Started true Progress 0/3 Complete false OTP eYr...cMqx OTP Length 28 vault server log é¡¯ç¤ºé–‹å§‹ç”¢ç”Ÿ root\n2023-09-20T15:12:08.633Z [INFO] core: root generation initialized: nonce=13ed8986-7b01-323c-0d06-2c32536fb8c1 ä½¿ç”¨ -otp flagï¼Œä¸¦è¼¸å…¥ unseal key\nvault operator generate-root -otp=\u0026quot;...\u0026quot; output\nOperation nonce: 13ed8986-7b01-323c-0d06-2c32536fb8c1 Unseal Key (will be hidden): Nonce 13ed8986-7b01-323c-0d06-2c32536fb8c1 Started true Progress 1/3 Complete false æŒçºŒè¼¸å…¥ 3/5 unseal keysï¼Œç›´åˆ°å–å¾— encoded token\nOperation nonce: 13ed8986-7b01-323c-0d06-2c32536fb8c1 Unseal Key (will be hidden): Nonce 13ed8986-7b01-323c-0d06-2c32536fb8c1 Started true Progress 3/3 Complete true Encoded Token DS8B...MdGw ä½¿ç”¨ otp + encoded token ä¾†é€²è¡Œ decode\nvault operator generate-root \\ -decode=\u0026quot;DS8B...MdGw\u0026quot; \\ -otp=\u0026quot;eYr1...cMqx\u0026quot; output\nhvs.bDKG...Pnlc vault server log é¡¯ç¤ºé€ç”Ÿ root å®Œæˆ\n2023-09-20T15:15:40.541Z [INFO] core: root generation finished: nonce=13ed8986-7b01-323c-0d06-2c32536fb8c1 NOTE: ç¬¬ä¸€æŠŠ init root token é‚„æ˜¯æœ‰æ•ˆï¼ŒåŠ ä¸Šå¾Œä¾†ç”Ÿæˆçš„ç¬¬äºŒæŠŠï¼Œç¾åœ¨æœ‰å…©æŠŠå¸¸æ•ˆæœŸçš„ root token\næ¸…ç©º ä½ å¯ä»¥åˆªé™¤ ./vault/file/ï¼Œå®Œå…¨æ¸…é™¤ vault server ä½¿ç”¨çš„ filesystem storage backend\nrm -rf ./vault/file/* vault server æœ¬èº«å¹¾ä¹æ˜¯ç„¡ç‹€æ…‹ï¼Œæ¸…é™¤ storage backend å¾Œå°±ä»€éº¼ä¹Ÿä¸å‰©äº†\nchatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-deploy https://hub.docker.com/r/hashicorp/vault å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-09-19-vault-workshop-docker-and-initialization/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-08-vault-in-docker-and-initialization\"\u003eDay 08: Vault in Docker and Initialization\u003c/h1\u003e\n\u003ch3 id=\"vault-in-container\"\u003eVault in container\u003c/h3\u003e\n\u003cp\u003eå‰å¹¾å¤©æˆ‘å€‘ä½¿ç”¨ vault dev Server ä¾†å•Ÿç”¨æ¸¬è©¦ç”¨çš„ Vault serverã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ production ç’°å¢ƒæˆ‘å€‘ä¸æœƒä½¿ç”¨ dev Serverã€‚Vault æä¾›è¨±å¤šå®‰è£æ–¹æ³•\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¯ä»¥ä½¿ç”¨ binary ç›´æ¥å®‰è£åœ¨VMä¸Š\u003c/li\u003e\n\u003cli\u003eä¹Ÿå¯ä»¥é€é hashicorp/vault official docker imageï¼Œåœ¨container ç’°å¢ƒä¸­åŸ·è¡Œ\u003c/li\u003e\n\u003cli\u003eæˆ–æ˜¯ä½¿ç”¨ hashicorp official helm chartï¼Œå®‰è£åœ¨kuberntesä¸Š\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"ä½¿ç”¨ç¯„ä¾‹-repository\"\u003eä½¿ç”¨ç¯„ä¾‹ repository\u003c/h3\u003e\n\u003cp\u003eä½ å¯ä»¥ä½¿ç”¨ç­†è€…æº–å‚™çš„ç¯„ä¾‹ repository \u003ca href=\"https://github.com/chechiachang/vault-playground\"\u003ehttps://github.com/chechiachang/vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003egit clone git@github.com:chechiachang/vault-playground.git\n\ncd deploy/00-docker-dev/\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤å•Ÿå‹• vault in docker\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸¦ä½¿ç”¨ -v flag ä¾†æ›è¼‰ ./config/ volume åˆ° container ä¸­çš„ /vault/config.d/\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003edocker run --cap-add=IPC_LOCK \\\n  --volume ./vault/config/:/vault/config.d \\\n  --volume ./vault/file/:/vault/file \\\n  --volume ./vault/logs/:/vault/logs \\\n  -p 8200:8200 \\\n  --name vault_1 \\\n  -d \\\n  hashicorp/vault:1.14.3 \\\n  vault server -config=/vault/config.d/vault.hcl\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç„¶å¾Œä½¿ç”¨ docker logs æŒ‡ä»¤æª¢è¦– vault server log\u003c/p\u003e","title":"Vault Workshop 08: Vault in Docker and Initialization"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 07: Policy \u0026amp; Approle åœ¨ Vault ä¸­ï¼Œç­–ç•¥ï¼ˆPoliciesï¼‰æ§åˆ¶è‘—ä½¿ç”¨è€…å¯ä»¥è¨ªå•çš„è³‡æºã€‚åœ¨ä¸Šä¸€ç¯‡èº«ä»½é©—è­‰ä¸­ï¼Œä½ å·²ç¶“å­¸åˆ°äº†èº«ä»½é©—è­‰æ–¹æ³•(authentication method)ã€‚è€Œé€™ä¸€ç¯€æ˜¯é—œæ–¼æˆæ¬Š(Authorization)ï¼Œä¹Ÿå°±æ˜¯åˆæ³•çš„ç”¨æˆ¶ç™»å…¥å¾Œï¼Œæ‡‰è©²èƒ½å¤ å–å¾—æ€æ¨£çš„æ¬Šé™ã€‚\nåœ¨èº«ä»½é©—è­‰æ–¹é¢ï¼ŒVault æä¾›äº†å¤šç¨®å•Ÿç”¨å’Œä½¿ç”¨çš„é¸é …æˆ–æ–¹æ³•ã€‚Vault åœ¨æˆæ¬Šå’Œ policy æ–¹é¢ä¹Ÿä½¿ç”¨ç›¸åŒçš„è¨­è¨ˆã€‚æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•éƒ½å°‡ç™»å…¥è€…çš„èº«ä»½ map å›èˆ‡ Vault é…ç½®çš„æ ¸å¿ƒ policyã€‚\næº–å‚™ç’°å¢ƒ åœ¨ vault å®˜æ–¹ç¶²ç«™æ–‡ä»¶ä¸­ï¼ŒHashicorp å®˜æ–¹æº–å‚™äº† https://instruqt.com/çš„ session lab\nç­†è€…å€‹äººè¦ºå¾— interactive lab çš„ browser tab å¾ˆé›£ç”¨ï¼Œä¹Ÿä¸å–œæ­¡ Terminal session é€£ remote VM çš„å»¶é²ï¼Œä»¥ä¸‹å…§å®¹é‚„æ˜¯æœƒä½¿ç”¨ local dev Server èªªæ˜ã€‚\nè§€çœ¾å€‘å¯ä»¥è‡ªå·±æ–Ÿé…Œä½¿ç”¨ã€‚\nPolicy æ ¼å¼ ç­–ç•¥ï¼ˆPoliciesï¼‰æ˜¯ä»¥HCLæ’°å¯«çš„ï¼Œä½†ä¹Ÿå…¼å®¹JSONæ ¼å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ç¯„ä¾‹ç­–ç•¥ï¼š\n# Dev servers have version 2 of KV secrets engine mounted by default, so will # need these paths to grant permissions: path \u0026quot;secret/data/*\u0026quot; { capabilities = [\u0026quot;create\u0026quot;, \u0026quot;update\u0026quot;] } path \u0026quot;secret/data/foo\u0026quot; { capabilities = [\u0026quot;read\u0026quot;] } é€™å€‹ç¯„ä¾‹ policy æˆäºˆäº†å° KV v2 ç§˜å¯†ç®¡ç†ï¼ˆsecrets engineï¼‰çš„è³‡æºçš„èƒ½åŠ›ã€‚å¦‚æœä½ å°æ–¼èˆ‡é€™å€‹ç§˜å¯†ç®¡ç†å¼•æ“ç›¸é—œçš„è·¯å¾‘ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥é–±è©²ç§˜å¯†ç®¡ç†å¼•æ“æ–‡ä»¶ä¸­çš„ ACL è¦å‰‡éƒ¨åˆ†ã€‚\næ ¹æ“šé€™å€‹ policyï¼Œä½¿ç”¨è€…å¯ä»¥å° secret/data/ ä¸­çš„ä»»ä½•ç§˜å¯†é€²è¡Œå¯«å…¥æ“ä½œï¼Œä½†å°æ–¼ secret/data/foo çš„å­˜å–åƒ…å…è¨±è®€å–ã€‚policy çš„é è¨­è¡Œç‚ºæ˜¯ Denyï¼Œå› æ­¤ä¸å…è¨±å°æœªæŒ‡å®šè·¯å¾‘çš„è³‡æºé€²è¡Œä»»ä½•å­˜å–ã€‚\npolicy æ ¼å¼ä½¿ç”¨ prefix åŒ¹é…ç³»çµ±ä¾†ç¢ºå®šå° API è·¯å¾‘çš„è¨ªå•æ§åˆ¶ã€‚ä½¿ç”¨æœ€å…·é«”çš„å·²å®šç¾©ç­–ç•¥ï¼Œå³ç²¾ç¢ºåŒ¹é…æˆ–æœ€é•· prefix åŒ¹é…ã€‚ä¹Ÿå°±æ˜¯å­˜å– secret/data/foo è·¯å¾‘ç¬¦åˆä¸Šé¢å…©æ¢è¦å‰‡ï¼Œä½†æ˜¯ç”±æ–¼ç¬¬äºŒæ¢è¦å‰‡çš„è·¯å¾‘ match æœ€é•·æœ€ç²¾ç¢ºï¼Œæ‰€ä»¥æœ€çµ‚æ‹¿åˆ°çš„æ¬Šé™æ˜¯ \u0026ldquo;read\u0026rdquo;\nç”±æ–¼ Vault ä¸­çš„ä¸€åˆ‡éƒ½å¿…é ˆé€šé API é€²è¡Œè¨ªå•ï¼Œé€™ä½¿å¾—å° Vault çš„æ¯å€‹æ–¹é¢éƒ½æœ‰åš´æ ¼çš„æ§åˆ¶ï¼ŒåŒ…æ‹¬å•Ÿç”¨ç§˜å¯†ç®¡ç†å¼•æ“ã€å•Ÿç”¨èº«ä»½é©—è­‰æ–¹æ³•ã€èº«ä»½é©—è­‰ï¼Œä»¥åŠå­˜å–ç§˜å¯†ç­‰ã€‚\næœ‰ä¸€äº›å…§å»ºçš„ç­–ç•¥ç„¡æ³•è¢«ç§»é™¤ã€‚ä¾‹å¦‚ï¼Œroot policy å’Œ default policy æ˜¯å¿…éœ€çš„ç­–ç•¥ï¼Œç„¡æ³•è¢«åˆªé™¤ã€‚\ndefault policy æä¾›äº†ä¸€çµ„å¸¸è¦‹çš„æ¬Šé™ï¼Œä¸¦ä¸” default åŒ…å«åœ¨æ‰€æœ‰ token ä¸­ã€‚ root policy çµ¦äºˆ token è¶…ç´šç®¡ç†å“¡æ¬Šé™ï¼Œé¡ä¼¼æ–¼Linuxæ©Ÿå™¨ä¸Šçš„ root ç”¨æˆ¶ã€‚ å•Ÿå‹•æœ¬åœ°é–‹ç™¼ç’°å¢ƒ æ­¥é©Ÿåœ¨å‰å¹¾ç¯‡å·²ç¶“å‡ºç¾éæ•¸æ¬¡ï¼Œé€™é‚Šå°±ç°¡å–®å¸¶é\nvault server -dev -dev-no-store-token export VAULT_ADDR='http://127.0.0.1:8200' unset VAULT_TOKEN vault login Defult policy ä½ å¯ä»¥ç”¨ä¸‹åˆ—æŒ‡ä»¤åˆ—å‡ºé è¨­çš„ policy\nvault policy list output\ndefault root å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤è®€å– default policy çš„å…§å®¹\nvault policy read default output å›å‚³è¨±å¤šæ¢ policy ruleï¼Œä¸»è¦æ˜¯çµ¦äºˆ token åŸºæœ¬çš„æ“ä½œæ¬Šé™\n# Allow tokens to look up their own properties path \u0026quot;auth/token/lookup-self\u0026quot; { capabilities = [\u0026quot;read\u0026quot;] } # Allow tokens to renew themselves path \u0026quot;auth/token/renew-self\u0026quot; { capabilities = [\u0026quot;update\u0026quot;] } # Allow tokens to revoke themselves path \u0026quot;auth/token/revoke-self\u0026quot; { capabilities = [\u0026quot;update\u0026quot;] } ... ç†Ÿæ‚‰ default policy å…§å®¹å¾Œï¼Œå¯ä»¥æ–Ÿé…Œä½¿ç”¨ã€‚æˆ–æ˜¯é¸æ“‡å¾é ­ç·¨å¯«è‡ªå·±çš„ policyã€‚\nç·¨å¯«ç¬¬ä¸€å€‹ policy è¦æ’°å¯« policy ï¼Œä½¿ç”¨ vault policy write æŒ‡ä»¤ã€‚è«‹æŸ¥é–±è©²æŒ‡ä»¤çš„å¹«åŠ©æ–‡ä»¶ä»¥é€²ä¸€æ­¥äº†è§£ç”¨æ³•ã€‚\nvault policy write -h Usage: vault policy write [options] NAME PATH Uploads a policy with name NAME from the contents of a local file PATH or stdin. If PATH is \u0026quot;-\u0026quot;, the policy is read from stdin. Otherwise, it is loaded from the file at the given path on the local disk. # ä½¿ç”¨ vault policy write æŒ‡ä»¤ï¼Œå¯ä»¥å¾æœ¬åœ°æ–‡ä»¶ PATH æˆ–æ¨™æº–è¼¸å…¥ï¼ˆstdinï¼‰çš„å…§å®¹ä¸Šå‚³ä¸€å€‹åç‚º NAME çš„ç­–ç•¥ã€‚å¦‚æœ PATH æ˜¯ \u0026quot;-\u0026quot;ï¼Œå‰‡ç­–ç•¥å°‡å¾ stdin è®€å–ã€‚å¦å‰‡ï¼Œå®ƒå°‡å¾æœ¬åœ° disk ä¸Šçµ¦å®šè·¯å¾‘çš„æ–‡ä»¶ä¸­è¼‰å…¥ã€‚ Upload a policy named \u0026quot;my-policy\u0026quot; from \u0026quot;/tmp/policy.hcl\u0026quot; on the local disk: $ vault policy write my-policy /tmp/policy.hcl Upload a policy from stdin: $ cat my-policy.hcl | vault policy write my-policy - ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å‰µå»ºåç‚º \u0026ldquo;my-policy\u0026rdquo; çš„ policyï¼Œä¸¦å°‡å…¶å…§å®¹ä¾†è‡ª stdinï¼ˆæ¨™æº–è¼¸å…¥ï¼‰\nvault policy write my-policy - \u0026lt;\u0026lt; EOF # Dev servers have version 2 of KV secrets engine mounted by default, so will # need these paths to grant permissions: path \u0026quot;secret/data/*\u0026quot; { capabilities = [\u0026quot;create\u0026quot;, \u0026quot;update\u0026quot;] } path \u0026quot;secret/data/foo\u0026quot; { capabilities = [\u0026quot;read\u0026quot;] } EOF output\nSuccess! Uploaded policy: my-policy ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤åˆ—å‡º policy\nvault policy list output\ndefault my-policy root è®€å– my-policy çš„å…§å®¹\nvault policy read my-policy output\n# Dev servers have version 2 of KV secrets engine mounted by default, so will # need these paths to grant permissions: path \u0026quot;secret/data/*\u0026quot; { capabilities = [\u0026quot;create\u0026quot;, \u0026quot;update\u0026quot;] } path \u0026quot;secret/data/foo\u0026quot; { capabilities = [\u0026quot;read\u0026quot;] } æ¸¬è©¦ policy ä½ æ‰€å»ºç«‹çš„ policy ï¼Œæä¾›å° KV-V2 ç§˜å¯†å¼•æ“æ‰€å®šç¾©çš„ç§˜å¯†é€²è¡Œç®¡ç†ã€‚policy è¢«é™„åŠ åˆ° Vault ç›´æ¥ç”Ÿæˆçš„ otokenï¼Œæˆ–é€éå…¶å„ç¨®æˆæ¬Šæ–¹æ³•ç”Ÿæˆçš„ token ä¸Šã€‚\nå‰µå»ºä¸€å€‹ token ï¼Œæ·»åŠ  my-policyã€‚-field flag è¨­å®šåªå›å‚³éƒ¨åˆ† key-vault dataï¼Œè€Œä¸æ˜¯å‚³æ•´å€‹ metadata tableã€‚-policy è¨­å®šé€£çµ token çš„ policyã€‚\nvault token create -field token -policy=my-policy hvs.CAESIIDh...UxbUU ç‚ºäº†ç°¡åŒ–ï¼Œæœ¬å…§å®¹ä½¿ç”¨ dev æ¨¡å¼ä¼ºæœå™¨ï¼Œç›´æ¥å¾ token æˆæ¬Šæ–¹æ³•å‰µå»º token ã€‚è«‹è¨˜ä½ï¼Œåœ¨å¤§å¤šæ•¸ production ç’°å¢ƒéƒ¨ç½²ä¸­ï¼Œtoken å°‡ç”±å·²å•Ÿç”¨çš„æˆæ¬Šæ–¹æ³•(ex. github auth method)å‰µå»ºã€‚\nå¯ä»¥ä½¿ç”¨ token login\nvault login output å›å‚³ç™»å…¥è³‡è¨Šï¼Œä»¥åŠé€£çµ token çš„ policyï¼Œpolicy åŒ…å« default èˆ‡ my-policy\nSuccess! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026quot;vault login\u0026quot; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.CAESIIDh...UxbUU token_accessor vY3aLwMSezlxeOn7YwcjxuhZ token_duration 767h56m52s token_renewable true token_policies [\u0026quot;default\u0026quot; \u0026quot;my-policy\u0026quot;] identity_policies [] policies [\u0026quot;default\u0026quot; \u0026quot;my-policy\u0026quot;] ä½ å¯ä»¥åŸ·è¡Œ vault token lookupï¼ŒæŸ¥æ‰¾ç›®å‰ token çš„å®Œæ•´è³‡è¨Š\nvault token lookup output\nKey Value --- ----- accessor vY3aLwMSezlxeOn7YwcjxuhZ creation_time 1694917062 creation_ttl 768h display_name token entity_id n/a expire_time 2023-10-19T10:17:42.723364+08:00 explicit_max_ttl 0s id hvs.CAESIIDh...UxbUU issue_time 2023-09-17T10:17:42.723365+08:00 meta \u0026lt;nil\u0026gt; num_uses 0 orphan false path auth/token/create policies [default my-policy] renewable true ttl 767h55m45s type service é€™å€‹policy å•Ÿç”¨äº† secret/ ç§˜å¯†å¼•æ“å…§æ¯å€‹è·¯å¾‘çš„å‰µå»ºå’Œæ›´æ–°åŠŸèƒ½ï¼Œé™¤äº†ä¸€å€‹ä¾‹å¤–è·¯å¾‘ secret/data/foo åƒ…å…è¨± readã€‚\nå¯«å…¥è³‡æ–™åˆ° secret/data/creds\nvault kv put -mount=secret creds password=\u0026quot;my-long-password\u0026quot; output å›å‚³æˆåŠŸè³‡è¨Šï¼Œç§˜å¯†å·²æˆåŠŸå‰µå»ºã€‚\n== Secret Path == secret/data/creds ======= Metadata ======= Key Value --- ----- created_time 2023-09-17T02:26:44.179748Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 1 è©²æ”¿ç­–åƒ…å•Ÿç”¨äº†å° secret/data/foo è·¯å¾‘çš„è®€å–åŠŸèƒ½ã€‚å˜—è©¦å‘æ­¤è·¯å¾‘å¯«å…¥å°‡å°è‡´\u0026quot;æ¬Šé™æ‹’çµ•\u0026quot;éŒ¯èª¤ã€‚è«‹å˜—è©¦å¯«å…¥ secret/data/foo è·¯å¾‘ã€‚\nvault kv put -mount=secret foo robot=beepboop outputï¼Œé¡¯ç¤ºæ¬Šé™éŒ¯èª¤ã€‚\nError writing data to secret/data/foo: Error making API request. URL: PUT http://127.0.0.1:8200/v1/secret/data/foo Code: 403. Errors: * 1 error occurred: * permission denied æ­¤ policy å®šç¾©äº†ä¸€çµ„æœ‰é™çš„è·¯å¾‘å’ŒåŠŸèƒ½ã€‚å¦‚æœæ²’æœ‰å° sys çš„è¨ªå•æ¬Šé™ï¼Œå‰‡ç³»çµ±ç›¸é—œç„ç·šï¼Œåƒ vault policy list æˆ– vault secrets list é€™æ¨£çš„å‘½ä»¤å°‡ç„¡æ³•é‹ä½œã€‚\nkv v2 èˆ‡ v1 èªæ³• ç•¶ä½ ä½¿ç”¨ vault kv CLI å‘½ä»¤è¨ªå• KV v2 ç§˜å¯†å¼•æ“æ™‚ï¼Œæˆ‘å€‘å»ºè­°ä½¿ç”¨ -mount flag èªæ³•ï¼Œä¾†å¼•ç”¨ KV v2 ç§˜å¯†å¼•æ“çš„è·¯å¾‘ã€‚\nvault kv get -mount=secret foo\nä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¼å®¹ KV v1 é¢¨æ ¼çš„è·¯å¾‘ prefix èªæ³•ï¼Œåœ¨æŸå€‹ç¯„åœå…§ä¸Šæ˜¯ç­‰æ•ˆçš„ï¼Œç³»çµ±å°‡è‡ªå‹•é™„åŠ  /data åˆ°ç§˜å¯†è·¯å¾‘ï¼Œå¯èƒ½æœƒå¼•èµ·æ··æ·†ã€‚\nvault kv get secret/foo\né€£çµ policy èˆ‡ auth method Vault æœ¬èº«åªæœ‰å”¯ä¸€çš„ policy æˆæ¬Šç®¡ç†æ©Ÿæ§‹ï¼Œä¸åŒæ–¼èº«ä»½é©—è­‰ï¼Œä½ å¯ä»¥å•Ÿç”¨å¤šå€‹èº«ä»½é©—è­‰æ–¹æ³•ã€‚\nä½ å¯ä»¥é…ç½®èº«ä»½é©—è­‰æ–¹æ³•ï¼Œä»¥è‡ªå‹•åˆ†é…ä¸€çµ„ policyï¼Œçµ¦ä½¿ç”¨æŸäº›èº«ä»½é©—è­‰æ–¹æ³•å‰µå»ºçš„ token ã€‚é€™æ¨£åšçš„æ–¹å¼å–æ±ºæ–¼ç›¸é—œçš„èº«ä»½é©—è­‰æ–¹æ³•ï¼Œä½†é€šå¸¸æ¶‰åŠå°‡ role æ˜ å°„åˆ° policy ï¼Œæˆ–è€…å°‡ identity æˆ– group æ˜ å°„åˆ° policyã€‚\nä¾‹å¦‚ï¼šç•¶è¨­å®š github auth method çš„ role æ™‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ token policies åƒæ•¸ä¾†å¯¦ç¾é€™ä¸€é»ã€‚\næˆ‘å€‘é€™é‚Šå˜—è©¦å»ºç«‹å¦å¤–ä¸€å€‹ auth methodï¼ŒAppRoleï¼Œé †ä¾¿åœ¨æ•´ç†ä¸€æ¬¡ vault -\u0026gt; auth method -\u0026gt; policy çš„é—œä¿‚\né…ç½® AppRole èº«ä»½é©—è­‰æ–¹æ³• åœ¨ä»¥ä¸‹æ­¥é©Ÿä¸­ï¼Œä½¿ç”¨æ¬Šé™æ›´é«˜çš„ root token é€²è¡Œæ“ä½œèˆ‡ç™»å…¥\nvault login output\nToken (will be hidden): Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026quot;vault login\u0026quot; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.uCGr6...749AI token_accessor SlAe0epU6CLngp2iclB5WN2A token_duration âˆ token_renewable false token_policies [\u0026quot;root\u0026quot;] identity_policies [] policies [\u0026quot;root\u0026quot;] å•Ÿç”¨ approle auth method\nvault auth enable approle output\nSuccess! Enabled approle auth method at: approle/ vault server log\n2023-09-17T10:44:26.460+0800 [INFO] core: enabled credential backend: path=approle/ type=approle version=\u0026quot;\u0026quot; approle é…ç½® role æˆ‘å€‘å·²ç¶“å•Ÿç”¨ approle é€™å€‹ auth methodï¼Œæ¥ä¸‹ä¾†è¦è¨­å®šåç‚º \u0026ldquo;my-role\u0026rdquo; çš„ AppRole roleï¼Œé…ç½®ä¸€äº›åŸºæœ¬çš„token è¨­å®šï¼Œä¸¦å°‡å…ˆå‰å®šç¾©çš„ \u0026ldquo;my-policy\u0026rdquo; policyï¼Œé™„åŠ åˆ°æ‰€æœ‰é€šéè©² role å‰µå»ºçš„ tokenã€‚\nä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼Œåœ¨ auth/approle/role/ ä¸‹æ–°å¢ my-roleï¼Œpath ä¹Ÿä»£è¡¨ approle / role / my-role çš„éšå±¤é—œä¿‚\nvault write auth/approle/role/my-role \\ secret_id_ttl=10m \\ token_num_uses=10 \\ token_ttl=20m \\ token_max_ttl=30m \\ secret_id_num_uses=40 \\ token_policies=my-policy output\nSuccess! Data written to: auth/approle/role/my-role ä½ å¯ä»¥é€šéä½¿ç”¨ auth æ–¹æ³•ä¾†é©—è­‰é€™å€‹ AppRole role æ˜¯å¦é™„åŠ äº†policyã€‚\nè¦ä½¿ç”¨ AppRole é€²è¡Œèº«ä»½é©—è­‰ï¼Œé¦–å…ˆéœ€è¦ç²å–è§’è‰²ID\né¦–å…ˆå…ˆè®€å–ç›®å‰ approle/role/my-role çš„è¨­å®š\nv read auth/approle/role/my-role Key Value --- ----- bind_secret_id true local_secret_ids false secret_id_bound_cidrs \u0026lt;nil\u0026gt; secret_id_num_uses 40 secret_id_ttl 10m token_bound_cidrs [] token_explicit_max_ttl 0s token_max_ttl 30m token_no_default_policy false token_num_uses 10 token_period 0s token_policies [my-policy] token_ttl 20m token_type default ç„¶å¾Œè®€å– my-role çš„ role-id\nvault read auth/approle/role/my-role/role-id output\nKey Value --- ----- role_id 600dce48-244c-094e-aeae-cb819ec7f5dd æ¥ä¸‹ä¾†ï¼Œç²å–ä¸€å€‹ç§˜å¯†ID(å®ƒé¡ä¼¼æ–¼æ‡‰ç”¨ç¨‹å¼ç”¨æ–¼ AppRole èº«ä»½é©—è­‰çš„å¯†ç¢¼)ï¼Œç”±æ–¼æˆ‘å€‘é€™å€‹ç¤ºç¯„ä¸¦ä¸æä¾›é¡å¤–åƒæ•¸å€¼ï¼Œé€™å…ˆéœ€è¦ä½¿ç”¨ -f | -force flagï¼Œå¼·è¿« vault å¯«å…¥ä¸€å€‹æ²’æœ‰ value çš„è³‡æ–™åˆ° auth/approle/role/my-role/secret-id endpoint\nvault write -f auth/approle/role/my-role/secret-id å¯ä»¥æƒ³åƒæ˜¯å‘ API server æ‰“ POST my-role/secret-idï¼Œå‘ approle è¨»å†Šä¸€å€‹ appï¼Œserver å‰‡å›å‚³ä¸€çµ„ idï¼Œä»¥è¾¨è­˜é€™å€‹ appã€‚\nKey Value --- ----- secret_id d80db935-9792-faf7-306d-93a2f0c3a18f secret_id_accessor 32451384-f985-a387-175b-67140225856f secret_id_num_uses 40 secret_id_ttl 10m æœ€å¾Œé€²è¡Œ login å–å¾— tokenï¼Œé€™è£¡ä½¿ç”¨ vault write é€²è¡Œ AppRole èº«ä»½é©—è­‰ï¼ŒæŒ‡å®š role pathä¸¦ä½¿ç”¨ç›¸æ‡‰çš„é¸é …å‚³érole idå’Œsecret id\nexport ROLE_ID=600dce48-244c-094e-aeae-cb819ec7f5dd export SECRET_ID=d80db935-9792-faf7-306d-93a2f0c3a18f vault write auth/approle/login \\ role_id=$ROLE_ID \\ secret_id=$SECRET_ID outputï¼Œå–å¾—åˆæ³•çš„ tokenï¼Œä¸¦ä¸”å…·æœ‰æˆ‘å€‘ç‚º approle/my-role é…ç½®çš„ my-policy æ¬Šé™\nKey Value --- ----- token hvs.CAESIB9gD3aupV5X06IRIWMEvhL4QeBtizO20i2Hh2YderxpGh4KHGh2cy5BWVVWVDVFUVI3dkw5VUFUbmdoZmpnUFA token_accessor QGrKxnHH4e9SVLqhpaqgYsCZ token_duration 20m token_renewable true token_policies [\u0026quot;default\u0026quot; \u0026quot;my-policy\u0026quot;] identity_policies [] policies [\u0026quot;default\u0026quot; \u0026quot;my-policy\u0026quot;] token_meta_role_name my-role å¯¦å‹™ä¸­ï¼Œé€™å€‹ secret_id æœƒè¨­ç½®åœ¨ application ä¸Šï¼Œè®“ application å…·æœ‰åˆæ³•å­˜å– vault çš„æ¬Šé™\nå¯¦å‹™ç¯„ä¾‹è¬›è§£ æˆ‘å€‘å¯ä»¥é‡è¤‡ä½¿ç”¨è¨­å®šå¥½çš„ policyï¼Œç¶å®šåˆ° auth method ä¸Šï¼Œpolicy å° auth method æ˜¯å¤šå°å¤šçš„ï¼Œé€™é‚Šé€éæˆ‘å€‘ä¸Šç¯‡ github auth method ä¾†å°ç…§ä¸€ä¸‹ï¼Œè§£é‡‹ auth method èˆ‡ role / policy çš„é—œä¿‚\nchechia-net æ˜¯ä¸€å€‹çµ„ç¹”\nas a adminï¼Œæˆ‘å¸Œæœ›è—‰ç”± github auth methodï¼Œè®“æœ‰ github æ¬Šé™çš„å·¥ç¨‹å¸«ï¼Œå¯ä»¥å­˜å– vault\nä¸¦ä¸”åœ¨ github ä¸Šçš„ org / team ç®¡ç†å„å€‹ä½¿ç”¨è€…ï¼Œvault å¯ä»¥ç›´æ¥è¤‡ç”¨ github çš„æ¬Šé™éšå±¤ æ–¼æ˜¯ï¼Œé€é github auth methodï¼Œè‡ªå‹•é…ç½® vault æ¬Šé™çµ¦ chechia-net github org ä¸‹çš„ä½¿ç”¨è€…\nvault auth enable -path=github-chechia github vault write auth/github-chechia/config organization=chechia-net as a github userï¼Œæˆ‘å¸Œæœ›è—‰ç”± github auth methodï¼Œç›´æ¥ç™»å…¥ vaultï¼Œä¸ç”¨è¨»å†Šé¡å¤–çš„å¸³è™Ÿ\nvault login -method=github -path=github-chechia æ›æˆ approle ä¹Ÿæ˜¯ç›¸åŒé“ç†\nas a adminï¼Œæˆ‘å¸Œæœ›æˆ‘çš„ application èƒ½å¤ æœ‰è¾¦æ³•å­˜å– vault\nå¯èƒ½æ˜¯ä¸€å€‹ badkend golang serverï¼Œéœ€è¦å­˜å– vault ä¸­çš„ mysql database credential vault auth enable -path=approle-golang-server approle é€™å€‹ application å¯èƒ½æœ‰è¤‡æ•¸ä¸åŒç¨®é¡å·¥ä½œï¼Œæ‰€ä»¥ä¹Ÿå¸Œæœ›èƒ½å¤ é…ç½®ä¸åŒçš„ roleï¼Œçµ¦äºˆä¸åŒçš„ policy æ¬Šé™\nrole/default æœ‰ default policy role/my-role æœ‰ default, my-policy å…©å€‹ policy æ›´æ¥è¿‘å¯¦å‹™çš„ä¾‹å­ï¼Œåº•ä¸‹å¯èƒ½æ˜¯å¸¸è¦‹çš„ role ç”¨é€”\napprole/databaseï¼Œç•¶ application éœ€è¦å‘ db å­˜å–æ™‚ä½¿ç”¨ï¼Œex. å»å–å¾— mysql ç›¸é—œçš„ credential approle/frontendï¼Œè®“ application å¯ä»¥å‘å‰ç«¯å­˜å–æ¸¬è©¦éœ€è¦ credential approle/qaï¼Œä¹Ÿè¨±æ˜¯ application è‡ªå‹•åŒ–æ¸¬è©¦çš„ credential æƒ³è¡¨é”ï¼Œé›–ç„¶ä¾†æºéƒ½æ˜¯ç›¸åŒ applicationï¼Œä½¿ç”¨ approle auth methodï¼Œvault é‚„æ˜¯å¯ä»¥è¨­å®šä¸åŒçš„ policyï¼Œè®“ application å–ç”¨æœ€å°çš„å¯ç”¨æ¬Šé™ï¼Œè€Œä¸æœƒæ¯æ¬¡ç™»å…¥ vault éƒ½æ˜¯å¾ˆå¤§çš„æ¬Šé™ èº«ç‚º adminï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨ approle-golang-server ä¸­ç”¢ç”Ÿä¸€å€‹ default role\nvault write auth/approle-golang-server/role/default \\ secret_id_ttl=10m \\ token_num_uses=10 \\ token_ttl=20m \\ token_max_ttl=30m \\ secret_id_num_uses=40 \\ token_policies=default å¢åŠ ä¸€å€‹ my-role\nvault write auth/approle-golang-server/role/my-role \\ secret_id_ttl=10m \\ token_num_uses=10 \\ token_ttl=20m \\ token_max_ttl=30m \\ secret_id_num_uses=40 \\ token_policies=default,my-policy åˆ—å‡ºåœ¨ approle-golang-server ä¸­å•Ÿç”¨çš„ role\nvault list auth/approle-golang-server/role/ output\nKeys ---- default my-role admin é…ç½®å®Œ role å¾Œï¼Œè¨˜å¾—è®€å– role-idï¼Œä¸¦å°‡ role-id é…ç½®åˆ° application ä¸Š\nå¯ä»¥åœ¨ application ä¸­ç¶­è­·ä¸€å€‹ mapï¼Œç•¶ä½¿ç”¨é€™é€é applicationï¼Œæ‹¿åˆ° default roleï¼Œå°±ä½¿ç”¨ default/role-id æ­é…æ¥è¿‘å¯¦å‹™çš„ä¾‹å­ï¼Œå°±æ˜¯å¦‚æœæ˜¯å¾Œç«¯å·¥ç¨‹å¸«ä½¿ç”¨ applicationï¼Œapplication è¦èƒ½å¤ ä½¿ç”¨ role/backend/role-idï¼Œä¾†å‘ vault é€²è¡Œ authentication ä½ ä¹Ÿå¯ä»¥è®“ application æœ‰æ¬Šé™è®€å– auth/approle-golang-server/role/*/role-idï¼Œè®“ application é€é vault API è‡ªå‹•å–å¾— role-id vault read auth/approle-golang-server/role/default/role-id vault read auth/approle-golang-server/role/my-role/role-id output\nKey Value --- ----- role_id f0340d97-a97d-85f9-30d5-65a2058baf11 Key Value --- ----- role_id c1f3cd3e-8f0a-8b1f-91f7-a3a310b9755f ä¸Šé¢æ˜¯ admin éœ€è¦é…ç½®çš„å…§å®¹\nç¾åœ¨è§’è‰²æ›æˆ applicationï¼Œapplication ä¸Šç·šäº†ã€‚application ä¾ç…§æƒ…å¢ƒï¼Œé¸æ“‡è¦ä½¿ç”¨é‚£å€‹ roleï¼Œå»å–å¾— secret-id\nä¾‹å¦‚ application è¦å»å­˜å– databaseï¼Œå°±è‡ªå·±ä½¿ç”¨ role/database æ³¨æ„ï¼Œé€™å€‹ role/database èˆ‡ policy/database ä¸Šé¢éƒ½æ²’æœ‰é…ç½®ï¼Œè«‹è®€è€…è‡ªå·±ç·´ç¿’ï¼Œé…ç½®ä¸€å€‹ placeholder ç©ºçš„æ¬Šé™ï¼Œæˆ–æ˜¯ç™¼æ®å‰µæ„ä¹Ÿå¯ä»¥\nvault write -f auth/approle-golang-server/role/my-role/secret-id outputï¼Œvault å›è¦†ä¸€çµ„çŸ­æ™‚æ•ˆçš„ secret-idï¼Œttl=10 min\nKey Value --- ----- secret_id ad70d84b-56a5-eec2-0a95-6aa7f2cfceef secret_id_accessor 76a5b993-a139-9837-5990-b6adc483542a secret_id_num_uses 40 secret_id_ttl 10m application å¯ä»¥ä½¿ç”¨ role-id + secret-idï¼Œå»å–å¾— token\nvault write auth/approle-golang-server/login \\ role_id=$ROLE_ID \\ secret_id=$SECRET_ID output\nKey Value --- ----- token hvs.CA...ZXRVc token_accessor zjBhj70A6ed72zksuooxCpYt token_duration 20m token_renewable true token_policies [\u0026quot;default\u0026quot; \u0026quot;database\u0026quot;] identity_policies [] policies [\u0026quot;default\u0026quot; \u0026quot;database\u0026quot;] token_meta_role_name database chatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-policies https://developer.hashicorp.com/vault/docs/concepts/policies å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ å¾ˆé‡è¦ï¼šä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-09-18-vault-workshop-policy-and-approle/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-07-policy--approle\"\u003eDay 07: Policy \u0026amp; Approle\u003c/h1\u003e\n\u003cp\u003eåœ¨ Vault ä¸­ï¼Œç­–ç•¥ï¼ˆPoliciesï¼‰æ§åˆ¶è‘—ä½¿ç”¨è€…å¯ä»¥è¨ªå•çš„è³‡æºã€‚åœ¨ä¸Šä¸€ç¯‡èº«ä»½é©—è­‰ä¸­ï¼Œä½ å·²ç¶“å­¸åˆ°äº†èº«ä»½é©—è­‰æ–¹æ³•(authentication method)ã€‚è€Œé€™ä¸€ç¯€æ˜¯é—œæ–¼æˆæ¬Š(Authorization)ï¼Œä¹Ÿå°±æ˜¯åˆæ³•çš„ç”¨æˆ¶ç™»å…¥å¾Œï¼Œæ‡‰è©²èƒ½å¤ å–å¾—æ€æ¨£çš„æ¬Šé™ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨èº«ä»½é©—è­‰æ–¹é¢ï¼ŒVault æä¾›äº†å¤šç¨®å•Ÿç”¨å’Œä½¿ç”¨çš„é¸é …æˆ–æ–¹æ³•ã€‚Vault åœ¨æˆæ¬Šå’Œ policy æ–¹é¢ä¹Ÿä½¿ç”¨ç›¸åŒçš„è¨­è¨ˆã€‚æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•éƒ½å°‡ç™»å…¥è€…çš„èº«ä»½ map å›èˆ‡ Vault é…ç½®çš„æ ¸å¿ƒ policyã€‚\u003c/p\u003e\n\u003ch3 id=\"æº–å‚™ç’°å¢ƒ\"\u003eæº–å‚™ç’°å¢ƒ\u003c/h3\u003e\n\u003cp\u003eåœ¨ \u003ca href=\"https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-policies\"\u003evault å®˜æ–¹ç¶²ç«™æ–‡ä»¶\u003c/a\u003eä¸­ï¼ŒHashicorp å®˜æ–¹æº–å‚™äº† \u003ca href=\"https://instruqt.com/\"\u003ehttps://instruqt.com/\u003c/a\u003eçš„ session lab\u003c/p\u003e\n\u003cp\u003eç­†è€…å€‹äººè¦ºå¾— interactive lab çš„ browser tab å¾ˆé›£ç”¨ï¼Œä¹Ÿä¸å–œæ­¡ Terminal session é€£ remote VM çš„å»¶é²ï¼Œä»¥ä¸‹å…§å®¹é‚„æ˜¯æœƒä½¿ç”¨ local dev Server èªªæ˜ã€‚\u003c/p\u003e\n\u003cp\u003eè§€çœ¾å€‘å¯ä»¥è‡ªå·±æ–Ÿé…Œä½¿ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"policy-æ ¼å¼\"\u003ePolicy æ ¼å¼\u003c/h3\u003e\n\u003cp\u003eç­–ç•¥ï¼ˆPoliciesï¼‰æ˜¯ä»¥HCLæ’°å¯«çš„ï¼Œä½†ä¹Ÿå…¼å®¹JSONæ ¼å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ç¯„ä¾‹ç­–ç•¥ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-hcl\"\u003e# Dev servers have version 2 of KV secrets engine mounted by default, so will\n# need these paths to grant permissions:\npath \u0026quot;secret/data/*\u0026quot; {\n  capabilities = [\u0026quot;create\u0026quot;, \u0026quot;update\u0026quot;]\n}\n\npath \u0026quot;secret/data/foo\u0026quot; {\n  capabilities = [\u0026quot;read\u0026quot;]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé€™å€‹ç¯„ä¾‹ policy æˆäºˆäº†å° KV v2 ç§˜å¯†ç®¡ç†ï¼ˆsecrets engineï¼‰çš„è³‡æºçš„èƒ½åŠ›ã€‚å¦‚æœä½ å°æ–¼èˆ‡é€™å€‹ç§˜å¯†ç®¡ç†å¼•æ“ç›¸é—œçš„è·¯å¾‘ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥é–±è©²ç§˜å¯†ç®¡ç†å¼•æ“æ–‡ä»¶ä¸­çš„ \u003ca href=\"https://developer.hashicorp.com/vault/docs/secrets/kv/kv-v2#acl-rules\"\u003eACL è¦å‰‡\u003c/a\u003eéƒ¨åˆ†ã€‚\u003c/p\u003e","title":"Vault Workshop 07: Policy \u0026 approle"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 06ï¼šGithub auth method ä¸éœ€è¦ä½¿ç”¨ root token çš„ auth method: github Vault æ”¯æ´ç”¨æ–¼äººå“¡ä½¿ç”¨è€…çš„èº«ä»½é©—è­‰æ–¹æ³•ã€‚GitHub èº«ä»½é©—è­‰ï¼Œä½¿ç”¨æˆ¶å¯ä»¥é€šéæä¾›ä»–å€‘çš„ GitHub æ†‘è­‰ä¾†é©—è­‰ Vaultï¼Œä¸¦æ”¶åˆ°ä¸€å€‹ Vault tokenã€‚\nç°¡å–®ä¾†èªªï¼Œgithub organization chechia-netï¼Œå¯ä»¥è¨­å®šé©ç•¶çš„æ¬Šé™çµ¦æˆå“¡ chechiachangï¼Œè®“ chechiachang å¯ä»¥é€é github å–å¾—æœ‰æ¬Šé™çš„ tokenã€‚\næ³¨æ„\nåœ¨ç·´ç¿’ä¸­æ‰€æè¿°çš„é€™ç¨®èº«ä»½é©—è­‰æ–¹æ³•ï¼Œéœ€è¦ä½ æ“æœ‰ GitHubã€å±¬æ–¼ GitHub org ä¸­çš„ä¸€å€‹ team ï¼Œä¸¦ç”Ÿæˆäº†å…·æœ‰ read:org scope çš„ GitHub personal access tokenã€‚ä½ å¯ä»¥æ–¼ github å‰µå»ºä¸€å€‹ free plan çš„ orgï¼Œä¸¦è¨­å®šä¸€å€‹ teamï¼Œç„¶å¾Œé€éå€‹äºº Settings / Developer Settings ä¾†ç”¢ç”Ÿä¸€æŠŠå…·æœ‰ read:org æ¬Šé™çš„ personal access token\nå•Ÿç”¨ github auth method ä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼Œåœ¨ path=github/ ä¸‹å•Ÿç”¨ GitHub èº«ä»½é©—è­‰æ–¹æ³•ã€‚\nexport VAULT_TOKEN=hvs.qCqY...9KYv vault auth enable github é€™å€‹æŒ‡ä»¤ä½¿ç”¨ root token è¨­å®š auth methodï¼Œä¹Ÿæ˜¯æ•´å€‹ github auth methods ä¸­ï¼Œå”¯ä¸€éœ€è¦ç”¨åˆ° root token è¨­å®šçš„åœ°æ–¹ï¼Œè€Œä¸”åªéœ€è¦è¨­å®šä¸€æ¬¡\noutput\nSuccess! Enabled github auth method at: github/ vault server log é¡¯ç¤º credential backend å·²å•Ÿç”¨\n2023-09-16T21:40:10.444+0800 [INFO] core: enabled credential backend: path=github/ type=github version=\u0026quot;\u0026quot; ä½ å¯ä»¥ä¸‹åˆ—æŒ‡ä»¤ï¼Œåˆ—å‡ºæ‰€æœ‰çš„ auth methods\nvault auth list output\nPath Type Accessor Description Version ---- ---- -------- ----------- ------- github/ github auth_github_9bc96e5f n/a n/a token/ token auth_token_b7984c52 token based credentials n/a github èº«ä»½é©—è­‰æ–¹æ³•å·²å•Ÿç”¨ï¼Œä¸¦ä½æ–¼è·¯å¾‘ auth/github/ã€‚\nè¨­å®š github auth method æ­¤èº«ä»½é©—è­‰æ–¹æ³•éœ€è¦ä½ åœ¨é…ç½®ä¸­è¨­ç½® GitHub organizationã€‚GitHub organizationä¸­ï¼Œç¶­è­·äº†ä¸€å€‹å…è¨±èˆ‡ Vault é©—è­‰çš„ä½¿ç”¨è€…åˆ—è¡¨ã€‚\nè¨­ç½® GitHub èº«ä»½é©—è­‰çš„çµ„ç¹”ã€‚\nvault write auth/github/config organization=chechia-net output\nSuccess! Data written to: auth/github/config ç¾åœ¨ï¼Œchechia-net GitHub çµ„ç¹”ä¸­çš„æ‰€æœ‰ä½¿ç”¨è€…éƒ½å¯ä»¥é€²è¡Œèº«ä»½é©—è­‰ã€‚\nè¨­å®š github auth methodï¼Œçµ¦ä¸åŒ team ä¸åŒçš„ policy GitHub çµ„ç¹”å¯ä»¥å®šç¾©åœ˜éšŠ(team)ã€‚æ¯å€‹åœ˜éšŠå¯èƒ½å¯ä»¥åœ¨çµ„ç¹”ç¶­è­·çš„æ‰€æœ‰ repository ä¸­åŸ·è¡Œä¸åŒçš„æ“ä½œã€‚é€™äº›åœ˜éšŠä¹Ÿå¯èƒ½éœ€è¦è¨ªå• Vault å…§çš„ç‰¹å®šå¯†ç¢¼ã€‚\né…ç½® GitHub sre åœ˜éšŠçš„èº«ä»½é©—è­‰ï¼Œä»¥ç²å¾— default å’Œ application å…©å€‹ policyçš„æˆæ¬Šã€‚\nvault write auth/github/map/teams/sre value=default,application output\nSuccess! Data written to: auth/github/map/teams/sre GitHub sre åœ˜éšŠä¸­ chechia-net çµ„ç¹”çš„æˆå“¡ï¼Œå°‡ä½¿ç”¨ default å’Œ application policy é€²è¡Œèº«ä»½é©—è­‰å’Œæˆæ¬Šã€‚\nå‚™è¨»ï¼šapplication policy å°šæœªåœ¨ Vault ä¸­å®šç¾©ã€‚åœ¨è©²ç­–ç•¥å®šç¾©ä¹‹å‰ï¼ŒVault ä»ç„¶å…è¨±ä½¿ç”¨è€…é€²è¡Œèº«ä»½é©—è­‰ï¼Œä½†æœƒç”¢ç”Ÿè­¦å‘Šã€‚\nä½ å¯ä»¥ä½¿ç”¨æŒ‡ä»¤é¡¯ç¤º Vault å•Ÿç”¨çš„æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•\nvault auth list å›å‚³é¡¯ç¤ºå…©å€‹ auth methodsï¼Œgithub/ èˆ‡ token/\nPath Type Accessor Description Version ---- ---- -------- ----------- ------- github/ github auth_github_9bc96e5f n/a n/a token/ token auth_token_b7984c52 token based credentials n/a ä½¿ç”¨ github auth method login ä½¿ç”¨ help æŒ‡ä»¤ä¾†äº†è§£ github auth method çš„èªªæ˜\nvault auth help github output\nUsage: vault login -method=github [CONFIG K=V...] The GitHub auth method allows users to authenticate using a GitHub personal access token. Users can generate a personal access token from the settings page on their GitHub account. # GitHub èº«ä»½é©—è­‰æ–¹æ³•å…è¨±ä½¿ç”¨è€…ä½¿ç”¨ GitHub personal access tokené€²è¡Œèº«ä»½é©—è­‰ã€‚ä½¿ç”¨è€…å¯ä»¥å¾å…¶ GitHub Settings -\u0026gt; Developer Settings -\u0026gt; Personal access tokens (classic) ç”Ÿæˆå€‹äººè¨ªå•ä»¤ç‰Œã€‚ Authenticate using a GitHub token: $ vault login -method=github token=abcd1234 Configuration: mount=\u0026lt;string\u0026gt; Path where the GitHub credential method is mounted. This is usually provided via the -path flag in the \u0026quot;vault login\u0026quot; command, but it can be specified here as well. If specified here, it takes precedence over the value for -path. The default value is \u0026quot;github\u0026quot;. # GitHub æ†‘è­‰æ–¹æ³•æ›è¼‰çš„è·¯å¾‘ã€‚é€šå¸¸é€é \u0026quot;vault login\u0026quot; æŒ‡ä»¤çš„ -path flag æä¾›ï¼Œä½†é€™è£¡ä¹Ÿå¯ä»¥æŒ‡å®šã€‚å¦‚æœåœ¨é€™è£¡æŒ‡å®šï¼Œå‰‡å„ªå…ˆæ–¼ -path çš„å€¼ã€‚é è¨­çš„è·¯å¾‘å€¼ç‚º \u0026quot;github\u0026quot;ã€‚ token=\u0026lt;string\u0026gt; GitHub personal access token to use for authentication. If not provided, Vault will prompt for the value. # ç”¨æ–¼èº«ä»½é©—è­‰çš„ GitHub personal access tokenã€‚å¦‚æœæœªæä¾›ï¼ŒVault å°‡æç¤ºè¼¸å…¥æ­¤å€¼ã€‚ è¼¸å‡ºé¡¯ç¤ºäº†ä½¿ç”¨ GitHub æ–¹æ³•é€²è¡Œ login çš„ä¾‹å­ã€‚è©²æ–¹æ³•è¦æ±‚å¿…é ˆå®šç¾©è©²æ–¹æ³•ï¼Œä¸¦ç”±ä½¿ç”¨è€…æä¾› GitHub personal access tokenã€‚\nç”±æ–¼ä½ å°‡å˜—è©¦ä½¿ç”¨èº«ä»½é©—è­‰æ–¹æ³•é€²è¡Œç™»éŒ„ï¼Œè«‹ç¢ºä¿åœ¨æ­¤ shell session ä¸­æœªè¨­ç½® VAULT_TOKEN ç’°å¢ƒè®Šæ•¸ï¼Œå› ç‚ºå…¶å€¼å°‡å„ªå…ˆæ–¼ä½ å¾ Vault ç²å–çš„ä»»ä½• tokenã€‚\nå–æ¶ˆè¨­å®šè©²ç’°å¢ƒè®Šæ•¸ã€‚\nunset VAULT_TOKEN å˜—è©¦ä½¿ç”¨ github auth methods ç™»å…¥\nvault login -method=github outputï¼Œä½¿ç”¨è€…ä½¿ç”¨ github personal access tokenï¼Œå–å¾—æœ‰æ•ˆçš„ vault token\ntoken æ ¼å¼ä¸åŒ token çš„æ•ˆæœŸç‚º 768hï¼ŒçŸ­æ•ˆæœŸ token çš„æ›éšªç¨‹åº¦è¼ƒä½ é€™å€‹ token çš„ policy æ¬Šé™åªæœ‰ default policy metadata æ˜¯ github å›å‚³çš„ï¼Œvault ä¸­ä¸¦æ²’æœ‰å»ºç«‹ username=chechiachang çš„è³‡æ–™ org æ˜¯ chechia-net username æ˜¯ chechiachang GitHub Personal Access Token (will be hidden): Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026quot;vault login\u0026quot; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.CAESI...ncU0 token_accessor lKVpMawotXg1fXcgRvpAOAwQ token_duration 768h token_renewable true token_policies [\u0026quot;default\u0026quot;] identity_policies [] policies [\u0026quot;default\u0026quot;] token_meta_org chechia-net token_meta_username chechiachang ç•¶æœªæä¾› GitHub personal access token çµ¦å‘½ä»¤æ™‚ï¼ŒVault CLI æœƒæç¤ºä½¿ç”¨è€…è¼¸å…¥ã€‚\nå¦‚æœæä¾›äº†æœ‰æ•ˆçš„ GitHub personal access tokenï¼Œå‰‡ä½¿ç”¨è€…å°‡æˆåŠŸç™»éŒ„ vaultï¼Œä¸¦ä¸”è¼¸å‡ºæœƒé¡¯ç¤ºä¸€å€‹ Vault tokenã€‚ä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨é€™å€‹ Vault tokenï¼Œç›´åˆ°è©² token è¢«æ’¤éŠ·æˆ–å…¶æœ‰æ•ˆæœŸè¶…éäº† token_durationã€‚\nä½ å¯ä»¥ä½¿ç”¨ vault token lookup ä¾†æª¢è¦–ç•¶å‰çš„ token\nvault token lookup outputï¼Œé¡¯ç¤ºä½¿ç”¨ä¸­çš„ tokenï¼Œä½¿ç”¨çš„ path èˆ‡ methods æ˜¯ github/ï¼Œæ•ˆæœŸ ttl åœ¨å€’æ•¸ä¸­é€æ¼¸æ¸›å°‘ 767h54m27s\nKey Value --- ----- accessor lKVpMawotXg1fXcgRvpAOAwQ creation_time 1694873434 creation_ttl 768h display_name github-chechiachang entity_id 5d8af1ab-53a2-e1c5-61bf-bb0b6c7d190f expire_time 2023-10-18T22:10:34.812089+08:00 explicit_max_ttl 0s id hvs.CAESI...ncU0 issue_time 2023-09-16T22:10:34.812099+08:00 meta map[org:chechia-net username:chechiachang] num_uses 0 orphan true path auth/github/login policies [default] renewable true ttl 767h54m27s type service è¨˜å¾—æˆ‘å€‘å»ºç«‹ team çš„ policy = default + application å—ï¼Ÿä½ å¯ä»¥åœ¨ github ä¸ŠæŠŠ user åŠ å…¥åˆ° team/sre\nä¾‹å¦‚æˆ‘å€‘æŠŠ chechiachang åŠ å…¥åˆ° org/chechia-net çš„ team/sre\nç•¶å‰ç™»å…¥ session æ¬Šé™å°šæœªæ›´æ–°ï¼Œæˆ‘å€‘ç›´æ¥é‡æ–°ç™»å…¥ä¸€æ¬¡\nvault login -method=github outputï¼Œå¯ä»¥çœ‹è¦‹ç™»å…¥å¾Œçš„ policy æ¬Šé™å¢åŠ æˆç‚º default + application\nGitHub Personal Access Token (will be hidden): Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026quot;vault login\u0026quot; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.CAES...RcmE token_accessor 6DbsDizOenhCuWMmUWspTZwp token_duration 768h token_renewable true token_policies [\u0026quot;application\u0026quot; \u0026quot;default\u0026quot;] identity_policies [] policies [\u0026quot;application\u0026quot; \u0026quot;default\u0026quot;] token_meta_org chechia-net token_meta_username chechiachang ä»¥ä¸Šæ˜¯é€é github/ auth methods\nç®¡ç†è€…è¨­å®š github/ method config ä½¿ç”¨è€… chechiachangï¼Œä½¿ç”¨ github/ method login ä½¿ç”¨çš„æ¬Šé™ç®¡ç†æ˜¯ä¾ç…§ github org / team ä¾†ç®¡ç†ï¼Œvault ä¸¦æ²’æœ‰ç´€éŒ„ team èˆ‡ä½¿ç”¨è€…è³‡æ–™ æ¸…ç†ï¼šç§»é™¤ auth methods ä½¿ç”¨ root token å†æ¬¡é€²è¡Œç™»éŒ„ã€‚\nvault login output\nToken (will be hidden): Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026quot;vault login\u0026quot; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.J80w...mjoh token_accessor DaI1V1rq9tKZX5EaO4AfMI26 token_duration âˆ token_renewable false token_policies [\u0026quot;root\u0026quot;] identity_policies [] policies [\u0026quot;root\u0026quot;] ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ’¤éŠ· github/ auth methods ç”¢ç”Ÿçš„ token\nvault token revoke -mode path auth/github output\nSuccess! Revoked token (if it existed) vault server logï¼Œå°æ–¼ auth/github è·¯å¾‘çš„æ‰€æœ‰ç™»éŒ„ç”Ÿæˆçš„ä»¤ç‰Œéƒ½å·²è¢«æ’¤éŠ·ã€‚\n2023-09-16T22:25:06.793+0800 [INFO] expiration: revoked lease: lease_id=auth/github/login/h71720c9bc6fed61d459da4b172dc518a6d55b1dd33c70103cf0b12eb42d7741a 2023-09-16T22:25:06.793+0800 [INFO] expiration: revoked lease: lease_id=auth/github/login/hd2b110a8eda38814ac0e3ba7ccb926e75205c5065480c9c2675ae5f2860f9f97 æ‰€æœ‰èº«ä»½é©—è­‰æ–¹æ³•ï¼Œé™¤äº† token èº«ä»½é©—è­‰æ–¹æ³•ï¼Œéƒ½å¯ä»¥è¢«åœç”¨ã€‚\nåœç”¨ github èº«ä»½é©—è­‰æ–¹æ³•\nvault auth disable github output\nSuccess! Disabled the auth method (if it existed) at: github/ vault server log\n2023-09-16T22:27:42.040+0800 [INFO] core: disabled credential backend: path=auth/github/ æ‰€æœ‰ä½¿ç”¨æ­¤èº«ä»½é©—è­‰æ–¹æ³•é€²è¡Œç™»éŒ„ç”Ÿæˆçš„tokenéƒ½å·²è¢«æ’¤éŠ·ã€‚\næ¸…ç† github å¦‚æœæœ‰å»ºç«‹ org / team / github personal access token çš„è©±ï¼Œè¨˜å¾—ç§»é™¤ä»–\nchatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-authentication https://developer.hashicorp.com/vault/docs/auth/github å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ ä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-09-17-vault-workshop-authentication-github/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-06github-auth-method\"\u003eDay 06ï¼šGithub auth method\u003c/h1\u003e\n\u003ch3 id=\"ä¸éœ€è¦ä½¿ç”¨-root-token-çš„-auth-method-github\"\u003eä¸éœ€è¦ä½¿ç”¨ root token çš„ auth method: github\u003c/h3\u003e\n\u003cp\u003eVault æ”¯æ´ç”¨æ–¼äººå“¡ä½¿ç”¨è€…çš„èº«ä»½é©—è­‰æ–¹æ³•ã€‚GitHub èº«ä»½é©—è­‰ï¼Œä½¿ç”¨æˆ¶å¯ä»¥é€šéæä¾›ä»–å€‘çš„ GitHub æ†‘è­‰ä¾†é©—è­‰ Vaultï¼Œä¸¦æ”¶åˆ°ä¸€å€‹ Vault tokenã€‚\u003c/p\u003e\n\u003cp\u003eç°¡å–®ä¾†èªªï¼Œgithub organization \u003ca href=\"https://github.com/chechia-net\"\u003echechia-net\u003c/a\u003eï¼Œå¯ä»¥è¨­å®šé©ç•¶çš„æ¬Šé™çµ¦æˆå“¡ chechiachangï¼Œè®“ chechiachang å¯ä»¥é€é github å–å¾—æœ‰æ¬Šé™çš„ tokenã€‚\u003c/p\u003e\n\u003cp\u003eæ³¨æ„\u003c/p\u003e\n\u003cp\u003eåœ¨ç·´ç¿’ä¸­æ‰€æè¿°çš„é€™ç¨®èº«ä»½é©—è­‰æ–¹æ³•ï¼Œéœ€è¦ä½ æ“æœ‰ GitHubã€å±¬æ–¼ GitHub org ä¸­çš„ä¸€å€‹ team ï¼Œä¸¦ç”Ÿæˆäº†å…·æœ‰ \u003ccode\u003eread:org\u003c/code\u003e scope çš„ GitHub personal access tokenã€‚ä½ å¯ä»¥æ–¼ github å‰µå»ºä¸€å€‹ free plan çš„ orgï¼Œä¸¦è¨­å®šä¸€å€‹ teamï¼Œç„¶å¾Œé€éå€‹äºº Settings / Developer Settings ä¾†ç”¢ç”Ÿä¸€æŠŠå…·æœ‰ \u003ccode\u003eread:org\u003c/code\u003e æ¬Šé™çš„ personal access token\u003c/p\u003e\n\u003ch3 id=\"å•Ÿç”¨-github-auth-method\"\u003eå•Ÿç”¨ github auth method\u003c/h3\u003e\n\u003cp\u003eä½ å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼Œåœ¨ path=github/ ä¸‹å•Ÿç”¨ GitHub èº«ä»½é©—è­‰æ–¹æ³•ã€‚\u003c/p\u003e","title":"Vault Workshop 06: Github Auth method"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 05ï¼šAuthentication åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œä½ å·²ç¶“å‰µå»ºäº†ç¬¬ä¸€å€‹ç§˜å¯†ï¼Œäº†è§£äº†ç§˜å¯†å¼•æ“ï¼Œä¸¦åœ¨ä»¥é–‹ç™¼æ¨¡å¼å•Ÿå‹•çš„ Vault æœå‹™å™¨ä¸­æ¢ç´¢äº†å‹•æ…‹ç§˜å¯†ã€‚\næ¥ä¸‹ä¾†çš„å…§å®¹ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥ç ”ç©¶ä½¿ç”¨ Vault token å’Œ GitHub æ†‘è­‰é€²è¡Œèº«ä»½é©—è­‰ã€‚\nToken èº«ä»½é©—è­‰ Token èº«ä»½é©—è­‰å·²è‡ªå‹•å•Ÿç”¨ã€‚ç•¶ä½ å•Ÿå‹•é–‹ç™¼æ¨¡å¼æœå‹™å™¨æ™‚ï¼Œè¼¸å‡ºé¡¯ç¤ºäº† Root tokenã€‚Vault CLI å¾ $VAULT_TOKEN ç’°å¢ƒè®Šæ•¸ä¸­è®€å– Root tokenã€‚é€™å€‹æ ¹ token å¯ä»¥åœ¨ Vault å…§åŸ·è¡Œä»»ä½•æ“ä½œï¼Œå› ç‚ºå®ƒè¢«åˆ†é…äº† Root policy æ¬Šé™ã€‚å…è¨±çš„æ¬Šé™ä¸­åŒ…å«å‰µå»ºæ–°çš„ tokenã€‚\nç¾åœ¨ï¼Œè®“æˆ‘å€‘å‰µå»ºä¸€å€‹æ–°çš„ tokenã€‚\nå•Ÿå‹•å…¨æ–°çš„ dev Vault Server\nvault server -dev outputï¼Œserver log å›å‚³ dev æ¨¡å¼çš„è­¦å‘Š\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory and starts unsealed with a single unseal key. The root token is already authenticated to the CLI, so you can immediately begin using Vault. # è­¦å‘Šï¼å·²å•Ÿç”¨é–‹ç™¼æ¨¡å¼ï¼åœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒVaultå®Œå…¨é‹è¡Œåœ¨å…§å­˜ä¸­ï¼Œä½¿ç”¨å–®å€‹unseal keyè§£å°ã€‚ # root tokenå·²è¢«CLIé©—è­‰ï¼Œå› æ­¤ä½ å¯ä»¥ç«‹å³é–‹å§‹ä½¿ç”¨Vaultã€‚ You may need to set the following environment variables: $ export VAULT_ADDR='http://127.0.0.1:8200' # ä»¥ä¸‹é¡¯ç¤ºäº†unseal key å’Œ root tokenï¼Œä»¥é˜²ä½ æƒ³è¦å°å­˜/è§£å°Vaultï¼Œæˆ–é‡æ–°é€²è¡Œèº«ä»½é©—è­‰ã€‚ The unseal key and root token are displayed below in case you want to seal/unseal the Vault or re-authenticate. # dev æ¨¡å¼é è¨­é…ç½®çš„ unseal key èˆ‡ root token Unseal Key: QDUA...im4= Root Token: hvs.J30e...0DJaN # é–‹ç™¼æ¨¡å¼çµ•ä¸æ‡‰åœ¨ç”Ÿç”¢å®‰è£ä¸­ä½¿ç”¨ï¼ Development mode should NOT be used in production installations! ä¾æ“šæç¤º export éœ€è¦çš„è®Šæ•¸\nexport VAULT_ADDR='http://127.0.0.1:8200' åœ¨ dev mode ä¸‹ï¼Œæœªä½¿ç”¨ token ä¹Ÿå¯ä»¥å­˜å– Vault Server ä¸­çš„è³‡æ–™ï¼Œé€™æ˜¯å› ç‚º vault server åœ¨å•Ÿç”¨æ™‚ï¼Œé è¨­ä½¿ç”¨ token helperï¼Œå°‡ root token å¯«å…¥åˆ° local filesystem\nVault token helper èªªæ˜\nä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼Œæª¢æŸ¥å„²å­˜æ–¼æœ¬åœ°çš„ vault token\ncat ~/.vault-token output\nhvs.J30e...0DJaN% vault CLI è‡ªå‹•å–ç”¨æœ¬åœ°å„²å­˜çš„ root tokenï¼Œæ‰€ä»¥å·²ç¶“è‡ªå‹•å®Œæˆ authenticationï¼Œä¸ç”¨é¡å¤–é€²è¡Œ authenticationï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Vault\nä½¿ç”¨ Vault æ™‚ï¼Œé ˆé¡å¤–æ³¨æ„æœ¬åœ°å„²å­˜çš„ token\né¿å… dev æ¨¡å¼ä¸‹å„²å­˜ root token Vault dev server è‡ªå‹•å¯«å…¥ root tokenï¼Œè®“é–‹ç™¼ Vault åŠŸèƒ½æ™‚ååˆ†ä¾¿åˆ©ã€‚ç„¶è€Œåœ¨è³‡è¨Šå®‰å…¨çš„é ˜åŸŸï¼Œä¾¿åˆ©å¾€å¾€ä»£è¡¨è‘—é¢¨éšªã€‚åœ¨é dev Server ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘æœƒåš´æ ¼æ§åˆ¶æ‰€æœ‰ token çš„æ›éšªç¨‹åº¦ï¼Œç‰¹åˆ¥æ˜¯ root tokenï¼Œæ ¹æœ¬ä¸è©²è¢« print å‡ºï¼Œç•¶ç„¶ä¹Ÿè¬è¬ä¸èƒ½å„²å­˜åœ¨æœ¬åœ°é›»è…¦ã€‚\nä¾æ“šä½ çš„é–‹ç™¼éœ€æ±‚ï¼Œä½ å¯èƒ½ä¸å¸Œæœ› dev æ¨¡å¼ä¸‹ï¼Œlong-live æ°¸ä¹…æœ‰æ•ˆçš„ root token å„²å­˜åœ¨æœ¬åœ°é›»è…¦ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ -dev-no-store-token flag ä¾†é¿å… Vault dev server æš´éœ² root tokenã€‚\nvault server -dev -dev-no-store-token output\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory and starts unsealed with a single unseal key. The root token is already authenticated to the CLI, so you can immediately begin using Vault. You may need to set the following environment variables: $ export VAULT_ADDR='http://127.0.0.1:8200' The unseal key and root token are displayed below in case you want to seal/unseal the Vault or re-authenticate. Unseal Key: hNi8T3YctTZrLYlKezLAJttfiF97D1Vy7Tq+HMM3y9w= Root Token: hvs.qCqY...p89KYv Development mode should NOT be used in production installations! ä½ å¯ä»¥æª¢æŸ¥æœ¬åœ°ä½¿å¦æœ‰å„²å­˜çš„çš„ vault token\ncat ~/.vault-token output\ncat: /Users/che-chia/.vault-token: No such file or directory ç„¶å¾Œè©¦åœ–åœ¨æ²’æœ‰ .vault-token çš„ç‹€æ…‹ä¸‹ï¼Œå­˜å– Vault Server\nvault secrets list outputï¼Œæ²’æœ‰åˆæ³•çš„ access tokenï¼ŒVault server å›å‚³ 403 æ¬Šé™è¢«æ‹’\nvault secrets list Error listing secrets engines: Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/mounts Code: 403. Errors: * permission denied Authentication ä½ å¯ä»¥ä½¿ç”¨ vault dev Server log ä¸­å›å‚³çš„ root token ä¾†å­˜å– Vault server\nä½ å¯ä»¥å°‡ token åœ¨å¯«å› .vault-tokenï¼Œé€™æ˜¯æœ€æ–¹ä¾¿ï¼Œä¹Ÿæœ€å±éšª\nå»ºè­°ï¼šæ°¸é ä¸è¦å„²å­˜ root token åœ¨æœ¬åœ°é›»è…¦ä¸Šã€‚éå¸¸å®¹æ˜“éºå¿˜è‡ªå·±æœ¬åœ°æœ‰å„²å­˜ root tokenã€‚\necho hvs.qCqY...p89KYv \u0026gt; ~/.vault-token å¦ä¸€å€‹æ–¹å¼æ˜¯ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ VAULT_TOKEN\nVAULT_TOKEN=hvs.qCqY...p89KYv vault secrets list ä¸Šé¢æ˜¯åœ¨ CLI å‰é¢æ’å…¥ç’°å¢ƒè®Šæ•¸ï¼Œä¸‹é¢æ˜¯ export VAULT_TOKEN åˆ°ç•¶å‰ session çš„ç’°å¢ƒè®Šæ•¸\nexport VAULT_TOKEN=hvs.qCqY...p89KYv vault secrets list output\nPath Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_9cc57bcf per-token private secret storage identity/ identity identity_41faabef identity store secret/ kv kv_fca914b5 key/value secret storage sys/ system system_5dd83198 system endpoints used for control, policy and debugging ä½ å¯ä»¥æª¢æŸ¥ç›®å‰ç’°å¢ƒè®Šæ•¸ä¸­ï¼Œèˆ‡ Vault æœ‰é—œçš„ env\nenv | grep VAULT output\nVAULT_ADDR=http://127.0.0.1:8200 VAULT_TOKEN=hvs.qCqY...p89KYv ç•¶ç„¶ï¼ŒVAULT_TOKEN çš„å­˜åœ¨æ™‚é–“è¶Šä¹…ï¼Œtoken æ›éšªçš„æ©Ÿç‡å°±è¶Šé«˜ã€‚\nä¹Ÿå¾ˆå®¹æ˜“å¿˜è¨˜ VAULT_TOKEN æœ‰å­˜åœ¨çš„ç’°å¢ƒè®Šæ•¸ã€‚\nVAULT TOKEN é›·é» workshop è‡³ä»Šï¼Œä½ ç›®å‰åªæœ‰ä¸€å° vault dev serverï¼Œè€Œä¸”è£¡é¢ä¸¦æ²’æœ‰ä»»ä½•çš„æ©Ÿå¯†è³‡æ–™ï¼Œé€™å€‹ vault server å¯ä»¥éš¨æ™‚æ‹‹æ£„ã€‚\nç„¶è€Œï¼Œåœ¨å¯¦å‹™ä¸Šï¼ŒVault ç®¡ç†å“¡æ‰‹ä¸Šå¯èƒ½æœƒæœ‰å¤šå€‹ Vault server éœ€è¦ç®¡ç†ã€‚\næƒ³åƒä½ æœ‰ dev / stag / prod çš„ serverï¼ŒæŸä¸€å¤©ä½ æ­£åœ¨ dev é–‹ç™¼ä¸€å€‹æ–°åŠŸèƒ½ï¼Œç”±æ–¼æœ¬åœ°æœ‰ VAULT_TOKEN èˆ‡ VAULT_ADDRï¼Œä½ ä¸ç–‘æœ‰ä»–çš„åœ¨é€™å° server ä¸Šé‹è¡Œè¨±å¤šæ¸¬è©¦çš„æŒ‡ä»¤ï¼ŒåŒ…å«æ–°å¢ä¸€å°æ¸¬è©¦ secretï¼Œåˆªåˆªæ”¹æ”¹ç¾æœ‰çš„ secretã€‚\nç„¶å¾Œä½ çš„æœ¬èƒ½å¿½ç„¶è¦ºå¾—æ€ªæ€ªçš„ï¼Œæˆ‘æ²’æœ‰è¨­ç½®ä»»ä½• vault envï¼Œç‚ºä½•å¯ä»¥ç›´æ¥å­˜å– dev serverï¼Ÿ\nä½ æ‹‰å‡º env çœ‹ï¼Œç™¼ç¾æ˜¯ production server çš„ addr + tokenï¼Œä¸Šæ¬¡é€²å…¥ production server æ™‚çš„ sessionï¼Œé‚„å­˜æœ‰æœ‰æ•ˆçš„ addr èˆ‡ token\nVAULT_ADDR=http://vault.prod.chechia.net VAULT_TOKEN=this-is-prod-token ä½ éº»ç…©å¤§äº†\nå¿ƒå¾—ï¼šæ°¸é ä¸è¦å„²å­˜é•·æ•ˆæœŸçš„ token åœ¨æœ¬åœ°ã€‚æœ¬ workshop æœƒä¸æ–·åœ°å¼·èª¿ï¼Œæé†’å„ç¨®æ“ä½œä¸­çš„è³‡å®‰é¢¨éšªï¼Œè«‹å„ä½å­¸ç¿’éç¨‹ä¸­å°±é¤Šæˆè‰¯å¥½ç¿’æ…£ï¼Œä»¥å…æ–¹ä¾¿ä¸€æ™‚ï¼Œéºæ†¾çµ‚èº«ã€‚\nroot token https://developer.hashicorp.com/vault/docs/concepts/tokens#root-tokens\nroot tokenæ˜¯é™„å¸¶root policyçš„tokenã€‚root tokenå¯ä»¥åœ¨Vaultä¸­åŸ·è¡Œä»»ä½•æ“ä½œã€‚ä»»ä½•æ“ä½œã€‚\næ­¤å¤–ï¼Œå®ƒå€‘æ˜¯Vaultä¸­å”¯ä¸€å¯ä»¥è¨­ç½®ç‚ºæ°¸ä¸éæœŸï¼Œä¸”ç„¡éœ€é€²è¡Œä»»ä½•çºŒè¨‚çš„ token é¡å‹ã€‚ç”±æ–¼ root token æ¬Šé™å¦‚æ­¤å¤§ï¼ŒVault è¨­è¨ˆä¸Šåˆ»æ„è®“å‰µå»ºroot token å¾ˆå›°é›£ï¼›å¯¦éš›ä¸Šåªæœ‰ä¸‰ç¨®æ–¹æ³•å¯ä»¥å‰µå»ºroot tokenï¼š\nåœ¨ vault operator init æ™‚ç”Ÿæˆçš„åˆå§‹root token - æ­¤tokenä¸æœƒéæœŸ\nä½¿ç”¨å¦ä¸€å€‹root token å‰µå»º root tokenã€‚é€™é»æœ‰å€‹é™åˆ¶ï¼šä½¿ç”¨æœ‰é™æœŸçš„root tokenï¼Œç„¡æ³•å‰µå»ºæ°¸ä¸éæœŸçš„root token\nåœ¨æ“æœ‰ unseal keys quorumçš„æ¬Šé™ä¸‹ï¼Œä½¿ç”¨ vault operator generate-root ä¾†å‰µå»ºroot token\nroot tokenåœ¨é–‹ç™¼ä¸­å¾ˆæœ‰ç”¨ï¼Œä½†åœ¨ production ç’°å¢ƒä¸­æ‡‰è©²éå¸¸è¬¹æ…ä½¿ç”¨ã€‚\näº‹å¯¦ä¸Šï¼ŒVaultåœ˜éšŠå»ºè­° root token åªèƒ½é€²è¡Œå¿…è¦çš„åˆå§‹è¨­ç½®ï¼Œé€šå¸¸æ˜¯è¨­ç½®èº«ä»½é©—è­‰æ–¹æ³•(auth method)ï¼Œå’Œå¿…è¦çš„ policyï¼Œä»¥å…è¨±ç®¡ç†å“¡ç²å–æ›´æœ‰é™çš„tokenã€‚æˆ–æ˜¯ç·Šæ€¥æƒ…æ³ä¸‹ä½¿ç”¨root tokenï¼Œä¸¦åœ¨ä¸å†éœ€è¦æ™‚ç«‹å³æ’¤éŠ·(revoke)ã€‚\nå¦‚æœéœ€è¦æ–°çš„root tokenï¼Œå¯ä»¥ä½¿ç”¨ operator generate-root æŒ‡ä»¤ï¼Œä½¿ç”¨ç›¸é—œçš„ API endpointå³æ™‚ç”Ÿæˆã€‚\nåŒæ™‚ï¼Œç•¶root tokenè™•æ–¼æ´»å‹•ç‹€æ…‹æ™‚ï¼Œå»ºè­°åœ˜éšŠä¸­æä¾›å¤šäººä¸€èµ·å”ä½œï¼Œå…±åŒæª¢æŸ¥ terminal sessionï¼Œé¤Šæˆä¸€ç¨®è‰¯å¥½çš„å®‰å…¨å¯¦è¸ã€‚é€™æ¨£å¤šäººå¯ä»¥é©—è­‰ä½¿ç”¨root tokenåŸ·è¡Œçš„ä»»å‹™ï¼Œä»¥åŠé€™äº›ä»»å‹™å®Œæˆå¾Œï¼Œç«‹å³æ’¤éŠ·äº†è©²tokenã€‚\nä½¿ç”¨ root token ç”¢ç”Ÿ short-live token root token é è¨­é…ç½® root policyï¼Œæˆ‘å€‘å¯ä»¥ç”¢ç”Ÿæ¬Šé™è¼ƒå°çš„ tokenï¼Œä¸¦æŒ‡é…ç½®æœ€å°å¿…è¦æ¬Šé™(least privilege)\nVAULT_TOKEN=hvs.qCqY...p89KYv vault token create Key Value --- ----- token hvs.FbAeX...kjBIp token_accessor rPOOSI06WGnFo9MVOvS8luhn token_duration âˆ token_renewable false token_policies [\u0026quot;root\u0026quot;] identity_policies [] policies [\u0026quot;root\u0026quot;] å·²å‰µå»ºtokenï¼Œè¼¸å‡ºä¸­ä»¥key valueçš„è¡¨æ ¼æè¿°äº†æ­¤tokenã€‚å‰µå»ºçš„tokenåœ¨æ­¤è™•é¡¯ç¤ºç‚º hvs.FbAeX\u0026hellip;kjBIp\næ­¤tokenæ˜¯root tokençš„å­tokenï¼Œä¸¦ä¸”é è¨­æƒ…æ³ä¸‹ï¼Œå®ƒæœƒç¹¼æ‰¿å…¶ parent tokençš„policy æ¬Šé™ã€‚\ntokenæ˜¯æ ¸å¿ƒèº«ä»½é©—è­‰æ–¹æ³•(core auth method)ã€‚ä½ å¯ä»¥ä½¿ç”¨ç”Ÿæˆçš„tokenä¾† login Vaultï¼Œåªéœ€åœ¨æç¤ºæ™‚è¤‡è£½ä¸¦ç²˜è²¼å³å¯ã€‚\nä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ç™»å…¥ vault\nvault login åœ¨å›å‚³çš„è¼¸å…¥ä»¤ä¸­è¼¸å…¥æ–°ç”¢ç”Ÿçš„ child token hvs.FbAeX\u0026hellip;kjBIp\nWARNING! The VAULT_TOKEN environment variable is set! The value of this variable will take precedence; if this is unwanted please unset VAULT_TOKEN or update its value accordingly. # è­¦å‘Šï¼å·²è¨­ç½® VAULT_TOKEN ç’°å¢ƒè®Šæ•¸ï¼æ­¤è®Šæ•¸çš„å€¼å°‡å„ªå…ˆè€ƒæ…®ï¼›å¦‚æœä¸éœ€è¦æ­¤è¨­ç½®ï¼Œè«‹å–æ¶ˆè¨­ç½® VAULT TOKEN æˆ–ç›¸æ‡‰åœ°æ›´æ–°å…¶å€¼ã€‚ ç”±æ–¼åœ¨å‰é¢çš„æ“ä½œä¸­ï¼Œç’°å¢ƒè®Šæ•¸ä¸­ä»å¸¶æœ‰ VAULT_TOKENï¼Œè€Œä¸”æ˜¯æ›´é«˜æ¬Šé™çš„æ°¸ä¸éæœŸ root tokenï¼Œvault CLI åµæ¸¬åˆ° VAULT TOKEN envï¼Œè·³å‡ºè­¦å‘Šã€‚\nä½ å¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤æ¸…é™¤ VAULT_TOKEN ç’°å¢ƒè®Šæ•¸\nunset VAULT_TOKEN ç„¶å¾Œå†æ¬¡åŸ·è¡Œ vault loginï¼Œåœ¨å›å‚³çš„è¼¸å…¥ä»¤ä¸­è¼¸å…¥æ–°ç”¢ç”Ÿçš„ child token hvs.FbAeX\u0026hellip;kjBIp\nvault login outputï¼Œé¡¯ç¤ºæˆåŠŸç™»å…¥ï¼Œä¸¦å›å‚³ token çš„ç›¸é—œè¨Šæ¯\nToken (will be hidden): Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \u0026quot;vault login\u0026quot; again. Future Vault requests will automatically use this token. Key Value --- ----- token hvs.FbAeX...kjBIp token_accessor rPOOSI06WGnFo9MVOvS8luhn token_duration âˆ token_renewable false token_policies [\u0026quot;root\u0026quot;] identity_policies [] policies [\u0026quot;root\u0026quot;] æ­¤tokenæ˜¯root tokençš„å­tokenï¼Œç¹¼æ‰¿å…¶ parent tokençš„policy æ¬Šé™ï¼Œä¹Ÿå°±æ˜¯ rootã€‚æœ¬èº«æ˜¯ç„¡æ•ˆæœŸé™åˆ¶çš„æ°¸ä¹… root tokenã€‚\nåœ¨å‰µå»ºä¸€æŠŠ tokenï¼Œæ­¤æ™‚ç”±æ–¼ vault loginï¼Œé€²å…¥ç™»å…¥ç‹€æ…‹ï¼Œtoken å·²ç¶“å­˜åœ¨æœ¬åœ°ä¸­\nvault token create outputï¼Œç¬¬äºŒéš» token ç‚º hvs.FDjvyRFXo\u0026hellip;QVFGã€‚æ¯ä¸€éš» token éƒ½æ˜¯ä¸é‡è¤‡çš„ã€‚\nKey Value --- ----- token hvs.FDjvyRFXo...QVFG token_accessor gLe7IrUMUq4eb2pZWVdUhbHv token_duration âˆ token_renewable false token_policies [\u0026quot;root\u0026quot;] identity_policies [] policies [\u0026quot;root\u0026quot;] revoke æ’¤éŠ· token ç•¶æˆ‘å€‘ä¸å†éœ€è¦ä½¿ç”¨ token æ™‚ï¼Œæœ€å¥½ç›¡å¿«æ’¤éŠ· revoke token\nç›®å‰çš„ token æ¨¹ç‹€çµæ§‹\nåˆå§‹ root token (å•Ÿå‹• dev Server æ™‚é è¨­ç”¢ç”Ÿçš„)\nchild: hvs.FbAeX\u0026hellip;kjBIp grandchild: hvs.FDjvyRFXo\u0026hellip;QVFG ä½ å¯ä»¥ä½¿ç”¨æŒ‡ä»¤ï¼Œæ’¤éŠ·ç¬¬ä¸€æŠŠç”¢ç”Ÿçš„ token (child)\nvault token revoke hvs.FbAeX...kjBIp CLI outputï¼Œé¡¯ç¤º token å·²ç¶“æ’¤éŠ·\nSuccess! Revoked token (if it existed) åŒæ™‚ï¼Œvault server log ç´€éŒ„ revoked lease\n2023-09-16T21:29:21.464+0800 [INFO] expiration: revoked lease: lease_id=auth/token/create/hf153f5e80ed722f6816f592032a43906a5606a889bab4c13ff3368c9a1b95b69 é‚„è¨˜å¾—æˆ‘å€‘æ˜¯ä½¿ç”¨åœ°ä¸€æŠŠç”¢ç”Ÿçš„ token (child) login çš„å—ï¼Ÿç›®å‰çš„ç™»å…¥ç•¶ç„¶ä¹Ÿéš¨è‘— token å¤±æ•ˆï¼Œå˜—è©¦å­˜å–å›å‚³ 403 æ¬Šé™è¢«æ‹’\nvault secrets list Error listing secrets engines: Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/mounts Code: 403. Errors: * permission denied å˜—è©¦é‡æ–° loginï¼Œä½¿ç”¨åœ°ä¸€æŠŠç”¢ç”Ÿçš„ token (child) ä¸€æ¨£è¢«æ‹’\nvault login output\nToken (will be hidden): Error authenticating: error looking up token: Error making API request. URL: GET http://127.0.0.1:8200/v1/auth/token/lookup-self Code: 403. Errors: * permission denied æ’¤éŠ·token æ™‚ï¼Œä¹Ÿæœƒä¸€ä½µæ’¤éŠ·ä½¿ç”¨é€™æŠŠ token ç”¢ç”Ÿçš„å­ token (grandchild)\nå˜—è©¦é‡æ–° loginï¼Œä½¿ç”¨ç¬¬äºŒæŠŠç”¢ç”Ÿçš„ token (grandchild) ä¸€æ¨£è¢«æ‹’\nvault login output\nToken (will be hidden): Error authenticating: error looking up token: Error making API request. URL: GET http://127.0.0.1:8200/v1/auth/token/lookup-self Code: 403. Errors: * permission denied ç‚ºä½•ç¸½æ˜¯è¦ä½¿ç”¨ root token ä¸Šé¢è¬›äº† vault æ ¸å¿ƒçš„ token auth methodï¼Œç›¸ä¿¡è®€è€…ä¸€å®šæœ‰ä¸€å€‹å¥‡æ€ªçš„æ„Ÿè¦º\næœ€é–‹å§‹ login éœ€è¦ token ç”¢ç”Ÿ token åœ¨å»ç”¢ç”Ÿæ–°çš„ token é€™æ¨£ç”¢ç”Ÿ token çš„ admin ä¸å°±éœ€è¦å°‡ token å…ˆå‚³çµ¦ä½¿ç”¨è€…ï¼Œä½¿ç”¨è€…æ‰èƒ½ç™»å…¥å—ï¼Ÿé€™æ¨£å‚³é token çš„è¡Œç‚ºï¼Œä¸æ˜¯åè€Œå¢åŠ æ›´å¤§çš„æ›éšªã€‚\né€™æ¨£çœŸçš„æœ‰æ¯”ä¸€èˆ¬ä½¿ç”¨ username password ç™»å…¥çš„æ–¹æ³•æ›´å®‰å…¨å—ï¼Ÿ\nä¸Šé¢çš„æƒ³æ³•éƒ½æ˜¯æœ‰é“ç†çš„ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œå…‰ä½¿ç”¨ token auth methods æ˜¯ç„¡æ³•æ»¿è¶³æˆ‘å€‘çš„å®‰å…¨éœ€æ±‚ã€‚é€™äº›å®‰å…¨éœ€æ±‚ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»– auth method æ–¹æ³•ä¾†è§£æ±ºï¼Œè€Œ vault å¼·å¤§ä¹‹è™•ä¾¿æ˜¯æ”¯æ´çš„è¨±å¤š auth methodï¼Œå°‡ vault çš„å®‰å…¨å»ºç«‹åœ¨å…¶ä»–æ›´ç©©å®šçš„æœå‹™ä¸Šï¼Œä¾‹å¦‚ github / aws / azure / gcp / kubernetes ç­‰ã€‚\nä¸‹ä¸€ç¯‡ï¼Œæˆ‘å€‘å°±ä¾†å¯¦ä½œ github auth methodã€‚\nchatGPT æœ¬æ®µéƒ¨åˆ†å…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-authentication å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ ä¸è¦ä½¿ç”¨æ•¬èªï¼Œç¿»è­¯çµæœä¸­è‹¥å‡ºç¾\u0026quot;æ‚¨\u0026quot;ï¼Œè«‹ç”¨\u0026quot;ä½ \u0026quot;å–ä»£\u0026quot;æ‚¨\u0026quot;ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“šåº«\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™åº«\u0026quot;ï¼Œå°‡ \u0026quot;æ•¸æ“š\u0026quot; æ”¹ç‚º \u0026quot;è³‡æ–™\u0026quot;ï¼Œå°‡ \u0026quot;è¨ªå•\u0026quot; æ”¹ç‚º \u0026quot;å­˜å–\u0026quot;ï¼Œå°‡ \u0026quot;æºä»£ç¢¼\u0026quot; æ”¹ç‚º \u0026quot;åŸå§‹ç¢¼\u0026quot;ï¼Œå°‡ \u0026quot;ä¿¡æ¯\u0026quot; æ”¹ç‚º \u0026quot;è³‡è¨Š\u0026quot;ï¼Œå°‡ \u0026quot;å‘½ä»¤\u0026quot; æ”¹ç‚º \u0026quot;æŒ‡ä»¤\u0026quot;ï¼Œå°‡ \u0026quot;ç¦ç”¨\u0026quot; æ”¹ç‚º \u0026quot;åœç”¨\u0026quot;ï¼Œå°‡ \u0026quot;é»˜èª\u0026quot; æ”¹ç‚º \u0026quot;é è¨­\u0026quot;ã€‚ ","permalink":"https://chechia.net/posts/2023-09-16-vault-workshop-authentication/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-05authentication\"\u003eDay 05ï¼šAuthentication\u003c/h1\u003e\n\u003cp\u003eåœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œä½ å·²ç¶“å‰µå»ºäº†ç¬¬ä¸€å€‹ç§˜å¯†ï¼Œäº†è§£äº†ç§˜å¯†å¼•æ“ï¼Œä¸¦åœ¨ä»¥é–‹ç™¼æ¨¡å¼å•Ÿå‹•çš„ Vault æœå‹™å™¨ä¸­æ¢ç´¢äº†å‹•æ…‹ç§˜å¯†ã€‚\u003c/p\u003e\n\u003cp\u003eæ¥ä¸‹ä¾†çš„å…§å®¹ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥ç ”ç©¶ä½¿ç”¨ Vault token å’Œ GitHub æ†‘è­‰é€²è¡Œèº«ä»½é©—è­‰ã€‚\u003c/p\u003e\n\u003ch3 id=\"token-èº«ä»½é©—è­‰\"\u003eToken èº«ä»½é©—è­‰\u003c/h3\u003e\n\u003cp\u003eToken èº«ä»½é©—è­‰å·²è‡ªå‹•å•Ÿç”¨ã€‚ç•¶ä½ å•Ÿå‹•é–‹ç™¼æ¨¡å¼æœå‹™å™¨æ™‚ï¼Œè¼¸å‡ºé¡¯ç¤ºäº† Root tokenã€‚Vault CLI å¾ \u003ccode\u003e$VAULT_TOKEN\u003c/code\u003e ç’°å¢ƒè®Šæ•¸ä¸­è®€å– Root tokenã€‚é€™å€‹æ ¹ token å¯ä»¥åœ¨ Vault å…§åŸ·è¡Œä»»ä½•æ“ä½œï¼Œå› ç‚ºå®ƒè¢«åˆ†é…äº† Root policy æ¬Šé™ã€‚å…è¨±çš„æ¬Šé™ä¸­åŒ…å«å‰µå»ºæ–°çš„ tokenã€‚\u003c/p\u003e\n\u003cp\u003eç¾åœ¨ï¼Œè®“æˆ‘å€‘å‰µå»ºä¸€å€‹æ–°çš„ tokenã€‚\u003c/p\u003e\n\u003cp\u003eå•Ÿå‹•å…¨æ–°çš„ dev Vault Server\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003evault server -dev\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eoutputï¼Œserver log å›å‚³ dev æ¨¡å¼çš„è­¦å‘Š\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory\nand starts unsealed with a single unseal key. The root token is already\nauthenticated to the CLI, so you can immediately begin using Vault.\n\n# è­¦å‘Šï¼å·²å•Ÿç”¨é–‹ç™¼æ¨¡å¼ï¼åœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒVaultå®Œå…¨é‹è¡Œåœ¨å…§å­˜ä¸­ï¼Œä½¿ç”¨å–®å€‹unseal keyè§£å°ã€‚\n# root tokenå·²è¢«CLIé©—è­‰ï¼Œå› æ­¤ä½ å¯ä»¥ç«‹å³é–‹å§‹ä½¿ç”¨Vaultã€‚\n\nYou may need to set the following environment variables:\n\n    $ export VAULT_ADDR='http://127.0.0.1:8200'\n\n# ä»¥ä¸‹é¡¯ç¤ºäº†unseal key å’Œ root tokenï¼Œä»¥é˜²ä½ æƒ³è¦å°å­˜/è§£å°Vaultï¼Œæˆ–é‡æ–°é€²è¡Œèº«ä»½é©—è­‰ã€‚\n\n    The unseal key and root token are displayed below in case you want to\n    seal/unseal the Vault or re-authenticate.\n\n# dev æ¨¡å¼é è¨­é…ç½®çš„ unseal key èˆ‡ root token\n    Unseal Key: QDUA...im4=\n    Root Token: hvs.J30e...0DJaN\n\n# é–‹ç™¼æ¨¡å¼çµ•ä¸æ‡‰åœ¨ç”Ÿç”¢å®‰è£ä¸­ä½¿ç”¨ï¼\n    Development mode should NOT be used in production installations!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¾æ“šæç¤º export éœ€è¦çš„è®Šæ•¸\u003c/p\u003e","title":"Vault Workshop 05: Authentication"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 04ï¼šSecret Engine KV V2 KVç§˜å¯†å¼•æ“ï¼Œç”¨æ–¼åœ¨Vaultçš„å·²é…ç½®ç‰©ç†Storageä¸­ï¼Œå­˜å„²ä»»æ„ç§˜å¯†ã€‚\nkey åç¨±å¿…é ˆå§‹çµ‚æ˜¯å­—ç¬¦ä¸²ã€‚å¦‚æœä½ ç›´æ¥é€šéCLIç·¨å¯«éå­—ä¸² valueï¼Œå®ƒå€‘å°‡è¢«è½‰æ›ç‚ºå­—ä¸²ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥é€šéå¾JSONæ–‡ä»¶ä¸­å°‡key-value pairå¯«å…¥Vaultï¼Œæˆ–ä½¿ç”¨HTTP APIä¾†ä¿ç•™éå­—ä¸² valueã€‚\næ­¤ç§˜å¯†å¼•æ“éµç…§ACL policyä¸­ï¼Œå‰µå»º(create)å’Œæ›´æ–°(update)æ¬Šé™ä¹‹é–“çš„è¨­å®šã€‚å®ƒé‚„æ”¯æŒpatchåŠŸèƒ½ï¼Œç”¨æ–¼è¡¨ç¤ºéƒ¨åˆ†æ›´æ–°(patch)ï¼Œè€Œæ›´æ–°åŠŸèƒ½(update)å‰‡è¡¨ç¤ºå®Œå…¨è¦†è“‹ã€‚\nè¨­ç½® å¤§å¤šæ•¸ç§˜å¯†å¼•æ“å¿…é ˆåœ¨åŸ·è¡Œå…¶åŠŸèƒ½ä¹‹å‰äº‹å…ˆé…ç½®ã€‚é€™äº›æ­¥é©Ÿé€šå¸¸ç”±æ“ä½œäººå“¡æˆ–é…ç½®ç®¡ç†å·¥å…·å®Œæˆã€‚\nå•Ÿç”¨v2 kvç§˜å¯†å¼•æ“ï¼š\nå•Ÿå‹•ä¸€å€‹ä¹¾æ·¨çš„æœ¬åœ°çš„é–‹ç™¼æ¨¡å¼ Vault Serverï¼Œå…¨æ–°çš„ Vault Server åŒ…å«åº•ä¸‹é è¨­å•Ÿç”¨çš„å¼•æ“\nvault server -dev export VAULT_ADDR='http://127.0.0.1:8200' vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging ä½ å¯ä»¥åœ¨æŒ‡å®šçš„è·¯å¾‘ä¸‹ï¼Œå•Ÿç”¨ä¸€å€‹æ–°çš„ v2 kv ç§˜å¯†å¼•æ“ã€‚è‹¥ä¸æŒ‡å®š -path åƒæ•¸ï¼Œå‰‡é è¨­ path ç‚º typeï¼Œä¹Ÿå°±æ˜¯ path=kvã€‚\nvault secrets enable -version=2 -path=kv kv Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_57a4ca51 per-token private secret storage identity/ identity identity_c2ecbd49 identity store kv/ kv kv_904eee17 n/a secret/ kv kv_c41afde8 key/value secret storage sys/ system system_c063e514 system endpoints used for control, policy and debugging æˆ–è€…ï¼Œä½ å¯ä»¥å°‡kv-v2ä½œç‚ºç§˜å¯†å¼•æ“é¡å‹ï¼Œä»¥åƒæ•¸å‚³éï¼š\nvault secrets enable kv-v2 ä¸Šé¢çš„æŒ‡ä»¤èˆ‡ä¸‹é¢çš„æŒ‡ä»¤ç­‰æ•ˆï¼Œé‡è¤‡åŸ·è¡Œæœƒå‡ºç¾è·¯å¾‘é‡è¤‡éŒ¯èª¤\nvault secrets enable -path kv-v2 -version=2 kv-v2 Error enabling: Error making API request. URL: POST http://127.0.0.1:8200/v1/sys/mounts/kv-v2 Code: 400. Errors: * path is already in use at kv-v2/ ä½ å¯ä»¥åœç”¨ä¸€å€‹ç§˜å¯†å¼•æ“\nvault secrets disable kv-v2 ç‚ºäº†å­¸ç¿’æ•ˆæœï¼Œå¾€å¾Œèª²ç¨‹éƒ½æœƒä½¿ç”¨æ›´å®Œæ•´çš„æŒ‡ä»¤ï¼Œä½œç‚ºç¤ºç¯„ã€‚\næ›´å¤šå•Ÿç”¨ç§˜å¯†å¼•æ“çš„æŒ‡ä»¤ï¼Œä½ å¯ä»¥åƒè€ƒ vault secrets enable \u0026ndash;help çš„å”åŠ©æŒ‡ä»¤\nvault secrets enable --help Usage: vault secrets enable [options] TYPE Enables a secrets engine. By default, secrets engines are enabled at the path corresponding to their TYPE, but users can customize the path using the -path option. å•Ÿç”¨ç§˜å¯†å¼•æ“ã€‚é è¨­æƒ…æ³ä¸‹ï¼Œç§˜å¯†å¼•æ“æœƒåœ¨èˆ‡å…¶é¡å‹ç›¸å°æ‡‰çš„è·¯å¾‘å•Ÿç”¨ï¼Œä½†ä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨ -path é¸é …è‡ªè¨‚è·¯å¾‘ã€‚ Once enabled, Vault will route all requests which begin with the path to the secrets engine. ä¸€æ—¦å•Ÿç”¨ï¼ŒVault å°‡å°‡æ‰€æœ‰ä»¥è©²è·¯å¾‘é–‹é ­çš„è«‹æ±‚è·¯ç”±åˆ°ç§˜å¯†å¼•æ“ã€‚ Enable the AWS secrets engine at aws/: $ vault secrets enable aws Enable the SSH secrets engine at ssh-prod/: $ vault secrets enable -path=ssh-prod ssh Enable the database secrets engine with an explicit maximum TTL of 30m: $ vault secrets enable -max-lease-ttl=30m database Enable a custom plugin (after it is registered in the plugin registry): $ vault secrets enable -path=my-secrets -plugin-name=my-plugin plugin OR (preferred way): $ vault secrets enable -path=my-secrets my-plugin å¾ä¸Šé¢çš„å…§å®¹ï¼Œå¯ä»¥çœ‹åˆ°ç§˜å¯†å¼•æ“æ”¯æ´å„ç¨®ä¸åŒçš„ç§˜å¯†é¡å‹ï¼Œä¾‹å¦‚ä»¥ä¸‹éƒ½æ˜¯ä¸€å€‹ç§˜å¯†å¼•æ“é¡å‹ï¼šawsï¼Œsshï¼Œdatabaseï¼Œpluginã€‚\næ³¨æ„ï¼Œè«‹ä¸è¦å¼„æ·· path=aws çš„ç§˜å¯†å¼•æ“ï¼Œä»¥åŠ type=aws çš„ç§˜å¯†å¼•æ“ã€‚åº•ä¸‹æ˜¯ä¸€å€‹ååˆ†æ··æ·†çš„ä¾‹å­ï¼š\nvault secrets enable --version=2 --path=kv-v1 kv vault secrets enable --version=1 --path=kv-v2 kv vault secrets list --detailed Path Plugin Accessor Default TTL Max TTL Force No Cache Replication Seal Wrap External Entropy Access Options Description UUID Version Running Version Running SHA256 Deprecation Status ---- ------ -------- ----------- ------- -------------- ----------- --------- ----------------------- ------- ----------- ---- ------- --------------- -------------- ------------------ cubbyhole/ cubbyhole cubbyhole_57a4ca51 n/a n/a false local false false map[] per-token private secret storage cee0001e-95f8-efaa-6a9a-a3d5c3573abc n/a v1.14.3+builtin.vault n/a n/a identity/ identity identity_c2ecbd49 system system false replicated false false map[] identity store 3b481e0d-1c6d-6698-85c3-c52839b4d6e4 n/a v1.14.3+builtin.vault n/a n/a kv-v1/ kv kv_c8de7a39 system system false replicated false false map[version:2] n/a 98289587-5b5d-06f3-c3cf-469e830eda9e n/a v0.15.0+builtin n/a supported kv-v2/ kv kv_f83d9acd system system false replicated false false map[version:1] n/a 5fc è«‹ä¸è¦åšé€™ç¨®ä¸è‰¯çš„å‘½åï¼Œèª¤å°è‡ªå·±ä¹Ÿèª¤å°åˆ¥äººã€‚ä¸å»ºè­°æŠŠ engine type ç•¶ä½œ pathï¼Œå¯¦å‹™ä¸Šä¹Ÿæ²’æœ‰å¿…è¦é€™å€‹åšã€‚\nvault secrets disable kv-v1 vault secrets disable kv-v2 ä½¿ç”¨å…¬å¸çµ„ç¹”ï¼Œåœ˜éšŠï¼Œå°ˆæ¡ˆåç¨±ï¼Œä½œç‚º engine path çš„å‘½åï¼Œæ˜¯å€‹ä¸éŒ¯çš„èµ·é»ã€‚\norg = chechia.net team = sre project = workshop vault secrets enable --version=2 --path=chechia-net/sre/workshop kv ä½¿ç”¨ v2 kv åœ¨ç§˜å¯†å¼•æ“é…ç½®å®Œæˆï¼Œä¸”ç”¨æˆ¶/æ©Ÿå™¨å…·å‚™å…·æœ‰é©ç•¶æ¬Šé™çš„Vault tokenå¾Œï¼Œå®ƒå¯ä»¥ç”Ÿæˆæ†‘è­‰ã€‚KVç§˜å¯†å¼•æ“å…è¨±å°‡ä»»æ„vvalueå¯«å…¥æŒ‡å®šçš„keyã€‚\nåœ¨KV-v2ä¸­ä»ç„¶å¯ä»¥ä½¿ç”¨é¡ä¼¼è·¯å¾‘çš„KV-v1èªæ³•ä¾†å¼•ç”¨ç§˜å¯†ï¼ˆsecret/fooï¼‰ï¼Œä½†æˆ‘å€‘å»ºè­°ä½¿ç”¨-flagçš„èªæ³•ä»¥é¿å…å°‡å…¶éŒ¯èª¤èªç‚ºæ˜¯ç§˜å¯†çš„å¯¦éš›è·¯å¾‘ï¼ˆsecret/data/fooæ˜¯çœŸæ­£çš„è·¯å¾‘ï¼‰ã€‚\nå¯«å…¥/è®€å–ä»»æ„è³‡æ–™ å¯«å…¥ä»»æ„è³‡æ–™ï¼š\nvault kv put -mount=chechia-net/sre/workshop my-secret foo=a bar=b ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 1 è®€å–ä»»æ„è³‡æ–™ï¼š\nvault kv get -mount=chechia-net/sre/workshop my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 1 === Data === Key Value --- ----- bar b foo a å¤šç‰ˆæœ¬æ§åˆ¶ v2 kv æ”¯æ´è¨˜éŒ„å¤šç‰ˆæœ¬çš„ç§˜å¯†ã€‚è«‹æä¾›å¦ä¸€å€‹ç‰ˆæœ¬ï¼Œä»¥å‰çš„ç‰ˆæœ¬ä»ç„¶å¯è¨ªå•ã€‚\nå¯ä»¥é¸æ“‡å‚³é-cas flagä»¥åŸ·è¡Œå¯«å…¥å‰æª¢æŸ¥(check-and-set)ã€‚å¦‚æœæœªè¨­ç½®ï¼Œå°‡ç›´æ¥å…è¨±å¯«å…¥ã€‚\nç‚ºäº†ä½¿å¯«å…¥æˆåŠŸï¼Œcaså¿…é ˆè¨­ç½®ç‚ºç§˜å¯†çš„ç•¶å‰ç‰ˆæœ¬ã€‚å¦‚æœè¨­ç½®ç‚º0ï¼Œåªæœ‰åœ¨å¯†é‘°ä¸å­˜åœ¨æ™‚æ‰å…è¨±å¯«å…¥ï¼Œå› ç‚ºæœªè¨­ç½®çš„å¯†é‘°æ²’æœ‰ä»»ä½•ç‰ˆæœ¬ä¿¡æ¯ã€‚\né‚„è¦è¨˜ä½ï¼Œsoft delete ä¸æœƒå¾å­˜å„²ä¸­åˆªé™¤ä»»ä½•åº•å±¤ç‰ˆæœ¬æ•¸æ“šã€‚ç‚ºäº†å¯«å…¥ soft delete çš„å¯†é‘°ï¼Œcasåƒæ•¸å¿…é ˆåŒ¹é…å¯†é‘°çš„ç•¶å‰ç‰ˆæœ¬ã€‚\nvault kv put -mount=chechia-net/sre/workshop -cas=1 my-secret foo=aa bar=bb ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:50:26.621978Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 2 è®€å–æœƒå›å‚³æœ€æ–°ç‰ˆæœ¬çš„ç§˜å¯†\nvault kv get -mount=chechia-net/sre/workshop my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:50:26.621978Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 2 === Data === Key Value --- ----- bar bb foo aa å¯ä»¥ä½¿ç”¨vault kv patchå‘½ä»¤é€²è¡Œéƒ¨åˆ†æ›´æ–°ã€‚\nè©²å‘½ä»¤å°‡é¦–å…ˆå˜—è©¦é€²è¡ŒHTTP PATCHè«‹æ±‚ï¼Œè©²è«‹æ±‚éœ€è¦patch ACLåŠŸèƒ½ã€‚å¦‚æœä½¿ç”¨çš„ token æ²’æœ‰å…è¨±patchåŠŸèƒ½çš„policyï¼Œå‰‡PATCHè«‹æ±‚å°‡å¤±æ•—ã€‚\nåœ¨ç¾åœ¨çš„ç¯„ä¾‹ï¼Œå®Œæ•´çš„PATCHå‘½ä»¤å°‡åŸ·è¡Œè®€å–ã€æœ¬åœ°æ›´æ–°å’Œå¾ŒçºŒå¯«å…¥ï¼Œé€™éœ€è¦è®€å–å’Œæ›´æ–°ACL policyæ¬Šé™ã€‚\nå¯ä»¥é¸æ“‡å‚³é-cas flag ä»¥åŸ·è¡Œå¯«å…¥å‰æª¢æŸ¥(check-and-set)ã€‚-cas åªæœƒåœ¨åˆå§‹PATCHè«‹æ±‚çš„æƒ…æ³ä¸‹ç”Ÿæ•ˆã€‚\nvault kv patch -mount=chechia-net/sre/workshop -cas=2 my-secret bar=bbb ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:54:03.925959Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 3 vault kv patchå‘½ä»¤é‚„æ”¯æŒä¸€å€‹ -method æ¨™èªŒï¼Œå¯ç”¨æ–¼æŒ‡å®šå…©ç¨® method\nHTTP PATCH è®€å–å¾Œå¯«å…¥(read-and-write) æ”¯æŒçš„å€¼åˆ†åˆ¥æ˜¯patchå’Œrw ä½¿ç”¨patchæ–¹æ³•\nvault kv patch -mount=chechia-net/sre/workshop -method=patch -cas=3 my-secret bar=bbb ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:02:55.522095Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 4 ä½¿ç”¨read-and-write\nå¦‚æœä½¿ç”¨è®€å–å¾Œå¯«å…¥(read-and-write)æµç¨‹ï¼Œå°‡ä½¿ç”¨è®€å–è¿”å›çš„ç§˜å¯†ç‰ˆæœ¬å€¼ï¼Œåœ¨å¾ŒçºŒå¯«å…¥ä¸­ï¼ŒåŸ·è¡Œå¯«å…¥å‰æª¢æŸ¥(check-and-set)ã€‚\nvault kv patch -mount=chechia-net/sre/workshop -method=rw my-secret bar=ccc ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 5 ä½ å¯ä»¥ä½¿ç”¨ -version flag ä¾†å­˜å–æ›´æ—©çš„ç‰ˆæœ¬\nvault kv get -mount=chechia-net/sre/workshop -version=1 my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 1 === Data === Key Value --- ----- bar b foo a åˆªé™¤è³‡æ–™ åœ¨åˆªé™¤è³‡æ–™æ™‚ï¼Œæ¨™æº–çš„ vault kv delete å‘½ä»¤å°‡åŸ·è¡Œ soft deletã€‚å®ƒå°‡æ¨™è¨˜ç‰ˆæœ¬ç‚ºå·²åˆªé™¤ä¸¦å¡«å…… deletion_time timestampã€‚soft delete ä¸æœƒå¾å­˜å„²ä¸­åˆªé™¤åº•å±¤ç‰ˆæœ¬è³‡æ–™ï¼Œé€™å…è¨±ç‰ˆæœ¬å¯ä»¥è¢«é‚„åŸ\né‚„åŸç‰ˆæœ¬\nvault kv undelete åªæœ‰ç•¶ç§˜å¯†çš„ç‰ˆæœ¬æ•¸è¶…é max-versions è¨­ç½®å…è¨±çš„ç‰ˆæœ¬æ•¸æ™‚ï¼Œæˆ–è€…ä½¿ç”¨ vault kv destroy æ™‚ï¼Œç‰ˆæœ¬çš„è³‡æ–™æ‰æœƒæ°¸ä¹…åˆªé™¤ã€‚\nä½¿ç”¨ destroy å‘½ä»¤æ™‚ï¼Œåº•å±¤ç‰ˆæœ¬è³‡æ–™å°‡è¢«åˆªé™¤ï¼Œä¸¦å°‡å¯†é‘° metadata æ¨™è¨˜ç‚ºå·²éŠ·æ¯€ã€‚å¦‚æœé€šéè¶…é max-versions ä¾†æ¸…ç†ç‰ˆæœ¬ï¼Œå‰‡ç‰ˆæœ¬ metadata ä¹Ÿå°‡å¾å¯†é‘°ä¸­åˆªé™¤ã€‚\nå¯ä»¥ä½¿ç”¨ delete å‘½ä»¤åˆªé™¤å¯†é‘°çš„æœ€æ–°ç‰ˆæœ¬ï¼Œé€™ä¹Ÿå¯ä»¥ä½¿ç”¨ -versions æ¨™èªŒåˆªé™¤ä¹‹å‰çš„ç‰ˆæœ¬ï¼š\nvault kv delete -mount=chechia-net/sre/workshop my-secret Success! Data deleted (if it existed) at: chechia-net/sre/workshop/data/my-secret è®€å– version=5 æ™‚ï¼Œåªå›å‚³ metadataï¼Œç„¡æ³•è®€å–è³‡æ–™\nvault kv get -mount=chechia-net/sre/workshop -version=5 my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z custom_metadata \u0026lt;nil\u0026gt; deletion_time 2023-09-15T17:10:01.558586Z destroyed false version 5 è®€å– version=4 æ™‚ï¼Œå¯ä»¥é †åˆ©è®€å–è³‡æ–™\nvault kv get -mount=chechia-net/sre/workshop -version=4 my-secret ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:02:55.522095Z custom_metadata \u0026lt;nil\u0026gt; deletion_time n/a destroyed false version 4 === Data === Key Value --- ----- bar bbb foo aa ä½ å¯ä»¥å¾©åŸä¸€å€‹åˆªé™¤çš„ç‰ˆæœ¬ version=5\nvault kv undelete -versions=5 chechia-net/sre/workshop/my-secret Success! Data written to: chechia-net/sre/workshop/undelete/my-secret é€™é‚Š undelete ä½¿ç”¨äº† legacy çš„ secret pathï¼Œè€Œä¸ä½¿ç”¨ -mount flagï¼Œæ˜¯å› ç‚º v2 kv åœ¨è™•ç†å¤šå±¤ mount path çš„ bug Github Issue: #19811ï¼ŒPR #19811 is comming lolã€‚\nvault kv undelete -versions=5 -mount=chechia-net/sre/workshop my-secret Error writing data to workshop/undelete/my-secret: Error making API request. URL: PUT http://127.0.0.1:8200/v1/workshop/undelete/my-secret Code: 404. Errors: * no handler for route \u0026quot;workshop/undelete/my-secret\u0026quot;. route entry not found. metadata æ‰€æœ‰ç‰ˆæœ¬å’Œå¯†é‘° metadata å¯ä»¥ä½¿ç”¨ metadata å‘½ä»¤å’ŒAPI é€²è¡Œæª¢æŸ¥ã€‚\nåˆªé™¤ metadata å¯†é‘°å°‡å°è‡´è©²å¯†é‘°çš„æ‰€æœ‰ metadata å’Œç‰ˆæœ¬æ°¸ä¹…åˆªé™¤ã€‚\næœ‰é—œæ›´å¤šä¿¡æ¯ï¼Œè¯·åƒè¦‹ä»¥ä¸‹å‘½ä»¤ï¼š\nå¯ä»¥æŸ¥çœ‹å¯†é‘°çš„æ‰€æœ‰å…ƒæ•¸æ“šå’Œç‰ˆæœ¬ï¼š\nvault kv metadata get -mount=chechia-net/sre/workshop my-secret ============== Metadata Path ============== chechia-net/sre/workshop/metadata/my-secret ========== Metadata ========== Key Value --- ----- cas_required false created_time 2023-09-15T16:48:45.817265Z current_version 5 custom_metadata \u0026lt;nil\u0026gt; delete_version_after 0s max_versions 0 oldest_version 0 updated_time 2023-09-15T17:03:37.331182Z ====== Version 1 ====== Key Value --- ----- created_time 2023-09-15T16:48:45.817265Z deletion_time n/a destroyed false ====== Version 2 ====== Key Value --- ----- created_time 2023-09-15T16:50:26.621978Z deletion_time n/a destroyed false ====== Version 3 ====== Key Value --- ----- created_time 2023-09-15T16:54:03.925959Z deletion_time n/a destroyed false ====== Version 4 ====== Key Value --- ----- created_time 2023-09-15T17:02:55.522095Z deletion_time n/a destroyed false ====== Version 5 ====== Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z deletion_time 2023-09-15T17:15:40.767682Z destroyed false ä½ å¯ä»¥é€éæ›´æ”¹ metadata API èª¿æ•´ secret çš„å±¬æ€§\nvault kv metadata put -mount=chechia-net/sre/workshop \\ -max-versions 2 \\ -delete-version-after=\u0026quot;3h25m19s\u0026quot; my-secret Success! Data written to: secret/metadata/my-secret Delete-version-after åªæœƒæ‡‰ç”¨åœ¨æ–°çš„ç‰ˆæœ¬ä¸Šï¼ŒMax versions changes æœƒæ‡‰ç”¨åœ¨ä¸‹æ¬¡å¯«å…¥\nvault kv put -mount=chechia-net/sre/workshop my-secret new=123 ============= Secret Path ============= chechia-net/sre/workshop/data/my-secret ======= Metadata ======= Key Value --- ----- created_time 2023-09-15T17:34:09.61954Z custom_metadata \u0026lt;nil\u0026gt; deletion_time 2023-09-15T20:59:28.61954Z destroyed false version 6 æ ¹æ“š max-version çš„è¨­å®šçµæœï¼Œåªä¿ç•™ version=5 èˆ‡ version=6ï¼Œæ›´èˆŠçš„ç‰ˆæœ¬éƒ½è¢«åˆªé™¤\nvault kv metadata get -mount=chechia-net/sre/workshop my-secret ============== Metadata Path ============== chechia-net/sre/workshop/metadata/my-secret ========== Metadata ========== Key Value --- ----- cas_required false created_time 2023-09-15T16:48:45.817265Z current_version 6 custom_metadata \u0026lt;nil\u0026gt; delete_version_after 3h25m19s max_versions 2 oldest_version 5 updated_time 2023-09-15T17:34:09.61954Z ====== Version 5 ====== Key Value --- ----- created_time 2023-09-15T17:03:37.331182Z deletion_time 2023-09-15T17:15:40.767682Z destroyed false ====== Version 6 ====== Key Value --- ----- created_time 2023-09-15T17:34:09.61954Z deletion_time 2023-09-15T20:59:28.61954Z destroyed false Vault å‘½åç©ºé–“(namespace) å’Œæ›è¼‰(mount)çµæ§‹ å‘½åç©ºé–“æ˜¯åŠŸèƒ½ä¸Šå‰µå»ºâ€œVaultä¸­çš„Vaultâ€çš„éš”é›¢ç’°å¢ƒã€‚å®ƒå€‘å…·æœ‰ç¨ç«‹çš„ç™»éŒ„è·¯å¾‘ï¼Œä¸¦æ”¯æŒå‰µå»ºå’Œç®¡ç†èˆ‡å…¶å‘½åç©ºé–“éš”é›¢çš„æ•¸æ“šã€‚æ­¤åŠŸèƒ½ä½¿ä½ èƒ½å¤ å°‡Vaultä½œç‚ºæœå‹™æä¾›çµ¦ç§Ÿæˆ¶ã€‚\nç‚ºä»€éº¼é€™å€‹ä¸»é¡Œå¾ˆé‡è¦ï¼Ÿ\nVaultä¸­çš„ä¸€åˆ‡éƒ½æ˜¯åŸºæ–¼è·¯å¾‘çš„ã€‚æ¯å€‹è·¯å¾‘å°æ‡‰æ–¼Vaultä¸­çš„æ“ä½œæˆ–ç§˜å¯†ï¼ŒVault API endpointæ˜ å°„åˆ°é€™äº›è·¯å¾‘ã€‚å› æ­¤ï¼Œç·¨å¯« policy æœƒé…ç½®å°ç‰¹å®šç§˜å¯† path çš„å…è¨±æ“ä½œã€‚\nä¾‹å¦‚ï¼Œç‚ºäº†æˆäºˆç®¡ç†æ ¹å‘½åç©ºé–“ä¸­çš„ä»¤ç‰Œçš„è¨ªå•æ¬Šé™ï¼Œç­–ç•¥è·¯å¾‘æ˜¯auth/token/ã€‚è¦ç®¡ç†æ•™è‚²å‘½åç©ºé–“ä¸­çš„ä»¤ç‰Œï¼Œå®Œå…¨åˆæ ¼çš„è·¯å¾‘åœ¨åŠŸèƒ½ä¸Šè®Šç‚ºeducation/auth/token/ã€‚\nä»¥ä¸‹åœ–è¡¨ç¤ºäº†åŸºæ–¼æˆæ¬Šæ–¹æ³•å’Œç§˜å¯†å¼•æ“å•Ÿç”¨ä½ç½®çš„APIè·¯å¾‘ã€‚\nä½ å¯ä»¥ä½¿ç”¨å‘½åç©ºé–“ï¼Œæˆ–ç‚ºæ¯å€‹Vaultå®¢æˆ¶ç«¯å°ˆç”¨çš„æ›è¼‰ä¾†éš”é›¢ç§˜å¯†ã€‚\nä¾‹å¦‚ï¼Œä½ å¯ä»¥ç‚ºæ¯å€‹ç¨ç«‹çš„ç§Ÿæˆ¶å‰µå»ºä¸€å€‹å‘½åç©ºé–“ï¼Œä»–å€‘è² è²¬ç®¡ç†å…¶å‘½åç©ºé–“ä¸‹çš„è³‡æºã€‚æˆ–è€…ï¼Œä½ å¯ä»¥åœ¨çµ„ç¹”å…§çš„æ¯å€‹åœ˜éšŠå°ˆç”¨çš„è·¯å¾‘ä¸Šå®‰è£å°ˆç”¨ç§˜å¯†å¼•æ“ã€‚\næ ¹æ“šå¦‚ä½•éš”é›¢ç§˜å¯†ï¼Œç¢ºå®šäº†èª°è² è²¬ç®¡ç†é€™äº›ç§˜å¯†ï¼Œæ›´é‡è¦çš„æ˜¯èˆ‡é€™äº›ç§˜å¯†ç›¸é—œçš„ç­–ç•¥ã€‚\nPrerequisites å¦‚æœä½ å°Vaultå‘½åç©ºé–“é‚„ä¸ç†Ÿæ‚‰ï¼Œè«‹æŸ¥çœ‹å¸¶æœ‰å‘½åç©ºé–“çš„å®‰å…¨å¤šç§Ÿæˆ¶æ•™ç¨‹ã€‚\næ³¨æ„\nå‰µå»ºå‘½åç©ºé–“æ‡‰ç”±å…·æœ‰é«˜åº¦ç‰¹æ¬Šä»¤ç‰Œï¼ˆä¾‹å¦‚rootï¼‰çš„ç”¨æˆ¶åŸ·è¡Œï¼Œä»¥ç‚ºæ¯å€‹çµ„ç¹”ã€åœ˜éšŠæˆ–æ‡‰ç”¨ç¨‹åºè¨­ç½®éš”é›¢ç’°å¢ƒã€‚\néƒ¨ç½²æ³¨æ„äº‹é … è¦è¨ˆåŠƒå’Œè¨­è¨ˆVaultå‘½åç©ºé–“ã€æˆæ¬Šæ–¹æ³•è·¯å¾‘å’Œç§˜å¯†å¼•æ“è·¯å¾‘ï¼Œä½ éœ€è¦è€ƒæ…®å¦‚ä½•ç‚ºä½ çš„çµ„ç¹”ï¼Œè¨­è¨ˆVaultçš„é‚è¼¯å°è±¡ã€‚\nçµ„ç¹”çµæ§‹ - ä½ çš„çµ„ç¹”çµæ§‹æ˜¯ä»€éº¼ï¼Ÿ\néƒ¨é–€ã€åœ˜éšŠã€æœå‹™ã€æ‡‰ç”¨ç¨‹åºä¹‹é–“çš„å±¤ç´šï¼Œåœ¨Vaultæœ€çµ‚è¨­è¨ˆä¸­éœ€è¦åæ˜ ä»€éº¼ï¼Ÿ\nVault policy å¦‚ä½•ç®¡ç†ï¼Ÿ\nåœ˜éšŠæ˜¯å¦éœ€è¦ç›´æ¥ç®¡ç†å…¶è² è²¬ç¯„åœçš„ policyï¼Ÿ\nchatGPT æœ¬æ®µå…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/secrets/kv/kv-v2 https://developer.hashicorp.com/vault/tutorials/recommended-patterns/namespace-structure å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ä¸è¦ä½¿ç”¨æ•¬èªï¼Œè«‹ç”¨ä½ å–ä»£ä½ ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œvalueï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinaryï¼Œprefixï¼Œinstanceï¼Œmetadataã€‚ ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œæ•¸æ“šåº«æ”¹ç‚ºè³‡æ–™åº«ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œè¨ªå•æ”¹ç‚ºå­˜å–ï¼Œæºä»£ç¢¼æ”¹ç‚ºåŸå§‹ç¢¼ï¼Œä¿¡æ¯æ”¹ç‚ºè³‡è¨Šï¼Œå‘½ä»¤æ”¹ç‚ºæŒ‡ä»¤ï¼Œç¦ç”¨æ”¹ç‚ºåœç”¨ï¼Œé»˜èªæ”¹ç‚ºé è¨­ã€‚ ","permalink":"https://chechia.net/posts/2023-09-15-vault-workshop-secret-engine-kv-v2/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-04secret-engine-kv-v2\"\u003eDay 04ï¼šSecret Engine KV V2\u003c/h1\u003e\n\u003cp\u003eKVç§˜å¯†å¼•æ“ï¼Œç”¨æ–¼åœ¨Vaultçš„å·²é…ç½®ç‰©ç†Storageä¸­ï¼Œå­˜å„²ä»»æ„ç§˜å¯†ã€‚\u003c/p\u003e\n\u003cp\u003ekey åç¨±å¿…é ˆå§‹çµ‚æ˜¯å­—ç¬¦ä¸²ã€‚å¦‚æœä½ ç›´æ¥é€šéCLIç·¨å¯«éå­—ä¸² valueï¼Œå®ƒå€‘å°‡è¢«è½‰æ›ç‚ºå­—ä¸²ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥é€šéå¾JSONæ–‡ä»¶ä¸­å°‡key-value pairå¯«å…¥Vaultï¼Œæˆ–ä½¿ç”¨HTTP APIä¾†ä¿ç•™éå­—ä¸² valueã€‚\u003c/p\u003e\n\u003cp\u003eæ­¤ç§˜å¯†å¼•æ“éµç…§ACL policyä¸­ï¼Œå‰µå»º(create)å’Œæ›´æ–°(update)æ¬Šé™ä¹‹é–“çš„è¨­å®šã€‚å®ƒé‚„æ”¯æŒpatchåŠŸèƒ½ï¼Œç”¨æ–¼è¡¨ç¤ºéƒ¨åˆ†æ›´æ–°(patch)ï¼Œè€Œæ›´æ–°åŠŸèƒ½(update)å‰‡è¡¨ç¤ºå®Œå…¨è¦†è“‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"è¨­ç½®\"\u003eè¨­ç½®\u003c/h3\u003e\n\u003cp\u003eå¤§å¤šæ•¸ç§˜å¯†å¼•æ“å¿…é ˆåœ¨åŸ·è¡Œå…¶åŠŸèƒ½ä¹‹å‰äº‹å…ˆé…ç½®ã€‚é€™äº›æ­¥é©Ÿé€šå¸¸ç”±æ“ä½œäººå“¡æˆ–é…ç½®ç®¡ç†å·¥å…·å®Œæˆã€‚\u003c/p\u003e\n\u003cp\u003eå•Ÿç”¨v2 kvç§˜å¯†å¼•æ“ï¼š\u003c/p\u003e\n\u003cp\u003eå•Ÿå‹•ä¸€å€‹ä¹¾æ·¨çš„æœ¬åœ°çš„é–‹ç™¼æ¨¡å¼ Vault Serverï¼Œå…¨æ–°çš„ Vault Server åŒ…å«åº•ä¸‹é è¨­å•Ÿç”¨çš„å¼•æ“\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003evault server -dev\n\nexport VAULT_ADDR='http://127.0.0.1:8200'\n\nvault secrets list\n\nPath          Type         Accessor              Description\n----          ----         --------              -----------\ncubbyhole/    cubbyhole    cubbyhole_57a4ca51    per-token private secret storage\nidentity/     identity     identity_c2ecbd49     identity store\nsecret/       kv           kv_c41afde8           key/value secret storage\nsys/          system       system_c063e514       system endpoints used for control, policy and debugging\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½ å¯ä»¥åœ¨æŒ‡å®šçš„è·¯å¾‘ä¸‹ï¼Œå•Ÿç”¨ä¸€å€‹æ–°çš„ v2 kv ç§˜å¯†å¼•æ“ã€‚è‹¥ä¸æŒ‡å®š -path åƒæ•¸ï¼Œå‰‡é è¨­ path ç‚º typeï¼Œä¹Ÿå°±æ˜¯ path=kvã€‚\u003c/p\u003e","title":"Vault Workshop 04: Secret Engine KV V2"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\næ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\nDay 03ï¼šç´°æ¢ Secret Engine ç§˜å¯†å¼•æ“ ä»€éº¼æ˜¯ç§˜å¯†å¼•æ“ï¼Ÿ ç§˜å¯†å¼•æ“æ˜¯Vaultçš„çµ„ä»¶ï¼Œç”¨æ–¼å­˜å„²ã€ç”Ÿæˆæˆ–åŠ å¯†ç§˜å¯†ã€‚åœ¨å‰é¢çš„å…§å®¹ä¸­ï¼Œä½ ä½¿ç”¨äº†Key/Value v2 ç§˜å¯†å¼•æ“ä¾†å­˜å„²æ•¸æ“šã€‚ä¸€äº›ç§˜å¯†å¼•æ“ï¼Œæ¯”å¦‚éµ/å€¼ç§˜å¯†å¼•æ“ï¼Œåƒ…åƒ…æ˜¯ç”¨ä¾†å­˜å„²å’Œè®€å–æ•¸æ“šçš„ã€‚å…¶ä»–ç§˜å¯†å¼•æ“å‰‡é€£æ¥åˆ°å…¶ä»–æœå‹™ä¸¦æ ¹æ“šéœ€æ±‚ç”Ÿæˆå‹•æ…‹æ†‘è­‰ã€‚é‚„æœ‰ä¸€äº›ç§˜å¯†å¼•æ“æä¾›åŠ å¯†ä½œç‚ºæœå‹™ã€‚\nå‰é¢çš„å…§å®¹ä¸­ï¼Œé»˜èªæƒ…æ³ä¸‹ï¼Œkey/value v2 ç§˜å¯†å¼•æ“å·²å•Ÿç”¨ï¼Œä¸¦æº–å‚™åœ¨ secret/ ä¸‹æ¥æ”¶è«‹æ±‚ï¼Œå› ç‚ºæˆ‘å€‘åœ¨-dev æ¨¡å¼ä¸‹å•Ÿå‹•äº†Vault Serverã€‚\nåœ¨åº•ä¸‹æˆ‘å€‘ä½¿ç”¨ kv v1 åšç°¡å–®çš„ç¯„ä¾‹ã€‚\nmount path å»ºè­°åœ¨ä½¿ç”¨ KV v2 ç§˜å¯†å¼•æ“æ™‚ï¼Œä½¿ç”¨å¯é¸çš„ -mount flag èªæ³•ï¼Œä¾‹å¦‚\nvault kv get -mount=secret foo è«‹å˜—è©¦ä»¥ä¸‹å‘½ä»¤ï¼Œé€™å°‡å°è‡´éŒ¯èª¤ï¼š\nvault kv put foo/bar a=b Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/foo/bar Code: 403. Errors: * preflight capability check returned 403, please ensure client's policies grant access to path \u0026quot;foo/bar/\u0026quot; Path prefix è·¯å¾‘å‰ç¶´å‘Šè¨´ Vault æ‡‰è©²å°‡æµé‡ route åˆ°å“ªå€‹ç§˜å¯†å¼•æ“\nç•¶è«‹æ±‚åˆ°é” Vault æ™‚ï¼Œå®ƒæœƒä½¿ç”¨æœ€é•·å‰ç¶´åŒ¹é…ä¾†åŒ¹é…åˆå§‹è·¯å¾‘éƒ¨åˆ†ï¼Œç„¶å¾Œå°‡è«‹æ±‚å‚³éçµ¦åœ¨è©²è·¯å¾‘å•Ÿç”¨çš„ç›¸æ‡‰ç§˜å¯†å¼•æ“ã€‚\nå¦‚æœ mount è¨­ç½®ç‚º foo/bar å‰‡æœƒåœ¨ foo/bar é€™å€‹ path ä¸‹çš„ secret engineï¼Œå„²å­˜ a=b å¦‚æœ mount è¨­ç½®ç‚º foo å‰‡æœƒåœ¨ foo é€™å€‹ path ä¸‹çš„ secret engineï¼Œå„²å­˜åœ¨ path /barï¼Œa=b Vault å°‡é€™äº›ç§˜å¯†å¼•æ“å‘ˆç¾å¾—é¡ä¼¼æ–¼æ–‡ä»¶ç³»çµ± (ex. )/usr/local/bin/vault)\nåœ¨ linux ä¸Šå­˜å–ä¸€å€‹ mount path ä¸å­˜åœ¨çš„ directory path åœ¨ vault ä¸­å­˜å– foo è™•æœªæ›è¼‰ç§˜å¯†å¼•æ“ï¼Œæ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤è¿”å›äº†éŒ¯èª¤ã€‚ å°æ–¼ vault kv å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ -mount flag\nå•Ÿç”¨ä¸€å€‹ç§˜å¯†å¼•æ“ è¦é–‹å§‹ï¼Œè«‹åœ¨è·¯å¾‘ kv å•Ÿç”¨ä¸€å€‹æ–°çš„ KV ç§˜å¯†å¼•æ“ã€‚æ¯å€‹è·¯å¾‘éƒ½æ˜¯å®Œå…¨éš”é›¢çš„ï¼Œç„¡æ³•èˆ‡å…¶ä»–è·¯å¾‘é€šä¿¡ã€‚ä¾‹å¦‚ï¼Œ\nå•Ÿç”¨åœ¨ foo çš„ KV ç§˜å¯†å¼•æ“ç„¡æ³•èˆ‡å•Ÿç”¨åœ¨ bar çš„ KVç§˜å¯†å¼•æ“é€šä¿¡ã€‚\n/foo a=b /bar c=d å•Ÿç”¨æ–°çš„ç§˜å¯†å¼•æ“ä»¥å‰ï¼Œå…ˆæŸ¥çœ‹ä¸€ä¸‹ç›®å‰ vault server ä¸­å·²ç¶“å•Ÿç”¨çš„å¼•æ“ã€‚\né™¤äº† default å­˜åœ¨çš„å¼•æ“ï¼Œé‚„æœ‰åœ¨ dev æ¨¡å¼ä¸‹è‡ªå‹•å»ºç«‹çš„ secret/\ndefault\ncubbyhole/ identity/ sys/ dev mode\nsecret/ vault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_9c6d82c2 per-token private secret storage identity/ identity identity_8feb8f49 identity store secret/ kv kv_6f946f62 key/value secret storage sys/ system system_b45bc416 system endpoints used for control, policy and debugging ç„¶å¾Œåœ¨ path=kv ä¸‹ï¼Œå•Ÿç”¨ä¸€å€‹ secret engine\nvault secrets enable -path=kv kv Success! Enabled the kv secrets engine at: kv/ ç§˜å¯†å¼•æ“å•Ÿç”¨çš„è·¯å¾‘é»˜èªç‚ºç§˜å¯†å¼•æ“çš„åç¨±ã€‚å› æ­¤ï¼Œä»¥ä¸‹å‘½ä»¤ç­‰æ•ˆæ–¼åŸ·è¡Œä¸Šé¢çš„å‘½ä»¤ã€‚\nvault secrets enable kv é‡è¤‡åŸ·è¡Œé€™å€‹å‘½ä»¤æœƒæ‹‹å‡ºâ€œè·¯å¾‘å·²åœ¨kv/ ä¸­ä½¿ç”¨â€éŒ¯èª¤ã€‚\nç‚ºäº†é©—è­‰æˆ‘å€‘çš„æˆåŠŸä¸¦ç²å–æœ‰é—œç§˜å¯†å¼•æ“çš„æ›´å¤šä¿¡æ¯ï¼Œä½¿ç”¨ä»¥ä¸‹çš„ vault secrets list å‘½ä»¤ï¼š\nvault secrets list Path Type Accessor Description ---- ---- -------- ----------- cubbyhole/ cubbyhole cubbyhole_9c6d82c2 per-token private secret storage identity/ identity identity_8feb8f49 identity store kv/ kv kv_2b6528af n/a secret/ kv kv_6f946f62 key/value secret storage sys/ system system_b45bc416 system endpoints used for control, policy and debugging é€™é¡¯ç¤ºäº†åœ¨é€™å€‹Vaultä¼ºæœå™¨ä¸Šå·²å•Ÿç”¨çš„5å€‹ç§˜å¯†å¼•æ“ã€‚\nä½ å¯ä»¥çœ‹åˆ°ç§˜å¯†å¼•æ“çš„é¡å‹ã€ç›¸æ‡‰çš„è·¯å¾‘ä»¥åŠå¯é¸çš„æè¿°ï¼ˆå¦‚æœæ²’æœ‰æä¾›æè¿°ï¼Œå‰‡ç‚ºâ€œn/aâ€ï¼‰ã€‚\nä½¿ç”¨å¸¶æœ‰ -detailed æ¨™èªŒé‹è¡Œä¸Šè¿°å‘½ä»¤å¯ä»¥é¡¯ç¤ºKVç§˜å¯†å¼•æ“çš„ç‰ˆæœ¬å’Œæ›´å¤šä¿¡æ¯ã€‚\nvault secrets list --detailed Path Plugin Accessor Default TTL Max TTL Force No Cache Replication Seal Wrap External Entropy Access Options Description UUID Version Running Version Running SHA256 Deprecation Status ---- ------ -------- ----------- ------- -------------- ----------- --------- ----------------------- ------- ----------- ---- ------- --------------- -------------- ------------------ cubbyhole/ cubbyhole cubbyhole_9c6d82c2 n/a n/a false local false false map[] per-token private secret storage 6087f484-a02c-f36c-0a1a-aa07840f988c n/a v1.14.3+builtin.vault n/a n/a identity/ identity identity_8feb8f49 system system false replicated false false map[] identity store c3a1e4ae-09c6-29b9-906a-8281b46690f3 n/a v1.14.3+builtin.vault n/a n/a kv/ kv kv_2b6528af system system false replicated false false map[] n/a 5ff9bc4c-6d2c-5fd7-cbe0-e9b7fbf03ee5 n/a v0.15.0+builtin n/a supported secret/ kv kv_6f946f62 system system false replicated false false map[version:2] key/value secret storage ed28307e-0472-c0a7-b7a9-65543a63e68c n/a v0.15.0+builtin n/a supported sys/ system system_b45bc416 n/a n/a false replicated true false map[] system endpoints used for control, policy and debugging 9712d56d-95e3-6c07-796f-d44565de5c07 n/a v1.14.3+builtin.vault n/a n/a sys/ è·¯å¾‘å°æ‡‰åˆ°ç³»çµ±å¾Œç«¯ã€‚é€™äº›è·¯å¾‘èˆ‡Vaultçš„æ ¸å¿ƒç³»çµ±äº¤äº’ï¼Œå°æ–¼åˆå­¸è€…ä¾†èªªä¸æ˜¯å¿…éœ€çš„ã€‚\nå»ºç«‹ Secret è¦å‰µå»ºç§é‘°ï¼Œä½¿ç”¨ kv put å‘½ä»¤ã€‚\nvault kv put kv/hello target=world Success! Data written to: kv/hello è¦è®€å–å­˜å„²åœ¨kv/helloè·¯å¾‘ä¸­çš„ç§é‘°ï¼Œä½¿ç”¨ kv get å‘½ä»¤ã€‚\nvault kv get kv/hello ===== Data ===== Key Value --- ----- target world å˜—è©¦å»ºç«‹ç¬¬äºŒå€‹ kv/my-secret\nvault kv put kv/my-secret value=\u0026quot;s3c(eT\u0026quot; Success! Data written to: kv/my-secret è®€å–ä½æ–¼ kv/my-secret çš„è³‡æ–™\nvault kv get kv/my-secret ==== Data ==== Key Value --- ----- value s3c(eT åˆªé™¤ä½æ–¼ kv/my-secret çš„è³‡æ–™\nvault kv delete kv/my-secret Success! Data deleted (if it existed) at: kv/my-secret åˆ—å‡ºä½æ–¼ kv/my-secret çš„è³‡æ–™\nvault kv list kv/ Keys ---- hello åœç”¨ç§˜å¯†å¼•æ“ ç•¶ä¸å†éœ€è¦ç§˜å¯†å¼•æ“æ™‚ï¼Œå¯ä»¥å°‡å…¶åœç”¨ã€‚\nç•¶åœç”¨ç§˜å¯†å¼•æ“æ™‚ï¼Œæ‰€æœ‰ç§é‘°éƒ½å°‡è¢«æ’¤éŠ·ï¼Œç›¸æ‡‰çš„Vaultæ•¸æ“šå’Œé…ç½®å°‡è¢«åˆªé™¤ã€‚\nvault secrets disable kv/ Success! Disabled the secrets engine (if it existed) at: kv/ è«‹æ³¨æ„ï¼Œæ­¤å‘½ä»¤å°‡è·¯å¾‘ä½œç‚ºåƒæ•¸ï¼Œè€Œä¸æ˜¯ç§˜å¯†å¼•æ“çš„é¡å‹ã€‚\nå°åŸå§‹è·¯å¾‘çš„ä»»ä½•æ•¸æ“šè·¯ç”±è«‹æ±‚éƒ½å°‡å°è‡´éŒ¯èª¤ï¼Œä½†ç¾åœ¨å¯ä»¥åœ¨è©²è·¯å¾‘å•Ÿç”¨å¦ä¸€å€‹ç§˜å¯†å¼•æ“ã€‚\nvault kv get kv/hello Error making API request. URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/kv/hello Code: 403. Errors: * preflight capability check returned 403, please ensure client's policies grant access to path \u0026quot;kv/hello/\u0026quot; ç§˜å¯†å¼•æ“æ˜¯ä¸€å€‹æŠ½è±¡ Vaultçš„è¡Œç‚ºé¡ä¼¼æ–¼è™›æ“¬æ–‡ä»¶ç³»çµ±ã€‚è®€å–/å¯«å…¥/åˆªé™¤/åˆ—å‡ºæ“ä½œå°‡è½‰ç™¼åˆ°ç›¸æ‡‰çš„ç§˜å¯†å¼•æ“ï¼Œç§˜å¯†å¼•æ“æ±ºå®šå¦‚ä½•å°é€™äº›æ“ä½œåšå‡ºåæ‡‰ã€‚\né€™ç¨®æŠ½è±¡éå¸¸å¼·å¤§ã€‚å®ƒä½¿Vaultèƒ½å¤ ç›´æ¥èˆ‡ç‰©ç†ç³»çµ±ã€è³‡æ–™åº«ã€HSM ç­‰é€²è¡Œäº¤äº’ã€‚\nä½†é™¤äº†é€™äº›ç‰©ç†ç³»çµ±å¤–ï¼ŒVaulté‚„å¯ä»¥èˆ‡æ›´å¤šç¨ç‰¹çš„ç’°å¢ƒé€²è¡Œäº¤äº’ï¼Œæ¯”å¦‚AWS IAMã€å‹•æ…‹SQL user å‰µå»ºç­‰ï¼Œæ‰€æœ‰é€™äº›éƒ½ä½¿ç”¨ç›¸åŒçš„è®€å–/å¯«å…¥ interfaceã€‚\nchatGPT æœ¬æ®µå…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-secrets-engines å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ä¸è¦ä½¿ç”¨æ•¬èªï¼Œè«‹ç”¨ä½ å–ä»£æ‚¨ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinary ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šç§˜å¯†æ”¹ç‚ºç§é‘°ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œæ•¸æ“šåº«æ”¹ç‚ºè³‡æ–™åº«ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œè¨ªå•æ”¹ç‚ºå­˜å–ï¼Œæºä»£ç¢¼æ”¹ç‚ºåŸå§‹ç¢¼ã€‚ ","permalink":"https://chechia.net/posts/2023-09-14-vault-workshop-secret-engine/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"day-03ç´°æ¢-secret-engine-ç§˜å¯†å¼•æ“\"\u003eDay 03ï¼šç´°æ¢ Secret Engine ç§˜å¯†å¼•æ“\u003c/h1\u003e\n\u003ch3 id=\"ä»€éº¼æ˜¯ç§˜å¯†å¼•æ“\"\u003eä»€éº¼æ˜¯ç§˜å¯†å¼•æ“ï¼Ÿ\u003c/h3\u003e\n\u003cp\u003eç§˜å¯†å¼•æ“æ˜¯Vaultçš„çµ„ä»¶ï¼Œç”¨æ–¼å­˜å„²ã€ç”Ÿæˆæˆ–åŠ å¯†ç§˜å¯†ã€‚åœ¨å‰é¢çš„å…§å®¹ä¸­ï¼Œä½ ä½¿ç”¨äº†Key/Value v2 ç§˜å¯†å¼•æ“ä¾†å­˜å„²æ•¸æ“šã€‚ä¸€äº›ç§˜å¯†å¼•æ“ï¼Œæ¯”å¦‚éµ/å€¼ç§˜å¯†å¼•æ“ï¼Œåƒ…åƒ…æ˜¯ç”¨ä¾†å­˜å„²å’Œè®€å–æ•¸æ“šçš„ã€‚å…¶ä»–ç§˜å¯†å¼•æ“å‰‡é€£æ¥åˆ°å…¶ä»–æœå‹™ä¸¦æ ¹æ“šéœ€æ±‚ç”Ÿæˆå‹•æ…‹æ†‘è­‰ã€‚é‚„æœ‰ä¸€äº›ç§˜å¯†å¼•æ“æä¾›åŠ å¯†ä½œç‚ºæœå‹™ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://developer.hashicorp.com/_next/image?url=https%3A%2F%2Fcontent.hashicorp.com%2Fapi%2Fassets%3Fproduct%3Dtutorials%26version%3Dmain%26asset%3Dpublic%252Fimg%252Fvault%252Fvault-triangle.png%26width%3D1641%26height%3D973\u0026w=3840\u0026q=75\"\u003e\u003c/p\u003e\n\u003cp\u003eå‰é¢çš„å…§å®¹ä¸­ï¼Œé»˜èªæƒ…æ³ä¸‹ï¼Œkey/value v2 ç§˜å¯†å¼•æ“å·²å•Ÿç”¨ï¼Œä¸¦æº–å‚™åœ¨ secret/ ä¸‹æ¥æ”¶è«‹æ±‚ï¼Œå› ç‚ºæˆ‘å€‘åœ¨-dev æ¨¡å¼ä¸‹å•Ÿå‹•äº†Vault Serverã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨åº•ä¸‹æˆ‘å€‘ä½¿ç”¨ kv v1 åšç°¡å–®çš„ç¯„ä¾‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"mount-path\"\u003emount path\u003c/h3\u003e\n\u003cp\u003eå»ºè­°åœ¨ä½¿ç”¨ KV v2 ç§˜å¯†å¼•æ“æ™‚ï¼Œä½¿ç”¨å¯é¸çš„ -mount flag èªæ³•ï¼Œä¾‹å¦‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003evault kv get -mount=secret foo\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè«‹å˜—è©¦ä»¥ä¸‹å‘½ä»¤ï¼Œé€™å°‡å°è‡´éŒ¯èª¤ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003evault kv put foo/bar a=b\n\nError making API request.\n\nURL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/foo/bar\nCode: 403. Errors:\n\n* preflight capability check returned 403, please ensure client's policies grant access to path \u0026quot;foo/bar/\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePath prefix è·¯å¾‘å‰ç¶´å‘Šè¨´ Vault æ‡‰è©²å°‡æµé‡ route åˆ°å“ªå€‹ç§˜å¯†å¼•æ“\u003c/p\u003e","title":"Vault Workshop 03: Secret Engine"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDay 02 æº–å‚™ï¼šåŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„ Vault æ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ Github Repository: vault-playground\næº–å‚™å·¥ä½œ åœ¨é–‹å§‹é€²è¡Œ Vault 30 å¤© workshop ä¹‹å‰ï¼Œæœ‰ä¸€äº›æº–å‚™å·¥ä½œéœ€è¦å®Œæˆï¼š\næ­¥é©Ÿ1ï¼šä¸‹è¼‰ Vault Binary\né¦–å…ˆï¼Œä½ éœ€è¦ä¸‹è¼‰HashiCorp Vaultçš„æœ€æ–°ç‰ˆæœ¬ã€‚ä½ å¯ä»¥åœ¨HashiCorpçš„å®˜æ–¹ç¶²ç«™ä¸Šæ‰¾åˆ°Vaultçš„ä¸‹è¼‰éˆæ¥ã€‚è«‹ç¢ºä¿ä¸‹è¼‰é©ç”¨æ–¼ä½ æ“ä½œç³»çµ±çš„ç‰ˆæœ¬ã€‚\nhttps://developer.hashicorp.com/vault/downloads\nMacOS amd64 MacOS arm64 Linux æ­¥é©Ÿ2ï¼šå®‰è£Vault\nä¸‹è¼‰å®Œæˆå¾Œï¼Œæ ¹æ“šä½ çš„æ“ä½œç³»çµ±é€²è¡Œå®‰è£ã€‚å°æ–¼å¤§å¤šæ•¸Linuxå’ŒUnixç³»çµ±ï¼Œä½ cå¯ä»¥é€šéè§£å£“ç¸®å£“ç¸®æ–‡ä»¶ä¾†å®‰è£Vaultã€‚å°‡Vault Binaryæ–‡ä»¶ç§»è‡³ä½ çš„PATHä¸­ï¼Œä»¥ä¾¿åœ¨çµ‚ç«¯ä¸­è¼•é¬†è¨ªå•\nç­†è€…ä½¿ç”¨çš„æ˜¯ Mac M1ï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤é€²è¡Œå®‰è£\nwget https://releases.hashicorp.com/vault/1.14.3/vault_1.14.3_darwin_arm64.zip unzip vault_1.14.3_darwin_arm64.zip sudo mv vault /usr/local/bin/vault Vault v1.14.3 (56debfa71653e72433345f23cd26276bc90629ce), built 2023-09-11T21:23:55Z ä½ ä¸éœ€è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Vault ä¹Ÿå¯ä»¥å®Œæˆé€™æ¬¡ workshop\nå•Ÿå‹• Vault server ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤åœ¨æœ¬åœ°å•Ÿå‹• Vault Serverã€‚è«‹ç¢ºä¿ Vault ä¼ºæœå™¨å·²æ­£ç¢ºå•Ÿå‹•ï¼Œä¸¦ä¸”æœªå‡ºç¾éŒ¯èª¤æ¶ˆæ¯ã€‚\nvault server -dev ä½¿ç”¨ -dev é¸é …å¯ä»¥å•Ÿå‹•Vaultçš„é–‹ç™¼æ¨¡å¼ï¼Œè©²æ¨¡å¼ä¸éœ€è¦èº«ä»½é©—è­‰å³å¯é‹è¡ŒVaultã€‚\nç¢ºèªVaulté‹è¡Œ æ‰“é–‹ä½ çš„ç€è¦½å™¨ï¼Œç€è¦½åˆ° http://127.0.0.1:8200\næˆ–è€…ä½¿ç”¨ curl å‘½ä»¤ç™¼é€ GET è«‹æ±‚ï¼š\ncurl http://127.0.0.1:8200/v1/sys/health | jq { \u0026quot;initialized\u0026quot;: true, \u0026quot;sealed\u0026quot;: false, \u0026quot;standby\u0026quot;: false, \u0026quot;performance_standby\u0026quot;: false, \u0026quot;replication_performance_mode\u0026quot;: \u0026quot;disabled\u0026quot;, \u0026quot;replication_dr_mode\u0026quot;: \u0026quot;disabled\u0026quot;, \u0026quot;server_time_utc\u0026quot;: 1694693898, \u0026quot;version\u0026quot;: \u0026quot;1.14.3\u0026quot;, \u0026quot;cluster_name\u0026quot;: \u0026quot;vault-cluster-3273d150\u0026quot;, \u0026quot;cluster_id\u0026quot;: \u0026quot;a32d555e-3346-0757-1d57-21e2f646aaf3\u0026quot; } å¦‚æœVaultæ­£å¸¸é‹è¡Œï¼Œä½ æ‡‰è©²æœƒæ”¶åˆ°ä¸€å€‹åŒ…å«Vaultè¨Šæ¯çš„JSON responseã€‚\nä¹Ÿå¯ä½¿ç”¨ Vault Binary ä¾†å­˜å– Vault API\nexport Vault Server çš„ http endpoint (æˆ‘å€‘å°šæœªå•Ÿå‹• tls listenerï¼Œæ‰€ä»¥æ²’æœ‰ https endpoint)\nexport VAULT_ADDR='http://127.0.0.1:8200' vault status Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 1 Threshold 1 Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type inmem Cluster Name vault-cluster-3273d150 Cluster ID a32d555e-3346-0757-1d57-21e2f646aaf3 HA Enabled false å¯ä»¥çœ‹åˆ°æœ¬åœ°çš„ Vault server\nå·²åˆå§‹åŒ– å·²è§£å° ç‰ˆæœ¬ æœªå•Ÿç”¨ HA ä¹Ÿå¯ä»¥ä½¿ç”¨ Vault Binary ä¸­çš„ operator æŒ‡ä»¤æª¢æ¸¬\nvault operator members Host Name API Address Cluster Address Active Node Version Upgrade Version Redundancy Zone Last Echo --------- ----------- --------------- ----------- ------- --------------- --------------- --------- CheChias-MacBook-Pro.local http://127.0.0.1:8200 https://127.0.0.1:8201 true 1.14.3 n/a n/a n/a åˆå§‹åŒ–Vault åœ¨é–‹ç™¼æ¨¡å¼ä¸‹é‹è¡Œçš„Vaultå¯èƒ½ä¸éœ€è¦åˆå§‹åŒ–ï¼Œä½†å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ production æ¨¡å¼ï¼Œè«‹åƒè€ƒVaultçš„å®˜æ–¹æ–‡æª”ï¼Œé€²è¡Œåˆå§‹åŒ–å’Œè¨­ç½®ã€‚\nVault server åœ¨ dev æ¨¡å¼ä¸‹å•Ÿå‹•å¾Œï¼Œæœƒè‡ªå‹•ç”¢ç”Ÿä¸€éš»å–®ä¸€å€‹ unseal keyï¼Œèˆ‡ä¸€æŠŠ Root Tokenã€‚\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory and starts unsealed with a single unseal key. The root token is already authenticated to the CLI, so you can immediately begin using Vault. You may need to set the following environment variables: $ export VAULT_ADDR='http://127.0.0.1:8200' The unseal key and root token are displayed below in case you want to seal/unseal the Vault or re-authenticate. Unseal Key: JbKrVzhH4VO14nPBRvWE1qxJz9CVhnOFJT0pYLsx9LU= Root Token: hvs.0pmmzGSZ8S7w8vP2E4sm7SqE Development mode should NOT be used in production installations! ä½ å¯ä»¥ä½¿ç”¨ vault operator æŒ‡ä»¤ï¼Œå˜—è©¦ seal Vault server\nvault operator seal Success! Vault is sealed. å†æ¬¡æª¢æŸ¥ status\nvault status Key Value --- ----- Seal Type shamir Initialized true Sealed true Total Shares 1 Threshold 1 Unseal Progress 0/1 Unseal Nonce n/a Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type inmem HA Enabled false é¡¯ç¤ºç‚ºå¯†é‘°å¯†å°ï¼ˆSealedï¼‰ç‹€æ…‹\nä½ å¯ä»¥ä½¿ç”¨ vault operator è§£å° Vault\nvault operator unseal JbKrVzhH4VO14nPBRvWE1qxJz9CVhnOFJT0pYLsx9LU= Key Value --- ----- Seal Type shamir Initialized true Sealed false Total Shares 1 Threshold 1 Version 1.14.3 Build Date 2023-09-11T21:23:55Z Storage Type inmem Cluster Name vault-cluster-3273d150 Cluster ID a32d555e-3346-0757-1d57-21e2f646aaf3 HA Enabled false é¡¯ç¤ºç‚ºè§£å°ç‹€æ…‹\nå¯†é‘°å®‰å…¨ æœ¬ workshop ä¸­ä½¿ç”¨çš„ vault server / seal key / root token éƒ½æ˜¯æ¸¬è©¦ç”¨é€”çš„æš«æ™‚æ€§å­˜åœ¨ï¼Œç­†è€…å¯«å®Œæ–‡ç« å¾Œï¼Œé€™äº› server èˆ‡å¯†é‘°æ—©å·²ç¶“æ¸…ç†å®Œç•¢ï¼Œæ‰€ä»¥æ²’æœ‰è³‡å®‰é¢¨éšªã€‚\nç‚ºäº†ç¤ºç¯„æ–¹ä¾¿ï¼Œworkshop æœƒä»¥æ˜ç¢¼ plain text å½¢å¼è¡¨ç¾\nå¦‚æœä½ æ˜¯åœ¨å…¬å¸çš„ production ç’°å¢ƒä½¿ç”¨ï¼Œå‹™å¿…è¦ç¢ºä¿å¯†é‘°çš„å®‰å…¨\nä¸è¦åœ¨ local é›»è…¦ä¸Šå­˜æ”¾ token æˆ– seal key ä¸è¦åœ¨æ²’æœ‰å¯†ç¢¼å­¸èˆ‡è³‡å®‰æª¢æ¸¬çš„å¹³å°ä¸Šå„²å­˜ token æˆ– seal key ä¸è¦é€éé€šè¨Šè»Ÿé«”(ex. slack) æ˜ç¢¼å‚³é€ token æˆ– seal key \u0026hellip; ä½ å¯èƒ½æœƒå•ï¼Œæœ¬åœ°ä¸èƒ½å­˜ï¼Œé ç«¯ä¹Ÿä¸èƒ½å­˜ï¼Œä¹Ÿä¸èƒ½éš¨æ„å‚³é€çµ¦åŒäº‹ï¼Œé‚£æ‡‰è©²å¦‚ä½•å”ä½œèˆ‡ç®¡ç†ï¼Ÿ\nåœ¨å¾Œé¢çš„ workshop å…§å®¹æœƒèˆ‡å¤§å®¶ä¸€ä¸€ç¤ºç¯„è§£èªª\nDev æ¨¡å¼ ä½ å¯ä»¥é—œé–‰åŸ·è¡Œ vault server çš„ terminal session ä¾†é—œé–‰ vault server\nvault server -dev ctrl + c https://developer.hashicorp.com/vault/docs/concepts/dev-server\n\u0026ldquo;Dev\u0026rdquo; ä¼ºæœå™¨æ¨¡å¼\ndev æ¨¡å¼çš„ä¼ºæœå™¨ä¸éœ€è¦é€²ä¸€æ­¥çš„è¨­å®šï¼Œä¸”ä½ æœ¬åœ°çš„ vault CLI å·²ç¶“è¢«èªè­‰ã€‚é€™ä½¿å¾—ä½¿ç”¨ Vault æˆ–å•Ÿå‹•ç”¨æ–¼é–‹ç™¼çš„ Vault instance è®Šå¾—å®¹æ˜“ã€‚Vault çš„æ¯ä¸€å€‹åŠŸèƒ½åœ¨ \u0026ldquo;dev\u0026rdquo; æ¨¡å¼ä¸­éƒ½æ˜¯å¯ç”¨çš„ã€‚-dev flag åªæ˜¯å°‡å¾ˆå¤šè¨­ç½®ç°¡åŒ–ç‚ºä¸å®‰å…¨çš„é»˜èªå€¼ã€‚\nè­¦å‘Šï¼šæ°¸é ã€æ°¸é ã€æ°¸é ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­é‹è¡Œ \u0026ldquo;dev\u0026rdquo; æ¨¡å¼ä¼ºæœå™¨ã€‚é€™æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸”æ¯æ¬¡é‡æ–°å•Ÿå‹•éƒ½æœƒä¸Ÿå¤±è³‡æ–™ï¼ˆå› ç‚ºå®ƒå°‡è³‡æ–™å­˜å„²åœ¨è¨˜æ†¶é«”ä¸­ï¼‰ã€‚å®ƒåƒ…ä¾›é–‹ç™¼æˆ–å¯¦é©—ä½¿ç”¨ã€‚\ndev æ¨¡å¼ç‰¹æ€§ dev ä¼ºæœå™¨çš„å±¬æ€§ï¼ˆæœ‰äº›å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œ flag æˆ–æŒ‡å®šé…ç½®æ–‡ä»¶ä¾†è¦†å¯«ï¼‰ï¼š\nåˆå§‹åŒ–ä¸”æœªå°å°: ä¼ºæœå™¨å°‡è‡ªå‹•åˆå§‹åŒ–ä¸”æœªå°å°ã€‚ä½ ä¸éœ€è¦ä½¿ç”¨ vault operator unsealã€‚å®ƒç«‹å³å¯ç”¨ã€‚\nè¨˜æ†¶é«”å­˜å„²: æ‰€æœ‰è³‡æ–™ï¼ˆåŠ å¯†å¾Œï¼‰éƒ½å­˜å„²åœ¨è¨˜æ†¶é«”ä¸­ã€‚Vault ä¼ºæœå™¨ä¸éœ€è¦ä»»ä½•æª”æ¡ˆæ¬Šé™ã€‚\nç¶å®šåˆ°æœ¬åœ°åœ°å€è€Œä¸ä½¿ç”¨ TLS: ä¼ºæœå™¨æ­£åœ¨ç›£è½ 127.0.0.1:8200ï¼ˆé»˜èªçš„ä¼ºæœå™¨åœ°å€ï¼‰è€Œä¸ä½¿ç”¨ TLSã€‚\nè‡ªå‹•èªè­‰: ä¼ºæœå™¨å­˜å„²äº†ä½ çš„ root access tokenï¼Œæ‰€ä»¥ vault CLI å­˜å–å·²ç¶“æº–å‚™å¥½ã€‚å¦‚æœä½ é€é API å­˜å– Vaultï¼Œä½ éœ€è¦ä½¿ç”¨æ‰“å°å‡ºçš„ token é€²è¡Œèªè­‰ã€‚\nå–®ä¸€è§£å°é‘°åŒ™: ä¼ºæœå™¨ä½¿ç”¨å–®ä¸€çš„ unseal key é€²è¡Œåˆå§‹åŒ–ã€‚Vault å·²ç¶“æ˜¯è§£å°çš„ï¼Œä½†å¦‚æœä½ æƒ³å˜—è©¦ seal/unsealï¼Œé‚£éº¼åªéœ€è¦è¼¸å‡ºçš„å–®ä¸€é‘°åŒ™ã€‚\nå®‰è£ key value storage: åœ¨ secret/ è™•å®‰è£äº†ä¸€å€‹ v2 KV secret engineã€‚è«‹æ³¨æ„ v1 KV æœ‰æ‰€ä¸åŒã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ v1ï¼Œä½¿ç”¨æ­¤æ——æ¨™ -dev-kv-v1ã€‚\nç¬¬ä¸€æ¬¡å­˜å– vault è³‡æ–™ å»ºç«‹é€šç”¨ Key-Value å­˜å„²ï¼š ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨ Vault ä¸­å‰µå»ºé€šç”¨çš„ Key-Value å­˜å„²ã€‚åœ¨é€™å€‹ä¾‹å­ä¸­ï¼Œæˆ‘å€‘å°‡ä½¿ç”¨ secrets ä½œç‚ºå­˜å„²çš„è·¯å¾‘ï¼Œä½ å¯ä»¥æ ¹æ“šä½ çš„éœ€æ±‚è‡ªè¡Œå‘½åå­˜å„²è·¯å¾‘ï¼š\nvault kv put secret/mysecrets username=admin password=secretpassword é€™å€‹å‘½ä»¤å°‡åœ¨ Vault ä¸­å‰µå»ºä¸€å€‹ Key-Value å­˜å„²ï¼Œå…¶ä¸­åŒ…å«ä¸€å° Key value pairï¼Œåˆ†åˆ¥æ˜¯ username å’Œ passwordã€‚\næª¢ç´¢å­˜å„²çš„å€¼ï¼š ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æª¢ç´¢å­˜å„²ä¸­çš„å€¼ï¼š\nvault kv get secret/mysecrets é€™å€‹å‘½ä»¤å°‡è¿”å›å­˜å„²ä¸­çš„æ‰€æœ‰ Key Value pairã€‚\næ›´æ–°å­˜å„²çš„å€¼ï¼š å¦‚æœä½ éœ€è¦æ›´æ–°å­˜å„²ä¸­çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\nvault kv put secret/mysecrets password=newsecretpassword é€™å€‹å‘½ä»¤å°‡æ›´æ–°å­˜å„²ä¸­çš„ password éµçš„å€¼ã€‚\nåˆªé™¤å­˜å„²çš„å€¼ï¼š è‹¥è¦åˆªé™¤å­˜å„²ä¸­çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\nvault kv delete secret/mysecrets é€™å€‹å‘½ä»¤å°‡åˆªé™¤æ•´å€‹å­˜å„²è·¯å¾‘åŠå…¶å…§å®¹\né—œæ–¼ kv-v2 dev æ¨¡å¼ä¸‹ï¼ŒVault server è‡ªå‹•åœ¨ secret/ è™•å®‰è£äº†ä¸€å€‹ v2 KV secret engine\nVaultä¸­çš„ä¸åŒç§˜å¯†å¼•æ“ï¼ˆSecret Engineï¼‰æä¾›äº†ä¸åŒçš„åŠŸèƒ½å’Œç‰¹æ€§ã€‚æœ¬æ¬¡ workshop æœƒä»¥æœ€æ–°ï¼ŒåŠŸèƒ½ä¹Ÿæœ€å¤šå…ƒçš„ kv-v2 Secret Engine ç‚ºä¸»ã€‚\nä»¥ä¸‹æ˜¯ä¸‰ç¨®å¸¸è¦‹çš„ç§˜å¯†å¼•æ“ï¼ˆgenericã€kv v1 å’Œ kv v2ï¼‰ä¹‹é–“çš„ä¸»è¦å€åˆ¥ï¼š\nGeneric Secrets Engineï¼ˆé€šç”¨ç§˜å¯†å¼•æ“ï¼‰ ç‰¹æ€§ï¼š é€šç”¨ç§˜å¯†å¼•æ“æ˜¯ä½ çš„æœ€ç°¡å–®çš„å¼•æ“ä¹‹ä¸€ï¼Œå®ƒå…è¨±ä½ å­˜å„²å’Œæª¢ç´¢é€šç”¨çš„ Key Value Secretï¼Œé€™äº› Secret ä¸éœ€è¦ç‰¹å®šçš„çµæ§‹æˆ–æ ¼å¼ã€‚\nç”¨æ³•ï¼š é€šç”¨ç§˜å¯†å¼•æ“é©ç”¨æ–¼ç°¡å–®çš„ç§˜å¯†å­˜å„²éœ€æ±‚ï¼Œå…¶ä¸­ Secret å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„æ•¸æ“šã€‚ä½ å¯ä»¥ä½¿ç”¨é€šç”¨ç§˜å¯†å¼•æ“ä¾†å­˜å„²APIé‡‘é‘°ã€å¯†ç¢¼ã€é…ç½®ä¿¡æ¯ç­‰ã€‚\nKey-Value (KV) Version 1 Secrets Engineï¼ˆKV v1 ç§˜å¯†å¼•æ“ï¼‰ ç‰¹æ€§ï¼š KV v1ç§˜å¯†å¼•æ“å¼•å…¥äº†ä¸€å€‹æœ‰å±¤æ¬¡çµæ§‹çš„éµå€¼å­˜å„²ï¼Œå…è¨±ä½ çµ„ç¹”å’Œç‰ˆæœ¬æ§åˆ¶å„²å­˜çš„ Secretã€‚å®ƒå…·æœ‰ Secret ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥ä¿å­˜å¤šå€‹ç‰ˆæœ¬çš„ Secretã€‚\nç”¨æ³•ï¼š KV v1å¼•æ“é©ç”¨æ–¼éœ€è¦æœ‰çµ„ç¹”çµæ§‹ä¸¦å¸Œæœ›ä¿ç•™ç§˜å¯†ç‰ˆæœ¬çš„æƒ…æ³ã€‚å®ƒå¯ä»¥ç”¨æ–¼å­˜å„²é…ç½®ä¿¡æ¯ã€TLSè­‰æ›¸ã€APIé‡‘é‘°ç­‰ã€‚\nKey-Value (KV) Version 2 Secrets Engineï¼ˆKV v2 ç§˜å¯†å¼•æ“ï¼‰ ç‰¹æ€§ï¼š KV v2ç§˜å¯†å¼•æ“æ˜¯KV v1çš„é€²åŒ–ç‰ˆæœ¬ï¼Œå®ƒå¼•å…¥äº†æ›´å¼·å¤§çš„ç‰¹æ€§ï¼Œå¦‚å¯é…ç½®çš„ Secret Data typeï¼ˆå¦‚å­—ç¬¦ä¸²ã€list å’Œ dictï¼‰ï¼Œä¸¦å¯è¨­ç½®çš„å¤šç‰ˆæœ¬çš„ Secret å­˜å„²ã€‚\nç”¨æ³•ï¼š KV v2å¼•æ“é©ç”¨æ–¼æ›´è¤‡é›œçš„ç§˜å¯†ç®¡ç†éœ€æ±‚ï¼Œå…¶ä¸­ç§˜å¯†å¯èƒ½å…·æœ‰ä¸åŒçš„æ•¸æ“šé¡å‹ï¼Œä¸¦ä¸”éœ€è¦æ›´éˆæ´»çš„ç‰ˆæœ¬ç®¡ç†ã€‚å®ƒä¹Ÿç”¨æ–¼é…ç½®ä¿¡æ¯ã€TLSè­‰æ›¸ã€APIé‡‘é‘°ç­‰ã€‚\nç¸½çµä¾†èªªï¼Œé€šç”¨ç§˜å¯†å¼•æ“é©ç”¨æ–¼ç°¡å–®çš„ç§˜å¯†å­˜å„²ï¼Œè€ŒKV v1å’ŒKV v2ç§˜å¯†å¼•æ“é©ç”¨æ–¼æ›´è¤‡é›œçš„ç§˜å¯†ç®¡ç†éœ€æ±‚ï¼Œå…·æœ‰æ›´å¤šçš„çµ„ç¹”å’Œç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ã€‚åœ¨é¸æ“‡å¼•æ“æ™‚ï¼Œè«‹è€ƒæ…®ä½ çš„å…·é«”éœ€æ±‚å’ŒVaultçš„é…ç½®ã€‚é€šå¸¸ï¼ŒKV v2å¼•æ“æ˜¯è¼ƒæ–°å’Œæ›´éˆæ´»çš„é¸æ“‡ï¼Œä½†æ ¹æ“šä½ çš„æƒ…æ³ï¼Œä¹Ÿå¯ä»¥è€ƒæ…®ä½¿ç”¨å…¶ä»–å¼•æ“ã€‚\ndev ä½¿ç”¨æƒ…å¢ƒ dev ä¼ºæœå™¨æ‡‰è©²ç”¨æ–¼å¯¦é©— Vault çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä¸åŒçš„èªè­‰æ–¹æ³•ã€Secret engineã€audit device ç­‰ã€‚\né™¤äº†å¯¦é©—ï¼Œdev ä¼ºæœå™¨å°æ–¼é–‹ç™¼ç’°å¢ƒçš„è‡ªå‹•åŒ–éå¸¸å®¹æ˜“ã€‚\nå°çµ é€šéåŸ·è¡Œé€™äº›æ­¥é©Ÿï¼Œä½ å¯ä»¥ç¢ºä¿æœ¬åœ°å®‰è£çš„ Vault Binary æ­£å¸¸é‹è¡Œã€‚\nè«‹æ³¨æ„ï¼ŒVaultçš„å¯¦éš›é…ç½®å’Œä½¿ç”¨å°‡æ ¹æ“šä½ çš„éœ€æ±‚å’Œç’°å¢ƒè€Œæœ‰æ‰€ä¸åŒï¼Œé€™äº›æ­¥é©Ÿä¸»è¦ç”¨æ–¼ç¢ºä¿Vaultçš„åŸºæœ¬åŠŸèƒ½æ­£å¸¸é‹è¡Œã€‚åœ¨ production ç’°å¢ƒä¸­ï¼Œä½ éœ€è¦æ›´å¤šçš„é…ç½®å’Œå®‰å…¨æ€§æªæ–½ã€‚\n","permalink":"https://chechia.net/posts/2023-09-13-vault-workshop-get-started/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003ch1 id=\"day-02-æº–å‚™åŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„-vault\"\u003eDay 02 æº–å‚™ï¼šåŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„ Vault\u003c/h1\u003e\n\u003cp\u003eæ•´ç¯‡ Workshop æœƒä½¿ç”¨çš„ç¯„ä¾‹èˆ‡åŸå§‹ç¢¼ï¼Œæ”¾åœ¨ \u003ca href=\"http://chechia.net/zh-hant/#projects\"\u003eGithub Repository: vault-playground\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"æº–å‚™å·¥ä½œ\"\u003eæº–å‚™å·¥ä½œ\u003c/h3\u003e\n\u003cp\u003eåœ¨é–‹å§‹é€²è¡Œ Vault 30 å¤© workshop ä¹‹å‰ï¼Œæœ‰ä¸€äº›æº–å‚™å·¥ä½œéœ€è¦å®Œæˆï¼š\u003c/p\u003e\n\u003cp\u003eæ­¥é©Ÿ1ï¼šä¸‹è¼‰ Vault Binary\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œä½ éœ€è¦ä¸‹è¼‰HashiCorp Vaultçš„æœ€æ–°ç‰ˆæœ¬ã€‚ä½ å¯ä»¥åœ¨HashiCorpçš„å®˜æ–¹ç¶²ç«™ä¸Šæ‰¾åˆ°Vaultçš„ä¸‹è¼‰éˆæ¥ã€‚è«‹ç¢ºä¿ä¸‹è¼‰é©ç”¨æ–¼ä½ æ“ä½œç³»çµ±çš„ç‰ˆæœ¬ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.hashicorp.com/vault/downloads\"\u003ehttps://developer.hashicorp.com/vault/downloads\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://releases.hashicorp.com/vault/1.14.3/vault_1.14.3_darwin_amd64.zip\"\u003eMacOS amd64\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://releases.hashicorp.com/vault/1.14.3/vault_1.14.3_darwin_arm64.zip\"\u003eMacOS arm64\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://releases.hashicorp.com/vault/1.14.3/vault_1.14.3_linux_amd64.zip\"\u003eLinux\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ­¥é©Ÿ2ï¼šå®‰è£Vault\u003c/p\u003e\n\u003cp\u003eä¸‹è¼‰å®Œæˆå¾Œï¼Œæ ¹æ“šä½ çš„æ“ä½œç³»çµ±é€²è¡Œå®‰è£ã€‚å°æ–¼å¤§å¤šæ•¸Linuxå’ŒUnixç³»çµ±ï¼Œä½ cå¯ä»¥é€šéè§£å£“ç¸®å£“ç¸®æ–‡ä»¶ä¾†å®‰è£Vaultã€‚å°‡Vault Binaryæ–‡ä»¶ç§»è‡³ä½ çš„PATHä¸­ï¼Œä»¥ä¾¿åœ¨çµ‚ç«¯ä¸­è¼•é¬†è¨ªå•\u003c/p\u003e\n\u003cp\u003eç­†è€…ä½¿ç”¨çš„æ˜¯ Mac M1ï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤é€²è¡Œå®‰è£\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003ewget https://releases.hashicorp.com/vault/1.14.3/vault_1.14.3_darwin_arm64.zip\nunzip vault_1.14.3_darwin_arm64.zip\n\nsudo mv vault /usr/local/bin/vault\n\nVault v1.14.3 (56debfa71653e72433345f23cd26276bc90629ce), built 2023-09-11T21:23:55Z\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½ ä¸éœ€è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Vault ä¹Ÿå¯ä»¥å®Œæˆé€™æ¬¡ workshop\u003c/p\u003e\n\u003ch3 id=\"å•Ÿå‹•-vault-server\"\u003eå•Ÿå‹• Vault server\u003c/h3\u003e\n\u003cp\u003eä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤åœ¨æœ¬åœ°å•Ÿå‹• Vault Serverã€‚è«‹ç¢ºä¿ Vault ä¼ºæœå™¨å·²æ­£ç¢ºå•Ÿå‹•ï¼Œä¸¦ä¸”æœªå‡ºç¾éŒ¯èª¤æ¶ˆæ¯ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003evault server -dev\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½¿ç”¨ -dev é¸é …å¯ä»¥å•Ÿå‹•Vaultçš„é–‹ç™¼æ¨¡å¼ï¼Œè©²æ¨¡å¼ä¸éœ€è¦èº«ä»½é©—è­‰å³å¯é‹è¡ŒVaultã€‚\u003c/p\u003e","title":"Vault Workshop 02: Get Started"},{"content":"å¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹éµäººè³½2023\næœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDay 01 å‰è¨€ï¼šå¾é›¶é–‹å§‹çš„ Hashicorp Vault Workshop å¾é›¶é–‹å§‹ workshop ç³»åˆ—å·²ç¶“åšäº†å››å¹´ï¼Œå…§å®¹åŒ…å« k8s, terraform, aws ç­‰ã€‚\næ·±æ·±è¦ºå¾—è¦å­¸ç¿’ä¸€å€‹å·¥å…·ï¼Œé‚„æ˜¯è¦å‹•æ‰‹åšã€‚\næ‰€ä»¥æœ‰äº† 30 å¤©æ‰‹æŠŠæ‰‹ workshop ç³»åˆ—æ–‡ï¼Œè®“æœ‰èˆˆè¶£æ¥è§¸çš„æœ‹å‹ï¼Œèƒ½ä»¥ç›¸å°ä½çš„é–€æª»å…¥é–€ã€‚\né—œæ–¼å…§å®¹\nç„¡åŸºç¤çš„æ‰‹æŠŠæ‰‹çš„åŸºç¤æ•™å­¸ å®Œæ•´çš„ç¯„ä¾‹ï¼Œæä¾›åŸå§‹ç¨‹å¼ç¢¼ï¼Œä¹Ÿæä¾› production çš„ç¶“é©—èˆ‡ç¯„ä¾‹ å®˜æ–¹æœ€æ–°æ–‡ä»¶ç¹ä¸­ç¿»è­¯ (chatGPT based) å»ºè­°è®€è€…å‹™å¿…è·Ÿè‘—æ“ä½œï¼Œä¸è¦åªæ˜¯çœ‹é\nå…¶ä»–æ–‡ç«  https://chechia.net/\néå»çš„ Workshop\n2022 éµäººè³½: Terraform IaC Best Practice on AWS Cloud / åœ¨ aws å…¬æœ‰é›²ä¸Šæ‰¾ IaC æœ€ä½³å¯¦è¸ (å› æ•…é€€è³½) 2021 éµäººè³½: Terraform Workshop - Infrastructure as Code for Public Cloud 2020 éµäººè³½: Kubernetes X DevOps X å¾é›¶é–‹å§‹å°å…¥å·¥å…· X éœ€æ±‚åˆ†æ 2019 éµäººè³½: Kubernetes é å®šå…§å®¹èˆ‡è¨±é¡˜æ¸…å–® æœ¬ workshop é è¨ˆæœ‰åº•ä¸‹å…§å®¹\nDay 01 å‰è¨€ï¼šå¾é›¶é–‹å§‹çš„ Hashicorp Vault Workshop Day 02 æº–å‚™ï¼šåŸ·è¡Œä¸€å€‹æœ¬åœ°é–‹ç™¼ç”¨é€”çš„ Vault Day 03ï¼šç´°æ¢ Secret Engine ç§˜å¯†å¼•æ“ Day 04ï¼šSecret Engine KV V2 Day 05ï¼šAuthentication Day 06: Github auth method Day 07: Policy Day 08: Docker and Initialization æœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€ï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\nDynamic Secrets tls certificate management configuration docker initialization ha storage backend filesystem postgresql Infrastructure as Code for Vault deploy policy auth method Vault Kuberntes integration Azure integration AWS integration token in detail é—œæ–¼ç¿»è­¯å·¥å…· chatGPT æœ¬ç³»åˆ—æ–‡ç« å¤§é‡ä½¿ç”¨ chatGPT ç¿»è­¯å®˜æ–¹æ–‡ç« ã€‚ç›®çš„æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆå®˜æ–¹æ–‡ä»¶å…§å®¹ï¼Œæä¾›ç¬¬ä¸€æ‰‹ä¸”ç²¾æº–çš„è³‡æ–™çµ¦è®€è€…ï¼Œä½†åˆèƒ½é™ä½éæ¯èªè®€è€…å¾—å­¸ç¿’é–€æª»ã€‚\næœ‰ç¿»è­¯çš„æ®µè½éƒ½æœƒæ¨™ç¤ºå‡ºè™•ï¼Œè‘—ä½œæ¬Šçš†å±¬æ–¼åŸå‡ºè™•æ‰€æœ‰ã€‚\næœ¬ç³»åˆ—æ–‡ç« ä»¥åˆ†äº«è³‡è¨Šï¼Œè²¢ç»ç¤¾ç¾¤ï¼Œæé«˜åœ‹å…§æ•´é«”æŠ€è¡“èƒ½åŠ›ç‚ºç›®çš„ï¼Œä¸¦ä¸ç”¨æ–¼å•†æ¥­ç”¨é€”ã€‚\nä½¿ç”¨ç¿»è­¯å·¥å…·ä¸¦ä¸ä»£è¡¨ä½œè€…ï¼ˆè­¯è€…ï¼‰æ²’æœ‰ä»˜å‡ºç›¸ç•¶æ™‚é–“å¿ƒåŠ›ï¼ŒåŒ…å«è¦åŠƒæ–‡ç« å¤§ç¶±ï¼Œæ¸¬è©¦ prompt engineeringï¼Œèª¿æ•´åƒæ•¸ï¼Œä¸¦äººå·¥æ ¡æ­£ç”¢ç”Ÿçš„å…§å®¹ã€‚\næœ¬ç³»åˆ—ä½œå“åœ¨æ–¼æ•™å°è®€è€…ä½¿ç”¨å·¥å…· Hashicorp Vaultï¼Œè€Œ chatGPT ç­‰å¤§èªè¨€æ¨¡å‹å·¥å…·å°±æ˜¯è¿‘å¹´æœ€å€¼å¾—å­¸ç¿’çš„å·¥å…·ã€‚å¦‚æœè®€è€…é‚„ä¸æœƒä½¿ç”¨ chatGPTï¼Œæœ¬ç³»åˆ—æ–‡ç« éƒ½é™„ä¸Š Prompt æç¤ºè©ï¼Œå¯ä»¥åƒè€ƒï¼Œå­¸ç¿’ï¼Œä¸¦è‡ªç”±ä½¿ç”¨ã€‚ä¹Ÿè¨±å­¸æœƒä½¿ç”¨ chatGPT æ‰€å¸¶ä¾†çš„åƒ¹å€¼ï¼Œæœƒæ¯”å­¸ç¿’ Vault å¸¶ä¾†çš„é‚„å¤šã€‚\nå¾ˆé‡è¦æ‰€ä»¥å†èªªä¸€éï¼ŒchatGPT æ˜¯è¿‘å¹´æœ€å€¼å¾—å­¸ç¿’çš„å·¥å…·ï¼Œæ²’æœ‰ä¹‹ä¸€ã€‚\nhttps://github.com/f/awesome-chatgpt-prompts/blob/main/prompts.csv What is Vault? æœ¬æ®µå…§å®¹ä½¿ç”¨ chatGPT-3.5 ç¿»è­¯ https://developer.hashicorp.com/vault/docs/what-is-vault å…§å®¹ï¼Œä¸¦ç”±ç­†è€…äººå·¥æ ¡é©—\nbase context\næˆ‘å¸Œæœ›ä½ èƒ½å……ç•¶ä¸€åç¹é«”ä¸­æ–‡ç¿»è­¯ï¼Œæ‹¼å¯«ä¿®æ­£è€…å’Œæ”¹é€²è€…ã€‚æˆ‘å°‡ç”¨è‹±æ–‡èˆ‡ç¨‹å¼èªè¨€èˆ‡ä½ å°è©±ï¼Œä½ å°‡ç¿»è­¯å®ƒï¼Œä¸¦ä»¥å·²ç³¾æ­£ä¸”æ”¹é€²çš„ç‰ˆæœ¬å›ç­”ï¼Œä»¥ç¹é«”ä¸­æ–‡è¡¨é”ã€‚æˆ‘å¸Œæœ›ä½ èƒ½ç”¨æ›´ç¾éº—å’Œå„ªé›…ã€é«˜ç´šçš„ç¹é«”ä¸­æ–‡è©èªå’Œå¥å­æ›¿æ›æˆ‘ç°¡åŒ–çš„è©èªå’Œå¥å­ã€‚ä¿æŒæ„ç¾©ä¸è®Šã€‚æˆ‘åªå¸Œæœ›ä½ å›ç­”ç³¾æ­£å’Œæ”¹é€²ï¼Œä¸è¦å¯«è§£é‡‹ã€‚ä¸è¦ä½¿ç”¨æ•¬èªï¼Œè«‹ç”¨ä½ å–ä»£æ‚¨ã€‚ result correction\néƒ¨åˆ†è‹±æ–‡å…§å®¹ç‚ºå°ˆæœ‰åè©ï¼Œç”¢ç”Ÿçš„ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœä¸­ï¼Œé€™äº›åè©ç¶­æŒè‹±æ–‡ï¼Œä¸éœ€è¦ç¿»è­¯æˆä¸­æ–‡ï¼škeyï¼Œcertificateï¼Œtokenï¼Œpolicyï¼Œpolicy ruleï¼Œpathï¼Œpath-basedï¼Œkey rollingï¼Œauditï¼Œaudit trailï¼Œplain textï¼Œkey valueï¼ŒConsulï¼ŒS3 bucketï¼ŒLeasingï¼ŒRenewalï¼Œbinary ä¿®æ­£ä¸‹åˆ—ç¿»è­¯ï¼šç§˜å¯†æ”¹ç‚ºç§é‘°ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œæ•¸æ“šåº«æ”¹ç‚ºè³‡æ–™åº«ï¼Œæ•¸æ“šæ”¹ç‚ºè³‡æ–™ï¼Œè¨ªå•æ”¹ç‚ºå­˜å–ï¼Œæºä»£ç¢¼æ”¹ç‚ºåŸå§‹ç¢¼ã€‚ What is Vault? HashiCorp Vault æ˜¯ä¸€å¥—åŸºæ–¼èº«ä»½çš„ç§é‘°å’ŒåŠ å¯†ç®¡ç†ç³»çµ±ã€‚æ‰€è¬‚çš„\u0026quot;ç§é‘°\u0026quot;ï¼Œæ˜¯ä½ å¸Œæœ›åš´æ ¼æ§åˆ¶å­˜å–çš„è³‡è¨Šï¼Œä¾‹å¦‚ API keyã€å¯†ç¢¼å’Œcertificateã€‚Vault æä¾›åŠ å¯†æœå‹™ï¼Œä¸¦é€éèªè­‰å’Œæˆæ¬Šæ–¹æ³•é€²è¡Œç®¡æ§ã€‚ä½¿ç”¨ Vault çš„ä½¿ç”¨è€…ä»‹é¢ã€å‘½ä»¤åˆ—ä»‹é¢æˆ– HTTP APIï¼Œå¯ä»¥å®‰å…¨åœ°å„²å­˜å’Œç®¡ç†ç§é‘°åŠå…¶ä»–æ•æ„Ÿè³‡æ–™ï¼Œä¸¦èƒ½åš´æ ¼æ§åˆ¶ï¼ˆé™åˆ¶ï¼‰å…¶å­˜å–æ¬Šï¼Œä¸¦å¯é€²è¡Œ auditã€‚\nç¾ä»£ç³»çµ±éœ€è¦å­˜å–å¤§é‡çš„ç§é‘°ï¼ŒåŒ…æ‹¬è³‡æ–™åº«æ†‘è­‰ã€å¤–éƒ¨æœå‹™çš„ API keyã€é¢å‘æœå‹™çš„æ¶æ§‹é€šè¨Šæ†‘è­‰ç­‰ã€‚äº†è§£èª°æ­£åœ¨å­˜å–å“ªäº›ç§é‘°å¯èƒ½ç›¸ç•¶å›°é›£ï¼Œå°¤å…¶ç•¶é€™ç¨®å­˜å–å¯èƒ½å› å¹³å°è€Œç•°ã€‚è€Œåœ¨æ­¤åŸºç¤ä¸ŠåŠ å…¥key rollingã€å®‰å…¨å„²å­˜å’Œè©³ç´°çš„audit trailï¼Œè‹¥ç„¡è‡ªè¨‚çš„è§£æ±ºæ–¹æ¡ˆå¹¾ä¹æ˜¯ä¸å¯èƒ½çš„ã€‚é€™æ­£æ˜¯ Vault ç™¼æ®ä½œç”¨çš„åœ°æ–¹ã€‚\nVault æœƒé©—è­‰ä¸¦æˆæ¬Šå®¢æˆ¶ç«¯ï¼ˆç”¨æˆ¶ã€æ©Ÿå™¨ã€æ‡‰ç”¨ç¨‹åºï¼‰åœ¨æä¾›ä»–å€‘å­˜å–ç§˜å¯†æˆ–å„²å­˜çš„æ•æ„Ÿè³‡æ–™ä¹‹å‰ã€‚\nVault å¦‚ä½•é‹ä½œï¼š Vault ä¸»è¦ä½¿ç”¨ tokenï¼Œä¸” token èˆ‡å®¢æˆ¶ç«¯çš„ policy ç›¸é—œè¯ã€‚æ¯ä¸€ policy éƒ½æ˜¯åŸºæ–¼ path-based çš„ï¼Œpolicy rule é™åˆ¶æ¯å€‹å®¢æˆ¶ç«¯å°æ–¼æ¯ä¸€ path çš„è¡Œå‹•å’Œå­˜å–èƒ½åŠ›ã€‚ä½¿ç”¨ Vaultï¼Œä½ å¯ä»¥æ‰‹å‹•å»ºç«‹ token ä¸¦æŒ‡æ´¾çµ¦ä½ çš„å®¢æˆ¶ç«¯ï¼Œæˆ–å®¢æˆ¶ç«¯å¯ä»¥ç™»å…¥ä¸¦ç²å¾— tokenã€‚ä¸‹é¢çš„æ’åœ–é¡¯ç¤ºäº† Vault çš„æ ¸å¿ƒå·¥ä½œæµç¨‹ã€‚\nVault å·¥ä½œæµç¨‹ Vault çš„æ ¸å¿ƒå·¥ä½œæµç¨‹åŒ…å«å››å€‹éšæ®µï¼š\nèªè­‰ï¼šåœ¨ Vault ä¸­çš„èªè­‰æ˜¯æŒ‡å®¢æˆ¶ç«¯æä¾›è³‡è¨Šï¼ŒVault ä½¿ç”¨æ­¤è³‡è¨Šä¾†åˆ¤å®šä»–å€‘æ˜¯å¦æ˜¯ä»–å€‘æ‰€è²ç¨±çš„é‚£å€‹äººã€‚ä¸€æ—¦å®¢æˆ¶ç«¯æ ¹æ“šæŸç¨®èªè­‰æ–¹å¼æˆåŠŸèªè­‰ï¼Œå°‡ç”Ÿæˆä¸€å€‹èˆ‡ç­–ç•¥ç›¸é—œè¯çš„ tokenã€‚\né©—è­‰ï¼šVault æ ¹æ“šç¬¬ä¸‰æ–¹å—ä¿¡è³´çš„ä¾†æºï¼Œä¾‹å¦‚ Githubã€LDAPã€AppRole ç­‰ï¼Œå°å®¢æˆ¶ç«¯é€²è¡Œé©—è­‰ã€‚\næˆæ¬Šï¼šå®¢æˆ¶ç«¯æ ¹æ“š Vault å®‰å…¨ç­–ç•¥é€²è¡ŒåŒ¹é…ã€‚æ­¤ç­–ç•¥æ˜¯ä¸€å¥—è¦å‰‡é›†ï¼Œå®šç¾©å®¢æˆ¶ç«¯ä½¿ç”¨å…¶ Vault token å¯å­˜å–å“ªäº› API ç«¯é»ã€‚ç­–ç•¥æä¾›äº†ä¸€ç¨®å®£å‘Šæ–¹å¼ä¾†æˆäºˆæˆ–ç¦æ­¢å­˜å– Vault ä¸­çš„ç‰¹å®šè·¯å¾‘å’Œæ“ä½œã€‚\nå­˜å–ï¼šæ ¹æ“šèˆ‡å®¢æˆ¶ç«¯èº«ä»½ç›¸é—œè¯çš„ç­–ç•¥ï¼ŒVault é€šéç™¼å‡º token ä¾†æˆäºˆå­˜å–ç§˜å¯†ã€é‡‘é‘°å’ŒåŠ å¯†èƒ½åŠ›çš„æ¬Šé™ã€‚ç„¶å¾Œï¼Œå®¢æˆ¶ç«¯å¯ä»¥ä½¿ç”¨ä»–å€‘çš„ Vault token é€²è¡Œæœªä¾†çš„æ“ä½œã€‚\nç‚ºä»€éº¼é¸æ“‡ Vaultï¼Ÿ ç¾ä»Šçš„å¤§å¤šæ•¸ä¼æ¥­éƒ½æœ‰æ†‘è­‰æ•£å¸ƒåœ¨å…¶çµ„ç¹”ä¸­ã€‚å¯†ç¢¼ã€API é‡‘é‘°å’Œæ†‘è­‰å­˜å„²åœ¨æ˜æ–‡ä¸­ã€æ‡‰ç”¨æºä»£ç¢¼ã€é…ç½®æ–‡ä»¶å’Œå…¶ä»–ä½ç½®ã€‚ç”±æ–¼é€™äº›æ†‘è­‰å­˜åœ¨æ–¼å„è™•ï¼Œå› æ­¤å¯èƒ½å¾ˆé›£çœŸæ­£çŸ¥é“èª°æœ‰å­˜å–å’Œæˆæ¬Šæ¬Šé™ã€‚æ˜æ–‡ä¸­çš„æ†‘è­‰ä¹Ÿå¢åŠ äº†å…§éƒ¨å’Œå¤–éƒ¨æ”»æ“Šè€…é€²è¡Œæƒ¡æ„æ”»æ“Šçš„å¯èƒ½æ€§ã€‚\nè€ƒæ…®åˆ°é€™äº›æŒ‘æˆ°ï¼ŒVault è¢«è¨­è¨ˆå‡ºä¾†ã€‚Vault æ¡å–æ‰€æœ‰é€™äº›æ†‘è­‰ä¸¦é›†ä¸­ç®¡ç†ï¼Œé€™æ¨£ä»–å€‘å°±åªåœ¨ä¸€å€‹ä½ç½®å®šç¾©ï¼Œå¾è€Œæ¸›å°‘äº†æ†‘è­‰çš„ä¸å¿…è¦æš´éœ²ã€‚ä½† Vault æ›´é€²ä¸€æ­¥ï¼Œç¢ºä¿ç”¨æˆ¶ã€æ‡‰ç”¨ç¨‹åºå’Œç³»çµ±éƒ½è¢«èªè­‰ä¸¦æ˜ç¢ºæˆæ¬Šå­˜å–è³‡æºï¼ŒåŒæ™‚ä¹Ÿæä¾›ä¸€å€‹å¯©è¨ˆè·Ÿè¸ªï¼Œæ•æ‰ä¸¦ä¿ç•™å®¢æˆ¶ç«¯æ“ä½œçš„æ­·å²è¨˜éŒ„ã€‚\nVault çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ å®‰å…¨çš„ç§˜å¯†å­˜å„²ï¼šå¯ä»¥åœ¨ Vault ä¸­å­˜å„²ä»»æ„çš„é‡‘é‘°/å€¼ç§˜å¯†ã€‚Vault åœ¨å°‡é€™äº›ç§˜å¯†å¯«å…¥æŒä¹…æ€§å­˜å„²ä¹‹å‰æœƒå°å…¶é€²è¡ŒåŠ å¯†ï¼Œå› æ­¤ç²å–åŸå§‹å­˜å„²ä¸¦ä¸è¶³ä»¥å­˜å–ä½ çš„ç§˜å¯†ã€‚Vault å¯ä»¥å¯«å…¥ç£ç›¤ã€Consul ç­‰ã€‚\nå‹•æ…‹ç§˜å¯†ï¼šVault å¯ä»¥ç‚ºæŸäº›ç³»çµ±å³æ™‚ç”Ÿæˆç§˜å¯†ï¼Œä¾‹å¦‚ AWS æˆ– SQL æ•¸æ“šåº«ã€‚ä¾‹å¦‚ï¼Œç•¶æ‡‰ç”¨ç¨‹åºéœ€è¦å­˜å– S3 æ¡¶æ™‚ï¼Œå®ƒæœƒè¦æ±‚ Vault æä¾›æ†‘è­‰ï¼ŒVault å°‡å³æ™‚ç”Ÿæˆå…·æœ‰æœ‰æ•ˆæ¬Šé™çš„ AWS å¯†é‘°å°ã€‚åœ¨å‰µå»ºé€™äº›å‹•æ…‹ç§˜å¯†å¾Œï¼ŒVault ä¹Ÿæœƒåœ¨ç§ŸæœŸåˆ°æœŸå¾Œè‡ªå‹•æ’¤éŠ·å®ƒå€‘ã€‚\næ•¸æ“šåŠ å¯†ï¼šVault å¯ä»¥åœ¨ä¸å­˜å„²æ•¸æ“šçš„æƒ…æ³ä¸‹åŠ å¯†å’Œè§£å¯†æ•¸æ“šã€‚é€™å…è¨±å®‰å…¨åœ˜éšŠå®šç¾©åŠ å¯†åƒæ•¸ï¼Œä¸¦å…è¨±é–‹ç™¼äººå“¡å°‡åŠ å¯†æ•¸æ“šå­˜å„²åœ¨å¦‚ SQL æ•¸æ“šåº«ä¹‹é¡çš„åœ°æ–¹ï¼Œè€Œä¸å¿…è¨­è¨ˆä»–å€‘è‡ªå·±çš„åŠ å¯†æ–¹æ³•ã€‚\nç§Ÿè³ƒå’ŒçºŒæœŸï¼šVault ä¸­çš„æ‰€æœ‰ç§˜å¯†éƒ½æœ‰ä¸€å€‹èˆ‡ä¹‹ç›¸é—œçš„ç§ŸæœŸã€‚åœ¨ç§ŸæœŸçµæŸæ™‚ï¼ŒVault æœƒè‡ªå‹•æ’¤éŠ·è©²ç§˜å¯†ã€‚å®¢æˆ¶ç«¯å¯ä»¥é€šéå…§ç½®çš„çºŒæœŸ API ä¾†çºŒç§Ÿã€‚\næ’¤éŠ·ï¼šVault å…·æœ‰å…§ç½®çš„ç§˜å¯†æ’¤éŠ·æ”¯æ´ã€‚Vault ä¸åƒ…å¯ä»¥æ’¤éŠ·å–®ä¸€çš„ç§˜å¯†ï¼Œé‚„å¯ä»¥æ’¤éŠ·ç§˜å¯†æ¨¹ï¼Œä¾‹å¦‚ç”±ç‰¹å®šç”¨æˆ¶è®€å–çš„æ‰€æœ‰ç§˜å¯†ï¼Œæˆ–ç‰¹å®šé¡å‹çš„æ‰€æœ‰ç§˜å¯†ã€‚æ’¤éŠ·åœ¨é‡‘é‘°æ»¾å‹•ä»¥åŠåœ¨å…¥ä¾µæƒ…æ³ä¸‹é–å®šç³»çµ±æ™‚éƒ½å¾ˆæœ‰å¹«åŠ©ã€‚\nä»€éº¼æ˜¯ HCP Vaultï¼Ÿ HashiCorp Cloud Platform (HCP) Vault æ˜¯ Vault çš„è¨—ç®¡ç‰ˆæœ¬ï¼Œç”± HashiCorp é‹ç‡Ÿï¼Œä½¿çµ„ç¹”èƒ½å¤ å¿«é€Ÿå•Ÿå‹•ä¸¦é‹è¡Œã€‚HCP Vault ä½¿ç”¨èˆ‡è‡ªè¨—ç®¡çš„ Vault ç›¸åŒçš„äºŒé€²åˆ¶æ–‡ä»¶ï¼Œé€™æ„å‘³è‘—ä½ å°‡æ“æœ‰ä¸€è‡´çš„ç”¨æˆ¶é«”é©—ã€‚ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ Vault å®¢æˆ¶ç«¯èˆ‡ HCP Vault é€šä¿¡ï¼Œå°±åƒä½ ä½¿ç”¨è‡ªè¨—ç®¡çš„ Vault ä¸€æ¨£ã€‚è«‹åƒè€ƒ HCP Vault æ–‡æª”ä»¥ç²å¾—æ›´å¤šè³‡è¨Šã€‚\n","permalink":"https://chechia.net/posts/2023-09-12-vault-workshop-introduction/","summary":"\u003cp\u003eå¦‚æœä½ å¸Œæœ›è¿½è¹¤æœ€æ–°çš„è‰ç¨¿ï¼Œè«‹è¦‹\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2023/\"\u003eéµäººè³½2023\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬ workshop ä¹Ÿæ¥å—ç¶²å‹çš„è¨±é¡˜æ¸…å–®ï¼Œ\u003ca href=\"https://ithelp.ithome.com.tw/articles/10317378\"\u003eå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®å¯æ–¼ç¬¬ä¸€ç¯‡åº•ä¸‹ç•™è¨€\u003c/a\u003eï¼Œç­†è€…æœƒç›¡åŠ›å¯¦ç¾ï¼Œä½†ä¸åšä»»ä½•ä¿è­‰\u003c/p\u003e\n\u003ch1 id=\"day-01-å‰è¨€å¾é›¶é–‹å§‹çš„-hashicorp-vault-workshop\"\u003eDay 01 å‰è¨€ï¼šå¾é›¶é–‹å§‹çš„ Hashicorp Vault Workshop\u003c/h1\u003e\n\u003cp\u003eå¾é›¶é–‹å§‹ workshop ç³»åˆ—å·²ç¶“åšäº†å››å¹´ï¼Œå…§å®¹åŒ…å« k8s, terraform, aws ç­‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ·±æ·±è¦ºå¾—è¦å­¸ç¿’ä¸€å€‹å·¥å…·ï¼Œé‚„æ˜¯è¦å‹•æ‰‹åšã€‚\u003c/p\u003e\n\u003cp\u003eæ‰€ä»¥æœ‰äº† 30 å¤©æ‰‹æŠŠæ‰‹ workshop ç³»åˆ—æ–‡ï¼Œè®“æœ‰èˆˆè¶£æ¥è§¸çš„æœ‹å‹ï¼Œèƒ½ä»¥ç›¸å°ä½çš„é–€æª»å…¥é–€ã€‚\u003c/p\u003e\n\u003cp\u003eé—œæ–¼å…§å®¹\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç„¡åŸºç¤çš„æ‰‹æŠŠæ‰‹çš„åŸºç¤æ•™å­¸\u003c/li\u003e\n\u003cli\u003eå®Œæ•´çš„ç¯„ä¾‹ï¼Œæä¾›åŸå§‹ç¨‹å¼ç¢¼ï¼Œä¹Ÿæä¾› production çš„ç¶“é©—èˆ‡ç¯„ä¾‹\u003c/li\u003e\n\u003cli\u003eå®˜æ–¹æœ€æ–°æ–‡ä»¶ç¹ä¸­ç¿»è­¯ (chatGPT based)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå»ºè­°è®€è€…å‹™å¿…è·Ÿè‘—æ“ä½œï¼Œä¸è¦åªæ˜¯çœ‹é\u003c/p\u003e\n\u003cp\u003eå…¶ä»–æ–‡ç«  \u003ca href=\"https://chechia.net/\"\u003ehttps://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eéå»çš„ Workshop\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2022/\"\u003e2022 éµäººè³½: Terraform IaC Best Practice on AWS Cloud / åœ¨ aws å…¬æœ‰é›²ä¸Šæ‰¾ IaC æœ€ä½³å¯¦è¸ (å› æ•…é€€è³½)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://ithelp.ithome.com.tw/users/20120327/ironman/4057\"\u003e2021 éµäººè³½: Terraform Workshop - Infrastructure as Code for Public Cloud\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2020/\"\u003e2020 éµäººè³½: Kubernetes X DevOps X å¾é›¶é–‹å§‹å°å…¥å·¥å…· X éœ€æ±‚åˆ†æ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2019/\"\u003e2019 éµäººè³½: Kubernetes\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"é å®šå…§å®¹èˆ‡è¨±é¡˜æ¸…å–®\"\u003eé å®šå…§å®¹èˆ‡è¨±é¡˜æ¸…å–®\u003c/h1\u003e\n\u003cp\u003eæœ¬ workshop é è¨ˆæœ‰åº•ä¸‹å…§å®¹\u003c/p\u003e","title":"Vault Workshop 01: Introduction"},{"content":" æ´»å‹•æ—¥æœŸ: 2023-05-10T11:00:00Z æ´»å‹•é€£çµ è¯çµ¡æˆ‘Facebook Twitter æŠ•å½±ç‰‡ Info ç¾ä»£ç¶²è·¯æ‡‰ç”¨éœ€è¦è™•ç†è¨±å¤šç§å¯†é‡‘é‘°çš„ç®¡ç†ï¼Œä¾‹å¦‚ï¼šuser çš„å¯†ç¢¼ã€server çš„è³‡æ–™ã€database çš„è³‡æ–™ã€microservices å½¼æ­¤ authentication\u0026hellip;ã€‚åŠ ä¸Šé§­å®¢åœ˜é«”çŒ–ç—ï¼Œè¨±å¤šåœ‹å…§å¤–çŸ¥åä¼æ¥­ç´›ç´›é­é§­ï¼Œå°è‡´å…¬å¸èˆ‡ä½¿ç”¨è€…çš„æå¤±ã€‚ å¦‚ä½•ç³»çµ±åŒ–ä¸”è‡ªå‹•åŒ–ç®¡ç†å¤§é‡çš„ç§å¯†è³‡æ–™ï¼Œæˆç‚ºç³»çµ±æ•´é«”å®‰å…¨æ€§çš„é—œéµã€‚\nHashiCorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ï¼Œé™¤äº†ä¿éšœç³»çµ±å®‰å…¨æ€§ï¼Œæ¯”èµ·å¸‚é¢ä¸Šçš„å…¶ä»–ç®¡ç†å·¥å…·ï¼Œé‚„æœ‰è¨±å¤šç‰¹é»å¦‚ï¼š\nä¸ä¾è³´å¤–éƒ¨æœå‹™ï¼Œé©åˆè‡ªè¡Œæ¶è¨­åœ¨å…§éƒ¨å…¬æœ‰é›²/ç§æœ‰é›²/å‚³çµ± server/Kubernetes/VM æ”¯æ´è·¨ç’°å¢ƒçš„æ‡‰ç”¨ï¼Œå¯ä»¥ä¸²é€£æ··åˆé›²ä¸­çš„æ‡‰ç”¨ï¼Œä½œç‚ºç§é‘°èªè­‰çš„ä¸­å¿ƒ\nTarget group æœ¬æ¬¡æ´»å‹•å°‡ç°¡ä»‹ Hashicorp Vaultï¼Œä¸¦ä»¥ AWS Cloud èˆ‡æœ¬åœ° Kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ï¼Œé©åˆåˆæ¬¡æ¥è§¸ HashiCorp Vault èˆ‡å°‹æ‰¾ç§é‘°ç®¡ç†å¹³å°çš„åœ˜éšŠã€‚\nAuthor Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2023 DevOpsDay 2023 Ithome Kubernetes Summit 2022 COSCUP 2022 Ithome Cloud Summit 2021 Ithome Cloud Summit 2020 DevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2020 Cloud Native Taiwan å¹´æœ«èšæœƒ 2020 Ithome Cloud Summit 2019 Ithome Cloud Summit 2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit ","permalink":"https://chechia.net/posts/2023-05-10-hashicorp-vault-intro/","summary":"\u003cul\u003e\n\u003cli\u003eæ´»å‹•æ—¥æœŸ: 2023-05-10T11:00:00Z\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.accupass.com/event/2304180633007080095620\"\u003eæ´»å‹•é€£çµ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¯çµ¡æˆ‘Facebook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/chechiachang\"\u003eTwitter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.google.com/presentation/d/1iex9lm89OCIR8IAoD1RPe4vcW--bcKBmMHoixDybqP8/edit?usp=sharing\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"info\"\u003eInfo\u003c/h3\u003e\n\u003cp\u003eç¾ä»£ç¶²è·¯æ‡‰ç”¨éœ€è¦è™•ç†è¨±å¤šç§å¯†é‡‘é‘°çš„ç®¡ç†ï¼Œä¾‹å¦‚ï¼šuser çš„å¯†ç¢¼ã€server çš„è³‡æ–™ã€database çš„è³‡æ–™ã€microservices å½¼æ­¤ authentication\u0026hellip;ã€‚åŠ ä¸Šé§­å®¢åœ˜é«”çŒ–ç—ï¼Œè¨±å¤šåœ‹å…§å¤–çŸ¥åä¼æ¥­ç´›ç´›é­é§­ï¼Œå°è‡´å…¬å¸èˆ‡ä½¿ç”¨è€…çš„æå¤±ã€‚ å¦‚ä½•ç³»çµ±åŒ–ä¸”è‡ªå‹•åŒ–ç®¡ç†å¤§é‡çš„ç§å¯†è³‡æ–™ï¼Œæˆç‚ºç³»çµ±æ•´é«”å®‰å…¨æ€§çš„é—œéµã€‚\u003c/p\u003e\n\u003cp\u003eHashiCorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ï¼Œé™¤äº†ä¿éšœç³»çµ±å®‰å…¨æ€§ï¼Œæ¯”èµ·å¸‚é¢ä¸Šçš„å…¶ä»–ç®¡ç†å·¥å…·ï¼Œé‚„æœ‰è¨±å¤šç‰¹é»å¦‚ï¼š\u003c/p\u003e\n\u003cp\u003eä¸ä¾è³´å¤–éƒ¨æœå‹™ï¼Œé©åˆè‡ªè¡Œæ¶è¨­åœ¨å…§éƒ¨å…¬æœ‰é›²/ç§æœ‰é›²/å‚³çµ± server/Kubernetes/VM\næ”¯æ´è·¨ç’°å¢ƒçš„æ‡‰ç”¨ï¼Œå¯ä»¥ä¸²é€£æ··åˆé›²ä¸­çš„æ‡‰ç”¨ï¼Œä½œç‚ºç§é‘°èªè­‰çš„ä¸­å¿ƒ\u003c/p\u003e\n\u003ch3 id=\"target-group\"\u003eTarget group\u003c/h3\u003e\n\u003cp\u003eæœ¬æ¬¡æ´»å‹•å°‡ç°¡ä»‹ Hashicorp Vaultï¼Œä¸¦ä»¥ AWS Cloud èˆ‡æœ¬åœ° Kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ï¼Œé©åˆåˆæ¬¡æ¥è§¸ HashiCorp Vault èˆ‡å°‹æ‰¾ç§é‘°ç®¡ç†å¹³å°çš„åœ˜éšŠã€‚\u003c/p\u003e\n\u003ch3 id=\"author\"\u003eAuthor\u003c/h3\u003e\n\u003cp\u003eChe-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚\nMicrosoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\u003c/p\u003e\n\u003cp\u003eç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\u003c/p\u003e\n\u003cp\u003eChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup.\nMicrosoft Most Valuable Professional since 2020.\u003c/p\u003e","title":"HashiCorp Vault on AWS \u0026 K8s - é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å°"},{"content":"target group é‡‘èå®¢æˆ¶ vault 4/15 ä¸Šæ¶\naccupass 5/10 (Wed) 11:00-12:00\nwebbase link (online)\n10:30 ä¸Šç·šè¨­å‚™æ¸¬è©¦\n11:00 Ming é–‹å ´\n11:05 ä¸»è¬›\n12:00 Q\u0026amp;A (ç•™è¨€)\nç•¶å¤©éŒ„å½±æœƒä¸Šç·š\næ¼”è¬›å¤§ç¶± åŸºæœ¬ä»‹ç´¹ vault æ¶æ§‹ ä¼æ¥­éœ€æ±‚ self-host è¤‡é›œçš„ policy ç”¨ä¾‹ demo aws auth k8s auth policy ç•¶å¤©æä¾› github example Q\u0026amp;A (10mins) å…§å®¹ æ¼”è¬›ä¸»é¡Œï¼šHashicorp vault é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å°\nç¾ä»£ç¶²è·¯æ‡‰ç”¨éœ€è¦è™•ç†è¨±å¤šç§å¯†é‡‘æ›œçš„ç®¡ç†ï¼Œä¾‹å¦‚ï¼šuser çš„å¯†ç¢¼ï¼Œserver çš„è³‡æ–™ï¼Œdatabase çš„è³‡æ–™ï¼Œmicroservices å½¼æ­¤ authentication\u0026hellip;ã€‚åŠ ä¸Šé§­å®¢åœ˜é«”çŒ–ç—ï¼Œè¨±å¤šåœ‹å…§å¤–çŸ¥åä¼æ¥­ç´›ç´›é­é§­ï¼Œå°è‡´å…¬å¸èˆ‡ä½¿ç”¨è€…çš„æå¤±ã€‚ å¦‚ä½•ç³»çµ±åŒ–ä¸”è‡ªå‹•åŒ–ç®¡ç†å¤§é‡çš„ç§å¯†è³‡æ–™ï¼Œæˆç‚ºç³»çµ±æ•´é«”å®‰å…¨æ€§çš„é—œéµã€‚ Hashicorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ï¼Œé™¤äº†ä¿éšœç³»çµ±å®‰å…¨æ€§ï¼Œæ¯”èµ·å¸‚é¢ä¸Šçš„å…¶ä»–ç®¡ç†å·¥å…·ï¼Œæœ‰è¨±å¤šç‰¹é»\nä¸ä¾è³´å¤–éƒ¨æœå‹™ï¼Œé©åˆè‡ªè¡Œæ¶è¨­åœ¨å…§éƒ¨å…¬æœ‰é›²/ç§æœ‰é›²/å‚³çµ±server/Kubernetes/VM æ”¯æ´è·¨ç’°å¢ƒçš„æ‡‰ç”¨ï¼Œå¯ä»¥ä¸²é€£æ··åˆé›²ä¸­çš„æ‡‰ç”¨ï¼Œä½œç‚ºç§è¦èªè­‰çš„ä¸­å¿ƒ æœ¬æ¬¡æ¼”è¬›ç°¡ä»‹ Hashicorp Vaultï¼Œä»¥ aws cloud èˆ‡æœ¬åœ° kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ é©åˆåˆæ¬¡æ¥è§¸çš„ Hashicorp Vaultï¼Œèˆ‡å°‹æ‰¾ç§è¦ç®¡ç†å¹³å°çš„åœ˜éšŠ è¬›è€…ç°¡ä»‹\nChe-Chia Changï¼ŒSREï¼Œå–œæ­¡ç ”ç©¶å…¬æœ‰é›²/å®¹å™¨åŒ–æ‡‰ç”¨/Kubernetes Microsoft MVPï¼ŒIthome é›²ç«¯å¤§æœƒ/COSCUPè¬›å¸«ï¼Œå¸¸å‡ºç¾ CNTUG / DevOpsTW / Golang Taipei æŠ€è¡“ blog æ”¶éŒ„éå¾€æ¼”è¬›èˆ‡æ–‡ç«  https://chechia.net\nPresentation https://docs.google.com/presentation/d/1iex9lm89OCIR8IAoD1RPe4vcW--bcKBmMHoixDybqP8/edit#slide=id.g2403737215e_0_147\n","permalink":"https://chechia.net/posts/2023-05-10-hashicorp-comminity-presentation-vault-introduction/","summary":"\u003ch1 id=\"target-group\"\u003etarget group\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eé‡‘èå®¢æˆ¶\u003c/li\u003e\n\u003cli\u003evault\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e4/15 ä¸Šæ¶\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eaccupass\n5/10 (Wed) 11:00-12:00\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ewebbase link (online)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e10:30 ä¸Šç·šè¨­å‚™æ¸¬è©¦\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e11:00 Ming é–‹å ´\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e11:05 ä¸»è¬›\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e12:00 Q\u0026amp;A (ç•™è¨€)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eç•¶å¤©éŒ„å½±æœƒä¸Šç·š\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"æ¼”è¬›å¤§ç¶±\"\u003eæ¼”è¬›å¤§ç¶±\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eåŸºæœ¬ä»‹ç´¹ vault æ¶æ§‹\u003c/li\u003e\n\u003cli\u003eä¼æ¥­éœ€æ±‚\n\u003cul\u003e\n\u003cli\u003eself-host\u003c/li\u003e\n\u003cli\u003eè¤‡é›œçš„ policy\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eç”¨ä¾‹ demo\n\u003cul\u003e\n\u003cli\u003eaws auth\u003c/li\u003e\n\u003cli\u003ek8s auth\u003c/li\u003e\n\u003cli\u003epolicy\u003c/li\u003e\n\u003cli\u003eç•¶å¤©æä¾› github example\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eQ\u0026amp;A (10mins)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"å…§å®¹\"\u003eå…§å®¹\u003c/h1\u003e\n\u003cp\u003eæ¼”è¬›ä¸»é¡Œï¼šHashicorp vault é›²ç«¯åœ°ç«¯é€šåƒçš„ç§é‘°ç®¡ç†å¹³å°\u003c/p\u003e\n\u003cp\u003eç¾ä»£ç¶²è·¯æ‡‰ç”¨éœ€è¦è™•ç†è¨±å¤šç§å¯†é‡‘æ›œçš„ç®¡ç†ï¼Œä¾‹å¦‚ï¼šuser çš„å¯†ç¢¼ï¼Œserver çš„è³‡æ–™ï¼Œdatabase çš„è³‡æ–™ï¼Œmicroservices å½¼æ­¤ authentication\u0026hellip;ã€‚åŠ ä¸Šé§­å®¢åœ˜é«”çŒ–ç—ï¼Œè¨±å¤šåœ‹å…§å¤–çŸ¥åä¼æ¥­ç´›ç´›é­é§­ï¼Œå°è‡´å…¬å¸èˆ‡ä½¿ç”¨è€…çš„æå¤±ã€‚\nå¦‚ä½•ç³»çµ±åŒ–ä¸”è‡ªå‹•åŒ–ç®¡ç†å¤§é‡çš„ç§å¯†è³‡æ–™ï¼Œæˆç‚ºç³»çµ±æ•´é«”å®‰å…¨æ€§çš„é—œéµã€‚\nHashicorp Vault ç‚ºä¸€æ¬¾é–‹æºçš„ç§å¯†è³‡æ–™ç®¡ç†å¹³å°ï¼Œé™¤äº†ä¿éšœç³»çµ±å®‰å…¨æ€§ï¼Œæ¯”èµ·å¸‚é¢ä¸Šçš„å…¶ä»–ç®¡ç†å·¥å…·ï¼Œæœ‰è¨±å¤šç‰¹é»\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸ä¾è³´å¤–éƒ¨æœå‹™ï¼Œé©åˆè‡ªè¡Œæ¶è¨­åœ¨å…§éƒ¨å…¬æœ‰é›²/ç§æœ‰é›²/å‚³çµ±server/Kubernetes/VM\u003c/li\u003e\n\u003cli\u003eæ”¯æ´è·¨ç’°å¢ƒçš„æ‡‰ç”¨ï¼Œå¯ä»¥ä¸²é€£æ··åˆé›²ä¸­çš„æ‡‰ç”¨ï¼Œä½œç‚ºç§è¦èªè­‰çš„ä¸­å¿ƒ\næœ¬æ¬¡æ¼”è¬›ç°¡ä»‹ Hashicorp Vaultï¼Œä»¥ aws cloud èˆ‡æœ¬åœ° kubernetes ç‚ºä¾‹ï¼Œæä¾›å¹¾å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹\né©åˆåˆæ¬¡æ¥è§¸çš„ Hashicorp Vaultï¼Œèˆ‡å°‹æ‰¾ç§è¦ç®¡ç†å¹³å°çš„åœ˜éšŠ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè¬›è€…ç°¡ä»‹\u003c/p\u003e","title":"Hashicorp Comminity Presentation Vault Introduction"},{"content":"AWS cross account delegation ä¾èˆŠ WIPï¼Œä»Šå¤©å»¶çºŒæ˜¨å¤©å…§å®¹ï¼Œä½¿ç”¨ github action åš terraform module çš„ CI/CD\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nTerraform Github Action Jobs æˆ‘å€‘å¯ä»¥åœ¨ terraform repository ä¸­å¢åŠ  tool checks åˆ° CI/CD ä¸­ï¼ŒåŠ å¼· code çš„å“è³ªæ§ç®¡\nterragrunt-infrastructure-modules PR åœ¨æ­¤\né€™å€‹ PR åŒ…å«å¹¾å€‹ Github Action Workflow\nls .github/workflows checkov.yaml format.yaml plan.yaml security-scan.yaml validate.yaml format.yaml ä¸­åŸ·è¡Œ terraform fmt -recursiveï¼Œéœ€æ±‚èˆ‡ç›®çš„å·²åœ¨æ˜¨å¤©èªªæ˜ validate.yaml ä¸­åŸ·è¡Œ terraform validateï¼Œç”¨ä¾†é©—è­‰ module å…§çš„ terraform syntax æ˜¯å¦ç¬¦åˆèªæ³• checkov.yaml æ˜¯å¤šèªè¨€çš„ policy as code å·¥å…·ï¼Œåœ¨é€™é‚ŠåŸ·è¡Œæƒæ terraform code çš„å®‰å…¨æ€§èˆ‡ CVEs æª¢æŸ¥ security-scan.yaml ä¸­ä¹Ÿæ˜¯ Policy As Code ä½¿ç”¨ tfsec å·¥å…·æƒæ plan.yaml ä¸­åœ¨ pipeline åŸ·è¡Œè‡ªå‹•åŒ– terraform plan ç”±æ–¼ plan éœ€è¦å­˜å– state èˆ‡ provider APIï¼Œè¨­å®šä¸Šæœ‰è¨±å¤šæ¬Šé™è¨­å®šéœ€è¦é–‹å•Ÿï¼Œç›®å‰æ˜¯ä¸€å€‹ dummy workflow policy as code å…§å®¹å¯ä»¥å°‡ä¸€ç¯‡æ¼”è¬›ï¼Œæœ‰èˆˆè¶£è«‹è¦‹åº•ä¸‹æŠ•å½±ç‰‡: 2022 DevOpsDay: Policy As Code for Terraform: https://docs.google.com/presentation/d/1yawazO1B_sP5Yiav-XLGJXW3ZS2JTV0wGuJwhrUKQ3A\nå°æ–¼ Policy as Code æœ‰èˆˆè¶£çš„æœ‹å‹è«‹è¦‹ä»Šå¹´ DevOpsDay çš„æ¼”è¬› https://devopsdays.tw/session-page/1146\nTODO èˆ‡é€²åº¦ root ä¸­è¨­å®š IAM User aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role cross account iam role iam_cross_account_roles TODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key root account password policy aws cross account iam role delegation root account MFA policy Optional: Cloudtrail Optional: terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-25-14th-ithome-ironman-iac-aws-workshop-11-aws-github-action-ci-cd/","summary":"\u003cp\u003eAWS cross account delegation ä¾èˆŠ WIPï¼Œä»Šå¤©å»¶çºŒæ˜¨å¤©å…§å®¹ï¼Œä½¿ç”¨ github action åš terraform module çš„ CI/CD\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"terraform-github-action-jobs\"\u003eTerraform Github Action Jobs\u003c/h3\u003e\n\u003cp\u003eæˆ‘å€‘å¯ä»¥åœ¨ terraform repository ä¸­å¢åŠ  tool checks åˆ° CI/CD ä¸­ï¼ŒåŠ å¼· code çš„å“è³ªæ§ç®¡\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/chechiachang/terragrunt-infrastructure-modules/pull/6\"\u003eterragrunt-infrastructure-modules PR åœ¨æ­¤\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eé€™å€‹ PR åŒ…å«å¹¾å€‹ Github Action Workflow\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003els .github/workflows\n\ncheckov.yaml\nformat.yaml\nplan.yaml\nsecurity-scan.yaml\nvalidate.yaml\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eformat.yaml ä¸­åŸ·è¡Œ terraform fmt -recursiveï¼Œéœ€æ±‚èˆ‡ç›®çš„å·²åœ¨æ˜¨å¤©èªªæ˜\u003c/li\u003e\n\u003cli\u003evalidate.yaml ä¸­åŸ·è¡Œ terraform validateï¼Œç”¨ä¾†é©—è­‰ module å…§çš„ terraform syntax æ˜¯å¦ç¬¦åˆèªæ³•\u003c/li\u003e\n\u003cli\u003echeckov.yaml æ˜¯å¤šèªè¨€çš„ policy as code å·¥å…·ï¼Œåœ¨é€™é‚ŠåŸ·è¡Œæƒæ terraform code çš„å®‰å…¨æ€§èˆ‡ CVEs æª¢æŸ¥\u003c/li\u003e\n\u003cli\u003esecurity-scan.yaml ä¸­ä¹Ÿæ˜¯ Policy As Code ä½¿ç”¨ tfsec å·¥å…·æƒæ\u003c/li\u003e\n\u003cli\u003eplan.yaml ä¸­åœ¨ pipeline åŸ·è¡Œè‡ªå‹•åŒ– terraform plan\n\u003cul\u003e\n\u003cli\u003eç”±æ–¼ plan éœ€è¦å­˜å– state èˆ‡ provider APIï¼Œè¨­å®šä¸Šæœ‰è¨±å¤šæ¬Šé™è¨­å®šéœ€è¦é–‹å•Ÿï¼Œç›®å‰æ˜¯ä¸€å€‹ dummy workflow\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003epolicy as code å…§å®¹å¯ä»¥å°‡ä¸€ç¯‡æ¼”è¬›ï¼Œæœ‰èˆˆè¶£è«‹è¦‹åº•ä¸‹æŠ•å½±ç‰‡: \u003ca href=\"https://docs.google.com/presentation/d/1yawazO1B_sP5Yiav-XLGJXW3ZS2JTV0wGuJwhrUKQ3A\"\u003e2022 DevOpsDay: Policy As Code for Terraform: https://docs.google.com/presentation/d/1yawazO1B_sP5Yiav-XLGJXW3ZS2JTV0wGuJwhrUKQ3A\u003c/a\u003e\u003c/p\u003e","title":"Terraform Github Action CI/CD"},{"content":"TODO èˆ‡é€²åº¦ root ä¸­è¨­å®š IAM User aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nAWS cross account with iam roles è¦åšè·¨ AWS account çš„ IAM Roles access controlï¼Œæˆ‘å€‘å…ˆçœ‹å®˜æ–¹æ–‡ä»¶ç†è§£é€™å€‹åŠŸèƒ½\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html\nå›æ†¶æˆ‘å€‘åœ¨ day-04 æåˆ°çš„ multi-accounts æ¶æ§‹\naccount/security æœ‰æ‰€æœ‰ iam-users å…¶ä»– child-account ex. account/test ä¸­æœƒæœ‰ iam-roles éœ€æ±‚ï¼šsecurity/iam-user å¯ä»¥ä½¿ç”¨ test/iam-role çš„èº«ä»½ï¼Œå­˜å– test åº•ä¸‹çš„ resource ex.test/ec2 å¥½è™• admin ä¸éœ€è¦åˆ°æ¯ä¸€å€‹ child-account ä¸‹é¢å»é–‹æ¯ä¸€å€‹äººçš„ iam userï¼Œçµ±ä¸€åˆ° account/security ç®¡ç† user åªè¦ç™»å…¥ä¸€å€‹ security å¸³è™Ÿï¼Œå°±å¯ä»¥æ§åˆ¶å¤šå€‹ child-accountï¼Œä¸ç”¨ç™»å‡ºåˆç™»å…¥ä¸åŒ account åœ¨ aws official doc ä¸Šï¼Œä¹Ÿæ˜¯èˆ‰å¹¾å€‹ account ä½œç‚º cross account delegation çš„ç¯„ä¾‹ã€‚ç”±æ–¼æœ¬ workshop å·²ç¶“æœ‰ç¾å­˜çš„ child-accountï¼Œæˆ‘å€‘æœƒç›´æ¥ä½¿ç”¨ workshop çš„ accounts åšèªªæ˜ã€‚å®Œæˆé€™æ¬¡ iam role delegation çš„è¨­å®šå¾Œï¼Œæˆ‘å€‘æœƒå¾—åˆ°ä»¥ä¸‹æˆæœ\naccount/security ä¸‹é¢ IAM User å¯ä»¥ assume åˆ° account/test ä¸‹é¢çš„ç‰¹å®šçš„ IAM role account/test ä¸‹é¢æœ‰ä¸€å€‹ IAM role å¯ä»¥å­˜å– S3 Bucket å·¥ç¨‹å¸«å¯ä»¥ä½¿ç”¨ web console ç™»å…¥ security/userï¼Œç„¶å¾Œ assume role ç‚º test/roleï¼Œå–å¾—æŸ¥çœ‹ s3 bucket çš„æ¬Šé™ å·¥ç¨‹å¸«ä¹Ÿå¯ä½¿ç”¨ä»¥ security/user çš„èº«ä»½ï¼Œ call aws API å–å¾— test/role çš„æš«æ™‚çš„ credential æ­¥é©Ÿ æˆ‘å€‘æœƒå…ˆéä¸€æ¬¡ aws å®˜æ–¹æ–‡ä»¶ä¸Šæ‰€è¿°çš„æ­¥é©Ÿï¼Œè®“å¤§å®¶äº†è§£æ•´å€‹è¨­å®šæ­¥é©Ÿï¼Œå¼„æ¸…æ•´å€‹ delegation çš„æµç¨‹èˆ‡æ¦‚å¿µã€‚ä¹‹å¾Œæœƒè½‰è€Œä½¿ç”¨ Terraform è¨­å®šæ‰€æœ‰çš„å…ƒä»¶ã€‚\né¦–å…ˆè¦åœ¨ test (child-account) è¨­å®š iam role å°‡ account/security ä½œç‚º trusted entity è¨­å®š role çš„ policyï¼Œå¢åŠ å¯ä»¥å­˜å– s3 bucket çš„æ¬Šé™çµ¦ test/role èª¿æ•´ iam roleï¼Œå¯ä»¥è¨­å®šéœ€è¦çµ¦äºˆæ¬Šé™ï¼Œæˆ–æ˜¯ deny æŸäº›æ¬Šé™ æœ€å¾Œåšæ¸¬è©¦ï¼Œæ˜¯å¦å¯ä»¥å®Œæˆ switch role AWS çš„ç¯„ä¾‹ä½¿ç”¨ aws web console åšç¯„ä¾‹ï¼Œé€™å€‹ workshop å¾Œé¢æˆ‘å€‘æœƒä½¿ç”¨ terraform ä¾†å¯¦ä½œã€‚\nå¤–å‡ºå–æ ä¸Šé¢çš„ç¯„ä¾‹é‚„åœ¨ WIPï¼Œè«‹ç•¶ä½œè€…å¤–å‡ºå–æä¸€å¤©ï¼Œä»Šå¤©å…ˆè¬›å¦å¤–ä¸€å€‹å·¥å…·\nTerraform fmt \u0026amp; lint è¦æå‡ terraform code å“è³ªï¼Œæœ‰è¨±å¤šå·¥å…·éå¸¸å€¼å¾—åœ¨ CI/CD éç¨‹ä¸­ä½¿ç”¨\nä¾‹å¦‚ terraform å…§å»ºçš„ fmt èˆ‡ terragrunt å…§å»ºçš„ hclfmt\nåœ¨ module çš„ repository ä¸­æœƒéœ€è¦è·‘ terraform fmtï¼Œç¢ºä¿æ¯å€‹ module release å‡ºå»å‰éƒ½æœ‰ç¶“é fmt åœ¨ä½¿ç”¨ terragrunt çš„ root module æœƒéœ€è¦ hclfmt .hcl æª”æ¡ˆ cd terragrunt-infrastructure-modules terraform fmt -recursive cd terragrunt-infrastructure-live-example terragrunt hclfmt fmt å°æ–¼ç¨‹å¼ç¢¼çš„å“è³ªæ˜¯åŸºç¤ä½†ååˆ†é‡è¦çš„\næ²’æœ‰å›ºå®š format çš„ç¨‹å¼ç¢¼æœƒé€ æˆ git ä½¿ç”¨å‡ºç¾éå¤š diffï¼Œé€ æˆåœ˜éšŠå”ä½œçš„å›°é›£ format ä¹Ÿæœƒå½±éŸ¿è‡ªå‹•åŒ–ï¼Œä¾‹å¦‚ templating / variable expension fmt / lint æ˜¯æˆ‘å€‘ç¬¬ä¸€å€‹å¸¶å…¥ CI/CD çš„å·¥å…·\næ‰‹å‹• fmt fmt ä¸€ä¸‹\ncd terragrunt-infrastructure-modules terraform fmt -recursive cd terragrunt-infrastructure-live-example terragrunt hclfmt commit å¦‚ä¸‹\nterragrunt-infrastructure-modules commit terragrunt-infrastructure-live-example Git precommit hook æ—¢ç„¶æ˜¯ code å“è³ªçš„åŸºç¤ï¼Œæ‡‰è©²æ¯æ¬¡ commit ä¹‹å‰éƒ½è§¸ç™¼æª¢æŸ¥ï¼Œé€™å€‹éšæ®µé©åˆä½¿ç”¨ git pre-commit hook å‰åŸ·è¡Œ\nhttps://github.com/antonbabenko/pre-commit-terraform\nä»¥ terragrunt-infrastructure-live-example ç‚ºä¾‹\nPR åœ¨æ­¤ å•Ÿç”¨å‰éœ€è¦ install remote script åˆ°æœ¬åœ° git add å¾Œï¼Œä½¿ç”¨ run ä¾†æ‰‹å‹•è§¸ç™¼ pre-commit hook æœƒæ ¹æ“š commit hook åŸ·è¡Œè…³æœ¬ï¼Œä»¥é€™é‚Šçš„ç¯„ä¾‹æœƒåŸ·è¡Œ id: terraform-fmt id: terraform-validate id: tflint id: terraform_checkov id: terrascan id: terraform_tfsec id: infracost_breakdown é™¤äº† fmt æœ‰èªªæ˜éä»¥å¤–ï¼Œå…¶ä»–çš„ tool æˆ‘å€‘å¾ŒçºŒå†èªªæ˜ pre-commit install pre-commit install pre-commit installed at .git/hooks/pre-commit pre-commit run å¦‚æœé€šé run æ¸¬è©¦ï¼Œå°±å¯ä»¥é€²è¡Œ git commit commit ä¹‹å‰æœƒåœ¨è·‘ä¸€æ¬¡ scriptï¼Œæ‰€ä»¥ç¨±ä½œ pre-commit hook å¦‚æœé€šéæ¸¬è©¦è®ŠåŒ–è‡ªå‹• commit å¦‚æœæ²’æœ‰é€šéï¼Œå‰‡é€€å›é€™æ¬¡ commit å¦‚æœæƒ³è¦è·³é pre-commit checkï¼Œå¯ä»¥ä½¿ç”¨ git commit \u0026ndash;no-verify é€šéä¸Šè¿°æ­¥é©Ÿï¼Œä¾†ç¢ºä¿å·¥ç¨‹å¸«åœ¨æœ¬åœ°ç™¼å‡ºçš„ commit æœ‰ç¶“éåŸºç¤çš„é©—è­‰ï¼Œéå¸¸å€¼å¾—åœ˜éšŠå°å…¥\nGithub Action ","permalink":"https://chechia.net/posts/2022-09-21-14th-ithome-ironman-iac-aws-workshop-10-aws-cross-account-delegation-and-pre-commit-hook/","summary":"\u003ch3 id=\"todo-èˆ‡é€²åº¦\"\u003eTODO èˆ‡é€²åº¦\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e root ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e aws cross account iam role delegation\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e root account MFA policy\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e (Optional) Cloudtrail\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e (Optional) terraform aws config\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security è¨­å®š password policy\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security è¨­å®š MFA policy\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security ä¸­è¨­å®š IAM Policy \u0026amp; Group\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e dev ä¸­è¨­å®š IAM role\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e å…è¨± security assume dev IAM role\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003ch3 id=\"aws-cross-account-with-iam-roles\"\u003eAWS cross account with iam roles\u003c/h3\u003e\n\u003cp\u003eè¦åšè·¨ AWS account çš„ IAM Roles access controlï¼Œæˆ‘å€‘å…ˆçœ‹å®˜æ–¹æ–‡ä»¶ç†è§£é€™å€‹åŠŸèƒ½\u003c/p\u003e","title":"Aws Cross Account Delegation \u0026 pre-commit hook"},{"content":"ä½¿ç”¨ aws module çš„å¥½è™• ç‚ºä½•è¨±å¤šé–‹æºçš„ terraform module å…§éƒ¨ä½¿ç”¨çš„éƒ½æ˜¯å…¶ä»–çš„ moduleï¼Œè€Œä¸æ˜¯å¾ resource å–®ä½é–‹å§‹ï¼Ÿ\nTerraform å®˜æ–¹æ–‡ä»¶ï¼Œå¦‚ä½•å»ºç«‹ module\nå¦‚ä½•å»ºç«‹ä¸€å€‹ module\næ ¹æ“šæœ€å¸¸å‡ºç¾çš„ä½¿ç”¨æƒ…åŠ‡èˆ‡éœ€æ±‚ å°ˆæ³¨æ–¼æ¥­å‹™çš„éœ€æ±‚èˆ‡æŠ½è±¡ï¼Œé›ƒå¾ŒæŠŠå¯¦ä½œ(terraform resource) åœ¨ module ä¸­çµ„åˆå¯¦ä½œå‡ºä¾† module ä¹Ÿéœ€è¦è€ƒæ…® resource ä¹‹é–“çš„ architecture ä¹Ÿè¦è€ƒæ…®åˆ°è§€ç¦®æ˜¯å¦æ–¹ä¾¿ï¼Ÿä½¿ç”¨ä¸Šæ˜¯å¦å®‰å…¨ï¼Ÿ ex. æˆ‘å€‘éœ€æ±‚æ˜¯ç”¢ç”Ÿä¸€å€‹ IAM User\næ­£å¸¸çš„å¯¦ä½œå°±æ˜¯å¯«ä¸€å€‹ resource.aws_iam_user é”æˆéœ€æ±‚ æ›´å¥½çš„å¯¦ä½œæ˜¯ï¼šé™¤äº† iam_user å¤–ï¼ŒåŠ ä¸Š ä¸€å®šæœƒéœ€è¦é…æ¬Šé™ï¼Œæ‡‰æ­é… iam_group + iam_policy pgp encrypt è®“è³‡æ–™æ›´å®‰å…¨ password_policy å¢åŠ å¯†ç¢¼å®‰å…¨ \u0026hellip;ç­‰ æ¯”èµ·å–®ä¸€ä¸€å€‹ iam_user æ€è€ƒçš„æ›´å…¨é¢ï¼Œæ›´æ¥è¿‘æœ€ä½³å¯¦è¸ åœ¨é€™æ¬¡çš„ Best Practice è¿½å°‹ä¹‹æ—…ä¸­ï¼Œæˆ‘å€‘æœƒå¸¶å¤§å®¶å»çœ‹å…¶ä»–åœ˜éšŠæ‰€å¯«å‡ºçš„ terraform module\nç›®å‰å·²ç¶“çœ‹äº† aws çš„ terraform module gruntwork çš„ terraform module design (æˆ‘å€‘æ²’çœ‹åˆ° private moduleï¼Œåªæ˜¯è·Ÿéš¨æ–‡ä»¶è‡ªå·±åˆ») é€™äº›æœ‰å¤šå¹´ä¼æ¥­è§£æ±ºæ–¹æ¡ˆç¶“é©—çš„åœ˜éšŠï¼Œå¯«å‡ºä¾†çš„ terraform module éƒ½æœƒè€ƒé‡è¨±å¤š security æ–¹é¢çš„å•é¡Œ é€™ä¹Ÿæ˜¯æˆ‘å€‘å‰åç¯‡éƒ½åœ¨å°ˆæ³¨çš„æ–¹å‘ ä¸€èˆ¬ä¾†èªªï¼Œä¸€å€‹å¥½ module æœƒå¸¶ä¾†å¾ˆå¤šå¥½è™•\nç²¾ç°¡ .tf codeï¼Œé€é terraform function èˆ‡åˆ¤æ–·å¼ä¾†ç”¢ç”Ÿ resource æ•´åˆä¸åŒ resource ä½¿ç”¨æ™‚è¦è¼¸å…¥çš„ input å¯ä»¥å¼•å°ä½¿ç”¨è€…çš„ architecture è¨­è¨ˆ èƒ½ç¬¦åˆéœ€æ±‚ï¼Œåƒæ•¸æ–¹ä¾¿ä½¿ç”¨ï¼Œå…§å®¹é‚è¼¯æ¸…æ¥šçš„ module å°±æ˜¯å¥½ module\nç„¶è€Œè¦å¯«å¥½ä¸€å€‹ module éœ€è¦å¾ˆå¤šç¶“é©—ï¼Œä¸åƒ…è¦å° aws å…ƒä»¶ï¼Œæ¶æ§‹éƒ½å¾ˆç†Ÿæ‚‰ï¼Œé‚„è¦è€ƒé‡ç®¡ç†èˆ‡å®‰å…¨ã€‚æˆ‘å€‘æœ‰æ©Ÿæœƒå†ä¾†åˆ†äº«ã€‚\nç‚ºä»€éº¼è¦èŠ±é€™éº¼å¤šæ™‚é–“è¬› account / iam / security çš„åŸºç¤è¨­å®šï¼Ÿ å› ç‚ºäººå®¶å¯«å‡ºä¾†çš„å°±æ˜¯é€™éº¼çš„å®‰å…¨ï¼Œé–‹é ­ç›´æ¥ç«‹æ–¼ä¸è¢«é§­ä¹‹åœ°\næ˜¨å¤©ä½¿ç”¨ reset root IAM user çš„å¯†ç¢¼ï¼Œä¸¦ä½¿ç”¨ pgp key åŠ å¯†ä¿è­·ï¼Œä»Šå¤©è¦é€²ä¸€æ­¥å¼·åŒ– IAM çš„å®‰å…¨æ€§ï¼ŒåŒ…æ‹¬\nå¼·åŒ– password policy å¢åŠ è·¨å¸³è™Ÿ iam role çš„ assume permission å¢åŠ  MFA æœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key root account password policy aws cross account iam role delegation root account MFA policy iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\npassword policy å¯†ç¢¼å¼·åº¦çš„é‡è¦æ€§ä¸éœ€è¦å†å¼·èª¿ï¼Œå¼·è¿« user ä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ä¸¦ä¸”å®šæœŸæ›´æ–°ï¼Œæ‰èƒ½å°‡åœ°å®‰å…¨é¢¨éšª æƒ³è¦é€é web console ä¿®æ”¹ password policy çš„æœ‹å‹å¯ä»¥çœ‹aws doc: setting account password policyã€‚æˆ‘å€‘é€™é‚Šæœƒä½¿ç”¨ terraform é…ç½®\nä¿®æ”¹ terragrunt-infrastructure-modules\næ³¨æ„ï¼šæ˜¨å¤©åœ¨ module.iam_user è¨­å®šçš„æ˜¯ login profile çš„ passwordï¼Œæ˜¯ç®¡ç†å“¡é…çµ¦ user çš„ç¬¬ä¸€æŠŠ passwordï¼Œä¸¦ä¸”ç™»å…¥å¾Œå¿…é ˆæ›´æ›å¯†ç¢¼ ä»Šå¤©è¦è¨­ç½®çš„æ˜¯ä¹‹å¾Œçš„é‡è¨­å¯†ç¢¼éƒ½è¦éµå¾ªçš„è¦ç¯„ å¦‚æœæƒ³è¦å¼·åŒ–å¯†ç¢¼ç®¡ç†\næ›´é•·çš„å¯†ç¢¼ æ›´å¤šé™åˆ¶ å®šæœŸæ›´æ–° é¦–å…ˆå…ˆæ›´æ”¹ terraform moduleï¼Œé–‹å•Ÿ password policy\nå¢åŠ  resource.aws_iam_account_password_policy å¢åŠ  input variableï¼Œå°‡ variable å¾€å¾ä¸Šå±¤ input variable æ¥é€²ä¾†ï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨æœ€ä¸Šå±¤èª¿æ•´ å¯ä»¥è¨­å®šå¯†ç¢¼å£½å‘½ï¼Œdefault 90 å¤© å¯ä»¥è¨­å®šæœ€å°å¯†ç¢¼é•·åº¦ï¼Œdefault 32 å­—å…ƒ å…¶ä»– policy åƒæ•¸éƒ½å¯«æ­»å›ºå®š éœ€è¦æ•¸å­—ï¼Œå¤§å°å¯«è‹±æ–‡ å…è¨±ä½¿ç”¨è€…åœ¨å¯†ç¢¼éæœŸå‰é‡è¨­å¯†ç¢¼ å¯†ç¢¼éæœŸå°±é–ä½å¸³è™Ÿä¸çµ¦ç™»å…¥ï¼Œè¦è«‹ admin ä¾† reset # aws_iam_account_password_policy.tf resource \u0026quot;aws_iam_account_password_policy\u0026quot; \u0026quot;strict\u0026quot; { allow_users_to_change_password = true minimum_password_length = var.minimum_password_length hard_expiry = true max_password_age = var.max_password_age require_lowercase_characters = true require_numbers = true require_uppercase_characters = true require_symbols = true password_reuse_prevention = 0 } # variables.tf variable \u0026quot;minimum_password_length\u0026quot; { type = number description = \u0026quot;The number of days that an user password is valid.\u0026quot; default = 32 } variable \u0026quot;max_password_age\u0026quot; { type = number description = \u0026quot;Minimum length to require for user passwords.\u0026quot; default = 90 } é€²è¡Œ terragrunt planï¼Œæ²’å•é¡Œçš„è©±å°±å¯ä»¥ç›´æ¥ apply\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # aws_iam_account_password_policy.strict will be created + resource \u0026quot;aws_iam_account_password_policy\u0026quot; \u0026quot;strict\u0026quot; { + allow_users_to_change_password = true + expire_passwords = (known after apply) + hard_expiry = true + id = (known after apply) + max_password_age = 90 + minimum_password_length = 32 + password_reuse_prevention = 0 + require_lowercase_characters = true + require_numbers = true + require_symbols = true + require_uppercase_characters = true } Plan: 1 to add, 0 to change, 0 to destroy. aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt apply æ³¨æ„æ›´æ”¹å¯†ç¢¼çš„å‰¯ä½œç”¨\nç”±æ–¼æ›´æ”¹ password policy æ˜¯æ•´å€‹ account é€šç”¨çš„ï¼Œæ‰€ä»¥ä¹Ÿæœƒå½±éŸ¿åˆ° administrator çš„ password é›–ç„¶å½±éŸ¿ passwordï¼Œä½†ä¸å½±éŸ¿ access keyï¼Œæ‰€ä»¥ terraform å¯ä»¥æ­£å¸¸å·¥ä½œ Apply passsword policy å¾Œï¼Œæˆ‘å€‘ä½¿ç”¨åŸå…ˆçš„å¯†ç¢¼èµ° aws web console ç™»å…¥çœ‹çœ‹\nå¯ä»¥ä½¿ç”¨ç¾æœ‰å¯†ç¢¼ç™»å…¥ å˜—è©¦å¾å³ä¸Šè§’ User -\u0026gt; security credentials -\u0026gt; change passwordï¼Œå¯ä»¥ç™¼ç¾æ–°çš„ password policy å·²ç¶“æ›´æ–°äº† æˆ‘å€‘ä¾¿æ‰‹å‹•æ›´æ”¹å¯†ç¢¼ï¼Œä»¥ç¬¦åˆæ–°çš„ password policy æ›´æ”¹å¯†ç¢¼å®Œæˆè¨˜å¾—å­˜åœ¨å¯†ç¢¼å„²å­˜å™¨ä¸­ å€‹äººç¿’æ…£è€•è²·å¯†ç¢¼å®Œæˆå¾Œï¼Œéƒ½é‡æ–°ç™»å…¥ï¼Œå†ç™»å…¥ä¸€æ¬¡ï¼Œç¢ºå®šå¯†ç¢¼æ­£ç¢ºï¼Œæ¬Šé™ä¹Ÿæ²’å•é¡Œ MFA for me æ¥è‘—æˆ‘å€‘å¯ä»¥ç‚ºè‡ªå·±çš„ IAM User å•Ÿç”¨ MFA è£ç½®\nåœ¨å³ä¸Šè§’ User -\u0026gt; security credentials -\u0026gt; MFA\né»é¸ Assign MFA Device é¸æ“‡ virtual MFA Deviceï¼Œæˆ‘å€‘é€™é‚Šç¤ºç¯„ä½¿ç”¨ google authenticator app ç•«é¢ä¸Šå‡ºç¾ MFA key çš„ QRcodeï¼Œé€™å€‹ QRcode == keyï¼Œä¸èƒ½æ´©æ¼ï¼Œé›¢é–‹é€™å€‹ç•«é¢å°±ä¸æœƒå†å‡ºç¾äº† ä½¿ç”¨ google authenticatorï¼Œæ–°å¢ä¸€çµ„ accountï¼Œç„¶å¾Œæƒæ QRCode åº•ä¸‹å¡«å…¥æ–° account ç”¢ç”Ÿçš„ 6 ä½æ•¸å­— token ç­‰å¾… 60 ç§’ åº•ä¸‹å¡«å…¥ç¬¬äºŒçµ„æ–° account ç”¢ç”Ÿçš„ 6 ä½æ•¸å­— tokenï¼Œç¢ºå®šçœŸçš„èƒ½å¤ å–å¾—æ­£ç¢ºçš„ token ä¹‹å¾Œæ¯æ¬¡ç™»å…¥éƒ½éœ€è¦è¼¸å…¥ MFA NOTE: é€™è£¡æ˜¯ IAM User login æ™‚éœ€è¦è¼¸å…¥ MFAï¼Œæˆ‘å€‘ä¹‹å¾Œæœƒè¨­å®š child account ä¸‹ iam-role assume æ™‚éƒ½éœ€è¦è¼¸å…¥ MFA\næ˜å¤©æœƒå‰åç¯‡çš„é‡é»ä¹‹ä¸€ï¼šcross account çš„ iam role é…ç½®\nTODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key root account password policy aws cross account iam role delegation root account MFA policy (Optional) Cloudtrail (Optional) terraform aws config security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-20-14th-ithome-ironman-iac-aws-workshop-09-terraform-module-and-password-security/","summary":"\u003ch3 id=\"ä½¿ç”¨-aws-module-çš„å¥½è™•\"\u003eä½¿ç”¨ aws module çš„å¥½è™•\u003c/h3\u003e\n\u003cp\u003eç‚ºä½•è¨±å¤šé–‹æºçš„ terraform module å…§éƒ¨ä½¿ç”¨çš„éƒ½æ˜¯å…¶ä»–çš„ moduleï¼Œè€Œä¸æ˜¯å¾ resource å–®ä½é–‹å§‹ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/language/modules/develop\"\u003eTerraform å®˜æ–¹æ–‡ä»¶ï¼Œå¦‚ä½•å»ºç«‹ module\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚ä½•å»ºç«‹ä¸€å€‹ module\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ ¹æ“šæœ€å¸¸å‡ºç¾çš„ä½¿ç”¨æƒ…åŠ‡èˆ‡éœ€æ±‚\u003c/li\u003e\n\u003cli\u003eå°ˆæ³¨æ–¼æ¥­å‹™çš„éœ€æ±‚èˆ‡æŠ½è±¡ï¼Œé›ƒå¾ŒæŠŠå¯¦ä½œ(terraform resource) åœ¨ module ä¸­çµ„åˆå¯¦ä½œå‡ºä¾†\u003c/li\u003e\n\u003cli\u003emodule ä¹Ÿéœ€è¦è€ƒæ…® resource ä¹‹é–“çš„ architecture\u003c/li\u003e\n\u003cli\u003eä¹Ÿè¦è€ƒæ…®åˆ°è§€ç¦®æ˜¯å¦æ–¹ä¾¿ï¼Ÿä½¿ç”¨ä¸Šæ˜¯å¦å®‰å…¨ï¼Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eex. æˆ‘å€‘éœ€æ±‚æ˜¯ç”¢ç”Ÿä¸€å€‹ IAM User\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ­£å¸¸çš„å¯¦ä½œå°±æ˜¯å¯«ä¸€å€‹ \u003ccode\u003eresource.aws_iam_user\u003c/code\u003e é”æˆéœ€æ±‚\u003c/li\u003e\n\u003cli\u003eæ›´å¥½çš„å¯¦ä½œæ˜¯ï¼šé™¤äº† \u003ccode\u003eiam_user\u003c/code\u003e å¤–ï¼ŒåŠ ä¸Š\n\u003cul\u003e\n\u003cli\u003eä¸€å®šæœƒéœ€è¦é…æ¬Šé™ï¼Œæ‡‰æ­é… \u003ccode\u003eiam_group\u003c/code\u003e + \u003ccode\u003eiam_policy\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003epgp encrypt è®“è³‡æ–™æ›´å®‰å…¨\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epassword_policy\u003c/code\u003e å¢åŠ å¯†ç¢¼å®‰å…¨\u003c/li\u003e\n\u003cli\u003e\u0026hellip;ç­‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eæ¯”èµ·å–®ä¸€ä¸€å€‹ \u003ccode\u003eiam_user\u003c/code\u003e æ€è€ƒçš„æ›´å…¨é¢ï¼Œæ›´æ¥è¿‘æœ€ä½³å¯¦è¸\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eåœ¨é€™æ¬¡çš„ Best Practice è¿½å°‹ä¹‹æ—…ä¸­ï¼Œæˆ‘å€‘æœƒå¸¶å¤§å®¶å»çœ‹å…¶ä»–åœ˜éšŠæ‰€å¯«å‡ºçš„ terraform module\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç›®å‰å·²ç¶“çœ‹äº†\n\u003cul\u003e\n\u003cli\u003eaws çš„ terraform module\u003c/li\u003e\n\u003cli\u003egruntwork çš„ terraform module design (æˆ‘å€‘æ²’çœ‹åˆ° private moduleï¼Œåªæ˜¯è·Ÿéš¨æ–‡ä»¶è‡ªå·±åˆ»)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eé€™äº›æœ‰å¤šå¹´ä¼æ¥­è§£æ±ºæ–¹æ¡ˆç¶“é©—çš„åœ˜éšŠï¼Œå¯«å‡ºä¾†çš„ terraform module éƒ½æœƒè€ƒé‡è¨±å¤š security æ–¹é¢çš„å•é¡Œ\u003c/li\u003e\n\u003cli\u003eé€™ä¹Ÿæ˜¯æˆ‘å€‘å‰åç¯‡éƒ½åœ¨å°ˆæ³¨çš„æ–¹å‘\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸€èˆ¬ä¾†èªªï¼Œä¸€å€‹å¥½ module æœƒå¸¶ä¾†å¾ˆå¤šå¥½è™•\u003c/p\u003e","title":"Modules and password security"},{"content":"æ˜¨å¤©è™•ç†å®Œ Accounting çš„ reset passwordï¼Œä»Šå¤©è¦ä¾† reset root account Administrator çš„æ¬Šé™\næœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nReset IAM root user Administrator Password ä¾ç…§ä¸Šé¢çš„æ­¥é©Ÿï¼Œæˆ‘å€‘ç¢ºå®šå¯ä»¥æ­£å¸¸ç™»å…¥ï¼Œæ–¼æ˜¯å¯ä»¥ä¾†å¯ä»¥æ–°å»º Administrator çš„ login profile\nç”±æ–¼ Administrator æœƒéœ€è¦ access keyï¼Œæ‰€ä»¥æˆ‘å€‘ä¹ŸæŠŠä»–è¨­æˆ true # terragrunt.hcl users = { Administrator = { groups = [\u0026quot;full-access\u0026quot;] pgp_key = \u0026quot;keybase:chechiachang\u0026quot; create_login_profile = true create_access_keys = true }, Accounting = { groups = [\u0026quot;billing\u0026quot;] pgp_key = \u0026quot;keybase:chechiachang\u0026quot; create_login_profile = true create_access_keys = false # accounting always use web console, won't use access key } } è¨˜å¾—æ›´æ”¹ module/output.tfï¼Œå¢åŠ  secret key çš„ outputï¼Œè€Œä¸è¦åªç•™åœ¨ terraform state è£¡é¢\n# output.tf output \u0026quot;keybase_secret_key_decrypt_command\u0026quot; { description = \u0026quot;Decrypt access secret key command\u0026quot; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_secret_key_decrypt_command } } output \u0026quot;keybase_secret_key_pgp_message\u0026quot; { description = \u0026quot;Encrypted access secret key\u0026quot; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_secret_key_pgp_message } } è©¦è‘— plan ä¸€ä¸‹ï¼Œé æœŸ\nAdministrator æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„ login profile Administrator æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„ access key aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0] will be created + resource \u0026quot;aws_iam_access_key\u0026quot; \u0026quot;this\u0026quot; { + create_date = (known after apply) + encrypted_secret = (known after apply) + encrypted_ses_smtp_password_v4 = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + pgp_key = \u0026quot;keybase:chechiachang\u0026quot; + secret = (sensitive value) + ses_smtp_password_v4 = (sensitive value) + status = \u0026quot;Active\u0026quot; + user = \u0026quot;Administrator\u0026quot; } # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user_login_profile.this[0] will be created + resource \u0026quot;aws_iam_user_login_profile\u0026quot; \u0026quot;this\u0026quot; { + encrypted_password = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 + password_reset_required = false + pgp_key = \u0026quot;keybase:chechiachang\u0026quot; + user = \u0026quot;Administrator\u0026quot; } Plan: 2 to add, 0 to change, 0 to destroy. Changes to Outputs: + iam_access_key_id = { + Accounting = \u0026quot;\u0026quot; + Administrator = null -\u0026gt; (known after apply) } ~ keybase_password_decrypt_command = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } ~ keybase_password_pgp_message = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } + keybase_secret_key_decrypt_command = { + Accounting = null + Administrator = (known after apply) } + keybase_secret_key_pgp_message = { + Accounting = null + Administrator = (known after apply) } ç¬¦åˆé æœŸ!! å¯å–œå¯è³€\nä½†æ˜¯æˆ‘å€‘å·²ç¶“æœ‰ access key åœ¨ä½¿ç”¨äº†ï¼Œæˆ‘åˆä¸æƒ³è¦èµ° day 3 aws-vault add key çš„æ­¥é©Ÿæ›ä¸€çµ„æ–°çš„ï¼Œé€™æ™‚è©²æ€è¾¦\næ²’éŒ¯ï¼Œæˆ‘å€‘å¯ä»¥åƒ Day3 ä¸€æ¨£ï¼Œä½¿ç”¨ import åŒ¯å…¥å·²ç¶“å­˜åœ¨çš„ resource åˆ° address è£¡é¢\ngoogle \u0026ldquo;terraform aws iam user access key\u0026rdquo;ï¼Œæ‰¾åˆ° aws iam user access key çš„èªªæ˜é é¢ address æ˜¯ module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0] access key ID å¯ä»¥åœ¨å¯†ç¢¼ç®¡ç†å™¨æŸ¥çœ‹ æˆ–æ˜¯åœ¨ aws web console -\u0026gt; IAM -\u0026gt; User -\u0026gt; Administrator -\u0026gt; Security Credential -\u0026gt; Access Keys æŸ¥åˆ° aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import 'module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0]' AKIA1234567890 module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0]: Importing from ID \u0026quot;AKIA2I2H7ERWKI4RIF4Z\u0026quot;... module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0]: Import prepared! Prepared aws_iam_access_key for import module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0]: Refreshing state... [id=AKIA2I2H7ERWKI4RIF4Z] Import successful! The resources that were imported are shown above. These resources are now in your Terraform state and will henceforth be managed by Terraform. Releasing state lock. This may take a few moments... é †ä¾¿ login profile ä¹Ÿ import è¿‘ä¾†\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import 'module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user_login_profile.this[0]' Administrator å†æ¬¡ plan å°±ä¸éœ€è¦æ–°å»ºä¸€æŠŠ access key äº†\u0026hellip;å§ï¼Ÿï¼\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create -/+ destroy and then create replacement Terraform will perform the following actions: # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_access_key.this[0] must be replaced -/+ resource \u0026quot;aws_iam_access_key\u0026quot; \u0026quot;this\u0026quot; { ~ create_date = \u0026quot;2022-09-16T13:05:35Z\u0026quot; -\u0026gt; (known after apply) + encrypted_secret = (known after apply) + encrypted_ses_smtp_password_v4 = (known after apply) ~ id = \u0026quot;AKIA2I2H7ERWKI4RIF4Z\u0026quot; -\u0026gt; (known after apply) + key_fingerprint = (known after apply) + pgp_key = \u0026quot;keybase:chechiachang\u0026quot; # forces replacement + secret = (sensitive value) + ses_smtp_password_v4 = (sensitive value) # (2 unchanged attributes hidden) } # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user_login_profile.this[0] must be replaced -/+ resource \u0026quot;aws_iam_user_login_profile\u0026quot; \u0026quot;this\u0026quot; { + encrypted_password = (known after apply) ~ id = \u0026quot;Administrator\u0026quot; -\u0026gt; (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 # forces replacement + pgp_key = \u0026quot;keybase:chechiachang\u0026quot; # forces replacement # (2 unchanged attributes hidden) } Plan: 2 to add, 0 to change, 2 to destroy. Changes to Outputs: + iam_access_key_id = { + Accounting = \u0026quot;\u0026quot; + Administrator = \u0026quot;AKIA2I2H7ERWARJJWIVK\u0026quot; } ~ keybase_password_decrypt_command = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } ~ keybase_password_pgp_message = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } ~ keybase_secret_key_decrypt_command = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } ~ keybase_secret_key_pgp_message = { ~ Administrator = null -\u0026gt; (known after apply) # (1 unchanged element hidden) } èª’çµæœä¸ç¬¦åˆé æœŸï¼Œ\naws_iam_access_key.this éœ€è¦é‡å»º åŸå› æ˜¯æˆ‘å€‘æ›´æ”¹äº† pgp_key = \u0026quot;keybase:chechiachang\u0026quot; é€ æˆ forces replacement å› ç‚º æƒ³ä¸€æƒ³ä¹Ÿå¾ˆåˆç† ç¬¬ä¸€æ¬¡å‰µå»º access key çš„æ™‚å€™ï¼Œkeybase æ˜¯äº‚å¯«çš„ï¼Œé€™æ™‚ç”¨ module çš„ code å»è·‘ï¼Œç”¢ç”Ÿç„¡åŠ å¯†çš„ access key æ”¾åœ¨ state ä¸­ é€™æ¬¡ import å¾Œï¼Œmodule ä¸­çš„ .tf code å·²ç¶“æ”¹éï¼Œä¸å†å­˜ç„¡åŠ å¯†çš„ access keyï¼Œè€Œæ˜¯åŠ å¯†å¾Œå„²å­˜ GPG Encrypted Message é€™å€‹æ”¹è®Šè®“ provider è¦ºå¾—æ²’æœ‰è¾¦æ³•ç¬¦åˆï¼Œåªå¥½åˆªæ‰é‡å»º .aws_iam_user_login_profile.this éœ€è¦é‡å»ºï¼ŒåŸå› ä¹Ÿæ˜¯ä¸€æ¨£ï¼Œå› ç‚ºæˆ‘å€‘æ”¹äº† .tf code é‚è¼¯ï¼Œé€ æˆ provider å‹¢å¿…è¦é‡å»º login profile åŸ·è¡Œ terraform apply\nNOTE: æ³¨æ„æœ‰ destroy çš„ terraform plan éƒ½è¦ç‰¹åˆ¥å°å¿ƒ reviewï¼Œå› ç‚ºå¾ˆå¤š aws API delete ç™¼å‡ºå»å°±æ˜¯ç„¡æ³•å¾©åŸäº†\nä¾‹å¦‚ access key èˆ‡ password åˆªæ‰å¾Œï¼Œæ˜¯ç„¡æ³• recover çš„ æœ‰äº› API request æœƒæœ‰å‰¯ä½œç”¨ reset password å¾Œï¼Œaws web console æœƒè¢«ç™»å‡º access key æ›æ‰ terraform å°±ä¸èƒ½ç”¨ï¼Œæœ‰å¯èƒ½å°è‡´ terraform é€²è¡Œåˆ°ä¸€åŠè¢« permission denied (é€™å€‹ apply ä¸æœƒï¼Œåªæ˜¯æé†’å¤§å®¶è¦æ³¨æ„) æœ‰ destroy çš„éƒ¨åˆ†éƒ½è¦å°å¿ƒ reviewï¼Œçœ‹ä¸æ‡‚å°±æ‰¾ peering review æœ‰ destroy çš„éƒ¨åˆ†éƒ½è¦å°å¿ƒ reviewï¼Œçœ‹ä¸æ‡‚å°±æ‰¾ peering review æœ‰ destroy çš„éƒ¨åˆ†éƒ½è¦å°å¿ƒ reviewï¼Œçœ‹ä¸æ‡‚å°±æ‰¾ peering review\nå¾ˆé‡è¦æ‰€ä»¥èªªä¸‰æ¬¡\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt apply Apply complete! Resources: 2 added, 0 changed, 2 destroyed. Outputs: keybase_password_decrypt_command = { \u0026quot;Accounting\u0026quot; = \u0026lt;\u0026lt;-EOT echo \u0026quot;wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A==\u0026quot; | base64 --decode | keybase pgp decrypt EOT \u0026quot;Administrator\u0026quot; = \u0026lt;\u0026lt;-EOT echo \u0026quot;wcFMA4U4ylYlNYTfAQ/+JcRNkO9SxMm9U196p2WuuXdSWo9ooktKJMp3q4Xf5xMG5z/ccphl5+fVDmkp2Pr76UJ9NmiBw8rzScFUEU4U+xZepNojSdN/rmZPWB6PKCdJMyItw6HOnn7OSa0i1arr0PHaC0bpVs4Bc+9Oqtw1SuU8uvwBpCeM+h33qOROnvKnGgvOHV2Zk1XcgT+sg7xMTv8q77KePoNLTK3joQL7fXdPWUGWCp8srWpxzJ8LD4aNMmsrjA/s/7sNbAAdhffRwwA6diuZfeYscZ6MlURUtrSx3iAuNV33kmhuyYimlmXstbfs/nIJVI5OfcVexPKzHK5O9DikXApAzbf/YACz0OebOcxnzh6+rQw9+XWwRtARcK3tViMhxqnEu4PHROmj1sNmLZLJqCniwN91J2iry7BAx2Zoyvvw7vd7Sw9LddaM+j2XHhSf21250sNMn/9R6beUlkWQgPci8mU51rnqBffbOJnvVh7QCTLssoMTgKRrgxb+oZbSsKLLQO/621ZcTY9rzC74w2kZWJTS7nx5G/0KQkwXP4NGRSTXYg3/6TcwT7LefQiJpWB2z92zT1sp5lPhtpNneqrtFFnirplfP5coeelRSlTEbHDwbHSX1LfHU7A5WHjf7oEHvn2hMhdgTlvGt4vL7rXiy9p8GWjcudGxZs+/WNs8CCkZd8j2gVvSRQEmNNtCd/U3jmq+o2VncJjBhetJ7eCyvKOAMwcCLHE0zleX77mXVtq7UVLXrcypxIbVjJAIko8y71fATyrRomcijS7Sgw==\u0026quot; | base64 --decode | keybase pgp decrypt EOT } keybase_password_pgp_message = { \u0026quot;Accounting\u0026quot; = \u0026lt;\u0026lt;-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A== -----END PGP MESSAGE----- EOT \u0026quot;Administrator\u0026quot; = \u0026lt;\u0026lt;-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfAQ/+JcRNkO9SxMm9U196p2WuuXdSWo9ooktKJMp3q4Xf5xMG5z/ccphl5+fVDmkp2Pr76UJ9NmiBw8rzScFUEU4U+xZepNojSdN/rmZPWB6PKCdJMyItw6HOnn7OSa0i1arr0PHaC0bpVs4Bc+9Oqtw1SuU8uvwBpCeM+h33qOROnvKnGgvOHV2Zk1XcgT+sg7xMTv8q77KePoNLTK3joQL7fXdPWUGWCp8srWpxzJ8LD4aNMmsrjA/s/7sNbAAdhffRwwA6diuZfeYscZ6MlURUtrSx3iAuNV33kmhuyYimlmXstbfs/nIJVI5OfcVexPKzHK5O9DikXApAzbf/YACz0OebOcxnzh6+rQw9+XWwRtARcK3tViMhxqnEu4PHROmj1sNmLZLJqCniwN91J2iry7BAx2Zoyvvw7vd7Sw9LddaM+j2XHhSf21250sNMn/9R6beUlkWQgPci8mU51rnqBffbOJnvVh7QCTLssoMTgKRrgxb+oZbSsKLLQO/621ZcTY9rzC74w2kZWJTS7nx5G/0KQkwXP4NGRSTXYg3/6TcwT7LefQiJpWB2z92zT1sp5lPhtpNneqrtFFnirplfP5coeelRSlTEbHDwbHSX1LfHU7A5WHjf7oEHvn2hMhdgTlvGt4vL7rXiy9p8GWjcudGxZs+/WNs8CCkZd8j2gVvSRQEmNNtCd/U3jmq+o2VncJjBhetJ7eCyvKOAMwcCLHE0zleX77mXVtq7UVLXrcypxIbVjJAIko8y71fATyrRomcijS7Sgw== -----END PGP MESSAGE----- EOT } keybase_secret_key_decrypt_command = { \u0026quot;Accounting\u0026quot; = tostring(null) \u0026quot;Administrator\u0026quot; = \u0026lt;\u0026lt;-EOT echo \u0026quot;wcFMA4U4ylYlNYTfARAAivQzF+bh6N6OH/3a1S7XQCrIceoLn9EXsc8Gr0p09TVieSqwwv1RojaCULjYXYu5UnxRFwaavN+ULxrl2c4hRBIMgNEAo1Nxy16vfDEj4W7S9l+yA/TU3ewbs8WqKHIFrO8+AcjxUV4Ol5cmziDu70UR0H1/f0w7lqC/s36Zqa1Rz5Mb1n7ATLfs4jiPDQiFlr+E6gSe+I23sAQqdDS/WEbwAVz6o2B9mvs+OznNzeDoTwd7nE2ca+jYDZKjEjD6+qfDAnVzftwSrJIb2yJYlKIeSKJLC9loEQk2wdR5fkKrPg//9S4gYQJjzkwWyJAQsc6AuOPZXjqVe5yV9EpG2r0938G/acR3SEjt53ckXjh6Fi0/EgOjfeTVMO0EH6Se/vurdXBRyMggTieyN76Ts8nnn32GBldTZBUgWTL1Udj6B9ueqFCFuB8LFGNNNoHYjp3hAeGEQdtgI9TQ9r+jRDKpO8zcDoRMFK7wv4DJ31Nl/aS++a8nFEwJp7D5XkiSPbJ9JE1MwvuufldAHqr8iRbt3LmKeB4qC3TFbIhNWY4gs2VZ5LTepIn18sQfQ4f5s9o1lpem4yQw2XeEA7Fd1sPVypVeOj4z8Y080duGES896LiGpsAZdQ3bm/RiuIMLSabArgWCP/0LgrOQU8SwrIdN3k4682nw41KVnhjY2IDSWQHfEUCTNkgNfdj8v7FiD/OHX5G6VX/NAOwiAQ7Qh9u6UOmyAVY3QTjgVYEF4+oUyX+zZWprhhJkvHRDTTTNqozxVBfbYqrKTxSa00MRwAFIwQJh3xXbvmlF\u0026quot; | base64 --decode | keybase pgp decrypt EOT } keybase_secret_key_pgp_message = { \u0026quot;Accounting\u0026quot; = tostring(null) \u0026quot;Administrator\u0026quot; = \u0026lt;\u0026lt;-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfARAAivQzF+bh6N6OH/3a1S7XQCrIceoLn9EXsc8Gr0p09TVieSqwwv1RojaCULjYXYu5UnxRFwaavN+ULxrl2c4hRBIMgNEAo1Nxy16vfDEj4W7S9l+yA/TU3ewbs8WqKHIFrO8+AcjxUV4Ol5cmziDu70UR0H1/f0w7lqC/s36Zqa1Rz5Mb1n7ATLfs4jiPDQiFlr+E6gSe+I23sAQqdDS/WEbwAVz6o2B9mvs+OznNzeDoTwd7nE2ca+jYDZKjEjD6+qfDAnVzftwSrJIb2yJYlKIeSKJLC9loEQk2wdR5fkKrPg//9S4gYQJjzkwWyJAQsc6AuOPZXjqVe5yV9EpG2r0938G/acR3SEjt53ckXjh6Fi0/EgOjfeTVMO0EH6Se/vurdXBRyMggTieyN76Ts8nnn32GBldTZBUgWTL1Udj6B9ueqFCFuB8LFGNNNoHYjp3hAeGEQdtgI9TQ9r+jRDKpO8zcDoRMFK7wv4DJ31Nl/aS++a8nFEwJp7D5XkiSPbJ9JE1MwvuufldAHqr8iRbt3LmKeB4qC3TFbIhNWY4gs2VZ5LTepIn18sQfQ4f5s9o1lpem4yQw2XeEA7Fd1sPVypVeOj4z8Y080duGES896LiGpsAZdQ3bm/RiuIMLSabArgWCP/0LgrOQU8SwrIdN3k4682nw41KVnhjY2IDSWQHfEUCTNkgNfdj8v7FiD/OHX5G6VX/NAOwiAQ7Qh9u6UOmyAVY3QTjgVYEF4+oUyX+zZWprhhJkvHRDTTTNqozxVBfbYqrKTxSa00MRwAFIwQJh3xXbvmlF -----END PGP MESSAGE----- EOT } é€™æ™‚å˜—è©¦åœ¨ä½¿ç”¨ terraform planï¼Œæœƒç„¡æ³•å–å¾— state s3 bucket\nå› ç‚º access key å·²ç¶“é‡å»ºï¼Œç¾åœ¨ terraform ä½¿ç”¨èˆŠçš„ access key é€£ s3 æœƒ 404 not found aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Remote state S3 bucket chechia-root-ap-northeast-1-terraform-state does not exist or you don't have permissions to access it. Would you like Terragrunt to create it? (y/n) n ERRO[0004] remote state S3 bucket chechia-root-ap-northeast-1-terraform-state does not exist or you don't have permissions to access it ERRO[0004] Unable to determine underlying exit code, so Terragrunt will exit with error code 1 å–å¾— output å¾Œï¼Œä¸€æ¨£åš gpg decrypt å–å¾—\npassword access key å®Œæˆå¾Œä½¿ç”¨ aws-vault ç§»é™¤èˆŠçš„ profile + credentialï¼Œå†å¾æ–°åŒ¯å…¥ access key\naws-vault remove terraform-30day-root-iam-user Delete credentials for profile \u0026quot;terraform-30day-root-iam-user\u0026quot;? (y|N) y Deleted credentials. aws-vault add terraform-30day-root-iam-user Enter Access Key ID: Enter Secret Access Key: Added credentials to profile \u0026quot;terraform-30day-root-iam-user\u0026quot; in vault å®Œæˆå¾Œå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ aws-vault plan äº†\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan ä¸Šé¢çš„è®Šæ›´æˆ‘å€‘çš„ PR å¦‚ä¸‹\nterragrunt-infrastructure-modules PR terragrunt-infrastructure-live-example PR TODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-19-14th-ithome-ironman-iac-aws-workshop-08-reset-iam-user-administrator/","summary":"\u003cp\u003eæ˜¨å¤©è™•ç†å®Œ Accounting çš„ reset passwordï¼Œä»Šå¤©è¦ä¾† reset root account Administrator çš„æ¬Šé™\u003c/p\u003e\n\u003cp\u003eæœ¬æ—¥é€²åº¦\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e root ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è£œä¸Š root account IAM Policy\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è£œä¸Š root account IAM Group\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e reset root account IAM user login profile \u0026amp; pgp key\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"reset-iam-root-user-administrator-password\"\u003eReset IAM root user Administrator Password\u003c/h3\u003e\n\u003cp\u003eä¾ç…§ä¸Šé¢çš„æ­¥é©Ÿï¼Œæˆ‘å€‘ç¢ºå®šå¯ä»¥æ­£å¸¸ç™»å…¥ï¼Œæ–¼æ˜¯å¯ä»¥ä¾†å¯ä»¥æ–°å»º Administrator çš„ login profile\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç”±æ–¼ Administrator æœƒéœ€è¦ access keyï¼Œæ‰€ä»¥æˆ‘å€‘ä¹ŸæŠŠä»–è¨­æˆ true\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode\u003e# terragrunt.hcl\n  users = {\n    Administrator = {\n      groups               = [\u0026quot;full-access\u0026quot;]\n      pgp_key              = \u0026quot;keybase:chechiachang\u0026quot;\n      create_login_profile = true\n      create_access_keys   = true\n    },\n    Accounting = {\n      groups               = [\u0026quot;billing\u0026quot;]\n      pgp_key              = \u0026quot;keybase:chechiachang\u0026quot;\n      create_login_profile = true\n      create_access_keys   = false # accounting always use web console, won't use access key\n    }\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¨˜å¾—æ›´æ”¹ module/output.tfï¼Œå¢åŠ  secret key çš„ outputï¼Œè€Œä¸è¦åªç•™åœ¨ terraform state è£¡é¢\u003c/p\u003e","title":"Reset Iam User Administrator"},{"content":"æ˜¨å¤©æˆ‘å€‘å»ºç«‹ IAM Group èˆ‡ policyï¼Œä¸¦èªªæ˜ policy ç®¡ç†åŸå‰‡ã€‚\nç„¶è€Œæ˜¨å¤©æœ€å¾Œå‰µå»º user æ™‚ï¼Œæˆ‘å€‘é—œé–‰äº† create_login_profile = false çš„é¸é … é€™æ˜¯ç‚ºäº†é¿å…ç•¶å‰çš„ç™»å…¥æ©Ÿåˆ¶è¢«è¦†è“‹æ‰ï¼Œå½±éŸ¿ root account Administrator çš„ä½¿ç”¨ æ›´æ”¹ login æ–¹å¼ï¼Œåœ¨æŸäº›æ¥µç«¯çš„æƒ…å½¢ä¸‹ï¼Œæœ‰å¯èƒ½è®“ Administrator è‡ªå·±è¦†è“‹è‡ªå·±çš„ login è¨­å®šå¾Œï¼Œè®“è‡ªå·±ç„¡æ³•ç™»å…¥ å¦‚æœä½ æ˜¯ç®¡ç†å“¡ï¼Œåœ¨æ›´æ”¹ admin å¸³è™Ÿçš„æ¬Šé™èˆ‡ç™»å…¥è¨­å®šæ™‚ï¼Œä¸€å®šè¦å¤šåŠ æ³¨æ„\nå¦‚æœä¸å¹¸æ”¹å£ï¼Œç„¡æ³•ç™»å…¥ï¼Œå°±åªèƒ½å†å»æ‰¾å‡º root account root user å¸³è™Ÿä¾†è§£æ•‘äº† å¦‚æœæ˜¯ root account root user æŠŠè‡ªå·±çš„ login æ”¹å£ï¼Œå°±æœƒå¾ˆç—›è‹¦ï¼Œè¦è«‹ aws support ä¾†æ•‘ä½  æœ¬æ—¥é€²åº¦\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group reset root account IAM user login profile \u0026amp; pgp key iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nEnhance User Login Security Gruntwork Guide åœ¨å®Œæˆ group èˆ‡ policy è¨­å®šå¾Œï¼Œä¸‹ä¸€å€‹éœ€è¦åšçš„æ˜¯åŠ å¼· user ç™»å…¥çš„å®‰å…¨æ€§\néœ€è¦åšçš„äº‹æƒ…æœ‰\nå•Ÿç”¨ MFA policy è¨­å®šåš´æ ¼çš„ password policy å»ºç«‹ login profile: password å¾Œï¼Œä½¿ç”¨å„å€‹æˆå“¡çš„ gpg key åŠ å¯† (encrypt) passwordï¼Œåªæœ‰æˆå“¡è‡ªå·±å¯ä»¥è§£é–‹è‡ªå·±çš„ password MFA Policy Multi-factor authentication æ˜¯å¸¸ç”¨çš„èªè­‰æ–¹å¼\nåœ¨ä½¿ç”¨ AWS API çš„æ™‚å€™ï¼Œé™¤äº†å¸³è™Ÿå¯†ç¢¼ / access key ä»¥å¤–ï¼Œéœ€è¦ç¬¬äºŒå±¤ç™»å…¥è£ç½®åšé©—è­‰ AWS æ”¯æ´è¨±å¤šä¸åŒå½¢å¼çš„ MFA è£ç½® è™›æ“¬çš„ MFA è£ç½® ex. è·Ÿ google authenticator ä¸€èµ·ä½¿ç”¨ ç¡¬é«”çš„ MFA è£ç½® ex. ç¬¦åˆ FIDO2 æ¨™æº–çš„ YubiKey ç­‰ç­‰ æœ¬ workshop æœƒå¯¦ä½œè™›æ“¬çš„ MFA è£ç½®ï¼Œè®“ä½¿ç”¨è€…ä½¿ç”¨ Google Authenticator ç™»å…¥æ‰èƒ½ä½¿ç”¨ API ç„¶è€Œ å¦‚ Gruntwork Guide åœ¨ MFA Policyæ‰€è¿°ï¼Œè¦ enforce MFA åˆ°æ‰€æœ‰çš„ AWS API æœƒæœ‰è«¸å¤šå›°é›£\nå¦‚æœæˆ‘å€‘è¦æ±‚æ‰€æœ‰ AWS API éƒ½é MFAï¼Œæœ‰äº›ä¾†æºå¯èƒ½å¾ˆé›£åš MFA ex. EC2 VM ä¸Šçš„ä¸€å€‹ application ä¹Ÿéœ€è¦æ‰“ AWS APIï¼Œä½†åœ¨ VM ä¸Šå°±å¾ˆé›£å–å¾— Google Authenticator çš„èªè­‰ç¢¼ ex. æ–°çš„ IAM User å‰›æ–°å»ºï¼Œæ²’æœ‰ MFAï¼Œä¹Ÿå°±ç„¡æ³•ç™»å…¥è¨­å®šè‡ªå·±çš„ MFAï¼Œè®Šæˆé›ç”Ÿè›‹è›‹ç”Ÿé› Gruntwork Guide ä¸­å»ºè­°åœ¨ä»¥ä¸‹æƒ…å¢ƒä¸­å•Ÿç”¨ MFA å°±å¥½\nsecurity ä»¥å¤–çš„ child-account (dev/stag/prod) çš„æ‰€æœ‰ iam-role éƒ½é–‹å•Ÿ MFA ç•¶æˆ‘å€‘è¦ä½¿ç”¨ security/iam-user assuem åˆ°å¦å¤–ä¸€å€‹ account/iam-role æ™‚ï¼Œéœ€è¦ MFA èªè­‰æ‰å¯ assume role ç„¶å¾ŒæŠŠ security ä»¥å¤–çš„ child-account é–‹å•Ÿ global çš„ trust policy ï¼Œé€™æ¨£è¨­å®šå°±å¾ˆå–®ç´” ä¸æœƒ block iam-user ç™»å…¥ï¼Œå› ç‚ºæ‰€æœ‰ user éƒ½åœ¨ security åº•ä¸‹ï¼Œå…¶ä»– child-account æ²’æœ‰ user åœ¨ root èˆ‡ security account å…§ï¼Œæ‰æœ‰ IAM User èˆ‡ IAM Groupï¼Œåœ¨é€™é‚Šå•Ÿç”¨ MFA å°‡ MFA ä¾æ“š policy å»è¨­å®šï¼Œé€é policy - group - user å» enforce user ä½¿ç”¨ MFA æ–° user å»ºç«‹æ™‚ï¼Œéœ€è¦é¡å¤–å»ºç«‹ \u0026ldquo;self-management\u0026rdquo; permissions policyï¼Œè®“æ–°ç”¨æˆ¶å¯ä»¥ä¸ç”¨ MFAï¼Œé€²è¡Œç¬¬ä¸€æ¬¡çš„ MFA è¨­å®š Password Policy Password Policy æŒ‡çš„æ˜¯å°æ–¼ user è‡ªå·±è¨­å®šçš„å¯†ç¢¼è¦ç¬¦åˆä¸€å®šçš„è¦ç¯„\nAWS official doc: å¦‚ä½•è¨­å®š password policy ex. å¯†ç¢¼è‡³å°‘è¦ 32 å­—å…ƒé•·åº¦ ex. å¯†ç¢¼è¦åŒ…å«è‹±æ–‡ï¼Œæ•¸å­—ï¼Œå¤§å°å¯«ï¼Œæˆ–ç‰¹æ®Šå­—å…ƒ ex. å¯†ç¢¼å¤šä¹…éœ€è¦æ›´æ–°ä¸€æ¬¡ é€™äº› password policy å¯ä»¥å¤§å¹…å¼·åŒ–æ‰€æœ‰ User çš„å¯†ç¢¼å®‰å…¨æ€§ ç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„ external module terraform-aws-iam å·²ç¶“æ•´åˆäº† password policyï¼Œæ‰€ä»¥æˆ‘å€‘é€™é‚Šç›´æ¥åœ¨ input ä¸­é–‹å•Ÿå³å¯ä»¥ä½¿ç”¨\nPGP key pgp (Pretty Good Privacy) æ˜¯éå¸¸å¸¸ç”¨çš„éå°ç¨±åŠ å¯†å·¥å…·\næ¯”è¼ƒå¸¸ç”¨çš„å·¥å…·å¦‚ OpenPGP æˆ–æ˜¯ gpg (GnuPG) ç‚ºä½• iam user å‰µå»ºæœƒç‰½æ‰¯åˆ° pgpï¼Ÿ\nä¸ç®¡æ˜¯ gruntwork module æˆ–æ˜¯ aws terraform-aws-iam module éƒ½æ”¯æ´ pgp åœ¨ admin æ–°å»º User èˆ‡ login profile å¾Œï¼Œaws api ç”¢ç”Ÿ passwordï¼Œå›å‚³çµ¦ admin terraformï¼Œé€™æ™‚ admin éœ€è¦æŠŠç¬¬ä¸€æŠŠ password å‚³çµ¦ userï¼Œè®“ user åšç¬¬ä¸€æ¬¡ç™»å…¥ é€™æ•´å€‹å‚³ééç¨‹ï¼Œä¸ç®¡å¾ aws api -\u0026gt; terraform state -\u0026gt; terraform output -\u0026gt; admin -\u0026gt; userï¼Œå¦‚æœæ˜¯æ˜ç¢¼æœªåŠ å¯†çš„ç‹€æ…‹ä¸‹ï¼Œå¯¦åœ¨ä¸å®œå‚³éï¼Œå¾ˆæœ‰å¯èƒ½è¢«æœ‰å¿ƒä¸­ä¸­é€”æ””æˆª å› æ­¤æˆ‘å€‘å¯ä»¥ä½¿ç”¨ pgp ç›¸é—œå·¥å…·ä¾†åŠ å¯† admin ä»¥ gpg(GnuPG) ç‚ºä¾‹éå°ç¨±åŠ å¯† (local exposure)\nadmin å–å¾—æ–° user (ex. accounting äººå“¡) çš„ gpg public key admin ç”¢ç”Ÿ user password å¾Œï¼Œä½¿ç”¨ gpg å·¥å…·ï¼Œä»¥ account äººå“¡çš„ public key åŠ å¯† password ç²å¾—ä¸€ä¸² encrypted textï¼Œå‚³çµ¦ accounting äººå“¡ accounting äººå“¡ä½¿ç”¨è‡ªå·±çš„ private key ç”¨ gpg å·¥å…·è§£å¯†ï¼Œå³å¯å–å¾—æ˜ç¢¼ password åªæœ‰æœ‰ private key çš„äººå¯ä»¥è§£é–‹ encrypted text accounting äººå“¡ä½¿ç”¨ password ç™»å…¥å¾Œï¼Œæœƒå› ç‚º login profile è¦æ±‚ï¼Œè€Œè¢«è¿«æ›´æ”¹æ–°å¯†ç¢¼ï¼Œæ¨æ£„ admin local æœ‰æ›éšªéçš„ password ä¸Šé¢çš„åšæ³• terraform state èˆ‡ admin local æœƒçœ‹åˆ°æ˜ç¢¼ passwordï¼Œä¸å¤ å®‰å…¨ã€‚\nPGP \u0026amp; keybase.io aws æä¾›ä¸€å€‹æ”¹é€²çš„åšæ³•ï¼Œterraform state åªå­˜ encrypted text\né€™æ¨£å¯ä»¥é¿å…åœ¨ terraform state ä¸­èˆ‡ admin local çš„ password æ›éšª pre-requisite\ngpg tool keybase.io è¨»å†Š å®‰è£ gpg\nsudo port install gpg gpg --version å¦‚æœç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå¯ä»¥å‰µå»ºä¸€å° key pair\ngpg --full-generate-key åˆ—å‡ºè‡ªå·±æœ‰çš„ secret key (private key)\ngpg --list-secret-keys --keyid-format=long export public key\ngpg --armor --export 3AA5C34371567BD2 -----BEGIN PGP PUBLIC KEY BLOCK----- mQINBF9oN7ABEADeJ5BO3RsvfB0RpU3ZtI3AZmLmMfoaQ41QtkLoFEhF0XnSBNhH .... ARFfAR39B4hHAnA+/+scVFdGT8i9kuYxk8Ocb7zHgULrOBfKEPEQ5XLmdiqAD+DN jO2IFPM= -----END PGP PUBLIC KEY BLOCK----- NOTE: private key æ˜¯é‘°åŒ™ï¼Œpublic key æ˜¯é–é ­ï¼Œæ°¸é ä¸è¦æŠŠ private key å‚³å‡ºå»ï¼Œè€Œæ˜¯æŠŠ public key å‚³å‡ºå»è®“åˆ¥äººåŠ å¯†ï¼Œç”¨ public key åŠ å¯†éçš„æ±è¥¿ï¼Œåªèƒ½ç”¨æ‰‹ä¸Šé€™æŠŠ private key è§£é–‹ï¼Œä¹Ÿå°±æ˜¯å°ˆå±¬ä½ çš„\nåœ¨ keybase.io ä¸Šé¢è¨»å†Šå¾Œï¼Œä¸Šå‚³ä½ çš„ pgp public key\nä¾ç…§æŒ‡ç¤ºå®Œæˆæ­¥é©Ÿ (optional) èªè­‰ github / domain / å…¶ä»–ç¶²ç«™è®“å…¶ä»–äººç¢ºå®šé€™å€‹æ˜¯ä½ æœ¬äºº å¯¦éš›æ“ä½œï¼špassword policy \u0026amp; pgp key NOTE: å¦‚æœä¸å•Ÿç”¨ pgp-keyï¼Œadmin terraform apply æ–° user å¾Œæ‹¿åˆ°çš„ password å°±æœƒæ˜¯æ˜ç¢¼ï¼Œå¯ä»¥é€é gpg å·¥å…·åŠ å¯†ï¼Œåœ¨é€éç¶²è·¯å‚³çµ¦å°æ–¹\né€™é‚Šæˆ‘å€‘å…ˆä½¿ç”¨ Accounting å…ˆåšæ¸¬è©¦ï¼Œå•Ÿç”¨ login profile\nNOTE: ä½ çŸ¥é“è‡ªå·±æ˜¯ adminï¼Œå°±è«‹ä¸è¦æ‹¿è‡ªå·±çš„ User åšæ¸¬è©¦ï¼Œå£äº†å¾ˆéº»ç…©\nå°‡ terragrunt.hcl æ”¹æˆ\nAccounting = { groups = [\u0026quot;billing\u0026quot;] pgp_key = \u0026quot;keybase:chechiachang\u0026quot; create_login_profile = true create_access_keys = false # accounting always use web console, won't use access key } } æ¥è‘—è¦æ”¹ module ä¸­çš„ codeï¼Œå°‡ module çš„ output æ¥å‡ºä¾†åˆ°ä¸Šå±¤çš„ root module\noutput.tf\n# https://github.com/terraform-aws-modules/terraform-aws-iam/blob/master/modules/iam-user/outputs.tf output \u0026quot;keybase_password_pgp_message\u0026quot; { description = \u0026quot;Encrypted password\u0026quot; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_password_pgp_message } } output \u0026quot;keybase_password_decrypt_command\u0026quot; { description = \u0026quot;Decrypt user password command\u0026quot; value = { for key, value in module.iam_user : key =\u0026gt; value.keybase_password_decrypt_command } } ç„¶å¾Œæˆ‘å€‘è©¦è‘— plan\né æœŸï¼šç”¢ç”Ÿ accounting login profileï¼Œç”¢ç”Ÿ pgp encrypted password text (è€Œä¸æ˜¯æ˜ç¢¼ password) aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform will perform the following actions: # module.iam_user[\u0026quot;Accounting\u0026quot;].aws_iam_user_login_profile.this[0] will be created + resource \u0026quot;aws_iam_user_login_profile\u0026quot; \u0026quot;this\u0026quot; { + encrypted_password = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 + password_reset_required = false + pgp_key = \u0026quot;keybase:chechiachang\u0026quot; + user = \u0026quot;Accounting\u0026quot; } Plan: 1 to add, 0 to change, 0 to destroy. Changes to Outputs: + keybase_password_decrypt_command = { + Accounting = (known after apply) + Administrator = null } + keybase_password_pgp_message = { + Accounting = (known after apply) + Administrator = null } ç¬¦åˆé æœŸï¼\nOutput ä¸­ keybase_password_pgp_message çš„ Accounting = (known after apply) æ‡‰è©²æ˜¯åŠ å¯†éçš„ output æ‡‰è©²è¦åŠ å¯†çµ¦ keybase:chechiachangï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ‘çš„ gpg key å¯ä»¥è§£é–‹ é‚£ç›´æ¥ä¾† apply è©¦è©¦çœ‹\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt apply Outputs: keybase_password_decrypt_command = { \u0026quot;Accounting\u0026quot; = \u0026lt;\u0026lt;-EOT echo \u0026quot;wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A==\u0026quot; | base64 --decode | keybase pgp decrypt EOT \u0026quot;Administrator\u0026quot; = tostring(null) } keybase_password_pgp_message = { \u0026quot;Accounting\u0026quot; = \u0026lt;\u0026lt;-EOT -----BEGIN PGP MESSAGE----- Version: Keybase OpenPGP v2.0.76 Comment: https://keybase.io/crypto wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A== -----END PGP MESSAGE----- EOT \u0026quot;Administrator\u0026quot; = tostring(null) } ä¸Šé¢çš„ PGP message æ˜¯åŠ å¯†éçš„ textï¼Œå¯ä»¥æ”¾å¿ƒçš„å‚³é\nåªæœ‰æˆ‘çš„ private key èƒ½è§£é–‹ï¼Œæ‰€ä»¥å°±ç®—æ“´æ•£ä¹Ÿæ²’æœ‰ä»€éº¼é¢¨éšª æ²’æœ‰ private key çš„äººå·²ç¶“è­‰æ˜ç„¡æ³•åœ¨æœ‰æ•ˆçš„æ™‚é–“å…§è§£é–‹ é™„ä¸Šè§£å¯†çš„ keybase command å¾ˆè²¼å¿ƒï¼Œæœ‰ä½¿ç”¨ keybase tool äººå¯ä»¥ç›´æ¥è§£ ä½†æˆ‘æ˜¯ä½¿ç”¨ gpg è€Œä¸æ˜¯ keybaseï¼Œä¹Ÿæ˜¯å¯ä»¥è§£é–‹\necho \u0026quot;wcFMA4U4ylYlNYTfAQ/+KLtNeJqOqK/V3pNdcRh9nvyDw/huJfaYF7Ab/YdKqLKNVySBqc6HY8xedmER5Wn78RlG962/f772u8UlQN4XCOjOLjyOaNL8K0tkeoSVg+XXPx2qJO9Myc1d+74rG57biUD26XpwfS7+ryIjaHf+NzjisExZy2mgiMIzzAlfqTzRAc+jYP11wZcyFGwOe9pMq6BJy7FH5935ndVgNLCgYtSjgIV5b5kWQ3SDr0E9egAHnoAcHs8mni71x7OL7OCc/bS3nJSLz1jRkMoukWyQQ3+lM7Nwi36NSJneIKxW5f7lSxr7Bx+W3mx6gZgb18yRVIwbVW5iDFsAQOFb0zOHUf8tm3tAQ0F79Yeqy9sfLCfUUjVpCENEJe5FtwJkI8EbHKe8mGnYA4dbHaCkIDgVa8TZ4mdXl7yVZx0adlkKFIS48niwPHxMErZYqnRBitUCGdaH0bHcpPcnSVolLljZmXZUrntMjIEb9FGYbgl6hOiRF9MR3RQL5DNmpS7uSqU7V6TyhVbAOJO2oR01Z7hXdAMxZ54O+h06jN7fzvLrUSMWvUz/wp+JJnIDYNwu75Dvicn6NmXrP3fH3M8xmYIEPhpSvOldNzB4DMqQdD6tN+DphFFyvFwuLnWKWKOY+pbNXkd5q0H3A69owxgsONoOL1JqjZgOdcLtWTq+g9XqU5XSRQGo1ei5Ctv2f5yAHZuI2smwJkTA88SuyZqJNwRixw5OPpUDOuWxhK6xftsN7M1/TnioX8Ch3RTow7H0dvMFFD3ocvjG4A==\u0026quot; | base64 --decode | gpg --decrypt å°±å–å¾— Accounting çš„åˆæ¬¡ç™»å…¥å¯†ç¢¼çš„ï¼Œè¶•å¿«åˆ° aws console ä¸Šé¢è©¦è©¦çœ‹\nNOTE: æƒ³è¦åœ¨ browser åŒæ™‚å¤šé–‹ aws login session çš„è©±ï¼Œå¯ä»¥åƒè€ƒ chrome plugin session box\nç™»å…¥ aws web console\næ³¨æ„ account ID æ˜¯ root account ID user æ˜¯ Accounting password æ˜¯å‰›å‰›è§£å¯†çš„å¯†ç¢¼ password å°¾ç«¯å¦‚æœæœ‰ % ä¸æ˜¯å¯†ç¢¼çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ EOL (End of line) indicatorï¼Œè¨˜å¾—å»æ‰ å‰é¢çš„éƒ¨åˆ†å‰›å¥½ 20 å­—å…ƒï¼Œç¬¦åˆæˆ‘å€‘ login profile çš„å¯†ç¢¼é•·åº¦é™åˆ¶ é †åˆ©ç™»å…¥æ‹‰ Accounting çš„æ¬Šé™æ˜¯ä¸èƒ½å‹•ç”¨ EC2 API çš„ï¼Œåˆ‡åˆ° EC2 é é¢ç›´æ¥ API Errorï¼Œä¹Ÿç¬¦åˆé æœŸ ä¸Šé¢çš„è®Šæ›´æˆ‘å€‘çš„ PR å¦‚ä¸‹\nterragrunt-infrastructure-modules PR terragrunt-infrastructure-live-example PR æ˜å¤©é‚„æœ‰ Administrator å¸³æˆ¶éœ€è¦è™•ç†ï¼Œæœƒå†æ›´éº»ç…©ä¸€äº›\nTODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-18-14th-ithome-ironman-iac-aws-workshop-07-reset-iam-user/","summary":"\u003cp\u003eæ˜¨å¤©æˆ‘å€‘å»ºç«‹ IAM Group èˆ‡ policyï¼Œä¸¦èªªæ˜ policy ç®¡ç†åŸå‰‡ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç„¶è€Œæ˜¨å¤©æœ€å¾Œå‰µå»º user æ™‚ï¼Œæˆ‘å€‘é—œé–‰äº† \u003ccode\u003ecreate_login_profile = false\u003c/code\u003e çš„é¸é …\n\u003cul\u003e\n\u003cli\u003eé€™æ˜¯ç‚ºäº†é¿å…ç•¶å‰çš„ç™»å…¥æ©Ÿåˆ¶è¢«è¦†è“‹æ‰ï¼Œå½±éŸ¿ root account Administrator çš„ä½¿ç”¨\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eæ›´æ”¹ login æ–¹å¼ï¼Œåœ¨æŸäº›æ¥µç«¯çš„æƒ…å½¢ä¸‹ï¼Œæœ‰å¯èƒ½è®“ Administrator è‡ªå·±è¦†è“‹è‡ªå·±çš„ login è¨­å®šå¾Œï¼Œè®“è‡ªå·±ç„¡æ³•ç™»å…¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå¦‚æœä½ æ˜¯ç®¡ç†å“¡ï¼Œåœ¨æ›´æ”¹ admin å¸³è™Ÿçš„æ¬Šé™èˆ‡ç™»å…¥è¨­å®šæ™‚ï¼Œä¸€å®šè¦å¤šåŠ æ³¨æ„\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœä¸å¹¸æ”¹å£ï¼Œç„¡æ³•ç™»å…¥ï¼Œå°±åªèƒ½å†å»æ‰¾å‡º root account root user å¸³è™Ÿä¾†è§£æ•‘äº†\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæ˜¯ root account root user æŠŠè‡ªå·±çš„ login æ”¹å£ï¼Œå°±æœƒå¾ˆç—›è‹¦ï¼Œè¦è«‹ aws support ä¾†æ•‘ä½ \u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæœ¬æ—¥é€²åº¦\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e root ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è£œä¸Š root account IAM Policy\u003c/li\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e è£œä¸Š root account IAM Group\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e reset root account IAM user login profile \u0026amp; pgp key\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e","title":"Reset Iam User"},{"content":"æ˜¨å¤©æˆ‘å€‘å°‡ root account IAM user import åˆ° terraform ä¸­\nç¤ºç¯„ terraform import å¢åŠ  iam user çš„åŠŸèƒ½åˆ° module repository ä¸­ ä»Šå¤©è¦å®Œæˆ root account ä¸­ IAM Group + Policyï¼Œé †ä¾¿èŠèŠ aws IAM policy ç®¡ç†åŸå‰‡\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\næ‰¿æ¥æ˜¨å¤©çš„ plan çµæœï¼Œæˆ‘å€‘ä»Šå¤©è¦æŠŠ IAM policy èˆ‡ group é–‹å‡ºä¾†\nIam User é¦–å…ˆ review aws_iam_user çš„ resource\n# module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0] will be updated in-place ~ resource \u0026quot;aws_iam_user\u0026quot; \u0026quot;this\u0026quot; { + force_destroy = true id = \u0026quot;Administrator\u0026quot; name = \u0026quot;Administrator\u0026quot; tags = {} # (4 unchanged attributes hidden) }` force_destroy é€™å€‹åƒæ•¸æˆ‘å€‘éœ€è¦å—ï¼Ÿå¯ä»¥ä¸€æ‰¾ä»¥ä¸‹çš„æ­¥é©ŸæŸ¥æ–‡ä»¶åˆ¤æ–·\nç›´æ¥ google \u0026ldquo;terraform aws iam user\u0026rdquo;ï¼Œæ‰¾åˆ° Terraform registry ä¸Š AWS iam user çš„èªªæ˜ é€™è£¡æœ‰èªªæ˜ï¼Œåˆªé™¤ user æ™‚ï¼Œå¦‚æœæœ‰ non-terraform-managed çš„ access key, login profile, MFA devicesï¼Œæ˜¯å¦ä»è¦å¼·åˆ¶åˆªé™¤ é€™è£¡æˆ‘å€‘å¸Œæœ›å¦‚æœæœ‰ access key æˆ– MFA device å­˜åœ¨çš„è©±ï¼Œä¸è¦ç›´æ¥åˆªé™¤ User å°‡ https://github.com/chechiachang/terragrunt-infrastructure-modules/pull/1/files#diff-b15a741b1129d8f5451060653922d85c934792a1dd41c7fae1b02f3a6398094aR8 æ”¹æˆ false Iam Group \u0026amp; Policy ä»Šå¤©è¦ä¾†èª¿æ•´ Iam Group \u0026amp; Policy\nGruntwork æ–‡ä»¶: Root Account èªªæ˜ï¼Œroot account ä¸‹æ‡‰è©²æœ‰å…©å€‹ policy group group/full-access çµ¦äºˆ root account è¶…ç´šç®¡ç†å“¡å®Œæ•´çš„æ§åˆ¶æ¬Šé™ billing çµ¦äºˆ billing çš„æœƒè¨ˆäººå“¡é€²ä¾†å ±å¸³ é¦–å…ˆ full-access çš„ iam_group plan å¾Œçš„çµæœå¦‚ä¸‹\nç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„ module æ˜¯ terraform-aws-iam çš„ group with policies module.iam_group_with_policies_full_access è£¡é¢æœ‰ group ä¹Ÿæœ‰ policy .aws_iam_group.this[0] æ˜¯ä¸»è¦çš„ group # module.iam_group_with_policies_full_access.aws_iam_group.this[0] will be created + resource \u0026quot;aws_iam_group\u0026quot; \u0026quot;this\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = \u0026quot;full-access\u0026quot; + path = \u0026quot;/\u0026quot; + unique_id = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_group_membership.this[0] will be created + resource \u0026quot;aws_iam_group_membership\u0026quot; \u0026quot;this\u0026quot; { + group = (known after apply) + id = (known after apply) + name = \u0026quot;full-access\u0026quot; + users = [ + \u0026quot;Administrator\u0026quot;, ] } æœ‰äº† groupï¼Œæ¥ä¸‹ä¾†å°±æ˜¯è¦é… policy\nä¸€æ¨£é€é group + policy -\u0026gt; attachment çš„ resourceï¼ŒæŠŠ group è·Ÿ policy ç¶åœ¨ä¸€èµ· æˆ‘å€‘é€™é‚Šçš„ç¨‹å¼ç¢¼ ç›´æ¥ä½¿ç”¨ aws é å…ˆå®šç¾©å¥½çš„ policy arn:aws:iam::aws:policy/AdministratorAccess # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.custom_arns[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;custom_arns\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = \u0026quot;arn:aws:iam::aws:policy/AdministratorAccess\u0026quot; } IAM AWS é å…ˆå®šç¾©çš„ policy æœ‰å“ªäº› aws å·²ç¶“é å…ˆå®šç¾©å¥½çš„ policy å¯ä»¥ä½¿ç”¨ï¼Ÿ\nå¯ä»¥ä¸Š aws web console -\u0026gt; iam -\u0026gt; policies ä¸‹æŸ¥è©¢ é€™äº›é å…ˆå®šç¾©çš„ policyï¼Œæ˜¯ aws ä¾ç…§æœ€å¸¸å‡ºç¾çš„ä½¿ç”¨æƒ…å¢ƒï¼Œäº‹å…ˆå»ºç«‹çš„ policy\nä½¿ç”¨è€…ä¸ç”¨å†å»ºè­° ex. AWS è¦ºå¾— administrator å¤§æ¦‚æœƒéœ€è¦é€™äº›æ¬Šé™ï¼Œéƒ½å…ˆé–‹åˆ°é€™å€‹ policy/admin ä¸Š ex. AWS è¦ºå¾— billing å¤§æ¦‚æœƒéœ€è¦é€™äº›æ¬Šé™ï¼Œéƒ½å…ˆé–‹åˆ°é€™å€‹ policy/billing ä¸Š ç”±æ–¼æ˜¯ AWS ä¾ç…§å¤§éƒ¨åˆ†äººçš„éœ€æ±‚é–‹çš„ policyï¼Œæ‰€ä»¥æœƒå¤šé–‹è¨±å¤šæ¬Šé™ é€™ä¹Ÿæ˜¯ç”¨é å…ˆå®šç¾© policy çš„ç¼ºé»ï¼Œå°±æ˜¯ç‚ºäº†æ»¿è¶³å¾ˆå¤šäººçš„éœ€æ±‚ï¼Œæ¬Šé™å¤ªå¤§ é•åæœ€å°æ¬Šé™åŸå‰‡ï¼Œçµ¦äºˆæ¬Šé™éå¤šä¹Ÿé€ æˆå®‰å…¨æ€§çš„é¢¨éšª ä¸ä½¿ç”¨é å…ˆå®šç¾©çš„ policy çš„è©±ï¼Œæˆ‘å€‘å¯ä»¥è‡ªå·±å¯« policy\nä¸€å€‹ policy é–‹å‡ºä¾† default æ²’æœ‰ä»»ä½• permission ä¾æ“šæœ€å°æ¬Šé™åŸå‰‡ï¼Œä¸€å¥ä¸€å¥å¢åŠ  permission åˆ° policy ä¸Š å¦‚æ­¤å¯ä»¥ç¢ºä¿ policy ä¸Šçš„ permission éƒ½æ˜¯éœ€è¦çš„ï¼Œè€Œä¸æœƒæœ‰å¤šé–‹ä½†æ˜¯ç”¨ä¸åˆ°çš„æ¬Šé™ æ¬Šé™æ„ˆå¤§ï¼Œå®‰å…¨æ€§é¢¨éšªè¶Šé«˜ï¼Œæ‰€ä»¥æœ€ä½³å¯¦è¸æœƒå¸Œæœ›æ‰€æœ‰ policy éƒ½æ˜¯é…å¾—å‰›å‰›å¥½å¤ ç”¨å°±å¥½\nç„¶è€Œé… policy å¾ˆèŠ±æ™‚é–“ï¼Œç”¨ aws å·²ç¶“å¯«å¥½çš„ policy é¦¬ä¸Šå¯ä»¥ç”¨ å¯¦å‹™ä¸Šå¯ä»¥è€ƒé‡å°ˆæ¡ˆæ™‚é–“èˆ‡æ•´é«”äººåŠ›ï¼Œä»¥åŠéœ€è¦çš„å®‰å…¨ç­‰ç´šï¼Œä¾†è€ƒæ…®è¦ä¸è¦åšåˆ°é€™éº¼ç´° AWS policy access advisor é€šå¸¸å¯« policy å¾ˆé›£é…åˆ°éå¸¸å®Œç¾å‰›å‰›å¥½ï¼Œé€šå¸¸éƒ½æœƒå¤šé–‹ permission\næ¬Šé™å¤šé–‹åŠŸèƒ½ä¸æœƒå£ï¼Œå°‘é–‹ç›´æ¥ permission denied é‚£å¤šé–‹çš„æ¬Šé™æ²’æœ‰ç”¨åˆ°ï¼Œä¹‹å¾Œè¦å¦‚ä½•æŠŠæ²’æœ‰ç”¨åˆ°çš„æ¬Šé™æ”¶å›ä¾†ï¼Ÿ AWS web console æä¾›æ ¹æ“šä½¿ç”¨ç´€éŒ„ï¼Œæå»ºè­°ä¿®æ”¹ policy\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_access-advisor.html\naws æœƒçµ±è¨ˆå„å€‹ IAM å…ƒä»¶ï¼Œå­˜å– AWS API ä½¿ç”¨/æ²’ä½¿ç”¨çš„æ¬Šé™\nä¾‹å¦‚é€™å€‹ User éå» 90 å¤©ä½¿ç”¨äº†å“ªäº› permission å»æ‰“ API ä»¥åŠ User é‚„æœ‰å“ªäº› policy permissionï¼Œæ˜¯éå» 90 å¤©éƒ½æ²’æœ‰ç”¨åˆ°çš„ é€™äº›é•·æ™‚é–“éƒ½æ²’æœ‰ç”¨åˆ°çš„ policyï¼Œæˆ‘å€‘å°±æ‡‰è©²å®šæœŸ reviewï¼Œç„¶å¾Œç§»é™¤é€™äº›ä¸å¿…è¦çš„æ¬Šé™\nUser / Group / \u0026hellip; ç­‰ç­‰éƒ½éœ€è¦åšä¸€æ¨£çš„äº‹æƒ… module ä½œç‚ºä¸€å€‹çµ„æˆå…ƒä»¶ä½¿ç”¨ ç”±æ–¼æˆ‘å€‘åœ¨ module input ä¸­é–‹å•Ÿäº† attach_iam_self_management_policy = true åƒæ•¸ï¼Œåœ¨ module ä¸­ä¾¿é€£å¸¶ç”¢ç”Ÿ\n.aws_iam_policy.iam_self_management[0]ï¼Œè£¡é¢å®šç¾©çš„è¦åš self management æ‰€éœ€è¦çš„ permission å†æŠŠ policy é€é .aws_iam_group_policy_attachment.iam_self_management[0] ç¶åˆ° group ä¸Š # module.iam_group_with_policies_full_access.aws_iam_policy.iam_self_management[0] will be created + resource \u0026quot;aws_iam_policy\u0026quot; \u0026quot;iam_self_management\u0026quot; { ... } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.iam_self_management[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;iam_self_management\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = (known after apply) } ä¸Šé¢å°±æ˜¯æˆ‘å€‘çš„ root account group/full-access èˆ‡å°æ‡‰çš„ policy\nbilling account æ¥è‘—æ˜¯ root account group/full-access èˆ‡å°æ‡‰çš„ policy\næˆ‘å€‘å¯ä»¥è‡ªå·±æ‰‹å¯« policyï¼Œä¾ç…§æœ€å°æ¬Šé™åŸå‰‡ï¼Œä¸€æ¢ä¸€æ¢åŠ å…¥ permission æˆ–æ˜¯æˆ‘å€‘å¯ä»¥ä¸Š aws web console æ‰¾çœ‹çœ‹æœ‰ç„¡é å…ˆå®šç¾©å¥½çš„ policy æˆ‘å€‘æœå°‹ billing æœ‰çœ‹åˆ°å››å€‹ policyï¼Œæ¯å€‹ policy éƒ½æœ‰é™„ä¸Š description èªªæ˜ä½¿ç”¨çš„ç›®çš„\nBilling AWSBillingConductorReadOnlyAccess AWSBillingConductorFullAccess AWSBillingReadOnlyAccess é€™è£¡å°±è¦ä¾æ“šä½¿ç”¨çš„éœ€æ±‚é¸æ“‡\nçµ¦äºˆ billing ç®¡ç†å“¡çš„æ¬Šé™ï¼Œå°±æœƒæ˜¯ ConductorFullAccess æˆ– ConductorReadOnlyAccess çµ¦äºˆ billing å ±å¸³äººå“¡ï¼Œæ‡‰è©²ä¸ç”¨æ›´æ”¹ aws çš„å…¶ä»–è¨­å®šï¼Œåªéœ€è¦è®€å–è·Ÿè¼¸å‡ºï¼Œå°±æœƒæ˜¯ AWSBillingReadOnlyAccess æˆ‘å€‘é€™é‚Šé¸æ“‡ AWSBillingConductorFullAccessï¼Œåšå€‹ç¤ºç¯„\né»æ“Š AWSBillingConductorFullAccessï¼Œè·³åˆ° Policies \u0026raquo; AWSBillingConductorFullAccess é é¢ å¯ä»¥çœ‹åˆ° policy çš„å®Œæ•´ arnï¼ŒAmazon Resource Name (ARN) å”¯ä¸€è­˜åˆ¥AWS è³‡æºï¼Œé¡ä¼¼æ–¼ ID ç„¶å¾ŒæŠŠ arn å¡«å…¥ module.am_group_with_policies_billing plan \u0026amp; apply ä¸Šé¢çš„è®Šæ›´æˆ‘å€‘çš„ PR å¦‚ä¸‹\nterragrunt-infrastructure-modules PR terragrunt-infrastructure-live-example PR ç”±æ–¼æˆ‘å€‘ module ä¸­æœ‰æ–°å¢ module \u0026quot;iam_group_with_policies_billing\u0026quot;ï¼Œè¨˜å¾—è¦å…ˆåŸ·è¡Œ init\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan â•· â”‚ Error: Module not installed â”‚ â”‚ on group.tf line 29: â”‚ 29: module \u0026quot;iam_group_with_policies_billing\u0026quot; { â”‚ â”‚ This module is not yet installed. Run \u0026quot;terraform init\u0026quot; to install all â”‚ modules required by this configuration. â•µ aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt init aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # module.iam_group_with_policies_billing.aws_iam_group.this[0] will be created + resource \u0026quot;aws_iam_group\u0026quot; \u0026quot;this\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = \u0026quot;billing\u0026quot; + path = \u0026quot;/\u0026quot; + unique_id = (known after apply) } # module.iam_group_with_policies_billing.aws_iam_group_membership.this[0] will be created + resource \u0026quot;aws_iam_group_membership\u0026quot; \u0026quot;this\u0026quot; { + group = (known after apply) + id = (known after apply) + name = \u0026quot;billing\u0026quot; + users = [ + \u0026quot;Accounting\u0026quot;, ] } # module.iam_group_with_policies_billing.aws_iam_group_policy_attachment.custom_arns[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;custom_arns\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = \u0026quot;arn:aws:iam::aws:policy/AWSBillingConductorFullAccess\u0026quot; } # module.iam_group_with_policies_billing.aws_iam_group_policy_attachment.iam_self_management[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;iam_self_management\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = (known after apply) } # module.iam_group_with_policies_billing.aws_iam_policy.iam_self_management[0] will be created + resource \u0026quot;aws_iam_policy\u0026quot; \u0026quot;iam_self_management\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = (known after apply) + name_prefix = \u0026quot;IAMSelfManagement-\u0026quot; + path = \u0026quot;/\u0026quot; + policy = jsonencode( { + Statement = [ + { + Action = [ + \u0026quot;iam:UploadSigningCertificate\u0026quot;, + \u0026quot;iam:UploadSSHPublicKey\u0026quot;, + \u0026quot;iam:UpdateUser\u0026quot;, + \u0026quot;iam:UpdateLoginProfile\u0026quot;, + \u0026quot;iam:UpdateAccessKey\u0026quot;, + \u0026quot;iam:ResyncMFADevice\u0026quot;, + \u0026quot;iam:List*\u0026quot;, + \u0026quot;iam:Get*\u0026quot;, + \u0026quot;iam:GenerateServiceLastAccessedDetails\u0026quot;, + \u0026quot;iam:GenerateCredentialReport\u0026quot;, + \u0026quot;iam:EnableMFADevice\u0026quot;, + \u0026quot;iam:DeleteVirtualMFADevice\u0026quot;, + \u0026quot;iam:DeleteLoginProfile\u0026quot;, + \u0026quot;iam:DeleteAccessKey\u0026quot;, + \u0026quot;iam:CreateVirtualMFADevice\u0026quot;, + \u0026quot;iam:CreateLoginProfile\u0026quot;, + \u0026quot;iam:CreateAccessKey\u0026quot;, + \u0026quot;iam:ChangePassword\u0026quot;, ] + Effect = \u0026quot;Allow\u0026quot; + Resource = [ + \u0026quot;arn:aws:iam::706136188012:user/*/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:user/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:mfa/${aws:username}\u0026quot;, ] + Sid = \u0026quot;AllowSelfManagement\u0026quot; }, + { + Action = [ + \u0026quot;iam:List*\u0026quot;, + \u0026quot;iam:Get*\u0026quot;, ] + Effect = \u0026quot;Allow\u0026quot; + Resource = \u0026quot;*\u0026quot; + Sid = \u0026quot;AllowIAMReadOnly\u0026quot; }, + { + Action = \u0026quot;iam:DeactivateMFADevice\u0026quot; + Condition = { + Bool = { + \u0026quot;aws:MultiFactorAuthPresent\u0026quot; = \u0026quot;true\u0026quot; } + NumericLessThan = { + \u0026quot;aws:MultiFactorAuthAge\u0026quot; = \u0026quot;3600\u0026quot; } } + Effect = \u0026quot;Allow\u0026quot; + Resource = [ + \u0026quot;arn:aws:iam::706136188012:user/*/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:user/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:mfa/${aws:username}\u0026quot;, ] + Sid = \u0026quot;AllowDeactivateMFADevice\u0026quot; }, ] + Version = \u0026quot;2012-10-17\u0026quot; } ) + policy_id = (known after apply) + tags_all = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_group.this[0] will be created + resource \u0026quot;aws_iam_group\u0026quot; \u0026quot;this\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = \u0026quot;full-access\u0026quot; + path = \u0026quot;/\u0026quot; + unique_id = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_group_membership.this[0] will be created + resource \u0026quot;aws_iam_group_membership\u0026quot; \u0026quot;this\u0026quot; { + group = (known after apply) + id = (known after apply) + name = \u0026quot;full-access\u0026quot; + users = [ + \u0026quot;Administrator\u0026quot;, ] } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.custom_arns[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;custom_arns\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = \u0026quot;arn:aws:iam::aws:policy/AdministratorAccess\u0026quot; } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.iam_self_management[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;iam_self_management\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_policy.iam_self_management[0] will be created + resource \u0026quot;aws_iam_policy\u0026quot; \u0026quot;iam_self_management\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = (known after apply) + name_prefix = \u0026quot;IAMSelfManagement-\u0026quot; + path = \u0026quot;/\u0026quot; + policy = jsonencode( { + Statement = [ + { + Action = [ + \u0026quot;iam:UploadSigningCertificate\u0026quot;, + \u0026quot;iam:UploadSSHPublicKey\u0026quot;, + \u0026quot;iam:UpdateUser\u0026quot;, + \u0026quot;iam:UpdateLoginProfile\u0026quot;, + \u0026quot;iam:UpdateAccessKey\u0026quot;, + \u0026quot;iam:ResyncMFADevice\u0026quot;, + \u0026quot;iam:List*\u0026quot;, + \u0026quot;iam:Get*\u0026quot;, + \u0026quot;iam:GenerateServiceLastAccessedDetails\u0026quot;, + \u0026quot;iam:GenerateCredentialReport\u0026quot;, + \u0026quot;iam:EnableMFADevice\u0026quot;, + \u0026quot;iam:DeleteVirtualMFADevice\u0026quot;, + \u0026quot;iam:DeleteLoginProfile\u0026quot;, + \u0026quot;iam:DeleteAccessKey\u0026quot;, + \u0026quot;iam:CreateVirtualMFADevice\u0026quot;, + \u0026quot;iam:CreateLoginProfile\u0026quot;, + \u0026quot;iam:CreateAccessKey\u0026quot;, + \u0026quot;iam:ChangePassword\u0026quot;, ] + Effect = \u0026quot;Allow\u0026quot; + Resource = [ + \u0026quot;arn:aws:iam::706136188012:user/*/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:user/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:mfa/${aws:username}\u0026quot;, ] + Sid = \u0026quot;AllowSelfManagement\u0026quot; }, + { + Action = [ + \u0026quot;iam:List*\u0026quot;, + \u0026quot;iam:Get*\u0026quot;, ] + Effect = \u0026quot;Allow\u0026quot; + Resource = \u0026quot;*\u0026quot; + Sid = \u0026quot;AllowIAMReadOnly\u0026quot; }, + { + Action = \u0026quot;iam:DeactivateMFADevice\u0026quot; + Condition = { + Bool = { + \u0026quot;aws:MultiFactorAuthPresent\u0026quot; = \u0026quot;true\u0026quot; } + NumericLessThan = { + \u0026quot;aws:MultiFactorAuthAge\u0026quot; = \u0026quot;3600\u0026quot; } } + Effect = \u0026quot;Allow\u0026quot; + Resource = [ + \u0026quot;arn:aws:iam::706136188012:user/*/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:user/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:mfa/${aws:username}\u0026quot;, ] + Sid = \u0026quot;AllowDeactivateMFADevice\u0026quot; }, ] + Version = \u0026quot;2012-10-17\u0026quot; } ) + policy_id = (known after apply) + tags_all = (known after apply) } # module.iam_user[\u0026quot;Accounting\u0026quot;].aws_iam_user.this[0] will be created + resource \u0026quot;aws_iam_user\u0026quot; \u0026quot;this\u0026quot; { + arn = (known after apply) + force_destroy = false + id = (known after apply) + name = \u0026quot;Accounting\u0026quot; + path = \u0026quot;/\u0026quot; + tags_all = (known after apply) + unique_id = (known after apply) } Plan: 11 to add, 0 to change, 0 to destroy. aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt apply çœ¼å°–çš„åŒå­¸æ‡‰è©²æœ‰æ³¨æ„åˆ°æˆ‘å€‘æŠŠ create_login_profile = false å…ˆé—œæ‰\nå› ç‚ºæˆ‘å€‘é‚„æ²’æœ‰æº–å‚™ pgp keyï¼Œé€™å€‹åˆè¦æ˜å¤©å†ä¾†äº† TODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-17-14th-ithome-ironman-iac-aws-workshop-06-provision-iam-group-policy/","summary":"\u003cp\u003eæ˜¨å¤©æˆ‘å€‘å°‡ root account IAM user import åˆ° terraform ä¸­\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç¤ºç¯„ terraform import\u003c/li\u003e\n\u003cli\u003eå¢åŠ  iam user çš„åŠŸèƒ½åˆ° module repository ä¸­\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä»Šå¤©è¦å®Œæˆ root account ä¸­ IAM Group + Policyï¼Œé †ä¾¿èŠèŠ aws IAM policy ç®¡ç†åŸå‰‡\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e root ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput checked=\"\" disabled=\"\" type=\"checkbox\"\u003e å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e è£œä¸Š root account IAM Policy\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e è£œä¸Š root account IAM Group\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eæ‰¿æ¥æ˜¨å¤©çš„ plan çµæœï¼Œæˆ‘å€‘ä»Šå¤©è¦æŠŠ IAM policy èˆ‡ group é–‹å‡ºä¾†\u003c/p\u003e","title":"Provision Iam Group Policy"},{"content":"æ˜¨å¤©æˆ‘å€‘ç‚ºæ¯å€‹ç’°å¢ƒ(dev / stag / prod \u0026hellip;) è¨­å®šä¸€å€‹ aws organization account\nä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS IAM User\nroot ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User åŠ åˆ° terraform ä¸­ security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nAccounts \u0026amp; IAM Users ä»Šå¤©è¦ä½¿ç”¨ Terraform è¨­å®š IAM Usersã€‚\næœªä¾†æ‰€æœ‰çš„ User éƒ½æœƒé€é terraform è¨­å®šä¸¦ç®¡ç† Day02 è¨­å®šçš„ root account IAM User: Administrator é›–ç„¶æ˜¯æ‰‹å‹•å»ºç«‹çš„ï¼Œæˆ‘å€‘ä¸€æ¨£éœ€è¦æŠŠä»–åŒ¯å…¥åˆ° terraform ä¸­ ç„¶è€Œä¸Šå€‹ PR ä¸­ï¼Œæˆ‘å€‘çš„ terraform module ä¸­ä¸¦æ²’æœ‰è¨­å®š IAM User çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯é€™æ®µ code æ˜¯æ²’æœ‰ç™¼æ®åŠŸèƒ½ https://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/1/files#diff-62920ff868733e1c625c23fe7ffd6c93bebd87ae16b865869bf682e29b082a99R54-R67\nusers = { alice = { groups = [\u0026quot;full-access\u0026quot;] pgp_key = \u0026quot;keybase:alice\u0026quot; create_login_profile = true create_access_keys = false }, bob = { groups = [\u0026quot;billing\u0026quot;] pgp_key = \u0026quot;keybase:bob\u0026quot; create_login_profile = true create_access_keys = false } } æˆ‘å€‘é€™é‚Šä¸€æ¨£å˜—è©¦æŠŠé€™å€‹ users (map) çš„åŠŸèƒ½è£œä¸Š\nä½¿ç”¨é–‹æº module å¯¦ä½œ IAM User ä½¿ç”¨çš„é–‹æº terraform module æ˜¯ terraform-aws-modules/terraform-aws-iam æ˜¯ aws å®˜æ–¹ç¶­è­·çš„é–‹æº terraform moduleï¼Œå“è³ªå¾ˆå¥½ï¼Œæ”¾å¿ƒä½¿ç”¨ éœ€æ±‚æ•´ç†\nè¦ç”¢ç”Ÿ IAM User input: ä¸€å€‹ map users = {} output: å¤šå€‹ user è¦ç”¢ç”Ÿ IAM Group èˆ‡ IAM Policy å¢åŠ  IAM User PR çš„ commit åœ¨æ­¤ https://github.com/chechiachang/terragrunt-infrastructure-modules/pull/1\næ–¼æ˜¯æˆ‘å€‘è©¦è‘—åŸ·è¡Œ terraform plan\naws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # module.iam_group_with_policies_full_access.aws_iam_group.this[0] will be created + resource \u0026quot;aws_iam_group\u0026quot; \u0026quot;this\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = \u0026quot;full-access\u0026quot; + path = \u0026quot;/\u0026quot; + unique_id = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_group_membership.this[0] will be created + resource \u0026quot;aws_iam_group_membership\u0026quot; \u0026quot;this\u0026quot; { + group = (known after apply) + id = (known after apply) + name = \u0026quot;full-access\u0026quot; + users = [ + \u0026quot;Administrator\u0026quot;, ] } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.custom_arns[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;custom_arns\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = \u0026quot;arn:aws:iam::aws:policy/AdministratorAccess\u0026quot; } # module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment.iam_self_management[0] will be created + resource \u0026quot;aws_iam_group_policy_attachment\u0026quot; \u0026quot;iam_self_management\u0026quot; { + group = (known after apply) + id = (known after apply) + policy_arn = (known after apply) } # module.iam_group_with_policies_full_access.aws_iam_policy.iam_self_management[0] will be created + resource \u0026quot;aws_iam_policy\u0026quot; \u0026quot;iam_self_management\u0026quot; { + arn = (known after apply) + id = (known after apply) + name = (known after apply) + name_prefix = \u0026quot;IAMSelfManagement-\u0026quot; + path = \u0026quot;/\u0026quot; + policy = jsonencode( { + Statement = [ + { + Action = [ + \u0026quot;iam:UploadSigningCertificate\u0026quot;, + \u0026quot;iam:UploadSSHPublicKey\u0026quot;, + \u0026quot;iam:UpdateUser\u0026quot;, + \u0026quot;iam:UpdateLoginProfile\u0026quot;, + \u0026quot;iam:UpdateAccessKey\u0026quot;, + \u0026quot;iam:ResyncMFADevice\u0026quot;, + \u0026quot;iam:List*\u0026quot;, + \u0026quot;iam:Get*\u0026quot;, + \u0026quot;iam:GenerateServiceLastAccessedDetails\u0026quot;, + \u0026quot;iam:GenerateCredentialReport\u0026quot;, + \u0026quot;iam:EnableMFADevice\u0026quot;, + \u0026quot;iam:DeleteVirtualMFADevice\u0026quot;, + \u0026quot;iam:DeleteLoginProfile\u0026quot;, + \u0026quot;iam:DeleteAccessKey\u0026quot;, + \u0026quot;iam:CreateVirtualMFADevice\u0026quot;, + \u0026quot;iam:CreateLoginProfile\u0026quot;, + \u0026quot;iam:CreateAccessKey\u0026quot;, + \u0026quot;iam:ChangePassword\u0026quot;, ] + Effect = \u0026quot;Allow\u0026quot; + Resource = [ + \u0026quot;arn:aws:iam::706136188012:user/*/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:user/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:mfa/${aws:username}\u0026quot;, ] + Sid = \u0026quot;AllowSelfManagement\u0026quot; }, + { + Action = [ + \u0026quot;iam:List*\u0026quot;, + \u0026quot;iam:Get*\u0026quot;, ] + Effect = \u0026quot;Allow\u0026quot; + Resource = \u0026quot;*\u0026quot; + Sid = \u0026quot;AllowIAMReadOnly\u0026quot; }, + { + Action = \u0026quot;iam:DeactivateMFADevice\u0026quot; + Condition = { + Bool = { + \u0026quot;aws:MultiFactorAuthPresent\u0026quot; = \u0026quot;true\u0026quot; } + NumericLessThan = { + \u0026quot;aws:MultiFactorAuthAge\u0026quot; = \u0026quot;3600\u0026quot; } } + Effect = \u0026quot;Allow\u0026quot; + Resource = [ + \u0026quot;arn:aws:iam::706136188012:user/*/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:user/${aws:username}\u0026quot;, + \u0026quot;arn:aws:iam::706136188012:mfa/${aws:username}\u0026quot;, ] + Sid = \u0026quot;AllowDeactivateMFADevice\u0026quot; }, ] + Version = \u0026quot;2012-10-17\u0026quot; } ) + policy_id = (known after apply) + tags_all = (known after apply) } # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0] will be created + resource \u0026quot;aws_iam_user\u0026quot; \u0026quot;this\u0026quot; { + arn = (known after apply) + force_destroy = true + id = (known after apply) + name = \u0026quot;Administrator\u0026quot; + path = \u0026quot;/\u0026quot; + tags_all = (known after apply) + unique_id = (known after apply) } # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user_login_profile.this[0] will be created + resource \u0026quot;aws_iam_user_login_profile\u0026quot; \u0026quot;this\u0026quot; { + encrypted_password = (known after apply) + id = (known after apply) + key_fingerprint = (known after apply) + password = (known after apply) + password_length = 20 + password_reset_required = false + pgp_key = \u0026quot;keybase:alice\u0026quot; + user = \u0026quot;Administrator\u0026quot; } Plan: 7 to add, 0 to change, 0 to destroy. æœƒç”¢ç”Ÿå¹¾å€‹æ±è¥¿\nmodule.iam_user[\u0026quot;Administrator\u0026quot;] æ˜¯ä¸€å€‹ moduleï¼Œè£¡é ­ç”¢ç”Ÿ IAM User èˆ‡å…¶ä»– resource module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user_login_profile æˆ‘å€‘æœ‰é–‹å•Ÿ create login file çš„åƒæ•¸ï¼Œæ‰€ä»¥ aws terraform module ä¾¿ç”¢ç”Ÿ module.iam_group_with_policies_full_access.aws_iam_policy.iam_self_management æˆ‘å€‘æœ‰é–‹å•Ÿ create self management policyï¼Œæ‰€ä»¥ aws terraform module ä¾¿ç”¢ç”Ÿ module.iam_group_with_policies_full_access.aws_iam_group_policy_attachment é€éé€™å€‹ attachment å°‡ IAM policy é—œè¯åˆ° IAM groupï¼Œä¹Ÿå°±æ˜¯ group ä¸­æœ‰ attach æ­¤ full-access policy module.iam_group_with_policies_full_access.aws_iam_group æ˜¯ IAM Group: full-access module.iam_group_with_policies_full_access.aws_iam_group_membership å°‡ IAM User é—œè¯åˆ° IAM group ä¹Ÿå°±æ˜¯ user/Administrator å±¬æ–¼ group/full-access AWS è¨±å¤šè³‡æºçš„æè¿°éƒ½ç”¨ attachment çš„å½¢å¼æè¿°å…©å€‹å…ƒä»¶çš„é—œè¯\nuser + group -\u0026gt; group_membership group + policy -\u0026gt; group_policy_attachment åƒæ˜¯ RMDBS çš„é—œè¯ tableï¼Œæ›´æ”¹é—œè¯æ™‚ä¸¦ä¸æœƒå½±éŸ¿åˆ°å…©å€‹å…ƒä»¶æœ¬èº«çš„å…§å®¹ï¼Œèª¿æ•´é—œè¯å¾ˆå½ˆæ€§ Terraform Import ç”±æ–¼ Administrator æˆ‘å€‘ Day02 å·²ç¶“é€é web console å»ºç«‹ï¼Œç¾åœ¨ terraform plan å‡ºä¾†çš„çµæœå»ä¹Ÿæ˜¯è¦ create ä¸€å€‹ new userï¼Œé€™å€‹çµæœä¸æ˜¯æˆ‘å€‘æƒ³è¦çš„\nå› ç‚º web console ç”¢ç”Ÿçš„ User ä¸¦æ²’æœ‰åœ¨ terraform ä¸­ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯é›–ç„¶ AWS ä¸Š User ç¢ºå¯¦å­˜åœ¨ï¼Œä½† terraform ä¸­ä¸¦æ²’æœ‰ state ä¾†æè¿°é€™å€‹ Userï¼Œæ‰€ä»¥ Terraform ä¸çŸ¥é“é€™å€‹ plan create çš„ User å…¶å¯¦å°±æ˜¯ AWS console ä¸Šå·²ç¶“å­˜åœ¨çš„ Administrator ä¸åœ¨ terraform state çš„å…ƒä»¶ï¼Œterraform ä¾¿ç„¡æ³•ç®¡ç† è¦å°‡å·²ç¶“å­˜åœ¨çš„ AWS å…ƒä»¶ï¼Œç´å…¥ terraform state é€²è¡Œç®¡ç†ï¼Œé€™å€‹è¡Œç‚ºæˆ‘å€‘ç¨±ä½œ import\nç¾åœ¨æˆ‘å€‘è¦è©¦è‘— terraform import å·²ç¶“å­˜åœ¨çš„ User/Administrator\né¦–å…ˆï¼Œå…ˆåˆ° terraform registry å»æœå°‹ aws provider import çš„èªæ³•åŠåƒæ•¸ ç›´æ¥ google å…ƒä»¶çš„åç¨± terraform aws iam user é€šå¸¸å°±æœƒæ‰¾åˆ° æ²åˆ°é é¢æœ€åº•ä¸‹å°±å¯ä»¥çœ‹åˆ° import èªæ³• # terraform import aws_iam_user.lb loadbalancer terraform import \u0026lt;address\u0026gt; \u0026lt;username\u0026gt; é€™é‚Šçš„ address éœ€è¦å¡«å…¥ plan æ™‚é è¨ˆç”¢ç”Ÿçš„ resource aws_iam_user\nä¹Ÿå°±æ˜¯ module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0] é€™å€‹ address å‰›é–‹å§‹å­¸ terraform å¯èƒ½æœƒé‚„ä¸å¤ªæ¸…æ¥š address ç‚ºä½•æœƒé•·é€™æ¨£ï¼Œä¹…äº†å°±æœƒäº†è§£ å¯ä»¥å…ˆå¾æ‰¾åˆ° resource ä¸»é«”ç‚ºç›®æ¨™æ…¢æ…¢çœ‹\næ‰€è¬‚çš„ resource çš„ä¸»é«”ï¼Œå…¶å¯¦å°±æ˜¯ terraform çš„åŸºæœ¬å–®ä½ ä¸€å€‹ terraform resource å¯èƒ½å°±æ˜¯å°æ‡‰ä¸€å€‹ aws å…ƒä»¶ aws_iam_user -\u0026gt; iam_user aws_iam_policy -\u0026gt; iam_policy å»æ‰å‰é¢çš„ module èˆ‡å¾Œé¢çš„ index å°±å¯ä»¥æ‰¾åˆ° resource\n# å…¶ä¸­ aws_iam_user æ˜¯ terraform resource module.\u0026lt;module_name\u0026gt;.aws_iam_user.\u0026lt;iam_user_name\u0026gt;.\u0026lt;iam_user_index\u0026gt; # æˆ–æ˜¯é€™å€‹ address ä¸­ aws_iam_policy æ˜¯ terraform resource module.\u0026lt;module_name\u0026gt;.aws_iam_policy.\u0026lt;iam_user_name\u0026gt;.\u0026lt;iam_user_index\u0026gt; # module å¯ä»¥åœ¨åŒ…å…¶ä»– moduleï¼Œæ‰€ä»¥æ¶æ§‹è¤‡é›œçš„ terraform moduleï¼Œresource address å°±æ„ˆä¾†è¶Šé•· module.\u0026lt;module_name\u0026gt;.module.\u0026lt;module_name\u0026gt;.aws_iam_user.\u0026lt;iam_user_name\u0026gt;.\u0026lt;iam_user_index\u0026gt; æœ€ä¸Šå±¤çš„ resource æ˜¯ module/iam_user[*]ï¼Œå°æ‡‰çš„ .tf code æ˜¯ user.tf\nmodule \u0026quot;iam_user\u0026quot; { source = \u0026quot;terraform-aws-modules/iam/aws//modules/iam-user\u0026quot; for_each = var.users name = each.key force_destroy = true create_iam_user_login_profile = each.value.create_login_profile create_iam_access_key = each.value.create_access_keys pgp_key = each.value.pgp_key password_reset_required = false } module/iam_user ä¸­åŒ…å«äº†è¨±å¤š terraform resource aws_iam_user æ˜¯åŸºæœ¬ resource aws_iam_user.this[0] å¾Œé¢å¤šäº† index suffixï¼Œæ˜¯å› ç‚ºå¯èƒ½åœ¨ module ä¸­æœ‰ä½¿ç”¨ count æˆ– for_eachï¼Œé€ æˆä¸€å€‹ list çš„ aws_iam_userï¼Œè€Œå…¶ä¸­ index ç‚º 0 çš„å°±æ˜¯ aws_iam_user.this[0] terraform æ”¯æ´è¨±å¤šå¥½ç”¨çš„ build-in function è®“æˆ‘å€‘å¯ä»¥å¿«é€Ÿçš„ä½¿ç”¨ï¼Œç”¢ç”Ÿè¤‡é›œçš„é‚è¼¯ï¼Œé€™å€‹ä¹‹å¾Œæœ‰ç©ºæœƒæ•™å¤§å®¶ã€‚æˆ–æ˜¯åƒè€ƒ 2021 iThome çš„ç™¼æ–‡: infrastructure ä¹Ÿå¯ä»¥ for each ä¹‹ä¸€\nå›åˆ° importï¼Œæˆ‘å€‘æŠŠ terraform import address name æ•¸å…¥å¾Œï¼Œç™¼ç¾å‡ºéŒ¯\n# Bash syntax error aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt import module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0] Administrator zsh: no matches found: module.iam_user[Administrator].aws_iam_user.this[0] é€™æ˜¯å› ç‚ºæœ‰äº› address å­—å…ƒ bash ä¸­æœ‰å…¶ä»–æ„ç¾©çš„ç‰¹æ®Šå­—å…ƒï¼Œbash å…ˆçœ‹ä¸æ‡‚äº†ï¼Œå°±ç„¡æ³•åŸ·è¡Œï¼Œé‚„æ²’è·‘åˆ° terragruntã€‚æˆ‘å€‘æŠŠ address å‰å¾Œéƒ½å¢åŠ å–®å¼•è™Ÿï¼Œè®“ bash æŠŠ address ç•¶ä½œå­—ä¸²è™•ç†è€Œä¸è¦å±•é–‹ (expension)\n# Add single quote to escape taws-vault exec terraform-30day-root-iam-user --no-session -- erragrunt import 'module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0]' Administrator module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0]: Importing from ID \u0026quot;Administrator\u0026quot;... module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0]: Import prepared! Prepared aws_iam_user for import module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0]: Refreshing state... [id=Administrator] Import successful! The resources that were imported are shown above. These resources are now in your Terraform state and will henceforth be managed by Terraform. Releasing state lock. This may take a few moments... é¡¯ç¤ºç‚º Import Success äº†ï¼Œå°±è¡¨ç¤ºæˆ‘å€‘å·²ç¶“æŠŠ aws å­˜åœ¨çš„ user import åˆ° terraform state ä¸­\nå†æ¬¡ planï¼Œç™¼ç¾å¾ Plan: 7 to addï¼Œè®Šæˆ Plan: 6 to add, 1 to change\nè¡¨ç¤º terraform çŸ¥é“ plan ä¸­çš„ address è¦ç›´æ¥å°æ‡‰åˆ° aws ç¾å­˜çš„ user/Administrator change ä¸­é¡¯ç¤º + force_destroy = true è¡¨ç¤º aws ç¾å­˜çš„ user/Administrator æ²’æœ‰é€™å€‹è¨­å®š .tf çš„ module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0] æœ‰é€™è¡Œ code terraform plan ç™¼ç¾ .tf æ¯”ç¾å­˜çš„ user/Administrator å¤šè¨­å®šï¼Œæ–¼æ˜¯è¦å¤šåŠ è¨­å®š æˆ‘å€‘å¯ä»¥ä¾æ“šéœ€æ±‚ï¼Œæ±ºå®šè¦ æ›´æ”¹ .tfï¼Œæ‹¿æ‰ + force_destroy = trueï¼Œé€™æ¨£ plan å¾Œ terraform å°±æœƒè¦ºå¾—å…©é‚Šçš„ user/Administrator ä¸€æ¨¡å£¹æ¨£ï¼Œä¸éœ€è¦ change æˆ–æ˜¯å°±ç›´æ¥ apply ï¼Œè®“ç¾å­˜çš„ user/Administrator å¢åŠ  + force_destroy = true aws-vault exec terraform-30day-root-iam-user --no-session -- terragrunt plan # module.iam_user[\u0026quot;Administrator\u0026quot;].aws_iam_user.this[0] will be updated in-place ~ resource \u0026quot;aws_iam_user\u0026quot; \u0026quot;this\u0026quot; { + force_destroy = true id = \u0026quot;Administrator\u0026quot; name = \u0026quot;Administrator\u0026quot; tags = {} # (4 unchanged attributes hidden) } Plan: 6 to add, 1 to change, 0 to destroy. TODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts root ä¸­è¨­å®š IAM User å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User import terraform ä¸­ è£œä¸Š root account IAM Policy è£œä¸Š root account IAM Group security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-16-14th-ithome-ironman-iac-aws-workshop-05-provision-iam-user/","summary":"\u003cp\u003eæ˜¨å¤©æˆ‘å€‘ç‚ºæ¯å€‹ç’°å¢ƒ(dev / stag / prod \u0026hellip;) è¨­å®šä¸€å€‹ aws organization account\u003c/p\u003e\n\u003cp\u003eä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS IAM User\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e root ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e å°‡æ‰‹å‹•ç”¢ç”Ÿçš„ Administrator çš„ IAM User åŠ åˆ° terraform ä¸­\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security ä¸­è¨­å®š IAM User\n\u003cul\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security è¨­å®š password policy\u003c/li\u003e\n\u003cli\u003e\u003cinput disabled=\"\" type=\"checkbox\"\u003e security è¨­å®š MFA policy\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003ch1 id=\"accounts--iam-users\"\u003eAccounts \u0026amp; IAM Users\u003c/h1\u003e\n\u003cp\u003eä»Šå¤©è¦ä½¿ç”¨ Terraform è¨­å®š IAM Usersã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæœªä¾†æ‰€æœ‰çš„ User éƒ½æœƒé€é terraform è¨­å®šä¸¦ç®¡ç†\u003c/li\u003e\n\u003cli\u003eDay02 è¨­å®šçš„ root account IAM User: Administrator é›–ç„¶æ˜¯æ‰‹å‹•å»ºç«‹çš„ï¼Œæˆ‘å€‘ä¸€æ¨£éœ€è¦æŠŠä»–åŒ¯å…¥åˆ° terraform ä¸­\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç„¶è€Œä¸Šå€‹ PR ä¸­ï¼Œæˆ‘å€‘çš„ terraform module ä¸­ä¸¦æ²’æœ‰è¨­å®š IAM User çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯é€™æ®µ code æ˜¯æ²’æœ‰ç™¼æ®åŠŸèƒ½\n\u003ca href=\"https://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/1/files#diff-62920ff868733e1c625c23fe7ffd6c93bebd87ae16b865869bf682e29b082a99R54-R67\"\u003ehttps://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/1/files#diff-62920ff868733e1c625c23fe7ffd6c93bebd87ae16b865869bf682e29b082a99R54-R67\u003c/a\u003e\u003c/p\u003e","title":"Provision Iam User"},{"content":"æ˜¨å¤©è¨­å®šäº†å¤šå€‹ aws organization accountsï¼Œä½†æˆ‘å€‘é‚„æ²’æœ‰èªªæ˜ç‚ºä»€éº¼è¦é€™æ¨£åš\nä»Šå¤©æœƒå…ˆè¬› Gruntwork æå‡ºçš„ Production-Grade Design: multi-account security strategy\næ‹†åˆ†å¤šå€‹ account çš„ç”¨æ„ å¤š account ä¸‹å¦‚ä½•çµ±ä¸€ç®¡ç† IAM User access control èˆ‡å®‰å…¨æ€§æ§ç®¡ iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\nProduction-grade Design IAM Gruntwork æå‡ºçš„ Production-Grade Design: multi-account security strategyï¼Œæˆ‘å€‘é€™é‚Šä¸€ä¸€è¬›è§£\nRoot Account çš„ç”¨é€” ä½æ–¼ diagram åœ–ä¸­çš„æœ€ä¸Šå±¤ æ˜¯æ•´å€‹æ¶æ§‹çš„å‰µä¸–å¸³è™Ÿï¼Œæ¬Šé™æœ€å¤§ root account è£¡é¢æ²’æœ‰ä»»ä½• infrastructure å…ƒä»¶ï¼Œ i.e. aws ec2 ä¸æœƒé•·åœ¨è£¡é¢ï¼Œæ˜¯ä¸€å€‹ç©º account root account çš„å­˜å–æœ€åš´æ ¼ åªæœ‰å¾ˆå°‘æ•¸çš„ admin å¯ä»¥å­˜å– i.e åªæœ‰ SRE éƒ¨é–€ä¸»ç®¡æœ‰è‡ªå·±çš„ IAM Userï¼Œå…¶ä»– SRE æ²’æœ‰æ¬Šé™å­˜å– root account root account çš„å·¥ä½œæœ€å°‘ è¨­å®š child account ç®¡ç† billing IAM policy ç®¡ç†ï¼Œä¸è¦æŠŠ policy ç›´æ¥ç¶åœ¨ User ä¸Šï¼Œæ‡‰è©²è¦\nç‚ºä¸åŒæ¬Šè²¬çš„æˆå“¡è¨­å®š IAM Groupï¼Œex. dev-admin / dev-user / stag-admin / qa / billing / \u0026hellip; æŠŠ policy ç¶åœ¨ Group ä¸Šï¼Œex. ReadPermission -\u0026gt; dev-user / Read+Write -\u0026gt; dev-admin æŠŠ User åŠ é€² / ç§»é™¤ Groupï¼Œä¾†ç®¡ç†äººå“¡æ¬Šé™ Group é€šå¸¸æœƒæ¥è¿‘å…¬å¸åœ˜éšŠçš„è·è²¬åˆ†é… root account å…§éƒ¨åªæœƒæœ‰ full-access çš„ç®¡ç†å“¡ group billing çš„æœƒè¨ˆå‡ºå¸³ group Child Account çš„ç”¨é€” é€é root account å‰µå»º child accounts å¾Œï¼Œé€™è£¡èªªæ˜å„å€‹ account çš„è¨­è¨ˆç”¨é€”\nSecurity ç”¨ä¾†ç®¡ç† authentication èˆ‡ authorization\nåº•ä¸‹ä¸€æ¨£æ²’æœ‰ä»»ä½• infrastructure å…ƒä»¶ å®šç¾©æ‰€æœ‰ IAM User èˆ‡ IAM Groupï¼Œæ‰€æœ‰åœ˜éšŠæˆå“¡çš„ User åœ¨é€™é‚Šè¨­å®š æ‰€æœ‰çš„ User æ”¾åœ¨ Security åº•ä¸‹çµ±ä¸€ç®¡ç† å…¶ä»–çš„ child account ä¸æœƒè¨­å®š IAM Userï¼Œex. dev / stag / prod è£¡é¢éƒ½æ²’æœ‰ IAM User child account ä¸­è¨­å®š IAM rolesï¼Œè®“ security/user assume role å­˜å–å…¶ä»– child account ex. security/dev-admin/chechia assume role dev/adminï¼Œé€é aws STS(Security Token Service) æš«æ™‚å–å¾— dev/admin é€™å€‹ role çš„æ¬Šé™ä¾†æ§åˆ¶ dev åœ˜éšŠä¸»ç®¡ä¹Ÿæœƒæœ‰ä¸€å€‹ security IAM Userï¼Œå¹³æ™‚é–‹ç™¼ infrastructure ä½¿ç”¨é€™å€‹ IAM Userï¼Œåªæœ‰éœ€è¦èª¿æ•´ root account æ™‚æ‰æœƒå‹•ç”¨ root account IAM Userã€‚åæ­£ root account æ˜¯èƒ½ä¸ç”¨å°±ä¸ç”¨ é€™å€‹åšæ³•æœ‰éå¸¸å¤šå¥½è™•ï¼Œä½†åˆä¸æœƒé€ æˆå·¥ä½œä¸Šçš„è² æ“”\nä½¿ç”¨æ–¹é¢ï¼šæ‰€æœ‰çš„åœ˜éšŠæˆå“¡åªæœƒæœ‰ä¸€å€‹ Userï¼Œé€é security ç™»å…¥ã€‚ä¸æœƒä¸€å€‹äººæœ‰å¥½å¹¾å€‹å¸³è™Ÿå¯†ç¢¼å¾ˆç…© ç®¡ç†æ–¹é¢ï¼šç®¡ç†å“¡åªè¦åœ¨ security å…§ç®¡ç† Userï¼Œè€Œä¸ç”¨ä¸€ç›´åˆ‡æ› account å»èª¿æ•´ IAM User å®‰å…¨æ–¹é¢ï¼šåªè¦åœ¨ security å…§è½å¯¦å®‰å…¨æ€§è¨­å®šï¼Œå°±å¯ä»¥å¾ˆå¥½çš„æ§åˆ¶æ‰€æœ‰ account çš„å­˜å–æ¬Šé™ dev / stag / prod ç”¨ä¾†å­˜æ”¾ infrastructure èˆ‡è·‘ application\né–‹ç™¼æ™‚ä½¿ç”¨ dev / stag ç’°å¢ƒï¼Œæ¸¬è©¦éƒ½å®Œæˆå¾Œï¼Œæ‰è‡ªå‹•æ¨å€’ prod å…¬é–‹çµ¦ç”¨æˆ¶ä½¿ç”¨ dev / stag ç’°å¢ƒæ˜¯å…§éƒ¨ç’°å¢ƒï¼Œæ¶æ§‹èˆ‡ prod é¡ä¼¼ï¼Œä¾†æ¨¡æ“¬ prod çš„ç’°å¢ƒæ–¹ä¾¿é–‹ç™¼èˆ‡æ¸¬è©¦ å¯èƒ½æ©Ÿå™¨æ•¸é‡æˆ–è¦æ ¼æ¯” prod å°å¾ˆå¤šï¼Œä¾†ç¯€çœæˆæœ¬ æœ‰äº›åœ˜éšŠæœƒæœ‰æ›´å¤š accountï¼Œä¾‹å¦‚ qa / uat / \u0026hellip;ï¼Œéƒ½å¯ä»¥ä¾ç…§éœ€æ±‚å»ºç«‹ prod æœ‰äº›åœ˜éšŠæœƒæœ‰è¤‡æ•¸ prod ç’°å¢ƒï¼Œå¯ä»¥ä¾›ç½é›£ç™¼ç”Ÿæ™‚åšå‚™æ´åˆ‡æ› shared è£¡é¢æ”¾è·¨ application account å…±ç”¨çš„å…ƒä»¶\nä¾‹å¦‚ AWS ECR å¯èƒ½ä¸æƒ³è¦æ¯å€‹ account éƒ½é–‹ï¼Œæƒ³æ”¾ä¸€èµ·çš„è©±å¯ä»¥æ”¾åœ¨ sharedï¼Œç„¶å¾Œè®“å…¶ä»– account å­˜å– shared ç‰ˆæœ¬æ§åˆ¶ç³»çµ± Git / github å¯èƒ½æœƒåªæœ‰ä¸€çµ„å¤§å®¶å…±ç”¨ CI/CD pipeline / Jenkins \u0026hellip;ç­‰ç­‰è·¨ç’°å¢ƒå…±ç”¨çš„è³‡æºï¼Œå¯ä»¥æ”¾ shared æ¯å€‹ account éƒ½é–‹ä¹Ÿæ˜¯æœ‰è¨±å¤šå¥½è™•ï¼Œä¾‹å¦‚æ›´ç¨ç«‹æ›´å®‰å…¨ï¼Œé€™å°±çœ‹çœ‹å„å€‹åœ˜éšŠç½å®‰å…¨èˆ‡æˆæœ¬ä¸Šçš„å–æ¨ ç®¡ç†ä¸Šç”±æ–¼ prod æœƒä½¿ç”¨åˆ° shared çš„å…ƒä»¶ï¼Œå»ºè­°è¦æŠŠ shared çš„å®‰å…¨ç­‰ç´šç•¶ä½œ prod ä¾†ç®¡ç†ï¼Œåš´æ ¼é™åˆ¶ shared çš„å­˜å–ï¼Œä»¥ä¿è­· prod ç’°å¢ƒçš„å®‰å…¨ å¾ˆå¤šå€‹ sandbox account è®“å·¥ç¨‹å¸«è‡ªç”±çš„æ¸¬è©¦åŠŸèƒ½\nå¦‚æœæœ‰éœ€æ±‚èˆ‡é ç®—ï¼Œä¸€å€‹å®Œå…¨ç¨ç«‹çš„ sandbox è®“å·¥ç¨‹å¸«å¯ä»¥åšå„ç¨®å¯¦é©—ï¼Œå°æ–¼ä¿ƒé€²åœ˜éšŠå…§éƒ¨çš„å‰µæ–°æœƒæœ‰éå¸¸å¤§çš„å¹«åŠ© å¦‚æœåœ¨ dev ä¸Šåšé€™æ¸¬è©¦ï¼Œæœ‰å¯èƒ½æœƒå½±éŸ¿åˆ°å…¶ä»–åœ˜éšŠæˆå“¡ï¼Œè€Œè¦ºå¾—ç¶æ‰‹ç¶è…³çš„äº‹æƒ…ï¼Œéƒ½å¯ä»¥ç›¡æƒ…åœ¨ sandbox ä¸Šæ“ä½œ å¯ä»¥ç‚º sandbox çš„å¸³è™Ÿè¨­å®šæ›´åš´æ ¼çš„ billing / cost è¨­å®šï¼Œé¿å…å·¥ç¨‹å¸«ç©å¤ªå—¨è¶…éé ç®— é»ƒé‡‘æº–å‰‡æ˜¯ä¸€å€‹å·¥ç¨‹å¸«ä¸€å€‹ sandbox ä¾†é”åˆ° 100% é–‹ç™¼ç¨ç«‹ testing account ç”¨ä¾†æ¸¬è©¦ infrastructure çš„æ¸¬è©¦\nå¦‚æœæœ‰ä½¿ç”¨ Gruntwork/Terratest ä¾†æ¸¬è©¦ terraform tf code çš„æœ‹å‹ï¼Œæ‡‰è©²çŸ¥é“ terratest æœƒæŠŠ terraform module ä¸­çš„ infrastrcuture çœŸçš„åœ¨ aws é–‹å‡ºä¾†ï¼ŒåšåŠŸèƒ½æ¸¬è©¦ï¼Œç„¶å¾Œæ¸¬è©¦å®Œæˆå¾Œå†æŠŠ infrastrcture å…¨éƒ¨åˆªæ‰ æ˜¯çš„ IaC terraform module ä¹Ÿæ˜¯éœ€è¦å–®å…ƒæ¸¬è©¦ testing å°±æ˜¯ç”¨ä¾†è®“ IaC åšè‡ªå‹•åŒ–æ¸¬è©¦çš„ç’°å¢ƒï¼Œè£¡é¢çš„ infrastructure éƒ½æ˜¯å¸¸å¸¸ create + destroyï¼Œä¸æœƒæœ‰å¸¸é§çš„æœå‹™ èˆ‡ sandbox ä¸åŒçš„æ˜¯ testing æ˜¯è·‘è‡ªå‹•åŒ– CI/CD pipeline çš„æ¸¬è©¦ sandbox æ˜¯è®“å·¥ç¨‹å¸«åšè¦æ¨¡è¼ƒå°çš„æ‰‹å‹•æ¸¬è©¦èˆ‡é–‹ç™¼ï¼Œå› ç‚ºæˆ‘å€‘ä¹Ÿä¸å¸Œæœ›ä¸€å †æ¸¬è©¦ç”¨ infrastructure æ•£è½åœ¨ sandbox è£¡é¢ï¼Œæ„Ÿè¦ºå¾ˆè²´ logs ç”¨ä¾†æ”¶é›† log åˆ°å–®ä¸€ account åº•ä¸‹ï¼Œæ–¹ä¾¿æŸ¥é–±\næ‰€æœ‰ child account çš„ log éƒ½æ”¶åˆ°é€™è£¡ï¼Œè€Œä¸ç”¨è·‘åˆ°å„å€‹ account å»æŸ¥ log aws account å…§éƒ¨çš„ logï¼Œcloud trail éƒ½å¯ä»¥é€éå®¢è¨‚èˆ‡å·¥å…·è½‰ç™¼ï¼Œé›†ä¸­æ”¶é›† å¦‚æœå…¬å¸è¦æ¨¡å¾ˆå¤§ï¼Œæœ‰å¤šå€‹ business unit çš„è©±ï¼Œä¹Ÿå¯ä»¥å¤šå»ºå¹¾å€‹ organizationï¼Œä¾†å°æ‡‰å…¬å¸çµ„ç¹”\né€é web console switch role æˆ‘æ˜¯ä¸€å€‹é–‹ç™¼å·¥ç¨‹å¸«ï¼ˆä¸æ˜¯ adminï¼‰ï¼Œé‚£åœ¨ multi-account ä¸‹çš„ç’°å¢ƒæˆ‘æ‡‰è©²å¦‚ä½•å·¥ä½œï¼Ÿ\nå¦‚ä½•å­˜å– aws\nIAM User å¯ä»¥é€éå¸³è™Ÿå¯†ç¢¼ä¾†å­˜å– aws web consoleï¼Œç™»å…¥ä¹‹å¾Œæœƒç™¼ç¾è‡ªå·±è™•åœ¨ security account åº•ä¸‹ ç¬¬ä¸€æ¬¡ç™»å…¥çš„è©±éœ€è¦é‡è¨­å¯†ç¢¼ï¼Œéœ€è¦ç¬¦åˆ IAM Password Policy æœƒéœ€è¦è¼¸å…¥ MFAï¼Œæœƒéœ€è¦ç¬¦åˆ IAM MFA Policy å…©é¢çš„å®‰å…¨æ€§ policy åœ¨å¯¦éš›å…¬å¸å¸³è™Ÿè£¡æ˜¯å¿…å‚™ï¼Œä½†åœ¨ workshop ä¸­ï¼Œæˆ‘å€‘é‚„æ²’åšï¼Œå…ˆç•™å€‹å‘ä¹‹å¾Œä¾†è£œ programatic access å¦‚åŒ day03 çš„ root account IAM User æ­¥é©Ÿï¼Œæˆ‘å€‘ä¹Ÿæ˜¯ä½¿ç”¨ aws-vault æ­é… aws access keyï¼Œä¾†è®“ terraform åŸ·è¡Œ web console å¦‚ä½• switch role\nå¯ä»¥åœ¨ aws web console -\u0026gt; å³ä¸Šè§’ user -\u0026gt; switch role å¡«å…¥\nç›®æ¨™ account ID (ex dev: 123456789012) ç›®æ¨™çš„ role çµ¦è‡ªå·±çœ‹çš„å¥½è¾¨è­˜åç¨± å¦‚æœ admin æœ‰è¨­å®š IAM role èˆ‡ assume role æ¬Šé™ï¼Œå°±å¯ä»¥åˆ‡æ›åˆ° dev account ä¸‹çš„ IAM role èº«åˆ† é€é web console switch role å¦‚åŒ day03 ä½¿ç”¨ root account IAM Userï¼Œæˆ‘å€‘ä¹Ÿæ˜¯ä½¿ç”¨ aws-vault æ­é… aws access keyï¼Œä¾†è®“ terraform åŸ·è¡Œ) ä¾†è·‘ terraform å»ºç«‹ child accounts ä¸€æ¨£ï¼Œæˆ‘å€‘ä¹Ÿéœ€è¦è¨­å®š aws-vaultï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨ local æ©Ÿä¸Š assume ä¸åŒ account roleï¼Œä¾†ä½¿ç”¨å„å€‹ child account\naws-vault Roles and MFA éœ€è¦èª¿æ•´ ~/.aws/config çš„è¨­å®š\nsecurity ç®¡ç†å“¡è¨­å®šå®Œ iam role + assume policy å¾Œï¼Œæœƒæä¾›ç™»å…¥è³‡è¨Šçµ¦å…¶ä»–åœ˜éšŠæˆå“¡ cat ~/.aws/config # é€™æ˜¯ root account IAM User ä¸è¦å†æ‹¿ä¾†ç”¨äº† # aws access key æ”¶åœ¨æœ¬æ©Ÿçš„ aws-vault å…§ [profile terraform-30day-root-iam-user] region=ap-northeast-1 # é€™æ˜¯ security account (111111111111) IAM Userï¼ˆé‚„æ²’å»ºç«‹ï¼‰ # aws access key æ”¶åœ¨æœ¬æ©Ÿçš„ aws-vault å…§ [profile chechia-security-iam-user] region=ap-northeast-1 # é€™æ˜¯ dev account (333333333333) IAM Roleï¼ˆé‚„æ²’å»ºç«‹ï¼‰ [profile dev-admin] source_profile = chechia-security-iam-user role_arn = arn:aws:iam::333333333333:role/dev-admin mfa_serial = arn:aws:iam::111111111111:mfa/chechia-security-iam-user ä¸Šé¢é€™äº›éƒ½é‚„æ²’å»ºç«‹ï¼Œæ‰€ä»¥éƒ½é‚„ä¸èƒ½ç”¨ï¼Œåªæ˜¯å…ˆèªªä¸€ä¸‹ä¹‹å¾Œè¦æ€éº¼æ“ä½œ\nsecurity ç®¡ç†å“¡è¦è¨­å®šä¸€å¤§å †æ±è¥¿ï¼Œä½†å·¥ç¨‹å¸«ä½¿ç”¨éå¸¸ç°¡å–®ï¼Œåªè¦é€é aws-vault åˆ‡æ›å°±å¯ä»¥åœ¨ä¸åŒ account ä¸‹æ“ä½œ terraform\naws-vault exec dev-admin -- aws sts get-caller-identity { \u0026quot;UserId\u0026quot;: \u0026quot;xxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;Account\u0026quot;: \u0026quot;333333333333\u0026quot;, \u0026quot;Arn\u0026quot;: \u0026quot;arn:aws:iam::333333333333:role/dev-admin\u0026quot; } aws-vault exec dev-admin -- terragrunt plan aws-vault exec stag-admin -- terragrunt plan ... å…¶ä»– Cloudtrail\n12 month free-tier æ˜¯å¯ä»¥å…è²»ä½¿ç”¨çš„ log å­˜æ”¾åœ¨ s3 ä¸Šï¼Œæœƒéœ€è¦æ”¶å– s3 çš„è²»ç”¨ï¼Œ12 month free-tier s3 æ˜¯ 5Gï¼Œæˆ‘å€‘é€™å€‹ workshop ä¸æœƒè¶…é note: terraform state ä¹Ÿæ˜¯æ”¾åœ¨ s3 ä¸Š TODO èˆ‡é€²åº¦ é€é root account è¨­å®šä¸€çµ„ IAM User é€é root account è¨­å®šå¤šå€‹ aws child accounts security ä¸­è¨­å®š IAM User security è¨­å®š password policy security è¨­å®š MFA policy security ä¸­è¨­å®š IAM Policy \u0026amp; Group dev ä¸­è¨­å®š IAM role å…è¨± security assume dev IAM role ","permalink":"https://chechia.net/posts/2022-09-15-14th-ithome-ironman-iac-aws-workshop-04-aws-multi-account-structure/","summary":"\u003cp\u003eæ˜¨å¤©è¨­å®šäº†å¤šå€‹ aws organization accountsï¼Œä½†æˆ‘å€‘é‚„æ²’æœ‰èªªæ˜ç‚ºä»€éº¼è¦é€™æ¨£åš\u003c/p\u003e\n\u003cp\u003eä»Šå¤©æœƒå…ˆè¬› Gruntwork æå‡ºçš„ \u003ca href=\"https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/intro\"\u003eProduction-Grade Design: multi-account security strategy\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ‹†åˆ†å¤šå€‹ account çš„ç”¨æ„\u003c/li\u003e\n\u003cli\u003eå¤š account ä¸‹å¦‚ä½•çµ±ä¸€ç®¡ç† IAM User\u003c/li\u003e\n\u003cli\u003eaccess control èˆ‡å®‰å…¨æ€§æ§ç®¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003ch1 id=\"production-grade-design-iam\"\u003eProduction-grade Design IAM\u003c/h1\u003e\n\u003cp\u003eGruntwork æå‡ºçš„ \u003ca href=\"https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/intro\"\u003eProduction-Grade Design: multi-account security strategy\u003c/a\u003eï¼Œæˆ‘å€‘é€™é‚Šä¸€ä¸€è¬›è§£\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Multi-account security strategy\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20220918/20120327GL49e7CTD0.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"root-account-çš„ç”¨é€”\"\u003e\u003ca href=\"https://docs.gruntwork.io/guides/build-it-yourself/landing-zone/production-grade-design/the-root-account\"\u003eRoot Account\u003c/a\u003e çš„ç”¨é€”\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eä½æ–¼ diagram åœ–ä¸­çš„æœ€ä¸Šå±¤\u003c/li\u003e\n\u003cli\u003eæ˜¯æ•´å€‹æ¶æ§‹çš„å‰µä¸–å¸³è™Ÿï¼Œæ¬Šé™æœ€å¤§\u003c/li\u003e\n\u003cli\u003eroot account è£¡é¢æ²’æœ‰ä»»ä½• infrastructure å…ƒä»¶ï¼Œ i.e. aws ec2 ä¸æœƒé•·åœ¨è£¡é¢ï¼Œæ˜¯ä¸€å€‹ç©º account\u003c/li\u003e\n\u003cli\u003eroot account çš„å­˜å–æœ€åš´æ ¼\n\u003cul\u003e\n\u003cli\u003eåªæœ‰å¾ˆå°‘æ•¸çš„ admin å¯ä»¥å­˜å–\n\u003cul\u003e\n\u003cli\u003ei.e åªæœ‰ SRE éƒ¨é–€ä¸»ç®¡æœ‰è‡ªå·±çš„ IAM Userï¼Œå…¶ä»– SRE æ²’æœ‰æ¬Šé™å­˜å– root account\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eroot account çš„å·¥ä½œæœ€å°‘\n\u003cul\u003e\n\u003cli\u003eè¨­å®š child account\u003c/li\u003e\n\u003cli\u003eç®¡ç† billing\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIAM policy ç®¡ç†ï¼Œä¸è¦æŠŠ policy ç›´æ¥ç¶åœ¨ User ä¸Šï¼Œæ‡‰è©²è¦\u003c/p\u003e","title":"AWS Multi-Accounts Structure"},{"content":"ä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\n\u0026ndash;\nProvision AWS Account\nä»Šå¤©è¦æŠŠ aws account è¨­å®šå®Œæˆï¼Œä¸¦ä¸”é–‹å§‹ä½¿ç”¨ live-repository ä¾†æ­å»º aws å…ƒä»¶\næˆ‘å€‘è‡ªå·±çš„ module repository é–‹ä¸€å€‹æ¬Šé™çš„ repository fork æˆ‘è‡ªå¹¹çš„ modules repository terragrunt-infrastructure-modules https://github.com/chechiachang/terragrunt-infrastructure-modules ä¸Šé¢é€™å€‹æ˜¯æ”¾ terraform module çš„ repositoryï¼Œæ˜¯å…©å€‹ repository ä¸è¦è·ŸåŸ·è¡Œ terragrunt repository ææ··ï¼Œæ˜¯å…©å€‹ repository https://github.com/chechiachang/terragrunt-infrastructure-live-example ä»Šå¤©çš„é€²åº¦èˆ‡ code base\nterraform-live-example PR åœ¨æ­¤ terragrunt-infrastructure-modules è«‹ç›´æ¥çœ‹ tag v0.0.1 å› ç‚ºæœ‰åœ°æ–¹åš´é‡å¯«éŒ¯ï¼Œæˆ‘æœ‰ force push æ±è¥¿ :tear:ï¼Œå¦‚æœå·²ç¶“ææ—©ä¸‹è¼‰çš„æœ‹å‹å¯èƒ½æœƒéœ€è¦æ¸…æ‰ repository main branch + tag é‡æ‹‰ orz å°ï¼Œæˆ‘å€‘ä¸”æˆ°ä¸”èµ°å¸¸å¸¸æœƒé€™æ¨£ï¼Œç™¼ç¾æ˜¨å¤©å¯«çš„æ±è¥¿å¯«éŒ¯è‡¨æ™‚æ”¹ï¼Œè«‹å¤§å®¶è¦‹è«’\nç‚ºä½•ä½¿ç”¨ aws modules X) å› ç‚ºæˆ‘å€‘æ²’æœ‰ä»˜éŒ¢ï¼Œä¸èƒ½ç”¨ gruntwork çš„ priviate repository (å¤§èª¤\nO) å› ç‚ºæˆ‘å€‘æƒ³è¦ä½¿ç”¨é–‹æºç‰ˆæœ¬çš„ terraform module (XD)\næˆ‘å€‘å¿«é€Ÿçœ‹ä¸€ä¸‹ module è£¡é¢çš„å…§å®¹ https://github.com/chechiachang/terragrunt-infrastructure-modules/tree/v0.0.1/aws/modules/account-baseline-root\nresource \u0026quot;aws_organizations_organization\u0026quot; \u0026quot;org\u0026quot; { aws_service_access_principals = [ \u0026quot;cloudtrail.amazonaws.com\u0026quot;, \u0026quot;config.amazonaws.com\u0026quot;, ] feature_set = \u0026quot;ALL\u0026quot; } resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { for_each = var.child_accounts name = each.key email = each.value[\u0026quot;email\u0026quot;] depends_on = [ aws_organizations_organization.org ] } æˆ‘å€‘çš„éœ€æ±‚\nåœ¨ root account ä¸‹ provision ä¸€å€‹ aws organization ç‚ºæ¯å€‹ç’°å¢ƒ provision ä¸€å€‹ aws organization account ä½¿ç”¨ terraform for_each function ä¾†è¿­ä»£ variabel å‚³å…¥çš„ organization accounts (å‹åˆ¥æ˜¯ map) each.key æœƒæ‹¿åˆ°æ¯å€‹ map element çš„ keyï¼Œä¾‹å¦‚ child_accounts = { logs = {}, security = {}, shared = {}, dev = {}, stage = {}, prod = {} } è·‘å‡ºä¾† each.key å°±æœƒæ˜¯ [logs, security, shared, dev, stage, prod] æ­£å¥½æ˜¯æˆ‘å€‘é€™æ¬¡éœ€è¦ provision çš„å…­å€‹ aws organization accountsï¼Œæ»¿è¶³ç›®å‰çš„éœ€æ±‚ each.value[\u0026ldquo;email\u0026rdquo;] å‰‡ä¾åºå¸¶å…¥å„è‡ªçš„ email åˆ° account ä¸­ NOTE: é€™äº› email è«‹ä½¿ç”¨ä½ æ”¶å¾—åˆ°çš„ email\nåœ¨ç¾å¯¦ä¸­é€™æœƒæ˜¯å…­çµ„ä¸åŒçš„ emailï¼Œemail é‡è¤‡çš„è©±æœƒè¢« aws api rejectï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸åŒçš„ email æˆ–æ˜¯è·Ÿ gruntwork guide ä¸€æ¨£ï¼Œä½¿ç”¨ gmail å¸³è™Ÿå¾Œ+ çš„å­—å…ƒæœƒ ignore å¦‚æœè¨­å®šäº†æ”¶ä¸åˆ°ä¿¡çš„ email ä½œç‚º account email å°±æœƒæœ‰é»éº»ç…© ä¸è¦åƒæˆ‘ä¸€æ¨£è¨­äº† 6 å€‹æ”¶ä¸åˆ° emailï¼Œåªå¥½å†å¤šé–‹ä¸€å€‹ account XDï¼Œé‚„å¥½æˆ‘å€‘æ˜¯åœ¨ workshop é€™å€‹ terraform module çš„å¯«æ³•å®Œå…¨å¿½ç•¥å…¶ä»– each.value å…§çš„å€¼\næˆ‘å€‘ä¸¦ä¸æ¸…æ¥š gruntwork åœ¨ private çš„ terraform module ä¸­ï¼Œé®äº›åƒæ•¸çš„ç¢ºåˆ‡ç”¨é€”ï¼Œä»¥åŠå° aws organization account è¨­å®šæœ‰ä½•å½±éŸ¿ ä½†ä»¥ç­†è€…ä½¿ç”¨ aws çš„ç¶“é©—ï¼Œå¤§æ¦‚çŒœå¾—å‡ºä¾†é€™äº›åƒæ•¸çš„ç”¨é€”ï¼Œä»¥åŠ terraform module æ‡‰è©²å¦‚ä½•èª¿æ•´ï¼Œç‚ºäº†èª²ç¨‹é€²åº¦å®‰æ’ï¼Œæˆ‘å€‘å…ˆæš«æ™‚å¿½ç•¥ã€‚ç¹¼çºŒç…§è‘— gruntwork çš„æ–‡ä»¶åšä¸‹å»ï¼Œä¹‹å¾Œæœ‰ç”¨åˆ°å†ä¾†è£œ Terragrunt Plan \u0026amp; apply åœ¨è·‘ terragrunt ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆè¦åˆ‡æ›æˆ root account çš„ iam Userï¼Œæ˜¨å¤©æ–°å»ºçš„ IAM Userï¼Œå­˜æ”¾åœ¨å¯†ç¢¼ä¼ç†ï¼Œé‚„è¨˜å¾—å—ï¼Ÿ\nä½¿ç”¨ aws-vault æ‹¿ IAM User çš„ access key åš programatic ç™»å…¥ï¼Œæä¾› terraform credentialã€‚è€Œéé€é aws web console è¨˜ä½ï¼šæˆ‘å€‘ä¸èƒ½ç”¨ root account åšé€™äº›å·¥ä½œ\naws-vault ç”±æ–¼æˆ‘å€‘ç¾åœ¨è¦ä½¿ç”¨ IAM User åš terraform ä¾†å‰µå»ºæ–°çš„ child accountsï¼Œæœªä¾†æœƒä½¿ç”¨æ–°çš„ child accounts ä¾†åšå„å€‹ç’°å¢ƒä¸­çš„ terraform å…ƒä»¶æ“ä½œï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹å·¥å…·ä¾†å”åŠ©åˆ‡æ›é€™äº› account\næˆ‘å€‘ä½¿ç”¨çš„å·¥å…·æ˜¯ aws-vault\nhttps://github.com/99designs/aws-vault æ”¯æ´å¾ˆå¤šå®‰è£å¹³å°ï¼Œé¸è‡ªå·±å–œæ­¡ç”¨çš„ï¼Œæˆ–æ˜¯ç›´æ¥åœ¨ github release é é¢ä¸‹è¼‰ binary $ aws-vault --help usage: aws-vault [\u0026lt;flags\u0026gt;] \u0026lt;command\u0026gt; [\u0026lt;args\u0026gt; ...] A vault for securely storing and accessing AWS credentials in development environments. ... ä½¿ç”¨ Root Account IAM User èº«ä»½åŸ·è¡Œ terragrunt\nåœ¨æœ¬æ©Ÿç´€éŒ„ access key (è«‹å¥½å¥½ä¿è­·æœ¬æ©Ÿçš„å®‰å…¨)\naws-vault add terraform-30day-root-iam-user Enter Access Key Id: XXXXXXXXXXXX Enter Secret Key: YYYYYYYYYYYY é€é aws-cli å–å¾— caller identityï¼Œä¹Ÿå°±æ˜¯ç¾åœ¨çš„èº«ä»½æ˜¯èª°ï¼Œç¢ºå®šæ˜¯ Administrator\nå¾ aws çš„è§’åº¦ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯ IAM User: Administrator æ“ä½œçš„ åªèƒ½æ“ä½œç•¶åˆå»ºç«‹ IAM User æ™‚ attach çš„æ¬Šé™ï¼ˆè˜‡ç„¶ä¹Ÿæ˜¯å¾ˆå¤§ï¼‰ä½†å·²ç¶“æ¯” root account å°å¾ˆå¤š ä¹‹å¾Œæˆ‘å€‘æœƒé€²ä¸€æ­¥é™ç¸®æ¯ä¸€å€‹ IAM User çš„ permission aws-vault exec terraform-30day-root-iam-user -- aws sts get-caller-identity { \u0026quot;UserId\u0026quot;: \u0026quot;AIDAxxxxxxxxxxxKGW\u0026quot;, \u0026quot;Account\u0026quot;: \u0026quot;706136188012\u0026quot;, \u0026quot;Arn\u0026quot;: \u0026quot;arn:aws:iam::706136188012:user/Administrator\u0026quot; } ç„¶å¾Œé€é aws-vault ä¾†åŸ·è¡Œ terraguntï¼Œé€™æ¨£ terragrunt å°±æœƒä½¿ç”¨ IAM User çš„ credential ä¾†æ“ä½œ provider å»å‘¼å« aws api\naws-vault exec terraform-30day-root-iam-user -- terragrunt init aws-vault exec terraform-30day-root-iam-user -- terragrunt plan Terraform will perform the following actions: # aws_organizations_account.account[\u0026quot;dev\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;terraform30days@outlook.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;dev\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026quot;logs\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;terraform30days@outlook.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;logs\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026quot;prod\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;terraform30days@outlook.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;prod\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026quot;security\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;terraform30days@outlook.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;security\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026quot;shared\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;terraform30days@outlook.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;shared\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026quot;stage\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;terraform30days@outlook.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;stage\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_account.account[\u0026quot;prod\u0026quot;] will be created + resource \u0026quot;aws_organizations_account\u0026quot; \u0026quot;account\u0026quot; { + arn = (known after apply) + close_on_deletion = false + create_govcloud = false + email = \u0026quot;chechiachang999+terraform-test@gmail.com\u0026quot; + govcloud_id = (known after apply) + id = (known after apply) + joined_method = (known after apply) + joined_timestamp = (known after apply) + name = \u0026quot;prod\u0026quot; + parent_id = (known after apply) + status = (known after apply) + tags_all = (known after apply) } # aws_organizations_organization.org will be created + resource \u0026quot;aws_organizations_organization\u0026quot; \u0026quot;org\u0026quot; { + accounts = (known after apply) + arn = (known after apply) + aws_service_access_principals = [ + \u0026quot;cloudtrail.amazonaws.com\u0026quot;, + \u0026quot;config.amazonaws.com\u0026quot;, ] + feature_set = \u0026quot;ALL\u0026quot; + id = (known after apply) + master_account_arn = (known after apply) + master_account_email = (known after apply) + master_account_id = (known after apply) + non_master_accounts = (known after apply) + roots = (known after apply) } Plan: 8 to add, 0 to change, 0 to destroy. Terragrunt plan å¾Œç”¢ç”Ÿ terraform planï¼Œæˆ‘å€‘è¦ä»”ç´° review\n0 change / 0 deleteï¼Œé€™é‚Šå¾ˆé‡è¦ï¼Œç¢ºå®šæˆ‘å€‘ä¸æœƒæ”¹éŒ¯æˆ–æ˜¯èª¤åˆªå·²ç¶“å­˜åœ¨çš„ aws å…ƒä»¶ 7 to addï¼Œæ–°å¢äº† 7 å€‹ aws å…ƒä»¶ ä¸€å€‹ aws_organization å…­å€‹ aws_organization_accountï¼Œå°æ‡‰æœªä¾†çš„å…­å€‹ç’°å¢ƒ ä¸€å€‹ aws_organization_accountï¼Œå› ç‚ºä¸Šé¢ email è¨­éŒ¯å¡ä½ï¼Œè€Œå¤šé–‹ä¸€å€‹ test ç’°å¢ƒXD review æ²’å•é¡Œå¾Œï¼Œæˆ‘å€‘é€²è¡Œ apply\naws-vault exec terraform-30day-root-iam-user -- terragrunt apply aws_organizations_account.account[\u0026quot;logs\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;stage\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;prod\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;security\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;dev\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;shared\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;prod\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;logs\u0026quot;]: Creating... aws_organizations_account.account[\u0026quot;logs\u0026quot;]: Still creating... [10s elapsed] aws_organizations_account.account[\u0026quot;prod\u0026quot;]: Still creating... [10s elapsed] aws_organizations_account.account[\u0026quot;logs\u0026quot;]: Creation complete after 14s [id=557659608246] aws_organizations_account.account[\u0026quot;prod\u0026quot;]: Creation complete after 14s [id=420896464212] å‰µå»ºå®Œæˆ organization èˆ‡ organization accounts å¾Œï¼Œæˆ‘å€‘å¯ä»¥é€²è¡Œæª¢æŸ¥\nåˆ° aws console -\u0026gt; organization é é¢ï¼Œå¯ä»¥çœ‹åˆ°æ–°å»ºçš„ organization èˆ‡ accounts\nä¹Ÿå¯ä»¥ä½¿ç”¨ aws-cli åˆ—å‡º organization çš„ accounts\naws-vault exec terraform-30day-root-iam-user --no-session -- aws organizations list-accounts ä½¿ç”¨ external module äºŒä¸‰äº‹ ä½¿ç”¨é–‹æºçš„ terraform module ä¹Ÿæ˜¯æœ‰å¾ˆå¤šå¥½è™•\né¦–å…ˆæˆ‘å€‘ä½¿ç”¨çš„æ˜¯ aws ç¶­è­·çš„ terraform moduleï¼Œå¦‚æœ aws api æœ‰æ›´æ–°é€šå¸¸éƒ½è·Ÿå¾—å¾ˆå¿« é–‹æº module æœƒæœ‰å¤§é‡çš„ç¤¾ç¾¤å¹«å¿™ç™¼ issue è¨è«–èˆ‡ PR review é‡åˆ°å•é¡Œå¯ä»¥ç›´æ¥é–‹ issue å• gruntwork enterprise çš„ module æ˜¯ enterprise ç­‰ç´šçš„è§£æ±ºæ–¹æ¡ˆï¼Œæœ‰ç›¸ç•¶çš„ code å“è³ªï¼Œä½†åœ¨ä¸Šé¢å¹¾é»è‡ªç„¶æ˜¯ä¸å¦‚é–‹æº repository é †ä¾¿æä¸€ä¸‹ï¼Œå¦‚æœä¹‹å¾Œè¦è‡ªå·±å‹•æ‰‹å¯«å…¶ä»–å…ƒä»¶ï¼Œæ‡‰è©²å¦‚ä½•æ‰¾åˆ°é©åˆçš„ external terraform module?\næœ‰éœ€è¦å°å…¥å…¶ä»–å…¬æœ‰é›²çš„å…ƒä»¶ (ex. azure / gcp / \u0026hellip;)ï¼Œå¯ä»¥åœ¨ registry.terraform.io ä¸Šé¢æœå°‹æ‰¾åˆ° é€šå¸¸æ¯”è¼ƒå¤§é–“çš„ Cloud provider ç‚ºäº†æ–¹ä¾¿ä½¿ç”¨è€…ï¼Œéƒ½æœƒç¶­è­·è‡ªå®¶ç”¢å“çš„ terraform moduleï¼Œæ–¹ä¾¿ä½¿ç”¨é€™ç›´æ¥ä½¿ç”¨ IaC çš„æ–¹å¼å°å…¥ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è‡ªå·±å®¶æ¨å‡ºçš„ terraform module å› ç‚º aws æœ€ç†Ÿæ‚‰è‡ªå·±å®¶çš„å…ƒä»¶ï¼Œæ¯”è¼ƒä¸æœƒå‡º bug é‡åˆ°å•é¡Œå¯ä»¥ç›´æ¥ç™¼ issue è®“ aws çš„å·¥ç¨‹å¸«ä¾†çœ‹ å¦‚æœ registry.terraform.io ä¸Šï¼ŒæŸå€‹å…ƒä»¶æ‰¾ä¸åˆ°è‡ªå·±å…¬å¸å‡ºçš„ terraform moduleï¼Œé‚£å¯èƒ½å°±è¦æ‰¾çœ‹çœ‹ç¤¾ç¾¤ç‰ˆæœ¬çš„ å¦‚æœ registry.terraform.io ä¸Šæœå°‹ä¸åˆ°ï¼Œå¯ä»¥ä¸Š Github æœå°‹ \u0026ldquo;terraform + å…ƒä»¶åç¨±\u0026rdquo; å¯èƒ½æ‰¾åˆ°æ²’æœ‰æ”¶éŒ„åœ¨ registry çš„ terraform moduleã€‚æˆ–æ˜¯ç›´æ¥ googleï¼Œå¶çˆ¾ä¹Ÿæœƒæœ‰æ„å¤–æ”¶ç©« æ²’æœ‰ terraform official validated module å°±è¦ç‰¹åˆ¥æ³¨æ„å®‰å…¨æ€§ ä¸€å€‹å¥½çš„ terraform module é€šå¸¸æœ‰å¹¾å€‹ç‰¹å¾µ\næœ‰è‰¯å¥½çš„æ›´æ–°ç´€éŒ„åœ¨ commit history ä¸­ æœ‰æ´»èºçš„ç¤¾ç¾¤ ç™¼ issue è¨è«– / PR / review æœ‰å®Œæ•´çš„ changelog ç´€éŒ„è®Šæ›´å¦‚ä½•æ™‚å‡ç‰ˆï¼Œä¹Ÿæ–¹ä¾¿è®“ä½¿ç”¨è€…å‡ç‰ˆæ™‚æª¢æŸ¥ æ™‚å¸¸æ›´æ–°ï¼Œèƒ½å¤ ç¬¦åˆæ–°ç‰ˆçš„ terraform core version è¦æ ¼ æœƒé–å®š dependency ç‰ˆæœ¬ï¼Œex. terraform core version èˆ‡ä¾è³´çš„ provider version åä¹‹ï¼Œå¦‚æœç™¼ç¾ä¸€å€‹ terraform module å¹´ä¹…å¤±ä¿®ï¼Œå¾ˆå°‘äººè¨è«–ï¼Œä¹Ÿæ²’æœ‰è·Ÿä¸Š terraform core ç‰ˆæœ¬ (ex. ä¸æ”¯æ´ 1.x) å¯èƒ½å°±è¦è€ƒæ…®ä¸€ä¸‹æ˜¯å¦è¦ä½¿ç”¨ ä½¿ç”¨å¤–éƒ¨ module æ‡‰è©²æ³¨æ„çš„äº‹æƒ… æœ‰æ™‚å€™æŸäº›å¤–éƒ¨ module æœƒæœ‰é›·ï¼Œå°è‡´æˆ‘å€‘å»å¼•ç”¨æ™‚å‡ºç¾éŒ¯èª¤\næ›´æ”¹å·²ç¶“å­˜åœ¨çš„ tag / ç«„æ”¹ commit history / \u0026hellip; ç­‰ æˆ–æ˜¯ repository ç§»é™¤è®Šä¸è¦‹ / æ”¹å / æ”¹ url ç‚ºäº†é¿å…æˆ‘å€‘åŸæœ¬å¥½å¥½çš„ terraform code å—åˆ°å½±éŸ¿ï¼Œå¦‚æœæœ‰ä½¿ç”¨å¤–éƒ¨ moduleï¼Œæˆ‘å€‘å¯ä»¥å…ˆ fork ä¸€ä»½å¤–éƒ¨ module åˆ° internal repository (clone ä¸€ä»½å† push åˆ°è‡ªå®¶çš„ cvs ä¸Šé¢ï¼‰ï¼Œç„¶å¾ŒæŠŠ source url æ”¹æˆ fork internal repository\nä¾‹å¦‚æœ¬ä¾†æ˜¯ github.com/chechiachang/terragrunt-infrastructure-modules fork (clone \u0026amp; push) è®Šæˆ chechia.bitbucket.com/chechia/terragrunt-infrastructure-modules source url ä¸­ä½¿ç”¨ git tag referenceï¼Œæ˜ç¢ºæŒ‡å®š internal module (ä¸ç”¨ github.com è€Œç”¨ chechia.bitchecket) éœ€è¦æ›´æ–°æ™‚ï¼Œåœ¨å¾ github ä¸Š pull æœ€æ–°çš„ codeï¼Œpush åˆ° bitbucket ä¸Šï¼Œä¿®æ”¹ source url å°±å®Œæˆå‡ç‰ˆ é€™æ¨£å¯ä»¥å°‡å° external module çš„ä¾è³´è½‰ä¹˜ loose couplingï¼Œé™ä½è€¦åˆç¨‹åº¦ï¼Œå¦‚æœ external module æ•´å€‹å£æ‰ï¼Œæˆ‘å€‘çš„ terraform module ä½¿ç”¨ä¸å—å½±éŸ¿ã€‚ä½†åˆèƒ½ trace åŸå…ˆçš„ external module remoteï¼Œæ–¹ä¾¿æ¥æ”¶æ›´æ–°ã€‚ ç¼ºé»æ˜¯æœƒèŠ±ä¸€äº›äººåŠ›æ•´ç†é€™äº› forked module repositories ä½¿ç”¨ external module ä¹Ÿè¦æ³¨æ„è³‡è¨Šå®‰å…¨\nè¦å°å¿ƒä¾†è·¯ä¸æ˜çš„ terraform moduleï¼Œterraform module å¯ä»¥å–å¾—å¾ˆå¤šé ç«¯çš„ç§å¯†è¨Šæ¯ï¼Œå¯èƒ½æœƒæœ‰å®‰ç¾¤æ€§çš„éš±æ†‚ æ²’æœ‰ terraform validated çš„ terraform moduleï¼Œä½¿ç”¨å‰è‡ªå·±è¦çœ‹éå…§å®¹ çœ‹åˆ°ä½¿ç”¨ä¸ç†Ÿæ‚‰çš„ terraform providerï¼Œä¹Ÿæ‡‰è©²å»æª¢æŸ¥ provider çš„å‡ºè™•èˆ‡å…§å®¹ é¿å…ç”¨è‡ªå·±çš„ aws account èº«ä»½åŸ·è¡Œå¾Œï¼Œç™¼ç¾è¢«å·åŸ‹æ±è¥¿ï¼Œæˆ–æ˜¯è³‡æ–™æ´©æ¼å‡ºå» å¦‚æœç™¼ç¾è‡ªå·±ä½¿ç”¨çš„å…ƒä»¶æ¯”è¼ƒå†·é–€ï¼Œç¬¦åˆè‡ªå·±éœ€æ±‚çš„ external module ä¹Ÿå¹´ä¹…å¤±ä¿®ï¼Œä¹Ÿå¯ä»¥è€ƒæ…® hard fork ä¸€ç‰ˆï¼Œç”±åœ˜éšŠè‡ªå·±ç¶­è­·\nå¯ä»¥åƒè€ƒç¾æœ‰çš„æ¶æ§‹èˆ‡å…§å®¹ï¼Œæ ¹æ“šå…§éƒ¨çš„éœ€æ±‚å»ä¿®æ”¹ terraform moduleï¼Œæœ€å¾Œåœ¨è‡ªå·±å¼•ç”¨ å…§éƒ¨ç¶­è­·ï¼Œè‡ªå·±æ§åˆ¶å‡ç‰ˆèˆ‡ç™¼ä½ˆ å¦‚æœä¸æ˜¯å¤ªè¤‡é›œçš„ module å…¶å¯¦å¯ä»¥åš åšå®Œè¨˜å¾—ç”¨å®‰å…¨æ€§å·¥å…·æª¢æŸ¥ï¼Œç¢ºä¿æ²’æœ‰å®‰å…¨éš±æ†‚ï¼ˆé€™å€‹æˆ‘å€‘ç¨å¾Œå¹¾å¤©çš„å…§å®¹æœƒæï¼‰ ","permalink":"https://chechia.net/posts/2022-09-14-14th-ithome-ironman-iac-aws-workshop-03-provision-aws-account/","summary":"\u003cp\u003eä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003e\u0026ndash;\u003c/p\u003e\n\u003cp\u003eProvision AWS Account\u003c/p\u003e\n\u003cp\u003eä»Šå¤©è¦æŠŠ aws account è¨­å®šå®Œæˆï¼Œä¸¦ä¸”é–‹å§‹ä½¿ç”¨ live-repository ä¾†æ­å»º aws å…ƒä»¶\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"æˆ‘å€‘è‡ªå·±çš„-module-repository\"\u003eæˆ‘å€‘è‡ªå·±çš„ module repository\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eé–‹ä¸€å€‹æ¬Šé™çš„ repository\u003c/li\u003e\n\u003cli\u003efork æˆ‘è‡ªå¹¹çš„ modules repository terragrunt-infrastructure-modules \u003ca href=\"https://github.com/chechiachang/terragrunt-infrastructure-modules\"\u003ehttps://github.com/chechiachang/terragrunt-infrastructure-modules\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eä¸Šé¢é€™å€‹æ˜¯æ”¾ terraform module çš„ repositoryï¼Œæ˜¯å…©å€‹ repository\u003c/li\u003e\n\u003cli\u003eä¸è¦è·ŸåŸ·è¡Œ terragrunt repository ææ··ï¼Œæ˜¯å…©å€‹ repository \u003ca href=\"https://github.com/chechiachang/terragrunt-infrastructure-live-example\"\u003ehttps://github.com/chechiachang/terragrunt-infrastructure-live-example\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä»Šå¤©çš„é€²åº¦èˆ‡ code base\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terragrunt-infrastructure-live-example/pull/1\"\u003eterraform-live-example PR åœ¨æ­¤\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"\"\u003eterragrunt-infrastructure-modules è«‹ç›´æ¥çœ‹ tag v0.0.1\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eå› ç‚ºæœ‰åœ°æ–¹åš´é‡å¯«éŒ¯ï¼Œæˆ‘æœ‰ force push æ±è¥¿ :tear:ï¼Œå¦‚æœå·²ç¶“ææ—©ä¸‹è¼‰çš„æœ‹å‹å¯èƒ½æœƒéœ€è¦æ¸…æ‰ repository main branch + tag é‡æ‹‰ orz\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå°ï¼Œæˆ‘å€‘ä¸”æˆ°ä¸”èµ°å¸¸å¸¸æœƒé€™æ¨£ï¼Œç™¼ç¾æ˜¨å¤©å¯«çš„æ±è¥¿å¯«éŒ¯è‡¨æ™‚æ”¹ï¼Œè«‹å¤§å®¶è¦‹è«’\u003c/p\u003e\n\u003ch3 id=\"ç‚ºä½•ä½¿ç”¨-aws-modules\"\u003eç‚ºä½•ä½¿ç”¨ aws modules\u003c/h3\u003e\n\u003cp\u003eX) å› ç‚ºæˆ‘å€‘æ²’æœ‰ä»˜éŒ¢ï¼Œä¸èƒ½ç”¨ gruntwork çš„ priviate repository (å¤§èª¤\u003c/p\u003e","title":"Provision Child AWS Accounts"},{"content":"ä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\niThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\n\u0026ndash;\nAWS Account structure AWS account structure æ˜¯ AWS IAM æä¾›çš„ feature ä¹‹ä¸€ï¼Œå¯ä»¥è®“ç”¨æˆ¶å¾ä¸€å€‹ account loginï¼Œç„¶å¾Œé€éæˆæ¬Šæ“ä½œå…¶ä»– account çš„å…ƒä»¶ã€‚\nç„¶è€Œæœ‰é€™å€‹ feature ä¸ä»£è¡¨ç”¨æˆ¶å°±è¦è²·å–®ï¼Œæœ‰å¯¦éš›éœ€æ±‚æˆ‘å€‘æ‰ä¾†ç”¨ featureã€‚ä½¿ç”¨ account structure çš„ç†ç”±æ˜¯ä»€éº¼ï¼Ÿ\nAccount structure çš„éœ€æ±‚ AWS å®˜æ–¹ whitepaper: ä½¿ç”¨ multiple aws account çš„å¥½è™•\nä¾æ“šè·å‹™éœ€æ±‚å°‡ workload åˆ†çµ„ ç‚ºä¸åŒ environment è¨­å®šç¨ç«‹çš„ security control é™åˆ¶æ•æ„Ÿè³‡æ–™çš„å­˜å– æå‡å‰µæ–°èˆ‡é–‹ç™¼çš„æ•æ· æ§åˆ¶äº‹æ•…çš„å½±éŸ¿ç¨‹åº¦èˆ‡è¡æ“Š impact ç²¾ç´°çš„æ‹†åˆ† IT çš„å·¥ä½œ æˆæœ¬æ§ç®¡ åˆ†æ•£ aws quotas ä½¿ç”¨é™é¡èˆ‡ API rate limit AWS å®˜æ–¹çš„ organization best practice AWS å®˜æ–¹ OU ç®¡ç†çš„ best practice\nGruntwork Doc å»ºè­°çš„ IaC best practice ä¸­çš„ aws account structureï¼Œæåˆ°ä¸‰å€‹ä¸»è¦çš„ç›®çš„\nIsolation (AKA compartmentalization) ä¸åŒç’°å¢ƒï¼Œäº‹æ•…ç™¼ç”Ÿæ™‚ï¼Œå½±éŸ¿ç¯„åœä¸æœƒå¤ªå¤§ (ex. å·¥ç¨‹å¸« terraform èª¤åˆª infra) å®‰å…¨æ€§ï¼Œdev / stag æœ‰å®‰å…¨æ€§æ¼æ´æ™‚ï¼Œattacker ä¸æœƒæ”»æ“Šåˆ° prod ç’°å¢ƒ Authentication and authorization æŠŠ user éƒ½æ”¾åœ¨ä¸€èµ·ç®¡ç†ï¼Œé€éæ›´ç²¾ç´°çš„ access control å»æ§åˆ¶å…¶ä»– account å…§éƒ¨çš„å…ƒä»¶ Auditing and reporting ä¾æ“šç’°å¢ƒèˆ‡ç”¨é€”æ‹†åˆ† accountï¼Œè®“ç›£æ¸¬èˆ‡æˆæœ¬æ§åˆ¶æ›´ç²¾ç´° å¾å¯¦å‹™ä¸Šçš„ç¶“é©—ï¼Œæœ‰ä»¥ä¸‹ç‹€æ³å°±è€ƒæ…®è¦æ‹†åˆ† aws account\nå¦‚æœ IT éƒ¨é–€å¾ˆå¤§äººæ•¸å¾ˆå¤šï¼Œé‚£å°‡æ‰€æœ‰å·¥ä½œå…§å®¹ä¸åŒçš„ user éƒ½æ”¾åœ¨åŒä¸€å€‹ aws account ä¸‹å°è‡´ç®¡ç†éº»ç…© å¤§å¤šæ•¸çš„ incident éƒ½æ˜¯å·¥ç¨‹å¸« change é€ æˆçš„ï¼Œæ‹†åˆ† dev / stag çš„ change æ›¾ç¶“å½±éŸ¿åˆ° prod ä¸åŒåœ˜éšŠå°æ–¼è² è²¬çš„å…ƒä»¶ç¯„åœå€åˆ†ä¸æ¸… å·¥ä½œæ‰çƒï¼Œè©²åšçš„äº‹æ²’äººè™•ç† å·¥ä½œé‡åŠŸï¼Œåšäº†ä¸€æ¨£çš„äº‹æƒ…å°è‡´è¡çª å°æ•…äº‹ï¼šæŠ€è¡“å•é¡Œè§£æ±ºäººç‚ºå•é¡Œï¼ˆï¼Ÿï¼‰ iThome DevOpsDay æœ‰ä¸€å€‹è½çœ¾è½å®Œ2022 DevOpsDay PaC for IaC æ¼”è¬› å¾Œè·‘ä¾†æ‰¾æˆ‘ï¼Œä»–å•èªªï¼š è¬›å¸«ä½ å¥½ï¼Œæˆ‘å€‘ terraform å¸¸å¸¸èª¤åˆªæ±è¥¿ï¼Œdeploy dev / stag çµæœ prod å£æ‰ï¼ˆæ±— å¦‚æœä¸æ˜¯æŠ€è¡“çš„å•é¡Œï¼Œæ˜¯äººçš„å•é¡Œï¼Œä¸çŸ¥é“æœ‰æ²’æœ‰æ–¹æ³•è§£ï¼Ÿ\nè¦æ²»æœ¬é‚„æ˜¯è¦åŠ å¼·å…§éƒ¨æ•™è‚²è¨“ç·´ï¼Œå¾ˆåŸºç¤çš„é‡å¤§éŒ¯èª¤æ˜¯å¾ˆé›£ç”¨æŠ€è¡“æ“‹çš„ ä½†çŸ­æœŸè¦æ²»æ¨™ï¼Œå¯ä»¥\nå…ˆå€éš” dev stag èˆ‡ prod çš„ terraform repo è·Ÿ aws account æŠŠ prod æ¬Šé™é–èµ·ä¾†ï¼Œå…ˆä¸è¦è®“ junior çš„æˆå“¡å»è§¸ç¢° æ‰€æœ‰ prod apply éƒ½è¦å…©åˆ°ä¸‰å€‹ senior å» approve ä¹Ÿè¨±ä½ å€‘çš„ç”Ÿæ´»æœƒå¿«æ¨‚ä¸€é»(å¥½è¡€æ·š)\nworkshop æˆ‘å€‘æœƒæ ¹æ“š Gruntwork Landing Zone Guide çš„æ–‡å­—æ•˜è¿°ä¾†é€²è¡Œä»Šå¤©çš„ workshop\nCAUTION You must be a Gruntwork subscriber to access the Gruntwork Infrastructure as Code Library. æ˜¯çš„ï¼Œé€™ä»½ Gruntwork Landing Zone Guide å…§éƒ¨çš„ç¯„ä¾‹æœ‰ä½¿ç”¨è¨±å¤š gruntwork-io çš„ private repositoryï¼Œé€™éƒ¨åˆ†æ˜¯éœ€è¦ä»˜è²»ã€‚gruntwork subscription ä¸€å€‹æœˆ $795 èµ·è·³ï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥åƒè€ƒ Gruntwork subscription checkout\næˆ‘å€‘é€™ç¯‡ workshop ä¸¦ä¸ä½¿ç”¨ Gruntwork çš„ä»˜è²»åŠŸèƒ½ï¼Œæ‰€æœ‰ private repository æˆ‘å€‘å°±æœƒä½¿ç”¨å…¶ä»–é–‹æºçš„ modules ä¾†æ›¿ä»£ï¼Œä¾‹å¦‚ä½¿ç”¨ aws + terraform team å®˜æ–¹ç¶­è­·çš„ aws modules\nç”±æ–¼ç¼ºå°‘éƒ¨åˆ† repository çš„å…§å®¹ï¼Œé€™ä»½ Gruntwork Landing Zone Guide æœƒå¸¸å¸¸çœ‹åˆ°å¾ˆå¤š github external link æ˜¯ 404 not foundï¼Œè¡¨ç¤ºæ˜¯ private repositoryã€‚çœ‹èµ·ä¾†æœƒæœ‰é»ä¸èˆ’æœï¼Œä½†æ²’é—œä¿‚æˆ‘å€‘å°±è¦‹æ‹›æ‹†æ‹›è‡ªç”±ç™¼æ®ã€‚\nå»ºç«‹ workspace repository repository çš„å…§å®¹å¯ä»¥ç›´æ¥åƒç…§ Gruntwork Guide çš„å…§å®¹\næœ¬æ¬¡ workshop æˆ‘å€‘ä½¿ç”¨çš„ repository https://github.com/chechiachang/terragrunt-infrastructure-live-example\nterragrunt éƒ½æœƒåœ¨é€™å€‹ repository è£¡é¢é‹ä½œ å„ä½å¯ä»¥ç›´æ¥ copy ä¾†æ”¹ Root account root account æ˜¯æ•´å€‹ account structure æœ€ä¸Šå±¤çš„ accountï¼Œå‰µä¸– accountã€‚ç”±æ–¼æ˜¯å‰µä¸– accountï¼Œæ¬Šé™ä¹Ÿæ˜¯æœ€å¤§ï¼Œå› æ­¤æœƒéœ€è¦åŠ ä¸Šè¨±å¤šé™åˆ¶:\nä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ ä½¿ç”¨å¯†ç¢¼å„²å­˜å™¨ä¿ç®¡å¯†ç¢¼ï¼Œex 1password / lastpass / \u0026hellip;ï¼Œé€™äº›å¯†ç¢¼å„²å­˜å™¨éƒ½æœ‰è‡ªå‹•åŠ å¯†ï¼Œä¸”æœ‰é€šéå®‰å…¨é¢¨éšªæ¸¬è©¦ ä¸è¦å­˜åœ¨é›»è…¦ä¸Š / email / google drive / ç´™ä¸Š / æˆ–æ˜¯å…¶ä»–æ²’æœ‰ç¶“éå®‰å…¨é©—è­‰å·¥å…·ä¸Š å‹™å¿…é–‹å•Ÿ MFA åˆªé™¤ root account çš„ aws access keyï¼Œåªå…è¨±é€é aws web console å­˜å– è‡ªå·±å†ä¹Ÿä¸è¦ä½¿ç”¨é€™å€‹å¸³è™Ÿï¼Œé™ä½æ´©æ¼çš„é¢¨éšª AWS å®˜æ–¹å»ºè­°ï¼Œåªæœ‰é€™äº›å·¥ä½œéœ€è¦ä½¿ç”¨ root account ï¼Œå…¶ä»–å·¥ä½œéƒ½ä¸æ‡‰è©²ä½¿ç”¨ root account Root Account IAM user æˆ‘å€‘ä½¿ç”¨ root account çš„æœ€å¾Œä¸€ä»¶å·¥ä½œï¼Œå°±æ˜¯å»ºç«‹ä¸€å€‹ IAM User ä½œç‚º adminï¼Œä¹‹å¾Œä½¿ç”¨é€™å€‹ IAM User æ“ä½œã€‚æ–‡ä»¶èˆ‡æ­¥é©Ÿåœ¨æ­¤\nName: Administrator å‹¾é¸: programmatic access AWS Management Console access Permission é é¢é¸æ“‡ Attach existing policies to user directly å‹¾é¸ AdministratorAccess policy. é»ä¸‹ä¸€æ­¥ï¼Œç›´åˆ°ç”¢ç”Ÿå‡º IAM User å°‡ç™»å…¥è³‡è¨Šå­˜åœ¨å¯†ç¢¼å„²å­˜å™¨ login url name password Access key ID Secret access key æ¥è‘—ä¹Ÿæ˜¯è¦é–ä½ root account çš„ IAM User\nä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ ä½¿ç”¨å¯†ç¢¼å„²å­˜å™¨ä¿ç®¡å¯†ç¢¼ å‹™å¿…é–‹å•Ÿ MFA ç‚º Root account è¨­å®š Security baseline ä¾ç…§ gruntwork guide æ¥ä¸‹ä¾†éœ€è¦è¨­å®šåº•ä¸‹çš„å…ƒä»¶\nå»ºç«‹æ‰€æœ‰çš„ child accounts è¨­å®š AWS Organization IAM ROles IAM Users IAM Groups IAM Password Policies Amazon GuardDuty AWS CloudTrail AWS Config. CAUTION You must be a Gruntwork subscriber to access terraform-aws-service-catalog. ç”±æ–¼ terraform-aws-service-catalog æ˜¯ private repositoryï¼Œéœ€è¦ä»˜è²»è¨‚é–±æ‰èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘å€‘ç„¡æ³•å–å¾—è£¡é¢çš„å…§å®¹\nç‚ºäº†é¿å…é€™å€‹ workshop å¡åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°±ä¾†è‡ªå¹¹é€™äº› module å§ï¼¸ï¼¤\nç›´æ¥ä½¿ç”¨å…¶ä»–çš„é–‹æº modules æ›¿ä»£ ä¾ç…§ guide æŠŠå…ƒä»¶ç”Ÿå‡ºä¾† ç„¶å¾Œä¾ç…§è‡ªå·±çš„éœ€æ±‚å»å®¢è£½åŒ– NOTE: Gruntwork çš„ security module æœ‰å…¶ enterprise solution çš„ç¶“é©—åœ¨è£¡é¢ï¼Œå…¶å¯¦å…¬å¸æœ‰é ç®—é‚„æ˜¯ç›¸ç•¶å€¼å¾—åƒè€ƒçš„ã€‚åªæ˜¯æˆ‘å€‘ workshop ç‚ºäº†å£é¢å¤§å®¶ç ´è²»ï¼Œå…ˆç•¶ä¸€å›å…è²»ä»”ã€‚\næˆ‘å€‘è‡ªå·±çš„ module repository é–‹ä¸€å€‹æ¬Šé™çš„ repository fork æˆ‘è‡ªå¹¹çš„ modules repository terragrunt-infrastructure-modules ä¸Šé¢é€™å€‹æ˜¯æ”¾ terraform module çš„ repositoryï¼Œæ˜¯å…©å€‹ repository ä¸è¦è·ŸåŸ·è¡Œ terragrunt repository ææ··ï¼Œæ˜¯å…©å€‹ repository https://github.com/chechiachang/terragrunt-infrastructure-live-example å¯«åˆ°é€™é‚Šå°± 6000 å­—äº†ï¼Œé‚„æ²’é–‹å§‹ç¢° terragrunt\naws account structure èˆ‡ terragrunt directory structure çš„æ¦‚å¿µéå¸¸é‡è¦ï¼Œæœ‰å¥½çš„åŸºç¤æœƒè®“å¾Œé¢çš„å·¥ä½œå¿«æ¨‚å¾ˆå¤š æ˜å¤©æœƒç¹¼çºŒä»Šå¤©çš„å·¥ä½œï¼ŒæŠŠ aws account / iam policy / permission é…å¥½\n","permalink":"https://chechia.net/posts/2022-09-13-14th-ithome-ironman-iac-aws-workshop-02-aws-account-structure/","summary":"\u003cp\u003eä»Šå¤©è¦ä½¿ç”¨ terraform è¨­å®š AWS account structure\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003e\u0026ndash;\u003c/p\u003e\n\u003ch1 id=\"aws-account-structure\"\u003eAWS Account structure\u003c/h1\u003e\n\u003cp\u003eAWS account structure æ˜¯ AWS IAM æä¾›çš„ feature ä¹‹ä¸€ï¼Œå¯ä»¥è®“ç”¨æˆ¶å¾ä¸€å€‹ account loginï¼Œç„¶å¾Œé€éæˆæ¬Šæ“ä½œå…¶ä»– account çš„å…ƒä»¶ã€‚\u003c/p\u003e\n\u003cp\u003eç„¶è€Œæœ‰é€™å€‹ feature ä¸ä»£è¡¨ç”¨æˆ¶å°±è¦è²·å–®ï¼Œæœ‰å¯¦éš›éœ€æ±‚æˆ‘å€‘æ‰ä¾†ç”¨ featureã€‚ä½¿ç”¨ account structure çš„ç†ç”±æ˜¯ä»€éº¼ï¼Ÿ\u003c/p\u003e\n\u003ch1 id=\"account-structure-çš„éœ€æ±‚\"\u003eAccount structure çš„éœ€æ±‚\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://docs.aws.amazon.com/whitepapers/latest/organizing-your-aws-environment/benefits-of-using-multiple-aws-accounts.html\"\u003eAWS å®˜æ–¹ whitepaper: ä½¿ç”¨ multiple aws account çš„å¥½è™•\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¾æ“šè·å‹™éœ€æ±‚å°‡ workload åˆ†çµ„\u003c/li\u003e\n\u003cli\u003eç‚ºä¸åŒ environment è¨­å®šç¨ç«‹çš„ security control\u003c/li\u003e\n\u003cli\u003eé™åˆ¶æ•æ„Ÿè³‡æ–™çš„å­˜å–\u003c/li\u003e\n\u003cli\u003eæå‡å‰µæ–°èˆ‡é–‹ç™¼çš„æ•æ·\u003c/li\u003e\n\u003cli\u003eæ§åˆ¶äº‹æ•…çš„å½±éŸ¿ç¨‹åº¦èˆ‡è¡æ“Š impact\u003c/li\u003e\n\u003cli\u003eç²¾ç´°çš„æ‹†åˆ† IT çš„å·¥ä½œ\u003c/li\u003e\n\u003cli\u003eæˆæœ¬æ§ç®¡\u003c/li\u003e\n\u003cli\u003eåˆ†æ•£ aws quotas ä½¿ç”¨é™é¡èˆ‡ API rate limit\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://aws.amazon.com/organizations/getting-started/best-practices/\"\u003eAWS å®˜æ–¹çš„ organization best practice\u003c/a\u003e\n\u003ca href=\"https://aws.amazon.com/blogs/mt/best-practices-for-organizational-units-with-aws-organizations/\"\u003eAWS å®˜æ–¹ OU ç®¡ç†çš„ best practice\u003c/a\u003e\u003c/p\u003e","title":"AWS Account Struture"},{"content":"iThome éµäººè³½å¥½è®€ç‰ˆ\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\n\u0026ndash;\nAWS ç‚ºä¾‹ï¼Œå¯¦ç¾ production framework çš„æœ€ä½³å¯¦è¸çš„ 30 å¤© workshop\næº–å‚™ Production environmtn Devops é¢è‡¨çš„å•é¡Œ DevOps çš„å·¥ä½œå…§å®¹ç¹é›œ\nä»Šå¤©æƒ³è¦ Deploy ä¸€å€‹ backend API deployment åˆ° k8s ä¸Š ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® port / servie / ingress / alb ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® tls certificate ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® node linux ä¸Šçš„ä¸€å€‹ bug ä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® monitoring / metrics + alert / log collection \u0026hellip; æˆ‘åªæ˜¯æƒ³ deploy ä¸€å€‹ backend deployment ä¿®infra èŠ±äº†å¥½å¹¾å¤©ï¼Œè€Œå¯« deployment åªè¦ 2 hr Devops çš„å·¥ä½œï¼Œæ˜¯è™•ç† developer èˆ‡ operator ä¸­é–“çš„ç¹é›œçš„ç´°ç¯€ æ›å€‹è§’åº¦æ€è€ƒï¼šä¸Šé¢é€™äº›å…ƒä»¶å…¨éƒ½æ˜¯å­˜åœ¨è¨±ä¹…çš„åŠŸèƒ½ï¼Œæ‡‰è©²æœ‰ä¸€å¥—çµ±ä¸€ä»‹é¢éš¨å«å³ç”¨é€™äº›æœå‹™ï¼Œex.\nä»Šå¤©æƒ³è¦ Deploy ä¸€å€‹ backend API deployment åˆ° k8s ä¸Š æ‰¿ä¸Šï¼ŒåŒå€¼æ€§é«˜ï¼Œcoding è¬›æ±‚ DRY åŸå‰‡ (Don\u0026rsquo;t Repeat Youself)ï¼Œinfra ç®¡ç†ä¸Šå»æœƒæœ‰å¤§é‡é‡è¤‡çš„å·¥ä½œ\né–‹ä¸€å€‹ Restful API deployment é–‹ä¸€å€‹ GRPC deployment é–‹ä¸€å€‹ Kafka message Queue / redis / RDS / \u0026hellip; å¸Œæœ›é€™äº›å…ƒä»¶éƒ½æœ‰å¯«å¥½çš„ unit å¯ä»¥é‡è¤‡ä½¿ç”¨ ä½†å¯¦å‹™ä¸Šé‚„æ˜¯æœƒæœ‰ç´°ç¯€éœ€è¦èª¿æ•´ è‡ªå‹•åŒ–\næ¨™æº–åŒ–åŠŸèƒ½å¾Œï¼Œæ‡‰è©²è¦å¯ä»¥è‡ªå‹•éƒ¨ç½² ç”šè‡³æ˜¯ç•¶ Backend API deployment éƒ¨ç½²ä¸Šå»æ™‚ï¼Œè‡ªå‹•èª¿ç”¨ç”¢ç”Ÿå°æ‡‰çš„å…ƒä»¶ Backend API deployment æœ‰è®ŠåŒ–æ™‚æ‡‰è©²è¦è·Ÿæ“š deployment éœ€æ±‚å»åš reconcile (k8s controller) ç¼ºä¹æ¸¬è©¦\nVM / alb / RDS / \u0026hellip; ç­‰å…¬æœ‰é›²æœå‹™éœ€è¦æ¸¬è©¦å— A: AWS / Google / Azure éƒ½æ¸¬éäº†ï¼Œæˆ‘å€‘ä¸ç”¨å†æ¸¬ ç„¶è€Œ SRE å»ç™¼ç¾æ™‚å¸¸éœ€è¦èŠ±æ™‚é–“ debug é€™äº›å…ƒä»¶ ä¸æ˜¯ functional issueï¼Œè€Œæ˜¯ configuration å•é¡Œï¼Œæˆ–æ˜¯ä¸åŒå…ƒä»¶è¨­å®šé€ æˆäº¤äº’ä½œç”¨ B: è¦ä¸Š production çš„å…ƒä»¶éƒ½è¦æ¸¬è©¦ ä½¿ç”¨ terraform provision ä¸€å° EC2 å¾Œï¼Œåœ¨ä½¿ç”¨ terratest (Golang) æ‰“ aws API é€²è¡Œæ¸¬è©¦ æ¨™æº–åŒ–ï¼Œè‡ªå‹•åŒ–å¾Œï¼Œæ‡‰è©²æœ‰å¤§é‡çš„è‡ªå‹•åŒ–æ¸¬è©¦ï¼Œä¾†ç¢ºä¿æ¯ä¸€å€‹å…ƒä»¶çš„ configuration éƒ½æ˜¯æ­£ç¢ºçš„ï¼Œè€Œä¸”æœ‰ä¿¡å¿ƒç¶­æŒç©©å®šåº¦ infra æ™‚å¸¸æ”¹è®Š\næŠ€è¡“å…ƒä»¶æ™‚å¸¸æ”¹è®Šï¼šterraform å‡ç´šï¼Œaws å‡ç´šï¼Œk8s å‡ç´šï¼Œlinux å‡ç´šèˆ‡ patch infra æ²’æœ‰å°„å¾Œä¸ç†é€™ç¨®äº‹ï¼Œéƒ½éœ€è¦æ™‚å¸¸ä¸”ç©©å®šçš„æ›´æ–° ç‚ºäº†æ»¿è¶³ä¸Šæ¸¸æœå‹™(å‰å¾Œç«¯/DB/\u0026hellip;)çš„éœ€æ±‚ èª¿æ•´ VM spec / networking / routing / security rules / ä¸æ–·çš„æ”¹è®Šè€—è²»å¤§é‡çš„äººå·¥æ™‚é–“ production ready éœ€è¦æº–å‚™çš„\nproduction -\u0026gt; çœŸé‡‘ç™½éŠ€ï¼Œå…¬å¸çš„æ¥­å‹™èˆ‡åè² production ready æ‡‰è©²æ˜¯æœ‰æ˜ç¢ºçš„è¡¨æº– True / Falseï¼Œè€Œä¸æ˜¯ã€æˆ‘è¦ºå¾—ç¾åœ¨æ˜¯ production ready äº†ã€ DevOps / SRE éƒ½çŸ¥é“ production ready çš„æ¨™æº–ï¼Œåªæ˜¯æ²’æœ‰æŠŠä»–æ˜ç¢ºå¯«å‡ºä¾† production ready æ‡‰è©²å°±è·Ÿ unit test ä¸€æ¨£ï¼Œä¸€å€‹ checklist è·‘ä¸‹å»æª¢æŸ¥ï¼Œé€šéå°±æ˜¯ production-readyï¼Œä¸é€šéå°±æ˜¯ not-readyï¼Œä¸”æœƒèªªæ˜ä¸é€šéçš„åŸå›  Gruntwork production ready checklist äººå·¥ä»‹å…¥å·¥ä½œå¤ªå¤š\næ–°å¢å…ƒä»¶éœ€è¦äººå·¥è™•è£¡ å®šæœŸçš„ patch \u0026amp; update / å®‰å…¨æ€§æ›´æ–° / deploy éƒ½éœ€è¦äººå·¥ä»‹å…¥çš„è©±å°±å¤ªæµªè²»æ™‚é–“äº† äººå·¥å·¥ä½œå¤ªå¤šå®¹æ˜“é€ æˆäººç‚ºéŒ¯èª¤(human error) å¤šç’°å¢ƒ\nSRE éœ€è¦æä¾›å¤§é‡çš„ç’°å¢ƒ dev / qa / stag / prod \u0026hellip; æˆ–æ˜¯ææ—© scan åˆ°æ›´å‰é¢çš„å·¥ä½œæµç¨‹ï¼Œä¾‹å¦‚åœ¨ code base / reposiroty ä¸­å°±å…ˆ scan Gruntwork solution ç‚ºä½•è¦ä½¿ç”¨ gruntwork framework\nWhy you need a framework\nGruntwork æå‡ºå…©å€‹ solution\nReference Architecture Build your own architecture Prerequisites ç”±æ–¼æœ¬æ¬¡åˆ†äº«ä¸å¸Œæœ›æœ‰å¤šé¤˜çš„è²»ç”¨ï¼Œæ‰€ä»¥å…§å®¹ä¾æ“š gruntwork å…¬é–‹ç¶²ç«™èˆ‡é–‹æºçš„ repository å…§å®¹è¬›è§£ä½¿ç”¨\nä¸æœƒæ¶‰åŠä»˜è²»ç‰ˆçš„ terraform code library å…§å®¹èˆ‡æ•™æ(subscription $795/month) aws æœå‹™ä¹Ÿç›¡é‡ä½¿ç”¨ free tier ä¸­çš„é¡åº¦ Prerequisites\nåŸºæœ¬ Terraform ç¶“é©—ï¼Œæˆ–æ˜¯åƒè€ƒ2021 å¹´çš„éµäººè³½ç³»åˆ—æ–‡ç« : 30 å¤©å­¸ Terraform on Azure åŸºæœ¬ AWS æœå‹™çš„è§€å¿µ éƒ½æ²’æœ‰ä¹Ÿæ²’é—œä¿‚ï¼Œæœƒæ²¿è·¯åœ¨å¹«å„ä½è¤‡ç¿’ 30 å¤©çš„ç›®æ¨™ ä½¿ç”¨ terraform è¨­å®šæ‰€æœ‰ aws account çš„ resource åƒè€ƒ gruntwork-io çš„é–‹æº repositoryï¼Œè¨­å®š å¦‚æœæ˜¯æ¸¬è©¦æˆ–å­¸ç¿’ï¼Œå¯ä»¥åƒè€ƒ https://github.com/gruntwork-io/terraform-aws-service-catalog å­¸ç¿’ç›®æ¨™\nç†Ÿæ‚‰ terraform åŸºæœ¬è§€å¿µ å­¸æœƒä½¿ç”¨ terraform IaC æ§åˆ¶æ‰€æœ‰ aws service Repository NOTE: å¦‚æœæ˜¯æœ‰è³¼è²· gruntwork subscription çš„æœ‹å‹ï¼Œè«‹ä½¿ç”¨ç§æœ‰çš„ IaC library repositoryï¼Œæœ‰æ›´å®Œæ•´ä¸”ç¶“éæ¸¬è©¦çš„æ¶æ§‹\næœ¬èª²ç¨‹ä½¿ç”¨ gruntwork é–‹æºçš„ repository æ¶æ§‹\nè«‹ copy éœ€è¦çš„éƒ¨åˆ†ï¼ˆè€Œä¸è¦ forkï¼Œå› ç‚ºé€™è£¡ä¸éœ€è¦éå»çš„ commit history èˆ‡æœªä¾†çš„ update)\nå»å¹´iThome éµäººè³½ä½¿ç”¨çš„ç¯„ä¾‹ repository æˆ‘è‡ªå·±ä½¿ç”¨çš„ repo ä»Šå¹´ iThome æœƒä½¿ç”¨çš„ repository ä»Šå¤©è¦åšçš„äº‹ è«‹æº–å‚™å¥½ä»¥ä¸‹ prerequisite\nè¨­å®š / è¨»å†Š aws account ä½µå–å¾— aws 12-month free-tier (é æœŸæ˜¯å…è²»çš„é æœŸ 12-month free tier å³å¯åŒ…å«æ‰€æœ‰å…§å®¹) ç„¶è€Œæˆæœ¬æ§åˆ¶ä¹Ÿæ˜¯èª²ç¨‹çš„ä¸€ç’°ï¼Œå„ä½è¦æ³¨æ„ä½¿ç”¨çš„è³‡æºï¼Œä¸è¦è¶…é aws free tier å¤ªå¤šï¼Œç†è«–ä¸Šä¹Ÿæ˜¯æœ€å¤šå¹¾ç¾é‡‘çš„èŠ±è²» å®‰è£èˆ‡è¨­å®š terraform tools terraform 1.2.9 terragrunt 0.38.9 ä½¿ç”¨èˆŠç‰ˆæœ¬çš„æœ‹å‹è«‹ç›¡é‡ä½¿ç”¨ terraform \u0026gt;1.x èˆ‡ terragrunt \u0026gt;0.35.8 çš„ç‰ˆæœ¬ Aws account\nå¦‚æœå·²ç¶“æœ‰ aws cloud service account å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæœ¬èª²ç¨‹æœƒä½¿ç”¨å…¨æ–°çš„ aws account ä½¿ç”¨ email è¨»å†Š aws cloud service email èªè­‰ ä¿¡ç”¨å¡ç™»è¨˜ æ‰‹æ©Ÿèªè­‰ Install terraform\nterraform 1.2.9 terragrunt 0.38.9 è¨­å®š Github repository æº–å‚™ä¸€å€‹ github repository ä¾†å­˜æ”¾ã„çš„ terraform code\nå¯ä»¥ä½¿ç”¨æˆ‘çš„ç¯„ä¾‹ repositoryï¼Œä¹Ÿæ˜¯ fork åº•ä¸‹ gruntwork çš„ repository ç¨ä½œæ•´ç† æˆ–åƒè€ƒ gruntwork Github repository example git clone git@github.com:chechiachang/terragrunt-infrastructure-live-example.git æ˜å¤© å¸¶è‘—å¤§å®¶åœ¨ terraform code ä¸­è¨­å®š aws account èˆ‡ IAM æ¬Šé™\nåƒè€ƒè³‡æº ä¸ç†Ÿæ‚‰ terraform çš„æœ‹å‹ä¸å¦¨åƒè€ƒå»å¹´çš„ä½³ä½œ Terraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©ï¼Œé›–ç„¶æ˜¯åœ¨ Azure ä¸Š ï¼Œä½†è¨±å¤šåŸºæœ¬æ¦‚å¿µéƒ½æ˜¯ç›¸é€šçš„\néå»çš„éµäººè³½æ–‡ç« \n13th ä½³ä½œ Terraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤© 12th ä½³ä½œ Kubernetes X DevOps X å¾é›¶é–‹å§‹å°å…¥å·¥å…· X éœ€æ±‚åˆ†æï¼Šå¾åº•å±¤é–‹å§‹ç ”ç©¶åˆ°æ‡·ç–‘äººç”Ÿçš„é«”æ‚Ÿï¼Š 11th å„ªå‹ å…¶å¯¦æˆ‘çœŸçš„æ²’æƒ³éåªæ˜¯æŠŠæœå‹™ä¸Ÿä¸Š kubernetes å°±æœ‰é€™éº¼å¤šå•é¡Œåªå¥½ä¾†åƒåŠ 30å¤©åˆ†äº«é‚£äº›å¹´æˆ‘æ€éº¼åœ¨ kubernetes ä¸Šè¸©é›·å„é …æœå‹™ kkk æ¨è–¦ä¸€ä¸‹ Gruntwork ä»–å€‘å®¶çš„ blog: Gruntwork devops as a service\nQ\u0026amp;A éå»åƒè³½éƒ½æœƒæœ‰è¨±å¤šæœ‹å‹æå‡ºå•é¡Œï¼Œä»Šå¹´è‹¥æœ‰ç–‘å•å¯ä»¥é›†ä¸­åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘æœƒè·Ÿå¤§å®¶ä¸€èµ·è¨è«–ã€‚æœ‰æƒ³è¦çœ‹çš„é¡Œç›®ä¹Ÿå¯ä»¥ç•™è¨€ï¼Œæˆ‘å€‘çœ‹æ™‚é–“åšå®‰æ’ã€‚\nreferences https://docs.gruntwork.io/intro/overview/how-it-works ","permalink":"https://chechia.net/posts/2022-09-12-14th-ithome-ironman-iac-aws-workshop-01-introduction/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10290931\"\u003eiThome éµäººè³½å¥½è®€ç‰ˆ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003e\u0026ndash;\u003c/p\u003e\n\u003cp\u003eAWS ç‚ºä¾‹ï¼Œå¯¦ç¾ production framework çš„æœ€ä½³å¯¦è¸çš„ 30 å¤© workshop\u003c/p\u003e\n\u003ch1 id=\"æº–å‚™-production-environmtn-devops-é¢è‡¨çš„å•é¡Œ\"\u003eæº–å‚™ Production environmtn Devops é¢è‡¨çš„å•é¡Œ\u003c/h1\u003e\n\u003cp\u003eDevOps çš„å·¥ä½œå…§å®¹ç¹é›œ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä»Šå¤©æƒ³è¦ Deploy ä¸€å€‹ backend API deployment åˆ° k8s ä¸Š\u003c/li\u003e\n\u003cli\u003eä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® port / servie / ingress / alb\u003c/li\u003e\n\u003cli\u003eä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® tls certificate\u003c/li\u003e\n\u003cli\u003eä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® node linux ä¸Šçš„ä¸€å€‹ bug\u003c/li\u003e\n\u003cli\u003eä¸€è½‰çœ¼ç™¼ç¾è‡ªå·±åœ¨ä¿® monitoring / metrics + alert / log collection\n\u0026hellip;\u003c/li\u003e\n\u003cli\u003eæˆ‘åªæ˜¯æƒ³ deploy ä¸€å€‹ backend deployment\n\u003cul\u003e\n\u003cli\u003eä¿®infra èŠ±äº†å¥½å¹¾å¤©ï¼Œè€Œå¯« deployment åªè¦ 2 hr\u003c/li\u003e\n\u003cli\u003eDevops çš„å·¥ä½œï¼Œæ˜¯è™•ç† developer èˆ‡ operator ä¸­é–“çš„ç¹é›œçš„ç´°ç¯€\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ›å€‹è§’åº¦æ€è€ƒï¼šä¸Šé¢é€™äº›å…ƒä»¶å…¨éƒ½æ˜¯å­˜åœ¨è¨±ä¹…çš„åŠŸèƒ½ï¼Œæ‡‰è©²æœ‰ä¸€å¥—çµ±ä¸€ä»‹é¢éš¨å«å³ç”¨é€™äº›æœå‹™ï¼Œex.\u003c/p\u003e","title":"IaC best practice workshop on aws"},{"content":"Titleq å¾é›¶å°å…¥ Policy as Code åˆ° terraform ç”˜è‹¦è«‡ - Introducing policy as code for terraform\nPresentation Google Slides\nDescription Terraform æ˜¯ä¸€å€‹å¾ˆæ£’çš„ Infrastructure as Code çš„å·¥å…·ï¼Œèƒ½å¤ ä»¥ç¾ä»£çš„è»Ÿé«”å·¥ç¨‹æµç¨‹ä¾†ç©©å®šçš„å»ºæ§‹ infrastructureï¼Œä¸¦éš¨è‘—éœ€æ±‚è®Šæ›´è‡ªå‹•åŒ–è¿­ä»£ï¼Œå°‡æ–°çš„ feature å®‰å…¨åœ°æ›´æ–°åˆ°æ—¢æœ‰çš„ infrastructure ä¸Šã€‚åªè¦æ˜¯ Infrastructure æœ‰é—œçš„å•é¡Œï¼Œæˆ‘ä¸€å¾‹æ¨è–¦ Terraformã€‚\né€™ä¹Ÿæ„å‘³ Terraform çš„å“è³ªå°±ç­‰æ–¼ infrastructure çš„å“è³ªï¼Œå¥½çš„ terraform å¸¶ä½ ä¸Šå¤©å ‚ï¼Œä¸å¥½çš„ terraform å…¨ team ç«è‘¬å ´ã€‚\nInfrastructure æœ‰å¤ªå¤šè³‡å®‰çš„è€ƒé‡ï¼Œæ–°çš„é¢¨éšªä¸æ–·è¢«æª¢æŸ¥å‡ºä¾†ï¼Œé€£å¸¶è¦ä¸æ–·çš„ patch terraform code ä¾†é¿å…æ½›åœ¨çš„è³‡å®‰é¢¨éšª Infrastructure æœƒä¸æ–·åœ°æ›´æ–°ï¼Œä¾‹å¦‚å…¬æœ‰é›²çš„ api ä¸æ–·æ›´æ–°ï¼Œå»å¹´çš„ code å·²ç¶“è·Ÿä¸ä¸Šä»Šå¹´çš„æœ€ä½³å¯¦è¸äº† å¥½çš„å·¥ç¨‹å¸«å¯«å‡ºçš„ terraform code å±Œæ‰“èœé³¥å·¥ç¨‹å¸«ï¼Œè¦å¦‚ä½•è®“åœ˜éšŠä¾å¾ªæ›´å¥½çš„å¯¦è¸ï¼Œé¿å…å¯«å‡ºçˆ› code ç¶­è­· code æœ‰ clean code / best practiceï¼ŒTerraform ä¹Ÿæœ‰ clean code èˆ‡ best practiceï¼Œå·¥ç¨‹å¸«è¦å¦‚ä½•å·¥å…·ä¾†è¼”åŠ©ï¼Œæ˜¯ Policy as Code çš„ä¸€å¤§èª²é¡Œã€‚ æœ¬æ¼”è¬›èšç„¦æ–¼å¯¦éš›ç¶“é©—ï¼Œå¾ä¸€å¤§å † terraform modules é–‹å§‹ï¼Œæ²’æœ‰ Policy as Codeï¼Œåˆ°ä¸€æ­¥æ­¥è©•ä¼°ã€å°å…¥ã€å¯¦ä½œã€æ”¹é€²èˆ‡è¿­ä»£ï¼Œé€æ¼¸çš„æå‡åœ˜éšŠ Terraform code å“è³ªï¼Œæå‡ infrastructure äº¤ä»˜å“è³ªï¼Œä¸¦é¿å…åˆ°æœªä¾†æ½›åœ¨çš„é¢¨éšªã€‚\næœ¬æ¬¡æ¼”è¬›çš„ Terraform ç‰ˆæœ¬ç‚ºå¾ 0.12, 0.13, ä¸€è·¯æ¨é€² 1.0+ã€‚\nContent å¾é›¶å°å…¥ Policy as Code åˆ° terraform ç”˜è‹¦è«‡\nç°¡ä»‹ Terraform èˆ‡ Policy as Code ç•¶ä½ æ‰‹ä¸Šæœ‰æ•¸ä¸å®Œçš„ terraform modulesï¼Œç®¡ç† terraform å“è³ªæ˜¯å€‹å¤§å•é¡Œ å¦‚ä½•ç®¡ç† Terraform è‡ªå‹•åŒ–: æ”¹è®Šå¾ Jenkins pipeline é–‹å§‹ï¼Œgitflow æ”¹é€²ï¼Œpre-commit hook Policy as Code æ ¡é©— ä½¿ç”¨å·¥å…·é‡åŒ– terraform code å“è³ª å®Œæ•´å°å…¥ Policy as Code å°çµ: ç© infra å¿…ç”¨ terraformï¼Œç© terraform å¿…åš policy as code About me Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit 2019 Ithome Cloud Summit 2020 Ithome Cloud Summit 2020/12/18\tCloud Native Taiwan å¹´æœ«èšæœƒ 2020/8/17\tDevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2021 Ithome Cloud Summit 2022 Ithome Cloud Summit 2022 COSCUP\nSuggested Audience æ¨è–¦æœ‰ Terraform ä½¿ç”¨ç¶“é©—ï¼Œç‰¹åˆ¥æ˜¯å…¬æœ‰é›²ç¶“é©—ï¼Œå° Policy as Code æœ‰èˆˆè¶£çš„äºº æƒ³è¦å¯«å‡º Terraform clean code çš„äºº ","permalink":"https://chechia.net/posts/2022-06-09-ithome-devopsday-2022-proposal-introduce-policy-as-code-for-terraform-/","summary":"\u003ch3 id=\"titleq\"\u003eTitleq\u003c/h3\u003e\n\u003cp\u003eå¾é›¶å°å…¥ Policy as Code åˆ° terraform ç”˜è‹¦è«‡ - Introducing policy as code for terraform\u003c/p\u003e\n\u003ch3 id=\"presentation\"\u003ePresentation\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://docs.google.com/presentation/d/1yawazO1B_sP5Yiav-XLGJXW3ZS2JTV0wGuJwhrUKQ3A/edit?usp=sharing\"\u003eGoogle Slides\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"description\"\u003eDescription\u003c/h3\u003e\n\u003cp\u003eTerraform æ˜¯ä¸€å€‹å¾ˆæ£’çš„ Infrastructure as Code çš„å·¥å…·ï¼Œèƒ½å¤ ä»¥ç¾ä»£çš„è»Ÿé«”å·¥ç¨‹æµç¨‹ä¾†ç©©å®šçš„å»ºæ§‹ infrastructureï¼Œä¸¦éš¨è‘—éœ€æ±‚è®Šæ›´è‡ªå‹•åŒ–è¿­ä»£ï¼Œå°‡æ–°çš„ feature å®‰å…¨åœ°æ›´æ–°åˆ°æ—¢æœ‰çš„ infrastructure ä¸Šã€‚åªè¦æ˜¯ Infrastructure æœ‰é—œçš„å•é¡Œï¼Œæˆ‘ä¸€å¾‹æ¨è–¦ Terraformã€‚\u003c/p\u003e\n\u003cp\u003eé€™ä¹Ÿæ„å‘³ Terraform çš„å“è³ªå°±ç­‰æ–¼ infrastructure çš„å“è³ªï¼Œå¥½çš„ terraform å¸¶ä½ ä¸Šå¤©å ‚ï¼Œä¸å¥½çš„ terraform å…¨ team ç«è‘¬å ´ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInfrastructure æœ‰å¤ªå¤šè³‡å®‰çš„è€ƒé‡ï¼Œæ–°çš„é¢¨éšªä¸æ–·è¢«æª¢æŸ¥å‡ºä¾†ï¼Œé€£å¸¶è¦ä¸æ–·çš„ patch terraform code ä¾†é¿å…æ½›åœ¨çš„è³‡å®‰é¢¨éšª\u003c/li\u003e\n\u003cli\u003eInfrastructure æœƒä¸æ–·åœ°æ›´æ–°ï¼Œä¾‹å¦‚å…¬æœ‰é›²çš„ api ä¸æ–·æ›´æ–°ï¼Œå»å¹´çš„ code å·²ç¶“è·Ÿä¸ä¸Šä»Šå¹´çš„æœ€ä½³å¯¦è¸äº†\u003c/li\u003e\n\u003cli\u003eå¥½çš„å·¥ç¨‹å¸«å¯«å‡ºçš„ terraform code å±Œæ‰“èœé³¥å·¥ç¨‹å¸«ï¼Œè¦å¦‚ä½•è®“åœ˜éšŠä¾å¾ªæ›´å¥½çš„å¯¦è¸ï¼Œé¿å…å¯«å‡ºçˆ› code\nç¶­è­· code æœ‰ clean code / best practiceï¼ŒTerraform ä¹Ÿæœ‰ clean code èˆ‡ best practiceï¼Œå·¥ç¨‹å¸«è¦å¦‚ä½•å·¥å…·ä¾†è¼”åŠ©ï¼Œæ˜¯ Policy as Code çš„ä¸€å¤§èª²é¡Œã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæœ¬æ¼”è¬›èšç„¦æ–¼å¯¦éš›ç¶“é©—ï¼Œå¾ä¸€å¤§å † terraform modules é–‹å§‹ï¼Œæ²’æœ‰ Policy as Codeï¼Œåˆ°ä¸€æ­¥æ­¥è©•ä¼°ã€å°å…¥ã€å¯¦ä½œã€æ”¹é€²èˆ‡è¿­ä»£ï¼Œé€æ¼¸çš„æå‡åœ˜éšŠ Terraform code å“è³ªï¼Œæå‡ infrastructure äº¤ä»˜å“è³ªï¼Œä¸¦é¿å…åˆ°æœªä¾†æ½›åœ¨çš„é¢¨éšªã€‚\u003c/p\u003e","title":"IThome 2022 DevOpsDay Introducing policy as code for terraform"},{"content":"Titleq åœ¨ k8s ä¸Šè·‘ time series database ç”˜è‹¦è«‡ - Operating Time Series Database in K8s\nGoogle Slides Youtube live record: https://youtu.be/YexUnVOZC8M?t=9421\nDescription Influxdb ç‚ºå¸‚å æœ€é«˜çš„ time series DBMS ä¹‹ä¸€ï¼Œä½¿ç”¨ä¸Šèˆ‡ RDBMS æœ‰ä¸åŒå„ªåŠ£å‹¢ã€‚\nåœ¨ç¶­é‹æ–¹é¢ï¼Œdatabase æœ‰è¨±å¤šç›¸ä¼¼éœ€æ±‚ï¼šç©©å®šæ€§ã€é«˜å¯ç”¨æ€§ã€å‚™ä»½ã€é‚„åŸã€è³‡æºç®¡ç†ã€èª¿åº¦ã€ç½é›£å¾©åŸ\u0026hellip;ç­‰ã€‚ç¤¾ç¾¤å¸¸è½åˆ°æœ‰äººå•ï¼šå¯ä¸å¯ä»¥åœ¨ K8s ä¸Šè·‘ databaseã€‚\næœ¬æ¼”è¬›æœƒåˆ†äº«åœ¨ k8s ä¸­ç¶­é‹ï¼Œå¯¦å‹™ä¸Šæ‰€é‡åˆ°çš„å•é¡Œï¼Œæä¾›ä¸€äº›æ€è€ƒæ–¹å‘ã€‚\næœ¬æ¬¡æ¼”è¬›çš„ influxdb ç‰ˆæœ¬ç‚º Influxdb OSS / enterprise 1.9+\nInfluxDB is one the the most popular time series database management system (DBMS) and is a powerful platform when dealing with time series data.\nDBMSs, including RDBMS, have many similar requirements on aspect of infrastructure operation. They all require stability, high availability, backup and restore utilities, cpu / memory resource management, disaster recovery\u0026hellip;etc. People often ask about that whether is it ok to run DBMS in kubernetes cluster or not. This lecture try to provide some points from our experiences dealing with real-world issues.\nThe version of InfluxDB discussed in the lecture is InfluxDB OSS / Enterprise 1.9+\nContent åœ¨ k8s ä¸Šè·‘ time series database ç”˜è‹¦è«‡\nç°¡ä»‹ Influxdbï¼Œtime series èˆ‡ RDBMS çš„å·®ç•° ä½¿ç”¨ time series çš„å¹¾å€‹æƒ…å¢ƒ: åœ¨ k8s ä¸Šè·‘ DB ç©©å®šæ€§ Availabilityã€HA (enterprise)ã€faillure recovery è³‡æºç®¡ç† OOMKilledã€cpu throttlingã€OutOfDisk DB management: data migrationã€backup \u0026amp; restoreã€data retention å°çµ: ä½ è©²ä¸è©²ç”¨ cloud service / VM / åœ¨ K8s ä¸Šè·‘ database Operating Time Series Database in K8s\nA brief introduction about InfluxDB and the differences with RDBMS Some scenario to use a time series database (other than RDBMS) Operate InfluxDB in K8s Stability, availability, disaster recovery Resource management, OOMKilled, cpu throttling, out of disk DB management: data migration, retention, rotation, backup \u0026amp; restore summary: whether or not to run a database in k8s About me Che-Chia Changï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ Microsoft æœ€æœ‰åƒ¹å€¼å¾æ¥­äººå“¡ MVPã€‚\nç›®å‰ç‚º Golang Taiwan Meetup Organizerï¼Œå¸¸å‡ºç¾æ–¼ CNTUGï¼ŒDevOps Taipeiï¼ŒGDG Taipeiï¼Œ Golang Taipei Meetupã€‚\nChe-Chia Chang, an SRE specialize in container and Kubernetes operation. An active member of CNTUG, DevOps Taipei, GDS Taipei, Golang Taiwan Meetup. Microsoft Most Valuable Professional since 2020.\nhttps://chechia.net\n2018 Ithome Cloud Summit 2018 Ithome Kubernetes Summit 2019 Ithome Cloud Summit 2020 Ithome Cloud Summit 2020/12/18\tCloud Native Taiwan å¹´æœ«èšæœƒ 2020/8/17\tDevOps Taiwan Meetup #26 - å¾é›¶é–‹å§‹å°å…¥ Terraform 2021 Ithome Cloud Summit\nSuggested Audience æ¨è–¦æœ‰ k8s ä½¿ç”¨ç¶“é©—çš„å¾æ¥­äººå“¡ï¼Œå° k8s æœ‰ä¸Šæ‰‹ç¶“é©— å•å¯ä¸å¯ä»¥åœ¨ k8s ä¸Šé¢è·‘ database çš„äºº ","permalink":"https://chechia.net/posts/2022-05-21-coscup-proposal-operating-time-series-database-in-k8s/","summary":"\u003ch3 id=\"titleq\"\u003eTitleq\u003c/h3\u003e\n\u003cp\u003eåœ¨ k8s ä¸Šè·‘ time series database ç”˜è‹¦è«‡ - Operating Time Series Database in K8s\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://docs.google.com/presentation/d/1PZryGImYRALMJfbEMuf_jPd2P-qzIwDmVd5DgXSuqq0/edit\"\u003eGoogle Slides\u003c/a\u003e\nYoutube live record: \u003ca href=\"https://youtu.be/YexUnVOZC8M?t=9421\"\u003ehttps://youtu.be/YexUnVOZC8M?t=9421\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"description\"\u003eDescription\u003c/h3\u003e\n\u003cp\u003eInfluxdb ç‚ºå¸‚å æœ€é«˜çš„ time series DBMS ä¹‹ä¸€ï¼Œä½¿ç”¨ä¸Šèˆ‡ RDBMS æœ‰ä¸åŒå„ªåŠ£å‹¢ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ç¶­é‹æ–¹é¢ï¼Œdatabase æœ‰è¨±å¤šç›¸ä¼¼éœ€æ±‚ï¼šç©©å®šæ€§ã€é«˜å¯ç”¨æ€§ã€å‚™ä»½ã€é‚„åŸã€è³‡æºç®¡ç†ã€èª¿åº¦ã€ç½é›£å¾©åŸ\u0026hellip;ç­‰ã€‚ç¤¾ç¾¤å¸¸è½åˆ°æœ‰äººå•ï¼šå¯ä¸å¯ä»¥åœ¨ K8s ä¸Šè·‘ databaseã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ¼”è¬›æœƒåˆ†äº«åœ¨ k8s ä¸­ç¶­é‹ï¼Œå¯¦å‹™ä¸Šæ‰€é‡åˆ°çš„å•é¡Œï¼Œæä¾›ä¸€äº›æ€è€ƒæ–¹å‘ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›çš„ influxdb ç‰ˆæœ¬ç‚º Influxdb OSS / enterprise 1.9+\u003c/p\u003e\n\u003cp\u003eInfluxDB is one the the most popular time series database management system (DBMS) and is a powerful platform when dealing with time series data.\u003c/p\u003e\n\u003cp\u003eDBMSs, including RDBMS, have many similar requirements on aspect of infrastructure operation. They all require stability, high availability, backup and restore utilities, cpu / memory resource management, disaster recovery\u0026hellip;etc. People often ask about that whether is it ok to run DBMS in kubernetes cluster or not. This lecture try to provide some points from our experiences dealing with real-world issues.\u003c/p\u003e","title":"2022 05 21 COSCUP Operating Time Series Database in K8s"},{"content":"å„ä½å¥½\né—œæ–¼é€™å€‹ QRcode\næ¯æ¬¡ä¸Šå°å‰ï¼Œæˆ‘éƒ½æœƒæƒ³è¦å¸¶ä»€éº¼æ¨£çš„å…§å®¹çµ¦è§€çœ¾ï¼Œè®“è§€çœ¾å€¼å¾—èŠ± 30 åˆ†é˜åœ¨åº•ä¸‹è½ã€‚å¾Œä¾†å°±ç¿’æ…£å…ˆç™¼è¡¨ä¸€ç¯‡æ–‡ç« ï¼ŒæŠŠå°è§€çœ¾æœ‰å¹«åŠ©çš„è³‡æºåŒ…æˆä¸€åŒ…ï¼š\né¦–å…ˆæ˜¯å®Œæ•´æŠ•å½±ç‰‡ï¼šhttps://slides.com/chechiac\u0026hellip;/terraform-introduction-a56697 é€å­—è¬›ç¨¿ï¼š(æœ€å¾Œæ ¡ç¨¿ä¸­ï¼‰ ç„¶è€Œåªæœ‰æœ¬æ¬¡æ¼”è¬›å…§å®¹ï¼Œå›å»å¯èƒ½é‚„æ˜¯ä¸å¤ªå®¹æ˜“æ“ä½œã€‚æ‰€ä»¥é€™æ¬¡é™„ä¸Šä½¿ç”¨ Terraform ä¸€éµéƒ¨ç½² vault çš„ Github Repositoryï¼šhttps://github.com/\u0026hellip;/southe\u0026hellip;/chechia_net/vault/singleton å¦‚æœä¸ç†Ÿ Terraformï¼Œå†é™„ä¸Š 30 å¤©æ‰‹æŠŠæ‰‹ Terraform æ•™å­¸æ–‡ç« ï¼Œåªè¦é¡˜æ„èŠ±æ™‚é–“ï¼Œå…¨ç¯‡ä¸­æ–‡ä¸€å€‹æœˆå¸¶ä½ ä¸Šæ‰‹ Terraformã€‚ IThome éµäººè³½å¥½è®€ç‰ˆï¼šhttps://ithelp.ithome.com.tw/users/20120327/ironman/4057 Github Repository å®Œæ•´ç‰ˆï¼šhttps://github.com/\u0026hellip;/terraform-30\u0026hellip;/tree/main/lecture/zh å¦‚æœé‡åˆ°å•é¡Œé‚„æ˜¯éœ€è¦æ‰¾äººç™¼å•ï¼Œæ‰€ä»¥å†æ¨è–¦å…©å€‹ç¤¾ç¾¤ï¼Œå¯ä»¥ä¾†é€™é‚Šç™¼å•ï¼Œè¦æ‰¾æˆ‘æœ¬äººä¹Ÿæ‰¾å¾—åˆ°ã€‚ç”šè‡³åªæ˜¯åŠ å…¥æ½›æ°´ä¸è¬›è©±ï¼Œéƒ½å¯ä»¥è¢«å‹•å¸æ”¶è¨±å¤šæ–°çŸ¥ã€‚ Cloud Native Taiwan User Group https://t.me/cntug https://fb.cloudnative.tw DevOps Taiwan Meetup Group https://t.me/devopstw å¤§å®¶å¯ä»¥æ‰‹æ©Ÿæ‹å®Œé€™å€‹å°±å‡ºå»åƒåˆé¤äº†ã€‚ æˆ–æ˜¯æ‹å›å®¶ï¼Œç„¶å¾Œå‚³çµ¦ä¸€å€‹åŒäº‹å«ä»–èŠ± 30 å¤©æŠŠ Terraform è·Ÿ Vault é€™äº›éƒ½å­¸æœƒã€‚\nç¸½ä¹‹å¸Œæœ›å°å„ä½æœ‰å¹«åŠ©ï¼Œè®“åœ‹å…§æŠ€è¡“åŠ›èƒ½æŒçºŒé€²æ­¥æˆé•·ã€‚\nå›åˆ°æœ¬æ¬¡æ¼”è¬›ã€‚\næœ¬æ¬¡æ¼”è¬›æœ‰ä¸‰å€‹é—œéµå­—\nKubernetes Vault Terraform é€™å€‹æ˜¯éš±è—çš„ è«‹å•å¹³æ™‚å·¥ä½œæœƒç”¨åˆ°é€™ä¸‰å€‹æŠ€è¡“ä¹‹ä¸€çš„æœ‹å‹ï¼Œè«‹èˆ‰å€‹æ‰‹ï¼Œå¥½è®“æˆ‘çŸ¥é“ä¸€ä¸‹è§€çœ¾çš„åˆ†å¸ƒï¼Œç­‰ç­‰åˆ†äº«çš„å…§å®¹æœƒç…§æ¯”ä¾‹åšä¸€äº›èª¿æ•´ã€‚\næˆ‘å€‘ä»Šå¤©ä¸æœƒè¬›å¤ªå¤š Kubernetes çš„å…§å®¹ï¼Œé‡é»æ”¾åœ¨ Vaultï¼Œä»¥åŠå¦‚ä½•è¨­å®š Vaultï¼Œæ‰€ä»¥ Terraform Infrastructure as Code æˆ–æ˜¯ configuration as Code æœƒåœ¨é€™é‚Šè·‘å‡ºä¾†ã€‚\né—œæ–¼æˆ‘ï¼Œæˆ‘æ˜¯å“²å˜‰ã€‚æˆ‘åœ¨ Maicoin ç•¶ SREã€‚å¸¸å‡ºç¾çš„ç¤¾ç¾¤æ˜¯ CNTUG èˆ‡ DevOpsTWã€‚\næˆ‘å€‘ä»Šå¤©è«‡çš„æ›´å¤§çš„ä¸»é¡Œå…¶å¯¦æ˜¯ Key Management ç§é‘°ç®¡ç†ï¼Œæˆ–æ˜¯å¯†ç¢¼ç®¡ç†ã€‚é€™æ˜¯ä¸€å€‹å¾ˆå¤§çš„é¡Œç›®ï¼Œä»Šå¤©æ¼”è¬›å…§å®¹åªæ˜¯å…¶ä¸­çš„ä¸€å€‹å¯¦ä½œæ¡ˆä¾‹ã€‚\nèˆ‰å€‹ä¾‹å­ï¼Œä¸€é‚Šæ˜¯ API Serverï¼Œå¦ä¸€é‚Š Databaseï¼Œæˆ–æ˜¯ç¬¬ä¸‰æ–¹æœå‹™\nDatabase ä¾† Authenticate åˆæ³•çš„ Client ç”¨æˆ¶ç«¯ï¼Œå¯èƒ½æ˜¯ username + passwordï¼Œæˆ–æ˜¯ API Key + Secretï¼Œæˆ–æ˜¯ Access Tokenï¼Œæˆ–æ˜¯ Private Keyï¼ŒClient Certificateï¼Œéƒ½å¯ä»¥ã€‚\nåœ¨è·¨ä¸åŒå¹³å°æˆ–æ˜¯ä»‹é¢çš„æœå‹™ï¼Œæˆ‘å€‘å¸¸ç”¨çš„ Auth æ–¹æ³•ã€‚èª Key ä¸èªäººã€‚\né‚£ä¸­é–“é€™äº› Key è¦æ€éº¼ç®¡ç†ï¼Œå°±æœ‰å¾ˆå¤šå­¸å• å…¶ä¸­æœ€åŸºæœ¬çš„ï¼Œæ˜¯æ€éº¼é…ç½®çµ¦ API Server è®“ä»–ä½¿ç”¨ æ³¨æ„ï¼šè®“ API Server ä½¿ç”¨ï¼Œéš±å«çš„æ„æ€æ˜¯ï¼Œå…¶ä»–äººä¸ç®¡æ˜¯å…¶ä»–å¾®æœå‹™ï¼Œæˆ–æ˜¯é–‹ç™¼å·¥ç¨‹å¸«ï¼Œé–’é›œäººç­‰éƒ½ä¸èƒ½çœ‹åˆ°ã€‚\né€™é‚Šæˆ‘å€‘å‡è¨­ API Server æ˜¯åœ¨ Kubernetes è£¡é¢è·‘ï¼Œå¾®æœå‹™æ¶æ§‹ï¼Œæ‰€ä»¥ API Server å¯èƒ½æ˜¯ä¸€å€‹ Podï¼Œæˆ‘å€‘ SRE è¦ç‚ºé€™çµ„ Pod é…ç½®å¯†ç¢¼ã€‚\né€™é‚Šåˆ—å‡ºçš„æ‡‰è©²æ˜¯ K8s æ¯”è¼ƒå¸¸è¦‹çš„å¹¾ç¨®åšæ³•ã€‚\nplain textï¼Œç›´æ¥å¯«é€² file è®“ Pod å»è®€å– k8s secret åš base64 encode å®‰å…¨ä¸€é»çš„é€éå¤–éƒ¨æ©Ÿåˆ¶ä½œåŠ å¯†è§£å¯† æˆ–æ˜¯å¯«åœ¨ API Server çš„ memory ä¸­ äº‹å¯¦ä¸Šå¦‚æœæ²’æœ‰ä½¿ç”¨ K8sï¼Œä½¿ç”¨ VM æˆ–æ˜¯å…¬æœ‰é›² Container Serviceï¼Œæ‡‰è©²éƒ½æ˜¯é¡ä¼¼çš„åŸç†ï¼Œå¤§å®¶éƒ½æ˜¯ Linux baseï¼Œsecret æ”¾é€²ä¾†çœ‹è¦æ”¾åœ¨ disk æˆ–æ˜¯ memory è£é¢ã€‚\nå¯¦éš›æ”¾åˆ° K8s å¤§æ¦‚æœƒé•·é•·é€™äº› yaml\næœ€ç°¡å–®ï¼Œå°±ç›´æ¥æŠŠ secret å£“åˆ° Pod env è£é¢ï¼Œ\næœ€ç°¡å–®ä¹Ÿæœ€å±éšª\næ‰€æœ‰çœ‹å¾—åˆ° yaml çš„äººéƒ½æ˜ç¢¼çœ‹è¦‹å¯†ç¢¼ æ‰€æœ‰èƒ½é€²åˆ° file system æå¤–è©±\nAPI Server è¢«å¾æ­£é¢æ‰“ç©¿ï¼Œæ»²é€åˆ°æ‹¿åˆ°é€™çµ„å¯†ç¢¼çš„æ©Ÿæœƒå¤šé«˜ï¼Ÿ\nå¦‚æœ API Server golang library æœ‰åœ¨è·Ÿå®‰å…¨æ€§æ›´æ–° Kubernetes ç”¨å…¬æœ‰é›²çš„ Kubernetes Serviceï¼Œæœ‰åœ¨æ›´æ–° OS ami è·Ÿ docker image éƒ½æœ‰åœ¨æ›´æ–° ç„¶å¾Œæœ‰åŠŸèƒ½æ­£å¸¸çš„é˜²ç«ç‰† æ‰“æ›è »æœ‰å¯èƒ½çš„ï¼Œä½†æ‰“ç©¿æœå‹™åˆ°æ‹¿åˆ°å¯†ç¢¼ï¼Œæ˜¯æœ‰é›£åº¦çš„ã€‚\næ›´å¤šæ™‚å€™ï¼Œè‡³å°‘åœ¨å¹£åœˆæœ‰è¢«çˆ†å‡ºä¾†çš„è³‡å®‰äº‹ä»¶ï¼Œå¤§å¤šæ˜¯æ˜¯å…¬å¸å“¡å·¥è¢«é‡£é­šä¿¡æ‰åˆ°ï¼Œè¢«æ¤å…¥æƒ¡æ„è»Ÿé«”åœ¨ local é›»è…¦ï¼Œç„¶å¾Œä»–åˆçœ‹å¾—åˆ°æ˜ç¢¼çš„å¯†ç¢¼ï¼Œç›´æ¥çˆ†ç‚¸ã€‚\næ˜ç¢¼ç³Ÿç³•çš„åœ°æ–¹ï¼Œå¤§å®¶éƒ½çœ‹å¾—åˆ°ï¼Œä¸€é–‹å§‹å°±æ˜¯ exposed çš„ç‹€æ…‹ï¼Œé¢¨éšªä¸å¯æ§ï¼Œä¹Ÿç„¡å¾ç®¡åˆ¶ã€‚\nç„¶å¾Œæ˜¯ K8s secretï¼Œä¹Ÿæ˜¯å¾ env æ›é€²å» Pod\næ”¾åœ¨ k8s secretï¼Œæ˜¯ base64 çš„æ ¼å¼\nçœ‹èµ·ä¾†è·ŸåŸå…ˆå…§å®¹ä¸ä¸€æ¨£äº†ï¼Œæœ‰äººå°±è·Ÿæˆ‘èªªï¼Œä»–å€‘å®¶çš„ k8s secret æœ‰ç”¨ base64 åŠ å¯†ã€‚\nencode è·Ÿ encrypt\nk8s secret æœ‰ä»€éº¼å•é¡Œ\næ˜ç¢¼ plain text çš„å•é¡Œï¼Œä¸è©²çœ‹åˆ°çš„äººå¾ˆå®¹æ˜“å°±çœ‹åˆ° æ ¹æœ¬çš„å•é¡Œé‚„æ˜¯ RBAC æ‡¶å¾—è¨­å®šï¼Œå¤§å®¶éƒ½ç”¨ default role é€²ä¾† è¦ç”¨å¯ä»¥ï¼Œå…ˆçœ‹ k8s secret å¾Œé¢çš„å„²å­˜å¯¦ä½œæ˜¯ä»€éº¼ï¼Ÿ\næ˜¯ k8s etcd é€é k8s API server å­˜å– etcd è·Ÿ kube-api ä¸€èˆ¬ä¾†èªªæ˜¯å¤ å®‰å…¨çš„ã€‚å®˜æ–¹æ–‡ä»¶é‚„å»ºè­°\nsecret è¦åŠ å¯† encrypt å¢å¼· RBAC æ§åˆ¶ï¼Œåªæœ‰ç‰¹å®š role æ‰çœ‹å¾—åˆ° secretï¼Œï¼Œè€Œä¸æ˜¯æ¯å€‹äººéƒ½ç”¨ default role è¿‘ä¾† k8sï¼Œç„¶å¾Œé€²åˆ° namespace å…¨éƒ¨ secret å°±çœ‹å…‰å…‰ RBAC æœ‰è¨­å®šå¥½ï¼Œæœ‰åŠ å¯†ï¼Œæ˜¯å¯ä»¥åšåˆ°å®‰å…¨ã€‚ç•¶ç„¶é‚„æ˜¯æ²’æœ‰å°ˆé–€ key Management å·¥å…·ï¼Œå¦‚ Vault æœ‰é¡å¤–ç®¡ç†ä¸Šçš„å„ªåŒ–åŠŸèƒ½ã€‚\nåŠ å¯†ç¯„ä¾‹å¯ä»¥çœ‹å¼·è€…æˆ‘æœ‹å‹çš„æ–‡ç« \nåŠ å¯†å®Œå¯èƒ½é•·é€™æ¨£ï¼Œé‚„è¦é¡å¤–é€éå…¶ä»–æ©Ÿåˆ¶æ‰èƒ½é€²è¡Œè§£å¯†ï¼Œæ‹¿åˆ°åŸå§‹è³‡æ–™\nä¾‹å¦‚é€é k8s controller è§£å¯† æˆ–æ˜¯é€é vault server æˆ–æ˜¯é€éå…¬æœ‰é›²çš„ Key Management Service åšè§£å¯† å…¶ä»–çš„ k8s secret åŠ å¯†è§£æ±ºæ–¹æ¡ˆ\nä»Šå¤©æˆ‘å€‘ä½¿ç”¨ Vaultï¼Œå…¶ä¸­ä¸€å€‹ç›®çš„å°±æ˜¯è¦åä¸­é–“é€™æ®µ Safe Magic\nçµ¦é€™å€‹ Pod secret ç„¶å¾Œåªçµ¦é€™å€‹ Pod Secret ç•¶ç„¶ Key Management å…¶ä»–é‚„æœ‰ä¸€å †äº‹æƒ…è¦è™•ç†\nå¯†ç¢¼æ´©æ¼çš„è©±æœ‰æ²’æœ‰ revoke æ©Ÿåˆ¶\nèƒ½ä¸èƒ½å®šæ™‚ Rotate æ±°æ›å¯†ç¢¼ï¼Ÿ\næ”¹æ¶æ§‹ï¼Œåº•ä¸‹çš„è¨­å®šå¥½ä¸å¥½è€•è‘—å‹•æ…‹èª¿æ•´ï¼Œé‚„æ˜¯è¦è·Ÿè‘— rename / mv k8s secret\næ€éº¼åšç¨½æ ¸ï¼Œæ€éº¼æª¢æŸ¥å…§å®¹ã€‚æˆ‘çœ‹ä¸åˆ° vault å¹«æˆ‘çœ‹ä¸€ä¸‹å…§å®¹å°ä¸å°ï¼Œé€™å€‹å¾ˆå®¹æ˜“ç™¼ç”Ÿã€‚\nè‡†æƒ³é ­å°±å¾ˆç—›\nä»Šå¤©çš„ç›®çš„å¾ˆå–®ç´”\nå¯†ç¢¼çš„éœ²å‡ºç›¡é‡å° æœ€å¥½å¯†ç¢¼æ˜¯æœ‰æœŸé™çš„ï¼Œé€¾æœŸè‡ªå‹•å¤±æ•ˆ æš´éœ²äº†å¯ä»¥ revoke Vault\næœ‰äººç”¨éï¼Ÿé€™é‚Šç°¡ä»‹ä¸€ä¸‹\nåœ¨ CNCF çš„ landscape æ¼±æ¸ Key Managementï¼Œæ‡‰è©²æ˜¯è£¡é¢å¸‚ä½”æœ€é«˜çš„é–‹æºé …ç›®\né‡é»å°±æ˜¯ä¿è­·èˆ‡ç®¡ç† secret\nVault çš„æ ¸å¿ƒæ¦‚å¿µï¼Œé€™å€‹å½±ç‰‡æ˜¯ Hashicorp å®˜æ–¹ä»‹ç´¹çš„å½±ç‰‡ï¼Œè¬›å¾—å¾ˆå¥½ï¼Œå¤§å®¶è‡ªå·±å›å»çœ‹ä¸€ä¸‹\né€™é‚Šç°¡å–® vault 101\nç¾åœ¨æœ‰ä¸€å° vault server å·²ç¶“è¨­å®šå¥½äº†ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ vault client é€£ç·š\nä¾‹å¦‚é€™é‚Š\nä½¿ç”¨ VAULT TOKEN å‘Šè¨´ vault ä½ æ˜¯ä»€éº¼èº«ä»½çš„ç”¨æˆ¶ æˆ–æ˜¯é€²è¡Œ loginï¼ŒVault æœƒå‘¸ç™¼ä¸€çµ„è‡¨æ™‚çš„ TOKEN çµ¦ä½  æ‹¿è‘—çµ„ TOKEN å»å• Vaultï¼Œè«‹å•æˆ‘å¯ä»¥è¦ /user/mysql é€™å€‹è·¯å¾‘ä¸‹çš„è³‡æ–™å—ï¼Ÿ\nVault æª¢æŸ¥ TOKEN çš„ role èˆ‡ permissionï¼Œå¯ä»¥å°±å›å‚³å€¼ ä¸è¡Œå°± permission denied\nVault å°±æ˜¯é‡‘åº«ï¼ŒçœŸæ­£é‡è¦çš„ key å­˜åœ¨è£¡é¢ï¼Œä½¿ç”¨é€™è¦ä¾†å• Vaultï¼Œè¦å…ˆé Vault é€™é—œ\nVault å¯¦éš›å­˜æ”¾ Secret Engineï¼Œé€™é‚Šä¹Ÿè·³éï¼Œå¤§å®¶å…ˆæŠŠä»–ç•¶ key / value å­˜æ”¾å¥½äº† XD\nç­‰ç­‰ï¼Œé€™æ¨£ vault Auth æœ‰é»æ€ª\næœ¬ä¾†æ‹¿ username / password å»æ§åˆ¶ Mysql å…ˆåœ¨å¤šä¸€æ­¥ï¼Œå…ˆæ‹¿åˆ° VAULT TOKENï¼Œå†æ‹¿ TOKEN å»è·Ÿ Vault æ‹¿ Mysql passwordï¼Œå†å»é€£ MySQL\nå’¦é€™æ¨£ä¸æ˜¯å¾ˆæ€ªï¼Ÿæˆ‘å¦‚æœ Vault token æš´éœ²äº†ï¼Œæœ‰å¿ƒäººå£«é‚„æ˜¯å¯ä»¥å¾ vault æ‹¿åˆ°è³‡æ–™å•Š\né€™æ¨£æœ‰æ¯”è¼ƒå®‰å…¨å—ï¼Ÿé‚„æ˜¯åªæ˜¯èŠ±å¼è¢«é§­\nå°ï¼Œåªæ˜¯åš token äº¤æ›çš„è©±ï¼Œé‚„æ˜¯ä¸å¤ ï¼Œæ‰€ä»¥ Vault æœ‰æä¾›è¨±å¤š Auth method\ntoken åªæ˜¯å…¶ä¸­ä¸€ç¨® æœ‰å¾ˆå¤šèªè­‰æ–¹æ³•ä¸ç”¨ token äº¤æ›ï¼Œä½†ä¹Ÿèƒ½è®“ vault èªå¾— k8s pod èˆ‡ api server é€™æ˜¯ä»Šå¤©çš„é‡é»ä¹‹ä¸€ï¼Œtoken / å¯†ç¢¼å‚³éä¸å®‰å…¨ï¼Œé‚£å°±ç”¨å…¶ä»–æ‰‹æ®µ auth\nä»¥ AWS IAM auth ç‚ºä¾‹\nå¦‚æœä»Šå¤©æ˜¯åœ¨ aws ec2 ä¸Šè·‘ï¼Œé‚£å¯ä»¥é€é aws internal api å»å–å¾—èº«ä»½èªè­‰è³‡æ–™ï¼Œä¹Ÿå°±æ˜¯ ec2 instance metadata\næ‹¿é€™å€‹ metadata å»å• vaultï¼Œvault å†é€é aws api å»ç¢ºèªï¼Œé€™å€‹ ec2 instance çœŸçš„æ˜¯åˆæ³•çš„\nç„¶å¾Œä¾æ“š ec2 instance èº«ä»½ï¼Œé…ç™¼æ¬Šé™è·Ÿè³‡æ–™\napi server ec2 å°±çµ¦ api server secret frontend server ec2 å°±çµ¦ frontend secret ä¸­é–“æ²’æœ‰å¤šé¤˜çš„å¯†ç¢¼ / token äº¤æ›\nä¾†å¾€çš„å°è©±å¤§æ¦‚æ˜¯é€™æ¨£\nAWS API æ˜¯å¯ä¿¡çš„ Vault è‡ªå·±ç¶­è­·æ˜¯å¯ä¿¡çš„ æœå‹™é€éä¸‰æ–¹äº¤æ¡å»èªè­‰ï¼Œèª runtime ç’°å¢ƒçš„ metadataï¼Œä¸å†æ˜¯èª key ä¸èªäºº è‡³æ–¼ api server ec2 è¿‘ä¾† vault å¾Œï¼Œæ‡‰è©²æœ‰ä»€éº¼æ¨£çš„æ¬Šé™ï¼Œåœ¨ vault å…§éƒ¨é€é policy é…ç½®\nè¨­å®š path è¨­å®šå…è¨±çš„ operation ä¾‹å¦‚ read write list delete \u0026hellip; ç­‰ runtime å‹•æ…‹èª¿æ•´\nç•¶ç„¶ Vault é‚„æœ‰æä¾›å¾ˆå¤šæ›´åŠ å®‰å…¨çš„åŠŸèƒ½\nä¾‹å¦‚å¦‚ä½•å®‰å…¨åœ°å­˜æ”¾ secret Storage é€™é‚Šè·³é\nSecret + auth æ­é…è·³é\nä»¥åŠ dynamic secretï¼Œä¾†è§£èª key ä¸èªäººçš„å•é¡Œ\nä¾‹å¦‚ mysql çš„éœæ…‹ username / passwordï¼Œé€é vault è¨­å®šå¯ä»¥è®Šæˆå‹•æ…‹çš„\nå›åˆ° k8sï¼Œä½¿ç”¨ token authï¼Œç„¶å¾ŒæŠŠ VAULT TOKEN æ”¾åœ¨ k8s secret è£é¢ï¼Œåªæœ‰æ¯”è¼ƒå®‰å…¨ä¸€é»é»\nå°±æ˜¯ VAULT TOKEN å¯ä»¥å¿«é€Ÿ rotate è·Ÿ revoke\né€™é‚Šå¯ä»¥æ­é…å…¶ä»– auth æ–¹å¼ä¾†è§£æ±º\nå‰›å‰›ä¸æ˜¯è®“ vault å»èª aws ec2ï¼Ÿ\nåœ¨ k8s ä¸­ï¼Œå¯ä»¥è®“ vault å»èª k8s cluster / service account\nè·¯å¾‘åœ–é•·é€™æ¨£\npod runtime éƒ½æœƒæœ‰ service account ä½¿ç”¨ service account çš„ metadata å»å• vault vault å»å• k8sï¼Œé€™å€‹ service account æ˜¯çœŸçš„å‡çš„ k8s å›ç­” vaultï¼ŒPod è·Ÿservice account æ˜¯åˆæ³•çš„ vault å†é…æ¬Šé™çµ¦ Pod auth detail çš„æ–‡å­—æè¿°ï¼Œè·Ÿä¸Šé¢è¬›çš„ä¸€æ¨£\né…åˆ k8s sidecarï¼Œå¯ä»¥æŠŠ vault æ‹¿åˆ°çš„ key å¯«åˆ° memory mount è£é¢\nPod init æ™‚ init container æ‰å» invoke vault API key ä¸æœƒé€é k8s api å‚³éï¼Œä¹Ÿä¸æœƒåœ¨ etcd å…§å‡ºç¾ main container é€é memory mount å­˜å– key key çš„ lifecycle è·Ÿ pod ä¸€æ¨£ï¼Œ pod delete æ‰é€™çµ„ in-memory key ä¹Ÿè‡ªå‹•æ¸…é™¤ å¥½è™•\næ›´å°‘ exposeï¼Œæ²’æœ‰é kube-api èˆ‡ etcd in-memory vault è·Ÿ pod ä¹‹é–“çš„ vault token çš„ time-to-live æœŸé™å¯ä»¥å¾ˆçŸ­ï¼Œå¹¾åç§’å…§ï¼Œinit å®Œå³å¯æ‹‹æ£„çš„ token å£è™•ï¼ˆï¼Ÿï¼‰\næ¯å€‹ pod èµ·ä¾†æœƒå»æ‰“ vault api å¯¦å‹™ç¶“é©—ä¸Š loading å¾ˆä½ è€Œä¸” vault server å¯ä»¥åš HA è·Ÿ horizontal scaling æœ€å¤§çš„æˆæœ¬ï¼Œå…¶å¯¦æ˜¯ vault è¨­å®š è®“ vault èª k8s æ ¹æ“š service account å»é…æ¬Šé™ å…¶ä»–èŠ±ä¿åŠŸèƒ½éƒ½éœ€è¦é¡å¤–çš„è¨­å®š ç³»çµ±è¤‡é›œï¼Œä¿è­‰é…åˆ°ä½ é ­æ˜çœ¼èŠ± æƒ³åƒä¸€ä¸‹ï¼Œé€™å¼µåœ–é‡Œçš„\npolicy è·Ÿç‚ºæœå‹™æ•¸é‡å‘ˆæ­£æ¯” secret path ä¹Ÿè€•æœå‹™æ•¸é‡å‘ˆæ­£æ¯” auth k8s æ•¸é‡ä¹Ÿè·Ÿæœå‹™æ•¸é‡å‘ˆæ­£ç›¸é—œ ç”¨è¶Šä¹…ï¼Œå…§å®¹éš¨æ™‚é–“å¢åŠ  æ”¹æ¶æ§‹æ™‚æ›´åˆºæ¿€ å»ºè­°ä½¿ç”¨ vault å‹™å¿… æ­é… Terraform ç®¡ç†\ninfrastructure as code configuration as code policy as code Terraform éå¸¸é©åˆç®¡ç†è¤‡é›œï¼Œä½†æœ‰å¸¸å¸¸éœ€è¦ç´°éƒ¨èª¿æ•´çš„è¨­å®šè³‡æ–™\nå…¶ä»–åŠŸèƒ½ï¼Œè·³é\nå…¶ä»–åŠŸèƒ½\nsecret debug è¶…éº»ç…©\nå…§å®¹æ­£ç¢ºæ€§ï¼Œvalid key é‚„æ˜¯ invalid keyï¼Œé‚„æ˜¯æ ¹æœ¬æ˜¯å¦ä¸€éš» key æ¬Šé™æ­£ç¢ºæ€§ï¼Œæ˜¯ä¸æ˜¯é€™å€‹ username / password çš„æ¬Šé™æ˜¯æ­£ç¢ºçš„ è·¨åœ˜éšŠæºé€šæ›´é ­ç—›ï¼Œä¸æ˜¯å¯ä»¥è²¼åœ¨ slack å¤§å®¶ä¸€èµ·å¹«çœ‹çš„æ±è¥¿ terraform å¯ä»¥å¹«åŠ© vault è¨­å®š debug\nè‡³å°‘è·¨ç’°å¢ƒå¾©ç¾å•é¡Œå¾ˆæ–¹é‚Š Vault æœ‰ HA\nVault Performance é€šå¸¸ä¸æ˜¯å•é¡Œ\né›–ç„¶ loading éš¨ micro service ç·šæ€§å¢åŠ  ä½†æœ¬èº«å¯ä»¥æ˜¯ç„¡ç‹€æ…‹ serverï¼Œå¯ä»¥ horizontal scale æ³¨æ„ä¸€ä¸‹ auto-retry\npod fail restart åˆå† init ä¸€æ¬¡ï¼Œå¦‚æœä¸€è¬å€‹ pod ä¸€ç›´ retry å¯èƒ½çœŸçš„æœƒæŠŠ vault æ‰“çˆ† backup limit è¦æ³¨æ„ ä½¿ç”¨ init container çš„è©±ï¼Œæ˜¯ cache åœ¨ Pod å±¤ç´šï¼Œcontainer fail restart ä¸æœƒé‡æ–°æ‰“ vault api å®‰å…¨æ€§\nvault æœ‰å°ˆæ¥­è³‡å®‰åœ˜éšŠæŠŠé—œ ä¸è¦æ€• vault è¢«æ‰“ç©¿ï¼Œè€Œæ˜¯è¦æ€•åŒäº‹è¢«é‡£é­š çµè«–\nè¦ä¸è¦ vault\nqrcode æœ€å¾Œæ©Ÿæœƒ\næœ‰å•é¡Œå¯ä»¥ä¾†ç¤¾ç¾¤æ‰¾æˆ‘\nMaicoin æ˜¯é–“å¥½å…¬å¸ 2014 æœå‹™ä¸Šç·šåˆ°ç¾åœ¨ï¼Œåœ¨å°ç£å·²ç¶“é‚å…¥ç¬¬å…«å¹´ã€‚é¡§å®¢æ•¸ä¸€ç›´å¢åŠ ï¼Œæˆ‘å€‘ä¹ŸæŒçºŒç·©æ…¢æ“´ç·¨ã€‚\nè¦ºå¾—è‡ªå·±æœ‰èƒ½åŠ›ï¼Œæ­¡è¿ä¾†æŒ‘æˆ°ï¼Œç­‰ç­‰ç§ä¸‹æ‰¾æˆ‘èŠ\nè¬è¬\nQ \u0026amp; A\nTerraform vs Pulumi\næ“ä½œèªè¨€å·®ç•°ï¼Œæœ‰å¥½æœ‰å£ vault è·Ÿ terraform çš„ hcl æ˜¯å¢å¼·ç‰ˆ jsonï¼Œæœ¬è³ªé‚„æ˜¯ jsonï¼Œæœ‰èˆˆè¶£å¯ä»¥å»çœ‹æˆ‘çš„æ–‡ç«  terraform ç›®å‰æ˜¯ç«™è·Ÿæ˜Ÿæ˜Ÿé‚„æ˜¯é ˜å…ˆï¼Œæœªä¾†ç¹¼çºŒçœ‹ Kubernetes Service account token è¦ä¸è¦æ›´æ–°\nè¦ï¼Œæ‡‰è©²å®šæœŸæ›´æ–°ï¼Œå®˜æ–¹æ–‡ä»¶æœ‰æ“ä½œæ­¥é©Ÿ Vault / Terraform å¯¦å‹™ä¸Šçš„å·¥ä½œè² æ“”æœƒå¾ˆèŠ±æ™‚é–“è·ŸäººåŠ›å—\nå­¸ç¿’æ›²ç·šæ¯”è¼ƒå¥‡æ€ªï¼Œè¦èŠ±ä¸€é»æ™‚é–“åšä¸­å­¸ å­¸ç†Ÿäº†ä¹‹å¾Œå°±å¾ˆå¥½æ”¹ï¼Œæ•ˆç‡å¾ˆé«˜ è‡³å°‘æ˜¯å±Œæ‰“ç”¨ gui æ”¹æˆ–æ˜¯ client ç›´æ¥ä¸‹ cmd æ‹‰ ","permalink":"https://chechia.net/posts/2021-11-16-ithome-cloud-summit-vault/","summary":"\u003cp\u003eå„ä½å¥½\u003c/p\u003e\n\u003cp\u003eé—œæ–¼é€™å€‹ QRcode\u003c/p\u003e\n\u003cp\u003eæ¯æ¬¡ä¸Šå°å‰ï¼Œæˆ‘éƒ½æœƒæƒ³è¦å¸¶ä»€éº¼æ¨£çš„å…§å®¹çµ¦è§€çœ¾ï¼Œè®“è§€çœ¾å€¼å¾—èŠ± 30 åˆ†é˜åœ¨åº•ä¸‹è½ã€‚å¾Œä¾†å°±ç¿’æ…£å…ˆç™¼è¡¨ä¸€ç¯‡æ–‡ç« ï¼ŒæŠŠå°è§€çœ¾æœ‰å¹«åŠ©çš„è³‡æºåŒ…æˆä¸€åŒ…ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé¦–å…ˆæ˜¯å®Œæ•´æŠ•å½±ç‰‡ï¼šhttps://slides.com/chechiac\u0026hellip;/terraform-introduction-a56697\u003c/li\u003e\n\u003cli\u003eé€å­—è¬›ç¨¿ï¼š(æœ€å¾Œæ ¡ç¨¿ä¸­ï¼‰\u003c/li\u003e\n\u003cli\u003eç„¶è€Œåªæœ‰æœ¬æ¬¡æ¼”è¬›å…§å®¹ï¼Œå›å»å¯èƒ½é‚„æ˜¯ä¸å¤ªå®¹æ˜“æ“ä½œã€‚æ‰€ä»¥é€™æ¬¡é™„ä¸Šä½¿ç”¨ Terraform ä¸€éµéƒ¨ç½² vault çš„ Github Repositoryï¼šhttps://github.com/\u0026hellip;/southe\u0026hellip;/chechia_net/vault/singleton\u003c/li\u003e\n\u003cli\u003eå¦‚æœä¸ç†Ÿ Terraformï¼Œå†é™„ä¸Š 30 å¤©æ‰‹æŠŠæ‰‹ Terraform æ•™å­¸æ–‡ç« ï¼Œåªè¦é¡˜æ„èŠ±æ™‚é–“ï¼Œå…¨ç¯‡ä¸­æ–‡ä¸€å€‹æœˆå¸¶ä½ ä¸Šæ‰‹ Terraformã€‚\n\u003cul\u003e\n\u003cli\u003eIThome éµäººè³½å¥½è®€ç‰ˆï¼šhttps://ithelp.ithome.com.tw/users/20120327/ironman/4057\u003c/li\u003e\n\u003cli\u003eGithub Repository å®Œæ•´ç‰ˆï¼šhttps://github.com/\u0026hellip;/terraform-30\u0026hellip;/tree/main/lecture/zh\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå¦‚æœé‡åˆ°å•é¡Œé‚„æ˜¯éœ€è¦æ‰¾äººç™¼å•ï¼Œæ‰€ä»¥å†æ¨è–¦å…©å€‹ç¤¾ç¾¤ï¼Œå¯ä»¥ä¾†é€™é‚Šç™¼å•ï¼Œè¦æ‰¾æˆ‘æœ¬äººä¹Ÿæ‰¾å¾—åˆ°ã€‚ç”šè‡³åªæ˜¯åŠ å…¥æ½›æ°´ä¸è¬›è©±ï¼Œéƒ½å¯ä»¥è¢«å‹•å¸æ”¶è¨±å¤šæ–°çŸ¥ã€‚\n\u003cul\u003e\n\u003cli\u003eCloud Native Taiwan User Group\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://t.me/cntug\"\u003ehttps://t.me/cntug\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://fb.cloudnative.tw\"\u003ehttps://fb.cloudnative.tw\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDevOps Taiwan Meetup Group\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://t.me/devopstw\"\u003ehttps://t.me/devopstw\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå¤§å®¶å¯ä»¥æ‰‹æ©Ÿæ‹å®Œé€™å€‹å°±å‡ºå»åƒåˆé¤äº†ã€‚\næˆ–æ˜¯æ‹å›å®¶ï¼Œç„¶å¾Œå‚³çµ¦ä¸€å€‹åŒäº‹å«ä»–èŠ± 30 å¤©æŠŠ Terraform è·Ÿ Vault é€™äº›éƒ½å­¸æœƒã€‚\u003c/p\u003e\n\u003cp\u003eç¸½ä¹‹å¸Œæœ›å°å„ä½æœ‰å¹«åŠ©ï¼Œè®“åœ‹å…§æŠ€è¡“åŠ›èƒ½æŒçºŒé€²æ­¥æˆé•·ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eå›åˆ°æœ¬æ¬¡æ¼”è¬›ã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬æ¬¡æ¼”è¬›æœ‰ä¸‰å€‹é—œéµå­—\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eKubernetes\u003c/li\u003e\n\u003cli\u003eVault\u003c/li\u003e\n\u003cli\u003eTerraform é€™å€‹æ˜¯éš±è—çš„\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè«‹å•å¹³æ™‚å·¥ä½œæœƒç”¨åˆ°é€™ä¸‰å€‹æŠ€è¡“ä¹‹ä¸€çš„æœ‹å‹ï¼Œè«‹èˆ‰å€‹æ‰‹ï¼Œå¥½è®“æˆ‘çŸ¥é“ä¸€ä¸‹è§€çœ¾çš„åˆ†å¸ƒï¼Œç­‰ç­‰åˆ†äº«çš„å…§å®¹æœƒç…§æ¯”ä¾‹åšä¸€äº›èª¿æ•´ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘å€‘ä»Šå¤©ä¸æœƒè¬›å¤ªå¤š Kubernetes çš„å…§å®¹ï¼Œé‡é»æ”¾åœ¨ Vaultï¼Œä»¥åŠå¦‚ä½•è¨­å®š Vaultï¼Œæ‰€ä»¥ Terraform Infrastructure as Code æˆ–æ˜¯ configuration as Code æœƒåœ¨é€™é‚Šè·‘å‡ºä¾†ã€‚\u003c/p\u003e","title":"2021 11 16 Ithome Cloud Summit Vault"},{"content":"2021 ithome éµäººè³½é–‹è·‘äº†ï½\nä»Šå¹´çš„é¡Œç›®æ˜¯ã€ŒTerraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©ã€ï¼Œæ˜¯ä¸€å€‹é•·é” 30 å¤©çš„ terraform workshopï¼Œå° terraform æœ‰èˆˆè¶£çš„æœ‹å‹æ­¡è¿è¿½ç¸±\nDay 01 - å¼•è¨€ï¼šTerraform æ˜¯å€‹å¥½æ±è¥¿ã€‚\nèª²ç¨‹å…§å®¹èˆ‡ä»£ç¢¼æœƒæ”¾åœ¨ Github ä¸Š: https://github.com/chechiachang/terraform-30-days\nè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\nè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\n","permalink":"https://chechia.net/posts/2021-09-01-ithome-ironman-go/","summary":"\u003cp\u003e2021 ithome éµäººè³½é–‹è·‘äº†ï½\u003c/p\u003e\n\u003cp\u003eä»Šå¹´çš„é¡Œç›®æ˜¯ã€ŒTerraform Workshop - Infrastructure as Code for Public Cloud ç–«æƒ…è­¦æˆ’é™ªä½ åº¦é 30 å¤©ã€ï¼Œæ˜¯ä¸€å€‹é•·é” 30 å¤©çš„ terraform workshopï¼Œå° terraform æœ‰èˆˆè¶£çš„æœ‹å‹æ­¡è¿è¿½ç¸±\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/articles/10258904\"\u003eDay 01 - å¼•è¨€ï¼šTerraform æ˜¯å€‹å¥½æ±è¥¿ã€‚\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/chechiachang/terraform-30-days\"\u003eèª²ç¨‹å…§å®¹èˆ‡ä»£ç¢¼æœƒæ”¾åœ¨ Github ä¸Š: https://github.com/chechiachang/terraform-30-days\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://chechia.net/\"\u003eè³½å¾Œæ–‡ç« æœƒæ•´ç†æ”¾åˆ°å€‹äººçš„éƒ¨è½æ ¼ä¸Š http://chechia.net/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eè¿½è¹¤ç²‰å°ˆå¯ä»¥æ”¶åˆ°æ–‡ç« çš„ä¸»å‹•æ¨æ’­\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\" loading=\"lazy\" src=\"https://ithelp.ithome.com.tw/upload/images/20210901/20120327NvpHVr2QC0.jpg\"\u003e\u003c/p\u003e","title":"2021 09 01 Ithome Ironman Go"},{"content":"Event https://devops.kktix.cc/events/meetup33-maicoin-devops-taiwan https://youtu.be/8hEifTAWnY0?t=3269 audience: 90/90 resources this presentation\nhttps://slides.com/chechiachang/terraform-introduction-a56697 github\nhttps://github.com/chechiachang/terraform-azure https://github.com/chechiachang/vault-playground/tree/master/deploy/v0.8.0 ","permalink":"https://chechia.net/posts/2021-05-13-devops-taiwan-33-hashicorp-vault-for-kubernetes-apps/","summary":"\u003ch1 id=\"event\"\u003eEvent\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://devops.kktix.cc/events/meetup33-maicoin-devops-taiwan\"\u003ehttps://devops.kktix.cc/events/meetup33-maicoin-devops-taiwan\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://youtu.be/8hEifTAWnY0?t=3269\"\u003ehttps://youtu.be/8hEifTAWnY0?t=3269\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eaudience: 90/90\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"resources\"\u003eresources\u003c/h1\u003e\n\u003cp\u003ethis presentation\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction-a56697\"\u003ehttps://slides.com/chechiachang/terraform-introduction-a56697\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003egithub\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-azure\"\u003ehttps://github.com/chechiachang/terraform-azure\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/vault-playground/tree/master/deploy/v0.8.0\"\u003ehttps://github.com/chechiachang/vault-playground/tree/master/deploy/v0.8.0\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"DevOps Taiwan Meetup #33: Hashicorp Vault for Kubernetes"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\néœ€æ±‚èˆ‡å•é¡Œ éš¨è‘— terraform åœ¨åœ˜éšŠå…§çš„è¦æ¨¡æŒçºŒæˆé•·ï¼Œåœ˜éšŠéœ€è¦è®“å·¥ä½œæµç¨‹æ›´åŠ é †æš¢ï¼Œä¾†é¢å°å¤§é‡çš„ tf è®Šæ›´æŸ¥æ ¸èˆ‡è®Šæ›´è«‹æ±‚ã€‚æƒ³åƒå¹¾åå€‹å·¥ç¨‹å¸«åŒæ™‚åœ¨ä¿®æ”¹å¹¾åå€‹ä¸åŒçš„ terraform projects / modulesï¼Œé€™æ™‚å¯èƒ½æœƒæœ‰å¹¾å€‹å•é¡Œ\néœ€è¦ä¸€å€‹ç©©å®šä¹¾æ·¨çš„ç’°å¢ƒåŸ·è¡Œ terraform å·¥ç¨‹å¸«çš„é–‹ç™¼æœ¬æ©Ÿä¸æ˜¯å€‹å¥½é¸æ“‡ éœ€è¦ 24/7 çš„ terraform åŸ·è¡Œä¸­å¿ƒ åŸ·è¡Œä¸­å¿ƒæœƒæœ‰å„å€‹ç’°å¢ƒ (dev / stage / prod) çš„å­˜å–æ¬Šé™ï¼Œå¸Œæœ›è¨­ç½®åœ¨å…§éƒ¨ ä¸‹åˆ—å…©å€‹å·¥ä½œæœƒåˆ‡æ›å·¥ä½œå¹³å°ï¼Œä¾‹å¦‚ Github reviewï¼Œæª¢è¦– differenceï¼Œèˆ‡è¨è«– PR review å®Œæœ‰æ™‚æœƒå¿˜è¨˜ mergeï¼Œmerge å®Œæœ‰æ™‚æœƒå¿˜è¨˜ apply repository è¶Šå¤šï¼Œå¿˜å¾—è¶Šå¤š\u0026hellip; åœ˜éšŠå·²ç¶“å°å…¥ Git-flowï¼Œå¸Œæœ›æŠŠå·¥ä½œæµç¨‹åšå¾—æ›´å®Œæ•´è‡ªå‹•åŒ–æ›´åŠ ä¾¿åˆ©\nAtlantis è§£æ±ºæ–¹æ¡ˆæ˜¯èˆ‡ç‰ˆæœ¬æ§åˆ¶æ•´åˆï¼Œæä¾› terraform åŸ·è¡Œçš„ workerï¼Œç—…å¯ä»¥èˆ‡ Git Host (e.g. Github) æ•´åˆåš PR + Reviewï¼Œä¾†é”æˆæŒçºŒçš„ CI/CD é ç«¯åŸ·è¡Œï¼Œè‡ªå‹• plan èˆ‡è‡ªå‹• apply mergeã€‚ä¹Ÿå°±æ˜¯ Atlantis å¹«æˆ‘å€‘è™•ç†ä»¥ä¸‹å¹¾ä»¶äº‹\nGit-flow TODO è‡ªå‹•åŒ– plan TODO Webhook å›å‚³ plan çµæœ TODO é€é bot æ§åˆ¶ apply TODO è‡ªå‹• merge éœ€æ±‚èˆ‡å·¥ä½œæµç¨‹ ä»¥ä¸‹çš„ç¯„ä¾‹ä½¿ç”¨\nGithub ä½œç‚ºç‰ˆæœ¬æ§ç®¡å·¥å…· æ˜¯æ•´å€‹å·¥ä½œæµç¨‹çš„æ§åˆ¶ä¸­å¿ƒ tf codeï¼Œreviewï¼Œplanï¼Œapply çš„çµæœéƒ½æœƒåœ¨ Github é€²ä¸€æ­¥æ•´åˆåˆ° Slack ä¸Šä¹Ÿéå¸¸æ–¹ä¾¿ Atlantis æ”¾åœ¨ Kubernetes ä¸Š ä½¿ç”¨ helm chart éƒ¨ç½² å¦‚æœéœ€è¦å…¶ä»–çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·æˆ–æ˜¯å®‰è£æ–¹å¼ï¼Œè«‹è¦‹Atlantis å®˜æ–¹æ–‡ä»¶ï¼ŒAtlantis æ”¯æ´éå¸¸å¤šç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œä¾‹å¦‚ Githubï¼ŒGitlabï¼ŒBitbucketï¼Œ\u0026hellip;ç­‰\næ•´å€‹å·¥ä½œæµç¨‹\nGithub commit push Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Github PR push Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Github Merge event / main branch push Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Atlantis acquire access to site (dev / stage) Atlantis apply to site Github release tag push (eg. 1.2.0-rc) Github event -\u0026gt; Atlantis webhook Atlantis run terraform validate plan Atlantis acquire access to site (dev/stage) Atlantis apply to site (release-candidate / prod) ä¾æ“šä¸Šé¢çš„ç’°å¢ƒï¼Œå®‰è£éœ€è¦æº–å‚™ä»¥ä¸‹å¹¾å€‹æ±è¥¿\nGit Git Host ä¸Šè¨­å®š Atlantis å­˜å– Git Repository çš„æ¬Šé™ ç‚º Git Host è¨­å®šå­˜å–ç§é‘°ï¼Œè®“ Atlantis èªè­‰ webhook Terraform Backend State storage: Atlantis éœ€è¦å­˜å–å¤–éƒ¨çš„ state storage Terraform ä½¿ç”¨çš„ç‰ˆæœ¬è¦æ³¨æ„ä¸€ä¸‹ã€‚Atlantis å¯ä»¥æ”¯æ´ä¸åŒ repository / project ä½¿ç”¨ä¸åŒç‰ˆæœ¬ Environment credential (provider credential) Atlantis æœƒéœ€è¦å­˜å–ä¸åŒçš„ç’°å¢ƒ (dev / stage / prod) ç‚ºé€™äº›ç’°å¢ƒç¨ç«‹é…ç½® credential è®“ Atlantis å­˜å– å¯¦éš› Atlantis çš„ç’°å¢ƒæœƒæœ‰\nDocker ä½œç‚ºå­¤åŸå¸«æœ¬æ©Ÿé–‹ç™¼æ¸¬è©¦ä½¿ç”¨ Kubernetes Atlantis æˆ‘å€‘çš„åœ˜éšŠæœƒæ˜¯ä¸€å€‹ç’°å¢ƒä¸€å€‹ç¨ç«‹çš„ Atlantis å®‰å…¨æ€§ï¼šåˆ‡åˆ†å„å€‹ç’°å¢ƒçš„æ¬Šé™èˆ‡ Access å„å€‹ Atlantis webhook åªæ¥æ”¶å±¬æ–¼è‡ªå·±çš„ event Docker ä½¿ç”¨ Docker ä½œç‚ºæœ¬åœ°é–‹ç™¼èˆ‡æ¸¬è©¦çš„å®¹å™¨ runtimeï¼š\ndocker pull runatlantis/atlantis:v0.15.0 docker run runatlantis/atlantis:v0.15.0 atlantis \\ --gh-user=GITHUB_USERNAME \\ --gh-token=GITHUB_TOKEN Helm Chart Helm çš„å®‰è£ååˆ†ç°¡æ˜“\nhelm repo add runatlantis https://runatlantis.github.io/helm-charts helm inspect values runatlantis/atlantis \u0026gt; values.yaml æ›´æ”¹ values.yaml\ngithub: user: chechiachang token: ... secret: ... orgWhitelist: github.com/chechiachang/* å®‰è£åˆ° Kubernetes ä¸Š\nhelm install atlantis runatlantis/atlantis -f values.yaml çµæœ å·¥ç¨‹å¸«é€é Github å°±å¯ä»¥å®Œæˆæ‰€æœ‰å·¥ä½œ åŠ ä¸Š Github Slack æ•´åˆï¼Œå°±å®Œå…¨ä¸ç”¨é›¢é–‹ Slackï¼Œè·Ÿ bot èŠå¤©å°±å¯ä»¥å®Œæˆæ‰€æœ‰ terraform å·¥ä½œ å®‰å…¨ç©©å®šçš„ terraform åŸ·è¡Œç’°å¢ƒ ç¨ç«‹çš„ in-cluster credentialï¼Œé›†ç¾¤çš„å­˜å–æ¬Šé™éƒ½æ§åˆ¶åœ¨é›†ç¾¤å…§ï¼Œä¸æœƒæš´éœ²åˆ°å¤–éƒ¨ç’°å¢ƒ è‡ªå‹• plan èˆ‡ applyï¼Œä¸æœƒéºå¿˜ å„ªåŠ£ å„ªé»\nå¯ä»¥ self-hostedï¼Œcredential ä¸å¤–æ´©ï¼Œç¢ºä¿æœ€é«˜çš„å®‰å…¨æ€§ å·²ç¶“æ•´åˆ Kubernetes, helm chart webhook æ•´åˆè¨±å¤šç‰ˆæœ¬æ§åˆ¶åº«ï¼Œä¾‹å¦‚ github, gitlab,\u0026hellip; å¯¦ç¾å®‰å…¨çš„é ç«¯åŸ·è¡Œ æœ¬åœ°åŸ·è¡Œé‚„æ˜¯æœƒæœ‰è«¸å¤šå•é¡Œ terraform cloud æä¾›çš„é ç«¯åŸ·è¡Œ ç¼ºé»ï¼Œå…¶å¯¦æ²’ä»€éº¼ç¼ºé»\nå°±éœ€è¦å¤šé¤Šä¸€çµ„ Atlantis ä½¿ç”¨ stateless deploymentï¼Œå…¶å¯¦æ˜¯æ‡‰è©²ä¸æœƒæœ‰ä»€éº¼è² æ“” Terraform ç³»åˆ—è‡³æ­¤æ‡‰è©²æ˜¯å…¨éƒ¨å®Œçµï¼Œæ„Ÿè¬å„ä½\n","permalink":"https://chechia.net/posts/2020-10-07-terraform-infrastructure-as-code-atlantis/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"éœ€æ±‚èˆ‡å•é¡Œ\"\u003eéœ€æ±‚èˆ‡å•é¡Œ\u003c/h1\u003e\n\u003cp\u003eéš¨è‘— terraform åœ¨åœ˜éšŠå…§çš„è¦æ¨¡æŒçºŒæˆé•·ï¼Œåœ˜éšŠéœ€è¦è®“å·¥ä½œæµç¨‹æ›´åŠ é †æš¢ï¼Œä¾†é¢å°å¤§é‡çš„ tf è®Šæ›´æŸ¥æ ¸èˆ‡è®Šæ›´è«‹æ±‚ã€‚æƒ³åƒå¹¾åå€‹å·¥ç¨‹å¸«åŒæ™‚åœ¨ä¿®æ”¹å¹¾åå€‹ä¸åŒçš„ terraform projects / modulesï¼Œé€™æ™‚å¯èƒ½æœƒæœ‰å¹¾å€‹å•é¡Œ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eéœ€è¦ä¸€å€‹ç©©å®šä¹¾æ·¨çš„ç’°å¢ƒåŸ·è¡Œ terraform\n\u003cul\u003e\n\u003cli\u003eå·¥ç¨‹å¸«çš„é–‹ç™¼æœ¬æ©Ÿä¸æ˜¯å€‹å¥½é¸æ“‡\u003c/li\u003e\n\u003cli\u003eéœ€è¦ 24/7 çš„ terraform åŸ·è¡Œä¸­å¿ƒ\n\u003cul\u003e\n\u003cli\u003eåŸ·è¡Œä¸­å¿ƒæœƒæœ‰å„å€‹ç’°å¢ƒ (dev / stage / prod) çš„å­˜å–æ¬Šé™ï¼Œå¸Œæœ›è¨­ç½®åœ¨å…§éƒ¨\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eä¸‹åˆ—å…©å€‹å·¥ä½œæœƒåˆ‡æ›å·¥ä½œå¹³å°ï¼Œä¾‹å¦‚ Github\n\u003cul\u003e\n\u003cli\u003ereviewï¼Œæª¢è¦– differenceï¼Œèˆ‡è¨è«–\u003c/li\u003e\n\u003cli\u003ePR\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ereview å®Œæœ‰æ™‚æœƒå¿˜è¨˜ mergeï¼Œmerge å®Œæœ‰æ™‚æœƒå¿˜è¨˜ apply\n\u003cul\u003e\n\u003cli\u003erepository è¶Šå¤šï¼Œå¿˜å¾—è¶Šå¤š\u0026hellip;\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eåœ˜éšŠå·²ç¶“å°å…¥ Git-flowï¼Œå¸Œæœ›æŠŠå·¥ä½œæµç¨‹åšå¾—æ›´å®Œæ•´è‡ªå‹•åŒ–æ›´åŠ ä¾¿åˆ©\u003c/p\u003e","title":"Terraform Infrastructure as Code: Atlantis"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\næ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html å·¥å…· Terraform Atlantis Terragrunt å•é¡Œèˆ‡éœ€æ±‚ ç•¶åœ˜éšŠå·²ç¶“é–‹å§‹å¤§è¦æ¨¡ä½¿ç”¨ terraformï¼Œtf æª”æ¡ˆè¶Šä¾†è¶Šå¤šã€‚æˆ‘å€‘ç‚ºäº†å¢åŠ ç¨‹å¼ç¢¼çš„é‡è¤‡åˆ©ç”¨æ€§ï¼Œæœƒä½¿ç”¨ terraform module å°‡å¸¸ç”¨çš„ tf æª”æ¡ˆå°è£ã€‚\néš¨è‘—å°å…¥çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œé€™äº› module æœƒè¶Šä¾†è¶Šå¤šï¼Œè€Œä¸”ä½¿ç”¨é€™äº› module çš„ project ä¹Ÿå¢åŠ  éš¨è‘—ç®¡ç†çš„ infrastructure è¶Šä¾†è¶Šè¤‡é›œï¼Œç‚ºäº†æè¿°é€™äº›æœ¬ä¾†å°±å¾ˆè¤‡é›œçš„ infrastructureï¼Œmodule ä¸åªè¶Šä¾†è¶Šå¤šï¼Œé‚„æœƒå‡ºç¾ module å¼•ç”¨å…¶ä»– moduleï¼Œå¤§ module ä½¿ç”¨å° module çš„ nested module é€™é»åœ¨è¤‡é›œçš„ provider ä¸­å¸¸å‡ºç¾ï¼Œä¾‹å¦‚ ä½¿ç”¨ terraform æè¿°ç¶²è·¯æ¶æ§‹ æè¿°è¤‡é›œçš„ IAM \u0026amp; Role terraform vault-provider ç®¡ç†çš„ç’°å¢ƒè¶Šä¾†è¶Šå¤šï¼Œä¾‹å¦‚ dev, staging, prod,\u0026hellip;ï¼Œæ¯å€‹ç’°å¢ƒéƒ½éœ€è¦ç¨ç«‹çš„å·¥ä½œç©ºé–“ï¼Œé€ æˆå¤§é‡é‡è¤‡çš„ tf code ä½¿ç”¨ä¸€æ®µæ™‚é–“ terraform ï¼Œå¾ˆå¿«å°±æœƒç™¼ç¾çš„ç¬¬ä¸€å€‹å•é¡Œæ˜¯ï¼šä¸è«–æ€éº¼å¾ tf æª”æ¡ˆä¸­æå–é‡è¤‡éƒ¨åˆ†ï¼Œåšæˆ moduleï¼Œé‚„æ˜¯æœ‰å¾ˆå¤šéƒ¨åˆ†çš„ tf code æ˜¯å®Œå…¨é‡è¤‡çš„ï¼Œä¾‹å¦‚ï¼š\næ¯å€‹ module æœƒå®šç¾©çš„ variable (argument)ï¼Œä½¿ç”¨é€™å€‹ module çš„ä¸Šå±¤æœƒéœ€è¦æä¾›å‚³å…¥ variable æ¯å€‹ module éƒ½æœƒéœ€è¦æä¾› provider Terraform çš„èªæ³•è¦æ±‚ä¸Šé¢é€™äº›åƒæ•¸éƒ½æ˜ç¢ºçš„å®šç¾©ï¼Œé€™è®“æ•´å€‹ module æˆ–è³‡æ–™å¤¾çš„æè¿°éå¸¸æ¸…æ¥šã€‚ä½†æœƒè™•å°±æ˜¯ï¼Œé€™äº›æè¿°çš„åƒæ•¸é“å‡ºéƒ½æ˜¯ï¼Œè€Œä¸”ä¸æ–·çš„é‡è¤‡ï¼Œæ¯å€‹ module æˆ–è³‡æ–™å¤¾éƒ½è¦æä¾›ï¼Œä¸ç„¶åœ¨ terraform validate æ™‚æœƒå› ç‚ºæ‡‰æä¾›åƒæ•¸æœªæä¾›ï¼Œå°è‡´éŒ¯èª¤ã€‚é›–ç„¶ç«‹æ„è‰¯å¥½ï¼Œä½†å»åš´é‡é•å DRY (Don\u0026rsquo;t Repeat Yourself) çš„åŸå‰‡\nmodule å¤šå±¤å¼•ç”¨ï¼Œproject å¼•ç”¨å¤§ moduleï¼Œå¤§ module åˆå¼•ç”¨å° module é–‹å§‹æ„Ÿè¦º backend èˆ‡ provider çš„ code æ¯”å…¶ä»–åŠŸèƒ½ code å¤šäº† æœ‰æ²’æœ‰å¯èƒ½ç”¨å…¶ä»–å·¥å…·ï¼Œé¿å…é€™äº›é‡è¤‡çš„åƒæ•¸ï¼Œbackendï¼Œprovider ç­‰ç­‰ï¼Ÿ\nTerragrunt æ¨è–¦æœ‰å¤§é‡ä½¿ç”¨çš„åœ˜éšŠï¼Œç›´æ¥ä½¿ç”¨ Terragrunt é€™æ¬¾å·¥å…·ã€‚\nä»–æ˜¯ä¸€å±¤ terraform çš„ wrapper\ni.e. åŸ·è¡Œ terraform plan -\u0026gt; terragrunt plan terragrunt æœƒå…ˆè§£æï¼Œç”¢ç”Ÿé‡è¤‡çš„ codeï¼Œç„¶å¾Œå†åŸ·è¡Œ terraform ç·¨è¼¯æ™‚åªè¦å¯«ä¸€æ¬¡ï¼Œterragrunt ä»£ç‚ºåœ¨å…¶ä»–åœ°æ–¹ç”¢ç”Ÿé‡è¤‡çš„ code ç”¢ç”Ÿçš„ code æœƒè¢«éš±è—èˆ‡ cache Terragrunt æœ‰è¨±å¤šåŠŸèƒ½ï¼Œä¾‹å¦‚\nè™•ç† Backendï¼Œproviderï¼Œèˆ‡å…¶ä»–ä¸æ–·é‡è¤‡çš„ tf code è™•ç†å¤šç’°å¢ƒä¸‹é‡è¤‡çš„ tf \u0026hellip;å®Œæ•´åŠŸèƒ½è«‹è¦‹å®˜æ–¹æ–‡ä»¶ å°å…¥ Terragrunt å¯ä»¥é¿å…é‡è¤‡ä»£ç¢¼ï¼Œé™ä½ç¶­è­·æˆæœ¬ï¼Œæå‡ç”Ÿç”¢æ•ˆç‡\nä½¿ç”¨æƒ…å¢ƒ ä¸Šè¿°èªªæ˜å¯èƒ½ä¸å¤ªæ¸…æ¥šï¼Œæˆ‘å€‘å¯¦éš›çœ‹ç¯„ä¾‹ï¼Œä»¥å‰å¹¾ç¯‡æˆ‘å€‘ä½¿ç”¨çš„ç¯„ä¾‹ repository ç‚ºä¾‹å­ï¼ŒæŠŠ gcp çš„è³‡æ–™å¤¾ç›®éŒ„æ‡‰è©²é•·é€™æ¨£ï¼š\nå¯ä»¥å¾ˆæ¸…æ¥šè¦‹åˆ°åº•ä¸‹å¹¾å€‹æ±è¥¿ä¸æ–·é‡è¤‡ ç”±æ–¼ my-new-project, gke-playground, national-team-5g ä¸‰å€‹å°ˆæ¡ˆæ˜¯ç¨ç«‹çš„å°ˆæ¡ˆï¼Œå„è‡ªå¯ä»¥ç¨ç«‹é‹è¡Œã€‚ä½†å…¶å¯¦åŒå±¬æ–¼åŒå…¬å¸çš„å°ˆæ¡ˆï¼Œå¯èƒ½è¨±å¤šå…§å®¹éƒ½æ˜¯é‡è¤‡çš„ã€‚\ntree gcp gcp â”œâ”€â”€ README.md â”œâ”€â”€ Makefile â”œâ”€â”€ my-new-project/ â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”œâ”€â”€ variable.tf â”‚Â â””â”€â”€ provider.tf â”œâ”€â”€ gke-playground/ â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”œâ”€â”€ variable.tf â”‚Â â””â”€â”€ provider.tf â”œâ”€â”€ national-team-5g/ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”‚Â â”œâ”€â”€ variable.tf â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â”œâ”€â”€ stag â”‚Â â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”‚Â â”œâ”€â”€ variable.tf â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â””â”€â”€ prod â”‚Â â”œâ”€â”€ terraform.tf â”‚Â â”œâ”€â”€ terraform.tfvars â”‚Â â”œâ”€â”€ variable.tf â”‚Â â””â”€â”€ provider.tf â”œâ”€â”€ templates/ â””â”€â”€ modules/ å¯ä»¥å¾ˆæ¸…æ¥šè¦‹åˆ°åº•ä¸‹å¹¾å€‹æ±è¥¿ä¸æ–·é‡è¤‡\nprovider.tf é€™è£¡æè¿°ä½¿ç”¨çš„ providerï¼Œé€™é‚Šåªæœ‰ä½¿ç”¨ gcp providerï¼Œæ‰€ä»¥æ˜¯å®Œå…¨ä¸€æ¨£é‡è¤‡ variable.tf æ˜¯å®šç¾©çš„åƒæ•¸ terraform.tfvars æ˜¯å‚³å…¥çš„åƒæ•¸ï¼Œä¹Ÿå°±æ˜¯å¯¦éš›å„å°ˆæ¡ˆå„è‡ªçš„åŸ·è¡Œåƒæ•¸ national-team-5g çš„å°ˆæ¡ˆä¸‹ï¼Œåˆå„è‡ªæ‹†åˆ†å¤šå€‹åŸ·è¡Œç’°å¢ƒï¼Œæ¯å€‹ç’°å¢ƒç¨ç«‹ï¼Œæ‰€ä»¥åˆæœ‰è¨±å¤šé‡è¤‡çš„ code é€™é‚Šçš„ç›®çš„ï¼Œæ˜¯æœ‰ç³»çµ±åŒ–çš„è™•ç†é€™äº›é‡è¤‡çš„ä»£ç¢¼\ngcp â”œâ”€â”€ terraform.tfvars # gcp å…±ç”¨çš„åƒæ•¸ â”œâ”€â”€ terragrunt.hcl # gcp å…±ç”¨çš„ç¨‹å¼ç¢¼ â”œâ”€â”€ national-team-5g/ â”‚Â â”œâ”€â”€ terraform.tfvars # national-team-5g å…±ç”¨çš„åƒæ•¸ â”‚Â â”œâ”€â”€ terragrunt.hcl # national-team-5g å…±ç”¨çš„ç¨‹å¼ç¢¼ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # dev çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ terragrunt.hcl # dev ç’°å¢ƒè‡ªå·±çš„ç¨‹å¼ç¢¼ â”‚Â â”œâ”€â”€ staging â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # staging çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ terragrunt.hcl # staging ç’°å¢ƒè‡ªå·±çš„ç¨‹å¼ç¢¼ â”‚Â â””â”€â”€ prod â”‚Â â”œâ”€â”€ terraform.tfvars # prod çš„åƒæ•¸ â”‚Â â””â”€â”€ terragrunt.hcl # prod ç’°å¢ƒè‡ªå·±çš„ç¨‹å¼ç¢¼ å·®ç•°éå¸¸å¤šæ˜¯å§ï¼Œä½†é€™é‚Šåªæ˜¯å¾è³‡æ–™ç›®éŒ„çµæ§‹çœ‹ï¼Œå…¶å¯¦å¦‚æœå¾ tf æª”æ¡ˆå…§éƒ¨çš„ç¨‹å¼ç¢¼çœ‹ï¼Œè£¡é¢çš„ä»£ç¢¼æ›´æ˜¯ç²¾ç°¡åˆ°ä¸è¡Œï¼Œç”¨èµ·ä¾†éå¸¸çš„çˆ½XD\nå®‰è£ å» release é é¢æ‰¾é©åˆçš„åŸ·è¡Œæª”æ¡ˆ ä¸‹è¼‰ chmod u+x terragrunt mv terragrunt /usr/local/bin/terragrunt è©³ç´°æ–‡ä»¶è«‹è¦‹\nç¯„ä¾‹ Terragrunt çš„ DRY featureï¼Œå…¶å¯¦å…§å®¹éƒ½å¤§åŒå°ç•°\nâ”œâ”€â”€ national-team-5g/ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # staging çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â”œâ”€â”€ stag â”‚Â â”‚Â â”œâ”€â”€ terraform.tfvars # staging çš„åƒæ•¸ â”‚Â â”‚Â â””â”€â”€ provider.tf â”‚Â â””â”€â”€ prod â”‚Â â”œâ”€â”€ terraform.tfvars # prod çš„åƒæ•¸ â”‚Â â””â”€â”€ provider.tf\nä¾‹å¦‚\nnational-team-5g/dev/provider.tf\nprovider \u0026quot;google\u0026quot; { version = \u0026quot;~\u0026gt;v3.25.0\u0026quot; credentials = file(var.credential_json) project = var.project region = var.region } æ”¹æˆ\nnational-team-5g/dev/terragrunt.hcl\ngenerate \u0026quot;provider\u0026quot; { path = \u0026quot;provider.tf\u0026quot; if_exists = \u0026quot;overwrite\u0026quot; contents = \u0026lt;\u0026lt;EOF provider \u0026quot;google\u0026quot; { version = \u0026quot;~\u0026gt;v3.25.0\u0026quot; credentials = file(var.credential_json) project = var.project region = var.region } EOF } åŸ·è¡Œ\ncd national-team-5g/dev terragrunt plan é—œæ–¼åƒæ•¸\nvar.region æ˜¯æœ¬åœ°åƒæ•¸ï¼Œå¯ä»¥ä¾æ“š dev/staging/prod åƒæ•¸å„è‡ªè¨­å®š var.project é€™å€‹æ˜¯æ•´å€‹ national-team-5g éƒ½å…±ç”¨çš„åƒæ•¸ï¼Œå¯ä»¥é€²ä¸€æ­¥æé«˜åˆ°æ›´ä¸Šå±¤ i.g. æ”¾åœ¨ national-team-5g/terraform.tfvars æª”æ¡ˆè£¡é¢ï¼Œé€é terragrunt.hcl å‚³éã€‚ Functions tf æª”æ¡ˆï¼Œåœ¨è¨±å¤š block ä¸­ç¦æ­¢ä½¿ç”¨ variableï¼Œé€™å±¤é™åˆ¶æœ‰å…¶è€ƒé‡ï¼Œä½†æ˜¯ç¼ºé»æ˜¯é€ æˆè¨±å¤š hard coded çš„ç¨‹å¼ç¢¼ã€‚\nTerragrunt ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ï¼Œç”±æ–¼æ˜¯åœ¨ terragrunt åŸ·è¡Œå¾Œï¼Œterraform åŸ·è¡Œå‰ï¼Œå› æ¬¡æ²’æœ‰é€™å±¤é™åˆ¶ï¼Œå¯ä»¥åšè¨±å¤šäº‹æƒ…ï¼Œä¾‹å¦‚ code generate ä»¥åŠ function é‹ç®—ï¼Œterragrunt æä¾›è¨±å¤šå…§å»º functionï¼Œé€™é‚Šåªä»‹ç´¹å¸¸ç”¨å¹¾å€‹ã€‚\nfind_in_parent_folder() path_relative_to_include() ç¯„ä¾‹å…©å€‹æª”æ¡ˆ\nproject/dev/terraform.hcl\ninclude { path = find_in_parent_folders() } project/terraform.hcl\nenv = path_relative_to_include() æœ€å¾Œ parse å¾Œçš„çµæœ\nproject/dev/terraform.hcl\nenv = \u0026quot;dev\u0026quot; åšäº†å…©ä»¶äº‹\nè¦æ±‚ project/dev å»ä¸Šå±¤å°‹æ‰¾ terraform.hclï¼Œä¸¦ä¸”å¼•å…¥å…¶ä¸­çš„è¨­å®š (env=\u0026quot;\u0026quot;) å­å°ˆæ¡ˆå¯ä»¥ include æ¯è³‡æ–™å¤¾çš„ç¨‹å¼ç¢¼ åŒ¯å…¥ä¸Šå±¤ project æ™‚ï¼Œå¯«å…¥ç›¸å°çš„è·¯å¾‘ (dev)ï¼Œä¸¦ä¸”å¸¶å…¥ (env=\u0026ldquo;dev\u0026rdquo;) æ¯å°ˆæ¡ˆå¯ä»¥ç‚ºå„å€‹å­ç›®éŒ„é…ç½®ç›¸å°è·¯å¾‘ å…¶ä»–å…§å»º function è«‹è¦‹å®˜æ–¹æ–‡ä»¶\nå°çµ Terragrunt å¯ä»¥ç²¾ç°¡ç¨‹å¼ç¢¼ï¼Œå¤§ç¦æå‡ç”Ÿç”¢æ•ˆç‡ï¼Œç„¶è€Œåœ¨é‚„ä¸ç†Ÿæ‚‰ terraform æ ¸å¿ƒåŠŸèƒ½ä¹‹å‰ï¼Œä¸å»ºè­°éæ—©å°å…¥ï¼Œæœƒå°è‡´å¤šé¤˜çš„å­¸ç¿’æˆæœ¬ã€‚\n","permalink":"https://chechia.net/posts/2020-10-06-terraform-infrastructure-as-code-terragrunt/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\u003c/p\u003e\n\u003cp\u003eæ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¿ƒå¾—\n\u003cul\u003e\n\u003cli\u003eCI/CD å…¨è‡ªå‹•åŒ–\u003c/li\u003e\n\u003cli\u003eState backend é¸æ“‡\u003c/li\u003e\n\u003cli\u003eæœ€ä½³å¯¦è¸ \u003ca href=\"https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\"\u003ehttps://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå·¥å…·\n\u003cul\u003e\n\u003cli\u003eTerraform Atlantis\u003c/li\u003e\n\u003cli\u003eTerragrunt\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"å•é¡Œèˆ‡éœ€æ±‚\"\u003eå•é¡Œèˆ‡éœ€æ±‚\u003c/h1\u003e\n\u003cp\u003eç•¶åœ˜éšŠå·²ç¶“é–‹å§‹å¤§è¦æ¨¡ä½¿ç”¨ terraformï¼Œtf æª”æ¡ˆè¶Šä¾†è¶Šå¤šã€‚æˆ‘å€‘ç‚ºäº†å¢åŠ ç¨‹å¼ç¢¼çš„é‡è¤‡åˆ©ç”¨æ€§ï¼Œæœƒä½¿ç”¨ terraform module å°‡å¸¸ç”¨çš„ tf æª”æ¡ˆå°è£ã€‚\u003c/p\u003e","title":"Terraform Infrastructure as Code: Terragrunt"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ å·¥å…· Terraform Atlantis Terragrunt å·¥å…·èˆ‡æ–‡åŒ– æ–°å·¥å…·æä¾›è§£æ±ºæ–¹æ¡ˆï¼Œç„¶è€Œå–®ç´”å°å…¥å·¥å…·å¾Œä¸æ˜¯å°±ä¸€å‹æ°¸é€¸ï¼Œè¨±å¤šå¯¦å‹™ä¸Šçš„å•é¡Œï¼Œé‚„æ˜¯è¦ä¾è³´æ”¹å–„å·¥ä½œæµç¨‹ï¼Œä¸¦ä¸”é¿å…æ•´é«”é‹ä½œçš„éŒ¯èª¤ã€‚\nå…¶æ¬¡ï¼Œä¸åŒåœ˜éšŠå·²æœ‰æ—¢æœ‰çš„åœ˜éšŠæ–‡åŒ–ï¼Œæ•´åˆæ–°çš„å·¥å…·å¾Œé‚„æ˜¯éœ€è¦ç£¨åˆï¼Œä¸ä¸€å®šè¦ç…§å–®å…¨æ”¶ã€‚æ›å¥è©±èªªï¼Œå·¥ä½œæµç¨‹çš„ä¸æ–·æ”¹é€²ä¹Ÿæ˜¯è§£æ±ºæ–¹æ¡ˆçš„ä¸€ç’°ã€‚\nå»ºè­°å¯¦è¸ Recommended Practices Terraform å®˜ç¶²æœ‰è¨±å¤šå»ºè­°çš„å¯¦ä½œèˆ‡å°å…¥æµç¨‹ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†çš„å»ºè­°æˆ‘å€‘éƒ½å·²ç¶“åœ¨å‰é¢çš„å¹¾ç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œé€™é‚Šè¦ä¾†èªªæ˜ä¸€ä¸‹ï¼Œä¸¦è£œå……å…¶ä»–å®˜æ–¹æ¨è–¦çš„å¯¦è¸ã€‚\næŠ€è¡“è¤‡é›œåº¦: éš¨è‘—æ¶æ§‹çš„è¤‡é›œå¢åŠ ï¼Œç¶­è­·æ•´é«”æ¶æ§‹çš„å›°é›£é€æ¼¸å¢åŠ  çµ„ç¹”è¤‡é›œåº¦: éš¨è‘—åœ˜éšŠè¦æ¨¡å¢é•·ï¼Œåˆ†å·¥èˆ‡æ¬Šè²¬è¶Šé¡¯è¤‡é›œï¼Œåœ˜éšŠçš„å”ä½œå›°é›£é€æ¼¸å¢åŠ  Terraform çš„ç›®çš„ï¼Œåœ¨æ–¼æ¸›å°‘ä¸Šé¢å…©è€…çš„è¤‡é›œåº¦ã€‚\nå·¥ä½œç›®éŒ„çµæ§‹ å·¥ä½œç›®éŒ„ (workspace) æ˜¯ terraform é‹ä½œçš„åŸºæº–é»ï¼Œå®¹ç´ tf æª”æ¡ˆï¼Œé€šå¸¸æœƒä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç®¡ç†ã€‚\nä¸€å€‹ç’°å¢ƒä¸€å€‹å·¥ä½œç›®éŒ„ é€™å€‹æˆ‘å€‘åœ¨å‰é¢çš„ç¯„ä¾‹å·²ç¶“å¯¦è¸ï¼ŒåŸºæœ¬ä¸Šç›®éŒ„ç‚º\nproject (git repository) â”œâ”€â”€ api-server/ â”‚Â â”œâ”€â”€ dev â”‚Â â”‚Â â””â”€â”€ terraform.tf â”‚Â â”œâ”€â”€ stage â”‚Â â”‚Â â””â”€â”€ terraform.tf â”‚Â â””â”€â”€ prod â”‚Â â””â”€â”€ terraform.tf â”œâ”€â”€ grpc-server/ â”‚ å°‡ç”¢å“æˆ–å°ˆæ¡ˆåˆ‡å‰²æˆå„è‡ªç¨ç«‹çš„ç’°å¢ƒï¼Œä»¥æŸå°ˆæ¡ˆçš„æŸç’°å¢ƒä½œç‚ºç®¡ç†å–®ä½\nproject-api-server-dev project-api-server-stage project-api-server-prod project-grpc-server-dev \u0026hellip; é€™éº¼åšæœ‰å¹¾å€‹å¥½è™•ï¼š\nç¢ºä¿ç”¢å“èˆ‡ç’°å¢ƒçš„ç¨ç«‹ å½¼æ­¤ä¸äº’ç›¸å½±éŸ¿ ä½†åˆå¯ç¢ºä¿å½¼æ­¤çš„é—œé€£æ€§ï¼Œä¾‹å¦‚æ¶æ§‹ç›¸åŒ ä»¥ç’°å¢ƒçš„ç‚ºç®¡ç†å–®ä½ï¼Œæ›å¥è©±èªªï¼Œä¸€çµ„å®Œæ•´çš„ç’°å¢ƒ ç›´æ¥å°æ‡‰åˆ° ä¸€çµ„å®Œæ•´çš„å·¥ä½œç›®éŒ„ ç®¡ç†ä¸Šéå¸¸ç›´è§€æ˜ç¢º ä½¿ç”¨å·¥ä½œç›®éŒ„åˆ†é…æ¬Šé™èˆ‡æ¬Šè²¬ ç›´æ¥ç‚ºä¸åŒåœ˜éšŠåˆ†é…ä¸åŒå·¥ä½œç›®éŒ„çš„å­˜å–æ¬Šé™ æ¬Šè²¬èˆ‡å·¥ä½œç›®éŒ„çš„æ˜ç¢ºå°æ‡‰ æŒçºŒè©•ä¼°èˆ‡æ”¹é€² è‡ªå‹•åŒ–ç¨‹åº¦ä¹Ÿæ˜¯å·¥ä½œæµç¨‹é€²æ­¥çš„æŒ‡æ¨™ï¼š\næ‰‹å‹•æ§åˆ¶ åŠè‡ªå‹•åŒ– å…¨è‡ªå‹•åŒ– å°å…¥ terraform å¾Œçš„æˆ‘å€‘å·²ç¶“æè¿°éäº†ï¼Œå…§å®¹è©³æƒ…è«‹è¦‹ä¸Šä¸Šç¯‡æ–‡ç« ã€‚ä¸‹é¢æè¿°å®˜æ–¹æ¨è–¦çš„å¾æœ€é–‹å§‹ï¼Œå®Œå…¨æ²’æœ‰ terraform ç¶“é©—é–‹å§‹å°å…¥æµç¨‹ï¼Œä»¥ç­†è€…å€‹äººæ–¼å…¬å¸å¾é›¶é–‹å§‹å°å…¥çš„ç¶“é©—ï¼Œéå¸¸ç›´å¾—åƒè€ƒã€‚\nå¦‚ä½•å¾å®Œå…¨æ‰‹å‹•æ“ä½œï¼Œè®ŠæˆåŠè‡ªå‹•æ“ä½œ å¦‚ä½•å¾åŠè‡ªå‹•ï¼Œè®Šæˆ IaC (infrastructure as code) å¦‚ä½•å¾ IaCï¼Œè®Šæˆ IaC å¤šäººå”ä½œ é€²éšæ”¹é€² IaC å¤šäººå”ä½œ å¦‚ä½•å¾å®Œå…¨æ‰‹å‹•æ“ä½œï¼Œè®ŠæˆåŠè‡ªå‹•æ“ä½œ å¦‚æœåœ˜éšŠæ‡‰è©²æ˜¯é‚„åœ¨å®Œå…¨æ‰‹å‹•æ§åˆ¶ infrastructure\næŸ¥é©— (audit) å›°é›£ ç„¡æ³•è¤‡ç¾ (reproduce) æ‹“å±• (scale) å›°é›£ å¾ˆé›£åˆ†äº« infrastructure çš„çŸ¥è­˜ ç¬¬ä¸€æ­¥è¦åŸ·è¡Œçš„æ˜¯ï¼šé¸æ“‡å°‘éƒ¨åˆ†ï¼Œå¯ä»¥æ§åˆ¶çš„ infrastructure é–‹å§‹å°å…¥ terraformã€‚æ‰€ä»¥è¦åšçš„å°±æ˜¯\né–‹å§‹ä½¿ç”¨ terraform å¦‚æœéœ€è¦å¯ä»¥åƒè€ƒä¸€äº›ç¯„ä¾‹å°ˆæ¡ˆ Terraform: Get Started collection é–‹å§‹é€²å…¥åŠè‡ªå‹•éšæ®µå¾Œï¼Œåœ˜éšŠä¸­çš„å°‘éƒ¨åˆ†äººå“¡é–‹å§‹ä½¿ç”¨ terraformï¼Œæ‰‹ä¸Šä¹Ÿæœ‰äº†å¯é‹ä½œçš„å°‘éƒ¨åˆ† infrastructure as codeï¼Œå¯ä»¥ä½œç‚º demo ï¼Œæˆ–æ˜¯å…¶ä»–åœ˜éšŠæˆå“¡çš„æ•™è‚²è¨“ç·´ï¼Œé€™å€‹å¯ä»¥å¹«åŠ©ä¸‹ä¸€éšæ®µçš„æ¼”é€²ã€‚\nå¦‚ä½•å¾åŠè‡ªå‹•ï¼Œè®Šæˆ IaC (infrastructure as code) ç›®å‰åŠè‡ªå‹•çš„å·¥ä½œå°ˆæ¡ˆå…§å®¹æ‡‰è©²æ˜¯ï¼š\nTerraform code æ‰‹å‹•æ“ä½œçš„æµç¨‹ ä¸€äº›è¼”åŠ©è…³æœ¬ ä¸‹å€‹éšæ®µå¸Œæœ›ç¹¼çºŒæ¨å±• terraform çš„ä½¿ç”¨ï¼Œé™ä½æ‰‹å‹•æ­¥é©Ÿèˆ‡è…³æœ¬åŸ·è¡Œã€‚é€™å€‹éšæ®µå¯ä»¥åšçš„äº‹æƒ…\nä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç† tf code é€™é‚Šå‡è¨­åœ˜éšŠæœ¬ä¾†å°±æœ‰ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼Œé–‹å§‹å°‡ tf code å°å…¥ç‰ˆæœ¬æ§åˆ¶çš„å·¥ä½œæµç¨‹ é–‹å§‹å°‡å…ˆç”¢ç”Ÿçš„ tf code ç§»å…¥ç‰ˆæœ¬æ§åˆ¶ æ‰€æœ‰åœ˜éšŠéƒ½èƒ½å…±äº«æ–° tf code çš„çŸ¥è­˜ é–‹å§‹ä½¿ç”¨ç¬¬ä¸€å€‹ terraform module ä¸€å€‹ç°¡å–®çš„æ–¹å¼æ˜¯å°‡é‡è¤‡ä½¿ç”¨çš„ infrastructure æŠ½å‡ºï¼Œæ¸›å°‘é‡è¤‡çš„ tf code é€™é‚Šéœ€è¦æé†’ï¼Œç›¡é‡ä»¥å®Œæ•´å€‹ infrastructure ä½œç‚ºå–®ä½æŠ½é›¢ tf code ä½œç‚º module å®Œæ•´çš„ infrastructure ä¹Ÿæ˜¯åœ¨ provider ä¸­é–“è½‰æˆçš„å–®ä½ æŒçºŒæ¨å»£åœ˜éšŠå…§ terraform çš„ä½¿ç”¨ é–‹å§‹è¨­å®šå·¥ä½œæº–å‰‡ (Guidelines) ä¾†æè¿°ä¸¦è¦ç¯„å·¥ä½œæµç¨‹ åœ¨åœ˜éšŠä¸Šä¸å®Œå…¨ç†Ÿæ‚‰ terraform å‰ï¼Œå¯ä»¥æå‡å·¥ä½œæ•ˆç‡ï¼Œæ¨å»£æœ€ä½³å¯¦è¸ï¼Œä¸¦ä¸”é™ä½éŒ¯èª¤é¢¨éšª åœ˜éšŠçš„æ¶æ§‹å¸«å¯ä»¥ä¾æ“šåœ˜éšŠæ–‡åŒ–å½¢å¡‘å·¥ä½œæµç¨‹ï¼Œæ›´ç¬¦åˆåœ˜éšŠéœ€æ±‚ é–‹å§‹å°å…¥ configuration management ä¾‹å¦‚ Chef cookbook ç§é‘°èˆ‡éš±ç§˜è³‡è¨Šç®¡ç† å°å…¥ vault ä¾†ç®¡ç† terraform æ•´åˆ vaultï¼Œå¯ä»¥ä½¿ç”¨ terraform ç®¡ç† vault çš„çµæ§‹ï¼Œä½¿ç”¨ vault ä¾†ç®¡ç† terraform æ‰€éœ€çš„ credentials å¦‚ä½•å¾ IaCï¼Œè®Šæˆ IaC å¤šäººå”ä½œ å°å…¥ç‰ˆæœ¬æ§åˆ¶å¯ä»¥é™ä½å †äººå”ä½œçš„è¤‡é›œåº¦ï¼Œä¸‹å€‹éšæ®µéœ€è¦\nçµ±ä¸€è·¨åœ˜éšŠçš„å·¥ä½œæµç¨‹ ä½¿ç”¨ terraform ç®¡ç†åœ˜éšŠçš„ IAM æ¬Šé™ å¯ä»¥åŸ·è¡Œçš„æ”¹é€²å¦‚ä¸‹ï¼š\nå®˜æ–¹æ¨è–¦ä½¿ç”¨ Terraform Cloud ä¾†åšå¾Œå°ï¼Œæˆ‘å€‘ç¨å€™æ¨è–¦çš„å¹¾å€‹å…è²»å·¥å…·ä¹Ÿæœ‰ç›¸ä¼¼åŠŸèƒ½ï¼Œåœ˜éšŠå¯ä»¥åƒè€ƒä½¿ç”¨ã€‚é€™é‚Šå°ˆæ³¨åœ¨éœ€æ±‚èˆ‡æ–¹æ³•ã€‚ é–‹å§‹è¨­è¨ˆæ•´å€‹çµ„ç¹”é–“çš„å·¥ä½œç›®éŒ„çµæ§‹ å·¥ä½œç›®éŒ„è¦åæ˜  ç¨ç«‹çš„ç’°å¢ƒèˆ‡ç¨ç«‹çš„å°ˆæ¡ˆ è² è²¬ç®¡ç†çš„åœ˜éšŠçµ„ç¹”ï¼Œå·²åˆ†é…å­˜å–æ¬Šé™ é€™éƒ¨åˆ†çš„å¯¦ä½œå¾Œé¢çš„æ–‡ç« ä¹Ÿæœƒæåˆ° å®˜æ–¹æ¨è–¦çš„ Terraform Cloud å¯è¦‹å®˜æ–¹æ–‡ä»¶ é€²éšæ”¹é€² IaC å¤šäººå”ä½œ å¦‚ä»Šåœ˜éšŠå·²ç¶“æœ‰å¤šäººå”ä½œçš„ä»‹é¢ï¼Œä¹Ÿæœ‰å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼Œæˆ‘å€‘å¯ä»¥è—‰ç”±ä»¥ä¸‹æ”¹é€²ï¼Œé”æˆæ›´å …å›ºçš„æ¡†æ¶\nå®˜æ–¹å»ºè­°å¤§é‡å°å…¥ Terraform Cloudï¼Œä½†é€™æœƒè¶…å‡ºå…è²»é¡åº¦ æˆ‘å€‘ä¹‹å¾Œçš„æ–‡ç« æœƒæä¾›é–‹æºç‰ˆæœ¬çš„è§£æ³• ç°¡åŒ–å·¥ä½œç›®éŒ„çš„ç®¡ç† æ˜ç¢ºçš„ review èˆ‡ audit å·¥ä½œæµç¨‹ å¢åŠ  infrastructure çš„ç›£æ¸¬èˆ‡æ•ˆèƒ½ç›£æ§ï¼Œé€™äº›éƒ½å¯ä»¥ä½¿ç”¨ terraform è¨­ç½® å…·é«”å¯¦ä½œï¼Œè«‹è¦‹ä¸‹ç¯‡æ–‡ç« \n","permalink":"https://chechia.net/posts/2020-10-05-terraform-infrastructure-as-code-recommended-practices/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¿ƒå¾—\n\u003cul\u003e\n\u003cli\u003eCI/CD å…¨è‡ªå‹•åŒ–\u003c/li\u003e\n\u003cli\u003eState backend é¸æ“‡\u003c/li\u003e\n\u003cli\u003eæœ€ä½³å¯¦è¸\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå·¥å…·\n\u003cul\u003e\n\u003cli\u003eTerraform Atlantis\u003c/li\u003e\n\u003cli\u003eTerragrunt\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"å·¥å…·èˆ‡æ–‡åŒ–\"\u003eå·¥å…·èˆ‡æ–‡åŒ–\u003c/h1\u003e\n\u003cp\u003eæ–°å·¥å…·æä¾›è§£æ±ºæ–¹æ¡ˆï¼Œç„¶è€Œå–®ç´”å°å…¥å·¥å…·å¾Œä¸æ˜¯å°±ä¸€å‹æ°¸é€¸ï¼Œè¨±å¤šå¯¦å‹™ä¸Šçš„å•é¡Œï¼Œé‚„æ˜¯è¦ä¾è³´æ”¹å–„å·¥ä½œæµç¨‹ï¼Œä¸¦ä¸”é¿å…æ•´é«”é‹ä½œçš„éŒ¯èª¤ã€‚\u003c/p\u003e\n\u003cp\u003eå…¶æ¬¡ï¼Œä¸åŒåœ˜éšŠå·²æœ‰æ—¢æœ‰çš„åœ˜éšŠæ–‡åŒ–ï¼Œæ•´åˆæ–°çš„å·¥å…·å¾Œé‚„æ˜¯éœ€è¦ç£¨åˆï¼Œä¸ä¸€å®šè¦ç…§å–®å…¨æ”¶ã€‚æ›å¥è©±èªªï¼Œå·¥ä½œæµç¨‹çš„ä¸æ–·æ”¹é€²ä¹Ÿæ˜¯è§£æ±ºæ–¹æ¡ˆçš„ä¸€ç’°ã€‚\u003c/p\u003e\n\u003ch1 id=\"å»ºè­°å¯¦è¸-recommended-practices\"\u003eå»ºè­°å¯¦è¸ Recommended Practices\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\"\u003eTerraform å®˜ç¶²æœ‰è¨±å¤šå»ºè­°çš„å¯¦ä½œèˆ‡å°å…¥æµç¨‹\u003c/a\u003eï¼Œå…¶ä¸­å¤§éƒ¨åˆ†çš„å»ºè­°æˆ‘å€‘éƒ½å·²ç¶“åœ¨å‰é¢çš„å¹¾ç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œé€™é‚Šè¦ä¾†èªªæ˜ä¸€ä¸‹ï¼Œä¸¦è£œå……å…¶ä»–å®˜æ–¹æ¨è–¦çš„å¯¦è¸ã€‚\u003c/p\u003e","title":"Terraform Infrastructure as Code: Recommended Practices"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\næ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html å·¥å…· Terraform Atlantis Terragrunt Terraform Backend å‰›é–‹å§‹ä½¿ç”¨ terraform çš„æ™‚å€™ï¼Œå¤§å®¶çš„ç¬¬ä¸€å€‹ç¯„ä¾‹æ‡‰è©²éƒ½æ˜¯ local backend å§ï¼Œå°±æ˜¯ç›´æ¥åœ¨æœ¬åœ° terraform applyï¼Œåœ¨ç›®å‰çš„å·¥ä½œç›®éŒ„ä¸‹ç”¢ç”Ÿ state æª”æ¡ˆã€‚é€™å€‹ state æª”æ¡ˆç›´æ¥ cat æ‰“é–‹ä¾†çœ‹å¾Œï¼Œå¯ä»¥ç™¼ç¾è£¡é¢ä¸€åˆ‡éƒ½æ˜¯æ˜ç¢¼çš„ã€‚åˆå­¸æ™‚ç­†è€…æ„Ÿè¦ºæ‰€è¬‚çš„ Terraform backend åªæ˜¯ä¸€å€‹å­˜æ”¾ä¸­ç¹¼çš„ state è³‡æ–™çš„ workspaceï¼Œå¾Œä¾†ç™¼ç¾å®Œå…¨ä¸æ˜¯é€™éº¼å›äº‹ï¼Œä¾¿ç«‹åˆ»æ£„ç”¨äº† local backendã€‚\nä¹‹å¾Œä¾ç…§å®˜æ–¹æ¨è–¦å°±ä½¿ç”¨äº† Terraform Cloudï¼Œå¾Œä¾†ä¾¿å‡ºç¾è¨±å¤šå•é¡Œï¼Œç­‰ç­‰æœƒåˆ†æã€‚\næœ€å¾Œåœ˜éšŠé¸ç”¨äº†è‡ªå®¶å…¬æœ‰é›²çš„ backendï¼Œä¾‹å¦‚\nAWS S3 ä½œç‚º state storageï¼ŒDynamoDB ä½œç‚ºä¸­å¿ƒåŒ–çš„ workflow lock GCP å®Œæ•´ terraform backend æ”¯æ´æ¸…å–®å¯ä»¥è¦‹å®˜æ–¹ç¶²ç«™ã€‚\né€™ç¯‡æ–‡ç« è¦ä¾†ä»”ç´°æ¢è¨æ‰€è¬‚çš„ terraform backendï¼Œbackend çš„é‡è¦æ€§ï¼Œèˆ‡å¦‚é¸æ“‡é©åˆè‡ªå·±åœ˜éšŠçš„ backendã€‚\nå•é¡Œ å¦‚æœä½¿ç”¨ tf random ç”¢ç”Ÿäº‚æ•¸å¯†ç¢¼ï¼Œç›´æ¥å» cat state æª”æ¡ˆå°±å¯ä»¥çœ‹åˆ°æ˜ç¢¼çš„ random æ•¸å€¼ã€‚\nå¤šäººå”ä½œ lock\nå¦å¤–ä¸€å€‹è§£æ³•æ˜¯ï¼Œæ ¹æœ¬ä¸ä½¿ç”¨ backendï¼Œterraform ä¹Ÿæ”¯æ´é€™æ¨£çš„åšæ³•ã€‚é›–ç„¶å®˜æ–¹ä¹Ÿæ˜è¬› backend are completely optionalï¼Œä½†ä¾ç…§ç­†è€…çš„ç¶“é©—ï¼Œå¼·çƒˆå»ºè­°å¤šäººåœ˜éšŠå‹™å¿…å»å•Ÿç”¨ï¼Œä¸¦æ‰¾å°‹é©åˆè‡ªå·±çš„ Backendã€‚\néœ€æ±‚ è³‡è¨Šå®‰å…¨ï¼Œå¸Œæœ› terraform ä½¿ç”¨æ˜¯å®‰å…¨çš„ï¼Œä¸æœƒæš´éœ²æ•æ„Ÿè³‡è¨Š å¤šäººå”ä½œï¼Œå¸Œæœ›å¯ä»¥åŒæ™‚å·¥ä½œï¼Œä½†åˆä¸æœƒäº’ç›¸è¡çª é ç«¯æ“ä½œï¼Œé¿å…æœ¬åœ°æ“ä½œ State å­˜æ”¾èˆ‡é– é è¨­çš„ backend æ˜¯ loal backendï¼Œä¹Ÿå°±æ˜¯åŸ·è¡Œ terraform apply å¾Œï¼Œæœ¬åœ°æœƒå‡ºç¾ä¸€å€‹ JSON æ ¼å¼çš„ state æª”æ¡ˆã€‚ç„¶è€Œ local state æœƒç«‹åˆ»é‡åˆ°çš„å•é¡Œï¼Œå°±æ˜¯\nç¬¬ä¸€å€‹æ˜¯å”ä½œå›°é›£ï¼Œapply çš„çµæœåˆ¥äººçœ‹ä¸åˆ°ï¼Œä¸èƒ½æ¥çºŒè‘—åš æ¯å€‹äººéƒ½å¯ä»¥ apply ä½†ä¸åŒäººçš„ apply æ²’æœ‰ç›¸ä¾æ€§ å¯æ˜¯é ç«¯çš„ infrastructure æœ‰ï¼ŒA B ä¸åŒäººä¸€èµ· apply åˆ° infrastructure ä¸Šï¼Œå¯å¯§å°±æœƒè¡çªï¼Œæˆ–æ˜¯ç”¢ç”Ÿä¸å¯é æœŸçš„éŒ¯èª¤ æ‰€ä»¥ç­†è€…å¼·çƒˆæ¨è–¦ä½¿ç”¨å¤–éƒ¨çš„ backend ä¾†å–ä»£ local backendã€‚å¤šåŠ backend æœƒå¤šåšè¨±å¤šäº‹ï¼Œé€éæ§åˆ¶ state ä¾†ç¢ºä¿ infrastrure çš„å®Œæ•´æ€§ï¼Œä¾‹å¦‚å° state å­˜å–æœ‰ä»¥ä¸‹çš„é™åˆ¶:\nï¼¡é€éé–ä¾†æ§åˆ¶ï¼Œç¦æ­¢å¤šäººåŒæ™‚å­˜å–ï¼Œä¾‹å¦‚åŒæ™‚æœ‰å…©å€‹äºº apply ç›¸åŒæˆ–ä¸åŒæª”æ¡ˆï¼Œå…ˆå–å¾— backend lock çš„äººåŸ·è¡Œï¼Œå¾Œä¾†çš„äººæœƒè¢« terraform é˜»æ“‹ é¿å…å¤šé ­é¦¬è»Šçš„å•é¡Œ ç¢ºä¿ state çš„å”¯ä¸€æ€§ï¼Œä½¿ç”¨å¦å¤–ä¸€å€‹ repo çš„ state æª”æ¡ˆï¼Œé ç«¯çš„ state æœƒæ‹’çµ•å­˜å– ç¢ºä¿ state çš„é †åºï¼Œæ¯æ¬¡ apply çš„ state éƒ½æ˜¯ä¾åºç”¢ç”Ÿ å¦‚æœ state æ˜¯èˆŠçš„ï¼Œå¯èƒ½å°±æœƒè¢«é ç«¯çš„ backend æ‹’çµ•ï¼Œé¿å…ä½¿ç”¨èˆŠçš„ apply è¦†è“‹æ–°çš„ infrastructure é€™äº›é™åˆ¶ï¼Œå¦‚æœä½¿ç”¨ local backend æ‰æœƒå®¹æ˜“é‡åˆ°ï¼Œä½¿ç”¨å¤–éƒ¨çš„ backend å…¶å¯¦ä¸å®¹æ˜“æœƒç™¼ç”Ÿã€‚Terraform åŸºæ–¼ Infrastructure as Code å¯¦ç¾ï¼Œå¯ä»¥å°‡æ•´å€‹ terraform repo è¦–ç‚º code ä¸€éƒ¨åˆ†ï¼Œé€™æ¨£å°±å¯ä»¥æƒ³åƒç‚ºä½•é€™äº› state é™åˆ¶æ˜¯é‡è¦çš„ã€‚\nstate è·Ÿéš¨ tf æª”æ¡ˆï¼Œéš¨è‘— tf æª”æ¡ˆçš„ commit æ¨é€²ï¼Œstate ä¹Ÿè·Ÿè‘—æ¨é€² commit 1 çš„ tf æª”æ¡ˆï¼Œapply å¾Œç”¢ç”Ÿ state 1 å¦‚æœä»Šå¤©æœ‰åœ˜éšŠ force push äº†ä¸€å€‹ conflict çš„ tf æª”æ¡ˆï¼Œç¡¬è¦ apply çš„çµæœä¹Ÿå¯èƒ½é€ æˆ infrastructure conflicts å¦‚æœä»Šå¤©åœ˜éšŠæœ‰å¤šå€‹ branch åŒæ™‚é–‹ç™¼ï¼Œbranch A apply çš„ state æœƒèˆ‡ branch B apply çš„ state ä¹Ÿå¯èƒ½é€ æˆè¡çª State æ‰‹å‹•æ›´æ”¹ åœ¨å¾ˆç‰¹æ®Šçš„ç‹€æ³ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹å‹•æ›´æ”¹ state fileï¼Œç„¶å¾Œ push ä¸Šå‚³ï¼Œä½†é€™é»éå¸¸ä¸å»ºè­°ï¼Œterraform æœƒè‡ªå‹•ç¶­è­· state çš„å®Œæ•´æ€§ï¼Œæ‰‹å‹•æ›´æ”¹å¯èƒ½æœƒç›´æ¥ç ´å£æ­£å¸¸çš„ stateã€‚ä»€éº¼æƒ…å½¢æœƒç”¨åˆ°ï¼Ÿå°±æ˜¯ä½ çš„ state å› ç‚ºæŸå€‹åŸå› è¢«ç©å£ï¼Œå¤§éƒ¨åˆ†æ˜¯äººç‚ºå¼„å£çš„ã€‚é€™æ™‚å€™æ‰è¢«è¿«è¦æ‰‹å‹•æ›´æ”¹ stateã€‚æ‰‹å‹•æ›´æ”¹ state ï¼Œè¬›ç™½äº†ä¸åšæ­»å°±ä¸æœƒæ­»ã€‚\nvault state pull vim your-local-state-file # Increment Serial if needed vault state push # vault state push -force Hosted: Terraform Cloud Terraform Cloudï¼Œæ˜¯å®˜æ–¹æä¾›çš„è§£æ±ºæ–¹æ¡ˆï¼Œæœ‰æä¾›è¼ƒå¤šåŠŸèƒ½ï¼Œä¾‹å¦‚åœ¨ terraform cloud çš„ç¶²ç«™ä¸Šé ç«¯ planã€‚æœ‰æä¾›å…è²»ç‰ˆï¼Œæä¾›æœ€å¤š 5 äººåœ˜éšŠä½¿ç”¨ã€‚ä¹Ÿæœ‰æä¾›é€²éšçš„æ–¹æ¡ˆ $20/user æˆ–æ˜¯ $70/userï¼Œä»¥åŠ enterprise ç‰ˆæœ¬ï¼Œå¯ä»¥æœ¬åœ°å®‰è£ã€‚\nä½¿ç”¨å¾ˆç°¡å–®ï¼Œæˆ‘åœ¨å‰å¹¾ç¯‡æä¾›çš„ç¯„ä¾‹ repositoryå…¨éƒ¨éƒ½æ˜¯ä½¿ç”¨ terraform cloud ä½œç‚º Backendã€‚æä¾›\né ç«¯çš„ state å„²å­˜åº« æ‰€æœ‰åœ˜éšŠæˆå“¡ä½¿ç”¨å„è‡ªå¸³è™Ÿç™»å…¥ plan ä¹‹å‰æœƒ sync terraform cloud ä¸Šé¢çš„ state é ç«¯çš„ state lock å¦‚æœ lock è¢«äººä½”æ“šï¼Œè¡¨ç¤ºæœ‰å…¶ä»–äººæ­£åœ¨ä½¿ç”¨ï¼Œæœƒå–æ¶ˆæ–°çš„æ“ä½œï¼Œé¿å…è¡çª ä¹Ÿæä¾›ç·šä¸Šæª¢è¦– state ï¼Œæˆ–æ˜¯ç·šä¸Šä¿®æ”¹ state çš„åŠŸèƒ½ è²¼å¿ƒå°åŠŸèƒ½ï¼Œä½†å¤šåŠç”¨ä¸åˆ° è¨—ç®¡çš„ Terraform Cloud ä½œç‚º backend ä»–æœ‰å¹¾å€‹å•é¡Œ\nå¦‚æœè¦å•Ÿç”¨é ç«¯ planï¼Œéœ€è¦ç¶å®šç‰ˆæœ¬æ§åˆ¶æœå‹™å™¨ï¼Œä¾‹å¦‚ç¶å®š Github æˆ– Gitlab åŸºæ–¼å®‰å…¨æ€§è€ƒé‡ï¼Œé€™é»å¾ˆå¤šå…¬å¸å°±ç›´æ¥æ‰“æ§äº† æš´éœ²åŸå§‹ç¢¼çµ¦ç¬¬ä¸‰æ–¹å…¬å¸ï¼Œå¯èƒ½æœƒè®“å…¬å¸çš„å®‰å…¨æ€§æª¢é©—ä¸é åŠ ä¸Š terraform çš„ Git Codeï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æ‰€æœ‰ infrastructure çš„è³‡è¨Š åŠ ä¸Šå¦‚æœæœ‰ä½¿ç”¨ terraform ç·¨è¼¯ IAM æˆ–æ˜¯ provision vaultï¼Œç­‰æ–¼è¨±å¤šæ•æ„Ÿè³‡æ–™éƒ½æœƒå‡ºç¾åœ¨ terraform repository ä¸­ å¦‚æœæ˜¯é‡è¦–å®‰å…¨æ€§çš„åœ˜éšŠï¼Œå‰‡è‡³å°‘è¦ä½¿ç”¨å¯ä»¥ self-hosted çš„ Terraform Enterpriseï¼Œè€Œä¸è¦ä½¿ç”¨å…¬æœ‰çš„ Terraform Cloudã€‚ç„¶è€Œ Enterprise æˆ‘æ˜¯æ²’ç”¨éï¼Œè«‹ä¸è¦å•æˆ‘åƒ¹éŒ¢ã€‚\nConsul Consul åš´æ ¼ä¾†èªªä¸æ˜¯å–®ç´”çš„å„²å­˜åº«ï¼Œä»–æ˜¯ Service Networking è¨­å®šèˆ‡æœå‹™ç™¼ç¾çš„è§£æ±ºæ–¹æ¡ˆï¼Œåªæ˜¯æœ¬èº«å¸¶æœ‰ key value çš„å„²å­˜åŠŸèƒ½ï¼Œå°±è¢«è‡ªå®¶æ•´åˆã€‚æ›å¥è©±èªªï¼Œä»–ä¸æ˜¯å°ˆé–€æ‹¿ä¾†åš terraform backend çš„ï¼Œæ¯”è¼ƒåƒæ˜¯å¦‚æœåœ˜éšŠæœ¬ä¾†å°±æœ‰ä½¿ç”¨ consulï¼Œå¯ä»¥è€ƒæ…®å…¬ç”¨å„²å­˜åº«ï¼Œä½œç‚º terraform backendã€‚\né€™æ˜¯ç›¸åŒå…¬å¸ Hashicorp æä¾›çš„è‡ªå®¶çš„ backendï¼Œæ•´åˆçš„å¾ˆå®Œæ•´ã€‚ä½†å°±åªæ˜¯å–®ç´”çš„å„²å­˜åº«ï¼Œæ²’æœ‰ terraform cloud çš„é ç«¯åŸ·è¡Œå•Šï¼Œæˆ–æ˜¯ç·šä¸Šæª¢è¦– state æª”æ¡ˆçš„åŠŸèƒ½ã€‚\nå¯ä»¥åœ¨å…¬å¸å…§éƒ¨è‡ªè¡Œæ¶è¨­ä¸€çµ„ clusterï¼Œç„¶å¾Œå°±å¯ä»¥ä½œç‚º backendã€‚\nå•é¡Œæ˜¯\nConsul é€™éº¼å¤§ä¸€åŒ…ï¼Œçµæœåªä½¿ç”¨äº†è£¡é¢çš„ kv store Consul æ˜¯åˆ†æ•£å¼çš„ Key-value storeï¼Œä¸ç†Ÿæ‚‰çš„è©±ä¸å¤ªå¥½é¤Š æ›å¥è©±èªªï¼Œå¦‚æœæ­»äº†æ•‘å¾—èµ·ä¾†å— Etcd Etcd è·Ÿ consul é¡ä¼¼ï¼Œé›–ç„¶æ˜¯å°ˆæ¥­çš„å„²å­˜åº«ï¼Œä½†æ˜¯ä½¿ç”¨é€™éº¼è¤‡é›œçš„åˆ†æ•£å¼å„²å­˜åº«ï¼Œåªä½œç‚º terraform çš„ backendï¼Œé¡¯ç„¶å¾ˆä¸ç¶“æ¿Ÿã€‚\nå¯ä»¥åœ¨å…¬å¸å…§éƒ¨è‡ªè¡Œæ¶è¨­ä¸€çµ„ clusterï¼Œç„¶å¾Œå°±å¯ä»¥ä½œç‚º backendã€‚\nä¸€æ¨£åªå»ºè­°å·²ç¶“æœ‰åœ¨ä½¿ç”¨ etcd ï¼Œä¸”ç†Ÿæ‚‰ç¶­é‹ etcd çš„åœ˜éšŠï¼Œæ‰è€ƒæ…®ä½¿ç”¨ etcd å…¼ä½œç‚º terraform backendã€‚\né€™äº›åˆ†æ•£å¼çš„å„²å­˜åº«ï¼Œä¸å¤ªå®¹æ˜“æ­»ï¼Œç„¶è€Œè¬ä¸€æ­»äº†å¯èƒ½ä¸å¤ªå¥½æ•‘ã€‚\nPublic Cloud AWS S3 + DynamoDB GCP gcs + pg Azurerm + pg\nåªæœ‰å–®ç´”çš„ state storage èˆ‡ lock çš„åŠŸèƒ½ï¼Œæ²’æœ‰ä»€éº¼èŠ±ä¿çš„ç·šä¸ŠåŸ·è¡Œæˆ–æ˜¯å¿«é€Ÿ reviewã€‚\nå¥½è™•æ˜¯\nä½¿ç”¨éå¸¸å–®ç´” ä¹Ÿæ˜¯è™•åœ¨å®‰å…¨çš„å…§ç¶²ç’°å¢ƒä¸­ æœ‰æ–¼æ˜¯å…¬æœ‰é›²æä¾›çš„æœå‹™ï¼ŒåŸºæœ¬çš„ IAM èˆ‡æ¬Šé™æ§ç®¡å¯ä»¥ç›´æ¥æ‡‰ç”¨ Postgresql Postgrel ä¹Ÿæ˜¯ä¸€å€‹ä¸éŒ¯çš„é¸æ“‡\nTerraform ä¸¦ä¸æœƒå¸¶ä¾†å¤§é‡çš„è³‡æ–™åº«è² æ“”ï¼Œæ‰€ä»¥å¯èƒ½æœƒæŠŠ terraform èˆ‡é™„è¼‰è¼ƒä½çš„æ‡‰ç”¨ï¼Œå…±ç”¨è³‡æ–™åº«ã€‚\nä½¿ç”¨ä¸Šä½œç‚º state storage èˆ‡ lock å¾ˆå–®ç´”æ²’ä»€éº¼å•é¡Œ\nå…¶ä»– å®˜æ–¹é‚„æœ‰æä¾›æ‰€æœ‰æ”¯æ´çš„ backend\nå¦‚æœ Kubernetes é‚„æœ‰åšå…¶ä»–äº‹æƒ…çš„è©±ï¼Œè«‹ä¸è¦ç”¨ Kubernetes secret ä½œç‚º terraform çš„ backend\n","permalink":"https://chechia.net/posts/2020-10-04-terraform-infrastructure-as-code-backend/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\u003c/p\u003e\n\u003cp\u003eæ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¿ƒå¾—\n\u003cul\u003e\n\u003cli\u003eCI/CD å…¨è‡ªå‹•åŒ–\u003c/li\u003e\n\u003cli\u003eState backend é¸æ“‡\u003c/li\u003e\n\u003cli\u003eæœ€ä½³å¯¦è¸ \u003ca href=\"https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\"\u003ehttps://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå·¥å…·\n\u003cul\u003e\n\u003cli\u003eTerraform Atlantis\u003c/li\u003e\n\u003cli\u003eTerragrunt\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"terraform-backend\"\u003eTerraform Backend\u003c/h1\u003e\n\u003cp\u003eå‰›é–‹å§‹ä½¿ç”¨ terraform çš„æ™‚å€™ï¼Œå¤§å®¶çš„ç¬¬ä¸€å€‹ç¯„ä¾‹æ‡‰è©²éƒ½æ˜¯ local backend å§ï¼Œå°±æ˜¯ç›´æ¥åœ¨æœ¬åœ° terraform applyï¼Œåœ¨ç›®å‰çš„å·¥ä½œç›®éŒ„ä¸‹ç”¢ç”Ÿ state æª”æ¡ˆã€‚é€™å€‹ state æª”æ¡ˆç›´æ¥ cat æ‰“é–‹ä¾†çœ‹å¾Œï¼Œå¯ä»¥ç™¼ç¾è£¡é¢ä¸€åˆ‡éƒ½æ˜¯æ˜ç¢¼çš„ã€‚åˆå­¸æ™‚ç­†è€…æ„Ÿè¦ºæ‰€è¬‚çš„ Terraform backend åªæ˜¯ä¸€å€‹å­˜æ”¾ä¸­ç¹¼çš„ state è³‡æ–™çš„ workspaceï¼Œå¾Œä¾†ç™¼ç¾å®Œå…¨ä¸æ˜¯é€™éº¼å›äº‹ï¼Œä¾¿ç«‹åˆ»æ£„ç”¨äº† local backendã€‚\u003c/p\u003e","title":"Terraform Infrastructure as Code: Backends"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\nè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\næ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\nä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\nå¿ƒå¾— CI/CD å…¨è‡ªå‹•åŒ– State backend é¸æ“‡ æœ€ä½³å¯¦è¸ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html å·¥å…· Terraform Atlantis Terragrunt CI/CD å…¨è‡ªå‹•åŒ– ç•¶å…¬å¸æˆåŠŸå°å…¥ terraform ï¼Œä¸¦ä¸”æ•´åˆ Git-flow çš„å·¥ä½œæµç¨‹å¾Œï¼Œæ‡‰è©²å¯ä»¥å¾ˆæ˜é¡¯çš„æ„Ÿå—åˆ°ï¼Œæ•´é«”çš„ infrastructure ç”¢å‡ºç©©å®šåº¦æœ‰å¤§å¹…æå‡ï¼Œç•¢ç«Ÿè»Ÿé«”å·¥ç¨‹ä¸­ code review æ˜¯ç©©å®šåº¦çš„æ ¸å¿ƒé—œéµä¹‹ä¸€ï¼Œè€Œå°å…¥ terraform èˆ‡ infrastructure as code è®“ infrastructure ä¹Ÿèƒ½åœ¨åˆç†çš„å·¥ä½œæµç¨‹ä¸­è¢«å±¤å±¤ reviewã€‚\nstable master -\u0026gt; feature/add-new-infra -\u0026gt; PR feature/add-new-infra -\u0026gt; master\nfeature branch merge é€²å» master ä¹‹å¾Œï¼Œå°±ç¢ºå®šæ˜¯ review éè€Œä¸”ç©©å®šçš„ç¨‹å¼ç¢¼ï¼Œå†ç”±å·¥ç¨‹å¸« pull æœ€æ–°çš„ master ï¼Œç„¶å¾Œåœ¨æœ¬åœ°åŸ·è¡Œ terraform applyï¼ŒæŠŠ infrastructure ç”Ÿå‡ºä¾†ã€‚\né€™æ¨£åšæœ¬è³ªä¸æœƒæœ‰ä»€éº¼å¤§å•é¡Œï¼Œç•¢ç«Ÿ code å·²ç¶“æ˜¯ç©©å®šã€‚ç„¶è€Œï¼Œå¯¦å‹™ä¸Šå»é‚„æ˜¯æœƒå‡ºç¾å¶ç™¼çš„å•é¡Œã€‚ä¾‹å¦‚ï¼šä½¿ç”¨éŒ¯èª¤çš„ credentail æˆ– contextï¼Œå°è‡´ dev æˆ– staging çš„ infrastructure apply åˆ° prod ä¸Šï¼Œç›´æ¥ p0 issue å¤§çˆ†ç™¼ï¼ŒSRE éƒ½è·ªè‘—ä¸Šç­ã€‚åˆä¾‹å¦‚ï¼šä½¿ç”¨éŒ¯èª¤çš„ master ç‰ˆæœ¬ applyï¼Œçµæœä¹Ÿæ˜¯æœå‹™æ‰ç·šï¼Œæ•´å€‹ team è·ªè‘—ä¸Šç­ã€‚\né—œéµï¼šåœ˜éšŠæ•´é«”çš„å®‰å…¨æ€§ï¼Œæ˜¯ç”±ç¨‹åº¦æœ€èœçš„åŒäº‹æ±ºå®šã€‚\nå°æˆ‘å°±æ˜¯åœ¨èªªä½ XDã€‚ç„¶è€Œäººéƒ½æœƒèœï¼Œè€Œäººäº‹æˆæœ¬ä¹Ÿæ˜¯å…¬å¸ç¶“ç‡Ÿçš„é—œéµè€ƒé‡ï¼Œç›¸ä¿¡æ‰€æœ‰åŒäº‹éƒ½å¤§ç¥æ˜¯ä¸åˆ‡å¯¦éš›çš„ï¼Œä¸å¦‚æ”¹é€²å·¥ä½œæµç¨‹ï¼Œè¿‘ä¸€æ­¥é™ä½äººç‚ºæ“ä½œå¤±èª¤çš„å¯èƒ½ã€‚äººçš„å•é¡Œï¼Œæ ¹æœ¬ä¹‹é“é‚„æ˜¯æ•™è‚²ï¼Œç„¶è€Œæˆ‘å€‘å¯ä»¥è©¦è‘—ç”¨æŠ€è¡“èˆ‡å·¥å…·é™ä½é¢¨éšªã€‚\nä»¥ä¸‹çš„åšæ³•ï¼Œå¯èƒ½æœƒå”åŠ©é¿å…é€™å€‹å•é¡Œã€‚æˆ‘å€‘è¦åšçš„å°±æ˜¯ CI/CD çš„å…¨è‡ªå‹•åŒ–ã€‚\néœ€æ±‚ é¿å… apply å¤±èª¤ é¿å…æ„šè ¢çš„éŒ¯èª¤ ç’°å¢ƒåˆ‡æ›éŒ¯èª¤ apply éŒ¯ç‰ˆæœ¬ (æ„šè ¢çš„éŒ¯èª¤æ¯”ä½ æƒ³çš„è¦å¤šï¼Œå‡ºç¾å¾Œæœƒè®“ä½ ä¸‰è§€å¤§é–‹) åŠ é€Ÿå·¥ä½œæµç¨‹ PR çµæŸå¾Œï¼Œåœ¨åˆé©çš„æ™‚é–“è‡ªå‹• apply è‡ªå‹•å›å ±çµæœ å‡ºéŒ¯è‡ªå‹• rollback ä¸Šå€‹ç©©å®šç‰ˆæœ¬ æœ€å°æ¬Šé™åŸå‰‡ (least privilege access) åŸæœ¬å·¥ç¨‹å¸«ç‚ºäº† apply ï¼Œæœƒæœ‰ admin æ¬Šé™çš„ credential ç§»è½‰åˆ°å®‰å…¨çš„ CI/CD server ä¸Šï¼Œåœ¨ server ä¸ŠåŸ·è¡Œ å·¥ç¨‹å¸«ä¸å†æ¡æœ‰é€™äº›è¶…ç´šç®¡ç†å“¡æ¬Šé™ï¼Œé¿å…å·¥ä½œæ©Ÿè¢«é§­çš„å®‰å…¨éš±æ†‚ NOTE: å·¥ç¨‹å¸«è¢«é‡£é­š (phishing) æˆ–æ˜¯ç¤¾äº¤å·¥ç¨‹æ”»æ“Š (social engineering attacks) æ‰æ˜¯å°è‡´å…¬å¸æœå‹™è¢«å®³çš„ä¸»å› ï¼Œä¸å¯ä¸é˜² è§£æ±ºæ–¹æ¡ˆ é¸æ“‡å®‰å…¨çš„ CI/CD serverï¼Œä¾‹å¦‚åœ¨å…§ç¶²çš„ self-hosted Jenkins server å°‡ terraform çš„åŸ·è¡Œé»ï¼Œå¾å·¥ç¨‹å¸«æœ¬æ©Ÿç§»è½‰åˆ° CI/CD æœå‹™å™¨ä¸Š æ›´æ”¹ CI/CD ï¼ŒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ Terraform validate Terraform plan çš„çµæœè¼¸å‡ºåˆ° Github / Slack plan çµæŸå¾Œåœä½ CI/CDï¼Œç™¼é€ä¸€å€‹ apply request åˆ° Github commentï¼Œä¸å†ç¹¼çºŒåŸ·è¡Œ apply SRE ä¸»ç®¡åªè¦é€é Github comment æˆ–æ˜¯ Slack bot å°±å¯ä»¥é¸æ“‡åˆé©çš„æ™‚é–“ï¼Œapprove apply æœ€å¾Œç§»é™¤å¤§å¤šæ•¸å·¥ç¨‹å¸«çš„ terraform æ¬Šé™ ç¯„ä¾‹ äº‹å¯¦ä¸Šï¼Œä¸åŒå®¶çš„ CI/CD serverï¼Œå·¥ä½œæµç¨‹éƒ½æ˜¯é¡ä¼¼\ncheckout initialize tools / SDK (ex. az/aws/gcloud client) inject public cloud credential (ex. Azure/AWS/GCP key) terraform validete terraform plan terraform apply (option) require manual approve å¦‚æœæ˜¯ Jenkins çš„ä½¿ç”¨è€…ï¼Œå¯ä»¥åƒè€ƒ Azure æä¾›çš„ç¯„ä¾‹\nç’°å¢ƒç®¡ç† åœ¨äººå·¥ apply çš„å·¥ä½œæµç¨‹ä¸­ï¼Œå·¥ç¨‹å¸«éœ€è¦è‡ªè¡Œåˆ‡æ›ç’°å¢ƒï¼Œä¾‹å¦‚ git repo å·¥ä½œç›®éŒ„å¦‚ä¸‹\ntree project â”œâ”€â”€ dev â”œâ”€â”€ staging â””â”€â”€ prod cd project/dev; terraform plan # plan staging cd project/prod; terraform plan # plan prod é€™æ˜¯ç›¸å°æ¯”è¼ƒå®‰å…¨çš„åšæ³•ï¼Œåœ¨å°çš„è³‡æ–™å¤¾ç›®éŒ„ä¸‹ï¼Œå°±æœƒ apply åˆ°æ­£ç¢ºçš„ç’°å¢ƒï¼Œç¨‹å¼ç¢¼èˆ‡ç’°å¢ƒæœ‰ç·Šå¯†çš„å°æ˜ ã€‚é™¤äº†ä»¥ä¸‹å¹¾ç¨®æƒ…å½¢\næƒ³è¦éƒ¨ç½² devï¼Œçµæœæ²’æ³¨æ„åˆ°è‡ªå·±åœ¨ staging æˆ–æ˜¯ prod æœ‰ä¸€éƒ¨åˆ†çš„ input variable æœƒå½±éŸ¿çµæœï¼Œç„¶å¾Œåˆè¼¸å…¥éŒ¯èª¤çš„ input åˆ°éŒ¯èª¤çš„ç’°å¢ƒä¸Š å°å¾ˆæ„šè ¢ï¼Œä½†æˆ‘éƒ½è¦‹éï¼ˆæ°£è¡€æ”»å¿ƒï¼‰ã€‚\næ—¢ç„¶å°å…¥äº†è‡ªå‹•åŒ–ï¼Œç’°å¢ƒçš„åˆ‡æ›å¯ä»¥è‡ªå‹•åˆ‡æ›ï¼Œä¾‹å¦‚\næ‰€æœ‰ feature branch åŸ·è¡Œ CI/CD server ä¸Šçš„æœ¬åœ°æ¸¬è©¦ lint init validate æ‰€æœ‰ PR éƒ½æœƒè§¸ç™¼æ–°çš„ dev ç’°å¢ƒéƒ¨ç½² plan apply æ¸¬è©¦è…³æœ¬ æ‰€æœ‰ master merge / push éƒ½æœƒè§¸ç™¼ staginge éƒ¨ç½² QA æ¸¬è©¦ å£“åŠ›æ¸¬è©¦ (optional) æ‰€æœ‰ release candidate tag æœƒéƒ¨ç½²åˆ° release candinate release management æ‰€æœ‰ç™¼å¸ƒç‰ˆæœ¬çš„ tag (ex. 1.1.0 / 1.2.0-release) æœƒéƒ¨ç½² prod ç•¶ç„¶è¦äº‹å…ˆé€šçŸ¥ç›¸é—œäººå£« stack holders è³‡æ·±å·¥ç¨‹å¸«åªè¦æ§åˆ¶ branch / tag å°±å¯ä»¥æ§åˆ¶ç™¼å¸ƒã€‚\nä½ èªªé€™æ¨£ï¼Œè¬ä¸€å¤©å…µå»è‡ªå·±æ‰“ tag æ‰“éŒ¯ commitï¼Œæˆ–æ˜¯æ¨éŒ¯ branch æ¨åˆ° masteræˆ–æ˜¯ release candidateï¼Œé‚„ä¸æ˜¯ä¾æ¨£çˆ†æ‰ã€‚é‚£ä½ å¯ä»¥æŠŠ master èˆ‡ release branch é–èµ·ä¾† (protected branch) ï¼Œç„¶å¾ŒæŠŠ tag push æ¬Šé™é–ä½ã€‚\nä½ èªªé‚„æ˜¯éŒ¯ é‚£æˆ‘\u0026hellip; \u0026hellip;å€‘çœ‹ä¸‹ä¸€æ®µ orz\nå®‰å…¨æ€§ é›–ç„¶èªªæ˜¯è‡ªå‹•åŒ–æ”¹å–„å·¥ä½œæµç¨‹ï¼Œç„¶è€Œæ”¶å›å­˜å–æ¬Šé™ï¼Œå°æ–¼æœå‹™çš„æ•´é«”å®‰å…¨æ€§å¤§å¹…æå‡ï¼Œç•¢ç«Ÿæ˜¯å¯ä»¥æ›´æ”¹ infrastructure çš„ç®¡ç†å“¡å¸³æˆ¶ã€‚Terraform æ—¢ç„¶èƒ½å¤ æ–°å¢ä¿®æ”¹é›²ç«¯çš„ infrastructureï¼Œé€™å€‹å¸³è™Ÿçš„æ¬Šé™æ˜¯ç›¸ç•¶å¤§çš„ï¼Œè¬ä¸€é‡‘é‘°(GCP/AWS/Azure credentail) æµå‡ºæˆ–é­é§­ï¼Œå¾Œæœéƒ½æ˜¯æ¯€æ»…æ€§çš„ï¼Œä¾‹å¦‚å¯ä»¥ç›´æ¥åˆªé™¤æœå‹™çš„ infrastructureï¼Œæˆ–æ˜¯ä¿®æ”¹é˜²ç«ç‰†çš„è¦å‰‡ï¼Œå·åŸ‹å…¶ä»–é‡‘è€€ï¼Œ\u0026hellip;ç­‰æ–¼æ˜¯æ•´åº§å…¬æœ‰é›²é€çµ¦é§­å®¢ã€‚æ‰€ä»¥æˆ‘å€‘ä½¿ç”¨ Terraform æ‡‰è©²è¦æ…é‡è€ƒæ…®å­˜å–æ¬Šé™çš„å®‰å…¨æ€§ã€‚\næœ¬ä¾†æ˜¯æ¯å€‹ SRE çš„æœ¬æ©Ÿé›»è…¦ä¸Šï¼Œå¯èƒ½éƒ½æœƒæœ‰é€™æŠŠå¸³æˆ¶æ¬Šé™ã€‚\nå¦‚æœæ˜¯ self-hosted Jenkins serverï¼Œæˆ–æ˜¯ Github enterprise serverï¼ŒæŠŠæœå‹™æ¬Šé™ç§»è½‰åˆ°é€™äº›æœå‹™å™¨ï¼Œä¾¿å¯ä»¥ç¢ºä¿é‡‘é‘°æ°¸é éƒ½åœ¨å…¬å¸çš„é˜²ç«ç‰†å…§éƒ¨ç¶²è·¯ï¼Œæ›´åŠ å¤§å¹…åº¦çš„æå‡æ•´é«”çš„å®‰å…¨æ€§ã€‚\nå…¶ä»– å¯ä»¥é€²ä¸€æ­¥åšé‡‘é‘°æ¬Šé™åˆ†å‰²ï¼Œå°‡åº•ä¸‹å››å€‹æ¬Šé™é€éå…¬æœ‰é›²çš„ IAM role å»åˆ‡å‰²ã€‚è¦æ˜¯è¬ä¸€é‡‘é‘°é‚„æ˜¯å¤–æ´©äº†ï¼Œå¯ä»¥é™ä½æå¤±ã€‚\nè®€å– æ–°å¢ ä¿®æ”¹ åˆªé™¤ ä½ èªªé€™å€‹ä¸ç”¨è‡ªå‹•åŒ–å°±å¯ä»¥åšï¼Œæˆ‘èªªå¦‚æœåˆ†å‰²é‡‘é‘°ç„¶å¾Œäººå·¥è‡ªå·±åˆ‡æ›æ“ä½œï¼Œåè€Œæœƒå¢åŠ æ“ä½œçš„è¤‡é›œåº¦ï¼Œå¢åŠ éŒ¯èª¤çš„æ©Ÿæœƒã€‚ç„¶å¾Œå·¥ç¨‹å¸«çš„ç—›è‹¦ç¨‹åº¦ï¼Œèˆ‡æ‰‹ä¸Šçš„é‡‘é‘°æ•¸é‡æˆæ­£æ¯”ã€‚\næˆ–æ˜¯åˆ©ç”¨ç’°å¢ƒå­˜å–é‡‘è€€åˆ†å‰²ï¼ŒæŠŠé‡‘è€€é€²ä¸€æ­¥åˆ‡å‰²æˆä¸åŒçš„æ¬Šé™ï¼Œè¬ä¸€æ‰äº†ï¼Œæå®³ä¹Ÿæ§åˆ¶åœ¨ä¸€å€‹ç’°å¢ƒä¹‹å…§ã€‚ä¾‹å¦‚ï¼š\ndev staging prod ä¸åŒç’°å¢ƒçš„ infrastructure ï¼Œåœ¨å‰µå»ºåˆæœŸå°±æ˜¯é€éä¸åŒçš„å¸³è™Ÿç”¢ç”Ÿçš„ï¼Œå½¼æ­¤ä¸æœƒæœ‰ä¸ä¹¾æ·¨æ®˜ç•™çš„å¸³è™Ÿæ¬Šé™ã€‚\nå°çµ é€™é‚Šå°±è¬›å…©ä»¶äº‹\nè‡ªå‹•åŒ–å¯ä»¥é˜²å‘† è‡ªå‹•åŒ–å¯ä»¥å¢åŠ å®‰å…¨ åƒè€ƒæ–‡ä»¶ Terraform Official doc: Running Terraform in Automation ","permalink":"https://chechia.net/posts/2020-10-03-terraform-infrastructure-as-code-automation/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä¸Šé¢è¬›è§£ Terraform çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼Œæä¾›ç¯„æœ¬åŸå§‹ç¢¼ï¼Œä»¥åŠä¸€æ­¥ä¸€æ­¥å°å…¥çš„è©³ç´°æ­¥é©Ÿã€‚å„ä½æ‡‰è©²éƒ½å¯ä»¥ä¾ç…§ä¸Šé¢å¹¾ç¯‡çš„èªªæ˜ï¼Œé–‹å§‹å¿«æ¨‚çš„ä½¿ç”¨ Terraform äº†ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œç•¶ä½¿ç”¨ Terraform çš„è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œç®¡ç†çš„è³‡æ–™è¶Šä¾†è¶Šå¤šæ™‚ï¼Œé–‹å§‹æœƒå‡ºç¾ä¸€äº›å•é¡Œï¼Œä¾‹å¦‚é‡è¤‡çš„ terraform code è¶Šä¾†è¶Šå¤šï¼Œå”åŒå·¥ä½œ review ä¸å¤ªå®¹æ˜“ï¼Œstate çš„å…§å®¹ç®¡ç†èˆ‡é–ç®¡ç†ï¼Œç­‰ç­‰ã€‚é€™äº›å•é¡Œå¯ä»¥é€éä¸€äº›å·¥ä½œæµç¨‹çš„æ”¹é€²ï¼Œæˆ–æ˜¯å°å…¥æ–°çš„å°å·¥å…·ï¼Œä¾†æ”¹å–„å·¥ä½œæ•ˆç‡ã€‚\u003c/p\u003e\n\u003cp\u003eæ¥ä¸‹ä¾†ç­†è€…æ¨è–¦å¹¾å€‹å¿ƒå¾—èˆ‡å·¥å…·ï¼Œå¸Œæœ›èƒ½æå‡ä½¿ç”¨ Terraform çš„æ•ˆç‡èˆ‡ç”¢å€¼\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹å¹¾ç¯‡æ–‡ç« ï¼Œé©åˆå·²ç¶“ä½¿ç”¨é terraform ä¸€é»æ™‚é–“ï¼Œæœ‰ç¶“é©—çš„åœ˜éšŠï¼Œä¸¦æ‰“ç®—æ›´å¤§è¦æ¨¡å°å…¥ terraformï¼Œæ­£åœ¨å°‹æ±‚æ”¹å–„çš„æ–¹å‘ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¿ƒå¾—\n\u003cul\u003e\n\u003cli\u003eCI/CD å…¨è‡ªå‹•åŒ–\u003c/li\u003e\n\u003cli\u003eState backend é¸æ“‡\u003c/li\u003e\n\u003cli\u003eæœ€ä½³å¯¦è¸ \u003ca href=\"https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\"\u003ehttps://www.terraform.io/docs/cloud/guides/recommended-practices/index.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå·¥å…·\n\u003cul\u003e\n\u003cli\u003eTerraform Atlantis\u003c/li\u003e\n\u003cli\u003eTerragrunt\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"cicd-å…¨è‡ªå‹•åŒ–\"\u003eCI/CD å…¨è‡ªå‹•åŒ–\u003c/h1\u003e\n\u003cp\u003eç•¶å…¬å¸æˆåŠŸå°å…¥ terraform ï¼Œä¸¦ä¸”æ•´åˆ Git-flow çš„å·¥ä½œæµç¨‹å¾Œï¼Œæ‡‰è©²å¯ä»¥å¾ˆæ˜é¡¯çš„æ„Ÿå—åˆ°ï¼Œæ•´é«”çš„ infrastructure ç”¢å‡ºç©©å®šåº¦æœ‰å¤§å¹…æå‡ï¼Œç•¢ç«Ÿè»Ÿé«”å·¥ç¨‹ä¸­ code review æ˜¯ç©©å®šåº¦çš„æ ¸å¿ƒé—œéµä¹‹ä¸€ï¼Œè€Œå°å…¥ terraform èˆ‡ infrastructure as code è®“ infrastructure ä¹Ÿèƒ½åœ¨åˆç†çš„å·¥ä½œæµç¨‹ä¸­è¢«å±¤å±¤ reviewã€‚\u003c/p\u003e","title":"Terraform Infrastructure as Code: CI/CD automation"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nä¸Šé¢è¬›äº†å¾ˆå¤š terraform çš„æ“ä½œç¯„ä¾‹ï¼Œæ‡‰è©²çœ‹åˆ°é€™è£¡ï¼Œå°æ–¼ terraform åŸºæœ¬ä¸Šæ˜¯ä»€éº¼æ±è¥¿ï¼Œæ‡‰è©²æœ‰äº›æ¦‚å¿µäº†ã€‚ç„¶è€Œé€™æ¨£é‚„ä¸èƒ½ç®—æ˜¯å­¸æœƒ terraformï¼Œé€™ç¨®å·¥å…·çš„æ±è¥¿ä¸€å®šè¦æœ‰å¯¦éš›æ“ä½œéçš„ç¶“é©—æ‰ç®—æ˜¯å­¸æœƒã€‚\nå¯ä»¥ç›´æ¥åƒè€ƒ Terraform å®˜æ–¹çš„ Get-started æ–‡ä»¶ä¾†æ“ä½œå­¸ç¿’ï¼Œæˆ‘é€™é‚Šä¹Ÿæä¾›ä¸€å€‹ Git repository è®“å¤§å®¶ä¸Šæ‰‹ï¼Œç•¶ä½œåˆæ¬¡æ“ä½œçš„æ¡†æ¶ã€‚\næä¾›åšç‚ºç¯„ä¾‹çš„åŸå§‹ç¢¼ é€™å€‹ Github Repository æ˜¯æˆ‘çµ¦ç¤¾ç¾¤æ¼”è¬›æ‰€ä½¿ç”¨çš„ç¯„ä¾‹ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨çš„å¯ä»¥åƒè€ƒ\nhttps://github.com/chechiachang/terraform-playground\ntree â”œâ”€â”€ README.md â”œâ”€â”€ SOP.md â”œâ”€â”€ aws/ â”œâ”€â”€ azure/ â””â”€â”€ gcp/ TL;DR é¸æ“‡ä½¿ç”¨çš„é›²å¹³å°ï¼Œé€™é‚Šæä¾›ä¸‰å®¶ç¯„ä¾‹ï¼Œä¾‹å¦‚æˆ‘é€™é‚Šä½¿ç”¨ gcpï¼Œç•¶ç„¶ä½ å°±è¦æº–å‚™ GCP çš„å¸³è™Ÿï¼Œä¸¦ä¸”ä¸‹è¼‰æœ‰åŸ·è¡Œæ¬Šé™çš„ç”¨æˆ¶ credential json key ç­‰ç­‰ã€‚\né›–ç„¶æˆ‘æ²’æ”¶ gcp éŒ¢ï¼Œé€™é‚Šé‚„æ˜¯æ¨å»£ä¸€ä¸‹ gcp çš„ free credit è©¦ç”¨ã€‚é˜¿è¦ç”¨ Azure Cloud çš„ free credit ä¾†åŸ·è¡Œé€™å€‹ç¯„ä¾‹ä¹Ÿæ˜¯å®Œå…¨æ²’å•é¡Œï¼Œéå¸¸å¤ ç”¨ã€‚å”¯æœ‰ AWS çš„è©¦ç”¨æ–¹æ¡ˆè·Ÿå‰©ä¸‹å…©å®¶ä¸å¤ªä¸€æ¨£ï¼Œé€™å€‹ repository èµ·çš„æœå‹™å¯èƒ½æœƒè¶…é AWS çš„å…è²»é¡åº¦æ¶µè“‹ç¯„åœï¼Œç¸½ä¹‹è«‹è‡ªå·±æ³¨æ„ã€‚\ngit clone https://github.com/chechiachang/terraform-playground cd gcp DIR=my-new-project make project cd my-new-project vim *tf terraform init terraform plan terraform apply é€™æ¨£æ‡‰è©²å°±æœƒè·‘å®Œã€‚ç„¶å¾Œæˆ‘å€‘è¬›è§£å¹¾å€‹åœ°æ–¹ã€‚\nå·¥ä½œç›®éŒ„ Terraform é è¨­æ˜¯ä»¥ç•¶ä¸‹åŸ·è¡Œçš„ç›®éŒ„ä½œç‚ºåŸºæº–ï¼Œæƒæè³‡æ–™å¤¾ä¸­çš„ .tf æª”æ¡ˆã€‚æ‰€ä»¥å¯ä»¥æŠŠä¸€å€‹ä¸€å€‹ç¨ç«‹çš„å°ˆæ¡ˆå…ˆç”¨è³‡æ–™å¤¾è£å¥½ï¼Œå½¼æ­¤å…§å®¹äº’ä¸å¹²æ¶‰ã€‚\næˆ‘å€‘é€™é‚Šå‰µå»ºæ–°çš„ subdirectoryï¼Œé€™é‚Šæ˜¯ä»¥ my-new-project ç‚ºç¯„ä¾‹ã€‚é€™é‚ŠæŒ‡çš„ project åªæ˜¯ä¸€å€‹ terraform resource ç¯„åœï¼Œå¯ä»¥ä½†ä¸ç”¨æ˜¯ä¸€å€‹çœŸå¯¦çš„ gcp projectã€‚terraform åŸ·è¡Œæ˜¯ä»¥ä¸€å€‹ directory ç‚ºç¯„åœï¼Œä¸åŒ project directory å¯ä»¥é€éä¸åŒ terraform æŒ‡ä»¤æ§åˆ¶ã€‚å¦‚æœæ˜¯ç¨ç«‹çš„æœå‹™å¸Œæœ›ç¨ç«‹ç®¡ç†ä¹Ÿå¯ä»¥åˆ‡é–‹ã€‚\næˆ‘å¯«äº†ä¸€å€‹ç°¡å–®çš„ Makefileï¼Œé€²ä¸€æ­¥å°è£åŸºæœ¬çš„æŒ‡ä»¤ï¼ŒåŸºæœ¬ä¸Šä¸éœ€è¦ Makefile ä»¥å¤–çš„æ“ä½œã€‚ make project æ˜¯å…¶ä¸­ä¸€å€‹æŒ‡ä»¤ï¼Œå¹«å¿™å‰µå»ºè³‡æ–™å¤¾ã€å¸ƒç½® Makefile èˆ‡åŸºæœ¬çš„ terraform è¨­å®šç­‰ç­‰ã€‚\nå¦‚æœåœ˜éšŠæœ‰å¤šäººå”ä½œï¼Œéå¸¸æ¨è–¦ä½¿ç”¨çµ±ä¸€ Makefile / æˆ–æ˜¯ bash script å°è£ï¼Œçµ±ä¸€é€™äº›ç·¨è¼¯çš„é›œäº‹ï¼Œé™ä½ä¸åŒäººç·¨è¼¯å‡ºéŒ¯çš„é¢¨éšªã€‚\nç›®éŒ„çµæ§‹ ç¸½ä¹‹æˆ‘å€‘ç¾åœ¨ cd åˆ° my-new-project çš„å·¥ä½œç›®éŒ„ä¸‹ï¼Œé€™å€‹ç›®éŒ„ä»£è¡¨ä¸€å€‹å°ˆæ¡ˆã€‚å…¶ä»–çš„ gke-playgound èˆ‡ national-team-5g ä¹Ÿæ˜¯å…¶ä»–çš„å°ˆæ¡ˆï¼Œå…ˆå¿½ç•¥ä»–ã€‚\ngcp â”œâ”€â”€ README.md â”œâ”€â”€ Makefile â”œâ”€â”€ my-new-project/ â”œâ”€â”€ gke-playground/ â”œâ”€â”€ national-team-5g/ â”œâ”€â”€ templates/ â””â”€â”€ modules/ cd my-new-project é€²å…¥ my-new-project ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è£¡é¢å·²ç¶“æœ‰ä¸€äº›æª”æ¡ˆï¼Œæˆ‘å€‘é¦–å…ˆè¦ç·¨è¼¯çš„æ˜¯é€™å€‹ terraform.tf\nmy-new-project â”œâ”€â”€ Makefile â”œâ”€â”€ provider.tf â”œâ”€â”€ terraform.tf â””â”€â”€ variables.tf vim terraform.tf terraform.tf æ˜¯ terraform æœ¬èº«çš„è¨­å®š é€™é‚Šæ˜¯ Terraform Backend çš„è¨­å®šï¼Œå¦‚æœä¸çŸ¥é“ä»€éº¼æ˜¯ terraform backend é€™å€‹æˆ‘å€‘æ˜å¤©çš„æ–‡ç« æœƒè¬›ã€‚é€™é‚Šä½¿ç”¨çš„ backend æ˜¯ terraform å®˜æ–¹è‡ªå®¶çš„ terraform cloudï¼Œå¯ä»¥åœ¨ç¶²ç«™ä¸Š\nè¨»å†Šä½¿ç”¨è€…ï¼Œå¡«åˆ°åº•ä¸‹ organization é€™è£¡ å‰µå»ºä¸€å€‹ workspaceï¼Œå¡«åˆ° workspace.name é€™è£¡ terraform { # Create a remote organization on https://app.terraform.io backend \u0026quot;remote\u0026quot; { # Provide terraform credential by # - terraform login (suggested) # - use User API Token #token = \u0026quot;\u0026quot; hostname = \u0026quot;app.terraform.io\u0026quot; organization = \u0026quot;chechia\u0026quot; workspaces { name = \u0026quot;terraform-playground\u0026quot; } } } provider.tf æ˜¯ provider çš„è¨­å®š terraform client æœƒæŠŠ tf æª”æ¡ˆæ‹¿ä¾†é‹ç®—ï¼Œé€é Provider ï¼Œå°‡éœ€æ±‚å¯¦éš›è½‰åŒ–æˆ API call ï¼Œç„¶å¾Œé€åˆ°å…¬æœ‰é›²æˆ–æ˜¯å…¶ä»–ç›®æ¨™ã€‚é€™é‚Šå°±åªè¬›åˆ°é€™æ¨£ã€‚\nprovider ç‚ºäº†å·¥ä½œï¼Œå¯èƒ½æœƒéœ€è¦æä¾›ä¸€äº›åƒæ•¸ï¼Œä¾‹å¦‚ google çš„ provider æœƒéœ€è¦åœ¨é€™è£¡æä¾› credential_json çš„è·¯å¾‘ï¼Œè«‹æŠŠå®ƒæ”¾åœ¨é©åˆçš„åœ°æ–¹ï¼Œç„¶å¾Œç”¨çµ•å°è·¯å¾‘æŒ‡å‘ google\nNOTE: ä¸è¦ commit credential key åˆ° git repository è£¡é¢ã€‚å¯ä»¥æ”¾åˆ°å¤–å±¤è³‡æ–™å¤¾ï¼Œæˆ–è‡³å°‘è¦ gitignore æ‰ã€‚\nprovider \u0026quot;google\u0026quot; { version = \u0026quot;~\u0026gt;v3.25.0\u0026quot; credentials = file(var.credential_json) project = var.project region = var.region } variable.tf åšåƒæ•¸çš„å­˜æ”¾é» é›–ç„¶ä¸Šé¢ tf æª”æ¡ˆä½¿ç”¨äº† terraform / provider / variable ï¼Œä½† terraform æƒææª”æ¡ˆæ™‚ï¼Œæª”åæœ¬èº«ä¸¦ä¸æœƒå½±éŸ¿ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œåƒæ•¸ä½ æƒ³æ“ºå“ªå°±æ“ºå“ªã€‚ä¸éä¸Šé¢æ˜¯å¸¸è¦‹çš„å‘½åæ…£ä¾‹ï¼Œé€™æ¨£æ“ºäººé¡æ¯”è¼ƒå®¹æ˜“æ‰¾å¾—åˆ°ã€‚\nvariable é€™é‚Šè¨­å®šçš„åƒæ•¸ï¼Œæ¯”è¼ƒåƒæ˜¯ argumentsï¼Œä¹Ÿå°±æ˜¯ç•¶å…¶ä»–ä½ç½®çš„ tf æª”æ¡ˆï¼Œå¼•ç”¨é€™å€‹è³‡æ–™å¤¾ä½œç‚º module çš„æ™‚å€™ï¼Œä½œç‚ºåƒæ•¸è¼¸å…¥çš„ placeholderï¼Œå…¶ä»– tf æª”æ¡ˆå¯ä»¥ä½¿ç”¨ variable é—œéµå­—å®šç¾©çš„åƒæ•¸ï¼Œä¾‹å¦‚: var.projectï¼Œæˆ–æ˜¯ provider.tf è£¡çš„ var.credential_jsonã€‚\nvariable é—œéµå­—ä¹Ÿå¯ä»¥å®šç¾© default é è¨­å€¼ï¼Œå¦‚æœæ²’æœ‰å®šç¾© defaultï¼Œä¹Ÿæ²’æœ‰å¾å¤–éƒ¨å‚³å…¥ argumentï¼Œæœƒåœ¨ validate æ™‚é€ æˆ errorã€‚\n# Global variable \u0026quot;project\u0026quot; { type = string default = \u0026quot;myproject\u0026quot; } variable \u0026quot;credential_json\u0026quot; { type = string default = \u0026quot;../credentials/gke-playground-0423-aacf6a39cc3f.json\u0026quot; } variable \u0026quot;region\u0026quot; { type = string default = \u0026quot;asia-east1\u0026quot; } Create é€™è£¡æˆ‘å€‘è©¦è‘—å‰µå»ºä¸€å° GCEï¼Œä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ï¼Œæœƒç™¼ç¾å¤šäº†ä¸€å€‹æª”æ¡ˆ compute_instance.tfã€‚\nNAME=my-new-gce make gce my-new-project â”œâ”€â”€ Makefile â”œâ”€â”€ compute_instance.tf â”œâ”€â”€ provider.tf â”œâ”€â”€ terraform.tf â””â”€â”€ variables.tf å…§å®¹å¤§æ¦‚æ˜¯\nmodule \u0026quot;my-new-gce\u0026quot; { source = \u0026quot;../modules/compute_instance\u0026quot; providers = { google = google } project = var.project name = \u0026quot;my-new-gce\u0026quot; image = \u0026quot;https://www.googleapis.com/compute/v1/projects/centos-cloud/global/images/centos-7-v20200429\u0026quot; machine_type = \u0026quot;n1-standard-1\u0026quot; network = \u0026quot;projects/${var.project}/global/networks/myproject\u0026quot; subnetwork = \u0026quot;projects/${var.project}/regions/asia-east1/subnetworks/myproject\u0026quot; } module é—œéµå­—å®šç¾©ä¸€çµ„è³‡æºï¼Œå…·é«”çš„å…§å®¹æ˜¯é€™è£¡ï¼Œç°¡å–®ä¾†èªªå¯ä»¥æŠŠä¸€å † tf æª”æ¡ˆæ”¾åœ¨ä¸€å¡Šï¼Œç„¶å¾ŒæŠŠéœ€è¦çš„åƒæ•¸ä½¿ç”¨ variable.tf æ‹‰å‡ºå»ï¼Œè®“å…¶ä»–åœ°æ–¹å¼•ç”¨ã€‚\nsource = \u0026quot;\u0026quot; æ˜¯å¯¦éš›å¼•ç”¨çš„ module ä¾†æº\nåº•ä¸‹æ˜¯é€™å€‹ module éœ€è¦ç”¨åˆ°çš„åƒæ•¸ï¼Œä¾‹å¦‚ project, name, image, machine_type,\u0026hellip; ç­‰æ˜¯ gce é€™å€‹ module éœ€è¦çš„åƒæ•¸ã€‚\nMakefile NAME=my-new-gce make gce é€™è¡ŒæŒ‡ä»¤èˆ‡ terraform ç„¡é—œï¼Œåªæ˜¯ä¸€å€‹å¿«é€Ÿç”Ÿæˆ compute_instance.tf çš„å°è…³æœ¬ã€‚ä½¿ç”¨é€™å€‹è…³æœ¬å¯ä»¥\nå¿«é€Ÿç”¢ç”Ÿ tf æª”æ¡ˆ ç”¢ç”Ÿæ¨™æº–åŒ–çš„ tf æª”æ¡ˆï¼Œæ‰€æœ‰ project çš„ compute_instance éƒ½é•·ä¸€æ¨£ æŠ½æ›åå­ name ä½¿ç”¨ symbolic link è®“æ‰€æœ‰ project è³‡æ–™å¤¾ä½¿ç”¨åŒä¸€å€‹ Makefileï¼Œkeep your code DRYã€‚\næœ€å¾Œå°±æ˜¯å¸¸è¦çš„ plan èˆ‡ applyï¼Œé€™é‚Šæ²’æœ‰ä»€éº¼ç‰¹åˆ¥çš„ã€‚\nterraform plan terraform apply å°çµ æœ‰è¦å¾‹åœ°æ•´ç† project å¯ä»¥é™ä½ç¶­è­·æˆæœ¬ å–„ç”¨ module å°è£ï¼Œå¯ä»¥æé«˜æ•´é«”çš„é‡ç”¨æ€§èˆ‡æ˜“ç”¨å§“ï¼Œæé«˜é–‹ç™¼æ•ˆç‡ ä½¿ç”¨ template tf å¯ä»¥åŠ é€Ÿé‡è¤‡çš„è³‡æºç”¢ç”Ÿæ­¥é©Ÿ å•é¡Œ: æ­¤æ™‚çš„è³‡æ–™å¤¾ä¸­é‚„æ˜¯å……æ»¿å¤§é‡é‡è¤‡çš„ codeï¼Œä¾‹å¦‚åˆ°è™•éƒ½éœ€è¦ providerã€é‡è¤‡çš„ moduleï¼Œä¸€å¤§å †é‡è¤‡çš„æ±è¥¿ã€‚æœ‰æ²’æœ‰å¯èƒ½å†è®“æˆ‘å€‘çš„ç¨‹å¼ç¢¼æ›´ DRY ä¸€é»å‘¢?\nTerragrunt å¹«æˆ‘å€‘å¯¦ç¾é€™é»ï¼Œéå¸¸å€¼å¾—ä½¿ç”¨çš„å·¥å…·ã€‚è«‹è¦‹ä¸‹ç¯‡åˆ†äº«ã€‚\n","permalink":"https://chechia.net/posts/2020-10-02-terraform-infrastructure-as-code-repository-example/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä¸Šé¢è¬›äº†å¾ˆå¤š terraform çš„æ“ä½œç¯„ä¾‹ï¼Œæ‡‰è©²çœ‹åˆ°é€™è£¡ï¼Œå°æ–¼ terraform åŸºæœ¬ä¸Šæ˜¯ä»€éº¼æ±è¥¿ï¼Œæ‡‰è©²æœ‰äº›æ¦‚å¿µäº†ã€‚ç„¶è€Œé€™æ¨£é‚„ä¸èƒ½ç®—æ˜¯å­¸æœƒ terraformï¼Œé€™ç¨®å·¥å…·çš„æ±è¥¿ä¸€å®šè¦æœ‰å¯¦éš›æ“ä½œéçš„ç¶“é©—æ‰ç®—æ˜¯å­¸æœƒã€‚\u003c/p\u003e\n\u003cp\u003eå¯ä»¥ç›´æ¥åƒè€ƒ Terraform å®˜æ–¹çš„ Get-started æ–‡ä»¶ä¾†æ“ä½œå­¸ç¿’ï¼Œæˆ‘é€™é‚Šä¹Ÿæä¾›ä¸€å€‹ Git repository è®“å¤§å®¶ä¸Šæ‰‹ï¼Œç•¶ä½œåˆæ¬¡æ“ä½œçš„æ¡†æ¶ã€‚\u003c/p\u003e\n\u003ch3 id=\"æä¾›åšç‚ºç¯„ä¾‹çš„åŸå§‹ç¢¼\"\u003eæä¾›åšç‚ºç¯„ä¾‹çš„åŸå§‹ç¢¼\u003c/h3\u003e\n\u003cp\u003eé€™å€‹ Github Repository æ˜¯æˆ‘çµ¦ç¤¾ç¾¤æ¼”è¬›æ‰€ä½¿ç”¨çš„ç¯„ä¾‹ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨çš„å¯ä»¥åƒè€ƒ\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003ehttps://github.com/chechiachang/terraform-playground\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003etree\nâ”œâ”€â”€ README.md\nâ”œâ”€â”€ SOP.md\nâ”œâ”€â”€ aws/\nâ”œâ”€â”€ azure/\nâ””â”€â”€ gcp/\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"tldr\"\u003eTL;DR\u003c/h3\u003e\n\u003cp\u003eé¸æ“‡ä½¿ç”¨çš„é›²å¹³å°ï¼Œé€™é‚Šæä¾›ä¸‰å®¶ç¯„ä¾‹ï¼Œä¾‹å¦‚æˆ‘é€™é‚Šä½¿ç”¨ gcpï¼Œç•¶ç„¶ä½ å°±è¦æº–å‚™ GCP çš„å¸³è™Ÿï¼Œä¸¦ä¸”ä¸‹è¼‰æœ‰åŸ·è¡Œæ¬Šé™çš„ç”¨æˆ¶ credential json key ç­‰ç­‰ã€‚\u003c/p\u003e","title":"Terraform Infrastructure as Code: Example repository"},{"content":"å…ˆå è™›æ“¬æ©Ÿèˆ‡ Kubernetes åœ¨ GCP ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œæœƒéœ€è¦é¢å°å…ˆå è™›æ“¬æ©Ÿçš„é¡å¤–é™åˆ¶\nè³‡æ–™ä¸­å¿ƒæœƒ (å¯é æœŸæˆ–ä¸å¯é æœŸåœ°) çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿä¸èƒ½è‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒè¢«è³‡æ–™ä¸­å¿ƒçµ‚æ­¢å¾Œå›æ”¶ GCP ä¸ä¿è­‰æœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ ç¯€é»çš„çµ‚æ­¢æœƒé€ æˆé¡å¤–çš„ç¶­é‹æˆæœ¬ï¼Œä¾‹å¦‚\nç®¡ç†å¤šå€‹ç¯€é»ï¼Œå®¹å¿å…ˆå è™›æ“¬æ©Ÿçš„ç§»é™¤ï¼Œè‡ªå‹•è£œå……æ–°çš„å…ˆå è™›æ“¬æ©Ÿ ç®¡ç†å¤šå€‹æ‡‰ç”¨è¤‡æœ¬ï¼Œç¯€é»çµ‚æ­¢æ™‚ï¼Œç¶­è­·æ•´é«”æ‡‰ç”¨çš„å¯ç”¨æ€§ å°‡ç§»é™¤ç¯€é»ä¸Šçš„æ‡‰ç”¨ï¼Œé‡æ–°æ’ç¨‹åˆ°å…¶ä»–å¯ç”¨ç¯€é» å‹•æ…‹ç¶­è­·æ‡‰ç”¨è¤‡æœ¬çš„æœå‹™ç™¼ç¾ (Service Discovery) èˆ‡æœå‹™ç«¯é» (Endpoints) æ„æ€æ˜¯æ‡‰ç”¨é—œé–‰é‡å•Ÿå¾Œï¼Œæ›äº†ä¸€å€‹æ–° IPï¼Œé‚„è¦èƒ½æŒçºŒå­˜å–æ‡‰ç”¨ã€‚èˆŠçš„ IP è¦ä¸»å‹•å¤±æ•ˆ é…åˆæ‡‰ç”¨çš„å¥åº·æª¢æŸ¥ (Health Check) èˆ‡å¯ç”¨æª¢æŸ¥ (Readiness Check)ï¼Œå†åˆ†é…ç¶²è·¯æµé‡ é€™äº›éœ€æ±‚ï¼Œå¿…é ˆè¦æœ‰è‡ªå‹•åŒ–çš„ç®¡ç†å·¥å…·ï¼Œæ˜¯ä¸å¯èƒ½äººå·¥ç®¡ç†çš„ï¼Œæƒ³åƒä½ æ‰‹ä¸Šä½¿ç”¨ 100 å€‹å…ˆå ç¯€é»ï¼Œå¹³å‡æ¯å¤©æœƒæœ‰ 10% - 15% çš„å…ˆå ç¯€é»è¢«è³‡æ–™ä¸­å¿ƒå›æ”¶ï¼Œç¶­é‹éœ€è¦\nè£œè¶³è¢«ç§»é™¤çš„ 15 å€‹ç¯€é» è¨ˆç®—è¢«ç§»é™¤çš„æ‡‰ç”¨ï¼Œè£œè¶³ç§»é™¤çš„æ‡‰ç”¨æ•¸é‡ ç§»é™¤å¤±æ•ˆçš„æ‡‰ç”¨ç«¯é»ï¼Œè£œä¸Šæ–°çš„æ‡‰ç”¨ç«¯é» æŒçºŒç›£æ§æ‡‰ç”¨ç‹€æ…‹ \u0026hellip; æ²’æœ‰è‡ªå‹•åŒ–ç®¡ç†å·¥å…·ï¼Œçœ‹äº†å¿ƒå·²ç´¯ (è²“çˆªæ©é¢)\næˆ‘å€‘ä½¿ç”¨ Kubernetes å”åŠ©ç¶­é‹è‡ªå‹•åŒ–ï¼Œåœ¨ GCP ä¸Šæˆ‘å€‘ä½¿ç”¨ GKEï¼Œé™¤äº†ä¸Šè¿°æåˆ°çš„å®¹å™¨æ‡‰ç”¨ç®¡ç†è‡ªå‹•åŒ–å¤–ï¼ŒGKE é‚„é¡å¤–æ•´åˆå…ˆå è™›æ“¬æ©Ÿçš„ä½¿ç”¨\nå•Ÿç”¨å…ˆå è™›æ“¬æ©Ÿçš„ç¯€é»æ±  (node-pool)ï¼Œè¨­å®šç¯€é»æ± çš„è‡ªå‹•æ‹“å±•ï¼Œè‡ªå‹•è£œè¶³å…ˆå ç¯€é»çš„æ•¸é‡ GKE è‡ªå‹•ç¶­è­·å…ˆå è™›æ“¬æ©Ÿçš„ labels é—œæ–¼ GKE çš„å…ˆå è™›æ“¬æ©Ÿçš„å®Œæ•´ç´°ç¯€ï¼Œè«‹è¦‹GCP å®˜æ–¹æ–‡ä»¶ã€‚é€™ä»½æ–‡ä»¶åº•ä¸‹ä¹Ÿæä¾›äº† GCP å®˜æ–¹å»ºè­°çš„å…ˆå è™›æ“¬æ©Ÿæœ€ä½³å¯¦è¸\næ¶æ§‹è¨­è¨ˆéœ€è¦å‡è¨­ï¼Œéƒ¨åˆ†æˆ–æ˜¯å…¨éƒ¨çš„å…ˆå è™›æ“¬æ©Ÿéƒ½ä¸å¯ç”¨çš„æƒ…å½¢ Pod ä¸ä¸€å®šæœ‰æ™‚é–“èƒ½å„ªé›…çµ‚æ­¢ (graceful shutdown) åŒæ™‚ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿèˆ‡å…ˆå è™›æ“¬æ©Ÿï¼Œä»¥ç¶­æŒå…ˆå è™›æ“¬æ©Ÿä¸å¯ç”¨æ™‚ï¼Œæœå‹™ä¾ç„¶å¯ç”¨ æ³¨æ„ç¯€é»æ›¿æ›æ™‚çš„ IP è®Šæ›´ é¿å…ä½¿ç”¨æœ‰ç‹€æ…‹çš„ Pod åœ¨å…ˆå è™›æ“¬æ©Ÿä¸Š (é€™é»ç¨å¾Œçš„æ–‡ç« ï¼Œæˆ‘å€‘æœƒè©¦åœ–è¶…è¶Š) ä½¿ç”¨ node taint ä¾†å”åŠ©æ’ç¨‹åˆ°å…ˆå è™›æ“¬æ©Ÿï¼Œèˆ‡éå…ˆå è™›æ“¬æ©Ÿ ç¸½ä¹‹ï¼Œç”±æ–¼æœ‰å®¹å™¨è‡ªå‹•åŒ–ç®¡ç†ï¼Œæˆ‘å€‘æ‰èƒ½è¼•æ˜“çš„ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿã€‚\nGKE ç„¶è€Œï¼Œæ±ºå®šä½¿ç”¨ GKE å¾Œï¼Œå°±æœ‰è¨±å¤šé—œæ–¼æˆæœ¬çš„äº‹æƒ…éœ€è¦è¨è«–\nå…ˆçœ‹ GKE çš„è¨ˆè²»æ–¹å¼ pricing\næ¯å€‹ GKE é›†ç¾¤ç®¡ç†è²»ç”¨ $0.1/hr = $72/hr é€™å€‹è²»ç”¨æ˜¯å›ºå®šæ”¶è²»ï¼Œåªè¦é–‹ä¸€å€‹é›†ç¾¤ï¼Œä¸è«–é›†ç¾¤çš„ç¯€é»æ•¸é‡ã€‚æ‰€ä»¥åœ¨ç¯€é»å¤šã€ç®—åŠ›å¤§çš„é›†ç¾¤è£¡ï¼Œé€™å€‹è²»ç”¨æœƒè¢«ç¨€é‡‹ï¼Œä½†åœ¨ç¯€é»å°‘çš„é›†ç¾¤è£¡æ¯”ä¾‹æœƒè¢«æ”¾å¤§ã€‚\nç„¶å¾Œ GKE é‚„æ˜¯æœƒæœ‰ä¸€äº›è‡ªå·±çš„æ¯›ï¼Œä¿—è©±èªªæœ‰ä¸€å¥½æ²’å…©å¥½ï¼Œæˆ‘å€‘ä½¿ç”¨å®ƒçš„å¥½è™•åŒæ™‚ï¼Œä¹Ÿè¦æ³¨æ„è¨±å¤šçœ‰çœ‰è§’è§’ã€‚å†ä¾†çˆ¬æ–‡ä»¶ã€‚å¦‚åŒæœ€å‰é¢å®£å°ï¼Œç”¨ç”¢å“å°±è¦ä¹–ä¹–æŠŠæ–‡ä»¶çœ‹å®Œï¼Œä¸éé€™è£¡å…ˆé‡å°èˆ‡å…ˆå è™›æ“¬æ©Ÿç›¸é—œçš„è­°é¡Œ\nAllocatable Resource Regional Cluster Cluster autoscaler Allocatable Resource åœ¨ç¶²è·¯ä¸Šçœ‹åˆ°é€™ç¯‡å¥½æ–‡ GKE ä¸Šçš„å¯ä½¿ç”¨çš„è³‡æº Allocatable Resourceã€‚å•¥æ„æ€å‘¢ï¼Ÿé›£é“é‚„æœ‰ä¸èƒ½ä½¿ç”¨çš„è³‡æºå—ï¼Ÿ\næ²’éŒ¯ï¼ŒGKE æœƒä¿ç•™ä¸€å®šçš„æ©Ÿå™¨è³‡æº (e.g. cpu, memory, disk)ï¼Œä¾†ç¶­æŒç¯€é»çš„ç®¡ç†å…ƒä»¶ï¼Œä¾‹å¦‚ container runtime (e.g. Docker)ã€kubeletã€cAdvisorã€‚\nä¹Ÿå°±æ˜¯èªªï¼Œå°±ç®—æˆ‘å€‘è·Ÿ GCP è³¼è²·äº†ç®—åŠ›ï¼Œæœ‰ä¸€å€‹æ¯”ä¾‹çš„è³‡æºæˆ‘å€‘æ˜¯ä½¿ç”¨ä¸åˆ°çš„ã€‚ç´°ç¯€è«‹è¦‹ ç†è§£ GKE é›†ç¾¤æ¶æ§‹ã€‚é€™æœƒå½±éŸ¿æˆ‘å€‘å–®ä¸€ç¯€é»çš„è¦æ ¼ï¼Œæˆ‘å€‘ä¹Ÿéœ€è¦ä¸€ä¸¦è¨ˆç®—ï¼Œèƒ½å¯¦éš›ä½¿ç”¨çš„è³‡æº (allocatable resource)ã€‚\nAllocatable = Capacity - Reserved - Eviction Threshold\nCapacityï¼Œæ˜¯æ©Ÿå™¨ä¸Šå¯¦éš›è£è¼‰çš„è³‡æºï¼Œä¾‹å¦‚ n1-standard-4 æä¾› 4 cpu 15 Gb memory Reservedï¼Œå…¬æœ‰é›²ä»£ç®¡é›†ç¾¤ï¼Œé ä¿ç•™çš„è³‡æº Eviction Thresholdï¼šKubernetes è¨­å®šçš„ kubelet é©…é€é–€æª» é©…é€é–€æª» (Eviction threshold) Kubelet æœƒä¸»å‹•ç›£æ¸¬ç¯€é»ä¸Šçš„è³‡æºä½¿ç”¨ç‹€æ³ï¼Œç•¶ç¯€é»ç™¼ç”Ÿè³‡æºä¸è¶³çš„ç‹€æ³æ™‚ï¼Œkubelet æœƒä¸»å‹•çµ‚æ­¢æŸäº› Pod çš„é‹è¡Œï¼Œä¸¦å›æ”¶ç¯€é»çš„è³‡æºï¼Œä¾†é¿å…æ•´å€‹ç¯€é»è³‡æºä¸è¶³å°è‡´çš„ç³»çµ±ä¸ç©©å®šã€‚è¢«çµ‚æ­¢çš„ Pod å¯ä»¥å†æ¬¡æ’ç¨‹åˆ°å…¶ä»–è³‡æºè¶³å¤ çš„ç¯€é»ä¸Šã€‚ç´°ç¯€è«‹è¦‹ å®˜æ–¹æ–‡ä»¶ Scheduling and Eviction\nåœ¨ Kubernetes ä¸Šï¼Œæˆ‘å€‘å¯ä»¥é€²ä¸€æ­¥è¨­å®šé©…é€é–€æª»ï¼Œç•¶ç¯€é»çš„å¯ç”¨è³‡æºä½æ–¼é©…é€çš„é–€æª»ï¼Œkubelet æœƒè§¸ç™¼ Pod é©…é€æ©Ÿåˆ¶\nGKE ä¸Šæ¯å€‹ç¯€é»æœƒé¡å¤–ä¿ç•™ 100 MiB çš„è¨˜æ†¶é«”ï¼Œä½œç‚ºé©…é€é–€æª»ï¼Œæ„æ€æ˜¯ç•¶ç¯€é»è€—ç›¡è³‡æºï¼Œå°è‡´å‰©é¤˜è¨˜æ†¶é«”ä½æ–¼ 100 MiB çš„æ™‚å€™ï¼Œæœƒç›´æ¥è§¸ç™¼ GKE çš„ Pod Evictionï¼Œçµ‚æ­¢ä¸¦å›æ”¶éƒ¨åˆ†çš„ Podã€‚æ›å¥è©±èªªï¼Œé€™ 100 MiB æ˜¯ä¸èƒ½è¢«ä½¿ç”¨çš„è³‡æºã€‚ç´°ç¯€è«‹è¦‹å®˜æ–¹æ–‡ä»¶\né›†ç¾¤ä¿ç•™è³‡æºç²¾ç®— è³‡æºçš„å®šç¾©ï¼Œä½¿ç”¨é›²å¹³å°çš„ä¸€èˆ¬è²»ç”¨å¤§å¤šä¾†è‡ªæ­¤\ncpu memory storage ç„¶å¾Œæ˜¯é€™å€‹è¡¨ï¼Œæ³¨æ„ä¿ç•™çš„è³‡æºæ˜¯ç´¯é€²ç´šè·\n255 MiB of memory for machines with less than 1 GB of memory 25% of the first 4GB of memory 20% of the next 4GB of memory (up to 8GB) 10% of the next 8GB of memory (up to 16GB) 6% of the next 112GB of memory (up to 128GB) 2% of any memory above 128GB\nå€¼è¨ˆä¸Šèƒ½å¤ ç”¨åˆ°çš„è³‡æºï¼Œåº•ä¸‹ GCP ä¹Ÿæ•´ç†å¥½äº†ï¼Œä¾‹å¦‚ n1-standard-4 å¯¦éš›ä½¿ç”¨çš„æ˜¯ memory 12.3/15ï¼Œcpu 3.92/4ã€‚\nåœ¨ç¶­æŒåˆç†çš„ä½¿ç”¨ç‡ä¸‹ï¼Œé–‹å•Ÿå¤§çš„æ©Ÿå™¨ï¼Œå¯ä»¥é™ä½è¢«ä¿ç•™çš„è³‡æºæ¯”ä¾‹ï¼Œä¾ç…§ç­†è€…å…¬å¸éå»ç¶“é©—ï¼ŒGKE èµ·è·³å°±æ˜¯ n1-standard-4 æˆ–æ˜¯ä»¥ä¸Šè¦æ ¼ï¼Œå¦‚æœä½æ–¼é€™å€‹è¦æ ¼ï¼Œå¯èª¿åº¦çš„è³‡æºæ¯”ä¾‹çœŸçš„å¤ªä½ï¼Œæ‡‰è©²é‡æ–°è€ƒæ…®ä¸€ä¸‹é€™å€‹è§£æ±ºæ–¹æ¡ˆæ˜¯å¦åˆä¹æˆæœ¬ã€‚\nä½†ç©¶ç«Ÿä»€éº¼è¦æ ¼çš„æ©Ÿå™¨é©åˆæˆ‘å€‘çš„éœ€æ±‚ï¼Œèªªå¯¦åœ¨å®Œå…¨è¦çœ‹åŸ·è¡Œçš„æ‡‰ç”¨è€Œå®šã€‚\n","permalink":"https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-kubernetes/","summary":"\u003ch3 id=\"å…ˆå è™›æ“¬æ©Ÿèˆ‡-kubernetes\"\u003eå…ˆå è™›æ“¬æ©Ÿèˆ‡ Kubernetes\u003c/h3\u003e\n\u003cp\u003eåœ¨ GCP ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œæœƒéœ€è¦é¢å°å…ˆå è™›æ“¬æ©Ÿçš„é¡å¤–é™åˆ¶\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè³‡æ–™ä¸­å¿ƒæœƒ (å¯é æœŸæˆ–ä¸å¯é æœŸåœ°) çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003cli\u003eå…ˆå è™›æ“¬æ©Ÿä¸èƒ½è‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒè¢«è³‡æ–™ä¸­å¿ƒçµ‚æ­¢å¾Œå›æ”¶\u003c/li\u003e\n\u003cli\u003eGCP ä¸ä¿è­‰æœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç¯€é»çš„çµ‚æ­¢æœƒé€ æˆé¡å¤–çš„ç¶­é‹æˆæœ¬ï¼Œä¾‹å¦‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç®¡ç†å¤šå€‹ç¯€é»ï¼Œå®¹å¿å…ˆå è™›æ“¬æ©Ÿçš„ç§»é™¤ï¼Œè‡ªå‹•è£œå……æ–°çš„å…ˆå è™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003cli\u003eç®¡ç†å¤šå€‹æ‡‰ç”¨è¤‡æœ¬ï¼Œç¯€é»çµ‚æ­¢æ™‚ï¼Œç¶­è­·æ•´é«”æ‡‰ç”¨çš„å¯ç”¨æ€§\u003c/li\u003e\n\u003cli\u003eå°‡ç§»é™¤ç¯€é»ä¸Šçš„æ‡‰ç”¨ï¼Œé‡æ–°æ’ç¨‹åˆ°å…¶ä»–å¯ç”¨ç¯€é»\u003c/li\u003e\n\u003cli\u003eå‹•æ…‹ç¶­è­·æ‡‰ç”¨è¤‡æœ¬çš„æœå‹™ç™¼ç¾ (Service Discovery) èˆ‡æœå‹™ç«¯é» (Endpoints)\n\u003cul\u003e\n\u003cli\u003eæ„æ€æ˜¯æ‡‰ç”¨é—œé–‰é‡å•Ÿå¾Œï¼Œæ›äº†ä¸€å€‹æ–° IPï¼Œé‚„è¦èƒ½æŒçºŒå­˜å–æ‡‰ç”¨ã€‚èˆŠçš„ IP è¦ä¸»å‹•å¤±æ•ˆ\u003c/li\u003e\n\u003cli\u003eé…åˆæ‡‰ç”¨çš„å¥åº·æª¢æŸ¥ (Health Check) èˆ‡å¯ç”¨æª¢æŸ¥ (Readiness Check)ï¼Œå†åˆ†é…ç¶²è·¯æµé‡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé€™äº›éœ€æ±‚ï¼Œå¿…é ˆè¦æœ‰è‡ªå‹•åŒ–çš„ç®¡ç†å·¥å…·ï¼Œæ˜¯ä¸å¯èƒ½äººå·¥ç®¡ç†çš„ï¼Œæƒ³åƒä½ æ‰‹ä¸Šä½¿ç”¨ 100 å€‹å…ˆå ç¯€é»ï¼Œå¹³å‡æ¯å¤©æœƒæœ‰ 10% - 15% çš„å…ˆå ç¯€é»è¢«è³‡æ–™ä¸­å¿ƒå›æ”¶ï¼Œç¶­é‹éœ€è¦\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè£œè¶³è¢«ç§»é™¤çš„ 15 å€‹ç¯€é»\u003c/li\u003e\n\u003cli\u003eè¨ˆç®—è¢«ç§»é™¤çš„æ‡‰ç”¨ï¼Œè£œè¶³ç§»é™¤çš„æ‡‰ç”¨æ•¸é‡\u003c/li\u003e\n\u003cli\u003eç§»é™¤å¤±æ•ˆçš„æ‡‰ç”¨ç«¯é»ï¼Œè£œä¸Šæ–°çš„æ‡‰ç”¨ç«¯é»\u003c/li\u003e\n\u003cli\u003eæŒçºŒç›£æ§æ‡‰ç”¨ç‹€æ…‹\u003c/li\u003e\n\u003cli\u003e\u0026hellip;\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ²’æœ‰è‡ªå‹•åŒ–ç®¡ç†å·¥å…·ï¼Œçœ‹äº†å¿ƒå·²ç´¯ (è²“çˆªæ©é¢)\u003c/p\u003e\n\u003cp\u003eæˆ‘å€‘ä½¿ç”¨ Kubernetes å”åŠ©ç¶­é‹è‡ªå‹•åŒ–ï¼Œåœ¨ GCP ä¸Šæˆ‘å€‘ä½¿ç”¨ GKEï¼Œé™¤äº†ä¸Šè¿°æåˆ°çš„å®¹å™¨æ‡‰ç”¨ç®¡ç†è‡ªå‹•åŒ–å¤–ï¼ŒGKE é‚„é¡å¤–æ•´åˆå…ˆå è™›æ“¬æ©Ÿçš„ä½¿ç”¨\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå•Ÿç”¨å…ˆå è™›æ“¬æ©Ÿçš„ç¯€é»æ±  (node-pool)ï¼Œè¨­å®šç¯€é»æ± çš„è‡ªå‹•æ‹“å±•ï¼Œè‡ªå‹•è£œè¶³å…ˆå ç¯€é»çš„æ•¸é‡\u003c/li\u003e\n\u003cli\u003eGKE è‡ªå‹•ç¶­è­·å…ˆå è™›æ“¬æ©Ÿçš„ labels\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé—œæ–¼ GKE çš„å…ˆå è™›æ“¬æ©Ÿçš„å®Œæ•´ç´°ç¯€ï¼Œè«‹è¦‹\u003ca href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/preemptible-vms\"\u003eGCP å®˜æ–¹æ–‡ä»¶\u003c/a\u003eã€‚é€™ä»½æ–‡ä»¶åº•ä¸‹ä¹Ÿæä¾›äº† GCP å®˜æ–¹å»ºè­°çš„å…ˆå è™›æ“¬æ©Ÿæœ€ä½³å¯¦è¸\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¶æ§‹è¨­è¨ˆéœ€è¦å‡è¨­ï¼Œéƒ¨åˆ†æˆ–æ˜¯å…¨éƒ¨çš„å…ˆå è™›æ“¬æ©Ÿéƒ½ä¸å¯ç”¨çš„æƒ…å½¢\u003c/li\u003e\n\u003cli\u003ePod ä¸ä¸€å®šæœ‰æ™‚é–“èƒ½å„ªé›…çµ‚æ­¢ (graceful shutdown)\u003c/li\u003e\n\u003cli\u003eåŒæ™‚ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿèˆ‡å…ˆå è™›æ“¬æ©Ÿï¼Œä»¥ç¶­æŒå…ˆå è™›æ“¬æ©Ÿä¸å¯ç”¨æ™‚ï¼Œæœå‹™ä¾ç„¶å¯ç”¨\u003c/li\u003e\n\u003cli\u003eæ³¨æ„ç¯€é»æ›¿æ›æ™‚çš„ IP è®Šæ›´\u003c/li\u003e\n\u003cli\u003eé¿å…ä½¿ç”¨æœ‰ç‹€æ…‹çš„ Pod åœ¨å…ˆå è™›æ“¬æ©Ÿä¸Š (é€™é»ç¨å¾Œçš„æ–‡ç« ï¼Œæˆ‘å€‘æœƒè©¦åœ–è¶…è¶Š)\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨ node taint ä¾†å”åŠ©æ’ç¨‹åˆ°å…ˆå è™›æ“¬æ©Ÿï¼Œèˆ‡éå…ˆå è™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç¸½ä¹‹ï¼Œç”±æ–¼æœ‰å®¹å™¨è‡ªå‹•åŒ–ç®¡ç†ï¼Œæˆ‘å€‘æ‰èƒ½è¼•æ˜“çš„ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿã€‚\u003c/p\u003e","title":"Gcp Preemptible Instance Kubernetes"},{"content":"å…ˆå è™›æ“¬æ©Ÿï¼ŒæŠ€è¡“æ–‡ä»¶äºŒä¸‰äº‹ ç¬¬ä¸€ç¯‡çš„å…§å®¹å¤§éƒ¨ä»½é‚„æ˜¯ç¿»è­¯è·Ÿè¬›è§£å®˜æ–¹æ–‡ä»¶ã€‚å¾Œé¢å¹¾ç¯‡æ‰æœƒæœ‰å¯¦éš›çš„éœ€æ±‚èˆ‡è§£æ±ºæ–¹æ¡ˆåˆ†æã€‚\nGoogle å…ˆå è™›æ“¬æ©Ÿå®˜æ–¹æ–‡ä»¶\nä½¿ç”¨ä¸ç†Ÿæ‚‰çš„ç”¢å“å‰ä¸€å®šè¦å¥½å¥½çœ‹æ–‡ä»¶ï¼Œæ‰ä¸æœƒè¸©åˆ°é›·çš„æ™‚å€™ï¼Œç™¼ç¾äººå®¶å°±æ˜¯é€™æ¨£è¨­è¨ˆçš„ï¼Œè€Œä¸”æ–‡ä»¶ä¸Šå¯«å¾—æ¸…æ¸…æ¥šæ¥šã€‚ä»¥ç‚ºæ˜¯ bug çµæœçœŸçš„æ˜¯ featureï¼Œé›·åˆ°è‡ªå·±ã€‚å…ˆå è™›æ“¬æ©Ÿæ˜¯ç”¨èµ·ä¾†è·Ÿæ™®é€šè™›æ“¬æ©Ÿæ²’ä»€éº¼å…©æ¨£ï¼Œä½†å¯¦éš›ä¸Šè¶…ç´šå¤šç´°ç¯€è¦æ³¨æ„ï¼Œæ¯›å¾ˆå¤šçš„ç”¢å“ï¼Œè«‹å‹™å¿…è¦å°å¿ƒä½¿ç”¨ã€‚\nä»¥ä¸‹æ–‡ç« æ˜¯ç­†è€…å·¥ä½œç¶“é©—ï¼Œè¦ºå¾—å¥½ç”¨ã€ç¢ºå¯¦æœ‰å¹«åŠ©å…¬å¸ï¼Œä¾†è·Ÿå¤§å®¶åˆ†äº«ã€‚ç¤™æ–¼ç¯‡å¹…ï¼Œé€™è£¡åªèƒ½éå¸¸ç²—ç•¥åœ°æè¿°æˆ‘å€‘åœ˜éšŠæ€è€ƒéçš„å•é¡Œï¼Œå¯¦éš›ä¸Šçš„å•é¡Œæœƒè¤‡é›œéå¸¸å¤šã€‚æ–‡ç« åªæ˜¯ä½œå€‹ç™¼æƒ³ï¼Œä¸¦ä¸è¶³ä»¥æ”¯æ’å¯¦éš›çš„æ¥­å‹™ï¼Œæ‰€ä»¥å¦‚æœè¦è€ƒæ…®å°å…¥ï¼Œé‚„æ˜¯è¦\nå¤šä½œåŠŸèª²ï¼Œä»”ç´°æŸ¥é–±å®˜æ–¹æ–‡ä»¶ï¼Œç†è§£æœå‹™çš„è¦æ ¼ æ·±å…¥åˆ†æè‡ªèº«çš„éœ€æ±‚ åŸºæ–¼ä¸Šé¢å…©è€…ï¼Œé‡åŒ–åˆ†æ ä»€éº¼æ˜¯å…ˆå è™›æ“¬æ©Ÿå™¨(Preemptible Instance) å…ˆå è™›æ“¬æ©Ÿå™¨ï¼Œæ˜¯è³‡æ–™ä¸­å¿ƒçš„å¤šé¤˜ç®—åŠ›ï¼Œè®€è€…å¯ä»¥æƒ³åƒæ˜¯ç›®å‰è³£å‰©çš„æ©Ÿå™¨ï¼Œæœƒä¾æ“šè³‡æ–™ä¸­å¿ƒçš„éœ€æ±‚å‹•æ…‹èª¿æ•´ï¼Œä¾‹å¦‚\nç›®å‰è³‡æ–™ä¸­å¿ƒçš„ç®—åŠ›éœ€æ±‚ä½ï¼Œå¯ä½¿ç”¨çš„å…ˆå è™›æ“¬æ©Ÿé‡‹å‡ºé‡å¤šï¼Œå¯èƒ½å¯ä»¥ç”¨æ›´ä¾¿å®œçš„åƒ¹æ ¼ä½¿ç”¨ ç›®å‰è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚é«˜ï¼Œè³‡æ–™ä¸­å¿ƒæœƒæ”¶å›éƒ¨åˆ†å…ˆå è™›æ“¬æ©Ÿçš„é¡åº¦ï¼Œè½‰åŒ–æˆéš¨é¸ä»˜è²»çš„è™›æ“¬æ©Ÿ (pay-as-you-go) ç”±æ–¼å…ˆå è™›æ“¬æ©Ÿæœƒä¸å®šæ™‚ï¼ˆä½†å¯é æœŸï¼‰åœ°è¢«è³‡æ–™ä¸­å¿ƒæ”¶å›ï¼Œå› æ­¤ä¸Šé ­åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œéœ€è¦å¯ä»¥æ‰¿å—æ©Ÿå™¨çš„çµ‚æ­¢ï¼Œé©åˆæœ‰å®¹éŒ¯æ©Ÿåˆ¶ (fault-tolerant) çš„æ‡‰ç”¨ï¼Œæˆ–æ˜¯æ‰¹æ¬¡åŸ·è¡Œçš„å·¥ä½œä¹Ÿå¾ˆé©åˆã€‚\nå…ˆå æ©Ÿå™¨çš„å„ªç¼ºé» é™¤äº†æœ‰ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿçš„ç‰¹æ€§ï¼Œå…ˆå è™›æ“¬æ©Ÿé‚„æœ‰ä»¥ä¸‹ç‰¹é»\næ¯”ä¸€èˆ¬çš„è™›æ“¬æ©Ÿå™¨ä¾¿å®œéå¸¸å¤šï¼Œé€™ä¹Ÿæ˜¯æˆ‘å€‘é¸ç”¨å…ˆå è™›æ“¬æ©Ÿå„ªæ–¼ä¸€èˆ¬è™›æ“¬æ©Ÿçš„å”¯ä¸€ç†ç”± å…ˆå è™›æ“¬æ©Ÿæœ‰ä»¥ä¸‹é™åˆ¶ï¼Œä»¥ç¶­é‹çš„è§’åº¦ï¼Œé€™äº›éƒ½æ˜¯éœ€è¦è€ƒé‡çš„é»ã€‚\nGCP ä¸ä¿è­‰æœƒæœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿä¸èƒ½ç›´æ¥è½‰æ›æˆæ™®é€šè™›æ“¬æ©Ÿ è³‡æ–™ä¸­å¿ƒè§¸ç™¼ç¶­è­·äº‹ä»¶æ™‚(ex. å›æ”¶å…ˆå è™›æ“¬æ©Ÿ)ï¼Œå…ˆå è™›æ“¬æ©Ÿä¸èƒ½è¨­å®šè‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒç›´æ¥é—œé–‰ å…ˆå æ©Ÿå™¨æ’é™¤åœ¨ GCP çš„æœå‹™ç­‰ç´šå”è­° (SLA)ä¹‹å¤– å…ˆå è™›æ“¬æ©Ÿä¸é©ç”¨GCP å…è²»é¡åº¦ è²»ç”¨ç²—ä¼°è©¦ç®— è‡³æ–¼ä¾¿å®œæ˜¯å¤šä¾¿å®œå‘¢ï¼Ÿé€™é‚Šå…ˆé–‹å¹¾å€‹ä¾‹å­çµ¦å„ä½ä¸€äº›æ¦‚å¿µã€‚\nä»¥å¸¸ç”¨çš„ N1 standard è™›æ“¬æ©Ÿï¼šhttps://cloud.google.com/compute/vm-instance-pricing#n1_standard_machine_types\nHourly Machine type\tCPUs\tMemory\tPrice (USD)\tPreemptible price (USD) n1-standard-1\t1\t3.75GB\t$0.0550\t$0.0110 n1-standard-2\t2\t7.5GB\t$0.1100\t$0.0220 n1-standard-4\t4\t15GB\t$0.2200\t$0.0440 n1-standard-8\t8\t30GB\t$0.4400\t$0.0880 n1-standard-16\t16\t60GB\t$0.8800\t$0.1760 n1-standard-32\t32\t120GB\t$1.7600\t$0.3520 n1-standard-64\t64\t240GB\t$3.5200\t$0.7040\nå¦‚æœæ˜¯ç”¨ GPU é‹ç®—ï¼šhttps://cloud.google.com/compute/gpus-pricing\nModel\tGPUs\tGPU memory\tGPU price (USD)\tPreemptible GPU price (USD) NVIDIAÂ® TeslaÂ® T4\t1 GPU\t16 GB GDDR6\t$0.35 per GPU\t$0.11 per GPU NVIDIAÂ® TeslaÂ® V100\t1 GPU\t16 GB HBM2\t$2.48 per GPU\t$0.74 per GPU\nä¾æ“šè™›æ“¬æ©Ÿè¦æ ¼çš„ä¸åŒï¼Œå…ˆå è™›æ“¬æ©Ÿå¤§ç´„æ˜¯éš¨é¸è™›æ“¬æ©Ÿåƒ¹æ ¼çš„ 2 åˆ° 3 æŠ˜ã€‚åœ¨ AWS èˆ‡ Azureï¼Œç”±æ–¼è¨ˆè²»æ–¹å¼ä¸åŒï¼Œæœ‰å¯èƒ½æ‹¿åˆ° 1 æŠ˜å·¦å³çš„æµ®å‹•åƒ¹æ ¼ã€‚å¾å„ç¨®è§’åº¦ä¾†èªªï¼Œéƒ½æ˜¯éå¸¸é«˜çš„æŠ˜æ•¸ã€‚\nä¸å¦¨èªªï¼Œé€™æ•´ç³»åˆ—æ–‡ç« ï¼Œéƒ½æ˜¯è¡é€™è‘—å€‹æŠ˜æ•¸ä¾†çš„ XDã€‚ç•¢ç«Ÿæˆæœ¬æ˜¯å¯¦å¯¦åœ¨åœ¨çš„èŠ±è²»ï¼Œå·¥ä½œè² è¼‰ (workload) åˆé©çš„è©±ï¼Œæ‡‰è©²ç›¡é‡å˜—è©¦å°å…¥ã€‚\né€™å€‹æŠ˜æ•¸é‚„æœ‰å¦å¤–ä¸€å€‹æ•ˆæœæ˜¯ï¼Œå¯ä»¥åœ¨ç›¸åŒæˆæœ¬ä¸‹ï¼Œæ·»å¢æ›´å¤šè³‡æºç®—åŠ›ï¼Œä½œç‚ºè§£æ±ºæ–¹æ¡ˆã€‚ä»€éº¼æ„æ€å‘¢ï¼Ÿå°±æ˜¯å¦‚æœå·¥ä½œè² è¼‰åˆé©çš„è©±ï¼Œå¯ä»¥ä½¿ç”¨æ›´é«˜è¦æ ¼çš„å…ˆå ç¯€é»ï¼Œæ•´é«”æˆæœ¬åè€Œæœƒä¸‹é™ã€‚\nè‡³æ–¼ç©¶ç«Ÿå·®å¤šå°‘ï¼Œéœ€è¦ä¾æ“šè¦æ ¼èˆ‡å®šåƒ¹è©³ç´°è©¦ç®—æ‰çŸ¥é“ã€‚åº•ä¸‹æˆ‘å€‘å°±ä¾†ç®—ç®—çœ‹ã€‚\n","permalink":"https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-introduction/","summary":"\u003ch1 id=\"å…ˆå è™›æ“¬æ©ŸæŠ€è¡“æ–‡ä»¶äºŒä¸‰äº‹\"\u003eå…ˆå è™›æ“¬æ©Ÿï¼ŒæŠ€è¡“æ–‡ä»¶äºŒä¸‰äº‹\u003c/h1\u003e\n\u003cp\u003eç¬¬ä¸€ç¯‡çš„å…§å®¹å¤§éƒ¨ä»½é‚„æ˜¯ç¿»è­¯è·Ÿè¬›è§£å®˜æ–¹æ–‡ä»¶ã€‚å¾Œé¢å¹¾ç¯‡æ‰æœƒæœ‰å¯¦éš›çš„éœ€æ±‚èˆ‡è§£æ±ºæ–¹æ¡ˆåˆ†æã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://cloud.google.com/compute/docs/instances/preemptible\"\u003eGoogle å…ˆå è™›æ“¬æ©Ÿå®˜æ–¹æ–‡ä»¶\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨ä¸ç†Ÿæ‚‰çš„ç”¢å“å‰ä¸€å®šè¦å¥½å¥½çœ‹æ–‡ä»¶ï¼Œæ‰ä¸æœƒè¸©åˆ°é›·çš„æ™‚å€™ï¼Œç™¼ç¾äººå®¶å°±æ˜¯é€™æ¨£è¨­è¨ˆçš„ï¼Œè€Œä¸”æ–‡ä»¶ä¸Šå¯«å¾—æ¸…æ¸…æ¥šæ¥šã€‚ä»¥ç‚ºæ˜¯ bug çµæœçœŸçš„æ˜¯ featureï¼Œé›·åˆ°è‡ªå·±ã€‚å…ˆå è™›æ“¬æ©Ÿæ˜¯ç”¨èµ·ä¾†è·Ÿæ™®é€šè™›æ“¬æ©Ÿæ²’ä»€éº¼å…©æ¨£ï¼Œä½†å¯¦éš›ä¸Šè¶…ç´šå¤šç´°ç¯€è¦æ³¨æ„ï¼Œæ¯›å¾ˆå¤šçš„ç”¢å“ï¼Œè«‹å‹™å¿…è¦å°å¿ƒä½¿ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹æ–‡ç« æ˜¯ç­†è€…å·¥ä½œç¶“é©—ï¼Œè¦ºå¾—å¥½ç”¨ã€ç¢ºå¯¦æœ‰å¹«åŠ©å…¬å¸ï¼Œä¾†è·Ÿå¤§å®¶åˆ†äº«ã€‚ç¤™æ–¼ç¯‡å¹…ï¼Œé€™è£¡åªèƒ½éå¸¸ç²—ç•¥åœ°æè¿°æˆ‘å€‘åœ˜éšŠæ€è€ƒéçš„å•é¡Œï¼Œå¯¦éš›ä¸Šçš„å•é¡Œæœƒè¤‡é›œéå¸¸å¤šã€‚æ–‡ç« åªæ˜¯ä½œå€‹ç™¼æƒ³ï¼Œä¸¦ä¸è¶³ä»¥æ”¯æ’å¯¦éš›çš„æ¥­å‹™ï¼Œæ‰€ä»¥å¦‚æœè¦è€ƒæ…®å°å…¥ï¼Œé‚„æ˜¯è¦\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå¤šä½œåŠŸèª²ï¼Œä»”ç´°æŸ¥é–±å®˜æ–¹æ–‡ä»¶ï¼Œç†è§£æœå‹™çš„è¦æ ¼\u003c/li\u003e\n\u003cli\u003eæ·±å…¥åˆ†æè‡ªèº«çš„éœ€æ±‚\u003c/li\u003e\n\u003cli\u003eåŸºæ–¼ä¸Šé¢å…©è€…ï¼Œé‡åŒ–åˆ†æ\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"ä»€éº¼æ˜¯å…ˆå è™›æ“¬æ©Ÿå™¨preemptible-instance\"\u003eä»€éº¼æ˜¯å…ˆå è™›æ“¬æ©Ÿå™¨(Preemptible Instance)\u003c/h1\u003e\n\u003cp\u003eå…ˆå è™›æ“¬æ©Ÿå™¨ï¼Œæ˜¯è³‡æ–™ä¸­å¿ƒçš„å¤šé¤˜ç®—åŠ›ï¼Œè®€è€…å¯ä»¥æƒ³åƒæ˜¯ç›®å‰è³£å‰©çš„æ©Ÿå™¨ï¼Œæœƒä¾æ“šè³‡æ–™ä¸­å¿ƒçš„éœ€æ±‚å‹•æ…‹èª¿æ•´ï¼Œä¾‹å¦‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç›®å‰è³‡æ–™ä¸­å¿ƒçš„ç®—åŠ›éœ€æ±‚ä½ï¼Œå¯ä½¿ç”¨çš„å…ˆå è™›æ“¬æ©Ÿé‡‹å‡ºé‡å¤šï¼Œå¯èƒ½å¯ä»¥ç”¨æ›´ä¾¿å®œçš„åƒ¹æ ¼ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eç›®å‰è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚é«˜ï¼Œè³‡æ–™ä¸­å¿ƒæœƒæ”¶å›éƒ¨åˆ†å…ˆå è™›æ“¬æ©Ÿçš„é¡åº¦ï¼Œè½‰åŒ–æˆéš¨é¸ä»˜è²»çš„è™›æ“¬æ©Ÿ (pay-as-you-go)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼å…ˆå è™›æ“¬æ©Ÿæœƒä¸å®šæ™‚ï¼ˆä½†å¯é æœŸï¼‰åœ°è¢«è³‡æ–™ä¸­å¿ƒæ”¶å›ï¼Œå› æ­¤ä¸Šé ­åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œéœ€è¦å¯ä»¥æ‰¿å—æ©Ÿå™¨çš„çµ‚æ­¢ï¼Œé©åˆæœ‰å®¹éŒ¯æ©Ÿåˆ¶ (fault-tolerant) çš„æ‡‰ç”¨ï¼Œæˆ–æ˜¯æ‰¹æ¬¡åŸ·è¡Œçš„å·¥ä½œä¹Ÿå¾ˆé©åˆã€‚\u003c/p\u003e\n\u003ch1 id=\"å…ˆå æ©Ÿå™¨çš„å„ªç¼ºé»\"\u003eå…ˆå æ©Ÿå™¨çš„å„ªç¼ºé»\u003c/h1\u003e\n\u003cp\u003eé™¤äº†æœ‰ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿçš„ç‰¹æ€§ï¼Œå…ˆå è™›æ“¬æ©Ÿé‚„æœ‰ä»¥ä¸‹ç‰¹é»\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¯”ä¸€èˆ¬çš„è™›æ“¬æ©Ÿå™¨ä¾¿å®œéå¸¸å¤šï¼Œé€™ä¹Ÿæ˜¯æˆ‘å€‘é¸ç”¨å…ˆå è™›æ“¬æ©Ÿå„ªæ–¼ä¸€èˆ¬è™›æ“¬æ©Ÿçš„å”¯ä¸€ç†ç”±\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå…ˆå è™›æ“¬æ©Ÿæœ‰ä»¥ä¸‹é™åˆ¶ï¼Œä»¥ç¶­é‹çš„è§’åº¦ï¼Œé€™äº›éƒ½æ˜¯éœ€è¦è€ƒé‡çš„é»ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eGCP ä¸ä¿è­‰æœƒæœ‰è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003cli\u003eå…ˆå è™›æ“¬æ©Ÿä¸èƒ½ç›´æ¥è½‰æ›æˆæ™®é€šè™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003cli\u003eè³‡æ–™ä¸­å¿ƒè§¸ç™¼ç¶­è­·äº‹ä»¶æ™‚(ex. å›æ”¶å…ˆå è™›æ“¬æ©Ÿ)ï¼Œå…ˆå è™›æ“¬æ©Ÿä¸èƒ½è¨­å®šè‡ªå‹•é‡å•Ÿï¼Œè€Œæ˜¯æœƒç›´æ¥é—œé–‰\u003c/li\u003e\n\u003cli\u003eå…ˆå æ©Ÿå™¨æ’é™¤åœ¨ \u003ca href=\"https://cloud.google.com/compute/sla\"\u003eGCP çš„æœå‹™ç­‰ç´šå”è­° (SLA)\u003c/a\u003eä¹‹å¤–\u003c/li\u003e\n\u003cli\u003eå…ˆå è™›æ“¬æ©Ÿä¸é©ç”¨\u003ca href=\"https://cloud.google.com/free\"\u003eGCP å…è²»é¡åº¦\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"è²»ç”¨ç²—ä¼°è©¦ç®—\"\u003eè²»ç”¨ç²—ä¼°è©¦ç®—\u003c/h1\u003e\n\u003cp\u003eè‡³æ–¼ä¾¿å®œæ˜¯å¤šä¾¿å®œå‘¢ï¼Ÿé€™é‚Šå…ˆé–‹å¹¾å€‹ä¾‹å­çµ¦å„ä½ä¸€äº›æ¦‚å¿µã€‚\u003c/p\u003e\n\u003cp\u003eä»¥å¸¸ç”¨çš„ N1 standard è™›æ“¬æ©Ÿï¼šhttps://cloud.google.com/compute/vm-instance-pricing#n1_standard_machine_types\u003c/p\u003e\n\u003cp\u003eHourly\nMachine type\tCPUs\tMemory\tPrice (USD)\tPreemptible price (USD)\nn1-standard-1\t1\t3.75GB\t$0.0550\t\t$0.0110\nn1-standard-2\t2\t7.5GB\t$0.1100\t\t$0.0220\nn1-standard-4\t4\t15GB\t$0.2200\t\t$0.0440\nn1-standard-8\t8\t30GB\t$0.4400\t\t$0.0880\nn1-standard-16\t16\t60GB\t$0.8800\t\t$0.1760\nn1-standard-32\t32\t120GB\t$1.7600\t\t$0.3520\nn1-standard-64\t64\t240GB\t$3.5200\t\t$0.7040\u003c/p\u003e","title":"Gcp Preemptible Instance Introduction"},{"content":"é—œæ–¼è³‡æºè©•ä¼° æ¶æ§‹åœ˜éšŠæä¾›è™›æ“¬æ©Ÿçµ¦æ‡‰ç”¨ï¼Œæœ‰å€‹å•é¡Œæ™‚å¸¸å‡ºç¾ï¼šæ‡‰è©²åˆ†é…å¤šå°‘è³‡æºçµ¦æ‡‰ç”¨ï¼Ÿä¾‹å¦‚ï¼šå¾Œç«¯æº–å‚™ä¸€å€‹ API serverï¼ŒSRE é€™é‚Šè¦æº–å‚™å¤šå°‘ä»€éº¼è¦æ ¼çš„æ©Ÿå™¨ï¼Ÿ\nä»¥å¾€ä½¿ç”¨è™›æ“¬æ©Ÿç›´æ¥éƒ¨ç½²æ‡‰ç”¨æ™‚ï¼Œæœƒéœ€è¦æ˜ç¢ºè¦åŠƒå„ç¾¤è™›æ“¬æ©Ÿï¼Œå„è‡ªéœ€è¦åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œå¦‚æœæ²’æœ‰åšè³‡æºçš„äº‹å‰è©•ä¼°ï¼Œæœ‰å¯èƒ½æ”¾ä¸Šæ©Ÿå™¨é‹è¡Œå¾Œå°±ç™¼ç”Ÿè³‡æºä¸è¶³ã€‚\nå°å…¥ Kubernetes å¾Œï¼Œé€éç¯€é»æ±  (Node Pool) å½¢æˆä¸€å€‹å¤§å‹è³‡æºæ± ï¼Œè¨­å®šéƒ¨ç½²çš„æ”¿ç­–å¾Œï¼Œè®“ Kubernetes è‡ªå‹•èª¿åº¦æ‡‰ç”¨ï¼š\næ¯ä¸€å€‹ç¯€é»çš„è³‡æºå¤ å¤§ï¼Œä½¿å¾—æ‡‰ç”¨è™›æ“¬æ©Ÿå™¨ä¸Šæ‰€ä½”çš„æ¯”ä¾‹ç›¸å°è¼ƒå°ï¼Œä¹Ÿå°±æ˜¯å–®ä¸€æ‡‰ç”¨çš„èª¿åº¦ä¸æœƒå½±éŸ¿ç¯€é»çš„æ•´é«”è² è¼‰ å¦‚æœç¯€é»å¤ªå°ï¼Œèª¿åº¦æ‡‰ç”¨å°±æœƒæœ‰äº›ä¾·ä¿ƒï¼Œä¾‹å¦‚ï¼šä¸€å€‹ API server å‡è¼‰æ™‚æ¶ˆè€— 1 cpu æ»¿è¼‰æ™‚æ¶ˆè€— 2 cpuã€‚æº–å‚™ 3 cpu çš„è™›æ“¬æ©Ÿï¼Œèª¿åº¦æ‡‰ç”¨æ™‚å¹¾ä¹æ˜¯é·ç§»æ•´å°è™›æ“¬æ©Ÿçš„è² è¼‰ æ­¤å¤–é‚„æœ‰æ©Ÿæœƒå› ç‚ºä¸Šç¯‡æåˆ°çš„è³‡æºä¿ç•™ï¼Œé€ æˆèª¿åº¦å¤±æ•—ã€‚å¦‚æœæº–å‚™ 24 cpu çš„æ©Ÿå™¨ï¼Œèª¿åº¦èµ·ä¾†å½ˆæ€§å°±å¾ˆå¤§ï¼Œå°ç¯€é»çš„æ€§èƒ½è¡æ“Šä¹Ÿæ¯”è¼ƒä½ åªéœ€è¦ä¼°è¨ˆæ•´é«”çš„è³‡æºæ¶ˆè€—ç‡è¨ˆç®—éœ€æ±‚ï¼Œé…åˆè‡ªå‹•æ“´å±•ï¼Œå‹•æ…‹å™¨è£œè¶³ä¸è¶³çš„è³‡æº ä¾‹å¦‚ï¼šä¼°è¨ˆç¸½å…±éœ€è¦ 32 cpu ï¼Œæº–å‚™ 36 cpu çš„è™›æ“¬æ©Ÿï¼Œç•¶æ»¿è¼‰æ™‚ä¾æ“š cpu å£“åŠ›è‡ªå‹•æ“´å®¹åˆ° 48 cpu å¸Œæœ›æ•´é«”è³‡æºçš„ä½¿ç”¨ç‡å¤ é«˜ï¼Œç•¶ç„¶é ç•™å¤ªå¤šçš„è³‡æºæœƒé€ æˆæµªè²» è¦æ§ç®¡ Kubernetes çš„è³‡æºä½¿ç”¨é‡ä¹Ÿå¯è¨­å®šè³‡æºéœ€æ±‚èˆ‡è³‡æºé™åˆ¶ï¼Œå»¶ä¼¸é–±è®€ã€‚\nä¼°è¨ˆå¾—è¶Šæº–ç¢ºï¼Œç•¶ç„¶å¯¦éš›éƒ¨ç½²çš„è³‡æºæŒæ¡åº¦å°±è¶Šé«˜ï¼Œç„¶è€Œç­†è€…éå»çš„ç¶“é©—ï¼Œåœ˜éšŠåœ¨äº¤ä»˜æºç¢¼æ™‚æœªå¿…å°±èƒ½å¤ åšå‡ºæœ‰æ•ˆçš„è³‡æºæ¶ˆè€—è©•ä¼°ï¼Œé‚£æœ‰æ²’æœ‰ä»€éº¼è¾¦æ³•å¯ä»¥å¹«åŠ©æˆ‘å€‘ï¼Ÿ\nè³‡æºéœ€æ±‚ä¼°ä¼°çœ‹ å¦‚æœæ‡‰ç”¨é–‹ç™¼åœ˜éšŠï¼Œæœ‰å…ˆä½œæ‡‰ç”¨çš„ profilingï¼Œç„¶å¾Œ release candidate ç‰ˆæœ¬æœ‰åœ¨ staging ä¸Šä½œå£“åŠ›æ¸¬è©¦çš„è©±ï¼Œç¶­é‹åœ˜éšŠé€™é‚Šæ‡‰è©²å°±å–å¾—çš„æ•¸æ“šï¼Œåšéƒ¨ç½²å‰çš„è³‡æºè©•ä¼°ã€‚\næ‡‰ç”¨åœ¨ä¸åŒç‹€æ…‹æˆ–æ˜¯å·¥ä½œéšæ®µï¼Œæœƒæ¶ˆè€—ä¸åŒçš„è³‡æº\nä¾‹å¦‚ï¼šé‹ç®—å¯†é›†çš„ batch job å¯èƒ½æœƒæœ‰\næ§åˆ¶ç¯€é» (master node) å•Ÿå‹•å¾Œæœƒä½”æœ‰ä¸€å®šçš„è³‡æºï¼Œä¸€èˆ¬ä¾†èªªä¸æœƒæ¶ˆè€—å¤ªå¤šï¼Œåªæ˜¯éœ€è¦ç‚ºæ§åˆ¶ç¯€é»å„ªå…ˆä¿ç•™è³‡æº å·¥ä½œç¯€é» (worker node) å•Ÿå‹•æ™‚æœƒéœ€è¦é ç•™è¶³å¤ çš„è³‡æºï¼Œæ¥æ”¶å·¥ä½œå¾Œæœƒé€æ¼¸å¢åŠ è³‡æºä½¿ç”¨ï¼Œæ‹‰åˆ°æ»¿è¼‰ ä¾‹å¦‚ï¼šé¢å‘ç”¨æˆ¶çš„æœå‹™ï¼Œå¯èƒ½æœƒæœ‰\nå•Ÿå‹•æ‡‰ç”¨æ‰€éœ€çš„è³‡æº æ²’æœ‰å¤§é‡è«‹æ±‚ï¼Œåªç¶­æŒåŸºæœ¬æ‡‰ç”¨é‹è¡Œæ‰€ä½¿ç”¨çš„è³‡æº è² è¼‰å£“åŠ›çŒé€²ä¾†æ™‚ï¼Œæ¶ˆè€—è³‡æºéš¨ç”¨æˆ¶è«‹æ±‚æ•¸é‡çš„æˆé•·æ›²ç·šï¼Œè¨­å®šçš„å®‰å…¨ä¸Šç•Œ å¦‚æœæ²’æœ‰é€™äº›æ•¸æ“šï¼Œå…¶å¯¦ç¶­é‹å¾ˆé›£äº‹å‰ä¼°è¨ˆè³‡æºï¼Œè®Šæˆè¦å¯¦éš›æ¨ä¸Šç·šå¾Œè¦‹æ‹›æ‹†æ‹›ï¼ŒåŸºæ–¼å¯¦éš›çš„è³‡æºæ¶ˆè€—å»åšè‡ªå‹•æ“´å®¹ï¼Œå…¶å¯¦æœ‰å¯èƒ½æœƒé€ æˆè³‡æºçš„æµªè²»ï¼Œå› æ­¤æˆ‘å»ºè­°å¦‚æœé–‹ç™¼åœ˜éšŠæ²’æœ‰ä½œ profilingï¼Œç¶­é‹åœ˜éšŠå¯ä»¥åœ¨å·¥ä½œæµç¨‹å…§ç°¡å–®åŠ ä¸€æ­¥ profilingï¼Œç›®å‰ä¸»æµèªè¨€éƒ½æœ‰æä¾›ç›¸é—œå·¥å…·ï¼Œç°¡å–®çš„åŸ·è¡Œå°±å¯ä»¥ç²å¾—å¾ˆå¤šè³‡è¨Šã€‚\nè‡³æ–¼å£“åŠ›æ¸¬è©¦ï¼Œä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨åŸºæœ¬çš„å·¥å…·(ä¾‹å¦‚ Artilery)ç°¡å–®æ•´åˆ°å·¥ä½œæµç¨‹ã€‚ç‰¹åˆ¥æ˜¯é¢å°å®¢æˆ¶çš„æ‡‰ç”¨ï¼Œå‹™å¿…è¦é€²è¡Œå£“åŠ›æ¸¬è©¦ã€‚\næœ‰äº†ä¸Šè¿°çš„è³‡æºéœ€æ±‚æ•¸æ“šï¼Œæ‰èƒ½äº‹å…ˆå®‰æ’æ©Ÿå™¨çš„è¦æ ¼ã€‚ä¾‹å¦‚\næ‡‰ç”¨æ˜¯é¢å°å®¢æˆ¶çš„ API server åŸºæœ¬è³‡æºæ˜¯ 200m cpu 1Gi memoryï¼Œé€™éƒ¨åˆ†ç›´æ¥å¯«é€² Kubernetes resource requestï¼Œåœ¨æ’ç¨‹æ™‚å°±å…ˆçµé»ä¸Šé ç•™ã€‚ è² è¼‰æ‹‰åˆ° 1,000 RPSï¼Œlatency 95% 20ms 99% 30msï¼Œé€™æ™‚çš„è³‡æºéœ€æ±‚çš„ä¸Šç•Œå¤§ç´„ 2 cpu 4 Gi memory è¶…é 1,000 RPS å°±æ‡‰è©²è¦é€éæ°´å¹³æ“´å±•å»å¢åŠ æ›´å¤š instamce å¦‚æœå–®è·‘é€™å€‹ API serverï¼Œå°±å¯ä»¥å®‰æ’ memory 8ï¼Œcpu 4 çš„ GKE node-poolï¼Œè®“è² è¼‰è½åœ¨å¯ç”¨è³‡æºçš„ 60%-70%ï¼Œé€™æ¨£é‚„æœ‰é¤˜è£•å¯ä»¥æ‰¿å—å¤§æµé‡ï¼Œçµ¦è‡ªå‹•æ°´å¹³æ“´å±•åšå‹•çš„æ™‚é–“ã€‚\nè³‡æºèª¿æ•´åƒè€ƒ ç•¶ç„¶é€™äº›æ•¸æ“šéƒ½å¯ä»¥ä¾ç…§æ™‚å¯¦éš›éœ€æ±‚èª¿æ•´ï¼Œè³‡æºè¦å£“ç¸®å¾—æ›´ç·Šæˆ–æ›´é¬†éƒ½æ˜¯å¯è¡Œçš„ã€‚\nå¦‚æœæ‡‰ç”¨æœ‰æ•´åˆåˆ†æå¾Œå°ï¼Œä¾‹å¦‚ Real-time Uer Monitoringã€æˆ–æ˜¯åŸºæœ¬çš„ Google Analyticsï¼Œéƒ½å¯ä»¥è§€å¯Ÿé€™äº›èª¿æ•´å¯¦éš›å°ç”¨æˆ¶å¸¶ä¾†çš„å½±éŸ¿ï¼Œç”¨æˆ¶è¡Œç‚ºæ”¹è®Šå°å…¬å¸ç‡Ÿæ”¶çš„å½±éŸ¿ï¼Œå…¨éƒ½å¯ä»¥é‡åŒ–ã€‚ä¾‹å¦‚\næ©Ÿå™¨è² è¼‰æ‹‰åˆ° 80%ï¼Œcpu çš„å£“åŠ›ï¼Œå°è‡´ API latency å¢åŠ åˆ° 95% 50ms 99% 100ms æ­¤æ™‚ç”¨æˆ¶å·²ç¶“å¾ˆæœ‰æ„Ÿäº†ï¼Œæœƒå°è‡´ 0.1% ç”¨æˆ¶è·³è½‰é›¢é–‹ è€Œé€™ 0.1% çš„ç”¨æˆ¶ï¼Œä»¥å¾€çš„å¹³å‡æ¶ˆè²»ï¼Œæ›ç®—æˆç‚ºå…¬å¸ç‡Ÿæ”¶ï¼Œæ˜¯ $1,000/month æŠŠæ©Ÿå™¨è² è¼‰å£“åˆ° 60%ï¼Œåªè¨ˆç®— cpu çš„æ•¸é‡çš„è©±ï¼Œéœ€è¦å¤šé–‹ 3 å° n1-standard-4 æ©Ÿå™¨ï¼Œå…±è¨ˆ $337.26/month æä¾›è€é—†åšåƒè€ƒï¼Œè€é—†å¯èƒ½æœƒè¶¨å‘åŠ é–‹æ©Ÿå™¨ ç•¶ç„¶ä¸Šé¢çš„ä¾‹å­éƒ½éå¸¸ç°¡åŒ–ï¼Œè®Šæˆåœ‹ä¸­æ•¸å­¸å•é¡Œï¼Œé€™é‚Šåªæ˜¯æä¾›ä¸€å€‹ä¼°ç®—çš„ä¾‹å­ã€‚ç¾å¯¦ä¸­çš„å•é¡Œéƒ½æœƒè¤‡é›œç™¾å€ï¼Œä¾‹å¦‚æ©Ÿå™¨è¦æ ¼æ‹‰ä¸Šå»å‡ºç¾æ–°çš„ç“¶é ¸ã€ä¾‹å¦‚ä¾è³´çš„æœå‹™ï¼Œmessage queueã€database å£“åŠ›ä¸Šå‡ï¼Œæˆ–æ˜¯å…¬å¸å…§éƒ¨å•é¡Œï¼Œå°±æ‹¿ä¸åˆ°é ç®—(è¡€æ·š SRE)ã€‚å¦‚æœè¦æ¸›å°‘æ©Ÿå™¨ï¼Œä¹Ÿå¯ä»¥åƒè€ƒï¼Œä¸€èˆ¬ä¾†èªªè½åˆ°é—œæ©Ÿå™¨çœéŒ¢çš„è©±ï¼Œè€é—†éƒ½æœƒæ¥å—çš„ XDã€‚\nå›åˆ°å…ˆå æ©Ÿå™¨ æ ¹æ“šä¸Šé¢çš„åœ‹ä¸­æ•¸å­¸ï¼ŒæŠŠæ‡‰ç”¨ä¸€å€‹ä¸€å€‹éƒ½è¨ˆç®—æ¸…æ¥šï¼Œéœ€æ±‚é€æ¼¸æ˜ç¢ºäº†ã€‚å‡è¨­ï¼Œæ¶æ§‹åœ˜éšŠæ‹¿åˆ°é–‹æ©Ÿå™¨çš„å·¥å–®ï¼ŒææŒ‡ä¸€ç®—ï¼Œæ±ºå®š\n1 GKE cluster 6 n1-standard-4 é€™äº›éƒ½æ˜¯éš¨é¸è™›æ“¬æ©Ÿï¼Œåƒ¹æ ¼å¤§ç´„æ˜¯ $747/month (å«é›†ç¾¤ç®¡ç†è²» $73/month)ã€‚ä»Šå¤©æœ‰äººè…¦å‹•å¤§é–‹ï¼Œé‚£å¦‚æœå…¨éƒ¨æ›æˆå…ˆå ç¯€é»å‘¢ï¼Ÿè®Šæˆ $265/monthï¼Œè™›æ“¬æ©Ÿè²»ç”¨ $192 / $674 = 0.28 ç›´æ¥æ‰“è¶…éä¸‰æŠ˜ã€‚\næœ‰äººå°±æ“”å¿ƒï¼Œé€™æ¨£çœŸçš„å¯ä»¥å—ï¼ŸçœŸçš„æ²’å•é¡Œå—ï¼Ÿæœƒä¸æœƒå½±éŸ¿ç”¨æˆ¶é˜¿ã€‚\nç­”æ¡ˆæ˜¯æœƒï¼Œå°±æ˜¯æœƒå½±éŸ¿ç”¨æˆ¶ XD\nè½åˆ°é€™é‚Šå¾ˆå¤šäººå°±æ€•äº†ã€‚ä½†æ˜¯æ€éº¼å€‹å½±éŸ¿æ³•å‘¢ï¼Œé‚„éœ€è¦çœ‹åº•ä¸‹å¹¾å€‹æ®µè½ï¼Œå¦‚æœæ›æˆå…ˆå è™›æ“¬æ©Ÿï¼Œç”¨æˆ¶æœƒæ€éº¼å—åˆ°å½±éŸ¿ã€‚æˆ‘å€‘ä¹Ÿè¦è©¦åœ–é‡åŒ–é€™å€‹å½±éŸ¿ï¼Œç•¶ä½œè¦ä¸è¦å°å…¥çš„åˆ¤æ–·ä¾æ“šã€‚\nå¥å€‹åä¾‹ï¼Œã€Œæˆ‘è¦ºå¾—å¯ä»¥ã€ã€Œä½ è¦ºå¾—ä¸è¡Œã€ï¼Œæˆ–æ˜¯ã€ŒæŸæŸå…¬å¸çš„æŸæŸåœ˜éšŠå¯ä»¥å•Šã€ã€Œæˆ‘å€‘å…¬å¸ä¹Ÿä¾†åšå§ã€ï¼Œé€™äº›éƒ½æ˜¯å¾ˆç³Ÿç³•çš„ç†ç”±ã€‚é™¤äº†å°å…§éƒ¨æ¯«ç„¡èªªæœåŠ›ä¹‹å¤–ï¼Œä¹Ÿæ²’æœ‰è¾¦æ³•ä½œç‚ºå°å…¥æˆæ•ˆçš„æŒ‡æ¨™ï¼Œæœƒè®“åœ˜éšŠé™·å…¥ã€Œå°å…¥äº†ä¹Ÿä¸çŸ¥é“æœ‰æ¯”å°å…¥å‰å¥½ï¼Ÿã€æˆ–æ˜¯ã€Œå…·é«”å°å…¥å¾Œæˆæ•ˆé‡åŒ–ã€ï¼Œæœƒå½±éŸ¿åœ˜éšŠåšå‡ºçœŸæ­£æœ‰æ•ˆçš„åˆ¤æ–·ï¼Œæ‡‰æ¥µåŠ›é¿å…ã€‚\næ­¤å¤–ï¼Œå•è¡Œä¸è¡Œä¹‹å‰ï¼Œå…¶å¯¦éœ€è¦çŸ¥é“åœ˜éšŠé¡˜æ„ç‚ºäº†ä¸‰æŠ˜æ©Ÿå™¨ï¼Œä»˜å‡ºå¤šå°‘æˆæœ¬ã€‚å¦‚æœåªæ˜¯æ¯æœˆçœå€‹å°å¹£ 15,000ï¼Œå·¥ç¨‹å¸«è–ªæ°´éƒ½è¶…éäº†ã€‚ä½†å¦‚æœæ‰‹ä¸‹æœ‰ä¸‰åå°æˆ–ä¸‰ç™¾å°ä»¥ä¸Šï¼Œä¹Ÿè¨±å°±éå¸¸å€¼å¾—æŠ•è³‡ã€‚æˆæœ¬ä¸æ˜¯çµ•å°çš„ï¼Œå¾ˆå¤šæ™‚å€™è¦èˆ‡å…¶ä»–æˆæœ¬ (e.g. é–‹ç™¼äººåŠ›æ™‚é–“æˆæœ¬) ä¸€èµ·è€ƒé‡ã€‚\nä»¥ä¸Šéƒ½æ˜¯èªªæ˜å°å…¥çš„å‹•æ©Ÿï¼Œä»¥ä¸‹èªªæ˜å…ˆå è™›æ“¬æ©Ÿçš„å„ç¨®æ©Ÿåˆ¶ï¼Œä»¥åŠå°æ‡‰ç”¨çš„å¯¦éš›å½±éŸ¿ã€‚\n","permalink":"https://chechia.net/posts/2020-09-25-gcp-preemptible-instance-resource-calculation/","summary":"\u003ch3 id=\"é—œæ–¼è³‡æºè©•ä¼°\"\u003eé—œæ–¼è³‡æºè©•ä¼°\u003c/h3\u003e\n\u003cp\u003eæ¶æ§‹åœ˜éšŠæä¾›è™›æ“¬æ©Ÿçµ¦æ‡‰ç”¨ï¼Œæœ‰å€‹å•é¡Œæ™‚å¸¸å‡ºç¾ï¼šæ‡‰è©²åˆ†é…å¤šå°‘è³‡æºçµ¦æ‡‰ç”¨ï¼Ÿä¾‹å¦‚ï¼šå¾Œç«¯æº–å‚™ä¸€å€‹ API serverï¼ŒSRE é€™é‚Šè¦æº–å‚™å¤šå°‘ä»€éº¼è¦æ ¼çš„æ©Ÿå™¨ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eä»¥å¾€ä½¿ç”¨è™›æ“¬æ©Ÿç›´æ¥éƒ¨ç½²æ‡‰ç”¨æ™‚ï¼Œæœƒéœ€è¦æ˜ç¢ºè¦åŠƒå„ç¾¤è™›æ“¬æ©Ÿï¼Œå„è‡ªéœ€è¦åŸ·è¡Œçš„æ‡‰ç”¨ï¼Œå¦‚æœæ²’æœ‰åšè³‡æºçš„äº‹å‰è©•ä¼°ï¼Œæœ‰å¯èƒ½æ”¾ä¸Šæ©Ÿå™¨é‹è¡Œå¾Œå°±ç™¼ç”Ÿè³‡æºä¸è¶³ã€‚\u003c/p\u003e\n\u003cp\u003eå°å…¥ Kubernetes å¾Œï¼Œé€éç¯€é»æ±  (Node Pool) å½¢æˆä¸€å€‹å¤§å‹è³‡æºæ± ï¼Œè¨­å®šéƒ¨ç½²çš„æ”¿ç­–å¾Œï¼Œè®“ Kubernetes è‡ªå‹•èª¿åº¦æ‡‰ç”¨ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¯ä¸€å€‹ç¯€é»çš„è³‡æºå¤ å¤§ï¼Œä½¿å¾—æ‡‰ç”¨è™›æ“¬æ©Ÿå™¨ä¸Šæ‰€ä½”çš„æ¯”ä¾‹ç›¸å°è¼ƒå°ï¼Œä¹Ÿå°±æ˜¯å–®ä¸€æ‡‰ç”¨çš„èª¿åº¦ä¸æœƒå½±éŸ¿ç¯€é»çš„æ•´é«”è² è¼‰\n\u003cul\u003e\n\u003cli\u003eå¦‚æœç¯€é»å¤ªå°ï¼Œèª¿åº¦æ‡‰ç”¨å°±æœƒæœ‰äº›ä¾·ä¿ƒï¼Œä¾‹å¦‚ï¼šä¸€å€‹ API server å‡è¼‰æ™‚æ¶ˆè€— 1 cpu æ»¿è¼‰æ™‚æ¶ˆè€— 2 cpuã€‚æº–å‚™ 3 cpu çš„è™›æ“¬æ©Ÿï¼Œèª¿åº¦æ‡‰ç”¨æ™‚å¹¾ä¹æ˜¯é·ç§»æ•´å°è™›æ“¬æ©Ÿçš„è² è¼‰\u003c/li\u003e\n\u003cli\u003eæ­¤å¤–é‚„æœ‰æ©Ÿæœƒå› ç‚º\u003ca href=\"\"\u003eä¸Šç¯‡\u003c/a\u003eæåˆ°çš„è³‡æºä¿ç•™ï¼Œé€ æˆèª¿åº¦å¤±æ•—ã€‚å¦‚æœæº–å‚™ 24 cpu çš„æ©Ÿå™¨ï¼Œèª¿åº¦èµ·ä¾†å½ˆæ€§å°±å¾ˆå¤§ï¼Œå°ç¯€é»çš„æ€§èƒ½è¡æ“Šä¹Ÿæ¯”è¼ƒä½\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eåªéœ€è¦ä¼°è¨ˆæ•´é«”çš„è³‡æºæ¶ˆè€—ç‡è¨ˆç®—éœ€æ±‚ï¼Œé…åˆè‡ªå‹•æ“´å±•ï¼Œå‹•æ…‹å™¨è£œè¶³ä¸è¶³çš„è³‡æº\n\u003cul\u003e\n\u003cli\u003eä¾‹å¦‚ï¼šä¼°è¨ˆç¸½å…±éœ€è¦ 32 cpu ï¼Œæº–å‚™ 36 cpu çš„è™›æ“¬æ©Ÿï¼Œç•¶æ»¿è¼‰æ™‚ä¾æ“š cpu å£“åŠ›è‡ªå‹•æ“´å®¹åˆ° 48 cpu\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå¸Œæœ›æ•´é«”è³‡æºçš„ä½¿ç”¨ç‡å¤ é«˜ï¼Œç•¶ç„¶é ç•™å¤ªå¤šçš„è³‡æºæœƒé€ æˆæµªè²»\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè¦æ§ç®¡ Kubernetes çš„è³‡æºä½¿ç”¨é‡ä¹Ÿå¯è¨­å®š\u003ca href=\"https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/\"\u003eè³‡æºéœ€æ±‚èˆ‡è³‡æºé™åˆ¶\u003c/a\u003eï¼Œå»¶ä¼¸é–±è®€ã€‚\u003c/p\u003e\n\u003cp\u003eä¼°è¨ˆå¾—è¶Šæº–ç¢ºï¼Œç•¶ç„¶å¯¦éš›éƒ¨ç½²çš„è³‡æºæŒæ¡åº¦å°±è¶Šé«˜ï¼Œç„¶è€Œç­†è€…éå»çš„ç¶“é©—ï¼Œåœ˜éšŠåœ¨äº¤ä»˜æºç¢¼æ™‚æœªå¿…å°±èƒ½å¤ åšå‡ºæœ‰æ•ˆçš„è³‡æºæ¶ˆè€—è©•ä¼°ï¼Œé‚£æœ‰æ²’æœ‰ä»€éº¼è¾¦æ³•å¯ä»¥å¹«åŠ©æˆ‘å€‘ï¼Ÿ\u003c/p\u003e\n\u003ch3 id=\"è³‡æºéœ€æ±‚ä¼°ä¼°çœ‹\"\u003eè³‡æºéœ€æ±‚ä¼°ä¼°çœ‹\u003c/h3\u003e\n\u003cp\u003eå¦‚æœæ‡‰ç”¨é–‹ç™¼åœ˜éšŠï¼Œæœ‰å…ˆä½œæ‡‰ç”¨çš„ profilingï¼Œç„¶å¾Œ release candidate ç‰ˆæœ¬æœ‰åœ¨ staging ä¸Šä½œå£“åŠ›æ¸¬è©¦çš„è©±ï¼Œç¶­é‹åœ˜éšŠé€™é‚Šæ‡‰è©²å°±å–å¾—çš„æ•¸æ“šï¼Œåšéƒ¨ç½²å‰çš„è³‡æºè©•ä¼°ã€‚\u003c/p\u003e\n\u003cp\u003eæ‡‰ç”¨åœ¨ä¸åŒç‹€æ…‹æˆ–æ˜¯å·¥ä½œéšæ®µï¼Œæœƒæ¶ˆè€—ä¸åŒçš„è³‡æº\u003c/p\u003e\n\u003cp\u003eä¾‹å¦‚ï¼šé‹ç®—å¯†é›†çš„ batch job å¯èƒ½æœƒæœ‰\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ§åˆ¶ç¯€é» (master node) å•Ÿå‹•å¾Œæœƒä½”æœ‰ä¸€å®šçš„è³‡æºï¼Œä¸€èˆ¬ä¾†èªªä¸æœƒæ¶ˆè€—å¤ªå¤šï¼Œåªæ˜¯éœ€è¦ç‚ºæ§åˆ¶ç¯€é»å„ªå…ˆä¿ç•™è³‡æº\u003c/li\u003e\n\u003cli\u003eå·¥ä½œç¯€é» (worker node) å•Ÿå‹•æ™‚æœƒéœ€è¦é ç•™è¶³å¤ çš„è³‡æºï¼Œæ¥æ”¶å·¥ä½œå¾Œæœƒé€æ¼¸å¢åŠ è³‡æºä½¿ç”¨ï¼Œæ‹‰åˆ°æ»¿è¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¾‹å¦‚ï¼šé¢å‘ç”¨æˆ¶çš„æœå‹™ï¼Œå¯èƒ½æœƒæœ‰\u003c/p\u003e","title":"Gcp Preemptible Instance Resource Calculation"},{"content":"éœ€æ±‚è¦åŠƒ ä½¿ç”¨å…ˆå ç¯€é»æ¯”èµ·ä½¿ç”¨ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿï¼Œæœƒå¤šå‡ºè¨±å¤šæŠ€è¡“å›°é›£éœ€è¦å…‹æœï¼Œåªæœ‰ç¯€çœä¸‹çš„æˆæœ¬å¤§æ–¼æ•´é«”æŠ€è¡“æˆæœ¬æ™‚ï¼Œæˆ‘å€‘æ‰æœƒé¸ç”¨å…ˆå ç¯€é»ã€‚å› æ­¤é€™é‚Šè¦é€²è¡Œæˆæœ¬ç²¾ç®—ï¼Œé‡æ–°èª¿æ•´çš„æ¶æ§‹ä¸‹ï¼Œå¯¦éš›åˆ°åº•èƒ½çœå¤šå°‘éŒ¢ã€‚å‹™å¿…ä½¿ç”¨ Google Cloud Pricing Calculator ç²¾ç®—æˆæœ¬ã€‚\nå¦å¤–ï¼Œé›–ç„¶å…ˆå è™›æ“¬æ©Ÿæœƒæœ‰å¾ˆå¤šé¡å¤–çš„é™åˆ¶èˆ‡æŠ€è¡“å›°é›£ï¼Œä½†å¯¦å‹™ä¸Šé‚„æ˜¯è¦å°æ¯”å¯¦éš›çš„éœ€æ±‚ï¼Œæœ‰äº›é™åˆ¶èˆ‡éœ€æ±‚æ˜¯è¡çªçš„ï¼Œæœ‰äº›é™åˆ¶å‰‡å®Œå…¨ä¸æœƒå½±éŸ¿æˆ‘å€‘çš„éœ€æ±‚ã€‚å‰è€…ç•¶ç„¶æœƒå¸¶çµ¦æˆ‘å€‘è¼ƒé«˜çš„å°å…¥é›£åº¦ï¼Œå¾Œè€…å¯èƒ½æœƒéå¸¸è¼•é¬†ã€‚\né€™é‚Šæƒ³çµ¦å¤§å®¶çš„æ¦‚å¿µæ˜¯ï¼Œå‹™å¿…å…ˆæ˜ç¢ºéœ€æ±‚ï¼Œå†è¨è«–æŠ€è¡“ã€‚é€™é»å¾ˆé‡è¦ï¼ŒæŠ€è¡“çš„é©ç”¨èˆ‡å¦ï¼Œä¸æ˜¯ç”±å€‹äººçš„å–œå¥½æ±ºå®šï¼Œå”¯ä¸€çš„åˆ¤æ–·æ¨™æº–ï¼Œæ˜¯èƒ½ä¸èƒ½æœ‰æ•ˆç‡çš„æ»¿è¶³éœ€æ±‚ã€‚\næ‰€ä»¥é€™é‚Šå…ˆå®šç¾©æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\nåŸ·è¡ŒçŸ­æœŸçš„ batch job åŸ·è¡Œé•·æœŸçš„ user-facing API server åŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº« Batch Job å¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\nä½¿ç”¨ç¶²è·¯çˆ¬èŸ² (crawler) å»æŠ“å–è¨±å¤šç¶²ç«™çš„æ‰€æœ‰å…§å®¹ ä½¿ç”¨ GPU é€²è¡Œæ©Ÿå™¨å­¸ç¿’çš„ Model Training å¤§æ•¸æ“šè¨ˆç®— MapReduce é€™äº›ä»»å‹™çš„æ ¸å¿ƒéœ€æ±‚ï¼Œå¾ˆç°¡å–®ç›´æ¥\nç›¡å¿«å®Œæˆæ•´é«”å·¥ä½œ ç›¡å¯èƒ½ç¯€çœå¤§é‡ç®—åŠ›æˆæœ¬ ä¾‹å¦‚ï¼šæˆ‘æ‰‹ä¸Šçš„æ©Ÿå™¨å­¸ç¿’ Model ç²—ç•¥ä¼°è¨ˆ 10000 å°æ™‚*GPU çš„ç®—åŠ›éœ€æ±‚ï¼Œæ‰èƒ½ç”¢å‡ºä¸€å€‹æœ‰æ•ˆçš„Modelã€‚ç”±æ–¼å¤§é‡çš„ç®—åŠ›éœ€æ±‚ï¼Œä¸€èˆ¬ä¾†èªªéƒ½æœƒé¸æ“‡åˆ†æ•£å¼çš„é‹ç®—æ¡†æ¶ (ex. MapReduce) ï¼Œå°‡çœŸæ­£æ¶ˆè€—ç®—åŠ›çš„å·¥ä½œï¼Œä½¿ç”¨åˆ†è€ŒåŒ–ä¹‹ (divide and conquer) çš„æ¶æ§‹è¨­è¨ˆï¼Œå°‡åˆ†é…ä»»å‹™çš„æ§åˆ¶ç¯€é» (master)ï¼Œèˆ‡å¯¦éš›é€²è¡Œé‹ç®—çš„å·¥ä½œç¯€é»(worker) æ‹†åˆ†ã€‚åŸºæ–¼åŸæœ¬çš„åˆ†æ•£å¼æ¶æ§‹ï¼Œå¹¾ä¹å¯ä»¥ç„¡ç—›åœ°å°‡å·¥ä½œç¯€é»è½‰ç§»åˆ°å…ˆå è™›æ“¬æ©Ÿä¸Šã€‚\næ ¹æ“šä¸Šè¿°çš„éœ€æ±‚ï¼Œé€™é¡çš„å·¥ä½œç‰¹æ€§å¯èƒ½æœ‰\nCPU / GPU ç®—åŠ›éœ€æ±‚é«˜çš„é‹ç®—ç¯€é» (Worker) Worker æœ¬èº«æ˜¯ç„¡ç‹€æ…‹çš„ Stateless å¯æ§çš„å³æ™‚è² è¼‰ å°‡æ•´é«”å·¥ä½œåˆ‡åˆ†æˆä»»å‹™å–®å…ƒ (task)ï¼Œåˆ†é…çµ¦å·¥ä½œç¯€é» ä»»å‹™å–®å…ƒçš„ç‹€æ…‹å¤–éƒ¨ä¿ç•™ï¼Œå·¥ä½œç¯€é»å¯å®¹éŒ¯ (fault-tolerent)ï¼Œä»»å‹™å–®å…ƒå¯å¾©åŸ ç”±æ–¼å…ˆå è™›æ“¬æ©Ÿå¯èƒ½æ˜¯æµ®å‹•åƒ¹æ ¼ï¼Œé€™é¡å·¥ä½œå¯ä»¥æ ¹æ“šå„ªå…ˆç¨‹åº¦ï¼Œèª¿æ•´åˆé©çš„å·¥ä½œæ™‚é–“ï¼Œä¾‹å¦‚åœ¨è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚ä½ï¼Œå…ˆå è™›æ“¬æ©Ÿçš„è²»ç”¨ä½å»‰æ™‚ï¼Œå•Ÿç”¨è¼ƒå¤šçš„å·¥ä½œç¯€é»åŠ å¿«é‹ç®—ï¼Œå¦‚æœè²»ç”¨é«˜æ™‚ï¼Œå¯ä»¥é™ä½å…ˆå è™›æ“¬æ©Ÿçš„ä½¿ç”¨ï¼Œå»¶å¾Œå·¥ä½œï¼Œç”šè‡³æ˜¯èª¿ç”¨ä¸åŒå€åŸŸï¼Œè²»ç”¨ä½çš„å·¥ä½œç¯€é»ï¼Œä¾†é™ä½æ•´é«”çš„æˆæœ¬ã€‚\nåŸ·å¾—æ³¨æ„çš„æ˜¯ï¼Œé€™é¡ä»»å‹™çš„æ§åˆ¶ç¯€é» (master)ï¼Œä¹Ÿè¨±æ˜¯é›†ä¸­å¼çš„ï¼Œä¹Ÿè¨±æ˜¯åˆ†æ•£å¼çš„ï¼Œéœ€è¦æ ¹æ“šæ€§è³ªè€ƒé‡ï¼Œæ˜¯å¦é©åˆæ”¾åœ¨å…ˆå è™›æ“¬æ©Ÿä¸Šã€‚æœ‰äº›æ¶æ§‹æ§åˆ¶ç¯€é»å¯ä»¥å®¹éŒ¯ï¼Œç„¶è€ŒéŒ¯èª¤ç™¼ç”Ÿå¾Œæœƒéœ€è¦å¾©åŸç‹€æ…‹ï¼Œé€™æ™‚æœƒæ¶ˆè€—é¡å¤–çš„ç®—åŠ›ï¼Œå¯èƒ½æœƒæ‹–ç·©æ•´é«”é€²åº¦ï¼Œé€ æˆç®—åŠ›çš„æ¶ˆè€—ã€‚ä¹Ÿè¨±å°±å¯ä»¥è€ƒé‡ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿé…åˆä½¿ç”¨ã€‚\nUser-facing services å¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\nRestful API server Websocket Server TCP/HTTP reverse proxy é€™äº›å·¥ä½œçš„æ ¸å¿ƒéœ€æ±‚å¦‚ä¸‹ï¼š\næ•´é¡Œæœå‹™çš„é«˜å¯ç”¨æ€§ (high availability) æ‰¿å—ä¸å¯é æœŸçš„è² è¼‰é«˜å³° (load spikes) æ•´é«”è¡¨ç¾éœ€è¦ä½å»¶é² (low latency) å¯ä»¥æ°´å¹³æ“´å±• (horizontal scaling)ï¼Œæ”¯æ’ç”¨æˆ¶çš„æˆé•· æœ€çµ‚å¹³è¡¡æ•ˆèƒ½å‘ˆç¾èˆ‡æˆæœ¬ ç”±æ–¼æœƒé¢å°ä½¿ç”¨è€…ï¼Œéœ€è¦èƒ½æ”¯æŒä½¿ç”¨è€…çš„å£“åŠ›ï¼ŒåˆåŒæ™‚éœ€è¦æœ‰ä¸€å®šçš„æœå‹™æ•ˆèƒ½ï¼Œä¾†ç¶­æŒä½¿ç”¨è€…é«”é©—ã€‚å¯¦å‹™ä¸Šè¨­è¨ˆå¯èƒ½æ¡ç”¨ç„¡ç‹€æ…‹æ‡‰ç”¨ (stateless)ï¼Œå¤šå‰¯æœ¬ (replica) éƒ¨ç½²åˆ°é›†ç¾¤ä¸­ã€‚éœ€è¦å„²å­˜çš„ç‹€æ…‹ï¼ˆå¦‚ç”¨æˆ¶ç‹€æ…‹ï¼‰ï¼Œä½¿ç”¨å¤–éƒ¨çš„å…±ç”¨å„²å­˜ (ä¾‹å¦‚ï¼šRedisï¼ŒRDBMSï¼Œæˆ–æ˜¯ Non-SQL DB)ã€‚è«‹æ±‚çš„æµé‡ï¼Œé€éä¸Šæ¸¸çš„è² è¼‰å‡è¡¡å™¨ (Load Balancer)ï¼Œé€é€²å¤šå€‹å¾Œç«¯ï¼Œè™•ç†å®Œæˆè«‹æ±‚å¾Œï¼Œå†è¿”å›çµ¦ä½¿ç”¨è€…ã€‚\né€™æ¨£çš„è¨­è¨ˆï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿä¹Ÿä¸æœƒæœ‰å¤ªå¤šçš„å•é¡Œ\nç¾ä»£çš„é™„è¼‰å‡è¡¡å™¨å¤šåŠéƒ½èƒ½åƒå¾Œç«¯åšå¯ç”¨æ€§æª¢æ¸¬ (health check)ï¼Œå¯ä»¥æŠŠæµé‡å°å‘å·¥ä½œæ­£å¸¸çš„ç¯€é»ï¼Œå¦‚æœå¾Œç«¯çš„è™›æ“¬æ©Ÿè¢«è³‡æ–™ä¸­å¿ƒæ”¶å›äº†ï¼Œæµé‡ä¹Ÿæœƒç§»è½‰åˆ°å…¶ä»–ç¯€é»ä¸Šï¼Œä¸æœƒéºå¤±ç”¨æˆ¶è«‹æ±‚ é…åˆè‡ªå‹•æ°´å¹³æ‹“å±•å·¥å…· (Auto horizontal scaler)ï¼Œå¯ä»¥è¨­å®šæœŸæœ›çš„æœå‹™ç¯€é»æ•¸é‡ï¼Œå¦‚æœè³‡æ–™ä¸­å¿ƒå›æ”¶å…ˆå ç¯€é»ï¼Œæ‹“å±•å·¥å…·å¯ä»¥åŒæ™‚å»å–å¾—æ–°çš„å…ˆå ç¯€é»ï¼Œæˆ–æ˜¯å–å¾—éš¨é¸éš¨ç”¨çš„è™›æ“¬æ©Ÿ é…åˆæµé‡ç›£æ¸¬ï¼Œä¹Ÿå¯ä»¥å‹•æ…‹èª¿æ•´æœŸæœ›çš„æœå‹™ç¯€é»æ•¸é‡ï¼Œä¾‹å¦‚ï¼šåµæ¸¬åˆ°å¤§é‡ç”¨æˆ¶é€£ç·šæ•¸æ™‚ï¼Œå¢åŠ æ›´å¤šæœå‹™ç¯€é»ï¼Œå¾…æµé‡ä¸‹é™å¾Œï¼Œå†é™ä½æœå‹™ç¯€é»æ•¸é‡ é€™æ¨£çš„è¨­è¨ˆå¯¦å‹™ä¸Šæœ‰å¹¾é»æ³¨æ„\né›–ç„¶èªªæ‡‰ç”¨å¾Œç«¯æœ¬èº«æ˜¯ç„¡ç‹€æ…‹çš„ï¼Œä½†é¢å°ç”¨æˆ¶ä¹Ÿè¨±é‚„æ˜¯æœƒæœ‰éƒ¨åˆ†ç‹€æ…‹å­˜åœ¨æ‡‰ç”¨å¤–éƒ¨ï¼Œä¾‹å¦‚ï¼šUser sessionï¼Œæˆ–æ˜¯ websocket çš„é•·é€£ç·šã€‚ç‰¹åˆ¥æ³¨æ„é€™äº›æœå‹™æ–·ç·šçš„æ™‚å€™ï¼Œå°æ–¼ä½¿ç”¨è€…çš„å½±éŸ¿ï¼Œé…åˆå‰ç«¯å¢å¼·ä½¿ç”¨è€…é«”é©— å¾Œç«¯æ°´å¹³æ‹“å±•å¾Œï¼Œç“¶é ¸æœƒè½‰ç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œä¾‹å¦‚ Database æˆç‚ºæ•ˆèƒ½ç“¶é ¸ï¼Œæ‡‰ç”¨é€™é‚Šéœ€è¦åšä¸€å®šç¨‹åº¦çš„è‡ªå¾‹( ex. connection limitï¼Œrate limit)ï¼Œé¿å…ä¸æ–·å¢é•·çš„æ‡‰ç”¨å£“å®ä¾è³´çš„æœå‹™ï¼Œå¦‚ MessageQueue æˆ–æ˜¯ Database åˆ†æ•£å¼çš„å„²å­˜ä¸­å¿ƒ (distributed DB)ï¼Œå¦‚ï¼šcassandra æˆ–æ˜¯å°å¼· DBã€‚è€Œé€™æ¨£é¡å‹çš„æœå‹™ï¼Œæ˜¯å¦é©åˆæ”¾åœ¨å…ˆå ç¯€é»ä¸Šï¼Ÿ\n","permalink":"https://chechia.net/posts/2020-09-24-gcp-preemptible-instance-requirement/","summary":"\u003ch1 id=\"éœ€æ±‚è¦åŠƒ\"\u003eéœ€æ±‚è¦åŠƒ\u003c/h1\u003e\n\u003cp\u003eä½¿ç”¨å…ˆå ç¯€é»æ¯”èµ·ä½¿ç”¨ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿï¼Œæœƒå¤šå‡ºè¨±å¤šæŠ€è¡“å›°é›£éœ€è¦å…‹æœï¼Œåªæœ‰ç¯€çœä¸‹çš„æˆæœ¬å¤§æ–¼æ•´é«”æŠ€è¡“æˆæœ¬æ™‚ï¼Œæˆ‘å€‘æ‰æœƒé¸ç”¨å…ˆå ç¯€é»ã€‚å› æ­¤é€™é‚Šè¦é€²è¡Œæˆæœ¬ç²¾ç®—ï¼Œé‡æ–°èª¿æ•´çš„æ¶æ§‹ä¸‹ï¼Œå¯¦éš›åˆ°åº•èƒ½çœå¤šå°‘éŒ¢ã€‚å‹™å¿…ä½¿ç”¨ \u003ca href=\"https://cloud.google.com/products/calculator?hl=zh-tw\"\u003eGoogle Cloud Pricing Calculator\u003c/a\u003e ç²¾ç®—æˆæœ¬ã€‚\u003c/p\u003e\n\u003cp\u003eå¦å¤–ï¼Œé›–ç„¶å…ˆå è™›æ“¬æ©Ÿæœƒæœ‰å¾ˆå¤šé¡å¤–çš„é™åˆ¶èˆ‡æŠ€è¡“å›°é›£ï¼Œä½†å¯¦å‹™ä¸Šé‚„æ˜¯è¦å°æ¯”å¯¦éš›çš„éœ€æ±‚ï¼Œæœ‰äº›é™åˆ¶èˆ‡éœ€æ±‚æ˜¯è¡çªçš„ï¼Œæœ‰äº›é™åˆ¶å‰‡å®Œå…¨ä¸æœƒå½±éŸ¿æˆ‘å€‘çš„éœ€æ±‚ã€‚å‰è€…ç•¶ç„¶æœƒå¸¶çµ¦æˆ‘å€‘è¼ƒé«˜çš„å°å…¥é›£åº¦ï¼Œå¾Œè€…å¯èƒ½æœƒéå¸¸è¼•é¬†ã€‚\u003c/p\u003e\n\u003cp\u003eé€™é‚Šæƒ³çµ¦å¤§å®¶çš„æ¦‚å¿µæ˜¯ï¼Œå‹™å¿…å…ˆæ˜ç¢ºéœ€æ±‚ï¼Œå†è¨è«–æŠ€è¡“ã€‚é€™é»å¾ˆé‡è¦ï¼ŒæŠ€è¡“çš„é©ç”¨èˆ‡å¦ï¼Œä¸æ˜¯ç”±å€‹äººçš„å–œå¥½æ±ºå®šï¼Œå”¯ä¸€çš„åˆ¤æ–·æ¨™æº–ï¼Œæ˜¯èƒ½ä¸èƒ½æœ‰æ•ˆç‡çš„æ»¿è¶³éœ€æ±‚ã€‚\u003c/p\u003e\n\u003cp\u003eæ‰€ä»¥é€™é‚Šå…ˆå®šç¾©æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåŸ·è¡ŒçŸ­æœŸçš„ batch job\u003c/li\u003e\n\u003cli\u003eåŸ·è¡Œé•·æœŸçš„ user-facing API server\u003c/li\u003e\n\u003cli\u003eåŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº«\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"batch-job\"\u003eBatch Job\u003c/h3\u003e\n\u003cp\u003eå¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä½¿ç”¨ç¶²è·¯çˆ¬èŸ² (crawler) å»æŠ“å–è¨±å¤šç¶²ç«™çš„æ‰€æœ‰å…§å®¹\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨ GPU é€²è¡Œæ©Ÿå™¨å­¸ç¿’çš„ Model Training\u003c/li\u003e\n\u003cli\u003eå¤§æ•¸æ“šè¨ˆç®—\u003c/li\u003e\n\u003cli\u003eMapReduce\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé€™äº›ä»»å‹™çš„æ ¸å¿ƒéœ€æ±‚ï¼Œå¾ˆç°¡å–®ç›´æ¥\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç›¡å¿«å®Œæˆæ•´é«”å·¥ä½œ\u003c/li\u003e\n\u003cli\u003eç›¡å¯èƒ½ç¯€çœå¤§é‡ç®—åŠ›æˆæœ¬\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¾‹å¦‚ï¼šæˆ‘æ‰‹ä¸Šçš„æ©Ÿå™¨å­¸ç¿’ Model ç²—ç•¥ä¼°è¨ˆ 10000 å°æ™‚*GPU çš„ç®—åŠ›éœ€æ±‚ï¼Œæ‰èƒ½ç”¢å‡ºä¸€å€‹æœ‰æ•ˆçš„Modelã€‚ç”±æ–¼å¤§é‡çš„ç®—åŠ›éœ€æ±‚ï¼Œä¸€èˆ¬ä¾†èªªéƒ½æœƒé¸æ“‡åˆ†æ•£å¼çš„é‹ç®—æ¡†æ¶ (ex. MapReduce) ï¼Œå°‡çœŸæ­£æ¶ˆè€—ç®—åŠ›çš„å·¥ä½œï¼Œä½¿ç”¨åˆ†è€ŒåŒ–ä¹‹ (divide and conquer) çš„æ¶æ§‹è¨­è¨ˆï¼Œå°‡åˆ†é…ä»»å‹™çš„æ§åˆ¶ç¯€é» (master)ï¼Œèˆ‡å¯¦éš›é€²è¡Œé‹ç®—çš„å·¥ä½œç¯€é»(worker) æ‹†åˆ†ã€‚åŸºæ–¼åŸæœ¬çš„åˆ†æ•£å¼æ¶æ§‹ï¼Œå¹¾ä¹å¯ä»¥ç„¡ç—›åœ°å°‡å·¥ä½œç¯€é»è½‰ç§»åˆ°å…ˆå è™›æ“¬æ©Ÿä¸Šã€‚\u003c/p\u003e\n\u003cp\u003eæ ¹æ“šä¸Šè¿°çš„éœ€æ±‚ï¼Œé€™é¡çš„å·¥ä½œç‰¹æ€§å¯èƒ½æœ‰\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCPU / GPU ç®—åŠ›éœ€æ±‚é«˜çš„é‹ç®—ç¯€é» (Worker)\u003c/li\u003e\n\u003cli\u003eWorker æœ¬èº«æ˜¯ç„¡ç‹€æ…‹çš„ Stateless\u003c/li\u003e\n\u003cli\u003eå¯æ§çš„å³æ™‚è² è¼‰\u003c/li\u003e\n\u003cli\u003eå°‡æ•´é«”å·¥ä½œåˆ‡åˆ†æˆä»»å‹™å–®å…ƒ (task)ï¼Œåˆ†é…çµ¦å·¥ä½œç¯€é»\u003c/li\u003e\n\u003cli\u003eä»»å‹™å–®å…ƒçš„ç‹€æ…‹å¤–éƒ¨ä¿ç•™ï¼Œå·¥ä½œç¯€é»å¯å®¹éŒ¯ (fault-tolerent)ï¼Œä»»å‹™å–®å…ƒå¯å¾©åŸ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼å…ˆå è™›æ“¬æ©Ÿå¯èƒ½æ˜¯æµ®å‹•åƒ¹æ ¼ï¼Œé€™é¡å·¥ä½œå¯ä»¥æ ¹æ“šå„ªå…ˆç¨‹åº¦ï¼Œèª¿æ•´åˆé©çš„å·¥ä½œæ™‚é–“ï¼Œä¾‹å¦‚åœ¨è³‡æ–™ä¸­å¿ƒç®—åŠ›éœ€æ±‚ä½ï¼Œå…ˆå è™›æ“¬æ©Ÿçš„è²»ç”¨ä½å»‰æ™‚ï¼Œå•Ÿç”¨è¼ƒå¤šçš„å·¥ä½œç¯€é»åŠ å¿«é‹ç®—ï¼Œå¦‚æœè²»ç”¨é«˜æ™‚ï¼Œå¯ä»¥é™ä½å…ˆå è™›æ“¬æ©Ÿçš„ä½¿ç”¨ï¼Œå»¶å¾Œå·¥ä½œï¼Œç”šè‡³æ˜¯èª¿ç”¨ä¸åŒå€åŸŸï¼Œè²»ç”¨ä½çš„å·¥ä½œç¯€é»ï¼Œä¾†é™ä½æ•´é«”çš„æˆæœ¬ã€‚\u003c/p\u003e\n\u003cp\u003eåŸ·å¾—æ³¨æ„çš„æ˜¯ï¼Œé€™é¡ä»»å‹™çš„æ§åˆ¶ç¯€é» (master)ï¼Œä¹Ÿè¨±æ˜¯é›†ä¸­å¼çš„ï¼Œä¹Ÿè¨±æ˜¯åˆ†æ•£å¼çš„ï¼Œéœ€è¦æ ¹æ“šæ€§è³ªè€ƒé‡ï¼Œæ˜¯å¦é©åˆæ”¾åœ¨å…ˆå è™›æ“¬æ©Ÿä¸Šã€‚æœ‰äº›æ¶æ§‹æ§åˆ¶ç¯€é»å¯ä»¥å®¹éŒ¯ï¼Œç„¶è€ŒéŒ¯èª¤ç™¼ç”Ÿå¾Œæœƒéœ€è¦å¾©åŸç‹€æ…‹ï¼Œé€™æ™‚æœƒæ¶ˆè€—é¡å¤–çš„ç®—åŠ›ï¼Œå¯èƒ½æœƒæ‹–ç·©æ•´é«”é€²åº¦ï¼Œé€ æˆç®—åŠ›çš„æ¶ˆè€—ã€‚ä¹Ÿè¨±å°±å¯ä»¥è€ƒé‡ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿé…åˆä½¿ç”¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"user-facing-services\"\u003eUser-facing services\u003c/h3\u003e\n\u003cp\u003eå¸¸è¦‹çš„ç¯„ä¾‹ï¼Œä¾‹å¦‚\u003c/p\u003e","title":"Gcp Preemptible Instance Requirement"},{"content":"å…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢æµç¨‹ (Preemption process) å­æ›°ï¼šæœªçŸ¥ç”Ÿç„‰çŸ¥æ­»ã€‚ä½†åšå·¥ç¨‹å¸«è¦åéä¾†ï¼Œè€ƒé‡æœ€å·®æƒ…å½¢ï¼Œä¹Ÿå°±æ˜¯è¦çŸ¥é“æ‡‰ç”¨å¯èƒ½å¦‚ä½•æ­»å»ã€‚ä¸çŸ¥é“æ‡‰ç”¨å¯èƒ½æ€éº¼æ­»ï¼Œåˆ¥èªªä½ çŸ¥é“æ‡‰ç”¨æ´»å¾—å¥½å¥½çš„ï¼Œå¤§æ¦‚æƒ³è¡¨é”é€™éº¼æ„æ€ã€‚\né€™å°å…ˆå è™›æ“¬æ©Ÿä¾†èªªç‰¹åˆ¥é‡è¦ï¼Œä¸€èˆ¬æ‡‰ç”¨é¢å°çš„æ©Ÿå™¨æ•…éšœæˆ–æ˜¯æ©Ÿå™¨çµ‚æ­¢ï¼Œåœ¨ä½¿ç”¨å…ˆå è¥¿ä½ å¹¾çš„ç‹€æ³ä¸‹ï¼Œè®Šæˆæ¯æ—¥çš„å¿…ç„¶ï¼Œå› æ­¤ï¼Œéœ€è¦å°æ‡‰ç”¨çš„çµ‚æ­¢æƒ…å¢ƒï¼Œèˆ‡çµ‚æ­¢æµç¨‹æœ‰æ›´ç²¾ç´°çš„æŒæ§ã€‚å¦‚åŒå‰å¹¾ç¯‡æ‰€èªªçš„ï¼Œå…ˆå è™›æ“¬æ©Ÿæœƒè¢«å…¬æœ‰é›²æ”¶å›ï¼Œä½†æ”¶å›çš„æ™‚å€™ä¸æœƒçªç„¶æ©Ÿå™¨å°± ben ä¸è¦‹ï¼Œæœƒæœ‰ä¸€å€‹å›ºå®šçš„æµç¨‹ã€‚\nå¦‚æœä½ çš„æ‡‰ç”¨å·²ç¶“å¸¶æœ‰å¯å®¹éŒ¯çš„æ©Ÿåˆ¶ï¼Œèƒ½å¤ æ‰¿å—æ©Ÿå™¨çªç„¶è®Šä¸è¦‹ï¼Œæœå‹™é‚„å¥½å¥½çš„ï¼Œä»ç„¶è¦èŠ±æ™‚é–“ç†è§£é€™é‚Šçš„æµç¨‹ï¼Œè—‰æ­¤ç²¾ç®—æ¯å¤©è™›æ“¬æ©Ÿçš„çµ‚æ­¢èˆ‡æ›¿æ›ï¼šæ‡‰ç”¨æœƒæœ‰ä»€éº¼åæ‡‰ï¼Œæœƒç”¢ç”Ÿå¤šå°‘è¡æ“Šï¼Œç¨å¾Œå¯ä»¥é‡åŒ–æœå‹™çš„å½±éŸ¿ã€‚ä¾‹å¦‚\næ‡‰ç”¨é‡å•Ÿåˆå§‹åŒ–æ™‚ cpu memory çªç„¶æ‹‰é«˜ æ‰¿å—ç¯€é»éŒ¯èª¤å¾Œçš„å¾©åŸæµç¨‹ï¼Œéœ€è¦æ¶ˆè€—é¡å¤–ç®—åŠ›ã€‚ä¾‹å¦‚éœ€è¦å¾ä¸Šå€‹ checkpoint æ¥çºŒåšï¼Œéœ€è¦å»è®€å–è³‡æ–™é€ æˆ IOï¼Œæˆ–æ˜¯è³‡æ–™éœ€è¦åš rebalance \u0026hellip;ç­‰ç­‰ å¦‚æœä½ çš„æ‡‰ç”¨éœ€è¦æœ‰ graceful shutdown çš„æ©Ÿåˆ¶ï¼Œé‚£ä½ å‹™å¿…è¦ç´°å¿ƒç†è§£é€™é‚Šçš„æ­¥é©Ÿã€‚ä¸¦ä»”ç´°å®‰æ’å®‰å…¨ä¸‹æ¨çš„æ­¥é©Ÿã€‚åˆæˆ–æ˜¯ç„¡æ³•ä¿è­‰åœ¨å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„ä½œæ¥­æ™‚é™å…§ï¼Œå®Œæˆå„ªé›…çµ‚æ­¢ï¼Œéœ€è¦è€ƒæ…®å…¶ä»–å¯èƒ½çš„å¯¦ä½œè§£æ³•ã€‚\né€™é‚Šæœ‰å¹¾å€‹é¢å‘è¦æ³¨æ„\nGCP å¦‚ä½•çµ‚æ­¢å…ˆå ç¯€é» GCP ç§»é™¤ç¯€é»å° GKE ã€ä»¥åŠåŸ·è¡Œä¸­æ‡‰ç”¨çš„å½±éŸ¿ GKE é›†ç¾¤å¦‚ä½•æ‡‰å°çš„ç¯€é»å¤±æ•ˆ GCP è‡ªå‹•èª¿åº¦è£œè¶³æ–°çš„å…ˆå ç¯€é» GKE é›†ç¾¤å¦‚ä½•æ‡‰å°ç¯€é»è£œè¶³ ä¸‰å€‹é‡é»\nå…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢å°é›†ç¾¤çš„å½±éŸ¿ Pod éš¨ä¹‹çµ‚æ­¢å°æ‡‰ç”¨çš„å½±éŸ¿ï¼Œæ˜¯å¦èƒ½å¤ å„ªé›…çµ‚æ­¢ æœ‰æ²’æœ‰æ–¹æ³•å¯ä»¥é¿å…ä¸Šé¢å…©è€…çš„å½±éŸ¿ åŠ‡é€ä¸€ä¸‹ï¼šæœ‰çš„ï¼Œæœ‰ä¸€äº›æ‹›å¼å¯ä»¥è™•ç†ã€‚è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ã€‚\nGCP å¦‚ä½•çµ‚æ­¢è™›æ“¬æ©Ÿ å…ˆå è™›æ“¬æ©Ÿçš„ç¡¬é«”çµ‚æ­¢æ­¥é©Ÿèˆ‡ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿç›¸åŒï¼Œæ‰€ä»¥æˆ‘å€‘è¦å…ˆç†è§£è™›æ“¬æ©Ÿçš„åœæ­¢æµç¨‹\né€™è£¡æŒ‡çš„çµ‚æ­¢ (Stop) æ˜¯è™›æ“¬æ©Ÿç”Ÿå‘½é€±æœŸ çš„ RUNNING -\u0026gt; instances.stop() -\u0026gt; STOPPING -\u0026gt; TERMINATED çš„æ­¥é©Ÿã€‚\ninstances.stop() ACPI shutdown OS æœƒé€²è¡Œ shutdown æµç¨‹ï¼Œä¸¦å˜—è©¦åŸ·è¡Œå„å€‹æœå‹™çš„çµ‚æ­¢æµç¨‹ï¼Œä»¥å®‰å…¨çš„çµ‚æ­¢æœå‹™ã€‚å¦‚æœè™›æ“¬æ©Ÿæœ‰è¨­å®šShtudown Script æœƒåœ¨é€™æ­¥é©Ÿè™•ç† ç­‰å¾…è‡³å°‘ 90 ç§’ï¼Œè®“ OS å®Œæˆçµ‚æ­¢çš„æµç¨‹ é€¾æ™‚çš„çµ‚æ­¢æµç¨‹ï¼ŒGCP æœƒç›´æ¥å¼·åˆ¶çµ‚æ­¢ï¼Œå°±ç®— shutdown script é‚„æ²’è·‘å®Œ GCP ä¸ä¿è­‰çµ‚æ­¢æ™‚é™çš„æ™‚é–“ï¼Œå®˜æ–¹å»ºè­°ä¸è¦å¯«é‡è¦çš„ä¾è³´è…³æœ¬åœ¨çµ‚æ­¢æ™‚é™å…§ è™›æ“¬æ©Ÿè®Šæˆ TERMINATED ç‹€æ…‹ GCP å¦‚ä½•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ èˆ‡éš¨é¸è™›æ“¬æ©Ÿä¸åŒ\nå…ˆå è™›æ“¬æ©Ÿçš„æ™‚é–“ 30 ç§’ æ­é… GKE ä½¿ç”¨ Managed Instance Groupï¼Œçµ‚æ­¢çš„è™›æ“¬æ©Ÿæœƒè¢«åˆªé™¤ï¼ŒAutoscaler æœƒå•Ÿå‹•æ–°çš„è™›æ“¬æ©Ÿ ä¸€æ¨£å…ˆçœ‹å…ˆå è™›æ“¬æ©Ÿçš„èªªæ˜æ–‡ä»¶ï¼šçµ‚æ­¢æµç¨‹\nè³‡æ–™ä¸­å¿ƒé–‹å§‹å›æ”¶å…ˆå è™›æ“¬æ©Ÿï¼Œé¸ä¸­æˆ‘å€‘å°ˆæ¡ˆå…¶ä¸­çš„ä¸€å°å…ˆå è™›æ“¬æ©Ÿ Compute Engine å‚³é€ ACPI G2 Soft Offï¼Œé€™è£¡ OS æœƒè©¦åœ–å®‰å…¨é—œè®Šæœå‹™ï¼Œä¹ŸæœƒåŸ·è¡Œ shutdown scriptï¼Œå¯ä»¥åšç°¡çŸ­çš„å„ªé›…çµ‚æ­¢ 30ç§’å¾Œï¼ŒACPI G3 Mechanical off ä½† 30 ç§’èƒ½åšä»€éº¼ï¼Ÿåªèƒ½å¿«é€Ÿçš„äº¤ä»£ç•¶å‰é€²åº¦ã€‚å¦‚æœæ‡‰ç”¨éœ€è¦èŠ±æ™‚é–“æ”¶å°¾ï¼Œä¿å­˜å·¥ä½œé€²åº¦ï¼Œå¯èƒ½æœƒç”¢ç”Ÿè¨±å¤šå•é¡Œ\nGCP ä¸ä¿è­‰çµ‚æ­¢æ™‚é™çš„æ™‚é–“ï¼Œå®˜æ–¹å»ºè­°ä¸è¦å¯«é‡è¦çš„ä¾è³´è…³æœ¬åœ¨çµ‚æ­¢æ™‚é™å…§ åœ¨é¢å°å¤§é‡ IO çš„å·¥ä½œï¼Œå¯èƒ½æœƒå°è‡´è€…å°è™›æ“¬æ©Ÿçš„å¤§é‡æ‡‰ç”¨ä¸€èµ·é€²å…¥å„ªé›…çµ‚æ­¢ï¼Œå…ˆå è™›æ“¬æ©Ÿæœ€å¾Œè€—ç›¡è³‡æºï¼Œä¾†ä¸åŠåšå®Œ å¦‚æœå¯èƒ½æœƒè¶…æ™‚ï¼Œæˆ–æ˜¯æ²’å®Œæˆæœƒæœ‰è³‡æ–™éºå¤±é¢¨éšªï¼Œå°±ä¸èƒ½åœ¨é€™å€‹éšæ®µè™•ç† ä¾è³´ shutdown script åšæ”¶å°¾æ˜¯å±éšªçš„ï¼Œæˆ‘å€‘ä¹‹å¾Œè¦æƒ³è¾¦æ³•è™•ç†é€™å€‹ä¸ä¿è­‰åšå®Œçš„å„ªé›…çµ‚æ­¢ã€‚\nå¦‚æœæ‡‰ç”¨æœ¬èº«æœ‰å®¹éŒ¯çš„æ¡†æ¶ï¼Œæˆ–æ˜¯æœ‰å®¹éŒ¯æ©Ÿåˆ¶ï¼Œæˆ‘å€‘é€™é‚Šè¦é¡å¤–åšçš„å·¥ä½œå°±æœƒå°‘å¾ˆå¤šã€‚ä¾‹å¦‚è¨±å¤šç¨‹å¼æ¡†æ¶æä¾›è‡ªå‹•é‡å•Ÿçš„åŠŸèƒ½ï¼Œåœ¨å¤–éƒ¨ä¿å­˜ checkpointï¼Œworker åªè² è²¬é‹ç®—ï¼Œçµ‚æ­¢ä¿¡è™Ÿä¸€é€²ä¾†ï¼Œä¹Ÿä¸ç”¨ä¿å­˜ï¼Œç›´æ¥æ‹‹æ£„æœªå®Œæˆçš„å·¥ä½œé€²åº¦ï¼Œç•™å¾…ç¹¼èµ·çš„ worker å¾ checkpoint æ¥æ‰‹ã€‚\nPreemption selection é™¤äº† 24 å°æ™‚çš„å£½å‘½é™åˆ¶æœƒçµ‚æ­¢è™›æ“¬æ©Ÿï¼Œè³‡æ–™ä¸­å¿ƒçš„äº‹ä»¶ä¹Ÿæœƒè§¸ç™¼ä¸»å‹•çš„è™›æ“¬æ©Ÿå›æ”¶ï¼Œç”± GCP ä¸»å‹•è§¸ç™¼çš„å›æ”¶æ©Ÿåˆ¶æ©Ÿç‡å¾ˆä½ï¼Œæœƒæ ¹æ“šæ¯æ—¥æ¯å€‹å€åŸŸ (zone)Â çš„ç‹€æ…‹è€Œå®šã€‚é€™è£¡æè¿°è³‡æ–™ä¸­å¿ƒå•Ÿå‹•çš„è‡¨æ™‚å›æ”¶ã€‚\nGCP ä¸æœƒæŠŠæ‰€ä½ æ‰‹ä¸Šçš„ preemptible æ©Ÿå™¨éƒ½æ”¶èµ°ï¼Œè€Œæ˜¯ä¾ç…§ä¸€å®šçš„è¦å‰‡ï¼Œé¸æ“‡ä¸€å€‹æ¯”ä¾‹æ’¤æ›çš„æ©Ÿå™¨ã€‚\nå…ˆçœ‹æ–‡ä»¶æ•˜è¿°\nCompute Engine æœƒé¿å…å¾å–®ä¸€å®¢æˆ¶ç§»é™¤å¤ªå¤šå…ˆå è™›æ“¬æ©Ÿ å„ªå…ˆç§»é™¤æ–°çš„è™›æ“¬æ©Ÿï¼Œåå‘ä¿ç•™èˆŠçš„è™›æ“¬æ©Ÿ (ä½†æœ€å¤šä»æ´»ä¸é 24hr) é–‹å•Ÿå¾Œé¦¬ä¸Šè¢«ç§»é™¤çš„å…ˆå è™›æ“¬æ©Ÿä¸è¨ˆè²» æ©Ÿå™¨å°ºå¯¸è¼ƒå°çš„æ©Ÿå™¨ï¼Œå¯ç”¨æ€§è¼ƒé«˜ã€‚ä¾‹å¦‚ï¼š16 cpu çš„å…ˆå è™›æ“¬æ©Ÿï¼Œæ¯” 128 cpu çš„å…ˆå è™›æ“¬æ©Ÿå®¹æ˜“å–å¾— GCP æ¯å¤©å¹³å‡æœƒç§»é™¤ä¸€å€‹å°ˆæ¡ˆä¸­ 5% - 15% çš„è™›æ“¬æ©Ÿï¼Œå¾ç”¨æˆ¶çš„è§’åº¦æˆ‘å€‘éœ€è¦é æœŸè‡³å°‘é€™å€‹ç¨‹åº¦çš„å›æ”¶ã€‚ä¸éé€™å€‹æ¯”ä¾‹ï¼ŒGCP ä¹Ÿä¸çµ¦äºˆä»»ä½•ä¿è­‰ã€‚ä»¥ç­†è€…ç¶“é©—ï¼Œåªèƒ½èªªçµ•å¤§éƒ¨åˆ†çš„æ™‚å€™ï¼Œéƒ½ä¸æœƒæ“”å¿ƒè¶…éé€™å€‹æ¯”ä¾‹çš„å›æ”¶ï¼Œä½†æ˜¯é‚„æ˜¯è¦åšå¥½æœ€å£çš„æ‰“ç®—ï¼Œå¦‚æœè‡¨æ™‚ç„¡æ³•å–å¾—è¶³å¤ çš„å…ˆå è™›æ“¬æ©Ÿï¼Œè¦æœ‰æ–¹æ³•æš«æ™‚è£œè¶³éš¨é¸è™›æ“¬æ©Ÿã€‚\nGKE ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿæœƒé•å Kubernetes çš„è¨­è¨ˆ\nPod grace period æœƒè¢«å¿½ç•¥ Pod disreuption budgetï¼Œä¸æœƒè¢«éµå®ˆ (å¯èƒ½æœƒè¶…é) å°æ‡‰ç”¨çš„å½±éŸ¿ GCP è§¸ç™¼çš„ Preemptible processï¼Œå°æ‡‰ç”¨çš„å½±éŸ¿\ninvoluntary disruptionsï¼ŒGCP é€ ACPI G2 Soft Off OS çµ‚æ­¢æœå‹™ï¼ŒåŒ…å«åŸ·è¡Œ Kubernetes çš„ container runtime å®¹å™¨å…§çš„æ‡‰ç”¨æœƒæ”¶åˆ° SIGTERMï¼Œå•Ÿå‹• graceful shutdown Kubernetes æä¾›çš„ Graceful-shutdown å¯èƒ½æœƒè·‘ä¸å®Œ å¯¦å‹™ä¸Šåªæ˜¯ä¸­æ–·ç•¶å‰å·¥ä½œ https://cloud.google.com/solutions/scope-and-size-kubernetes-engine-clusters\nå¤§é‡ç¯€é»åŒæ™‚å›æ”¶ ç”±æ–¼ GCP ä¸¦ä¸ä¿è­‰æ”¶å›çš„æ©Ÿå™¨çš„æ•¸é‡ï¼ŒåŒæ™‚å›æ”¶çš„æ©Ÿå™¨é‡å¤§ï¼Œé‚„æ˜¯æœƒè¡æ“Šåˆ°æœå‹™ã€‚ä¾‹å¦‚ï¼šä¸€æ¬¡æ”¶å› 15% çš„ç®—åŠ›ï¼Œç•¶ç„¶æœå‹™é‚„æ˜¯æœƒå—åˆ°è¡æ“Šã€‚ç•¶ç„¶é€™æ¨£äº‹ä»¶çš„æ©Ÿç‡ä¸¦ä¸é«˜ï¼Œä½†æˆ‘å€‘ä»æ˜¯éœ€è¦ç‚ºæ­¤æ‰“ç®—ã€‚é€™é‚Šæœ‰å¹¾å€‹åšæ³•\né ç•™æ›´å¤šçš„ç®—åŠ› ä½¿ç”¨ regional clusterï¼Œåœ¨å¤šå€‹ zone ä¸Šåˆ†é…å…ˆå è™›æ“¬æ©Ÿ æˆ‘å€‘è‡ªè¡Œæ§åˆ¶ï¼Œæå‰ä¸»å‹•å›æ”¶è™›æ“¬æ©Ÿ é ç•™æ›´å¤šè³‡æº é€™é»å¾ˆç›´è§€ï¼Œç”±æ–¼ä½¿ç”¨äº†æ›´åŠ ä¾¿å®œçš„æ©Ÿå™¨ï¼Œæˆ‘å€‘å¯ä»¥ç”¨åŒæ¨£çš„æˆæœ¬ï¼Œé–‹æ›´å¤šçš„æ©Ÿå™¨ã€‚\né€€ä¸€æ­¥èªªï¼Œä½¿ç”¨æ‰“ä¸‰æŠ˜çš„å…ˆå è™›æ“¬æ©Ÿï¼Œç„¶å¾Œé–‹åŸæœ¬å…©å€çš„æ©Ÿå™¨æ•¸é‡\nç¸½æˆæœ¬æ˜¯ 0.3 * 2 = 0.6 å€ åŒæ™‚é–“å¯ç”¨è³‡æºæ˜¯ 2 å€ ç”±æ–¼å…ˆå ç¯€é»å›æ”¶çš„å–®ä½æ˜¯ä¸€å€‹ä¸€å€‹è™›æ“¬æ©Ÿ\nå®‰æ’åˆé©çš„æ©Ÿå™¨å°ºå¯¸ å°ºå¯¸è¼ƒå°çš„å…ˆå è™›æ“¬æ©Ÿï¼Œå¯ç”¨æ€§è¼ƒé«˜ã€‚æ„æ€æ˜¯é›¶ç¢çš„å…ˆå è™›æ“¬æ©Ÿå®¹æ˜“å–å¾— ä½†ç•¶ç„¶ä¹Ÿä¸èƒ½éƒ½é–‹å¤ªå°çš„æ©Ÿå™¨ï¼Œé€™æœƒåš´é‡å½±éŸ¿æ‡‰ç”¨çš„åˆ†é…ã€‚è‡³æ–¼å…·é«”éœ€è¦é–‹å¤šå¤§ï¼Œå¯ä»¥æ ¹æ“šé è¨ˆåœ¨æ©Ÿå™¨ä¸Šé‹è¡Œçš„æ‡‰ç”¨ï¼Œåšç¶œåˆè€ƒé‡ï¼Œä¾‹å¦‚æœ‰ä»¥ä¸‹å½±ç”¨éœ€è¦åŸ·è¡Œï¼š\napp A: 1 cpu 5 replica app B: 3 cpu 5 replica app C: 5 cpu 5 replica ç¸½å…±è‡³å°‘ 45 cpu ï¼Œé æœŸæ©Ÿå™¨è² è¼‰8 æˆçš„è©±ï¼Œéœ€è¦ç¸½å…± 45 / 0.8 = 56 cpuã€‚ä¹Ÿè¨±å¯ä»¥è€ƒæ…®\n8 cpu * 7 å…ˆå è™›æ“¬æ©Ÿ 4 cpu * 14 ä¹Ÿèˆ‰å¹¾å€‹æ¥µç«¯ä¸å¯è¡Œçš„ä¾‹å­\n56 cpu * 1 é€™æ¨£çš„è™›æ“¬æ©Ÿå›æ”¶æ™‚çš„å½±éŸ¿ç¯„åœ (blast radius) å°±æ˜¯ 100% æœå‹™ 1 cpu * 56 æ©Ÿå™¨å¤ªç‘£ç¢ï¼Œå¯èƒ½è¶…å‡º Qouta (ç¯€é»æ•¸é‡ï¼ŒIP æ•¸é‡\u0026hellip;) æ‡‰ç”¨æœƒæ›´åˆ†æ•£ï¼Œç¯€é»é–“çš„å…§éƒ¨ç¶²è·¯æµé‡æœƒå¢åŠ  å‰å¹¾ç¯‡æåˆ°çš„ reserved resource æ¯”ä¾‹é«˜ï¼Œæœƒå½±éŸ¿æ‡‰ç”¨çš„éƒ¨ç½² å¦‚æœå¸Œæœ›æ›´ä¿éšªï¼Œå¯ä»¥å†è£œä¸Šéš¨é¸è™›æ“¬æ©Ÿæ··åˆæ­é…ï¼Œä¾‹å¦‚\n8 cpu * 7 5 å…ˆå è™›æ“¬æ©Ÿ 2 éš¨é¸è™›æ“¬æ©Ÿ 4 cpu * 14 10 å…ˆå è™›æ“¬æ©Ÿ 4 éš¨é¸è™›æ“¬æ©Ÿ è™›æ“¬æ©Ÿå€åŸŸ è™›æ“¬æ©Ÿçš„å›æ”¶è§¸ç™¼ï¼Œä¹Ÿæ˜¯æœƒä¾æ“šæœå‹™çš„å€åŸŸ (zone) å›æ”¶ã€‚æ„æ€æ˜¯ç¯€é»å›æ”¶ä¸æœƒåŒæ™‚è§¸ç™¼ asia-east1 ä¸­æ‰€æœ‰ zone çš„ç¯€é»å›æ”¶ï¼Œä¸€èˆ¬ä¾†èªªæ™‚é–“æ˜¯éŒ¯é–‹çš„ (ä¸éGCP ä¹Ÿä¸ä¿è­‰é€™é» XD)ã€‚ç‚ºäº†ç¶­æŒ GKE çš„å¯ç”¨æ€§ï¼Œæˆ‘å€‘éƒ½æœƒé–‹å¤šå€‹ node-pool åœ¨å¤šå€‹å€åŸŸä¸‹ã€‚\nç¸½ä¹‹é¿å…æŠŠæ©Ÿå™¨éƒ½æ”¾åœ¨åŒå€‹å€åŸŸä¸­ã€‚\nè‡ªè¡Œæ§åˆ¶çš„è™›æ“¬æ©Ÿæ±°æ› ç°¡å–®ä¾†èªªæˆ‘å€‘åœ¨ 24 hr æœŸé™ä¹‹å‰ï¼Œå…ˆåˆ†æ‰¹è‡ªç›¡ XDï¼Œæ‰“æ•£å€‹å„å€‹è™›æ“¬æ©Ÿçš„ 24 å°æ™‚é™åˆ¶ã€‚\nä½¿ç”¨é€™å€‹æœ‰è¶£çš„å·¥å…· estafette-gke-preemptible-killerï¼Œè‡ªå‹•æ±°æ›å…ˆå è™›æ“¬æ©Ÿï¼Œè®“æ•´å€‹ç¹¼èµ·è™›æ“¬æ©Ÿéƒ½åˆ†æ•£åœ¨ 24 å°æ™‚é–“ã€‚\nestafette-gke-preemptible-killer ï¼Œä½¿ç”¨ä¸Šç°¡å–®ï¼Œå¤§å®¶è‡ªå·±çœ‹è‘—è¾¦ XDã€‚å¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œç•™è¨€çš„äººå¤šçš„è©±ï¼Œæˆ‘å†å¦å¤–é–‹ä¸€ç¯‡ç´°è¬›ã€‚\nå°çµ ç‚ºäº†ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œæˆ‘å€‘è¦å¤šåšä»¥ä¸‹å¹¾ä»¶äº‹\nç‚ºæ‡‰ç”¨è¨­è¨ˆå¯å®¹éŒ¯åˆ†æ•£å¼æ¶æ§‹ï¼Œä¾‹å¦‚æ‡‰ç”¨å¯ä»¥åŒæ™‚åŸ·è¡Œä¸€æ¨£çš„ API server 3 å€‹ replica åˆ†æ•£ Pod åˆ°åˆé©çš„æ©Ÿå™¨ä¸Šï¼Œä¾‹å¦‚è¨­ç½® PodAntiAffinity è¨­å®šåˆé©çš„è™›æ“¬æ©Ÿå¤§å°ï¼Œåˆé©çš„åˆ†æ•£æ‡‰ç”¨ ä½¿ç”¨ estafette-gke-preemptible-killerï¼Œè‡ªå‹•æ±°æ›å…ˆå è™›æ“¬æ©Ÿ ä¸ä¾è³´æ‡‰ç”¨çš„ Graceful-shutdown æµç¨‹ ","permalink":"https://chechia.net/posts/2020-09-23-gcp-preemptible-instance-speficication/","summary":"\u003ch1 id=\"å…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢æµç¨‹-preemption-process\"\u003eå…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢æµç¨‹ (Preemption process)\u003c/h1\u003e\n\u003cp\u003eå­æ›°ï¼šæœªçŸ¥ç”Ÿç„‰çŸ¥æ­»ã€‚ä½†åšå·¥ç¨‹å¸«è¦åéä¾†ï¼Œè€ƒé‡æœ€å·®æƒ…å½¢ï¼Œä¹Ÿå°±æ˜¯è¦çŸ¥é“æ‡‰ç”¨å¯èƒ½å¦‚ä½•æ­»å»ã€‚ä¸çŸ¥é“æ‡‰ç”¨å¯èƒ½æ€éº¼æ­»ï¼Œåˆ¥èªªä½ çŸ¥é“æ‡‰ç”¨æ´»å¾—å¥½å¥½çš„ï¼Œå¤§æ¦‚æƒ³è¡¨é”é€™éº¼æ„æ€ã€‚\u003c/p\u003e\n\u003cp\u003eé€™å°å…ˆå è™›æ“¬æ©Ÿä¾†èªªç‰¹åˆ¥é‡è¦ï¼Œä¸€èˆ¬æ‡‰ç”¨é¢å°çš„æ©Ÿå™¨æ•…éšœæˆ–æ˜¯æ©Ÿå™¨çµ‚æ­¢ï¼Œåœ¨ä½¿ç”¨å…ˆå è¥¿ä½ å¹¾çš„ç‹€æ³ä¸‹ï¼Œè®Šæˆæ¯æ—¥çš„å¿…ç„¶ï¼Œå› æ­¤ï¼Œéœ€è¦å°æ‡‰ç”¨çš„çµ‚æ­¢æƒ…å¢ƒï¼Œèˆ‡çµ‚æ­¢æµç¨‹æœ‰æ›´ç²¾ç´°çš„æŒæ§ã€‚å¦‚åŒå‰å¹¾ç¯‡æ‰€èªªçš„ï¼Œå…ˆå è™›æ“¬æ©Ÿæœƒè¢«å…¬æœ‰é›²æ”¶å›ï¼Œä½†æ”¶å›çš„æ™‚å€™ä¸æœƒçªç„¶æ©Ÿå™¨å°± ben ä¸è¦‹ï¼Œæœƒæœ‰ä¸€å€‹å›ºå®šçš„æµç¨‹ã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœä½ çš„æ‡‰ç”¨å·²ç¶“å¸¶æœ‰å¯å®¹éŒ¯çš„æ©Ÿåˆ¶ï¼Œèƒ½å¤ æ‰¿å—æ©Ÿå™¨çªç„¶è®Šä¸è¦‹ï¼Œæœå‹™é‚„å¥½å¥½çš„ï¼Œä»ç„¶è¦èŠ±æ™‚é–“ç†è§£é€™é‚Šçš„æµç¨‹ï¼Œè—‰æ­¤ç²¾ç®—æ¯å¤©è™›æ“¬æ©Ÿçš„çµ‚æ­¢èˆ‡æ›¿æ›ï¼šæ‡‰ç”¨æœƒæœ‰ä»€éº¼åæ‡‰ï¼Œæœƒç”¢ç”Ÿå¤šå°‘è¡æ“Šï¼Œç¨å¾Œå¯ä»¥é‡åŒ–æœå‹™çš„å½±éŸ¿ã€‚ä¾‹å¦‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ‡‰ç”¨é‡å•Ÿåˆå§‹åŒ–æ™‚ cpu memory çªç„¶æ‹‰é«˜\u003c/li\u003e\n\u003cli\u003eæ‰¿å—ç¯€é»éŒ¯èª¤å¾Œçš„å¾©åŸæµç¨‹ï¼Œéœ€è¦æ¶ˆè€—é¡å¤–ç®—åŠ›ã€‚ä¾‹å¦‚éœ€è¦å¾ä¸Šå€‹ checkpoint æ¥çºŒåšï¼Œéœ€è¦å»è®€å–è³‡æ–™é€ æˆ IOï¼Œæˆ–æ˜¯è³‡æ–™éœ€è¦åš rebalance \u0026hellip;ç­‰ç­‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå¦‚æœä½ çš„æ‡‰ç”¨éœ€è¦æœ‰ graceful shutdown çš„æ©Ÿåˆ¶ï¼Œé‚£ä½ å‹™å¿…è¦ç´°å¿ƒç†è§£é€™é‚Šçš„æ­¥é©Ÿã€‚ä¸¦ä»”ç´°å®‰æ’å®‰å…¨ä¸‹æ¨çš„æ­¥é©Ÿã€‚åˆæˆ–æ˜¯ç„¡æ³•ä¿è­‰åœ¨å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„ä½œæ¥­æ™‚é™å…§ï¼Œå®Œæˆå„ªé›…çµ‚æ­¢ï¼Œéœ€è¦è€ƒæ…®å…¶ä»–å¯èƒ½çš„å¯¦ä½œè§£æ³•ã€‚\u003c/p\u003e\n\u003cp\u003eé€™é‚Šæœ‰å¹¾å€‹é¢å‘è¦æ³¨æ„\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eGCP å¦‚ä½•çµ‚æ­¢å…ˆå ç¯€é»\u003c/li\u003e\n\u003cli\u003eGCP ç§»é™¤ç¯€é»å° GKE ã€ä»¥åŠåŸ·è¡Œä¸­æ‡‰ç”¨çš„å½±éŸ¿\u003c/li\u003e\n\u003cli\u003eGKE é›†ç¾¤å¦‚ä½•æ‡‰å°çš„ç¯€é»å¤±æ•ˆ\u003c/li\u003e\n\u003cli\u003eGCP è‡ªå‹•èª¿åº¦è£œè¶³æ–°çš„å…ˆå ç¯€é»\u003c/li\u003e\n\u003cli\u003eGKE é›†ç¾¤å¦‚ä½•æ‡‰å°ç¯€é»è£œè¶³\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eä¸‰å€‹é‡é»\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå…ˆå è™›æ“¬æ©Ÿçµ‚æ­¢å°é›†ç¾¤çš„å½±éŸ¿\u003c/li\u003e\n\u003cli\u003ePod éš¨ä¹‹çµ‚æ­¢å°æ‡‰ç”¨çš„å½±éŸ¿ï¼Œæ˜¯å¦èƒ½å¤ å„ªé›…çµ‚æ­¢\u003c/li\u003e\n\u003cli\u003eæœ‰æ²’æœ‰æ–¹æ³•å¯ä»¥é¿å…ä¸Šé¢å…©è€…çš„å½±éŸ¿\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eåŠ‡é€ä¸€ä¸‹ï¼šæœ‰çš„ï¼Œæœ‰ä¸€äº›æ‹›å¼å¯ä»¥è™•ç†ã€‚è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ã€‚\u003c/p\u003e\n\u003ch3 id=\"gcp-å¦‚ä½•çµ‚æ­¢è™›æ“¬æ©Ÿ\"\u003eGCP å¦‚ä½•çµ‚æ­¢è™›æ“¬æ©Ÿ\u003c/h3\u003e\n\u003cp\u003eå…ˆå è™›æ“¬æ©Ÿçš„ç¡¬é«”çµ‚æ­¢æ­¥é©Ÿèˆ‡ä¸€èˆ¬éš¨é¸è™›æ“¬æ©Ÿç›¸åŒï¼Œæ‰€ä»¥æˆ‘å€‘è¦å…ˆç†è§£\u003ca href=\"https://cloud.google.com/compute/docs/instances/stop-start-instance\"\u003eè™›æ“¬æ©Ÿçš„åœæ­¢æµç¨‹\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eé€™è£¡æŒ‡çš„çµ‚æ­¢ (Stop) æ˜¯\u003ca href=\"https://cloud.google.com/compute/docs/instances/instance-life-cycle\"\u003eè™›æ“¬æ©Ÿç”Ÿå‘½é€±æœŸ\u003c/a\u003e çš„ RUNNING -\u0026gt; instances.stop() -\u0026gt; STOPPING -\u0026gt; TERMINATED çš„æ­¥é©Ÿã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003einstances.stop()\u003c/li\u003e\n\u003cli\u003eACPI shutdown\u003c/li\u003e\n\u003cli\u003eOS æœƒé€²è¡Œ shutdown æµç¨‹ï¼Œä¸¦å˜—è©¦åŸ·è¡Œå„å€‹æœå‹™çš„çµ‚æ­¢æµç¨‹ï¼Œä»¥å®‰å…¨çš„çµ‚æ­¢æœå‹™ã€‚å¦‚æœè™›æ“¬æ©Ÿæœ‰è¨­å®š\u003ca href=\"https://cloud.google.com/compute/docs/shutdownscript\"\u003eShtudown Script\u003c/a\u003e æœƒåœ¨é€™æ­¥é©Ÿè™•ç†\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://cloud.google.com/compute/docs/instances/deleting-instance\"\u003eç­‰å¾…è‡³å°‘ 90 ç§’\u003c/a\u003eï¼Œè®“ OS å®Œæˆçµ‚æ­¢çš„æµç¨‹\n\u003cul\u003e\n\u003cli\u003eé€¾æ™‚çš„çµ‚æ­¢æµç¨‹ï¼ŒGCP æœƒç›´æ¥å¼·åˆ¶çµ‚æ­¢ï¼Œå°±ç®— shutdown script é‚„æ²’è·‘å®Œ\u003c/li\u003e\n\u003cli\u003eGCP ä¸ä¿è­‰çµ‚æ­¢æ™‚é™çš„æ™‚é–“ï¼Œå®˜æ–¹å»ºè­°ä¸è¦å¯«é‡è¦çš„ä¾è³´è…³æœ¬åœ¨çµ‚æ­¢æ™‚é™å…§\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè™›æ“¬æ©Ÿè®Šæˆ TERMINATED ç‹€æ…‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"gcp-å¦‚ä½•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ\"\u003eGCP å¦‚ä½•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ\u003c/h3\u003e\n\u003cp\u003eèˆ‡éš¨é¸è™›æ“¬æ©Ÿä¸åŒ\u003c/p\u003e","title":"Gcp Preemptible Instance Speficication"},{"content":"æˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\nåŸ·è¡ŒçŸ­æœŸçš„ batch job åŸ·è¡Œé•·æœŸçš„ user-facing API server åŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº« è©²ä¸è©²åœ¨ Kubernetes ä¸Šé¢è·‘ databaseï¼Ÿ\nTL;DR ï¼Œå¦‚æœä½ å‰›é–‹å§‹è€ƒæ…®é€™ä»¶äº‹ï¼Œé€šå¸¸çš„ç­”æ¡ˆéƒ½æ˜¯å¦å®šçš„\nç­‰ç­‰ï¼Œæˆ‘å€‘é€™é‚Šä¸æ˜¯è¨è«–è©²ä¸è©²ä¸Š Kuberentes ï¼Œè€Œæ˜¯è©²ä¸è©²ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå§ã€‚ç„¶è€Œç”±æ–¼å…ˆå è™›æ“¬æ©Ÿç¯€é»çš„è«¸å¤šé™åˆ¶ï¼Œå…‰æ†‘å…ˆå è™›æ“¬æ©Ÿä¸¦ä¸é©åˆè·‘ä»»ä½•æŒä¹…æ€§çš„å„²å­˜åº«ã€‚æˆ‘å€‘é€™é‚Šä»°è³´ Kubernetes çš„ç¶²è·¯åŠŸèƒ½ (e.g. æœå‹™ç™¼ç¾)ï¼Œèˆ‡è‡ªå‹•ç®¡ç† (e.g. health checkï¼ŒHPAï¼Œauto-scaler)ï¼ŒåŸºæ–¼å…ˆå è™›æ“¬æ©Ÿï¼Œå»ºæ§‹é«˜å¯ç”¨æ€§çš„æœå‹™æ¶æ§‹ï¼Œä¾†æ”¯æ’é«˜å¯ç”¨ï¼Œä¸”æœ‰ç‹€æ…‹çš„çš„å„²å­˜åº«ã€‚\næ‡‰ç”¨æ˜¯å¦é©åˆéƒ¨ç½²åˆ° Kubernetes ä¸Šï¼Œå¯ä»¥çœ‹é€™ç¯‡ Google Blog: To run or not to run a database on Kubernetes: What to considerï¼Œå¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œå†ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å†é€²è¡Œä¸­æ–‡ç¿»è­¯ã€‚\næ–‡ä¸­é‡å°ä¸‰å€‹å¯èƒ½çš„æ–¹æ¡ˆåšåˆ†æï¼Œä»¥ MySQL ç‚ºä¾‹ï¼š\nSassï¼ŒGCP çš„ Cloud SQL æœ€ä½çš„ç®¡ç†ç¶­é‹æˆæœ¬ è‡ªæ¶ MySQL åœ¨ GCP çš„ VM ä¸Šï¼Œè‡ªè¡Œç®¡ç† è‡ªè² å®Œå…¨çš„ç®¡ç†è²¬ä»»ï¼ŒåŒ…å«å¯ç”¨æ€§ï¼Œå‚™ä»½ (backup)ï¼Œä»¥åŠå®¹éŒ¯ç§»è½‰ (failover) è‡ªæ¶ MySQL åœ¨ Kubernetes ä¸Š è‡ªè² å®Œå…¨çš„ç®¡ç†è²¬ä»» Kubernetes çš„è¤‡é›œæŠ½è±¡å±¤ï¼ŒæœƒåŠ é‡ç¶­é‹å·¥ä½œçš„è¤‡é›œç¨‹åº¦ ç„¶è€Œ RDBMS çš„æä¾›å•†ï¼Œè‡ªå®¶ä¹Ÿæä¾› Operator\nOracle è‡ªå®¶æä¾›çš„ MySQL Operator CrunchyData ä¹Ÿæœ‰æä¾›çš„ Postgres Operator ä½ å°±æƒ³ï¼Œæ‰€ä»¥é€™äº›äººæ˜¯æƒ³æ€æ¨£ï¼ŒRDBMS æ”¾ Kubernetes ä¸Šåˆ°åº•æ˜¯è¡Œä¸è¡Œ XDã€‚Google çš„æ–‡ç« èªªæ˜ï¼šå¦‚æœæ‡‰ç”¨æœ¬èº«ä¸¦ä¸ç¬¦åˆ Kubernetes çš„å·¥ä½œæµç¨‹ (Pod life-cycle)ï¼Œå¯ä»¥é€éä¸Šè¿°çš„ Operator ä¾†è‡ªå‹•åŒ–è¨±å¤šç¶­é‹çš„ä½œæ¥­ï¼Œé™ä½ç¶­é‹çš„å›°é›£ã€‚\nç„¶è€Œ DB æœ‰åƒç™¾ç¨®ï¼Œé™¤äº† RDBMS ä»¥å¤–ï¼Œé‚„æœ‰å¦å¤–ä¸€æ‰¹ Database å¤©ç”Ÿå°±å…·æœ‰åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œé€™äº›å„²å­˜åº«éƒ¨ç½²åˆ° Kubernetes ä¸Šï¼Œä¸¦ä¸æœƒå¤ªç—›è‹¦ (é‚„æ˜¯è¦ä»˜å‡ºä¸€å®šçš„æˆæœ¬XD)ï¼Œä½†æ˜¯å»å¯ä»¥å¾—ç›Šæ–¼ Kubernetes çš„è«¸å¤šåŠŸèƒ½ã€‚\nåº•ä¸‹æˆ‘å€‘å…ˆæ ¹æ“šåˆ†æ•£å¼çš„å„²å­˜åº«åšæ¦‚è§€æè¿°ï¼Œæœ¬ç³»åˆ—æ–‡çš„æœ€å¾Œï¼Œæœƒæ ¹æ“šæ™‚é–“ç‹€æ³ï¼Œåšå¯¦ä¾‹åˆ†äº«ï¼šCassandra æˆ–æ˜¯ CockroachDBã€‚æä¾›å„ä½ä¸€é»ç™¼æƒ³ï¼Œä¸¦æ ¹æ“šéœ€æ±‚å»é¸æ“‡éœ€è¦çš„å„²å­˜åº«\nã€Œè¡Œä¸è¡Œè¦å•ä½ è‡ªå·±äº†æ–½ä¸»ï¼ŒæŠ€è¡“ä¸Šéƒ½å¯ä»¥ï¼Œç¶­é‹ä¸Šè¦çœ‹çœ‹ä½ çš„åœ˜éšŠæœ‰æ²’æœ‰é‚£å€‹å±è‚¡åƒé€™ä»½è—¥ XDã€\nDistributed Database åº•ä¸‹éå¸¸ç²—æ·ºçš„ç°¡ä»‹åˆ†æ•£å¼å„²å­˜åº«çš„æ¦‚å¿µï¼Œæä¾›ä¸€å€‹åŸºæº–é»ï¼Œå¹«åŠ©æ¥ä¸‹ä¾†è¨è«–æ˜¯å¦å¯ä»¥ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿã€‚é€™é‚Šè¦å¼·èª¿ï¼Œå„²å­˜åº«çš„é¡å‹åƒç™¾ç¨®ï¼Œåº•å±¤çš„å„ç¨®å¯¦ä½œå·®ç•°éƒ½éå¸¸å¤§ï¼Œåº•ä¸‹çš„æ¨¡å‹æ˜¯åŸºæ–¼ cassandra ä½†ä¸æœƒèµ°å¤ªå¤šç´°ç¯€ã€‚ cassandra çš„è¦æ ¼æœ‰æ©Ÿæœƒå†ç´°èŠã€‚\nç•¶å¾Œç«¯æ‡‰ç”¨å·²ç¶“é †åˆ©æ°´å¹³æ‹“å±•ä¹‹å¾Œï¼Œæ•´é«”æœå‹™çš„æ•ˆèƒ½ç“¶é ¸å¾€å¾€éƒ½å£“åœ¨å¾Œç«¯ DB ä¸Šã€‚é€™äº›ä¸åŒçš„ DB é¢å‘ä¸åŒçš„éœ€æ±‚ï¼Œç•¶éœ€æ±‚ç¬¦åˆæ™‚ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨é€™äº›è§£æ±ºæ–¹æ³•ã€‚\né€™é‚Šè¦å¼·èª¿ï¼Œä¸æ˜¯æ”¾æ£„ç¾æœ‰çš„ RDBMS ï¼Œå®Œå…¨ç§»è½‰åˆ°æ–°çš„è³‡æ–™åº«ï¼Œé€™æ¨£çš„æˆæœ¬å¤ªé«˜ï¼Œä¹Ÿæ²’æœ‰å¿…è¦æ€§ã€‚æ›´å¥½çš„åšæ³•ï¼Œæ˜¯æ­é…æ—¢æœ‰çš„é—œè¯æ€§è³‡æ–™åº«ï¼Œå°‡ä¸æ˜¯æ ¸å¿ƒæ¥­å‹™çš„è³‡æ–™è™•ç†æŠ½å‡ºï¼Œç§»è½‰åˆ°åˆé©çš„è³‡æ–™åº«ä¸Šã€‚è®“ä¸åŒéœ€æ±‚çš„è³‡æ–™å„²å­˜åˆ°æ›´åˆé©çš„å„²å­˜åº«ï¼Œæ˜¯é€™æ®µè©±è¦å¼·èª¿çš„é‡é»ï¼Œé—œé€£å¼è³‡æ–™åº«ä¹Ÿä¸æ˜¯å”¯ä¸€é¸æ“‡ã€‚\nåˆ†æ•£å¼çš„è³‡æ–™åº«æœ‰ä»¥ä¸‹ç‰¹å¾µ\nåˆ†æ•£å¼ç¯€é»é›†ç¾¤ (Cluster)ï¼šè³‡æ–™åº«æ˜¯å¤šå€‹ç¯€é»å…±å­˜ï¼Œè€Œé single master, multiple slaves çš„æ¶æ§‹ é…åˆå…±è­˜ç®—æ³• (consensus algorithm) æºé€šç¯€é»ä¹‹é–“çš„è³‡è¨Š ç„¡å–®é»éŒ¯èª¤ (Single-point failure)ï¼še.g. ä¸æœƒå› ç‚º master éŒ¯èª¤å°è‡´æ•´å€‹æœå‹™å¤±æ•ˆ é«˜å¯ç”¨(High Availitilityï¼šå¯ä»¥æ‰¿å—é›†ç¾¤ä¸­ä¸€å®šæ•¸é‡è™›æ“¬æ©Ÿæ•…éšœï¼Œæœå‹™ä»ç„¶å¯ç”¨ è³‡æ–™ sharding åˆ°ä¸åŒç¯€é»ä¸Š è¤‡æœ¬ (replica) ç¯€é»è¤‡æœ¬ (node replicas)ï¼šå¤šå€‹ç¯€é»æä¾›æœå‹™ï¼Œæä¾›æµé‡çš„å¸¶å¯¬èˆ‡å¯ç”¨æ€§ è³‡æ–™è¤‡æœ¬ (data replicas)ï¼šåœ¨å¤šå€‹ç¯€é»ä¸Šå„²å­˜è³‡æ–™ï¼Œæä¾›è³‡æ–™çš„å‚™ä»½ï¼ŒåŒæ™‚ä¹Ÿæä¾›è®€å–å¸¶å¯¬èˆ‡å¯ç”¨æ€§ å¾ä»¥ä¸Šç‰¹å¾µä¾†èªªï¼Œä½¿ç”¨æ­¤æ¶æ§‹çš„æœå‹™å¯ä»¥æ‰¿å—å…ˆå è™›æ“¬æ©Ÿçš„ä¸å®šæ™‚çµ‚æ­¢ï¼Œæˆ–è¨±å¯ä»¥ä½¿ç”¨ã€‚\nå¯¦å‹™ä¸Šæœ‰éå¸¸å¤šéœ€è¦æ³¨æ„ï¼Œéœ€è¦ä¾æ“šå„è‡ªæœå‹™çš„æ€§è³ªï¼Œå„è‡ªè™•ç†ã€‚å¸¸è¦‹çš„å•é¡Œèˆ‰ä¾‹å¦‚ä¸‹ï¼š\næ‡‰ç”¨å¯ä»¥å®¹éŒ¯ (fault-tolerent)ï¼Œç„¶è€ŒéŒ¯èª¤ç™¼ç”Ÿå¾Œï¼Œæœƒéœ€è¦æ¶ˆè€—å¾©åŸæˆæœ¬ï¼Œä¾‹å¦‚é‡å•Ÿå¾Œéœ€è¦èŠ±æ™‚é–“åˆå§‹åŒ–ï¼Œæˆ–æ˜¯åœ¨å¤šç¯€é»ä¸Šé€²è¡Œ data rebalanceã€‚ å¯ä»¥æ‰¿å—çªç„¶çš„éŒ¯èª¤ï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿï¼Œè®Šæˆæ¯æ—¥å›ºå®šæœƒæ‰¿å—å¿…ç„¶çš„éŒ¯èª¤ã€‚é€™è£¡çŠ§ç‰²äº†éƒ¨åˆ†ç®—åŠ›ï¼Œç”šè‡³é€ æˆéš±æ€§çš„ç¶­è­·æˆæœ¬ï¼Œæœ€å¾Œæ˜¯å¦ç¬¦åˆç¯€çœæˆæœ¬çš„éœ€æ±‚ã€‚ éƒ½æ˜¯éœ€è¦ä»”ç´°äº†è§£è§£æ±ºæ–¹æ¡ˆï¼Œä¸¦ä¸”åˆ†æéœ€æ±‚ï¼Œä¾†è©•ä¼°æ˜¯å¦æœ‰åˆä¹æˆæœ¬ã€‚\nGKE ä»¥ä¸Šåˆ†æäº†ä¸‰ç¨®å¸¸è¦‹éœ€æ±‚ä¾‹å­ï¼šå¾ batch jobï¼Œuser-facing serviceï¼Œèˆ‡ distributed databaseã€‚æ˜å¤©æœƒå¯¦éš›æ¬å‡º GKE èˆ‡ GCP Preemptible Instance çš„æŠ€è¡“è¦æ ¼ï¼Œèˆ‡å¤§å®¶å¯¦éš›è¨è«–ã€‚\n","permalink":"https://chechia.net/posts/2020-09-22-gcp-preemptible-instance-requirement-distributed/","summary":"\u003cp\u003eæˆ‘å€‘ä»¥ä¸‹å¹¾å€‹éœ€æ±‚ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåŸ·è¡ŒçŸ­æœŸçš„ batch job\u003c/li\u003e\n\u003cli\u003eåŸ·è¡Œé•·æœŸçš„ user-facing API server\u003c/li\u003e\n\u003cli\u003eåŸ·è¡Œé•·æœŸçš„ stateful è³‡æ–™åº«ã€å„²å­˜åº«\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè©²ä¸è©²åœ¨ Kubernetes ä¸Šé¢è·‘ databaseï¼Ÿ\u003c/p\u003e\n\u003cp\u003eTL;DR ï¼Œå¦‚æœä½ å‰›é–‹å§‹è€ƒæ…®é€™ä»¶äº‹ï¼Œé€šå¸¸çš„ç­”æ¡ˆéƒ½æ˜¯å¦å®šçš„\u003c/p\u003e\n\u003cp\u003eç­‰ç­‰ï¼Œæˆ‘å€‘é€™é‚Šä¸æ˜¯è¨è«–è©²ä¸è©²ä¸Š Kuberentes ï¼Œè€Œæ˜¯è©²ä¸è©²ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå§ã€‚ç„¶è€Œç”±æ–¼å…ˆå è™›æ“¬æ©Ÿç¯€é»çš„è«¸å¤šé™åˆ¶ï¼Œå…‰æ†‘å…ˆå è™›æ“¬æ©Ÿä¸¦ä¸é©åˆè·‘ä»»ä½•æŒä¹…æ€§çš„å„²å­˜åº«ã€‚æˆ‘å€‘é€™é‚Šä»°è³´ Kubernetes çš„ç¶²è·¯åŠŸèƒ½ (e.g. æœå‹™ç™¼ç¾)ï¼Œèˆ‡è‡ªå‹•ç®¡ç† (e.g. health checkï¼ŒHPAï¼Œauto-scaler)ï¼ŒåŸºæ–¼å…ˆå è™›æ“¬æ©Ÿï¼Œå»ºæ§‹é«˜å¯ç”¨æ€§çš„æœå‹™æ¶æ§‹ï¼Œä¾†æ”¯æ’é«˜å¯ç”¨ï¼Œä¸”æœ‰ç‹€æ…‹çš„çš„å„²å­˜åº«ã€‚\u003c/p\u003e\n\u003cp\u003eæ‡‰ç”¨æ˜¯å¦é©åˆéƒ¨ç½²åˆ° Kubernetes ä¸Šï¼Œå¯ä»¥çœ‹é€™ç¯‡ \u003ca href=\"https://cloud.google.com/blog/products/databases/to-run-or-not-to-run-a-database-on-kubernetes-what-to-consider\"\u003eGoogle Blog: To run or not to run a database on Kubernetes: What to consider\u003c/a\u003eï¼Œå¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œå†ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å†é€²è¡Œä¸­æ–‡ç¿»è­¯ã€‚\u003c/p\u003e\n\u003cp\u003eæ–‡ä¸­é‡å°ä¸‰å€‹å¯èƒ½çš„æ–¹æ¡ˆåšåˆ†æï¼Œä»¥ MySQL ç‚ºä¾‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSassï¼ŒGCP çš„ Cloud SQL\n\u003cul\u003e\n\u003cli\u003eæœ€ä½çš„ç®¡ç†ç¶­é‹æˆæœ¬\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè‡ªæ¶ MySQL åœ¨ GCP çš„ VM ä¸Šï¼Œè‡ªè¡Œç®¡ç†\n\u003cul\u003e\n\u003cli\u003eè‡ªè² å®Œå…¨çš„ç®¡ç†è²¬ä»»ï¼ŒåŒ…å«å¯ç”¨æ€§ï¼Œå‚™ä»½ (backup)ï¼Œä»¥åŠå®¹éŒ¯ç§»è½‰ (failover)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè‡ªæ¶ MySQL åœ¨ Kubernetes ä¸Š\n\u003cul\u003e\n\u003cli\u003eè‡ªè² å®Œå…¨çš„ç®¡ç†è²¬ä»»\u003c/li\u003e\n\u003cli\u003eKubernetes çš„è¤‡é›œæŠ½è±¡å±¤ï¼ŒæœƒåŠ é‡ç¶­é‹å·¥ä½œçš„è¤‡é›œç¨‹åº¦\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç„¶è€Œ RDBMS çš„æä¾›å•†ï¼Œè‡ªå®¶ä¹Ÿæä¾› Operator\u003c/p\u003e","title":"Gcp Preemptible Instance Requirement Distributed"},{"content":"å‰è¨€ éµäººè³½çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¦å¸¶ä¾†å…¬æœ‰é›²çœéŒ¢ç³»åˆ—æ–‡ç« ã€‚\næ¶æ§‹çš„æˆæœ¬ï¼Œå¾ˆå¤šæ™‚å€™æœƒå½±éŸ¿æ¶æ§‹çš„è¨­è¨ˆèˆ‡éœ€æ±‚ã€‚å…¬å¸çš„ç‡Ÿé‹éƒ½éœ€è¦åœ¨æˆæœ¬èˆ‡éœ€æ±‚ä¹‹å‰å¹³è¡¡ï¼Œæˆæœ¬å…¶å¯¦æ˜¯å½±éŸ¿å…¬å¸æ±ºç­–çš„é‡è¦å› ç´ ã€‚èº«ç‚ºæ¶æ§‹ç®¡ç†å“¡ï¼Œæ‡‰è©²è¦è©¦è‘—é‡åŒ–ä¸¦ä¸”é€²è¡Œæˆæœ¬ç®¡ç†ï¼Œæå‡ºè§£æ±ºæ–¹æ¡ˆæ™‚ï¼Œä¹Ÿéœ€è¦æ€è€ƒå¦‚ä½•å¹«å…¬å¸é–‹æºç¯€æµã€‚\nä¸€æ˜§æ¶ˆæ¸›æ¶æ§‹çš„æˆæœ¬ä¹Ÿæœªå¿…æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå¸³é¢ä¸Šæ¶ˆæ¸›çš„æˆæœ¬æœ‰æ™‚ä¹Ÿæœƒåæ˜ åœ¨å…¶ä»–åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨æ¯”è¼ƒä¾¿å®œçš„è§£æ±ºæ–¹æ¡ˆï¼Œæˆ–æ˜¯è¼ƒä½çš„ç®—åŠ›ï¼Œä½†å»é€ æˆç¶­é‹éœ€è¦èŠ±æ›´å¤šæ™‚é–“ç¶­è­·ï¼Œé€ æˆéš±æ€§çš„äººåŠ›æˆæœ¬æ¶ˆè€—ã€‚ç”¨ä»€éº¼æ›¿ä»£æ–¹æ¡ˆ (trade-off) çœäº†é€™äº›éŒ¢ã€‚\nKubernetes æ˜¯ä¸€å€‹å¾ˆå¥½çš„ä¾‹å­ï¼šä¾‹å¦‚ï¼šæœ‰äººèªªã€ŒKubernetes å¯ä»¥çœéŒ¢ã€ï¼Œä½†ä¹Ÿæœ‰äººèªªã€ŒKubernetes ç”¢ç”Ÿçš„ Overhead å¤ªé‡æœƒè™§éŒ¢ã€ã€‚\nã€Œè¦ä¸è¦å°å…¥ Kubernetes æ˜¯ä¸€å€‹å¥½å•é¡Œã€ã€‚æ‡‰è©²å›æ­¸åŸºæœ¬çš„éœ€æ±‚ï¼Œäº†è§£éœ€æ±‚æ˜¯ä»€éº¼ã€‚ä¾‹å¦‚ï¼šGoogle ç•¶åˆé–‹ç™¼å®¹å™¨ç®¡ç†å¹³å°ï¼Œæ˜¯é¢å°ä»€éº¼æ¨£çš„ä½¿ç”¨éœ€æ±‚ï¼Œæœ€çµ‚é–‹ç™¼å‡º Kubernetesï¼Œå„ä½å¯ä»¥å›é¡§å‰ç¯‡æ–‡ç« ã€ŒBorg Omega and Kuberneteï¼ŒKubernetes çš„å‰æ—¥ä»Šç”Ÿï¼Œèˆ‡ Google åé¤˜å¹´çš„å®¹å™¨åŒ–æŠ€è¡“ã€ï¼Œå¾ Google çš„è§’åº¦ç†è§£å®¹å™¨ç®¡ç†å¹³å°ï¼Œåæ€è‡ªèº«åœ˜éšŠçš„å¯¦éš›éœ€æ±‚ã€‚\né€™å¥—è§£æ±ºæ–¹æ¡ˆæ˜¯å¦çœŸçš„é©åˆåœ˜éšŠï¼Œè§£æ±ºæ–¹æ¡ˆå¸¶ä¾†çš„æ•ˆæœåˆ°åº•æ˜¯æ€æ¨£å‘¢ï¼Ÿå¸Œæœ›çœ‹å®Œé€™ç³»åˆ—æ–‡ç« å¾Œï¼Œèƒ½å¹«åŠ©å„ä½ï¼Œå¾æˆæœ¬é¢æ€è€ƒé€™äº›é‡è¦çš„å•é¡Œã€‚\né€™ç¯‡ä½¿ç”¨ GCP çš„åŸå› ï¼Œé™¤äº†æ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„å…¬æœ‰é›²å¤–ï¼Œä¹Ÿæ˜¯å› ç‚º GCP æä¾›çš„å…è²»é¡åº¦ï¼Œè®“æˆ‘å¯ä»¥å¾ˆè¼•é¬†åœ°ä½œç‚ºç¤¾ç¾¤æ–‡ç« çš„ Demoï¼Œå¦‚æœæœ‰åˆ¥å®¶é›²å¹³å°æœ‰æä¾›ç›¸åŒæ–¹æ¡ˆï¼Œè«‹ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å¯èƒ½å°±æœƒå¤šé–‹å¹¾å®¶ä¸åŒçš„ç¯„ä¾‹ã€‚\nå…ˆå è™›æ“¬æ©Ÿ TL;DR å…ˆå è™›æ“¬æ©Ÿç‚ºéš¨é¸è™›æ“¬æ©Ÿå®šåƒ¹çš„ 2-3 æŠ˜ï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå¯èƒ½å¯ä»¥ç¯€çœ 7 æˆçš„é›²å¹³å°æ”¯å‡º å…ˆå è™›æ“¬æ©Ÿæ¯”èµ·éš¨é¸è™›æ“¬æ©Ÿï¼Œå¤–åŠ æœ‰è«¸å¤šé™åˆ¶ï¼Œe.g. æœ€é•·å£½å‘½ 24 hrã€é›²å¹³å°æœƒä¸»å‹•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ\u0026hellip;ç­‰ é…åˆä½¿ç”¨è‡ªå‹•æ°´å¹³æ“´å±• (auto-scaler)ï¼Œè®“èˆŠçš„å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„åŒæ™‚ï¼Œå»è³¼è²·æ–°çš„å…ˆå è™›æ“¬æ©Ÿ é…åˆå¯å®¹éŒ¯ (fault-tolerent) çš„åˆ†æ•£å¼æ‡‰ç”¨ï¼Œè®“æ‡‰ç”¨å¯ä»¥ç„¡ç—›åœ¨è™›æ“¬æ©Ÿåˆ‡æ›è½‰ç§»ï¼Œä¸å½±éŸ¿æœå‹™ è¦è®“æ‡‰ç”¨å¯ä»¥å®¹éŒ¯ï¼Œéœ€è¦åšéå¸¸å¤šäº‹æƒ… æ­é… kubernetes ï¼Œè‡ªå‹•åŒ–ç®¡ç†ä¾†ç°¡åŒ–å·¥ä½œ é…åˆæ­£ç¢ºçš„è¨­å®šï¼Œå¯ä»¥ç©©å®šçš„åŸ·è¡Œæœ‰ç‹€æ…‹çš„åˆ†æ•£å¼è³‡æ–™åº«æˆ–å„²å­˜åº« æˆ–æ˜¯çœ‹ Google å®˜æ–¹ Blogï¼šCutting costs with Google Kubernetes Engine: using the cluster autoscaler and Preemptible VMs\né è¨ˆå…§å®¹\néœ€æ±‚å‡è¨­ã€é‡æ¸…éœ€æ±‚ï¼Œä¸¦ä¸”ç²¾æº–è¨ˆåƒ¹ ç²¾æº–è¨ˆåƒ¹ä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿçš„ç¯€çœæˆæœ¬ å…ˆå è™›æ“¬æ©Ÿçš„è¦æ ¼ã€é¡å¤–é™åˆ¶ é¡å¤–é™åˆ¶ï¼Œé€ æˆæŠ€è¡“è¦å¤šåšå¾ˆå¤šé¡å¤–çš„äº‹æƒ… å¯¦å‹™ç¶“é©—åˆ†äº«ï¼šAPI server å¯¦å‹™ç¶“é©—ï¼šå¾ä½¿ç”¨éš¨é¸è™›æ“¬æ©Ÿï¼Œç§»è½‰åˆ°å…ˆå è™›æ“¬æ©Ÿï¼Œå…¬å¸å¯¦éš›å°å…¥ç¶“é©— å¯¦å‹™ç¶“é©—ï¼šElasticsearch å¯¦å‹™ç¶“é©—åˆ†äº«ï¼šå…¶ä»–åˆ†æ•£å¼è³‡æ–™åº«ï¼Œä¹Ÿè¨±æ˜¯ Cassandra æˆ–æ˜¯ cockroachDB ä¸Šé¢çš„å…§å®¹ä¸æ›‰å¾—æœƒå¯«å¹¾ç¯‡çœ‹æ„Ÿè¦º XD\næœ‰å¯«ééµäººè³½çš„éƒ½çŸ¥é“ 30 ç¯‡çœŸçš„å¾ˆæ¼«é•·ï¼Œä¸€ç¯‡æ–‡ç« å¹¾åƒå­—ï¼Œéƒ½è¦èŠ±å¥½å¹¾å€‹å°æ™‚ã€‚æˆ‘å»å¹´å¾ŒåŠï¼ŒçœŸçš„éƒ½æœƒçœ‹è®€è€…çš„ç•™è¨€è·ŸæŒ‰è®šï¼Œå–æš–ä¸€æ³¢ï¼Œæ‰æœ‰å‹•åŠ›ç¹¼çºŒå¯«ã€‚ç•™è¨€çš„äººå¤šå°±æœƒå¤šå¯«ï¼Œç•™è¨€çš„äººå°‘å°±æœƒå°‘å¯«ï¼Œå„ä½è¦ºå¾—æ–‡ç« é‚„çœ‹å¾—ä¸‹å»ï¼Œè«‹å‹™å¿…ä¾†æˆ‘ç²‰å°ˆæŒ‰è®šç•™å€‹è¨€ï¼Œä¸ç®¡æ˜¯æ¨æ¨ã€é­é­ã€æˆ–æ˜¯æœ‰æƒ³çœ‹çš„æ–‡ç« ä¾†è¨±é¡˜ï¼Œéƒ½ååˆ†æ­¡è¿ã€‚æœ‰ä½ å€‘çš„æ”¯æŒï¼Œæˆ‘æ‰æœ‰å‹•åŠ›ç¹¼çºŒå¯«ã€‚\nè«‹å¤§å®¶å‹™å¿…ä»¥å¯¦éš›è¡Œå‹•æ”¯æŒå¥½æ–‡ç« ï¼Œä¸è¦è®“åŠ£å¹£é©…é€è‰¯å¹£ã€‚ä¸ç„¶ iThome ä¸Šé¢ä¹‹å¾Œåªå‰©æ´—è§€çœ‹æ•¸çš„ç†±é–€æ–‡ç« äº† XD\nç•¶ç„¶ï¼Œæ²’äººç•™è¨€æˆ‘å°±æœƒç•¶ä½œè‡ªå·±æ‰æ˜¯åƒåœ¾æ–‡ (è‡ªçŸ¥ä¹‹æ˜XD)ï¼Œå°±æœƒæ”¶ä¸€æ”¶å›å®¶åš•è²“ç¡è¦ºï¼Œæ°æ°~\n-\u0026gt;æˆ‘çš„ç²‰å°ˆï¼Œç­‰ä½ ä¾†ç•™è¨€\n","permalink":"https://chechia.net/posts/2020-09-21-gcp-preemptible-instance/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eéµäººè³½çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œè¦å¸¶ä¾†å…¬æœ‰é›²çœéŒ¢ç³»åˆ—æ–‡ç« ã€‚\u003c/p\u003e\n\u003cp\u003eæ¶æ§‹çš„æˆæœ¬ï¼Œå¾ˆå¤šæ™‚å€™æœƒå½±éŸ¿æ¶æ§‹çš„è¨­è¨ˆèˆ‡éœ€æ±‚ã€‚å…¬å¸çš„ç‡Ÿé‹éƒ½éœ€è¦åœ¨æˆæœ¬èˆ‡éœ€æ±‚ä¹‹å‰å¹³è¡¡ï¼Œæˆæœ¬å…¶å¯¦æ˜¯å½±éŸ¿å…¬å¸æ±ºç­–çš„é‡è¦å› ç´ ã€‚èº«ç‚ºæ¶æ§‹ç®¡ç†å“¡ï¼Œæ‡‰è©²è¦è©¦è‘—é‡åŒ–ä¸¦ä¸”é€²è¡Œæˆæœ¬ç®¡ç†ï¼Œæå‡ºè§£æ±ºæ–¹æ¡ˆæ™‚ï¼Œä¹Ÿéœ€è¦æ€è€ƒå¦‚ä½•å¹«å…¬å¸é–‹æºç¯€æµã€‚\u003c/p\u003e\n\u003cp\u003eä¸€æ˜§æ¶ˆæ¸›æ¶æ§‹çš„æˆæœ¬ä¹Ÿæœªå¿…æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå¸³é¢ä¸Šæ¶ˆæ¸›çš„æˆæœ¬æœ‰æ™‚ä¹Ÿæœƒåæ˜ åœ¨å…¶ä»–åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨æ¯”è¼ƒä¾¿å®œçš„è§£æ±ºæ–¹æ¡ˆï¼Œæˆ–æ˜¯è¼ƒä½çš„ç®—åŠ›ï¼Œä½†å»é€ æˆç¶­é‹éœ€è¦èŠ±æ›´å¤šæ™‚é–“ç¶­è­·ï¼Œé€ æˆéš±æ€§çš„äººåŠ›æˆæœ¬æ¶ˆè€—ã€‚ç”¨ä»€éº¼æ›¿ä»£æ–¹æ¡ˆ (trade-off) çœäº†é€™äº›éŒ¢ã€‚\u003c/p\u003e\n\u003cp\u003eKubernetes æ˜¯ä¸€å€‹å¾ˆå¥½çš„ä¾‹å­ï¼šä¾‹å¦‚ï¼šæœ‰äººèªªã€ŒKubernetes å¯ä»¥çœéŒ¢ã€ï¼Œä½†ä¹Ÿæœ‰äººèªªã€ŒKubernetes ç”¢ç”Ÿçš„ Overhead å¤ªé‡æœƒè™§éŒ¢ã€ã€‚\u003c/p\u003e\n\u003cp\u003eã€Œè¦ä¸è¦å°å…¥ Kubernetes æ˜¯ä¸€å€‹å¥½å•é¡Œã€ã€‚æ‡‰è©²å›æ­¸åŸºæœ¬çš„éœ€æ±‚ï¼Œäº†è§£éœ€æ±‚æ˜¯ä»€éº¼ã€‚ä¾‹å¦‚ï¼šGoogle ç•¶åˆé–‹ç™¼å®¹å™¨ç®¡ç†å¹³å°ï¼Œæ˜¯é¢å°ä»€éº¼æ¨£çš„ä½¿ç”¨éœ€æ±‚ï¼Œæœ€çµ‚é–‹ç™¼å‡º Kubernetesï¼Œå„ä½å¯ä»¥å›é¡§å‰ç¯‡æ–‡ç« ã€ŒBorg Omega and Kuberneteï¼ŒKubernetes çš„å‰æ—¥ä»Šç”Ÿï¼Œèˆ‡ Google åé¤˜å¹´çš„å®¹å™¨åŒ–æŠ€è¡“ã€ï¼Œå¾ Google çš„è§’åº¦ç†è§£å®¹å™¨ç®¡ç†å¹³å°ï¼Œåæ€è‡ªèº«åœ˜éšŠçš„å¯¦éš›éœ€æ±‚ã€‚\u003c/p\u003e\n\u003cp\u003eé€™å¥—è§£æ±ºæ–¹æ¡ˆæ˜¯å¦çœŸçš„é©åˆåœ˜éšŠï¼Œè§£æ±ºæ–¹æ¡ˆå¸¶ä¾†çš„æ•ˆæœåˆ°åº•æ˜¯æ€æ¨£å‘¢ï¼Ÿå¸Œæœ›çœ‹å®Œé€™ç³»åˆ—æ–‡ç« å¾Œï¼Œèƒ½å¹«åŠ©å„ä½ï¼Œå¾æˆæœ¬é¢æ€è€ƒé€™äº›é‡è¦çš„å•é¡Œã€‚\u003c/p\u003e\n\u003cp\u003eé€™ç¯‡ä½¿ç”¨ GCP çš„åŸå› ï¼Œé™¤äº†æ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„å…¬æœ‰é›²å¤–ï¼Œä¹Ÿæ˜¯å› ç‚º GCP æä¾›çš„å…è²»é¡åº¦ï¼Œè®“æˆ‘å¯ä»¥å¾ˆè¼•é¬†åœ°ä½œç‚ºç¤¾ç¾¤æ–‡ç« çš„ Demoï¼Œå¦‚æœæœ‰åˆ¥å®¶é›²å¹³å°æœ‰æä¾›ç›¸åŒæ–¹æ¡ˆï¼Œè«‹ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å¯èƒ½å°±æœƒå¤šé–‹å¹¾å®¶ä¸åŒçš„ç¯„ä¾‹ã€‚\u003c/p\u003e\n\u003ch1 id=\"å…ˆå è™›æ“¬æ©Ÿ-tldr\"\u003eå…ˆå è™›æ“¬æ©Ÿ TL;DR\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eå…ˆå è™›æ“¬æ©Ÿç‚ºéš¨é¸è™›æ“¬æ©Ÿå®šåƒ¹çš„ 2-3 æŠ˜ï¼Œä½¿ç”¨å…ˆå è™›æ“¬æ©Ÿå¯èƒ½å¯ä»¥ç¯€çœ 7 æˆçš„é›²å¹³å°æ”¯å‡º\u003c/li\u003e\n\u003cli\u003eå…ˆå è™›æ“¬æ©Ÿæ¯”èµ·éš¨é¸è™›æ“¬æ©Ÿï¼Œå¤–åŠ æœ‰è«¸å¤šé™åˆ¶ï¼Œe.g. æœ€é•·å£½å‘½ 24 hrã€é›²å¹³å°æœƒä¸»å‹•çµ‚æ­¢å…ˆå è™›æ“¬æ©Ÿ\u0026hellip;ç­‰\u003c/li\u003e\n\u003cli\u003eé…åˆä½¿ç”¨è‡ªå‹•æ°´å¹³æ“´å±• (auto-scaler)ï¼Œè®“èˆŠçš„å…ˆå è™›æ“¬æ©Ÿå›æ”¶çš„åŒæ™‚ï¼Œå»è³¼è²·æ–°çš„å…ˆå è™›æ“¬æ©Ÿ\u003c/li\u003e\n\u003cli\u003eé…åˆå¯å®¹éŒ¯ (fault-tolerent) çš„åˆ†æ•£å¼æ‡‰ç”¨ï¼Œè®“æ‡‰ç”¨å¯ä»¥ç„¡ç—›åœ¨è™›æ“¬æ©Ÿåˆ‡æ›è½‰ç§»ï¼Œä¸å½±éŸ¿æœå‹™\u003c/li\u003e\n\u003cli\u003eè¦è®“æ‡‰ç”¨å¯ä»¥å®¹éŒ¯ï¼Œéœ€è¦åšéå¸¸å¤šäº‹æƒ…\u003c/li\u003e\n\u003cli\u003eæ­é… kubernetes ï¼Œè‡ªå‹•åŒ–ç®¡ç†ä¾†ç°¡åŒ–å·¥ä½œ\u003c/li\u003e\n\u003cli\u003eé…åˆæ­£ç¢ºçš„è¨­å®šï¼Œå¯ä»¥ç©©å®šçš„åŸ·è¡Œæœ‰ç‹€æ…‹çš„åˆ†æ•£å¼è³‡æ–™åº«æˆ–å„²å­˜åº«\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæˆ–æ˜¯çœ‹ Google å®˜æ–¹ Blogï¼š\u003ca href=\"https://cloud.google.com/blog/products/containers-kubernetes/cutting-costs-with-google-kubernetes-engine-using-the-cluster-autoscaler-and-preemptible-vms\"\u003eCutting costs with Google Kubernetes Engine: using the cluster autoscaler and Preemptible VMs\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eé è¨ˆå…§å®¹\u003c/p\u003e","title":"Gcp Preemptible Instance"},{"content":"å‰è¨€ é€™æ˜¯åŸæ–‡å®Œæ•´ç‰ˆæœ¬ã€‚å¤ªé•·ä¸è®€ (TL;DR) è«‹è¦‹Borg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæ‘˜è¦\nåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\næ‘˜è¦ åœ¨ container æŠ€è¡“å¤¯èµ·ä¾†å‰ï¼ŒGoogle å·²ç¶“åšäº† container åå¹¾å¹´ï¼Œéç¨‹ä¸­ç™¼å±•å‡ºéœ€ä¸‰å¥—å®¹å™¨ç®¡ç†ç³»çµ±ã€‚é›–ç„¶æ¯ä¸€ä»£ç³»çµ±çš„é–‹ç™¼éœ€æ±‚ä¸åŒï¼Œä½†æ¯ä¸€ä»£éƒ½æ·±å—ä¸Šä¸€ä»£å½±éŸ¿ã€‚é€™ç¯‡æ–‡ç« æè¿° Google é–‹ç™¼é€™äº›ç³»çµ±æ™‚ï¼Œå­¸åˆ°çš„ç¶“é©—ã€‚\nç¬¬ä¸€å¥— container management ç³»çµ±æ˜¯ Borgï¼Œç‚ºäº†ç®¡ç† 1. é•·æœŸåŸ·è¡Œçš„æœå‹™ 2. æ‰¹æ¬¡çš„çŸ­æœŸå·¥ä½œ (batch job)ï¼ŒåŸæœ¬åˆ†åˆ¥æ˜¯ç”± Babysitter èˆ‡ Global Work Queue å…©å¥—ç³»çµ±åˆ†é–‹ç®¡ç†ã€‚å¾Œè€…çš„æ¶æ§‹æ·±åˆ»å½±éŸ¿ Borgï¼Œä½† Global Work Queue å°ˆæ³¨æ–¼ batch jobã€‚å…©å¥—ç³»çµ±éƒ½åœ¨ Linux control groups ä¹‹å‰ã€‚Borg å°‡ä¸Šè¿°å…©ç¨®æ‡‰ç”¨æ”¾åœ¨å…±äº«çš„æ©Ÿå™¨ä¸Šï¼Œä¾†å¢åŠ è³‡æºçš„ä½¿ç”¨ç‡ï¼Œä»¥ç¯€çœæˆæœ¬ã€‚é€™ç¨®å…±äº«åŸºæ–¼æ”¯æ´ container çš„ Linux Kernel (Google ä¹Ÿè²¢ç»è¨±å¤š Linux kernel container ç¨‹å¼ç¢¼)ï¼Œæä¾›æ›´å¥½çš„éš”é›¢ (isolation) çµ¦å»¶é²æ•æ„Ÿçš„ä½¿ç”¨è€…æœå‹™ (latency-sentitive user-facing services)ï¼Œä»¥åŠæ¶ˆè€—å¤§é‡ cpu çš„ batch ç¨‹å¼ã€‚\nè¶Šä¾†è¶Šå¤šæ‡‰ç”¨éƒ½åœ¨ Borg ä¸Šé–‹ç™¼åŸ·è¡Œï¼Œ Google çš„æ‡‰ç”¨èˆ‡ infratructure åœ˜éšŠé–‹ç™¼è¨±å¤šå·¥å…·èˆ‡æœå‹™ï¼Œå½¢æˆ Borg ç”Ÿæ…‹ç³»ã€‚é€™äº›ç³»çµ±æä¾›è¨­å®š (configure) èˆ‡æ›´æ–° (update) å·¥ä½œã€é æ¸¬è³‡æºéœ€æ±‚ã€å‹•æ…‹æ¨é€è¨­å®šåˆ°åŸ·è¡Œä¸­çš„å·¥ä½œã€æœå‹™ç™¼ç¾ (service discovery) èˆ‡è² è¼‰å‡è¡¡ (Load balancing)ï¼Œç­‰ç­‰åŠŸèƒ½ã€‚é€™äº›ç”Ÿæ…‹ç³»çš„é–‹ç™¼åŸºæ–¼ Google ä¸åŒåœ˜éšŠçš„éœ€æ±‚ï¼Œç”¢ç”Ÿä¸€å€‹ä¸åŒèµ·æº (heterogeneous)ã€åªé‡å°å„åˆ¥éœ€æ±‚çš„ (ad-hoc) ä¸€å€‹å †ä¸åŒç³»çµ±ï¼ŒBorg çš„ä½¿ç”¨è€…éœ€è¦ä½¿ç”¨ä¸åŒçš„ç¨‹å¼èªè¨€èˆ‡ç¨‹åºï¼Œä¾†èˆ‡é€™äº›ç³»çµ±äº’å‹•ã€‚Borg ä»ç„¶æ˜¯ Google ä¸»è¦çš„å®¹å™¨ç®¡ç†ç³»çµ±ï¼Œå› ç‚ºä»–è¦æ¨¡ (scale) å·¨å¤§ï¼ŒåŠŸèƒ½å¤šæ¨£ï¼Œè€Œä¸”æ¥µåº¦å …å›º (robustness)ã€‚\nOmega æ˜¯ Borg çš„ä¸‹ä¸€ä»£ï¼Œç›®çš„æ˜¯æ”¹å–„ Borg ç”Ÿæ…‹ç³»çš„è»Ÿé«”å·¥ç¨‹ã€‚Omega æ‰¿è¥²è¨±å¤š Borg æ¸¬è©¦æˆåŠŸçš„æ¨¡å¼ï¼Œä½†ä¸åŒæ–¼ Borgï¼ŒOmega æœ‰å®Œæ•´çš„æ¶æ§‹è¨­è¨ˆï¼Œæ•´é«”æ›´åŠ ä¸€è‡´ã€‚Omega å°‡é›†ç¾¤ç‹€æ…‹ (cluster state) å­˜æ”¾åœ¨ä¸­å¿ƒåŒ– (centralized)ã€åŸºæ–¼ Paxos ç®—æ³•ã€äº¤æ˜“å°å‘ (transaction-oriented) çš„å„²å­˜ç³»çµ±ï¼Œè®“é›†ç¾¤çš„æ§åˆ¶é¢æ¿ (control panel) å­˜å–ï¼Œä¾‹å¦‚ schedulerã€‚Omega ä½¿ç”¨æ¨‚è§€çš„ä½µç™¼æ§åˆ¶ (optimistic concurrency control) ä¾†è™•ç†å¶ç™¼çš„è¡çªï¼Œé€™ä¸€å±¤è§£è—• (decoupling) çš„è¨­è¨ˆï¼Œä½¿å¾—åŸå…ˆçš„ Borgmaster çš„åŠŸèƒ½å¯ä»¥æ‹†åˆ†æˆå¤šå€‹å…ƒä»¶ï¼Œå–ä»£åŸæœ¬å–®ä¸€ (monolithic) é›†ä¸­ (centralized) çš„ masterï¼Œè¢«æ‰€æœ‰è®Šæ›´è«‹æ±‚å µå¡ã€‚è¨±å¤š Omage æˆåŠŸçš„å‰µæ–°ä¹Ÿæœƒè¢«è¿­ä»£å›å» Borg ä¸­ã€‚\nç¬¬ä¸‰å¥— Google é–‹ç™¼çš„å®¹å™¨ç®¡ç†ç³»çµ±æ˜¯ Kubernetesï¼Œé€™æ™‚å¤–ç•Œå·¥ç¨‹å¸«ä¹Ÿé–‹å§‹å° Linux å®¹å™¨æœ‰èˆˆè¶£ï¼Œè€Œ Google åŒæ™‚åœ¨é–‹ç™¼ä¸¦æ¨å±•è‡ªå·±çš„å…¬æœ‰é›²æ¶æ§‹ã€‚Kubernetes åœ¨é€™æ¨£çš„èƒŒæ™¯ä¸‹æ§‹æ€ä¸¦é–‹ç™¼ã€‚èˆ‡ Borg åŠ Omega ä¸åŒï¼ŒKubernetes æ˜¯é–‹æºè»Ÿé«”ï¼Œä¸é™æ–¼ Google å…§éƒ¨é–‹ç™¼ã€‚Kubernetes å…§éƒ¨æœ‰å…±äº«çš„æŒä¹…å±¤å„²å­˜ (persistent store)ï¼Œæœå‹™å…ƒä»¶æŒçºŒç›£æ¸¬æœ‰é—œç‰©ä»¶ï¼Œèˆ‡ Omega é¡ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒOmega å…è¨±ä¿¡ä»»çš„æ§åˆ¶é¢æ¿çš„å…ƒä»¶ç›´æ¥å­˜å–å„²å­˜åº«ï¼ŒKubernetes å‰‡é€é domain-specific çš„ REST API å­˜å–ï¼Œä¾†æä¾›é«˜éš (higher-level) çš„ API ç‰ˆæœ¬æ§åˆ¶ã€é©—è­‰ã€èªæ„è™•ç† (semantics)ã€ä»¥åŠå­˜å–æ”¿ç­– (policy)ï¼Œä¾†æ”¯æ´æ›´å»£æ³›çš„ç”¨æˆ¶ç«¯ã€‚æ›´é‡è¦çš„æ˜¯ Kubernetes è‘—é‡å·¥ç¨‹å¸«åœ¨ cluster ä¸Šé–‹ç™¼èˆ‡åŸ·è¡Œæ‡‰ç”¨çš„é«”é©—ï¼Œç°¡åŒ–è¤‡é›œåˆ†æ•£å¼ç³»çµ± (distributed system) çš„ç®¡ç†èˆ‡éƒ¨å±¬ (deploy)ï¼ŒåŒæ™‚ä»èƒ½é€éå®¹å™¨ä¾†æå‡è³‡æºçš„ä½¿ç”¨ç‡ã€‚\né€™ç¯‡æ–‡ç« æè¿° Google å¾ Borg åˆ° Kubernetes ç²å¾—çš„çŸ¥è­˜èˆ‡ç¶“é©—ã€‚\nå®¹å™¨ (Containers) å›é¡§æ­·å²ï¼Œç¬¬ä¸€å€‹å®¹å™¨åªæä¾› root file system (é€é chroot)ã€‚FreeBSD jail é€²ä¸€æ­¥å»¶ä¼¸å‡ºé¡å¤–çš„å‘½åç©ºé–“ (namespace) ä¾‹å¦‚ process IDã€‚Solaris å¤§å¹…åœ°æ¢ç´¢ç›¸é—œçš„æ–°åŠŸèƒ½ã€‚Linux control groups (cgroups) å¸æ”¶é€™äº›æƒ³æ³•ï¼Œç›´åˆ°ä»Šæ—¥ä»æŒçºŒé–‹ç™¼ã€‚\nå®¹å™¨æä¾›è³‡æºéš”é›¢ (resource isolation)ï¼ŒGoogle å¾—ä»¥å¤§å¹…æå‡è³‡æºä½¿ç”¨ç‡ (utilization) è¶…å‡ºç•¶æ™‚ç”¢æ¥­å¹³å‡å€¼ï¼Œä¾‹å¦‚ Borg ä½¿ç”¨å®¹å™¨ï¼Œå°‡æ‰¹æ¬¡æš«æ™‚å·¥ä½œã€èˆ‡é¢å°ç”¨æˆ¶éœ€è¦æ³¨æ„å»¶é²çš„æ‡‰ç”¨ï¼Œå…©è€…æ”¾åœ¨åŒæ¨£çš„ç‰©ç†æ©Ÿå™¨ä¸Šã€‚ç”¨æˆ¶æ‡‰ç”¨éœ€è¦é ç•™æ›´å¤šé¡å¤–çš„è³‡æºï¼Œä¾†è™•ç†çªç„¶ç”¢ç”Ÿçš„è² è¼‰é«˜å³° (load spikes) ä»¥åŠéŒ¯èª¤è™•ç† (fail-over) ï¼Œé€™äº›é ç•™çš„è³‡æºå¸¸å¸¸éƒ½ä¸æœƒç”¨åˆ°ï¼Œå¯ä»¥è½‰è®“æ‰¹æ¬¡å·¥ä½œä½¿ç”¨ã€‚å®¹å™¨æä¾›çš„è³‡æºç®¡ç†å·¥å…·å¯¦ç¾æ­¤é¡éœ€æ±‚ï¼Œkernel-level çš„è³‡æºéš”é›¢ä¹Ÿç¢ºä¿ç¨‹åºä¹‹é–“ä¸æœƒäº’ç›¸å¹²æ“¾ã€‚Google é–‹ç™¼ Borg ä¸­ï¼ŒåŒæ™‚ä¹Ÿæäº¤æ–°åŠŸèƒ½çµ¦ Linux å®¹å™¨ï¼Œä¾†æ»¿è¶³ä¸Šè¿°çš„éœ€æ±‚ã€‚ç„¶è€Œç›®å‰çš„éš”é›¢ä¸¦ä¸å®Œæ•´ï¼Œå¦‚æœ Linux kernel ä¸ç®¡ç†çš„è³‡æºï¼Œå®¹å™¨è‡ªç„¶ä¹Ÿç„¡æ³•æ ¼ç†ï¼Œä¾‹å¦‚ level-3 çš„è™•ç†å™¨å¿«å– (level-3 processor cache) èˆ‡è¨˜æ†¶é«”å¸¶å¯¬ (memory bandwith)ï¼Œå®¹å™¨é‚„éœ€è¦å¢åŠ ä¸€å±¤å®‰å…¨ä¿è­·å±¤ (ä¾‹å¦‚è™›æ“¬æ©Ÿå™¨ Virtual Machine) æ‰èƒ½å°ä»˜å…¬æœ‰é›²ä¸Šå‡ºç¾çš„æƒ¡æ„è¡Œç‚ºã€‚\nç¾ä»£çš„å®¹å™¨ä¸åªæä¾›éš”é›¢æ©Ÿåˆ¶ï¼Œæ›´æä¾›æ˜ åƒæª” (image)ï¼Œåœ¨é€™å€‹æª”æ¡ˆä¸Šå»ºæ§‹å®¹å™¨çš„æ‡‰ç”¨ã€‚Google ä½¿ç”¨ Midas Package Manager (MPM) ä¾†å»ºæ§‹ä¸¦éƒ¨å±¬å®¹å™¨æ˜ åƒæª”ï¼Œéš”é›¢æ©Ÿåˆ¶èˆ‡ MPM package çš„é—œä¿‚ï¼Œå¯ä»¥å°æ¯” Docker daemon èˆ‡ Docker image registryã€‚é€™å€‹ç« ç¯€æè¿°çš„ã€Œå®¹å™¨ã€åŒæ™‚åŒ…å«å…©å€‹æ¦‚å¿µï¼šéš”é›¢ã€æ˜ åƒæª”ã€‚\næ‡‰ç”¨å°å‘çš„æ¶æ§‹ (Application-oriented infrastructure) éš¨è‘—æ™‚é–“è­‰æ˜ï¼Œå®¹å™¨ä¸åªèƒ½æä¾›é«˜éšçš„è³‡æºä½¿ç”¨ç‡ï¼Œå®¹å™¨åŒ– (containerization) ä½¿è³‡æ–™ä¸­å¿ƒ (data center) å¾åŸæœ¬æ©Ÿå™¨å°å‘ (machine-oriented) è®Šæˆæ‡‰ç”¨å°å‘ (application-oriented)ï¼Œé€™å€‹æ®µè½æä¾›å…©å€‹ä¾‹å­ï¼š\nå®¹å™¨å°è£ (encapsulate) æ‡‰ç”¨çš„ç’°å¢ƒ (environment)ï¼Œåœ¨æ©Ÿå™¨èˆ‡ä½œæ¥­ç³»çµ±çš„ç´°ç¯€ä¸Šï¼Œå¢åŠ ä¸€å±¤æŠ½è±¡å±¤ï¼Œè§£è—•å…©ä»¶äº‹æƒ…ï¼šæ‡‰ç”¨é–‹ç™¼ã€éƒ¨å±¬åˆ°æ¶æ§‹ã€‚ è‰¯å¥½è¨­è¨ˆçš„å®¹å™¨èˆ‡æ˜ åƒæª”åªå°ˆæ³¨åœ¨å–®ä¸€å€‹æ‡‰ç”¨ï¼Œç®¡ç†å®¹å™¨æ„å‘³ç®¡ç†æ‡‰ç”¨ï¼Œè€Œä¸æ˜¯ç®¡ç†æ©Ÿå™¨ã€‚é€™é»å·®ç•°ä½¿å¾—ç®¡ç†çš„ APIï¼Œå¾æ©Ÿå™¨å°å‘è®Šæˆå½±ç”¨å°å‘ï¼Œå¤§å¹…åº¦çš„æ”¹å–„æ‡‰ç”¨çš„éƒ¨å±¬èˆ‡ç›£æ§ã€‚ æ‡‰ç”¨çš„ç’°å¢ƒ (Application environment) åŸæœ¬ kernel å…§çš„ cgroupã€chrootã€èˆ‡å‘½åç©ºé–“ï¼Œæ˜¯ç”¨ä¾†ä¿è­·æ‡‰ç”¨ä¸è¢«æ—é‚Šå…¶ä»–æ‡‰ç”¨çš„é›œè¨Šå½±éŸ¿ã€‚å°‡é€™äº›å·¥å…·èˆ‡å®¹å™¨æ˜ åƒæª”ä¸€èµ·ä½¿ç”¨ï¼Œç”¢ç”Ÿä¸€å±¤æŠ½è±¡å±¤ï¼Œåˆ†é›¢æ‡‰ç”¨ã€èˆ‡åº•ä¸‹çš„ (å„ç¨®ä¸åŒå®¶çš„) ä½œæ¥­ç³»çµ±ã€‚è§£è—•æ˜ åƒæª”èˆ‡ä½œæ¥­ç³»çµ±ï¼Œé€²ä¸€æ­¥æä¾›ç›¸åŒçš„ç’°å¢ƒçµ¦é–‹ç™¼ç’°å¢ƒ (development) èˆ‡ç”Ÿç”¢ç’°å¢ƒ (production)ï¼Œé™ä½ç’°å¢ƒé–“çš„ä¸ä¸€è‡´æ€§é€ æˆçš„å•é¡Œï¼Œæœ€çµ‚æå‡é–‹ç™¼çš„å¯é ç¨‹åº¦ã€ä¸¦åŠ é€Ÿé–‹ç™¼çš„æµç¨‹ã€‚\nå»ºæ§‹é€™å±¤æŠ½è±¡çš„é—œéµæ˜¯ï¼Œä½¿ç”¨å¯†é–‰çš„å®¹å™¨æ˜ è±¡æª” (hermetic container image) ï¼Œå°‡æ‰€æœ‰æ‡‰ç”¨æœ‰é—œçš„ä¾è³´ (dependencies) éƒ½æ‰“åŒ…ï¼Œæ•´åŒ…éƒ¨å±¬åˆ°å®¹å™¨ä¸­ã€‚æ­£ç¢ºåŸ·è¡Œçš„è©±ï¼Œå®¹å™¨å°å¤–éƒ¨çš„ä¾è³´åªå‰©ä¸‹ Linux kernel ç³»çµ±èª¿ç”¨ä»‹é¢ (system-call interface)ã€‚é€™å±¤ä»‹é¢å¤§å¹…æ”¹å–„æ˜ è±¡æª”çš„éƒ¨å±¬æ–¹ä¾¿æ€§ (protability)ï¼Œä½†ç›®å‰æ©Ÿåˆ¶ä»ä¸å®Œç¾ï¼Œæ‡‰ç”¨ä»ç„¶æš´éœ²åœ¨æŸäº›ä½œæ¥­ç³»çµ±çš„ä»‹é¢ä¸Šï¼Œç‰¹åˆ¥æ˜¯ socket optionsã€/procã€ä»¥åŠ ioctl çš„èª¿ç”¨åƒæ•¸ã€‚Google å¸Œæœ›é€éæ¨å»£é–‹æ”¾å®¹å™¨å€¡è­° (Open Container Initiative) ä¾†æ¸…æ¥šç•Œå®šï¼Œä¸Šè¿°ä»‹é¢èˆ‡å®¹å™¨çš„æŠ½è±¡å±¤ã€‚\næ¬¡å¤–ï¼Œå®¹å™¨æä¾›çš„éš”é›¢èˆ‡æœ€å°ä¾è³´ï¼Œåœ¨ Google è­‰æ˜éå¸¸æœ‰æ•ˆï¼Œå®¹å™¨æ˜¯ Google æ¶æ§‹ä¸Šå”¯ä¸€çš„å¯åŸ·è¡Œå–®ä½ (runnable entity)ï¼Œé€²ä¸€æ­¥ä½¿ Google åªæä¾›å°‘æ•¸çš„ä½œæ¥­ç³»çµ±ç‰ˆæœ¬çµ¦æ‰€æœ‰æ©Ÿå™¨ï¼Œåªéœ€è¦å°‘æ•¸çš„ç¶­è­·äººå“¡ä¾†è² è²¬ç®¡ç†ç‰ˆæœ¬ã€‚\nå¯†é–‰å®¹å™¨æ˜ æƒ³æª”æœ‰å¾ˆå¤šæ–¹å¼é”æˆï¼Œåœ¨ Borg å»ºæ§‹æ˜ æƒ³æª”æ™‚ï¼Œæ‡‰ç”¨çš„åŸ·è¡Œæª” (binary) éœæ…‹é€£çµåˆ°å¯ç”¨çš„ç¨‹åºåº« (library) ç‰ˆæœ¬ï¼Œç¨‹å¼åº«åœ¨å…¬å¸å…§éƒ¨å­˜æ”¾ã€‚è‡³æ­¤ Borg å®¹å™¨æ˜ åƒæª”é‚„ä¸æ˜¯å®Œå…¨å¯†é–‰ï¼Œåº•ä¸‹é‚„æœ‰ä¾è³´ä¸€å±¤åŸºåº•æ˜ è±¡æª” (base image)ï¼Œç›´æ¥äº‹å…ˆå®‰è£åˆ°æ©Ÿå™¨ä¸Šï¼Œè€Œä¸æ˜¯éš¨æ˜ åƒæª”éƒ¨å±¬ï¼ŒåŸºåº•æ˜ è±¡æª”åŒ…å«é€šç”¨å·¥å…·ä¾‹å¦‚ tar èˆ‡ libc ç¨‹å¼åº«ï¼Œå› æ­¤æ›´æ–°åŸºåº•æ˜ è±¡æª”ä»æœƒå½±éŸ¿æ‡‰ç”¨ï¼Œå¶çˆ¾æœƒç”¢ç”Ÿå¤§éº»ç…©ã€‚\nç¾ä»£çš„å®¹å™¨æ˜ åƒæª”æ ¼å¼ï¼Œå¦‚ Docker èˆ‡ ACIï¼Œéƒ½åŠ å¼·é€™å±¤æŠ½è±¡ã€æä¾›æ›´ç·Šå¯†çš„å°è£ï¼Œç§»é™¤ç‰¹å®šä½œæ¥­ç³»çµ±çš„ä¾è³´æ€§ï¼Œä¸¦è¦æ±‚ä½¿ç”¨è€…åœ¨åˆ†äº«æ˜ è±¡æª”å…§å®¹æ™‚ï¼Œå¿…é ˆæ˜ç¢ºå®£å‘Šã€‚\nå®¹å™¨ä½œç‚ºç®¡ç†å–®ä½ (Container as the unit of management) åœç¹å®¹å™¨å»ºæ§‹ç®¡ç† APIï¼Œè€Œéåœç¹æ©Ÿå™¨ï¼Œä½¿å¾—è³‡æ–™ä¸­å¿ƒçš„ã€ŒPrimary keyã€å¾æ©Ÿå™¨è®Šæˆæ‡‰ç”¨ã€‚å¸¶ä¾†è¨±å¤šå¥½è™•ï¼š\næ‡‰ç”¨å·¥ç¨‹å¸«èˆ‡ç¶­é‹åœ˜éšŠ (operation team) ä¸éœ€å†ç…©æƒ±æ©Ÿå™¨èˆ‡ä½œæ¥­ç³»çµ±çš„ç´°ç¯€ æ¶æ§‹åœ˜éšŠ (infrastructure team) ç²å¾—æ›´å¤šå‡ç‰ˆæˆ–æ˜¯èª¿åº¦ç¡¬é«”çš„å½ˆæ€§ï¼Œå¯¦éš›å°æ‡‰ç”¨èˆ‡é–‹ç™¼åœ˜éšŠçš„å½±éŸ¿éå¸¸å° ç®¡ç†ç³»çµ±æ”¶é›†æ‡‰ç”¨çš„ç›£æ¸¬æ•¸æ“š (ä¾‹å¦‚ CPU èˆ‡ Memory ä½¿ç”¨ metrics)ï¼Œè€Œéæ©Ÿå™¨çš„ç›£æ¸¬æ•¸æ“šï¼Œç›´æ¥æå‡æ‡‰ç”¨çš„ç›£æ¸¬èˆ‡è‡ªæˆ‘æª¢æŸ¥ (introspection)ï¼Œç‰¹åˆ¥æ˜¯æ“´å±• (scale-up)ã€æ©Ÿå™¨éŒ¯èª¤ã€æˆ–æ˜¯ç¶­è­·æ™‚ï¼Œé€ æˆæ‡‰ç”¨ç§»åˆ°å…¶ä»–ä½ç½®æ™‚ï¼Œç›£æ¸¬ä¾ç„¶å¯ç”¨ã€‚ å®¹å™¨æä¾›è¨±å¤šåˆ‡å…¥é»çµ¦æ³›ç”¨ API (generic API)ï¼Œæ³›ç”¨ API ä½¿è³‡è¨Šåœ¨ç®¡ç†ç³»çµ±èˆ‡æ‡‰ç”¨ä¹‹é–“æµå‹•ï¼Œä½†å…¶å¯¦å…©è€…äº’ç›¸ä¸æ¸…æ¥šå°æ–¹çš„å¯¦ä½œç´°ç¯€ã€‚åœ¨ Borg ä¸­æœ‰ä¸€ç³»åˆ—çš„ API é€£çµåˆ°æ‰€æœ‰å®¹å™¨ï¼Œä¾‹å¦‚ /healthz ç«¯é»å›å ±æ‡‰ç”¨çš„å¥åº·ç¨‹åº¦çµ¦å”èª¿ç®¡ç†è€… (orchestrator)ï¼Œç•¶ç™¼ç¾ä¸å¥åº·çš„æ‡‰ç”¨ï¼Œè‡ªå‹•çµ‚æ­¢ä¸¦é‡å•Ÿæ‡‰ç”¨ã€‚é€™å€‹è‡ªå‹•ä¿®å¾©åŠŸèƒ½æ˜¯å¯é çš„åˆ†æ•£å¼ç³»çµ±çš„åŸºç¤ã€‚(Kubernetes ä¹Ÿæä¾›é¡ä¼¼åŠŸèƒ½ï¼Œé€é HTTP ç«¯é»æˆ–æ˜¯ exec command ä¾†æª¢æŸ¥å®¹å™¨å…§éƒ¨çš„æ‡‰ç”¨)\nå®¹å™¨æä¾›ã€æˆ–æ˜¯æä¾›çµ¦å®¹å™¨çš„è³‡è¨Šï¼Œå¯ä»¥é€éè¨±å¤šä½¿ç”¨è€…ä»‹é¢å‘ˆç¾ã€‚Borg æä¾›å¯ä»¥å‹•æ…‹æ›´æ–°çš„æ–‡å­—ç‹€æ…‹è¨Šæ¯ï¼ŒKubernetes æä¾› key-value çš„ annotation å­˜æ”¾åœ¨çµ¦å€‹ç‰©ä»¶çš„ metadataï¼Œé€™äº›éƒ½èƒ½æºé€šæ‡‰ç”¨ã€‚annotation å¯ä»¥æ˜¯å®¹å™¨è‡ªè¡Œè¨­å®šã€æˆ–æ˜¯ç”±ç®¡ç†ç³»çµ±è¨­å®š (ä¾‹å¦‚æ»¾å‹•æ›´æ–°ç‰ˆæœ¬æ™‚æ¨™è¨»æ–°ç‰ˆæœ¬)ã€‚\nå®¹å™¨ç®¡ç†ç³»çµ±å¯ä»¥å–å¾—å®¹å™¨å…§éƒ¨è¨Šæ¯ï¼Œä¾‹å¦‚è³‡æºä½¿ç”¨ç‹€æ³ã€å®¹å™¨çš„ metadataï¼Œä¸¦å‚³æ’­çµ¦æ—¥èªŒ (logging) æˆ–æ˜¯ç›£æ§ (monitoring)ï¼Œä¾‹å¦‚ä½¿ç”¨è€…åç¨±ã€ç›£æ§ä»»å‹™åç¨±ã€ç”¨æˆ¶èº«åˆ†ã€‚ç”šè‡³é€²ä¸€æ­¥åœ¨ç¯€é»ç¶­è­·æ™‚ï¼Œææ—©æä¾›å®‰å…¨çµ‚æ­¢ (graceful-termination) çš„è­¦ç¤ºã€‚\nå®¹å™¨æœ‰å…¶ä»–æ–¹å¼å¯ä»¥æä¾›æ‡‰ç”¨å°å‘çš„ç›£æ¸¬ï¼Œä¾‹å¦‚ Linux Kernel cgroups æœƒæä¾›æ‡‰ç”¨çš„è³‡æºä½¿ç”¨ç‡ï¼Œé€™äº›è³‡è¨Šå¯ä»¥æ“´å±•ï¼Œä¸¦å°‡å®¢è£½åŒ–çš„ metrics æ§‹é HTTP API é€å‡ºã€‚åŸºæ–¼é€™äº›è³‡æ–™ï¼Œé€²ä¸€æ­¥é–‹ç™¼å‡ºæ³›ç”¨å·¥å…·å¦‚è‡ªå‹•æ“´å±• (auto-scaler) èˆ‡ cAdvisorï¼Œä»–å€‘ä¸éœ€è¦çŸ¥é“æ‡‰ç”¨çš„è¦æ ¼å°±å¯ä»¥è¨˜éŒ„ metricsã€‚ç”±æ–¼å®¹å™¨æœ¬èº«æ˜¯æ‡‰ç”¨ï¼Œå› æ¬¡ä¸éœ€è¦åœ¨å¯¦é«”æˆ–è™›æ“¬æ©Ÿå™¨ã€èˆ‡å¤šå€‹æ‡‰ç”¨ä¹‹é–“ï¼Œåšä¿¡è™Ÿå¤šå·¥è½‰ç™¼æˆ–å¤šè·¯åˆ†é… (multiplex / demultiplex signals)ã€‚é€™æ¨£æ›´ç°¡å–®ã€æ›´å …å›ºã€ä¸¦ä¸”å¯ä»¥ç”¢ç”Ÿç²¾åº¦æ›´é«˜çš„ metrics èˆ‡æ—¥èªŒï¼Œä¸¦æä¾›æ›´ç²¾ç´°çš„æ§åˆ¶æ“ä½œã€‚ä½ å¯ä»¥å°æ¯”ä½¿ç”¨ ssh ç™»å…¥æ©Ÿå™¨ï¼Œä¸¦ä¸”ä½¿ç”¨ top æŒ‡ä»¤ç›£æ¸¬ã€‚é›–ç„¶å·¥ç¨‹å¸«å¯ä»¥ ssh ç™»å…¥å®¹å™¨ï¼Œä½†å¾ˆå°‘éœ€è¦é€™æ¨£åšã€‚\næ‡‰ç”¨å°å‘è®Šé·åœ¨ç®¡ç†æ¶æ§‹ä¸Šç”¢ç”Ÿæ›´å¤šå›éŸ¿ï¼Œç›£æ¸¬åªæ˜¯å…¶ä¸­ä¸€å€‹ã€‚Google çš„é™„è¼‰å‡è¡¡å™¨ (load balancer) ä¸å†æ ¹æ“šæ©Ÿå™¨åšé™„è¼‰å‡è¡¡ï¼Œè€Œæ˜¯æ ¹æ“šæ‡‰ç”¨å¯¦é«” (application instances)ã€‚æ—¥èªŒæœƒæ ¹æ“šæ‡‰ç”¨æ‰“ä¸Šæ¨™ç±¤ (key) è€Œä¸æ˜¯æ©Ÿå™¨ï¼Œå› æ­¤å¯ä»¥è·¨æ©Ÿå™¨çš„æ”¶é›†æ‰€æœ‰ç›¸åŒæ‡‰ç”¨çš„æ—¥èªŒï¼Œè€Œä¸æœƒå½±éŸ¿å…¶ä»–çš„æ‡‰ç”¨æ—¥èªŒæˆ–æ˜¯å½±åƒä½œæ¥­ç³»çµ±ã€‚æˆ‘å€‘å¯ä»¥æª¢æ¸¬æ‡‰ç”¨å¤±æ•ˆï¼Œæ›´å®¹æ˜“çš„æè¿°éŒ¯èª¤åŸå› ï¼Œä¸éœ€è¦å…ˆæ‹†è§£è™•ç†æ©Ÿå™¨çš„å„å±¤ä¿¡è™Ÿã€‚ç”±æ–¼å®¹å™¨å¯¦é«”çš„èº«åˆ†è³‡è¨Šï¼Œå¾åŸºç¤ä¸Šéƒ½æ˜¯ç”±å®¹å™¨ç®¡ç†ç³»çµ±æ§åˆ¶ï¼Œå·¥ç¨‹å¸«å¯ä»¥æ˜ç¢ºçš„æŒ‡å®šæ‡‰ç”¨çš„åŸ·è¡Œèº«åˆ†ï¼Œä½¿å¾—æ‡‰ç”¨æ›´å®¹æ˜“å»ºæ§‹ã€ç®¡ç†ã€é™¤éŒ¯ã€‚\næœ€å¾Œï¼Œé›–ç„¶ä¸Šè¿°éƒ½é‡å°å®¹å™¨èˆ‡æ‡‰ç”¨åœ¨ä¸€å°ä¸€çš„ç‹€æ³ä¸‹ï¼Œä½†å¯¦å‹™ä¸Šæˆ‘å€‘éœ€è¦å¥—è£çš„å®¹å™¨ç¾¤ (nested containers)ï¼Œé€™ç¾¤å®¹å™¨ä¸€èµ·æ’ç¨‹åˆ°ç›¸åŒæ©Ÿå™¨ä¸Šï¼Œæœ€å¤–å±¤çš„å®¹å™¨æä¾›è³‡æºï¼Œå…§å±¤çš„å®¹å™¨æä¾›éƒ¨å±¬çš„éš”é›¢ã€‚Borg ä¸­ï¼Œæœ€å¤–å±¤å®¹å™¨å«åšè³‡æºåˆ†é… (resource allocation or alloc)ï¼Œåœ¨ Kubernetes ä¸Šç¨±åš Podã€‚Borg å…è¨±æœ€ä¸Šå±¤çš„æ‡‰ç”¨ç›´æ¥è·‘åœ¨å¤–å±¤çš„ alloc ä¸Šï¼Œä½†é€™é»ç”¢ç”Ÿäº†ä¸€äº›ä¸ä¾¿ï¼Œæ‰€ä»¥é€™é»åœ¨ Kubernetes åšäº†èª¿æ•´ï¼Œæ‡‰ç”¨æ°¸é è·‘åœ¨æœ€å¤–å±¤ Pod çš„å…§éƒ¨ï¼Œå°±ç®—åªæœ‰å–®ä¸€ä¸€å€‹å®¹å™¨ã€‚\nä¸€å€‹å¸¸è¦‹çš„ä½¿ç”¨æƒ…å¢ƒï¼Œæ˜¯ä¸€å€‹ Pod å…§éƒ¨è·‘ä¸€å€‹è¤‡é›œçš„æ‡‰ç”¨ï¼Œå¤§éƒ¨åˆ†çš„æ‡‰ç”¨éƒ½æ˜¯ä¸€å€‹ä¸€å€‹å­å®¹å™¨ (child containers)ï¼Œå…¶ä»–çš„å­å®¹å™¨å‰‡åŸ·è¡Œè¼”åŠ©å·¥å…·ï¼Œä¾‹å¦‚ log rotation æˆ–æ˜¯å°‡æ—¥èªŒç§»è½‰åˆ°åˆ†æ•£å¼æª”æ¡ˆç³»çµ±ã€‚å°æ¯”æŠŠä¸Šè¿°åŠŸèƒ½éƒ½æ‰“åŒ…åˆ° binary åŸ·è¡Œæª”ä¸­ï¼Œæ‹†åˆ†æ›´å®¹æ˜“è®“ä¸åŒåœ˜éšŠå„è‡ªé–‹ç™¼è² è²¬çš„åŠŸèƒ½ï¼Œæ‹†åˆ†é‚„æä¾›æ›´å¥½çš„è€ç”¨ç¨‹åº¦ (å°±ç®—ä¸»è¦æ‡‰ç”¨çµ‚æ­¢ï¼Œå­å®¹å™¨ä»èƒ½æˆåŠŸå°‡æ—¥èªŒç§»è½‰å‡ºå»)ï¼Œæ›´å®¹æ˜“çµ„è£æ‡‰ç”¨ (composability) (ç”±æ–¼æ¯å€‹æœå‹™éƒ½æ˜¯ç¨ç«‹é‹ä½œåœ¨å„è‡ªçš„å®¹å™¨ä¸­ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å¢åŠ æ–°çš„æ”¯æ´æœå‹™)ï¼Œæä¾›æ›´ç²¾ç´°çš„è³‡æºéš”é›¢ (æ‰€æœ‰å®¹å™¨è³‡æºéš”é›¢ï¼Œæ‰€ä»¥æ—¥èªŒæœå‹™ä¸æœƒæ¶å ä¸»è¦æ‡‰ç”¨çš„è³‡æºï¼Œåä¹‹äº¦ç„¶)ã€‚\nå”èª¿ç®¡ç†åªæ˜¯é–‹å§‹ï¼Œè€Œä¸æ˜¯çµ‚é» (Orchestration is the beginning, not the end) Borg çš„åˆè¡·åªæ˜¯åˆ†é…ä¸åŒçš„å·¥ä½œé™„è¼‰ (workload) åˆ°ç›¸åŒçš„æ©Ÿå™¨ä¸Šï¼Œä¾†æå‡è³‡æºä½¿ç”¨ç‡ã€‚ç„¶è€Œ Borg ç”Ÿæ…‹ç³»ä¸­ï¼Œæ”¯æ´ç³»çµ±çš„å¿«é€Ÿæ¼”åŒ–ï¼Œè¡¨æ˜å®¹å™¨ç®¡ç†ç³»çµ±æœ¬èº«åªæ˜¯ä¸€å€‹èµ·é»ï¼šé€šå¾€ä¸€å€‹æ–°çš„åˆ†æ•£å¼ç³»çµ±é–‹ç™¼èˆ‡ç®¡ç†ç’°å¢ƒã€‚è¨±å¤šæ–°çš„ç³»çµ±åœ¨ Borg ä¸Šæ‰“é€ ã€åµŒå…¥ Borgã€æˆ–æ˜¯åœç¹ Borg æ‰“é€ ï¼Œæå‡ Borg çš„åŸºæœ¬å®¹å™¨ç®¡ç†æœå‹™ï¼Œåº•ä¸‹æ˜¯éƒ¨åˆ†æœå‹™æ¸…å–®ï¼š\nå‘½åèˆ‡æœå‹™ç™¼ç¾ (Naming and service discovery) Borg Name Service (BNS) ä¸»ç¯€é»é¸èˆ‰ (master election) ä½¿ç”¨ Chubby æ‡‰ç”¨æ„ŸçŸ¥çš„ (application-aware) çš„è² è¼‰å‡è¡¡ è‡ªå‹•æ°´å¹³æ“´å±• (horizontal) èˆ‡å‚ç›´æ“´å±• (vertical) æ–°çš„åŸ·è¡Œæª”èˆ‡è¨­å®šæª”çš„æ»¾å‹•å‡ç´šå·¥å…· (rollout) å·¥ä½œæµç¨‹å·¥å…· (workflow) (ä¾‹å¦‚åœ¨ä¸åŒå·¥ä½œéšæ®µï¼ŒåŸ·è¡Œå¤šä»»å‹™çš„åˆ†æ pipeline) ç›£æ§å·¥å…·ï¼Œå¯ä»¥æ”¶é›†å®¹å™¨è³‡è¨Šã€æ•´åˆçµ±è¨ˆã€åœ¨ dashboard ä¸Šé¡¯ç¤ºã€ä¸¦å¯ä»¥è§¸ç™¼å‘Šè­¦ é€™äº›æœå‹™éƒ½æ˜¯ç”¨ä¾†è™•ç†é–‹ç™¼åœ˜éšŠé¢è‡¨çš„å•é¡Œï¼ŒGoogle é¸å‡ºæˆåŠŸçš„æœå‹™ä¸¦å»£æ³›çš„æ‡‰ç”¨ï¼Œè®“å·¥ç¨‹å¸«å·¥ä½œæ›´åŠ è¼•é¬†ã€‚ç„¶è€Œé€™äº›å·¥å…·å¤§å¤šå„è‡ªéœ€è¦ç‰¹åˆ¥çš„ (idiosyncratic) APIï¼Œä¾‹å¦‚éœ€è¦çŸ¥é“æª”æ¡ˆçš„ä½ç½®ï¼Œä¹Ÿéœ€è¦ Borg çš„æ·±åº¦æ•´åˆã€‚ç”¢ç”Ÿä¸€å€‹ä¸å¥½çš„å‰¯ä½œç”¨ï¼Œå°±æ˜¯éƒ¨å±¬ Borg ç”Ÿæ…‹ç³»è®Šå¾—æ›´è¤‡é›œäº†ã€‚\nKubernetes è©¦åœ–é™ä½é€™äº›è¤‡é›œåº¦ï¼Œå› æ­¤å°å…¥ä¸€è‡´æ€§è¨­è¨ˆçš„ API (consistent API)ï¼Œä¾‹å¦‚æ¯å€‹ Kubernetes ç‰©ä»¶éƒ½æœƒæœ‰ä¸‰å€‹åŸºç¤å…§å®¹ï¼šObjectMetadataã€Specification (Spec)ã€ä»¥åŠ Statusã€‚\næ‰€æœ‰ç‰©ä»¶çš„ ObjectMetadata éƒ½æ˜¯ä¸€æ¨£çš„ï¼ŒåŒ…å«ç‰©ä»¶çš„åç¨±ã€UIDã€ç‰©ä»¶çš„ç‰ˆæœ¬ (ä½œç‚ºæ¨‚è§€ä½µç™¼æ§åˆ¶ optimistic concurrency control æ™‚ä½¿ç”¨)ã€æ¨™ç±¤ (key-value label)ã€‚Spec èˆ‡ Status çš„å…§å®¹å› ç‰©ä»¶å‹åˆ¥æœ‰æ‰€ä¸åŒï¼Œä½†æ ¸å¿ƒæ¦‚å¿µä¸€è‡´ï¼šSpec æ˜¯æè¿°æœŸæœ›ç‹€æ…‹ (desired state)ï¼Œè€Œ Status æ˜¯ç´€éŒ„ç‰©ä»¶çš„ç•¶å‰ç‹€æ…‹ (current state)ã€‚\nçµ±ä¸€ API å¸¶ä¾†å¾ˆå¤šå¥½è™•ï¼Œå¾ç³»çµ±ç²å–è³‡è¨Šæ›´åŠ ç°¡å–®ï¼šæ‰€æœ‰ç‰©ä»¶éƒ½æœ‰ç›¸åŒçš„è³‡è¨Šï¼Œæ‰å¯ä»¥é–‹ç™¼æ‰€æœ‰ç‰©ä»¶éƒ½é©ç”¨çš„æ³›ç”¨å·¥å…·ï¼Œè€Œé€™é»æ›´é€²ä¸€æ­¥ï¼Œä½¿å·¥ç¨‹å¸«é–‹ç™¼çš„ä½¿ç”¨é«”é©—æ›´åŠ ä¸€è‡´ã€‚å¾ Borg èˆ‡ Omega ä¸­çš„ç¶“é©—å­¸ç¿’ï¼Œæ‰€ä»¥ Kubernetes æ˜¯ä¸€å †çµ„åˆçš„å€å¡Šæ‰“é€ è€Œæˆï¼Œä½¿ç”¨è€…é‚„å¯ä»¥è‡ªè¡Œæ“´å±•ã€‚æœ‰çµ±ä¸€çš„ API ä»¥åŠ object-metadata çµæ§‹è®“é€™ä»¶äº‹æ›´ç°¡å–®ã€‚ä¾‹å¦‚ Pod API ç”¨æˆ¶å¯ä»¥ä½¿ç”¨ã€Kubernetes å…§éƒ¨å…ƒä»¶ä¹Ÿä½¿ç”¨ã€å¤–éƒ¨çš„è‡ªå‹•åŒ–å·¥å…·ä¹Ÿä½¿ç”¨ã€‚ä¸€è‡´æ€§ç¹¼çºŒå»¶ä¼¸ï¼ŒKubernetes å…è¨±ç”¨æˆ¶å‹•æ…‹å¢åŠ å®¢è£½åŒ–çš„ APIï¼Œèˆ‡ Kubernetes æ ¸å¿ƒçš„ API ä¸€èµ·å·¥ä½œã€‚\nä¸€è‡´æ€§çš„ä¿ƒæˆä¹Ÿä»°è³´ Kubernetes è‡ªèº« API çš„è§£è—•ã€‚æŠŠå„è‡ªå…ƒä»¶çš„é¢å‘æ‹†é–‹ï¼Œè®“æ›´é«˜éšçš„æœå‹™å…±äº«ç›¸åŒçš„åº•å±¤åŸºç¤å¯¦ä½œã€‚ä¾‹å¦‚æ‹†åˆ† Kubernetes å‰¯æœ¬æ§åˆ¶å™¨ (replication controller) èˆ‡æ°´å¹³è‡ªå‹•æ“´å±•ç³»çµ± (horizontal auto-scaling system)ï¼Œå‰¯æœ¬æ§åˆ¶å™¨ç¢ºä¿ä¸€å€‹è…³è‰²çš„ (ex. å‰ç«¯ç¶²é ) å­˜åœ¨çš„æ•¸é‡ç¬¦åˆæœŸæœ›çš„æ•¸é‡ï¼Œè‡ªå‹•æ“´å±•å™¨å‰‡åŸºæ–¼å‰¯æœ¬æ§åˆ¶å™¨çš„åŠŸèƒ½ï¼Œåªå–®ç´”èª¿æ•´ Pods çš„æœŸæœ›ç‹€æ…‹ (desired state)ï¼Œè€Œä¸éœ€è² è²¬ Pod çš„å¢æ¸›ï¼Œè®“è‡ªå‹•æ“´å±•å™¨å¯ä»¥å¯¦ä½œæ›´å¤šä½¿ç”¨ä¸Šçš„éœ€æ±‚ï¼Œä¾‹å¦‚é æ¸¬ä½¿ç”¨ï¼Œä¸¦å¯ä»¥å¿½ç•¥åº•ä¸‹åŸ·è¡Œçš„å¯¦ä½œç´°ç¯€ã€‚\nAPI è§£è—•ä¹Ÿè®“è¨±å¤šé—œè¯ï¼Œä½†æ˜¯ä¸ç›¡ç›¸åŒçš„å…ƒä»¶æ§‹æˆè¿‘ä¼¼ã€‚ä¾‹å¦‚ Kubernetes æœ‰ä¸‰å€‹å½¢å¼çš„å‰¯æœ¬ Podï¼š\nReplicationControllerï¼šæŒçºŒåŸ·è¡Œçš„å®¹å™¨å‰¯æœ¬ (ä¾‹å¦‚ web server) DaemonSetï¼šæ¯å€‹ç¯€é»éƒ½æœ‰ä¸€å€‹å¯¦é«” (ä¾‹å¦‚æ—¥èªŒæ”¶é›†å™¨) Jobï¼šåŸ·è¡Œåˆ°å·¥ä½œå®Œæˆçš„æ§åˆ¶å™¨ï¼ŒçŸ¥é“å¦‚ä½• (å¹³è¡Œçš„) å•Ÿå‹•å·¥ä½œåˆ°çµæŸå·¥ä½œ é›–ç„¶æœ‰å„è‡ªçš„åŸ·è¡Œæ”¿ç­– (policy) ï¼Œä¸‰å€‹æ§åˆ¶å™¨éƒ½æœ‰ç›¸åŒçš„ Pod ç‰©ä»¶ï¼Œæè¿°å¸Œæœ›åŸ·è¡Œçš„å®¹å™¨ã€‚\nä¸€è‡´æ€§ä¹Ÿä»°è³´ Kubernetes å…§éƒ¨å…ƒä»¶çš„ç›¸åŒè¨­è¨ˆæ¨¡å¼ (design patterns)ã€‚æ§åˆ¶å™¨èª¿å’Œè¿´åœˆ (reconciliation controller loop) æ˜¯ Borgã€Omegaã€Kubernetes éƒ½å…±äº«çš„è¨­è¨ˆç†å¿µï¼Œç‚ºäº†æå‡ç³»çµ±çš„å½ˆæ€§ï¼šè¿´åœˆä¸æ–·æ¯”å°æœŸæœ›ç‹€æ…‹ (è¦æ±‚å¤šå°‘ç¬¦åˆ label-selector çš„ Pod å­˜åœ¨)ã€èˆ‡å¯¦éš›ç‹€æ…‹ (æ§åˆ¶å™¨å¯¦éš›è§€å¯Ÿåˆ°çš„æ•¸é‡)ï¼Œç„¶å¾Œæ§åˆ¶å™¨æ¡å–è¡Œå‹•ï¼Œç›¡é‡æ”¶æ–‚ (converge) å¯¦éš›ç‹€æ³èˆ‡æœŸæœ›ç‹€æ³ã€‚ç”±æ–¼æ‰€æœ‰è¡Œå‹•éƒ½åŸºæ–¼è§€å¯Ÿçµæœï¼Œè€Œéä¸€å€‹ç‹€æ…‹åœ–ï¼Œèª¿å’Œè¿´åœˆæ›´èƒ½æ‰¿å—éŒ¯èª¤ã€æ›´èƒ½æŠµæŠ—æ“¾äº‚ã€æ›´åŠ å …å›ºï¼šç•¶ä¸€å€‹æ§åˆ¶å™¨å‡ºéŒ¯ï¼Œåªè¦é‡å•Ÿï¼Œå°±å¯ä»¥ç¹¼çºŒä¸Šæ¬¡ä¸­æ–·çš„å·¥ä½œã€‚\nKubernetes è¨­è¨ˆæˆä¸€å †å¾®æœå‹™ (microservice) çš„çµ„åˆï¼Œä¸¦é€éå„å€‹å°å‹çš„æ§åˆ¶è¿´åœˆ (control loop)ï¼Œä¾†é”æˆæ•´é«”çš„ç·¨æ’çµæœ (choreography) - ä¸€å€‹æœŸæœ›çš„ç‹€æ…‹ï¼Œç”±å„å€‹åˆ†æ•£çš„è‡ªå‹•å…ƒä»¶ï¼Œå”ä½œé”æˆã€‚é€™å€‹æ„è­˜çš„è¨­è¨ˆé¸æ“‡ï¼Œå°æ¯”ä¸€å€‹ä¸­å¿ƒåŒ–å”èª¿ç®¡ç†ç³»çµ± (centralized orchestration)ï¼Œå¾Œè€…æ›´å®¹æ˜“å»ºæ§‹ï¼Œä½†é¢å°ä¸å¯é æœŸçš„éŒ¯èª¤èˆ‡è®Šæ›´æ™‚ï¼Œæ›´é¡¯è„†å¼±èˆ‡åƒµåŒ–ã€‚\nå‰è»Šä¹‹é‘‘ (Things to avoid) Google åœ¨é–‹ç™¼é€™äº›ç³»çµ±æ™‚ï¼Œå­¸åˆ°ä¸€äº›æœ€å¥½åˆ¥åšçš„äº‹æƒ…ï¼Œæˆ‘å€‘æä¾›é€™äº›è³‡è¨Šï¼Œæ‰€ä»¥å…¶ä»–äººå¯ä»¥é¿å…é‡è¤‡çš„éŒ¯èª¤ï¼Œè€ŒæŠŠçŠ¯éŒ¯çš„æˆæœ¬æ”¾åœ¨æ–°çš„éŒ¯èª¤ä¸Šã€‚\nä¸è¦ä½¿ç”¨å®¹å™¨ç®¡ç†ç³»çµ±ç®¡ç† Port number Borg ä¸Šæ‰€æœ‰å®¹å™¨éƒ½ä½¿ç”¨å®¿ä¸»æ©Ÿå™¨çš„ IPï¼ŒBorg åœ¨åˆ†é…æ™‚ä¾¿æŒ‡æ´¾çµ¦æ¯å€‹å®¹å™¨å„è‡ªçš„ port numberã€‚æ¯å€‹å®¹å™¨ç§»å‹•åˆ°æ–°æ©Ÿå™¨æ™‚æœƒå–å¾—ä¸€å€‹æ–°çš„ port numberï¼Œæœ‰æ™‚åœ¨æœ¬æ©Ÿé‡å•Ÿä¹Ÿæœƒæ‹¿åˆ°æ–°çš„ã€‚é€™é»è¡¨ç¤ºæ—¢å­˜çš„ç¶²è·¯æœå‹™ (ä¾‹å¦‚ DNS) Google éƒ½å¿…é ˆè‡ªè¡Œæ”¹å‹•ä¸¦ä½¿ç”¨è‡ªç¶­è­·çš„ç‰ˆæœ¬ï¼›æœå‹™çš„å®¢æˆ¶ç«¯ä¸¦ä¸èƒ½ä¸»å‹•ç²å¾—æœå‹™çš„ port number è³‡è¨Šï¼Œéœ€è¦è¢«å‹•å‘ŠçŸ¥ï¼›port number ä¹Ÿä¸èƒ½æ”¾åœ¨ URLs ä¸­ï¼Œé‚„éœ€è¦é¡å¤–çš„è½‰å€æ©Ÿåˆ¶ï¼›æ‰€æœ‰åŸºæ–¼ IP é‹ä½œçš„å·¥å…·éƒ½éœ€è¦æ”¹æˆä½¿ç”¨ IP:Portã€‚\næœ‰é‘‘æ–¼æ­¤ï¼ŒKubernetes ä¸Šæ¯å€‹ Pod åˆ†é…ä¸€å€‹ IPï¼Œè®“æ‡‰ç”¨çš„èº«åˆ†ç¬¦åˆç¶²è·¯èº«åˆ† (IP address)ï¼Œè®“ç¾æˆçš„æ‡‰ç”¨æ›´å®¹æ˜“åœ¨ Kubernetes ä¸ŠåŸ·è¡Œï¼Œæ‡‰ç”¨å¯ä»¥ç›´æ¥ä½¿ç”¨éœæ…‹çš„å¸¸è¦ port number (ä¾‹å¦‚ HTTP æµé‡ä½¿ç”¨ 80 port)ï¼Œç¾æœ‰çš„å·¥å…·ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¾‹å¦‚ç¶²æ®µåˆ‡åˆ† (network segmentation)ã€å¸¶å¯¬ç¯€æµ (bandwidth throttling) èˆ‡æ§åˆ¶ã€‚æ‰€æœ‰çš„å…¬æœ‰é›²éƒ½æä¾›æ¯å€‹ Pod ä¸€å€‹ IP çš„ç¶²è·¯åŸºåº•ï¼Œåœ¨å¯¦é«”æ©Ÿå™¨ (bare metal)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è»Ÿé«”å®šç¾©ç¶²è·¯ (Software defined network) çš„ overlay ç¶²è·¯ï¼Œæˆ–æ˜¯è¨­å®š L3 è·¯ç”±ä¾†é…ç½®æ©Ÿå™¨ä¸Šçš„ Pod IPsã€‚\nä¸è¦å¹«å®¹å™¨ç·¨è™Ÿï¼Œä½¿ç”¨ label æ§åˆ¶å®¹å™¨ å®¹å™¨å»ºæ§‹è®Šå¾—æ–¹ä¾¿å¾Œï¼Œä½¿ç”¨è€…æœƒç”¢ç”Ÿå¤§é‡å®¹å™¨ï¼Œå¾ˆå¿«å°±éœ€è¦ä¸€å€‹ç¾¤çµ„ç®¡ç†çš„æ–¹æ³•ã€‚Borg æä¾› job çµ¦ä¸€çµ„ç›¸åŒçš„ tasks (task ä½œç‚ºå®¹å™¨çš„åç¨±)ï¼Œä¸€å€‹ job æ˜¯ä¸€çµ„å‘é‡é›†åˆ (compact vector) å¯ä»¥æŒ‡å‘ä¸€å€‹æˆ–å¤šå€‹ tasksï¼Œå°‡ task å¾ 0 é–‹å§‹éå¢ç·¨è™Ÿï¼Œé€™å€‹åšæ³•å¾ˆç›´æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œä½†ç­‰ç¨å¾Œéœ€è¦é‡å•Ÿå®¹å™¨æ™‚ï¼ŒGoogle å°±å¾Œæ‚”é€™å€‹å›ºå®šçš„è¨­è¨ˆï¼Œä¾‹å¦‚å…¶ä¸­ä¸€å€‹ task æ­»äº†éœ€è¦é‡å•Ÿåˆ€å¦å¤–ä¸€å°æ©Ÿå™¨ï¼ŒåŸæœ¬çš„ task å‘é‡çš„ç›¸åŒä½ç½®ï¼Œç¾åœ¨éœ€è¦åšå…©å€å·¥ä½œï¼šæ‰¾åˆ°æ–°çš„å‰¯æœ¬ï¼Œç„¶å¾ŒæŒ‡å‘èˆŠçš„å‰¯æœ¬ä»¥å…éœ€è¦é™¤éŒ¯ã€‚ç•¶å‘é‡é›†åˆä¸­çš„ task é›¢é–‹å¾Œï¼Œé€™å€‹å‘é‡ä¸Šå°±æœ‰å¾ˆå¤šç©ºæ´ï¼Œé€™è®“ Borg ä¸Šå±¤çš„ç®¡ç†ç³»çµ±åˆ†é…ï¼Œè·¨ç´šç¾¤çš„ job æ™‚è®Šå¾—å¾ˆå›°é›£ã€‚é€™ä¹Ÿé€ æˆ Borg çš„ job å‡ç´šèªæ³•ä¸­å‡ºç¾è¨±å¤šå±éšªä¸”ä¸å¯é æœŸçš„äº¤äº’ (ç•¶æ»¾å‹•å‡ç´šæ™‚ä¾ç…§ index é †åºé‡å•Ÿ task)ï¼Œè€Œæ‡‰ç”¨ä»°è³´ task index (ä¾‹å¦‚æ‡‰ç”¨ä½¿ç”¨ index åŸ·è¡Œè³‡æ–™ç´šçš„ sharding æˆ– paritioning)ï¼šå¦‚æœæ‡‰ç”¨ä½¿ç”¨ task index ä¾†åš shardingï¼ŒBorg é‡å•Ÿæ™‚æœƒç§»é™¤é„°è¿‘çš„ tasksï¼Œå°è‡´è³‡æ–™ä¸å¯ç”¨ã€‚Borg ä¹Ÿæ²’æœ‰å¥½æ–¹æ³•ä¾†å¢åŠ ä¾†è‡ªæ‡‰ç”¨çš„ metadata åˆ° task ä¸Šï¼Œä¾‹å¦‚è§’è‰² (e.g. å‰ç«¯ç¶²é )ã€æˆ–æ˜¯æ»¾å‹•å‡ç´šçš„ç‹€æ…‹ (e.g. canary)ï¼Œå·¥ç¨‹å¸«åªå¥½å°‡ metadata ç·¨ç¢¼ï¼Œå£“åœ¨ jobs çš„åç¨±ä¸Šï¼Œå†ä½¿ç”¨æ­£è¦è¡¨é”å¼ (regular expression) è§£ç¢¼ã€‚\nKubernetes ç›´æ¥ä½¿ç”¨ label ä¾†è¾¨è­˜å®¹å™¨ç¾¤ï¼Œlabel æ˜¯éµå€¼è³‡æ–™å° (key-value pair)ï¼ŒåŒ…å«å¯ä»¥è¾¨è­˜æ‡‰ç”¨çš„è³‡æ–™ï¼Œä¸€å€‹ Pod å¯èƒ½æœ‰ role=frontend èˆ‡ state=production è¡¨ç¤º Pod æ˜¯å±¬æ–¼ production ç’°å¢ƒçš„å‰ç«¯ç¶²é ã€‚label å¯ä»¥å‹•æ…‹å¢åŠ ï¼Œä¸¦ä½¿ç”¨è‡ªå‹•åŒ–å·¥å…·æ›´æ”¹ï¼Œå€‹åœ˜éšŠå¯ä»¥è‡ªè¡Œç¶­è­·ä¸€çµ„å„è‡ªçš„ labelã€‚ä½¿ç”¨ label-selector ä¾†å–å¾—ä¸€çµ„ç‰©ä»¶ (e.g. stage==production \u0026amp;\u0026amp; role==frontend)ã€‚å„çµ„ç‰©ä»¶å¯ä»¥é‡è¤‡ï¼Œä¸€å€‹ç‰©ä»¶ä¹Ÿå¯ä»¥å±¬æ–¼å¤šå€‹ç‰©ä»¶çµ„ï¼Œæ‰€ä»¥ label ä¹Ÿæ¯”éœæ…‹çš„ç‰©ä»¶æ¸…å–®æ›´æœ‰å½ˆæ€§ã€‚ç”±æ–¼ç‰©ä»¶çµ„éƒ½æ˜¯å‹•æ…‹æŸ¥è©¢æ™‚ç”¢ç”Ÿçš„ï¼Œä»»ä½•æ™‚å€™éƒ½å¯ä»¥å¢åŠ æ–°çš„ç‰©ä»¶çµ„ã€‚label-selector æ˜¯ Kubernetes çš„ç¾¤çµ„æ©Ÿåˆ¶ï¼Œä¸¦è—‰æ­¤åˆ†ç•Œç®¡ç†ç¶­é‹ï¼Œåˆå¯ä»¥åŒæ™‚è™•ç†å¤šå€‹å¯¦é«”ã€‚\né›–ç„¶æœ‰äº›ä½¿ç”¨æƒ…å½¢ï¼Œäº‹å…ˆæ˜ç¢ºçŸ¥é“ä¸€çµ„å…§æœ‰å“ªäº› task å¾ˆæœ‰ç”¨ (ä¾‹å¦‚éœæ…‹è…³è‰²æŒ‡æ´¾ã€å·¥ä½œ partitioning æˆ– sharding)ï¼Œåˆç†çš„ label ä¹Ÿèƒ½ç”¢ç”Ÿä¸€æ¨£çš„æ•ˆæœï¼Œåªæ˜¯æ‡‰ç”¨ (æˆ–æ˜¯å…¶ä»–å¤–éƒ¨ç®¡ç†ç³»çµ±) å°±éœ€è¦è² è²¬æä¾› labelingã€‚label èˆ‡ label-selector ç‚ºé›™é‚Šæä¾›æœ€é©çš„åšæ³•ã€‚\næ³¨æ„ Pod çš„æ‰€æœ‰æ¬Š Borg ä¸Š task ä¾è³´ jobï¼Œä¸æœƒç¨è‡ªå­˜åœ¨ï¼Œç”¢ç”Ÿ job æ™‚ç”¢ç”Ÿ tasksï¼Œé€™äº› tasks æ°¸é é€£çµç‰¹å®šçš„ jobï¼Œåˆªé™¤ job åŒæ™‚åˆªé™¤ tasksã€‚é€™é»å¾ˆæ–¹ä¾¿ï¼Œä½†æœ‰ä¸€å€‹ç¼ºé™·ï¼Œé€™å€‹å–®ä¸€çš„ç¾¤çµ„æ©Ÿåˆ¶ï¼Œéœ€è¦æ‡‰å°æ‰€æœ‰ä½¿ç”¨éœ€æ±‚ã€‚ä¾‹å¦‚ ä¸€å€‹ job éœ€è¦å„²å­˜åƒæ•¸ï¼Œæä¾›çµ¦æœå‹™æˆ–æ˜¯æä¾›çµ¦æ‡‰ç”¨ï¼Œä½†ä¸æœƒä¸€èµ·æä¾›ï¼Œä½¿ç”¨è€…å°±éœ€è¦é–‹ç™¼å–ä»£æ–¹æ¡ˆä¾†å”åŠ©è™•ç† (e.g. DaemonSet å°‡ Pod è¤‡è£½åˆ°æ‰€æœ‰ç¯€é»ä¸Š)\nKubernetes ä¸­ Pod çš„ç”Ÿå‘½é€±æœŸç®¡ç†å…ƒä»¶ï¼Œä¾‹å¦‚ replication controllerï¼Œä½¿ç”¨ label selector æ±ºå®šé‚£äº› Pod è¦è² è²¬ç®¡ç†ï¼Œæ‰€ä»¥æœƒæœ‰ä¸€å€‹ä»¥ä¸Šçš„ controller èªç‚ºä»–å€‘éƒ½å°æŸå€‹ Pod æœ‰ç®¡è½„æ¬Šï¼Œé€™æ¨£çš„è¡çªéœ€è¦é€éæ˜ç¢ºè¨­å®šé¿å…çš„ã€‚ç”±æ–¼ label çš„å½ˆæ€§ä¹Ÿæœ‰è¨±å¤šå„ªé»ï¼Œä¾‹å¦‚å°‡ controller èˆ‡ Pod è§£è—•ï¼Œè¡¨ç¤ºå†ä¹Ÿä¸æœƒæœ‰ä»¥å¾€çš„å­¤å…’ Pod (orphan) æˆ–æ˜¯èªé ˜çš„ Pod (adopt)ã€‚è€ƒæ…®é™„è¼‰å‡è¡¡æœå‹™ï¼Œé€é label selector é¸æ“‡æµé‡çš„ç«¯é»ï¼Œå¦‚æœä¸€å€‹ Pod è¡Œç‚ºæœ‰ç•°ï¼Œé€™å€‹ Pod åªè¦ç§»é™¤å°æ‡‰çš„ labelï¼ŒKubernetes service load balancer å°±å¯ä»¥é¿å…æµé‡ï¼Œè¼•æ˜“çš„è¢«éš”é›¢é–‹ä¾†ï¼Œä½† Pod æœ¬èº«é‚„æœƒå­˜åœ¨ï¼Œæä¾›åŸåœ°é™¤éŒ¯ã€‚åŒæ™‚ï¼Œç®¡ç† Pod çš„ replication controller æœƒå¢åŠ ä¸€å€‹ Pod ä¾†å–ä»£è¡Œç‚ºæœ‰ç•°çš„ Podã€‚\nä¸è¦æš´éœ² raw state Borgã€Omegaã€Kubernetes çš„é—œéµä¸åŒé»æ˜¯ API çš„æ¶æ§‹è¨­è¨ˆã€‚Borgmaster æ˜¯ä¸€å€‹é›†ä¸­å–®ä¸€çš„ (monolithic) å…ƒä»¶ï¼Œå¯è¦‹æ‰€æœ‰çš„ API è¡Œç‚ºï¼ŒåŒ…å«ç´šç¾¤ç®¡ç†é‚è¼¯ï¼Œä¾‹å¦‚ job èˆ‡ task çš„ç‹€æ…‹æ©Ÿåˆ¶ï¼Œä¸¦ä¸”ä½¿ç”¨åŸºæ–¼ Paxos ç®—æ³•çš„åˆ†æ•£å¼å„²å­˜åº«ã€‚Omega é™¤äº†å„²å­˜åº«ä»¥å¤–ï¼Œæ²’æœ‰é›†ä¸­å¼çš„å…ƒä»¶ï¼Œå„²å­˜åº«åªå„²å­˜è¢«å‹•çš„ç‹€æ…‹è³‡è¨Šï¼Œæä¾›æ¨‚è§€çš„å¹³è¡Œæ§åˆ¶ (optimistic concurrenty control)ï¼šæ‰€æœ‰é‚è¼¯èˆ‡èªæ³•éƒ½æ¨é€åˆ°å„²å­˜åº«çš„å®¢æˆ¶ç«¯ï¼Œæ‰€ä»¥æ‰€æœ‰å®¢æˆ¶ç«¯éƒ½å¯ä»¥è®€å– Omega çš„æ‰€æœ‰é‚è¼¯ã€‚å¯¦å‹™ä¸­ Omega çš„å…ƒä»¶éƒ½ä½¿ç”¨ç›¸åŒçš„å®¢æˆ¶ç«¯ç¨‹å¼åº«ï¼Œè² è²¬æ‰“åŒ…/è§£åŒ…è³‡æ–™çµæ§‹ã€è³‡æ–™é‡é€ã€ä¸¦ç¢ºä¿èªæ³•çš„ä¸€è‡´æ€§ã€‚\nKubernetes é¸æ“‡ä¸­é–“ï¼Œé¡ä¼¼ Omega å…ƒä»¶åŒ–æ¶æ§‹çš„æ¶æ§‹ï¼Œç¢ºä¿å…¨åŸŸçš„å¸¸æ•¸ã€æ”¿ç­–æ§ç®¡ã€è³‡æ–™è½‰å‹ï¼Œä¾†æä¾›å½ˆæ€§èˆ‡æ“´å®¹æ€§ã€‚Kubernetes ç¢ºä¿æ‰€æœ‰çš„å„²å­˜åº«å­˜å–éƒ½é€é API serverï¼ŒAPI server éš±è—å„²å­˜åº«çš„å¯¦ä½œã€è² è²¬ç‰©ä»¶çš„é©—è­‰ã€é™¤éŒ¯ã€ç‰ˆæœ¬æ§åˆ¶ã€‚å¦‚åŒ Omegaï¼ŒKubernetes æä¾›å¤šç¨®ä¸åŒçš„å®¢æˆ¶ç«¯ (ç‰¹åˆ¥çµ¦æ˜¯é–‹æºçš„ç’°å¢ƒ)ï¼Œä½†æ˜¯é›†ä¸­åŒ–çš„ API serverï¼Œä»èƒ½ç¢ºä¿ç›¸åŒçš„èªæ³•ã€æ†é‡ã€èˆ‡æ”¿ç­–æ§ç®¡ã€‚\nå…¶ä»–å›°é›£çš„é–‹æ”¾å•é¡Œ å¤šå¹´çš„å®¹å™¨é–‹ç™¼ç³»çµ±é–‹ç™¼ç«¶è±”ï¼ŒGoogle ä»ç„¶æœ‰ä¸€äº›å•é¡Œé‚„æ²’æ‰¾åˆ°åˆé©çš„ç­”æ¡ˆï¼Œé€™è£¡åˆ†äº«ä¸€äº›å•é¡Œï¼Œå¸Œæœ›èƒ½å¸¶ä¾†æ›´å¤šè¨è«–èˆ‡è§£æ±ºæ–¹æ¡ˆã€‚\nè¨­å®š (configuration) æ‰€æœ‰é¢å°çš„å•é¡Œä¸­ï¼Œèˆ‡è¨­å®š (configuration) æœ‰é—œçš„å•é¡Œï¼Œç”¢ç”Ÿæœ€å¤šçš„è…¦åŠ›æ¿€ç›ªã€æ–‡ä»¶ã€èˆ‡è¨±å¤šç¨‹å¼ç¢¼ã€‚ä¸€çµ„æ•¸å€¼æä¾›çµ¦æ‡‰ç”¨ï¼Œä½†ä¸æ˜¯ç›´æ¥å¯«æ­»åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘å¯ä»¥å°±æ­¤å¯«ä¸€å¤§ç¯‡äº›ä¸å®Œï¼Œä½†é€™é‚Šå…ˆèšç„¦å¹¾å€‹é‡é»ã€‚\nç¬¬ä¸€ï¼Œé—œæ–¼æ‡‰ç”¨çš„è¨­å®šï¼Œå®¹å™¨ç®¡ç†ç³»çµ±æ²’åšï¼Œä½†å·²ç¶“æœ‰åŒ…ç¾…è¬è±¡çš„å¯¦ä½œï¼ŒBorg çš„æ­·å²ä¸­åŒ…å«ï¼š\nç¯„ç‰ˆ (boilerplate) çš„ç²¾ç°¡ (e.g. é‡å°ä¸åŒå·¥ä½œè² è¼‰ï¼Œä¾‹å¦‚æœå‹™æˆ–æ˜¯æ‰¹æ¬¡ä»»å‹™ï¼Œæä¾›é è¨­çš„ task é‡å•Ÿæ”¿ç­–) èª¿æ•´ä¸¦é©—è­‰æ‡‰ç”¨çš„åƒæ•¸èˆ‡å‘½ä»¤åˆ—æ¨™ç±¤ (command-line flags) å¯¦ä½œ workaround çµ¦é‚„æ²’æœ‰çš„ API æŠ½è±¡ï¼Œä¾‹å¦‚ package ç®¡ç† æ‡‰ç”¨çš„è¨­å®šæ¨£æœ¬ç¨‹å¼åº« ç™¼å¸ƒç®¡ç†å·¥å…· (release management) æ˜ è±¡æª”ç‰ˆæœ¬è¦æ ¼ ç‚ºäº†èˆ‡ä¸Šè¿°éœ€æ±‚å”ä½œï¼Œè¨­å®šç®¡ç†ç³»çµ±æœ€çµ‚ç”¢ç”Ÿä¸€å¥—é‡å°ç‰¹å®šé ˜åŸŸ (domain-specific) çš„è¨­å®šèªè¨€ï¼Œæœ€çµ‚è®Šæˆ Turing èªè¨€ï¼Œç‚ºäº†åœ¨è¨­å®šè³‡æ–™ä¸­é€²è¡Œé‹ç®— (e.g. é€éæœå‹™çš„ sharding æ•¸é‡ï¼Œé‚„æ±ºå®šèª¿æ•´æ©Ÿå™¨çš„ memory)ï¼Œé€™æœƒé€ æˆä¸€ç¨®é›£ä»¥ç†è§£çš„è¨­å®šç¨‹å¼ç¢¼ (configuration is code) ï¼Œè€Œé€™æ˜¯æ‡‰ç”¨å·¥ç¨‹å¸«ï¼Œé€éæ¶ˆæ»…åŸå§‹ç¢¼ä¸­å¯«æ­»çš„åƒæ•¸ï¼Œç›¡åŠ›é¿å…çš„ã€‚é€™é»ä¸¦æ²’æœ‰é™ä½ç¶­é‹çš„è¤‡é›œæ€§ï¼Œæ–°çš„èªè¨€åªæ˜¯å°‡è¨­å®šçš„é‹ç®—ï¼Œå¾æ‡‰ç”¨çš„ç¨‹å¼èªè¨€ä¸­ï¼Œç§»åˆ°å¦å¤–ä¸€å€‹æ–°çš„ç‰¹å®šèªè¨€ï¼Œè€Œé€™å€‹èªè¨€å¾€å¾€æ›´ç¼ºä¹é–‹ç™¼å·¥å…·ã€é™¤éŒ¯å·¥å…·ã€èˆ‡æ¸¬è©¦æ¡†æ¶ã€‚\nGoogle èªç‚ºç›®å‰æœ€æœ‰æ•ˆçš„è¾¦æ³•ï¼Œæ˜¯æ¥å—ä¸€éƒ¨åˆ†ç„¡æ³•é¿å…çš„ç¨‹å¼è¨­å®šï¼Œä¸¦ä¸”æ¸…æ¥šçš„å€åˆ†é‹ç®—çš„ç¨‹å¼èˆ‡è³‡æ–™ã€‚å‘ˆç¾è³‡æ–™çš„èªè¨€æ‡‰è©²ç°¡å–®æ¸…æ¥šï¼Œä¾‹å¦‚ JSON æˆ–æ˜¯ YAMLï¼Œè¨­å®šé‹ç®—çš„é‚è¼¯å‰‡éœ€è¦ä½¿ç”¨å®Œæ•´çš„ç¨‹å¼èªè¨€ï¼Œæ‰æœ‰å®Œæ•´çš„èªæ³•ã€èˆ‡å¥½çš„å·¥å…·ã€‚é€™é»å¯è¦‹æ–¼ Angular å‰ç«¯æ¡†æ¶ï¼ŒåŠƒåˆ† markup è³‡æ–™èˆ‡ JavaScript é‹ç®—é‚è¼¯ã€‚\nä¾è³´ç®¡ç† (dependency management) å»ºç«‹æœå‹™å¾€å¾€æ„å‘³è‘—å»ºç«‹ä¸€å¥—ç›¸é—œæœå‹™ (ç›£æ§ã€CI/CDã€ç­‰ç­‰)ï¼Œå¦‚æœä¸€å€‹æ‡‰ç”¨ä¾è³´å…¶ä»–æ‡‰ç”¨ï¼Œæ˜¯å¦å®¹å™¨ç®¡ç†ç³»çµ±ä¹Ÿèƒ½è‡ªå‹•æä¾›ä¾è³´çš„æœå‹™å‘¢ï¼Ÿ\nè®“äº‹æƒ…æ›´è¤‡é›œï¼Œå•Ÿå‹•ä¾è³´æœå‹™å¾€å¾€ä¸åªæ˜¯å•Ÿå‹•æ–°çš„å‰¯æœ¬ï¼Œä¾‹å¦‚æœå‹™å•Ÿå‹•å¾Œé‚„éœ€è¦å‘ä½¿ç”¨è€…è¨»å†Š (ä¾‹å¦‚ BigTable æœå‹™)ï¼Œç„¶å¾Œå‚³é€èº«åˆ†èªè­‰ã€æ¬Šé™èªè­‰ã€ä»¥åŠå…¶ä»–ä¸­ä»‹æœå‹™çš„è¨ˆåƒ¹è³‡è¨Šã€‚æ²’æœ‰ä¸€å€‹ç³»çµ±å¯ä»¥æ•æ‰ã€ç®¡ç†ã€ç¶­è­·ã€æˆ–æ˜¯æš´éœ²é€™æ¨£çš„ä¾è³´ç³»çµ±è³‡è¨Šã€‚æ‰€ä»¥é–‹å•Ÿä¸€å€‹æ–°æœå‹™æ™‚ï¼Œç”¨æˆ¶ä»éœ€è¦è‡ªå·±ç…©æƒ±ã€éƒ¨å±¬æ–°æœå‹™ä»ç„¶å›°é›£ï¼Œè€Œé€™å¾€å¾€é€²ä¸€æ­¥å°è‡´ä½¿ç”¨è€…æ²’æœ‰è·Ÿéš¨æœ€ä½³å¯¦è¸ï¼Œé€²è€Œé™ä½æœå‹™çš„å¯é æ€§ã€‚\nä¸€å€‹æ¨™æº–å•é¡Œæ˜¯ï¼Œå¦‚æœæœå‹™æ˜¯æ‰‹å‹•æä¾›çš„ï¼Œè·Ÿä¸Šä¾è³´æœå‹™æ›´æ–°æœƒå¾ˆå›°é›£ã€‚è©¦åœ–è‡ªå‹•åŒ–åˆ¤æ–· (e.g. ä½¿ç”¨ tracing accesses) å¤±æ•—ï¼Œå› ç‚ºç„¡æ³•å–å¾—åˆ¤è®€çµæœæ‰€éœ€è¦çš„èªæ³•è³‡è¨Šã€‚ä¸€å€‹å¯èƒ½çš„è§£æ±ºæ–¹æ³•ï¼Œæ˜¯è¦æ±‚æ‡‰ç”¨åˆ—èˆ‰æ‰€æœ‰ä¾è³´çš„æœå‹™ï¼Œä¸¦ä¸”é€éæ¶æ§‹æ§åˆ¶ï¼Œæ‹’çµ•å…¶ä»–æ‡‰ç”¨å­˜å– (å¦‚åŒç·¨è­¯æ™‚åŒ¯å…¥çš„ç¨‹å¼åº«)ã€‚é€™æ¨£å¯ä»¥è®“å®¹å™¨ç®¡ç†ç³»çµ±æä¾›è‡ªå‹•åŒ–çš„ç’°å¢ƒè¨­å®šã€æä¾›è‡ªå‹•èº«åˆ†èªè­‰ã€ä¸¦å¯«è‡ªå‹•é€£æ¥ã€‚\nä¸å¹¸çš„æ˜¯ï¼Œé€™æ¨£æè¿°ã€åˆ†æã€ä½¿ç”¨ä¾è³´æ€§çš„ç³»çµ±å¤ªéè¤‡é›œï¼Œé‚„æ²’è¢«å¢åŠ åˆ°ä¸»æµçš„å®¹å™¨ç®¡ç†ç³»çµ±ã€‚æˆ‘å€‘å¸Œæœ›æœ‰å¤© Kubernetes èƒ½å¤ å»ºç«‹èµ·é¡ä¼¼çš„å·¥å…·ï¼Œå–®ç›®å‰ä»æ˜¯ä¸€å€‹å°šæœªå®Œæˆçš„æŒ‘æˆ°ã€‚\nçµè«– åå¹´çš„ç¶“é©—æ‰“æƒå®¹å™¨ç®¡ç†ç³»çµ±ï¼Œçµ¦äº†æˆ‘å€‘è¨±å¤šç¶“é©—ï¼Œæˆ‘å€‘å°‡å…¶å¯¦ä½œ Kubernetes ä¸Šï¼ŒKubernetes çš„ç›®çš„æ˜¯é€éå®¹å™¨ï¼Œæå‡å·¥ç¨‹å¸«çš„ç”Ÿç”¢åŠ›ï¼Œä¸¦æ¸›è¼•æ‰‹å‹•èˆ‡è‡ªå‹•ç®¡ç†ç³»çµ±çš„è² æ“”ï¼Œæˆ‘å€‘å¸Œæœ›ä½ ä¹Ÿèƒ½åŠ å…¥æ‹“å±•èˆ‡æ¢ç´¢çš„è¡Œåˆ—ã€‚\n","permalink":"https://chechia.net/posts/2020-09-12-borg-omega-and-kubernetes/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eé€™æ˜¯åŸæ–‡å®Œæ•´ç‰ˆæœ¬ã€‚å¤ªé•·ä¸è®€ (TL;DR) è«‹è¦‹\u003ca href=\"https://chechia.net/posts/2020-08-26-borg-omega-and-kubernetes-tldr/\"\u003eBorg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæ‘˜è¦\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\u003c/p\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cp\u003eåœ¨ container æŠ€è¡“å¤¯èµ·ä¾†å‰ï¼ŒGoogle å·²ç¶“åšäº† container åå¹¾å¹´ï¼Œéç¨‹ä¸­ç™¼å±•å‡ºéœ€ä¸‰å¥—å®¹å™¨ç®¡ç†ç³»çµ±ã€‚é›–ç„¶æ¯ä¸€ä»£ç³»çµ±çš„é–‹ç™¼éœ€æ±‚ä¸åŒï¼Œä½†æ¯ä¸€ä»£éƒ½æ·±å—ä¸Šä¸€ä»£å½±éŸ¿ã€‚é€™ç¯‡æ–‡ç« æè¿° Google é–‹ç™¼é€™äº›ç³»çµ±æ™‚ï¼Œå­¸åˆ°çš„ç¶“é©—ã€‚\u003c/p\u003e\n\u003cp\u003eç¬¬ä¸€å¥— container management ç³»çµ±æ˜¯ Borgï¼Œç‚ºäº†ç®¡ç† 1. é•·æœŸåŸ·è¡Œçš„æœå‹™ 2. æ‰¹æ¬¡çš„çŸ­æœŸå·¥ä½œ (batch job)ï¼ŒåŸæœ¬åˆ†åˆ¥æ˜¯ç”± Babysitter èˆ‡ Global Work Queue å…©å¥—ç³»çµ±åˆ†é–‹ç®¡ç†ã€‚å¾Œè€…çš„æ¶æ§‹æ·±åˆ»å½±éŸ¿ Borgï¼Œä½† Global Work Queue å°ˆæ³¨æ–¼ batch jobã€‚å…©å¥—ç³»çµ±éƒ½åœ¨ Linux control groups ä¹‹å‰ã€‚Borg å°‡ä¸Šè¿°å…©ç¨®æ‡‰ç”¨æ”¾åœ¨å…±äº«çš„æ©Ÿå™¨ä¸Šï¼Œä¾†å¢åŠ è³‡æºçš„ä½¿ç”¨ç‡ï¼Œä»¥ç¯€çœæˆæœ¬ã€‚é€™ç¨®å…±äº«åŸºæ–¼æ”¯æ´ container çš„ Linux Kernel (Google ä¹Ÿè²¢ç»è¨±å¤š Linux kernel container ç¨‹å¼ç¢¼)ï¼Œæä¾›æ›´å¥½çš„éš”é›¢ (isolation) çµ¦å»¶é²æ•æ„Ÿçš„ä½¿ç”¨è€…æœå‹™ (latency-sentitive user-facing services)ï¼Œä»¥åŠæ¶ˆè€—å¤§é‡ cpu çš„ batch ç¨‹å¼ã€‚\u003c/p\u003e\n\u003cp\u003eè¶Šä¾†è¶Šå¤šæ‡‰ç”¨éƒ½åœ¨ Borg ä¸Šé–‹ç™¼åŸ·è¡Œï¼Œ Google çš„æ‡‰ç”¨èˆ‡ infratructure åœ˜éšŠé–‹ç™¼è¨±å¤šå·¥å…·èˆ‡æœå‹™ï¼Œå½¢æˆ Borg ç”Ÿæ…‹ç³»ã€‚é€™äº›ç³»çµ±æä¾›è¨­å®š (configure) èˆ‡æ›´æ–° (update) å·¥ä½œã€é æ¸¬è³‡æºéœ€æ±‚ã€å‹•æ…‹æ¨é€è¨­å®šåˆ°åŸ·è¡Œä¸­çš„å·¥ä½œã€æœå‹™ç™¼ç¾ (service discovery) èˆ‡è² è¼‰å‡è¡¡ (Load balancing)ï¼Œç­‰ç­‰åŠŸèƒ½ã€‚é€™äº›ç”Ÿæ…‹ç³»çš„é–‹ç™¼åŸºæ–¼ Google ä¸åŒåœ˜éšŠçš„éœ€æ±‚ï¼Œç”¢ç”Ÿä¸€å€‹ä¸åŒèµ·æº (heterogeneous)ã€åªé‡å°å„åˆ¥éœ€æ±‚çš„ (ad-hoc) ä¸€å€‹å †ä¸åŒç³»çµ±ï¼ŒBorg çš„ä½¿ç”¨è€…éœ€è¦ä½¿ç”¨ä¸åŒçš„ç¨‹å¼èªè¨€èˆ‡ç¨‹åºï¼Œä¾†èˆ‡é€™äº›ç³»çµ±äº’å‹•ã€‚Borg ä»ç„¶æ˜¯ Google ä¸»è¦çš„å®¹å™¨ç®¡ç†ç³»çµ±ï¼Œå› ç‚ºä»–è¦æ¨¡ (scale) å·¨å¤§ï¼ŒåŠŸèƒ½å¤šæ¨£ï¼Œè€Œä¸”æ¥µåº¦å …å›º (robustness)ã€‚\u003c/p\u003e","title":"Borg Omega and Kubernetes Translation å…¨æ–‡ç¿»è­¯"},{"content":"é€™æ˜¯åŸæ–‡ç¿»è­¯çš„å¤ªé•·ä¸è®€ (TL;DR) ç‰ˆæœ¬ã€‚å®Œæ•´ç¿»è­¯è«‹è¦‹Borg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæµ©æ–‡å®Œæ•´ç¿»è­¯\nåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\nå‰è¨€ Borg ä»¥å‰å°±æœ‰æ‡‰ç”¨ç®¡ç†ç³»çµ±ï¼Œé‚£æ™‚é‚„æ²’æœ‰ Linux control group Borg æ˜¯ç¬¬ä¸€å¥—çµ±ä¸€çš„ container-management system Borg ä»è¢«å¤§è¦æ¨¡çš„ä½¿ç”¨ï¼Œæœ‰è¨±å¤šåŠŸèƒ½è€Œä¸”éå¸¸å …å›º Omega ç¹¼æ‰¿ Borg ä¸ŠæˆåŠŸçš„è¨­è¨ˆï¼Œä¸¦å¸Œæœ›æ”¹é€² Borg çš„ç”Ÿæ…‹ç³» Kubernetes é–‹æº é€é REST API æºé€š client æ‡‰ç”¨é–‹ç™¼å°å‘ï¼Œè‘—é‡æ–¼é–‹ç™¼è€…çš„éœ€æ±‚ï¼Œå¸Œæœ›èƒ½ç°¡å–®çš„éƒ¨ç½²è¤‡é›œçš„ç³»çµ± Container Google ä½¿ç”¨ Container ä¾†ææ˜‡ utilization æŠŠ batch jobs è·Ÿé ç•™è³‡æºçš„æœå‹™ (user-facing app) æ”¾åœ¨ä¸€èµ·ï¼Œä½¿ç”¨é–’ç½®æ™‚çš„è³‡æºè·‘ batch job ç¾ä»£ container çš„å®šç¾©æ˜¯ runtime-isolation èˆ‡ image Application-oriented infrastructure container ä½¿ç”¨ä¹…äº†ï¼Œä¸åªæ»¿è¶³ utilization çš„éœ€æ±‚ è³‡æ–™ä¸­å¿ƒå¾æ©Ÿå™¨å°å‘è®Šæˆæ‡‰ç”¨å°å‘ Container å°è£ç’°å¢ƒï¼ŒæŠŠæ©Ÿå™¨èˆ‡ OS çš„ä¾è³´æŠ½è±¡åŒ– æ‡‰ç”¨ä¸ä¾è³´ éƒ¨ç½²æµç¨‹ runtime infrastrcture Container scope åœ¨æ‡‰ç”¨ä¸Šï¼Œå°ˆæ³¨åœ¨æ‡‰ç”¨ç®¡ç†è€Œä¸æ˜¯æ©Ÿå™¨ç®¡ç† Application environment cgroup, chroot, namespace åŸæœ¬çš„ç›®çš„æ˜¯ç‚ºäº†ä¿è­·æ‡‰ç”¨ï¼Œä¸è¢«å…¶ä»–æ‡‰ç”¨å½±éŸ¿ æ··åˆä½¿ç”¨å¯ä»¥åœ¨æ‡‰ç”¨èˆ‡ OS é–“ç”¢ç”ŸæŠ½è±¡å±¤ï¼Œè§£è€¦ app èˆ‡ OS æä¾›å®Œå…¨ç›¸åŒçš„éƒ¨ç½²ç’°å¢ƒï¼Œé¿å…åˆ‡æ›ç’°å¢ƒ(ex. dev, prod)æ™‚é€ æˆç’°å¢ƒå·®ç•° é€²ä¸€æ­¥æŠŠ app çš„ä¾è³´ç¨‹å¼ä¹Ÿæ‰“åŒ… image container å° OS å”¯ä¸€çš„ä¾è³´åªå‰© Linux kernel system-call interface å¤§å¹…å¢åŠ  app èª¿åº¦çš„å½ˆæ€§ ç„¶è€Œæœ‰äº› interface ä»é™„è‘— OS ä¸Šï¼Œex socket, /prod, ioctl calls å¸Œæœ›é€é Open Container Initiativeï¼Œæ¸…æ¥šå®šç¾© interface èˆ‡æŠ½è±¡ ç›´æ¥çš„å¥½è™•ï¼Œå°‘æ•¸å¹¾ç¨® OS èˆ‡ OS Version å°±å¯ä»¥è·‘æ‰€æœ‰æ‡‰ç”¨ï¼Œæ–°ç‰ˆæœ¬ä¹Ÿä¸å½±éŸ¿ Container as the unit of management è³‡æ–™ä¸­å¿ƒçš„é‡å¿ƒï¼Œå¾ç®¡ç†æ©Ÿå™¨è®Šæˆç®¡ç†æ‡‰ç”¨ æä¾›å½ˆæ€§çµ¦ infrastructure team æä¾›çµ±ä¸€çš„æ¶æ§‹ æ”¶é›†çµ±ä¸€çš„ metrics Container çµ±ä¸€çš„ä»‹é¢ï¼Œè®“ management system (ex. k8s) å¯ä»¥æä¾› generic APIs REST API, HTTP, /healthz, exec\u0026hellip; çµ±ä¸€çš„ health check ä»‹é¢ï¼Œæ›´æ–¹ä¾¿çš„çµ‚æ­¢èˆ‡é‡å•Ÿ ä¸€è‡´æ€§ å®¹å™¨æä¾›çµ±ä¸€çš„è³‡è¨Šï¼Œex. status, text message, \u0026hellip; ç®¡ç†å¹³å°æä¾›çµ±ä¸€è¨­å®š (ex. resource limits) ï¼Œä¸¦é€²è¡Œ logging èˆ‡ monitoring æä¾›æ›´ç²¾ç´°çš„åŠŸèƒ½ ex. graceful-termination cgroups æä¾› app çš„è³‡æºä½¿ç”¨è³‡è¨Šï¼Œè€Œä¸éœ€è¦çŸ¥é“ app specï¼Œå› ç‚º contaier æœ¬èº«å³æ˜¯ app æä¾›æ›´ç°¡å–®ï¼Œå»æ›´ç²¾ç´°ä¸”å …å›ºçš„ logging èˆ‡ monitoring æ‡‰ç”¨å°å‘çš„ monitoring ï¼Œè€Œä¸æ˜¯æ©Ÿå™¨å°å‘çš„ monitoring å¯ä»¥æ”¶é›†è·¨ OS çš„ app ç‹€æ…‹ï¼Œé€²è¡Œæ•´åˆåˆ†æï¼Œè€Œä¸æœƒæœ‰ OS ä¸åŒé€ æˆçš„é›œè¨Š æ›´å®¹æ˜“å°æ‡‰ç”¨é™¤éŒ¯ nested contaiers resource allocation (aka. alloc in Borg, Pod in Kubernetes) Orchestration is the beginning, not the end åŸæœ¬ Borg åªæ˜¯è¦æŠŠ workload åˆ†é…åˆ°å…±ç”¨çš„æ©Ÿå™¨ä¸Šï¼Œä¾†æ”¹å–„ utilization çµæœç™¼ç¾å¯ä»¥åšæ›´å¤šäº‹æƒ…ï¼Œä¾†å¹«åŠ©é–‹ç™¼èˆ‡éƒ¨ç½² Naming, service discovery Application-aware load balancing Rollout tool Workflow tool Monitoring tool æˆåŠŸçš„å·¥å…·è¢«ç•™ä¸‹ ç„¶è€Œå·¥å…·éƒ½éœ€è¦å„è‡ªçš„ APIï¼Œå‰¯ä½œç”¨æ˜¯å¢åŠ éƒ¨ç½²çš„è¤‡é›œåº¦åˆ° Borg çš„ç”Ÿæ…‹ç³» Kubernetese è©¦åœ–é™ä½è¤‡é›œåº¦ æä¾›ä¸€è‡´çš„ API ex. ObjectMetadata, Specification, Status Object metadata æ˜¯å…¨åŸŸå…±é€šçš„ Spec èˆ‡ Status æ ¹æ“š Object æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æ¦‚å¿µæ˜¯ä¸€è‡´çš„ Spec æè¿° desired state of object Status æä¾› read-only çš„ current state of object Uniform API æœ‰è¨±å¤šå¥½è™• é™ä½å­¸ç¿’æˆæœ¬ å¯ä»¥ä½¿ç”¨ generic çš„å·¥å…·è®“æ‰€æœ‰ workflow ä½¿ç”¨ çµ±ä¸€ä½¿ç”¨è€…çš„é–‹ç™¼æµç¨‹èˆ‡é–‹ç™¼ç¶“é©— Kubernetes æœ¬èº«æ¨¡çµ„åŒ–ï¼Œå¯ä»¥ä½¿ç”¨å»¶ä¼¸æ¨¡çµ„ ex. pod API è®“ä½¿ç”¨è€…ä½¿ç”¨ï¼Œkubernetes å…§éƒ¨ä½¿ç”¨ï¼Œå¤–éƒ¨è‡ªå‹•åŒ–å·¥å…·ä¹Ÿä½¿ç”¨ ä½¿ç”¨è€…å¯ä»¥è‡ªå·±å¢åŠ  customized API å¦‚ä½•é”åˆ° Uniform API decoupling API åˆ‡åˆ† API é—œæ³¨çš„é¢å‘ï¼Œè®Šæˆä¸åŒ components API. ex. replication controller ç¢ºä¿ desired æ•¸é‡çš„ Pod å­˜åœ¨ autoscaler é—œæ³¨åœ¨éœ€æ±‚èˆ‡ä½¿ç”¨çš„é æ¸¬ï¼Œç„¶å¾Œæ§åˆ¶ replication controller API higher-level æœå‹™éƒ½å…±ç”¨ç›¸åŒçš„ basic API åˆ‡åˆ† API è€Œå¤–çš„å¥½è™• æœ‰é—œè¯ä½†æ˜¯ç”¨é€”ä¸åŒçš„ API çš„å…§å®¹èˆ‡ä½¿ç”¨æ–¹å¼ååˆ†ç›¸ä¼¼. ex. ReplicationController: æ§åˆ¶é•·æ™‚é–“é‹è¡Œçš„ containers èˆ‡å…¶è¤‡æœ¬ DeamonSet: æ¯å€‹æ©Ÿå™¨ä¸Šéƒ½è·‘ä¸€å€‹ container Job: ä¸€æ¬¡æ€§åŸ·è¡Œå®Œç•¢çš„ container Common design patterns ex. reconciliation controller loop åœ¨ Borg, Omega, Kubernetes ä¸­å¤§é‡ä½¿ç”¨ éœ€æ±‚(desired state) è§€å¯Ÿç¾æ³(current state) åŸ·è¡Œå‹•ä½œï¼Œæ”¶æ–‚éœ€æ±‚èˆ‡ç¾æ³(reconcile) loop ç”±æ–¼ç‹€æ…‹æ˜¯åŸºæ–¼å¯¦éš›è§€æ¸¬ç”¢ç”Ÿï¼Œreconciliation loop éå¸¸å …å›ºï¼Œå¯ä»¥æ‰¿å—ç›¸ç•¶çš„ failure Kubernetes è¨­è¨ˆç‚ºä¸€é€£ä¸²çš„ç‚ºæœå‹™ç³»çµ±ï¼Œä»¥åŠè¨±å¤šå°å‹çš„ control loop å°æ¯”å¤§å‹çš„ centralized orchestration system Things to avoid Google é–‹ç™¼éç¨‹ä¸­ï¼Œä¹Ÿç™¼ç¾è¨±å¤šä¸è©²åšçš„äº‹æƒ…\nä¸è¦ä½¿ç”¨ conainer system ä¾†ç®¡ç† port numbers Borg æœƒæŒ‡å®š unique port number çµ¦æ¯å€‹ container å¿…é ˆç”¨å…¶ä»–æ–¹æ³•å–ä»£ DNS port ä¹Ÿä¸æ˜“åµŒå…¥ URL ä¸­ï¼Œè¦å¦å¤–è™•ç†è½‰å€ éœ€è¦è€Œå¤–çš„ç³»çµ±è™•ç† ip:port Kubernetes é¸æ“‡æŒ‡æ´¾ IP çµ¦ Pod å¯ä»¥ç›´æ¥ä½¿ç”¨å¸¸ç”¨ port (ex. 80,443) å¯ä»¥ä½¿ç”¨å…§éƒ¨ DNSï¼Œä½¿ç”¨ä¸€èˆ¬å¸¸ç”¨çš„å·¥å…· å¤§éƒ¨åˆ†å…¬æœ‰é›²éƒ½æä¾› networking underlaysï¼Œé”æˆ Ip-per-pod å¯ä»¥ä½¿ç”¨ DNS overlay æˆ–æ˜¯ L3 routingï¼Œä¾†æ§åˆ¶ä¸€å°æ©Ÿå™¨ä¸Šçš„å¤šå€‹ IPs ä¸è¦å¹« container ç·¨è™Ÿï¼Œä½¿ç”¨ label ä¾†ç®¡ç†å¤§é‡çš„ container Borg æœƒå¹« job å¾ 0 é–‹å§‹ç·¨è™Ÿ å¾ˆç›´è¦ºå¾ˆç›´æ¥ï¼Œä½†ç¨å¾Œå°±å¾Œæ‚”äº† å¦‚æœ job æ­»äº†ï¼Œé‡å•Ÿæ–°çš„ job åœ¨æ©Ÿå™¨ä¸Šå¾Œï¼Œé‚„éœ€è¦å»æ‰¾ä¸Šå€‹æ­»æ‰çš„ job task ä¸­é–“æœƒæœ‰å¾ˆå¤šæ´ (æ­»æ‰çš„ job) æ›´æ–°ç‰ˆæœ¬ï¼Œè¦æ›´æ–° jobs æ™‚æœƒä¾åºé‡å•Ÿ jobs è³‡æ–™å¦‚æœä¹Ÿæ˜¯æ ¹æ“š index åš shardingï¼Œé‡å•Ÿæ™‚è¦å¾©åŸ indexï¼Œä¸ç„¶æœƒæœ‰è³‡æ–™éºå¤± Kubernetes ä½¿ç”¨ label å¯ä»¥é€é label ç®¡ç†ä¸€çµ„ container ä¸€å€‹ container å¯ä½¿ç”¨å¤šå€‹ labelsï¼Œæ›´æ–¹ä¾¿çš„èª¿åº¦ éœ€è¦çš„è³‡è¨Šæ‰“åœ¨ label ä¸Š (ex. role assignments, work-partitioning, sharding\u0026hellip;)ï¼Œæ›´å®¹æ˜“ç®¡ç† æ³¨æ„æ‰€æœ‰æ¬Š Borg ä¸Šï¼Œtasks éƒ½ç¶å®šåœ¨ job ä¸Šï¼Œç”¢ç”Ÿ job ä¹Ÿç”¢ç”Ÿ tasks å¾ˆç›´è¦ºæ–¹ä¾¿ åªå‰©ä¸‹ä¸€ç¨® group æ§åˆ¶æ©Ÿåˆ¶ Kubernetes çš„ pod-lifecycle management (ex. replication controller) ä½¿ç”¨ label selector ä¾†æ§åˆ¶ pod å¯ä»¥å½ˆæ€§æ§åˆ¶å¤§é‡ pod å¯èƒ½æœ‰å¤šå€‹ä¸Šå±¤ controller æ§åˆ¶åŒä¸€å€‹ podï¼Œè¦ç›¡é‡é¿å…é€™ç¨®æƒ…æ³ å¥½è™•æ˜¯ä¿ç•™å½ˆæ€§çš„åŒæ™‚ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šç•Œå®šç®¡ç†çš„ podï¼Œä¸æœƒæœ‰ orphan / adapt pod é€é label é€²è¡Œ service load balance å¦‚æœ pod æœ‰å•é¡Œï¼Œå¯ä»¥è®Šæ›´ labelï¼Œè®“æµé‡ä¸è¦é€²ä¾†ï¼Œä½†åˆä¿ç•™ Pod debug ä¸è¦æš´éœ² raw state Borgmaster æ˜¯ monolithicï¼Œå¯è¦‹æ‰€æœ‰çš„ API Operation Omega ä¸æ˜¯ centralizedï¼Œåªä¿ç•™è¢«å‹•çš„è³‡è¨Šï¼Œä½¿ç”¨ optimistic concurrent control state å­˜åˆ° client storeï¼Œä¸¦åŸºæ–¼ state é€²è¡Œ operation æ‰€æœ‰ client éœ€è¦ä½¿ç”¨ä¸€æ¨£çš„ client store library Kubernetes èµ°ä¸­é–“ æ‰€æœ‰ state å­˜å–éœ€è¦é€é centralized API server client components å¯ä»¥ç¨ç«‹é‹ä½œ Some open, hard problems configuration dependency management ","permalink":"https://chechia.net/posts/2020-08-26-borg-omega-and-kubernetes-tldr/","summary":"\u003cp\u003eé€™æ˜¯åŸæ–‡ç¿»è­¯çš„å¤ªé•·ä¸è®€ (TL;DR) ç‰ˆæœ¬ã€‚å®Œæ•´ç¿»è­¯è«‹è¦‹\u003ca href=\"https://chechia.net/posts/2020-09-12-borg-omega-and-kubernetes/\"\u003eBorg Omega and Kubernetes å‰ä¸–ä»Šç”Ÿæµ©æ–‡å®Œæ•´ç¿»è­¯\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eåŸæ–‡ï¼šhttps://storage.googleapis.com/pub-tools-public-publication-data/pdf/44843.pdf\u003c/p\u003e\n\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eBorg ä»¥å‰å°±æœ‰æ‡‰ç”¨ç®¡ç†ç³»çµ±ï¼Œé‚£æ™‚é‚„æ²’æœ‰ Linux control group\u003c/li\u003e\n\u003cli\u003eBorg\n\u003cul\u003e\n\u003cli\u003eæ˜¯ç¬¬ä¸€å¥—çµ±ä¸€çš„ container-management system\u003c/li\u003e\n\u003cli\u003eBorg ä»è¢«å¤§è¦æ¨¡çš„ä½¿ç”¨ï¼Œæœ‰è¨±å¤šåŠŸèƒ½è€Œä¸”éå¸¸å …å›º\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eOmega\n\u003cul\u003e\n\u003cli\u003eç¹¼æ‰¿ Borg ä¸ŠæˆåŠŸçš„è¨­è¨ˆï¼Œä¸¦å¸Œæœ›æ”¹é€² Borg çš„ç”Ÿæ…‹ç³»\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes\n\u003cul\u003e\n\u003cli\u003eé–‹æº\u003c/li\u003e\n\u003cli\u003eé€é REST API æºé€š client\u003c/li\u003e\n\u003cli\u003eæ‡‰ç”¨é–‹ç™¼å°å‘ï¼Œè‘—é‡æ–¼é–‹ç™¼è€…çš„éœ€æ±‚ï¼Œå¸Œæœ›èƒ½ç°¡å–®çš„éƒ¨ç½²è¤‡é›œçš„ç³»çµ±\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"container\"\u003eContainer\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eGoogle ä½¿ç”¨ Container ä¾†ææ˜‡ utilization\n\u003cul\u003e\n\u003cli\u003eæŠŠ batch jobs è·Ÿé ç•™è³‡æºçš„æœå‹™ (user-facing app) æ”¾åœ¨ä¸€èµ·ï¼Œä½¿ç”¨é–’ç½®æ™‚çš„è³‡æºè·‘ batch job\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eç¾ä»£ container çš„å®šç¾©æ˜¯ runtime-isolation èˆ‡ image\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"application-oriented-infrastructure\"\u003eApplication-oriented infrastructure\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003econtainer ä½¿ç”¨ä¹…äº†ï¼Œä¸åªæ»¿è¶³ utilization çš„éœ€æ±‚\n\u003cul\u003e\n\u003cli\u003eè³‡æ–™ä¸­å¿ƒå¾æ©Ÿå™¨å°å‘è®Šæˆæ‡‰ç”¨å°å‘\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eContainer å°è£ç’°å¢ƒï¼ŒæŠŠæ©Ÿå™¨èˆ‡ OS çš„ä¾è³´æŠ½è±¡åŒ–\n\u003cul\u003e\n\u003cli\u003eæ‡‰ç”¨ä¸ä¾è³´\n\u003cul\u003e\n\u003cli\u003eéƒ¨ç½²æµç¨‹\u003c/li\u003e\n\u003cli\u003eruntime infrastrcture\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eContainer scope åœ¨æ‡‰ç”¨ä¸Šï¼Œå°ˆæ³¨åœ¨æ‡‰ç”¨ç®¡ç†è€Œä¸æ˜¯æ©Ÿå™¨ç®¡ç†\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"application-environment\"\u003eApplication environment\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003ecgroup, chroot, namespace åŸæœ¬çš„ç›®çš„æ˜¯ç‚ºäº†ä¿è­·æ‡‰ç”¨ï¼Œä¸è¢«å…¶ä»–æ‡‰ç”¨å½±éŸ¿\n\u003cul\u003e\n\u003cli\u003eæ··åˆä½¿ç”¨å¯ä»¥åœ¨æ‡‰ç”¨èˆ‡ OS é–“ç”¢ç”ŸæŠ½è±¡å±¤ï¼Œè§£è€¦ app èˆ‡ OS\n\u003cul\u003e\n\u003cli\u003eæä¾›å®Œå…¨ç›¸åŒçš„éƒ¨ç½²ç’°å¢ƒï¼Œé¿å…åˆ‡æ›ç’°å¢ƒ(ex. dev, prod)æ™‚é€ æˆç’°å¢ƒå·®ç•°\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eé€²ä¸€æ­¥æŠŠ app çš„ä¾è³´ç¨‹å¼ä¹Ÿæ‰“åŒ… image\n\u003cul\u003e\n\u003cli\u003econtainer å° OS å”¯ä¸€çš„ä¾è³´åªå‰© Linux kernel system-call interface\n\u003cul\u003e\n\u003cli\u003eå¤§å¹…å¢åŠ  app èª¿åº¦çš„å½ˆæ€§\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eç„¶è€Œæœ‰äº› interface ä»é™„è‘— OS ä¸Šï¼Œex socket, /prod, ioctl calls\n\u003cul\u003e\n\u003cli\u003eå¸Œæœ›é€é Open Container Initiativeï¼Œæ¸…æ¥šå®šç¾© interface èˆ‡æŠ½è±¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eç›´æ¥çš„å¥½è™•ï¼Œå°‘æ•¸å¹¾ç¨® OS èˆ‡ OS Version å°±å¯ä»¥è·‘æ‰€æœ‰æ‡‰ç”¨ï¼Œæ–°ç‰ˆæœ¬ä¹Ÿä¸å½±éŸ¿\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"container-as-the-unit-of-management\"\u003eContainer as the unit of management\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eè³‡æ–™ä¸­å¿ƒçš„é‡å¿ƒï¼Œå¾ç®¡ç†æ©Ÿå™¨è®Šæˆç®¡ç†æ‡‰ç”¨\n\u003cul\u003e\n\u003cli\u003eæä¾›å½ˆæ€§çµ¦ infrastructure team\n\u003cul\u003e\n\u003cli\u003eæä¾›çµ±ä¸€çš„æ¶æ§‹\u003c/li\u003e\n\u003cli\u003eæ”¶é›†çµ±ä¸€çš„ metrics\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eContainer çµ±ä¸€çš„ä»‹é¢ï¼Œè®“ management system (ex. k8s) å¯ä»¥æä¾› generic APIs\n\u003cul\u003e\n\u003cli\u003eREST API, HTTP, /healthz, exec\u0026hellip;\u003c/li\u003e\n\u003cli\u003eçµ±ä¸€çš„ health check ä»‹é¢ï¼Œæ›´æ–¹ä¾¿çš„çµ‚æ­¢èˆ‡é‡å•Ÿ\u003c/li\u003e\n\u003cli\u003eä¸€è‡´æ€§\n\u003cul\u003e\n\u003cli\u003eå®¹å™¨æä¾›çµ±ä¸€çš„è³‡è¨Šï¼Œex. status, text message, \u0026hellip;\u003c/li\u003e\n\u003cli\u003eç®¡ç†å¹³å°æä¾›çµ±ä¸€è¨­å®š (ex. resource limits) ï¼Œä¸¦é€²è¡Œ logging èˆ‡ monitoring\n\u003cul\u003e\n\u003cli\u003eæä¾›æ›´ç²¾ç´°çš„åŠŸèƒ½ ex. graceful-termination\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ecgroups æä¾› app çš„è³‡æºä½¿ç”¨è³‡è¨Šï¼Œè€Œä¸éœ€è¦çŸ¥é“ app specï¼Œå› ç‚º contaier æœ¬èº«å³æ˜¯ app\n\u003cul\u003e\n\u003cli\u003eæä¾›æ›´ç°¡å–®ï¼Œå»æ›´ç²¾ç´°ä¸”å …å›ºçš„ logging èˆ‡ monitoring\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eæ‡‰ç”¨å°å‘çš„ monitoring ï¼Œè€Œä¸æ˜¯æ©Ÿå™¨å°å‘çš„ monitoring\n\u003cul\u003e\n\u003cli\u003eå¯ä»¥æ”¶é›†è·¨ OS çš„ app ç‹€æ…‹ï¼Œé€²è¡Œæ•´åˆåˆ†æï¼Œè€Œä¸æœƒæœ‰ OS ä¸åŒé€ æˆçš„é›œè¨Š\u003c/li\u003e\n\u003cli\u003eæ›´å®¹æ˜“å°æ‡‰ç”¨é™¤éŒ¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003enested contaiers\n\u003cul\u003e\n\u003cli\u003eresource allocation (aka. alloc in Borg, Pod in Kubernetes)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"orchestration-is-the-beginning-not-the-end\"\u003eOrchestration is the beginning, not the end\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eåŸæœ¬ Borg åªæ˜¯è¦æŠŠ workload åˆ†é…åˆ°å…±ç”¨çš„æ©Ÿå™¨ä¸Šï¼Œä¾†æ”¹å–„ utilization\n\u003cul\u003e\n\u003cli\u003eçµæœç™¼ç¾å¯ä»¥åšæ›´å¤šäº‹æƒ…ï¼Œä¾†å¹«åŠ©é–‹ç™¼èˆ‡éƒ¨ç½²\n\u003cul\u003e\n\u003cli\u003eNaming, service discovery\u003c/li\u003e\n\u003cli\u003eApplication-aware load balancing\u003c/li\u003e\n\u003cli\u003eRollout tool\u003c/li\u003e\n\u003cli\u003eWorkflow tool\u003c/li\u003e\n\u003cli\u003eMonitoring tool\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eæˆåŠŸçš„å·¥å…·è¢«ç•™ä¸‹\n\u003cul\u003e\n\u003cli\u003eç„¶è€Œå·¥å…·éƒ½éœ€è¦å„è‡ªçš„ APIï¼Œå‰¯ä½œç”¨æ˜¯å¢åŠ éƒ¨ç½²çš„è¤‡é›œåº¦åˆ° Borg çš„ç”Ÿæ…‹ç³»\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetese è©¦åœ–é™ä½è¤‡é›œåº¦\n\u003cul\u003e\n\u003cli\u003eæä¾›ä¸€è‡´çš„ API\n\u003cul\u003e\n\u003cli\u003eex. ObjectMetadata, Specification, Status\u003c/li\u003e\n\u003cli\u003eObject metadata æ˜¯å…¨åŸŸå…±é€šçš„\u003c/li\u003e\n\u003cli\u003eSpec èˆ‡ Status æ ¹æ“š Object æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æ¦‚å¿µæ˜¯ä¸€è‡´çš„\n\u003cul\u003e\n\u003cli\u003eSpec æè¿° desired state of object\u003c/li\u003e\n\u003cli\u003eStatus æä¾› read-only çš„ current state of object\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eUniform API æœ‰è¨±å¤šå¥½è™•\n\u003cul\u003e\n\u003cli\u003eé™ä½å­¸ç¿’æˆæœ¬\u003c/li\u003e\n\u003cli\u003eå¯ä»¥ä½¿ç”¨ generic çš„å·¥å…·è®“æ‰€æœ‰ workflow ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eçµ±ä¸€ä½¿ç”¨è€…çš„é–‹ç™¼æµç¨‹èˆ‡é–‹ç™¼ç¶“é©—\u003c/li\u003e\n\u003cli\u003eKubernetes æœ¬èº«æ¨¡çµ„åŒ–ï¼Œå¯ä»¥ä½¿ç”¨å»¶ä¼¸æ¨¡çµ„\n\u003cul\u003e\n\u003cli\u003eex. pod API è®“ä½¿ç”¨è€…ä½¿ç”¨ï¼Œkubernetes å…§éƒ¨ä½¿ç”¨ï¼Œå¤–éƒ¨è‡ªå‹•åŒ–å·¥å…·ä¹Ÿä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨è€…å¯ä»¥è‡ªå·±å¢åŠ  customized API\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå¦‚ä½•é”åˆ° Uniform API\n\u003cul\u003e\n\u003cli\u003edecoupling API\n\u003cul\u003e\n\u003cli\u003eåˆ‡åˆ† API é—œæ³¨çš„é¢å‘ï¼Œè®Šæˆä¸åŒ components API. ex.\n\u003cul\u003e\n\u003cli\u003ereplication controller ç¢ºä¿ desired æ•¸é‡çš„ Pod å­˜åœ¨\u003c/li\u003e\n\u003cli\u003eautoscaler é—œæ³¨åœ¨éœ€æ±‚èˆ‡ä½¿ç”¨çš„é æ¸¬ï¼Œç„¶å¾Œæ§åˆ¶ replication controller API\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ehigher-level æœå‹™éƒ½å…±ç”¨ç›¸åŒçš„ basic API\u003c/li\u003e\n\u003cli\u003eåˆ‡åˆ† API è€Œå¤–çš„å¥½è™•\n\u003cul\u003e\n\u003cli\u003eæœ‰é—œè¯ä½†æ˜¯ç”¨é€”ä¸åŒçš„ API çš„å…§å®¹èˆ‡ä½¿ç”¨æ–¹å¼ååˆ†ç›¸ä¼¼. ex.\n\u003cul\u003e\n\u003cli\u003eReplicationController: æ§åˆ¶é•·æ™‚é–“é‹è¡Œçš„ containers èˆ‡å…¶è¤‡æœ¬\u003c/li\u003e\n\u003cli\u003eDeamonSet: æ¯å€‹æ©Ÿå™¨ä¸Šéƒ½è·‘ä¸€å€‹ container\u003c/li\u003e\n\u003cli\u003eJob: ä¸€æ¬¡æ€§åŸ·è¡Œå®Œç•¢çš„ container\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCommon design patterns\n\u003cul\u003e\n\u003cli\u003eex. reconciliation controller loop åœ¨ Borg, Omega, Kubernetes ä¸­å¤§é‡ä½¿ç”¨\n\u003cul\u003e\n\u003cli\u003eéœ€æ±‚(desired state)\u003c/li\u003e\n\u003cli\u003eè§€å¯Ÿç¾æ³(current state)\u003c/li\u003e\n\u003cli\u003eåŸ·è¡Œå‹•ä½œï¼Œæ”¶æ–‚éœ€æ±‚èˆ‡ç¾æ³(reconcile)\u003c/li\u003e\n\u003cli\u003eloop\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eç”±æ–¼ç‹€æ…‹æ˜¯åŸºæ–¼å¯¦éš›è§€æ¸¬ç”¢ç”Ÿï¼Œreconciliation loop éå¸¸å …å›ºï¼Œå¯ä»¥æ‰¿å—ç›¸ç•¶çš„ failure\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes è¨­è¨ˆç‚ºä¸€é€£ä¸²çš„ç‚ºæœå‹™ç³»çµ±ï¼Œä»¥åŠè¨±å¤šå°å‹çš„ control loop\n\u003cul\u003e\n\u003cli\u003eå°æ¯”å¤§å‹çš„ centralized orchestration system\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"things-to-avoid\"\u003eThings to avoid\u003c/h1\u003e\n\u003cp\u003eGoogle é–‹ç™¼éç¨‹ä¸­ï¼Œä¹Ÿç™¼ç¾è¨±å¤šä¸è©²åšçš„äº‹æƒ…\u003c/p\u003e","title":"Borg Omega and Kubernetes TLDR æ‘˜è¦ç¿»è­¯"},{"content":"å­£ä¸­å›é¡§\né€™ä¸€å­£é–‹äº†å¾ˆå¤šæ–°å‘ï¼Œå»ä¾†ä¸åŠå¯«æ–‡ç« å¡«ä¸Š\nå®Œæˆçš„æœ‰ Terraform çš„åŸºç¤èˆ‡å¯¦å‹™å°å…¥ç¶“é©—\næ­£åœ¨è¶•å·¥çš„æœ‰ hashicorp vaultï¼ŒGitopsï¼Œèˆ‡ tlsã€‚\nå…¶ä¸­ GitOps å·²ç¶“æœ‰å¼·è€…æˆ‘æœ‹å‹ Hwchiu å·¨å·¨å¡«å‘äº†ï¼Œæˆ‘é€™é‚Šå°±æœƒå·æ‡¶è·³éã€‚å‹æƒ…é€£çµ\nå‰©ä¸‹çš„å¸Œæœ›æœ¬å­£çµæŸå‰èƒ½å¡«å®Œ(æ©é¢)\nå·²å¡«å‘ å¾é›¶é–‹å§‹å°å…¥ Terraform DevOps Taiwan Meetup iThome Cloud Summit æ–°å‘ï¼Œç¢¼è¾²æ­£åœ¨è€•ç”°ï¼ŒæŒ–å‘è‡ªå·±è·³ hashicorp vault install basic operation Sign \u0026amp; manage x509 certificate with pki secret engine å¡«å‘ä¸­ï¼Œæ–‡ç« å°šæœªå®Œæˆ aws\npost/play-aws-eks-with-low-cost: ç²¾ç®—å°ç¥ç«¥ï¼Œå¦‚ä½•ç”¨æœ€å°‘çš„ credits ç© aws eks æœå‹™ tls\npost/openssl-self-sign-tls-with-own-ca post/k8s-manage-tls-certificate gitOps\npost/gitops-with-argo-cd terraform\npost/terraform-infrastructure-as-code-module kubernetes\nborg, omega, and kubernetes ä½œè€…å¤–å‡ºå–æä¸­\u0026hellip; MIT 6.824 Distributed System Learning Note ","permalink":"https://chechia.net/posts/2020-08-19-season-review/","summary":"\u003cp\u003eå­£ä¸­å›é¡§\u003c/p\u003e\n\u003cp\u003eé€™ä¸€å­£é–‹äº†å¾ˆå¤šæ–°å‘ï¼Œå»ä¾†ä¸åŠå¯«æ–‡ç« å¡«ä¸Š\u003c/p\u003e\n\u003cp\u003eå®Œæˆçš„æœ‰ Terraform çš„åŸºç¤èˆ‡å¯¦å‹™å°å…¥ç¶“é©—\u003c/p\u003e\n\u003cp\u003eæ­£åœ¨è¶•å·¥çš„æœ‰ hashicorp vaultï¼ŒGitopsï¼Œèˆ‡ tlsã€‚\u003c/p\u003e\n\u003cp\u003eå…¶ä¸­ GitOps å·²ç¶“æœ‰å¼·è€…æˆ‘æœ‹å‹ Hwchiu å·¨å·¨å¡«å‘äº†ï¼Œæˆ‘é€™é‚Šå°±æœƒå·æ‡¶è·³éã€‚\u003ca href=\"https://hwchiu.com/\"\u003eå‹æƒ…é€£çµ\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eå‰©ä¸‹çš„å¸Œæœ›æœ¬å­£çµæŸå‰èƒ½å¡«å®Œ(æ©é¢)\u003c/p\u003e\n\u003ch1 id=\"å·²å¡«å‘\"\u003eå·²å¡«å‘\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch/posts/185733642920123\"\u003eå¾é›¶é–‹å§‹å°å…¥ Terraform\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eDevOps Taiwan Meetup\u003c/li\u003e\n\u003cli\u003eiThome Cloud Summit\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"æ–°å‘ç¢¼è¾²æ­£åœ¨è€•ç”°æŒ–å‘è‡ªå·±è·³\"\u003eæ–°å‘ï¼Œç¢¼è¾²æ­£åœ¨è€•ç”°ï¼ŒæŒ–å‘è‡ªå·±è·³\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003ehashicorp vault\n\u003cul\u003e\n\u003cli\u003einstall\u003c/li\u003e\n\u003cli\u003ebasic operation\u003c/li\u003e\n\u003cli\u003eSign \u0026amp; manage x509 certificate with pki secret engine\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"å¡«å‘ä¸­æ–‡ç« å°šæœªå®Œæˆ\"\u003eå¡«å‘ä¸­ï¼Œæ–‡ç« å°šæœªå®Œæˆ\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eaws\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003epost/play-aws-eks-with-low-cost: ç²¾ç®—å°ç¥ç«¥ï¼Œå¦‚ä½•ç”¨æœ€å°‘çš„ credits ç© aws eks æœå‹™\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003etls\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003epost/openssl-self-sign-tls-with-own-ca\u003c/li\u003e\n\u003cli\u003epost/k8s-manage-tls-certificate\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003egitOps\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003epost/gitops-with-argo-cd\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eterraform\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003epost/terraform-infrastructure-as-code-module\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ekubernetes\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eborg, omega, and kubernetes\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"ä½œè€…å¤–å‡ºå–æä¸­\"\u003eä½œè€…å¤–å‡ºå–æä¸­\u0026hellip;\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eMIT 6.824 Distributed System Learning Note\u003c/li\u003e\n\u003c/ul\u003e","title":"2020 08 Season Review"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nå„ä½å¥½\nAbout this presentation é–‹å§‹ä¹‹å‰ï¼Œå…ˆåˆ†äº«ä¸€äº›è³‡æº\næŠ•å½±ç‰‡ è¬›ç¨¿ ç¨‹å¼ç¢¼ SOP ç¯„æœ¬ Facebook ç²‰å°ˆ éƒ½æ”¾åœ¨é€™è£¡ï¼Œå› ç‚ºæœ‰é™„é€å­—ç¨¿ï¼Œæ‰€ä»¥å¦‚æœå¾ˆå¿™çš„æœ‹å‹ï¼Œæƒäº† QR code å°±å¯ä»¥å›å®¶è‡ªå·±çœ‹äº†ï¼Œä¸ç”¨å®¢æ°£ã€‚\nç„¶å¾Œæœ‰èˆˆè¶£åœ¨è¿½é€™ç³»åˆ—æ–‡ç« çš„ï¼Œå¯ä»¥å¹«æˆ‘ facebook ç²‰å°ˆæŒ‰å€‹è®šè·Ÿè¿½è¹¤ï¼Œæ¯å‘¨æ–°æ–‡ç« å‡ºä¾†ï¼Œæœƒæ¨æ’­é€šçŸ¥ã€‚\næ–‡ç« åœ¨ chechia.net ä¸Šï¼Œæ–°æ–‡ç« é€šçŸ¥é  facebook ç²‰å°ˆé€™æ¨£ã€‚ä¹Ÿå¯ä»¥åªè¿½è¹¤ä¸æŒ‰è®šã€‚æˆ‘è‡ªå·±çœ‹åˆ¥äººæŠ€è¡“ blog ä¹Ÿå¾ˆå¸¸é€™æ¨£(XD\néœ€æ±‚ å¥½ï¼Œä»Šå¤©ä¾†è¬›å¾—é€™å€‹ Terraform\næˆ‘æœƒå¯¦éš›åˆ†äº«æˆ‘å€‘å…¬å¸ç‚ºé›²åœ˜éšŠå°å…¥çš„ç¶“é©—ï¼Œå‰åŠéƒ¨æœƒæœ‰é»åƒè³¼ç‰©é »é“çš„å»£å‘Š\nä»¥ä¸‹çš„å°è©±æ˜¯ä¸æ˜¯å¸¸å‡ºç¾åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Ÿ\nä»¥ä¸‹é€™æ®µå°è©±å¾ˆè€³ç†Ÿï¼Ÿ ã€Œæ˜¯èª°æ”¹äº†é€™å€‹è¨­å®šï¼Ÿã€\nby é€±ä¸€ä¸Šç­çš„ DevOps èˆ‡é€±å…­å€¼ç­çš„ç¶­é‹åœ˜éšŠ å°å•Ÿç”¨çš„ç’°å¢ƒçš„æŒæ¡å¦‚ä½• ç’°å¢ƒçš„è®Šæ›´èƒ½å¦æ°¸ä¹…ä¿å­˜ ã€Œé€™å€‹ç’°å¢ƒæ€éº¼å°‘ä¸€å€‹è¨­å®šï¼Ÿã€\nç¶²ç«™å™´éŒ¯å¾Œï¼Œæ•´å€‹åœ˜éšŠä¸€æ­¥æ­¥é‡æ¸…å•é¡Œï¼Œä¸æ˜¯ codeï¼Œä¸æ˜¯è®Šæ•¸configï¼Œæ˜¯ infra æœ‰ä¸€å€‹å°åœ°æ–¹æ²’è¨­å®š ç’°å¢ƒè¤‡é›œï¼Œä»¥æˆ‘å€‘çš„ä¾‹å­æ˜¯è¤‡é›œå¾—å¤šé›²ç¶²è·¯ï¼Œå¸¸å‡ºé€™ç¨®å•é¡Œ ç’°å¢ƒè¨­å®šçš„é™¤éŒ¯å¾ˆè²»æ™‚ å®Œå…¨å¯ä»¥é¿å… ã€Œæœƒå‹•å°±å¥½ï¼Œæ²’äº‹ä¸è¦æ”¹ç’°å¢ƒï¼ˆæŠ–ï¼‰ã€\nLegacy site èª¿æ•´ production ç’°å¢ƒæ˜¯å¦æœ‰ä¿¡å¿ƒ æˆ‘å€‘çœ‹ä¸æ…£ç„¡äººæ•´ç†çš„èˆŠæ¶æ§‹ï¼Œå°å…¥ terraform å¾Œï¼Œï¼ˆå¾ˆä¸è¦å‘½çš„ï¼‰æŠŠ production site æ¬éä¸€é æˆ‘æœ‰åæˆçš„ä¿¡å¿ƒè·Ÿä½ èªªæ–°èˆŠå…©å€‹ site å®Œå…¨ä¸€æ¨£ Our stories æˆ‘å€‘æ˜¯æ€è¯ç§‘æŠ€(ï¼¸ï¼¤) é–‹ç™¼åœ˜éšŠå¤§æ¦‚ 100+ å€‹å·¦å³ å°ˆæ¡ˆå¾ˆå¤šï¼Œè€Œä¸”è€é—†å¾ˆå–œæ­¡é–‹æ–°å°ˆæ¡ˆæ¸¬è©¦å•†æ¥­æ¨¡å‹ ç’°å¢ƒä¹Ÿè¶Šé–‹è¶Šå¤šï¼Œå¤§å¤§å°å°å¹¾ç™¾å° vmï¼Œå¹¾åå€‹è³‡æ–™åº«ï¼Œéƒ½æ˜¯ä¸åŒå°ˆæ¡ˆåœ¨è·‘ï¼Œè¦æ¨¡å¤§æ¦‚é€™æ¨£ æ¯é€±éƒ½æœ‰æ–°ç’°å¢ƒè¦äº¤ä»˜ äº¤æ¥ç¼ºå£ æˆ‘å€‘å…¬å¸æ±è¥¿å¤šï¼Œä½†æ±è¥¿å¤šä¸æ˜¯å•é¡Œï¼Œå•é¡Œæ˜¯ä»€éº¼å‘¢?\nå•é¡Œ æ‰‹å‹•éƒ¨å±¬æœ¬ä¾†ä¸æ˜¯å•é¡Œï¼Œä½†æ¼¸æ¼¸æˆç‚ºå•é¡Œ é–‹ infrastructure çš„æ–¹æ³•ï¼Œè·Ÿè‘— SOP ä¸Šå» GCP GUI ä»‹é¢ï¼Œé»ä¸€é»ï¼Œå¡«ä¸€å¡«ã€‚å…¬æœ‰é›²é–‹æ©Ÿå™¨å¾ˆæ–¹ä¾¿ã€‚ å¯æ˜¯ä¸åŒäººé–‹çš„ç’°å¢ƒæ¼¸æ¼¸å‡ºç¾ä¸€äº›ä¸åŒï¼Œå¯èƒ½å·®ä¸€å€‹è¨­å®šã€ä¸€å€‹åƒæ•¸ã€æˆ–æ˜¯å‘½åè¦å‰‡å·®ä¸€é»ã€‚é€™äº›ç´°ç¯€çš„ä¸åŒï¼Œå·®ä¸€å€‹ config æœ‰æ™‚å€™å°±æœƒé›·åˆ°äººã€‚ã€Œé€™æ©Ÿå™¨èª°å»ºçš„é˜¿ï¼Œæ ¹æœ¬æœ‰å•é¡Œå•Šã€ï¼Œè€Œä¸”é€™ç¨®é›·å¾ˆå¤šæ™‚å€™éƒ½æ˜¯è·‘ä¸‹å»å‡ºäº‹äº†ï¼Œæ‰ç™¼ç¾ã€Œé˜¿é åŸä¾†è¨­å®šä¸ä¸€æ¨£ã€ å‘½åå·®ä¸€é»ä¸å½±éŸ¿åŠŸèƒ½ï¼Œä½†çœ‹ä¹…äº†å°±å¾ˆç…©ï¼Œã€Œé˜¿å°±å°ä¸é½Šé˜¿ã€ï¼Œæœ‰å¼·è¿«ç—‡å°±å¾ˆç—›è‹¦ã€‚ç„¶å¾Œä½ ç¶­é‹çš„è‡ªå‹•åŒ–è…³æœ¬å°±çˆ†æ‰ï¼Œå‘½åå·®ä¸€å€‹å­—ï¼Œregex å°±è¦å¤§æ”¹ã€‚çªç„¶å¢åŠ ç¶­é‹æˆæœ¬ ç”Ÿç”¢ç’°å¢ƒå¤§å®¶éƒ½ä¸å¤ªæ•¢å‹•ã€‚æ¶æ§‹èª¿æ•´å¾ˆæ²’ä¿¡å¿ƒ èª°çŸ¥é“ç•¶åˆç’°å¢ƒè¨­å®šäº†é‚£äº›æ±è¥¿ï¼Œé–‹æ©Ÿå™¨çš„äººé›¢è·äº†ï¼Œä¹Ÿä¸çŸ¥é“ä»–ç‚ºå•¥è¨­å®šï¼Œã€Œä½ çŸ¥é“ä»–ç•¶åˆç‚ºä»€éº¼è¦è¨­å®šé€™å€‹å—?ã€ï¼Œä½ å•æˆ‘æˆ‘æ˜¯è¦å»æ“²èŒ­å–”ã€‚ æˆ‘å€‘é€™ä¸€å­£æŠŠæ‰€æœ‰ç¾æœ‰ç’°å¢ƒéƒ½æ¬åˆ°æ–°çš„æ¶æ§‹ä¸Šï¼Œå› ç‚ºæˆ‘å€‘å°èˆŠæ¶æ§‹ä¸çˆ½å¾ˆä¹…äº†(XD)ï¼Œé€™å€‹èƒ½åšåˆ°ç•¶ç„¶æœ‰ä½œæ³•ï¼Œå¾Œé¢ç´°è¬› æœ‰å¯¦éš›éœ€æ±‚æ‰æ‰¾è§£æ±ºæ–¹æ¡ˆï¼Œæ²’æœ‰éœ€æ±‚å°±ä¸ç”¨è¡å‹•å°å…¥æ–°æŠ€è¡“ï¼Œå°å…¥éç¨‹ä¸­é‚„æ˜¯è »ç´¯çš„\néœ€æ±‚ å¾ç¶­é‹çš„è§’åº¦ï¼Œéœ€æ±‚å¤§æ¦‚é•·é€™æ¨£\næå‡ç©©å®šåº¦\ninfra äº¤ä»˜æ¨™æº–åŒ– äº¤ä»˜è‡ªå‹•åŒ– æ¸¬è©¦ç’°å¢ƒ infra æäº¤è¦èƒ½å¤  review\næå‡æ•ˆç‡\nè€é—†è¦çš„ã€‚è¶…å¿«éƒ¨å±¬ï¼Œè…³æœ¬è·‘ä¸‹å»è¦å¿«ï¼Œé‚„è¦æ›´å¿« æ¬¡è¦ç›®æ¨™\næˆæœ¬ï¼Œæ•ˆèƒ½æœ€ä½³åŒ–ï¼Œå¸Œæœ›èƒ½åœ¨æ•´ç†éç¨‹ä¸­ï¼Œæ‰¾åˆ°æœ€é©åˆçš„å¯è¡Œæ¶æ§‹ æ–°äººå¥½ä¸Šæ‰‹ï¼ŒJunior åŒäº‹ä¹Ÿèƒ½ã€Œå®‰å…¨ã€çš„æ“ä½œï¼Œçœ‹åˆ°é€™å€‹å®‰å…¨å…©å€‹å­—äº†å—? å®‰å…¨ç¬¬ä¸€ï¼Œåœ¨è¨“ç·´æ–°çš„ op æ™‚è¦æ³¨æ„å®‰å…¨ï¼Œä¸ç„¶ä»–ä¸Šå» GUI é»ä¸€é»ï¼Œä¸€å€‹æ‰‹èµ·åˆ€è½ DB å°±ä¸è¦‹äº†ï¼Œæ•´å€‹ç¶­é‹åœ˜éšŠä¸€å‘¨ä¸ç”¨ç¡è¦ºã€‚å®‰å…¨ç¬¬ä¸€å¼ã€‚ æ¬Šé™æ§ç®¡ï¼ŒIAM ä¹Ÿç”¨ terraform ç®¡ç†ï¼Œæ¬Šé™ç®¡ç†äººå¤šæ‰‹é›œè¶Šç”¨è¶Šäº‚ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ IaCï¼Œä¸€è¦½ç„¡éº Programatical approach for infra å•Šä¸å°±æ˜¯ Infrastructure as code XD\nå°å…¥å‰ï¼Œå¤§å®¶éƒ½æœ‰è½éï¼Œå¤§å®¶éƒ½è¦ºå¾—å¾ˆæƒ³å°å…¥ï¼Œä½†æ²’äººæœ‰ç¶“é©—ï¼Œæ¯å€‹äººéƒ½è¶…æ€•ï¼Œä½†åˆä¸çŸ¥é“åœ¨æ€•ä¸‰å° é€™è¡¨æ˜äº†ä¸€ä»¶äº‹ï¼Œå¤§å®¶éƒ½çŸ¥é“è¦åšå°çš„äº‹æƒ…ï¼Œä½†ä¸æ˜¯æ¯å€‹äººéƒ½èƒ½æ”¹è®Šç¾æ³ï¼Œè®“åœ˜éšŠå°å‘å°çš„äº‹æƒ… è¨ˆç•«\nç¢ºå®šéœ€æ±‚ é–‹å§‹ survey ã€Œå°å¿ƒã€å°å…¥ æœ‰ç¶“é©—é ˜é ­ç¾Šå¾ˆæ£’ï¼Œä½†ä¸æ˜¯å¿…é ˆ æŠ€è¡“ç´°ç¯€ å…ˆç°¡å–®è¬›ä¸€ä¸‹ IaC (Yeah çµ‚æ–¼è¦è¬›æŠ€è¡“äº†)\nIaC ä¸Šé¢éƒ½è¬›æ¦‚å¿µè·Ÿå¿ƒæ³•ï¼Œç¾åœ¨å¯¦éš›è¬›ç”¨åˆ°çš„æŠ€è¡“ã€‚\né¦–å…ˆæ˜¯ Infrastructure as Codeï¼Œé€™å€‹æ¦‚å¿µå¾ˆä¹…äº†ï¼Œä½†å°å…¥çš„å…¬å¸å¥½åƒä¸æ˜¯é‚£éº¼å¤šã€‚æ‰€ä»¥æˆ‘ä»Šå¤©è¦ä¾†å‚³æ•™ï¼Œæ´—è…¦å¤§å®¶(XDï¼Œè·Ÿä½ æ¨è–¦é€™å€‹é…æ–¹ä¿è­‰å¿«åˆæœ‰æ•ˆ(XD)\nç°¡å–®ä¾†èªªå°±æ˜¯ç”¨ç¨‹å¼ä¾†æ“ä½œ infrastructureï¼Œä»Šå¤©ä¸»è¬›çš„ terraform æ˜¯ IaC å·¥å…·ä¸­çš„ä¸€å€‹ IaC å·¥å…·å¯ä»¥æ˜¯å®£å‘Šå¼ï¼Œæˆ–æ˜¯å‘½ä»¤å¼ï¼Œæˆ–æ˜¯å…©ç¨®éƒ½æ”¯æ´ ä¸€å€‹æ˜¯æˆ‘å‘Šè¨´ä½ çµæœï¼Œæ­¥é©Ÿæˆ‘ä¸ç®¡ï¼Œè«‹ä½ å¹«æˆ‘ç”Ÿå‡ºé€™æ¨£çš„çµæœã€‚ ä¸€å€‹æ˜¯æˆ‘å‘Šè¨´ä½ æ­¥é©Ÿï¼Œä½ ä¸€æ­¥ä¸€æ­¥å¹«æˆ‘åšå®Œï¼Œå°±æœƒå¾—åˆ°æˆ‘è¦çš„çµæœ terraform æ˜¯å®£å‘Šå¼ï¼Œèªªæ˜é‚è¼¯è·Ÿçµæœï¼Œä¾‹å¦‚æˆ‘è¦ 1 2 3 å°æ©Ÿå™¨ï¼Œterraform è‡ªå·±å»å¹«æˆ‘æ‰“ Google API é€™æ¨£ï¼ŒæŠŠæ©Ÿå™¨ç”Ÿå‡ºä¾† ansible æ˜¯å‘½ä»¤å¼ï¼Œæˆ‘æŠŠæ­¥é©Ÿå¯«æˆä¸€å †å‘½ä»¤è…³æœ¬ playbook ï¼Œansible å¹«æˆ‘ç…§è‘—è·‘ä¸‹å»ï¼Œç†è«–ä¸Šè·‘å®Œå¾Œæˆ‘çš„æ©Ÿå™¨ä¹Ÿæº–å‚™å¥½ Terraform å®˜ç¶²åœ¨é€™é‚Šï¼Œè‡ªå·±çœ‹ https://www.terraform.io/ å®£å‘Šå¼çš„ Iac å·¥å…· å–®ä¸€èªæ³•æè¿°å„å®¶ API é€é provider è½‰æ› tf æˆç‚º API call Terraform Core Workflow https://www.terraform.io/guides/core-workflow.html\nWrite æ’°å¯«æœŸå¾…ç‹€æ…‹ tf file plan è¨ˆç•«è©¦ç®—çµæœ apply ç”¨æœŸå¾…ç‹€æ…‹å»æ›´æ–°é ç«¯ tf fileï¼Œå°±æ˜¯å®£å‘Šå¼çš„è¡¨é” infra ï¼Œæè¿°æœŸå¾…çš„infraé•·é€™æ¨£ï¼Œex. tf file è£¡æœ‰é€™äº›æ©Ÿå™¨ 1 2 3 å°é€™æ¨£ resource ä¸€å€‹ä¸€å€‹ç‰©ä»¶æè¿°ï¼Œå¾Œé¢å¯èƒ½æ˜¯å°æ˜  provider çš„ API Endpoint (ex. GCP GKE API) remote resourcesï¼Œæ˜¯çœŸå¯¦å­˜åœ¨é ç«¯çš„æ©Ÿå™¨ï¼Œä¾‹å¦‚ GCP é›²ç«¯å¯¦éš›ä¸Šåªæœ‰ 1 2 å…©å°é€™æ¨£ã€‚ terraform diff tf vs remoteï¼Œç®—å‡º planï¼Œå°‘çš„ç”Ÿå‡ºä¾†ï¼Œå¤šçš„ä¸Šå»ç æ‰ Demo 1 (empty project)\nadd my-gce.tf\ngit diff\nstate\ncheck GUI remote\nexisting my-gce\nremove my-gce.tf\nplan\né€™é‚Šä¸ apply æˆ‘ demo é‚„è¦ç”¨\né€™é‚Šé€™æ¨£æœ‰ç†è§£ terraform çš„åŸºæœ¬æµç¨‹å—ï¼Ÿç·¨å¯«ï¼Œè¨ˆç•«ï¼Œapply ä¸‰æ­¥é©Ÿ å¾ˆå–®ç´” ç„¶å¾Œè¬›ä¸€é»ç´°ç¯€\nstate\nremove (out of scope)\nplan -\u0026gt; addd\napply (deplicated ID)\nmv state (Danger)\nrename state with the same ID -\u0026gt; destroy and recreate (Danger)\nState terraform ç¶“æ‰‹(apply) éçš„ resource æœƒç´å…¥ state (scope)\nä¸åœ¨ scope è£¡çš„ resource ä¸æœƒç´å…¥ planï¼Œä¸æœƒè¢« destroyï¼Œä½†å¯èƒ½æœƒ create duplicated ID\nterraform å…è¨±ç›´æ¥æ“ä½œ state\nimport remove ä½†æˆ‘ä¸å…è¨±XD æ³¨æ„æ˜¯ diff state å–”ï¼Œæ‰€ä»¥æ¯æ¬¡ plan æ™‚å€™æœƒè‡ªå‹• refresh state\nstate åˆæ˜¯ä»€éº¼? remote æ˜¯ä¸€å€‹å‹•æ…‹ç’°å¢ƒï¼Œå¯èƒ½æœƒå¤šæœƒå°‘ï¼Œé€™æ¨£æ²’è¾¦æ³• diffï¼Œstate æ˜¯æŠŠæˆ‘åŸ·è¡Œç•¶ä¸‹ï¼Œé ç«¯ç›¸é—œè³‡æºçš„ç‹€æ…‹å¿«ç…§å­˜èµ·ä¾†ï¼Œç„¶å¾Œæ ¹æ“šé€™å€‹ snapshop å» diff\napply åªæ˜¯æ‹¿ä½ çš„æœŸå¾…å» diff stateï¼Œterraform å¹«ä½ ç®—å‡ºä¾†å·®å¤šå°‘ï¼Œä¾‹å¦‚æˆ‘å€‘é€™é‚Šå°±æ˜¯é ç«¯å°‘ä¸€å°ã€‚terraform é€é provider å»çŸ¥é“ï¼Œå–”é€™ä¸€å°è¦å»æ‰“é‚£äº› GCP APIï¼ŒæŠŠé€™å°ç”Ÿå‡ºä¾†ã€‚\nStateï¼Œæ˜¯æ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ç•¶åˆè‡ªå·±å¡è§€å¿µæ˜¯å¡é€™é‚Šï¼Œæ‰€ä»¥æˆ‘ç‰¹åˆ¥æ‹‰å‡ºä¾†è¬›\né›²ç«¯ç©ºè•©è•©ï¼Œrefresh state ä¹Ÿæ˜¯ç©ºçš„ï¼Œtf file å¤šåŠ ä¸€å€‹ VMï¼Œplan è¦ºå¾—è¦ create é›²ç«¯æœ‰æ±è¥¿ï¼Œrefresh state æœªå¿…æœƒ refresh åˆ° ç›¸åŒ ID çš„è³‡æºä¹‹å‰ import åœ¨ state ä¸­ï¼Œrefresh stateï¼Œtf file æ²’æ±è¥¿ï¼Œplan è¦ºå¾—è¦ destroy ç›¸åŒ ID çš„è³‡æºä¸åœ¨ state ä¸­ï¼Œé€™äº› resource ä¸åœ¨ç•¶å‰ state çš„ scopor ä¸­ï¼Œrefresh state æ˜¯ç©ºçš„ï¼Œtf file æ²’æ±è¥¿ï¼Œplan è¦ºå¾—æ²’å¢æ²’æ¸› ç›¸åŒ ID çš„è³‡æºä¸åœ¨ state ä¸­ï¼Œé€™äº› resource ä¸åœ¨ç•¶å‰ state çš„ scopor ä¸­ï¼Œrefresh state æ˜¯ç©ºçš„ï¼Œtf file æœ‰ç›¸åŒ ID çš„è³‡æºï¼Œplan è¦ºå¾—è¦ createï¼Œä½†å¯¦éš› applyï¼ŒAPI error é ç«¯å·²ç¶“æœ‰ç›¸åŒ ID çš„è³‡æºå­˜åœ¨ å°çµ Write -\u0026gt; Plan -\u0026gt; Apply State å¤§å®¶éƒ½æœƒ terraform æƒ¹ åˆæ­¥ä½¿ç”¨æ„Ÿæƒ³ IaC åœ°ç«¯è·Ÿé›²ç«¯éƒ½èƒ½åšï¼Œä½†é›²ç«¯åšèµ·ä¾†æ•ˆæœè¶…ç´šå¥½ å®Œå…¨å±•ç¾é›²ç«¯é‹ç®—çš„ç‰¹æ€§ï¼Œè¿…é€Ÿã€å½ˆæ€§ã€éš¨ç”¨éš¨å«ï¼Œèª¿åº¦å¤§é‡çš„è™›æ“¬åŒ–è³‡æº æ–°å¢æ±è¥¿å¾ˆå¿«ï¼Œä¸è¦çš„è³‡æºï¼Œè¦åˆªæ‰ä¹Ÿå¾ˆå¿« ä¸å°å¿ƒåˆªéŒ¯ä¹Ÿå¾ˆå¿«(å¤§èª¤)ï¼Œæ‰€ä»¥æˆ‘èªªæ–°äººä¸€å€‹æ‰‹èµ·åˆ€è½å…¬å¸æ•´å€‹é›²å¼„ä¸è¦‹ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼Œã€Œå•Šæˆ‘çš„é›²å‹’ã€ã€Œè¢« terraform ç äº†ã€ã€‚ä¸è¦ç¬‘ï¼Œé‚£å€‹æ–°äººå°±æ˜¯æˆ‘ï¼Œæˆ‘è‡ªå·±å‰›å­¸çš„æ™‚å€™å°±æœ‰æŠŠæ•´å€‹ db è®Šä¸è¦‹éï¼Œå·®é»ä¸€åˆ°è·å°±å¼•å’è¾­è·(XDã€‚ç”¨é€™äº›æŠ€è¡“é‚„æ˜¯æœ‰å¾ˆå¤šå®‰å…¨è¦æ³¨æ„ï¼Œç¨å¾Œæœƒç´°è¬›æ³¨æ„çš„å®‰å…¨äº‹é …ã€‚ ç¸½ä¹‹ï¼ŒIac å°±æ˜¯ç”¨ç¨‹å¼åŒ–çš„èªæ³•ï¼Œç²¾æº–çš„æè¿°é›²ç«¯çš„ç‹€æ…‹æˆ–æ˜¯æ­¥é©Ÿï¼Œå®Œå…¨æ²’æœ‰æ¨¡ç³Šçš„åœ°å¸¶ã€‚å¸¶ä¾†çš„å¥½è™•ï¼Œé™ä½ç¶­é‹çš„éŒ¯èª¤é¢¨éšªï¼ŒåŠ å¿«ç¶­é‹æ•ˆç‡ï¼Œæœ€ä½³åŒ–ç¯€çœæˆæœ¬ã€‚\næ–°æ‰‹ state çš„é›· å¤šäººå”ä½œï¼ŒåŒæ™‚è®Šæ›´ state æœƒé€ æˆä¸å¯é æœŸçš„éŒ¯èª¤ é¿å…ç›´æ¥æ“ä½œ state state å¯èƒ½æœ‰ sensitive è³‡æ–™ æ¨è–¦ä½¿ç”¨å¤–éƒ¨å¸¶æœ‰ lock çš„ state storage å°å…¥ å°å…¥å·¥å…·ä¹‹å¾Œ æ–°å·¥å…·å°å…¥æ™‚è¦åšå¥½é¢¨éšªè©•ä¼°ï¼Œæ¯å€‹äººéƒ½æ˜¯ç¬¬ä¸€æ¬¡ç”¨ terraform ï¼Œç”¨èµ·ä¾†å¾ˆå¿«å¾ˆçˆ½çš„åŒæ™‚ä¹Ÿè¦ä¸æ–·å®£å°å®‰å…¨æ¦‚å¿µï¼Œé›·åœ¨å“ªè£¡å‘åœ¨å“ªè£¡ã€‚\nä½¿ç”¨ terraform çš„é¢¨éšª\næ‰“ DELET API è¶…å¿«ï¼Œç èµ·ä¾†å¾ˆæ–¹ä¾¿ï¼Œä½†å¾ˆå¤šæ™‚å€™æ–¹ä¾¿ = å±éšªã€‚çœ¼çœ‹å°æ˜ä¸€å€‹æ‰‹èµ·åˆ€è½ï¼Œè«‡ç¬‘é–“ï¼Œå…¬æœ‰é›²ç°é£›ç…™æ»…(XDï¼Œé€šé€šè®Šä¸è¦‹ã€‚ç¾åœ¨åœ¨è¬›æ•…äº‹å¾ˆé–‹å¿ƒï¼Œå¯¦éš›ç™¼ç”Ÿçš„è©±å¤§å®¶éƒ½ç¬‘ä¸å‡ºä¾†ï¼Œå…¨å…¬å¸ RD éƒ½è·‘ä¾†ç¶­é‹éƒ¨é–€æ’éšŠç›¯è‘—ä½ çœ‹ï¼Œå°±ç®—ä¿®å¥½ä¹Ÿè¦æ‡²è™•ã€‚å£“åŠ›è¶…å¤§ã€‚ä½†å°æ˜ç éŒ¯æ±è¥¿ä¸æ˜¯å°æ˜çš„éŒ¯ï¼Œæ˜¯å¤§ç’°å¢ƒçš„éŒ¯æ˜¯ SOP çš„éŒ¯(XDã€‚èªçœŸçš„ï¼Œåœ˜éšŠæ²’æœ‰æä¾› SOPï¼Œæ–°äººç éŒ¯æ±è¥¿ç•¶ç„¶æ˜¯åœ˜éšŠè² è²¬ã€‚æ‰€ä»¥æˆ‘å€‘ SOP ç¬¬ä¸€è¡Œå°±å¯«å¾—å¾ˆæ¸…æ¥šã€‚ çœ‹è¦‹ destroy å°±é›™æ‰‹é›¢é–‹éµç›¤ï¼Œç›´æ¥æ±‚æ•‘ï¼Œé€™æ¨£é‚„èƒ½å‡ºäº‹å— å†ä¾†ï¼Œçµ¦äºˆç‰¹æ®Šçš„ IAM æ¬Šé™ï¼Œä¾‹å¦‚åªèƒ½æ–°å¢ä¸èƒ½åˆªé™¤çš„æ¬Šé™ é€²ä¸€æ­¥å°å…¥ git-flowï¼Œpushã€reviewã€PRï¼Œè®“ä»–é€£çŠ¯éŒ¯çš„æ©Ÿæœƒéƒ½æ²’æœ‰ æ ¹æœ¬é‚„æ˜¯è¦çµ¦äºˆæ–°äººè¶³å¤ çš„è¨“ç·´ï¼Œç„¶å¾ŒåŒæ™‚ä¿éšœå…¬å¸å®‰å…¨ã€‚ çµ¦æ–°äººéå¤§æ¬Šé™ç éŒ¯æ±è¥¿ï¼Œæˆ–æ˜¯å·¥ä½œæµç¨‹ä¸€å †å‘ï¼Œæ ¹æœ¬æ˜¯åœ¨èª˜å°æ–°äººçŠ¯éŒ¯ï¼Œåœ˜éšŠçš„è³‡æ·±æˆå“¡è¦æª¢è¨ã€‚ é€æ¼¸å°å…¥ å°å…¥çš„éç¨‹ä¸æ–·æª¢è¨è·Ÿä¿®æ”¹ï¼Œæœ€å¾Œæ‰¾å‡ºé©åˆæˆ‘å€‘å…¬å¸çš„æµç¨‹ æª¢è¨é€æ˜ï¼Œæœ‰éŒ¯å°±ä¿® SOPï¼Œä¿®å·¥ä½œæµç¨‹ã€‚è®“ä½ çš„å·¥ä½œæµç¨‹è·Ÿå·¥ä½œç’°å¢ƒï¼Œå›ºè‹¥é‡‘æ¹¯ï¼Œæˆå“¡å¾ˆé›£åœ¨è£¡é¢çŠ¯éŒ¯ï¼Œé€™æ‰æ˜¯ DevOps åœ¨åšé€™çš„äº‹ã€‚ å®˜æ–¹å»ºè­°çš„æœ€ä½³å¯¦ä½œ https://www.terraform.io/docs/cloud/guides/recommended-practices/index.html è‡³æ–¼æˆ‘å€‘æ˜¯å¦‚ä½•é€æ¼¸å°å…¥ IaC åˆ°å…¬å¸çš„é–‹ç™¼æµç¨‹ä¸­ï¼Ÿå…·é«”çš„å°å…¥æ­¥é©Ÿå¦‚ä¸‹ Introduction: IaC èˆŠæ¶æ§‹ä¿å­˜ã€‚å…ˆæŠŠé›²ç«¯ä¸Šå·²ç¶“æœ‰çš„æ©Ÿå™¨ï¼Œterraform è£¡é¢å«è³‡æºï¼Œimport æˆä»£ç¢¼ æª¢æŸ¥èˆŠæ¶æ§‹ã€‚æ‰€æœ‰è¨­å®šéƒ½è®Šæˆä»£ç¢¼äº†ï¼Œè·Ÿä½ çœ‹ç¨‹å¼ç¢¼ä¸€æ¨£ï¼Œä¸€æ‹å…©çªçœ¼æ²’æœ‰ä»»ä½•æ¨¡ç¨œå…©å¯ã€‚æ•´ç†éç¨‹ä¸­æ‰¾å‡ºåˆç†è·Ÿä¸åˆç†çš„è¨­å®šã€‚æœ‰å¯èƒ½æœƒç™¼ç¾ä¸€äº›é›·ï¼Œåªæ˜¯é‚„æ²’çˆ†ç‚¸ï¼Œä¹Ÿè¶æ©Ÿä¿®ä¸€ä¿®ã€‚ ç„¶å¾Œï¼Œä¾ç…§é€™äº›ç¾è¡Œçš„è³‡æºï¼Œå»æ•´ç†ä¸€ä»½é©åˆå…¬å¸çš„ç’°å¢ƒç¯„æœ¬ï¼Œä¹‹å¾Œæ‰€æœ‰çš„æ–°ç’°å¢ƒéƒ½é€™é€™å€‹ç¯„æœ¬éƒ¨å±¬ï¼Œç¢ºå®šæ–°çš„ç’°å¢ƒéƒ½æœ‰åˆç†çš„è¦åŠƒã€‚ åˆ°æ­¤ï¼Œæ‰€æœ‰æ–°ç’°å¢ƒéƒ½æ˜¯åŒä¸€ä»½ç¯„æœ¬ç”Ÿå‡ºä¾†çš„ï¼Œç’°å¢ƒå·²ç¶“æ¨™æº–åŒ–äº†ã€‚ä¸æœƒå†æœ‰é›¶ç¢çš„å°éŒ¯èª¤ã€‚è½èµ·ä¾†è¶…è®šï¼Œä½†æœ‰æ™‚å€™å‡ºéŒ¯å°±æ˜¯ä¸€èµ·å…¨éŒ¯ï¼Œè¶…æ…˜(XDã€‚ç•¶ç„¶æœ‰éŒ¯å°±ä¿®ç¯„æœ¬ï¼Œä¿® SOPã€‚åŒæ¨£çš„éŒ¯æ°¸ä¸å†çŠ¯ï¼Œä¸ç”¨å†ä¿®ç¬¬äºŒæ¬¡ã€‚ Introduction: Git-flow ç„¶å¾Œï¼Œå°å…¥ç‰ˆæœ¬æ§ç®¡ï¼Œæ•´åˆ git-flow çš„é–‹ç™¼æµç¨‹ã€‚å¯« SOPï¼Œä¹‹å¾Œæ‰€æœ‰è®Šæ›´éƒ½è¦ å…ˆæŠŠ master å°èµ·ä¾†ï¼Œæ‰€æœ‰äººéƒ½ä¸å‡†ç›´æ¥æ”¹æ¶æ§‹ é–‹æ–° branchï¼Œcommit é–‹ PR å¤§å®¶ reviewï¼Œå¤§å®¶éƒ½çœ‹éäº†å¼ï¼Œå† merge é€²å»ï¼Œé€™æ¨£æœ‰éŒ¯å°±ä¸æ˜¯ä¸€å€‹äººçš„é‹è€Œæ˜¯å¤§å®¶ä¸€èµ·èƒŒé‹(XDã€‚ä¸æ˜¯æ‹‰ï¼Œreview èƒ½å¤§å¹…é™ä½éŒ¯èª¤ï¼Œåˆ†äº«åœ˜éšŠç¶“é©—åŠ é€Ÿæ–°äººè¨“ç·´ï¼Œä¸¦ä¸”è®“æ‰€æœ‰äºº on the same pageï¼Œä¸æœƒå†æœ‰ã€Œé˜¿é é€™æ©Ÿå™¨èª°é–‹çš„ã€æœ‰äººä¸çŸ¥æƒ…çš„äº‹æƒ…ã€‚ æ°¸é åªä½¿ç”¨ master ä¾†éƒ¨å±¬é›²ç«¯è³‡æºï¼Œä¹Ÿæ˜¯ç¢ºå®šæ‰€æœ‰æ¶æ§‹éƒ½ç¶“éå¤šäºº reviewã€‚ Introduction: Pipeline Automation æœ€å¾Œï¼Œæ•´åˆ CICDï¼Œè®“æ¶æ§‹çš„éƒ¨å±¬å®Œå…¨è‡ªå‹•åŒ–ã€‚æŠŠäººå·¥é™åˆ°æœ€ä½ï¼ŒåŒæ™‚ä¹ŸæŠŠäººå·¥éŒ¯èª¤çš„æ©Ÿç‡é™åˆ°æœ€ä½ï¼Œç•¶ç„¶é€™å€‹ä¹Ÿæ˜¯æ²’éŒ¯éƒ½æ²’éŒ¯ï¼Œè¦éŒ¯ä¸€èµ·éŒ¯çš„ç‹€æ…‹(XDï¼Œä½¿ç”¨æ™‚é‚„æ˜¯è¦æ³¨æ„ã€‚ä½†å¦‚æœåŸ·è¡Œçš„å¾ˆç©©å®šçš„è©±ï¼Œè‡ªå‹•åŒ–çµ•å°æ˜¯å€¼å¾—æŠ•è³‡çš„ã€‚å› ç‚ºç¾åœ¨æŠŠæ¶æ§‹ç•¶ä½œç”¢å“åšï¼Œéƒ¨å±¬å®Œè¦æ¸¬è©¦åŠŸèƒ½ï¼Œç¶²è·¯è¨­å®šæ˜¯å¦æ­£ç¢ºï¼Œç›£æ§æ˜¯å¦å®Œæ•´ï¼Œproxy æ˜¯ä¸æ˜¯è¦æ‰“çœ‹çœ‹ã€‚é€™äº›éƒ½æ•´åˆé€² infra è‡ªå‹• pipelineã€‚éƒ¨å±¬å®Œå°±æ˜¯æ¸¬è©¦ï¼Œç„¶å¾Œäº¤ä»˜çµ¦å…¶ä»–åœ˜éšŠã€‚ ä¹‹å¾Œå°±æ˜¯ä¸æ–·èª¿æ•´ SOPï¼Œè·Ÿ CI/CD pipelineã€‚æŠŠç¶­é‹æ­¥é©Ÿè½‰æˆç¨‹å¼ç¶­è­·ã€‚ çŠ¯éŒ¯éä¸€æ¬¡ï¼Œæ°¸ä¸å†çŠ¯ã€‚é€™å€‹å°æ–¼é•·æœŸåœ˜éšŠç¶“ç‡Ÿéå¸¸é‡è¦ï¼Œè®“ç¶“é©—è·ŸçŸ¥è­˜ç´¯ç©ï¼Œåœ˜éšŠè³ªé‡æ‰æœƒæˆé•·ã€‚IaC åœ¨é€™é»å¹«åŠ©å¾ˆå¤§ã€‚\nDemo 2 NAME=terraform-devops make gke redis sql module git commit Review on github Merge request Repo æˆ‘ä½¿ç”¨çš„åŸç¢¼éƒ½é–‹æºåœ¨ github ä¸Šï¼Œå› ç‚ºæ˜¯çœŸçš„æ‹¿ä¾†å°å…¥æˆ‘å€‘å…¬å¸çš„æ¶æ§‹ï¼Œä¿è­‰å¯ä»¥ç”¨ã€‚é˜¿ä¸èƒ½ç”¨çš„è©±ï¼Œå¹«æˆ‘ç™¼ issue çµ¦æˆ‘ï¼Œæˆ–æ˜¯ä½ äººæ›´å¥½ç™¼å€‹ PR çµ¦æˆ‘éƒ½å¯ä»¥(XDã€‚æŠŠ repo æ‹‰ä¸‹ä¾†ï¼Œé€™é‚Šæœ‰ gcp / azure / awsï¼Œé›–ç„¶æœ‰ä¸‰å€‹ä½†æˆ‘å€‘å…¬å¸ä¸»è¦æ˜¯ç”¨ gcpï¼Œå‰©ä¸‹å…©å€‹æˆ‘è‡ªå·±åšèˆˆè¶£çš„ã€‚è£¡é¢ templates è·Ÿ modules ï¼Œä½†ä½ ä¸ç”¨ç®¡ï¼Œæˆ‘ makefile éƒ½å¯«å¥½äº†\næˆ‘é€™é‚Šè¦æ–°å¢ä¸€å€‹ kubernetes é›†ç¾¤ æˆ‘ç›´æ¥é€²ä¾†æˆ‘çš„å°ˆæ¡ˆï¼Œ NAME=my-new-k8s make gkeï¼Œæ±è¥¿å°±ç”Ÿå‡ºä¾†ï¼Œå…·é«”åšçš„äº‹æƒ…å°±æ˜¯æ–°å¢å…©å€‹ç¨‹å¼å€å¡Šï¼Œæ¯å€‹å€å¡Šæè¿°ä¸€å€‹æ©Ÿå™¨ git diff çœ‹å¤šäº†ä»€éº¼ï¼Œé€™é‚Šå¤šä¸€å€‹ k8s è·Ÿå¤šä¸€å€‹ node-pool ç„¶å¾Œæˆ‘ planï¼Œè®“ terraform é æ¸¬ä¸€ä¸‹è©¦è·‘çµæœï¼Œæˆ‘å€‘ä¾æ“šçµæœå¥½å¥½ reviewï¼Œä¾‹å¦‚é€™é‚Š 2 to add 0 to destroy æˆ‘çš„æƒ³åƒæ˜¯ä¸æ˜¯çœŸçš„è·Ÿ terraform è¨ˆç•«ä¸€æ¨£ã€‚ ç„¶å¾Œ terraform applyï¼Œé€™é‚Šè¦çœ‹æ¸…æ¥šï¼Œæˆ‘å€‘æ˜¯ 2 to add 0 to destroyï¼Œå¦‚æœçœ‹åˆ°æœ‰ destroy å°±è¦é›™æ‰‹é›¢é–‹éµç›¤ï¼Œå¤§å®¶ä¸è¦è¡å‹•ï¼Œçœ‹æ¸…æ¥šï¼Œå› ç‚ºå¥¹çœŸçš„æœƒä¸Šå»æŠŠæ±è¥¿ç æ‰ P.S. å°ˆæ¡ˆå¯ä»¥æŒ‰ç…§å…¬å¸éœ€æ±‚åˆ†ï¼Œè³‡æºå¤ªå¤šå¤ªæ“ å°±æ‹†åˆ†æˆå¹¾å€‹è³‡æ–™å¤¾å¥½ç®¡ç†ï¼Œç„¶å¾Œåˆ†æ¬Šè²¬ç®¡ç†ï¼Œä¾‹å¦‚é¤¨ iam çš„ã€ç®¡ç¶²è·¯ã€ç®¡æ‡‰ç”¨æ©Ÿå™¨çš„å¯ä»¥åˆ†é–‹ä¾†\nGit-flow ç„¶å¾Œå› ç‚ºæˆ‘å¾Œé¢æœƒè¬› git-flow å·¥ä½œæµç¨‹æ•´åˆï¼Œæ‰€ä»¥æˆ‘é †ä¾¿åšå®Œã€‚\næ–°çš„è®Šæ›´ commit ï¼Œplan ä½†æ˜¯é‚„æ²’ applyã€‚æˆ‘è¦æ±‚æ‰€æœ‰æ–°çš„ commit æ¨ä¸Šå» ç™¼ PRï¼Œå…¶ä»–åœ˜éšŠæˆå“¡ä¾†å¹«æˆ‘ reviewã€‚PR ç”¨çš„ template ï¼Œæè¿°ä¸€ä¸‹æ–°æ¶æ§‹çš„ç›®çš„ï¼Œè®Šæ›´çš„åœ°æ–¹ï¼Œæœ‰æ²’æœ‰é›·ï¼Œç„¶å¾Œå¹¾å€‹ checklist æª¢æŸ¥ å…¶ä»–éšŠå“¡ review éƒ½ lgtm æ‰ merge å› master apply æ°¸é åœ¨æœ€æ–°çš„ master ä¸Š applyï¼Œç¢ºä¿æ‰€æœ‰æ¨åˆ°é›²ç«¯çš„æ¶æ§‹éƒ½æ˜¯å¤šäºº review éçš„ã€‚ æœ‰ review æ‰æœ‰å“è³ªå¯è¨€ï¼Œcode éƒ½è¦ reviewï¼Œinfra è‡ªç„¶ä¹Ÿéœ€è¦ reviewã€‚IaC + git-flow æ˜¯å¿…è¦çš„ã€‚\nDemo 2 å·¥å…· + æµç¨‹ å°å…¥çš„æˆåŠŸèˆ‡å¦ï¼Œä¸æ˜¯æœ€ä½³å¯¦è¸ï¼Œè€Œæ˜¯å„å€‹éšæ®µï¼Œéƒ½çµ¦äºˆåœ˜éšŠé©åˆçš„æŒ‘æˆ°èˆ‡å”åŠ©\nGit-flow SOP ç¯„ä¾‹ ä¸­æ–‡ç‰ˆï¼Œè¶…é•·ï¼Œä¸Šé¢æ“ä½œéäº†ï¼Œé€™é‚Šä¸ç´°è¬›ï¼Œå¤§å®¶è‡ªå·±ä¸Šå»çœ‹ ä½†å¦‚æœåœ˜éšŠæ˜¯ç¬¬ä¸€æ¬¡å°å…¥ terraformï¼Œæˆ‘å¼·çƒˆå»ºè­°è¦æœ‰é¡ä¼¼çš„æ±è¥¿ Provide template demo æ™‚ä¸æ˜¯æœ‰ makefileï¼Œmakefile è£¡é¢å¯«çš„å°è…³æœ¬è·Ÿæœ¬èº« IaC æ²’æœ‰é—œä¿‚ï¼Œæä¾›ä¸€äº›è€Œå¤–çš„å°è…³æœ¬è¼”åŠ©ï¼Œå¯ä»¥é€²ä¸€æ­¥é™ä½äººå·¥æ“ä½œï¼Œæå‡æ•ˆç‡ï¼Œåˆå¢åŠ å®‰å…¨ã€‚å·¥å…·ä¸ä¸€å®šå®Œå…¨é©åˆåœ˜éšŠå§ï¼Œé€™æ™‚å€™å°±éœ€è¦è£œè¶³åœ˜éšŠæ–‡åŒ–è·Ÿå·¥å…·é–“çš„è½å·®ï¼Œæ½¤æ»‘ä¸€ä¸‹ã€‚\nå†èªªä¸€æ¬¡ï¼Œæ–°äººåšéŒ¯ï¼Œä¸æ˜¯ä»–åšéŒ¯ï¼Œè€Œæ˜¯åœ˜éšŠæ²’æœ‰æä¾›ä»–è¶³å¤ çš„å”åŠ©ã€‚å¦‚ä½•è®“æ–°äººä¹Ÿèƒ½æœ‰é«˜ç”¢å‡ºåŒæ™‚åˆé¡§åŠå®‰å…¨ï¼Œè³‡æ·±å·¥ç¨‹å¸«æ˜¯é€™é‚Šåœ¨è³‡æ·±ã€‚æä¾›ä¸€äº›ä¸€ç”¨æ€§å·¥å…·æ˜¯å¿…è¦çš„ã€‚\nTerraform module åˆæ˜¯ä¸€å€‹ terraform çš„åŠŸèƒ½\nç°¡å–®ä¾†èªªï¼ŒGKE ä¹Ÿè¨±å®šç¾©äº† 2 å€‹å­ç‰©ä»¶(ex. Clusterï¼ŒNode-pool)ï¼Œç¸½å…±æœ‰ 30 å€‹åƒæ•¸\nä½ å…¶å¯¦ä¸éœ€è¦é‚£éº¼å¤šåƒæ•¸ XD å»ºç«‹ä¸€å€‹ my-gke-moduleï¼Œä¸€å€‹ç‰©ä»¶ï¼Œ5 å€‹å¿…å¡«åƒæ•¸ï¼Œ5 å€‹æœ‰é è¨­å€¼çš„é¸å¡«åƒæ•¸ ä¹Ÿè¨±å¯«éŒ¯çš„æ©Ÿæœƒåªå‰© 5 å€‹ï¼Œä¹Ÿè¨±å·¥æ™‚åªéœ€è¦ 5/30 éœ€æ±‚è®Šæ›´å°±æ”¹ moduleï¼Œè®“ä½ çš„æ“ä½œç‰©ä»¶æœ¬èº«å°±æ˜¯ç¬¦åˆå¯¦éš›éœ€æ±‚çš„ èƒ½æ‰‹å‹•æ”¹çš„åœ°æ–¹å°±æ˜¯èƒ½çŠ¯éŒ¯çš„åœ°æ–¹ï¼Œé»‘ç®±å°è£å¯ä»¥ä¿è­·æ•´é«”æ¶æ§‹ï¼Œä¸¦æé«˜æ˜“ç”¨æ€§\né›œé … å…¶ä»– ä¸Šé¢æ˜¯ IaC åœ¨æˆ‘å€‘å…¬å¸çš„æµç¨‹ æˆ‘å€‘é¸ terraformã„¨ å¦‚æœæ˜¯ç”¨ terraform ä»¥å¤–çš„å·¥å…·ï¼Œå¯ä»¥åƒè€ƒæµç¨‹ï¼Œä¹Ÿè¨±æ®Šé€”åŒæ­¸ https://www.terraform.io/intro/vs/index.html\nå„ªç¼ºé» å¥½ï¼Œè·Ÿåœ˜éšŠä¸€æ­¥ä¸€æ­¥æºé€šæ”¹é€²ï¼ŒèŠ±äº†ä¸€å…©å€‹æœˆï¼ŒæˆåŠŸå°å…¥ã€‚æ˜¯å¦æœ‰è§£æ±ºç•¶åˆçš„å•é¡Œï¼Ÿ\né™ä½äººå·¥æ“ä½œ\né¿å…äººå·¥å¤±èª¤ infra äº¤ä»˜æ¨™æº–åŒ–ï¼Œæ²’æœ‰å¥‡æ€ªçš„è¨­å®šï¼Œå†ä¹Ÿæ²’æœ‰ã€Œå•Šæˆ‘æ©Ÿå™¨é–‹éŒ¯äº†ã€é€™å›äº‹ å¿«ï¼ŒçœŸä½å¿«ã€‚é–‹ä¸€å€‹æ©Ÿå™¨å°±æ˜¯æˆ‘å‰›å‰› demo é€™æ¨£ï¼Œè€Œä¸”ä¿è­‰æœƒå‹•ã€‚é€™æ¨£é–‹å‡ºä¾†çš„æ©Ÿå™¨ï¼Œå°å¥¹è¶…æœ‰ä¿¡å¿ƒï¼Œè¦è¤‡è£½å®Œå…¨ä¸€æ¨¡ä¸€æ¨£çš„ç’°å¢ƒä¹Ÿè¶…æœ‰ä¿¡å¿ƒã€‚å¦‚æœå†åŠ ä¸Šè‡ªå‹•åŒ–æ¸¬è©¦å°±æ›´æ•¢ä¿è­‰ã€‚ æº–ç¢º\nå¤§å®¶éƒ½ review éï¼Œæ¯”è¼ƒä¸æœƒæœ‰ã€Œå•Šæˆ‘ç•¶æ™‚æ²’æƒ³åˆ°ã€çš„ç‹€æ³ï¼Œinfra å‡ºé€™ç¨®è¬è¬æ²’æƒ³åˆ°çš„å•é¡Œï¼Œå¾ˆæœ‰æ©Ÿç‡è¦å¹¹æ‰é‡ä¾†ã€‚èœé³¥è·Ÿè‘— review ï¼Œè©¦è‘—ç™¼ PRï¼Œé€™æ¨£æ–°äººè¨“ç·´æ‰æœƒæœ‰æ•ˆç‡ï¼Œä»–ä¹‹å¾Œæ‰èƒ½è‡ªå·±æ“ä½œï¼Œè³‡æ·±å·¥ç¨‹å¸«åªè¦ review å°±å¥½ã€‚è¦çµ¦æ–°äººè¶³å¤ çš„è¨“ç·´ï¼Œåˆè¦é¡§æ…®å®‰å…¨ï¼Œ review èŠ±çš„æ™‚é–“éå¸¸å€¼å¾—ã€‚ ä¿è­‰é–‹ç™¼ã€æ¸¬è©¦ã€stagingã€production ç’°å¢ƒé•·çš„ä¸€æ¨¡ä¸€æ¨£ã€‚terraform ç¨‹å¼ä¿è­‰çš„ä¸æ˜¯æˆ‘ä¿è­‰çš„(XD)ã€‚ä½†ä»–çš„ä¿è­‰æ˜¯æœ‰æ ¹æ“šçš„ï¼Œè®“åœ˜éšŠå¾é–‹ç™¼åˆ°ä¸Šé™ä¿é‡ç›¸åŒç’°å¢ƒã€‚ã€Œé˜¿åœ¨æˆ‘çš„æ©Ÿå™¨ä¸Šæœƒè·‘æ€éº¼ä¸Š production å°±å£æ‰ã€ä¸å¥½æ„æ€æ²’é€™å›äº‹ï¼Œå£æ‰å°±æ˜¯ä½ æ‰£å¯«éŒ¯(å…‡ã€‚èªçœŸåœ°èªªï¼Œæ’é™¤ä¸€äº› infra çš„å•é¡Œï¼Œå¯ä»¥å¤§å¹…å¢åŠ é™¤éŒ¯çš„æ•ˆç‡ï¼Œåªè¦æª¢æŸ¥é‚„æ²’è‡ªå‹•åŒ–çš„åœ°æ–¹å°±å¥½ã€‚ è‡ªå‹•åŒ–æ¸¬è©¦ï¼Œæ‰£è¦æ¸¬è©¦ç’°å¢ƒä¹Ÿè¦æ¸¬è©¦ï¼Œé€™é‚Šç›´æ¥æ•´é€²å»ï¼Œç’°å¢ƒäº¤å‡ºå»ä¿è­‰æ˜¯å¥½çš„ ç”Ÿç”¢ç’°å¢ƒè®Šå‹•\nå› ç‚ºå·²ç¶“è½‰æˆç¨‹å¼ç¢¼ï¼Œè¦æœ‰ä»€éº¼æ”¹å‹•éƒ½å¾ˆç²¾ç¢ºï¼Œå¤§å®¶ä¹Ÿæ¯”è¼ƒæ•¢å‹•ç’°å¢ƒï¼Œç‰¹åˆ¥æ˜¯ production ç’°å¢ƒã€‚å†ä¾†å› ç‚ºä¿ç•™æ‰€æœ‰ç’°å¢ƒç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ï¼Œè¦è¤‡è£½ç’°å¢ƒä¹Ÿå¾ˆå®¹æ˜“ï¼Œè€Œä¸”æœ‰ä¿¡å¿ƒä¿è­‰ä¸€æ¨£ã€‚æˆ‘å€‘å°±æŠŠå°±æ¶æ§‹çš„ production è¤‡è£½ï¼Œç„¶å¾Œæ¬å®¶ã€‚å®‰å…¨ä¸‹åº„æ²’å‡ºäº‹ã€‚å¾Œé¢å°±æ¬ä¸Šç™®ï¼Œæ•´å€‹å…¬å¸æœå‹™å¤§æ¬å®¶ï¼Œæ¬æˆåœ˜éšŠç†æƒ³çš„æ¶æ§‹ã€‚æ¬å®¶å·²ç¶“ä¸Šç·šçš„æœå‹™ï¼Œé€™å€‹éœ€è¦å¤šå°‘ä¿¡å¿ƒè·Ÿå‹‡æ°£ä½ å€‘çŸ¥é“å—ï¼Œç¶­é‹çœŸçš„æ˜¯æ„›èˆ‡å‹‡æ°£çš„å†’éšªã€‚æ–°æ¶æ§‹æˆ‘å€‘ä¹Ÿå¾ˆæ»¿æ„ã€‚ è‡ªå‹•åŒ–\nè‡ªå‹•åŒ–å°±æ˜¯è®“ä½ ç”¨é›¶å€çš„æ™‚é–“åšåå€çš„äº‹æƒ…å˜›ã€‚è½èµ·ä¾†æ€ªæ€ªçš„è›‹æ˜¯æ˜¯çœŸçš„ã€‚ å› ç‚ºæˆ‘å€‘ç›®æ¨™æ˜¯ç¶­é‹èººè‘—ä¸Šç­å˜›(XD)ï¼Œæˆ‘å€‘æ‰èƒ½æŠŠæ™‚é–“æ‹¿å»åšæ”¹é€²ï¼Œä¸ç„¶ä»¥å…‰æ˜¯é–‹æ©Ÿå™¨ï¼Œæ¸¬è©¦ç’°å¢ƒå¯ç”¨æ€§ï¼Œç¶­é‹å°±é£½äº†ï¼Œæ ¹æœ¬æ²’æ™‚é–“æ”¹é€²è·Ÿæå‡ã€‚é€™æ¨£å°å…¬å¸é•·æœŸéå¸¸ä¸å¥½ã€‚ å¯è®€æ€§\nGUI æ²’è¾¦æ³•æ‰“ comment é˜¿ï¼Œèª°çŸ¥é“é€™å€‹æ©Ÿå™¨ç•¶åˆç‚ºä»€æ˜¯é€™å€‹è¨­å®šã€‚IaC å¾Œåˆ°è™•éƒ½å¯ä»¥å¯« commentï¼Œæ€•ä½ ä¸å¯«è€Œå·²ã€‚ç„¶å¾Œ code çš„è¡¨é”æ€§é‚„æ˜¯å¾ˆå¼·å¤§ï¼Œæ¯”èµ· GUIï¼Œè³‡æ·±å·¥ç¨‹å¸«å¯ä»¥æŠŠæ¡æ•´å€‹å…¬å¸çš„æ¶æ§‹ç‹€æ³ï¼Œæ¯”èµ·å»é›²å¹³å°ä¸‹ä¸€å †æœç´¢ï¼Œæ‰‹å‹•æ¯”å°ï¼Œç¨‹å¼ç¢¼çš„å¯ç¶­è­·æ€§çœŸçš„è¶…é«˜ã€‚è€Œ GCP å·²ç¶“æ˜¯ GUI åšå¾—å¾ˆå¥½çš„å…¬æœ‰é›²äº†ã€‚ é™ä½äººå·¥ï¼Œå¿«é€Ÿï¼Œæº–ç¢ºï¼Œè‡ªå‹•åŒ–ï¼Œæœ‰ä¿¡å¿ƒ\nQ\u0026amp;A é‚„æœ‰ç©ºæˆ‘å€‘å†ä¾†è¬› terraform çš„ç´°ç¯€\næœ‰äº‹æ­¡è¿é€éç²‰å°ˆç§æ•²ï¼Œå› ç‚ºæˆ‘ä¹Ÿéœ€è¦äººè¨è«–\né‚„æœ‰æ™‚é–“å†èŠ terraform validate æ—¢ç„¶æ˜¯ codeï¼Œé€™é‚Šå¹«ä½ åš lintã€èªæ³•æª¢æ¸¬ã€type checkï¼Œéæ¿¾ç¬¬ä¸€å±¤éŒ¯èª¤ import å¯ä»¥æŠŠé ç«¯çš„è³‡æºåŒ¯å…¥æˆ stateï¼Œä¸€å€‹é»è®š follow è¿½è¹¤çš„æ¦‚å¿µ(XD)ï¼Œä¸æ˜¯æ‰€æœ‰çš„é ç«¯è³‡æºéƒ½éœ€è¦è¿½è¹¤åˆ° stateï¼Œæˆ‘å€‘åªéœ€è¦åœ¨å°çš„ scope è£¡é¢é—œæ³¨éœ€è¦çš„æ©Ÿå™¨ module å¯ä»¥è‡ªç”±æ’°å¯«ï¼ŒæŠŠæœ‰ç›¸ä¾æ€§çš„è³‡æºæ‰“åŒ…ï¼Œä¾ç…§åœ˜éšŠä½¿ç”¨ç¿’æ…£èª¿æ•´ä½¿ç”¨ cloud å¯ä»¥ç®¡ç† stateï¼Œterraform cloud å¹«ä½ ç¶­è­·å…¨åŸŸåŒä¸€ä»½ stateï¼Œæœ‰äººåœ¨ä½¿ç”¨æ™‚æœƒ lock stateï¼Œé¿å…å¤šäººåŒæ™‚ä¿®æ”¹ï¼Œæ‰“äº‚ API é€ æˆè³‡æºéŒ¯èª¤ state conflicts å¦‚æœæœ‰å¤šä»½ stateï¼Œä½ é›»è…¦ä¸Šä¸€ä»½ local stateï¼Œæˆ‘é›»è…¦ä¸Šä¸€ä»½ local stateï¼Œå…¶å¯¦æœƒé€ æˆè¡çª æ›´æ€•åŒæ™‚å¤šäººæ†¶èµ· applyï¼ŒGCP API ç›´æ¥è¢«æ‰“äº‚ï¼Œæœƒæœ‰ä¸å¯é æœŸçš„éŒ¯èª¤ è§£æ³•æ˜¯ä½¿ç”¨ terraform remote backendï¼Œä¸è¦ç”¨ local stateï¼Œä½¿ç”¨ DB ã€storage æˆ–æ˜¯ terraform cloudï¼Œé€éä¸€éš» lock ä¾†ä¿è­‰ synchronized state é–“æ¥ç†è§£ API ex. GCP Load Balancer\né€™å€‹è¬›ä¸‹å»å°±å¤ªå¤šäº†ï¼ŒåŸºæœ¬ä¸Šé€éçˆ¬ terraform google provider çš„æ–‡ä»¶ï¼Œç„¶å¾Œå»æ¯”å°\nå› ç‚ºå»é» GUI å…¶å¯¦æ„Ÿå—ä¸åˆ° GCP API çš„èª¿ç”¨ï¼Œä½†æ˜¯ä½¿ç”¨ terraform è½‰å¯«è³‡æºæ™‚å€™å°±å¾ˆæœ‰æ„Ÿï¼Œæ‰“é€™å€‹ API è·Ÿæ‰“é€™å€‹ APIï¼Œtf æª”æ¡ˆä¸Šå…¶å¯¦çœ‹å¾—å‡ºä¾†ã€‚ é€²ä¸€æ­¥å»æŸ¥ï¼Œæ‰ç™¼ç¾ GCP Load Balancer å…§ç¶²æˆ–å¤–ç¶²ã€http æˆ– tcpã€å…¨çƒæˆ–å€åŸŸï¼Œä½¿ç”¨çš„ Load Balancer è¡Œç‚ºä¸ä¸€æ¨£ï¼Œå› ç‚ºåº•ä¸‹çš„å¯¦ä½œä¸ä¸€æ¨£ã€‚ä½†ä¹‹å‰ä½¿ç”¨ GUI æ™‚å…¶å¯¦ä¸æœƒå»æƒ³ç‚ºå•¥è¨­å®šä¸ä¸€æ¨£ï¼Œä½¿ç”¨ terraform å°±æœƒè¢«è¿«å»äº†è§£ï¼Œå¼·è¿«å­¸ç¿’XDã€‚ åƒåœ¾è©± æœ€ä½³å¯¦è¸ä¸æ˜¯å•é¡Œ ï¼Œå¦‚ä½•å°å…¥æ‰æ˜¯å•é¡Œ å¯ä»¥ä¸ç”¨èººè‘—ä¸Šç­ï¼Œä½†æ˜¯ä¸èƒ½è·ªè‘—ä¸Šç­ é¡˜æ„å¤šå¹¾å€‹äººä¾†çœ‹æˆ‘ç²‰å°ˆæ¯”è¼ƒå¯¦åœ¨ ","permalink":"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eå„ä½å¥½\u003c/p\u003e\n\u003ch1 id=\"about-this-presentation\"\u003eAbout this presentation\u003c/h1\u003e\n\u003cp\u003eé–‹å§‹ä¹‹å‰ï¼Œå…ˆåˆ†äº«ä¸€äº›è³‡æº\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003eæŠ•å½±ç‰‡\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eè¬›ç¨¿\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eç¨‹å¼ç¢¼\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground/blob/master/SOP.md\"\u003eSOP ç¯„æœ¬\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.facebook.com/engineer.from.scratch/\"\u003eFacebook ç²‰å°ˆ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eéƒ½æ”¾åœ¨é€™è£¡ï¼Œå› ç‚ºæœ‰é™„é€å­—ç¨¿ï¼Œæ‰€ä»¥å¦‚æœå¾ˆå¿™çš„æœ‹å‹ï¼Œæƒäº† QR code å°±å¯ä»¥å›å®¶è‡ªå·±çœ‹äº†ï¼Œä¸ç”¨å®¢æ°£ã€‚\u003c/p\u003e\n\u003cp\u003eç„¶å¾Œæœ‰èˆˆè¶£åœ¨è¿½é€™ç³»åˆ—æ–‡ç« çš„ï¼Œå¯ä»¥å¹«æˆ‘ facebook ç²‰å°ˆæŒ‰å€‹è®šè·Ÿè¿½è¹¤ï¼Œæ¯å‘¨æ–°æ–‡ç« å‡ºä¾†ï¼Œæœƒæ¨æ’­é€šçŸ¥ã€‚\u003c/p\u003e\n\u003cp\u003eæ–‡ç« åœ¨ chechia.net ä¸Šï¼Œæ–°æ–‡ç« é€šçŸ¥é  facebook ç²‰å°ˆé€™æ¨£ã€‚ä¹Ÿå¯ä»¥åªè¿½è¹¤ä¸æŒ‰è®šã€‚æˆ‘è‡ªå·±çœ‹åˆ¥äººæŠ€è¡“ blog ä¹Ÿå¾ˆå¸¸é€™æ¨£(XD\u003c/p\u003e\n\u003ch2 id=\"éœ€æ±‚\"\u003eéœ€æ±‚\u003c/h2\u003e\n\u003cp\u003eå¥½ï¼Œä»Šå¤©ä¾†è¬›å¾—é€™å€‹ Terraform\u003c/p\u003e","title":"Terraform Infrastructure as Code Transcript"},{"content":"This article is part of å¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\nGet-started examples / SOP on Github Introducation to Terraform Iac: Speaker transcript Presentation Check my website chechia.net for other blog. Follow my page to get notification. Like my page if you really like it :)\nOutlline our story: issues, steps, \u0026amp; results basics IaC, terraform benefits risks and å‘ to be or not to be experience oriented\nOur stories 100+ devs, many teams 25+ projects 50+ GKEs 80+ SQLs IAMs, redis, VPCs, load-balancers, \u0026hellip; Issues Ops manually create resources through GUI by SOP. We have many isolated, separeated resources, VPCs. It\u0026rsquo;s our culture, and we (devops) want to change. Some projects have short life-cycle. Rapid resources created \u0026amp; destroy. Our user story As a devops, I would like to introduce terraform (IaC) so that I can\nreview all existing resources minimize error from manual operation ASAP!! As a devops, I would like to fully enforce terraform (IaC) so that I can\nminimize efforts to operate infra delegate infra operations to junior team members minimize IAM privilges Introduction import existing resources review existing resources code plan best practice resource templates create new resources with templates introduce git workflow, plan, commit, PR, and review add wrapper handler automation pipeline repeat 2-4 IaC Programatic way to operate infra declarative (functional) vs. imperative (procedural) Perfect for public cloud, cloud native, virtualized resources Benefits: cost (reduction), speed (faster execution) and risk (remove errors and security violations) Terraform Terraform\nDeclarative (functional) IaC Invoke API delegation State management providers: azure / aws / gcp /alicloud / \u0026hellip; Demo https://github.com/chechiachang/terraform-playground\nScope Compute Instances\nKubernetes\nDatabases\nIAM\nNetworking\nLoad Balancer\nExpected benefits Minimize manual operation.\nZero manual operation error\nStandarized infra. Infra as a (stable) product. fast, really fast to duplicate envs\nInfra workflow with infra review\nEasy to create identical dev, staging, prod envs Reviewed infra. Better workflow. Code needs reviews, so do infra. Fully automized infra pipeline.\nOther Benefits Don\u0026rsquo;t afraid to change prod sites anymore We made a massive infra migration in this quater!! Better readability to GUI. Allow comment everywhere. Risks Incorrect usage could cause massive destruction. å¦‚æœçœ‹è¦‹ destroy çš„æç¤ºï¼Œè«‹é›™æ‰‹é›¢é–‹éµç›¤ã€‚ ~ first line in our SOP If see \u0026ldquo;destroy\u0026rdquo;, cancel operation \u0026amp; call for help. State management A little latency between infra version and terraform provider version Reduce Risks Sufficient understanding to infra \u0026amp; terraform Sufficient training to juniors Minimize IAM privilege: remove update / delete permissions Git-flow Our SOP\nedit tf push new branch commit PR, review \u0026amp; discussion merge \u0026amp; apply revert to previous tag if necessary (Utility) Provide template wrap resources for better accesibility lower operation risks uniform naming convention best practice suggested default value About introducing new tool The hardest part is always people Focus on critical issues (ç—›é») instead of tool itself. \u0026ldquo;We introduce tool to solve\u0026hellip;\u0026rdquo; Put result into statistics \u0026ldquo;The outage due to misconfig is reduced by\u0026hellip;\u0026rdquo; Overall, my IaC experience is GREAT! IaC to automation. Comment (for infra) is important. You have to write doc anyway. Why not put in IaC? Q\u0026amp;A Full transcript Presentation file Source Code on Github chechia.net \u0026lt;- full contents Follow my page to get notification Like it if you really like it :) Appendix.I more about terraform terraform validate terraform import terraform module terraform cloud \u0026amp; state management\nAppendix.I understand State conflict Shared but synced watch out for state conflicts when colaborating state diff. could cause terraform mis-plan Solution: synced state lock Colatorative edit (git branch \u0026amp; PR), synchronized terraform plan \u0026amp; apply or better: automation Appendix.II understand resources from API aspect GCP Load Balancer\nGCP Load Balancing understand resources from API aspect\nhow terraform work with GCP API internal\nregional pass-through: tcp / udp -\u0026gt; internal TCP/UDP proxy: http / https -\u0026gt; internal HTTP(S) external\nregional pass-through: tcp / udp -\u0026gt; tcp/udp network global / effective regional proxy tcp -\u0026gt; TCP Proxy ssl -\u0026gt; SSL Proxy http / https -\u0026gt; External HTTP(S) Terraform Resource forwarding_rule\nforwarding_rule: tcp \u0026amp; http global_forwarding_rule: only http backend_service\nbackend_service health_check http_health_check https_health_check region_backend_service region_health_check region_http_health_check region_https_health_check Some ways to do IaC Cloud Formation bash script with API / client å¼•è¨€ Infrastructure as Code å¾å­—é¢ä¸Šè§£é‡‹ï¼ŒIaC å°±æ˜¯ç”¨ç¨‹å¼ç¢¼æè¿° infrastructureã€‚é‚£ç‚ºä½•æœƒå‡ºç¾é€™å€‹æ¦‚å¿µï¼Ÿ\nå¦‚æœä¸ IaC æ˜¯ä»€éº¼ç‹€æ³ï¼Ÿæˆ‘å€‘é‚„æ˜¯å¯ä»¥é€é GUI æˆ–æ˜¯ API æ“ä½œã€‚éš¨å«éš¨ç”¨\né›²ç«¯é‹ç®—é¢¨è¡Œï¼Œå·¥ç¨‹å¸«å¯ä»¥å¾ˆåœ¨ GUI ä»‹é¢ä¸Šï¼Œå¾ˆè¼•æ˜“çš„éƒ¨ç½²è³‡æ–™ä¸­å¿ƒçš„æ¶æ§‹ã€‚è¼¸å…¥åŸºæœ¬è³‡è¨Šï¼Œæ»‘é¼ é»å€‹ä¸€å…©ä¸‹ï¼Œå°±å¯ä»¥åœ¨é ç«¯å•Ÿç”¨é‹ç®—æ©Ÿå™¨ï¼Œå•Ÿç”¨è³‡æ–™åº«ï¼Œè¨­ç½®è™›æ“¬ç¶²è·¯èˆ‡è·¯ç”±ï¼Œå¹¾åˆ†é˜å°±å¯ä»¥å®Œæˆæ¶è¨­æœå‹™çš„åŸºç¤å»ºè¨­(infrastructure)ï¼Œé–‹å§‹é‹è¡Œæœå‹™ã€‚\nç„¶è€Œéš¨è‘—\né›²å¹³å°æä¾›æ›´å¤šæ–°çš„ï¼ˆè¤‡é›œçš„ï¼‰æœå‹™ æœå‹™å½¼æ­¤å¯èƒ½æ˜¯æœ‰ç›¸ä¾æ€§ï¼ˆdependencyï¼‰ï¼Œæœå‹™éœ€è¦ä»°è³´å…¶ä»–æœå‹™ æˆ–æ˜¯å‹•æ…‹è€¦åˆï¼Œæ›´æ”¹æœå‹™æœƒé€£å‹•å…¶ä»–æœå‹™ï¼Œä¸€é«®å‹•å…¨èº« éœ€è¦ç¸å¯†çš„å­˜å–æ§ç®¡ï¼ˆaccess controlï¼‰ é˜²ç«ç‰†ï¼Œè·¯ç”±è¦å‰‡ é›²å¹³å°ä¸Šï¼Œåœ˜éšŠæˆå“¡çš„å­˜å–æ¬Šé™ å°ˆæ¡ˆçš„è¦æ¨¡èˆ‡è¤‡é›œåº¦å¢åŠ  å¤šç’°å¢ƒçš„éƒ¨ç½² å¤šå€‹å‚™æ´å‰¯æœ¬è¨­å®š å¤§é‡æ©Ÿå™¨å½¢æˆçš„é›†ç¾¤ IaC çš„å¯¦éš›éœ€æ±‚ ä»¥ä¸‹é€™äº›å°è©±æ˜¯ä¸æ˜¯å¾ˆè€³ç†Ÿï¼Ÿ\nIaC çš„å¯¦éš›éœ€æ±‚ æ²’æœ‰éœ€æ±‚ï¼Œå°±ä¸éœ€è¦æ‰¾å°‹æ–°çš„è§£æ±ºæ–¹æ¡ˆã€‚\næœ‰çœ‹ä¸Šé¢ç›®éŒ„çš„æœ‹å‹ï¼Œæ‡‰è©²çŸ¥é“é€™ç³»åˆ—æ–‡ç« çš„å¾Œé¢ï¼Œæˆ‘æœƒå¯¦éš›åˆ†äº«æ–¼å…¬å¸å…§éƒ¨å°å…¥ Terraform èˆ‡ IaC æ–¹æ³•çš„éç¨‹ã€‚\nå„ä½è®€è€…æœƒæ‰¾åˆ°é€™ç¯‡æ–‡ï¼Œå¤§æ¦‚éƒ½æ˜¯å› ç‚ºå¯¦éš›æœå°‹äº† Terraform æˆ–æ˜¯ IaC çš„é—œéµå­—æ‰æ‰¾åˆ°é€™ç¯‡ã€‚\nå¦‚æœæ²’æœ‰éœ€æ±‚ï¼Œè‡ªå·±å› ç‚ºè¦ºå¾—æœ‰è¶£è€Œæ‹‰ä¸‹ä¾†ç ”ç©¶ï¼Œ\nå¦‚æœæ²’æœ‰æ˜ç¢ºéœ€æ±‚ï¼Œå°±è²¿ç„¶å°å…¥ ç„¡è¬‚å¢åŠ äº‚åº¦\nIaC çš„å¯¦ç¾å·¥å…· ç‚ºä½•é¸æ“‡ Terraform å»ºè­° å¦‚æœä¸ç†Ÿï¼Œå¾ import ç¾æœ‰æœ€å¥½çš„è³‡æºé–‹å§‹ã€‚æŠŠ 70 åˆ†ä¿ä½ï¼Œå†å‘ 80 90 é‚é€²ã€‚ å–„ç”¨ module å°è£ï¼Œåªéœ²å‡ºæœƒç”¨åˆ°çš„åƒæ•¸ã€‚ ","permalink":"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/","summary":"\u003cp\u003eThis article is part of \u003ca href=\"https://chechia.net/posts/2020-06-14-terraform-infrastructure-as-code/\"\u003eå¾é›¶é–‹å§‹çš„ Infrastructu as Code: Terraform\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/chechiachang/terraform-playground\"\u003eGet-started examples / SOP on Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2020-06-15-terraform-infrastructure-as-code-transcript/\"\u003eIntroducation to Terraform Iac: Speaker transcript\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://slides.com/chechiachang/terraform-introduction/edit\"\u003ePresentation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCheck my website \u003ca href=\"https://chechia.net\"\u003echechia.net\u003c/a\u003e for other blog. \u003ca href=\"https://www.facebook.com/engineer.from.scratch\"\u003eFollow my page to get notification\u003c/a\u003e. Like my page if you really like it :)\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"outlline\"\u003eOutlline\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eour story: issues, steps, \u0026amp; results\u003c/li\u003e\n\u003cli\u003ebasics IaC, terraform\u003c/li\u003e\n\u003cli\u003ebenefits\u003c/li\u003e\n\u003cli\u003erisks and å‘\u003c/li\u003e\n\u003cli\u003eto be or not to be\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eexperience oriented\u003c/p\u003e\n\u003ch1 id=\"our-stories\"\u003eOur stories\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e100+ devs, many teams\u003c/li\u003e\n\u003cli\u003e25+ projects\u003c/li\u003e\n\u003cli\u003e50+ GKEs\u003c/li\u003e\n\u003cli\u003e80+ SQLs\u003c/li\u003e\n\u003cli\u003eIAMs, redis, VPCs, load-balancers, \u0026hellip;\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"issues\"\u003eIssues\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eOps manually create resources through GUI by SOP.\u003c/li\u003e\n\u003cli\u003eWe have many isolated, separeated resources, VPCs. It\u0026rsquo;s our culture, and we (devops) want to change.\u003c/li\u003e\n\u003cli\u003eSome projects have short life-cycle. Rapid resources created \u0026amp; destroy.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"our-user-story\"\u003eOur user story\u003c/h1\u003e\n\u003cp\u003eAs a devops,\nI would like to introduce terraform (IaC)\nso that I can\u003c/p\u003e","title":"å¾é›¶é–‹å§‹çš„ Infrastructure as Code: Terraform - 01"},{"content":"ä»Šå¹´çµæŸäº†ï¼Œå›é¡§ä¸€ä¸‹ä»Šå¹´åšçš„äº‹æƒ…\n\u0026ndash; æˆ‘æ˜¯è»Ÿé«”å·¥ç¨‹å¸« \u0026ndash;\n6 å ´å…¬é–‹æ¼”è¬›ï¼Œä¸¦ä¸”è¸å‡ºç†Ÿæ‚‰çš„ç¤¾ç¾¤èˆ’é©åœˆï¼Œå—ä¸‹é€²è»é«˜é›„XD\n37 ç¯‡æŠ€è¡“æ–‡ç«  å…¶ä¸­åŒ…å« 30 ç¯‡ Ithome 30å¤©(åƒè³½å°±ä¸ç”¨ç¡è¦º)éµäººè³½åƒè³½æ–‡ç«  çµè³½æ’¿åˆ°è³€å„ªé¸ç‹‚è³€?\næ­£è·å·¥ä½œæ–¹é¢ï¼Œé€²äº†å¹£åœˆï¼Œåˆ‡èº«äº†è§£æ•åœˆçœŸäº‚å¾Œï¼Œåˆè¸å‡ºäº†å¹£åœˆ\né–‹å‘ç¿»è­¯éº»çœç†å·¥å­¸é™¢çš„èª²ç¨‹ã€åˆ†æ•£å¼ç³»çµ±ã€ï¼Œå¥½èª²æªåœ˜ä¸€èµ·ä¿® é è¨ˆæœƒæœ‰ 22 ç¯‡æ–‡ç« ï¼Œæº–å‚™åœ¨å¯è¦‹çš„æœªä¾†ï¼ŒçŠ§ç‰²ç„¡æ•¸å€‹å¤œæ™šï¼Œé‚å‘ 2020\n\u0026ndash; æˆ‘æ˜¯å°ˆæ¥­æ°´è‚ºæ½›æ°´æ•™ç·´ \u0026ndash; ä¹Ÿæ˜¯è‡ªç”±æ½›æ°´å“¡\nå¹´æœ«çš„å¹¾å¤©ï¼Œæ­£å¼é–‹å§‹åŸ·æ¥­ï¼Œå¸¶å­¸ç”Ÿä¸‹æµ·(?) å­¸ç¿’æ•™å°å­¸ç”Ÿï¼Œä¹Ÿå­¸ç¿’å°å­¸ç”Ÿçš„å®‰å…¨è² è²¬\næ–°å¹´å¾©å·¥å¾Œï¼Œæ­£è·ç¢¼è¾²ï¼Œå‰¯æ¥­æ½›æ°´ æœ‰äººè¦æ½›è«‹æ‰¾æˆ‘ï¼Œä¿è­‰å„ªæƒ ä¸è—ç§\n\u0026ndash; æˆ‘æ˜¯æ•¸ä½è¡ŒéŠ·å¯¦ç¿’ç”Ÿ \u0026ndash;\nè·Ÿå‰å…¬å¸ (é›–ç„¶éƒ½ä¸æ˜¯MKä½†å») è¶…å¼·çš„è¡ŒéŠ·åœ˜éšŠ\u0026lt;3å­¸ç¿’æ•¸ä½è¡ŒéŠ· å¾é›¶é–‹å§‹å¤§é€ å€‹äººå“ç‰Œï¼Œé‚Šå­¸é‚Šå¯¦ç¿’ é–‹äº†å…©å€‹ç²‰çµ²å°ˆé  ä¸€å€‹æ˜¯æŠ€è¡“æ–‡ç« åˆ†äº«ï¼Œä¸€å€‹åšæ½›æ°´å½±ç‰‡åˆ†äº« æ‰“é€ å€‹äººå“ç‰Œï¼Œè‡ªå·±æ¨å»£è¡ŒéŠ·ï¼Œå­¸ç¿’æ•¸ä½è¡ŒéŠ·\n","permalink":"https://chechia.net/posts/2019-12-31-say-goodbye-2019/","summary":"2019 å¹´åº¦å›é¡§","title":"Say Goodbye 2019"},{"content":"https://github.com/chechiachang/mit-6.824-distributed-system\nèª²ç¨‹è¬›ç¾©ä¸­æ–‡ç¿»è­¯ å€‹äººå¿ƒå¾— è·Ÿè‘— MIT 6.824 å­¸ç¿’åˆ†æ•£å¼ç³»çµ±\né€™å€‹å°ˆæ¡ˆå„²å­˜ MIT 6.824 åˆ†æ•£å¼ç³»çµ±ç·¨ç¨‹çš„ä¸Šèª²å…§å®¹ï¼Œæˆ‘å°‡å…§å®¹ç¿»è­¯ç¨‹ä¸­æ–‡ï¼ŒåŠ ä¸Šå€‹äººå­¸ç¿’ç­†è¨˜\næˆ‘æœƒåœ¨æˆ‘çš„å­¸ç¿’éç¨‹ä¸­ï¼ŒæŒçºŒç¿»è­¯èª²ç¨‹å…§å®¹ ä¸€æ–¹é¢æ·±å…¥å€‹äººå­¸ç¿’ å¦ä¸€æ–¹é¢ä¹Ÿå›é¥‹ç¤¾ç¾¤ ä¾ç…§èª²ç¨‹çš„é€²åº¦é€²è¡Œ è‹¥æœ‰é¤˜åŠ›ï¼Œæœƒå˜—è©¦ç¿»è­¯ä»¥ä¸‹å…§å®¹\nèª²å ‚ Q \u0026amp; A è«–æ–‡ lab å¯¦åš ","permalink":"https://chechia.net/posts/2019-12-16-mit-6.824-distributed-system/","summary":"è·Ÿè‘— MIT 6.824 æ·±å…¥æ·ºå‡ºåˆ†æ•£å¼ç³»çµ±","title":"MIT 6.824 Distributed System Learning Note"},{"content":"https://en.bitcoin.it/wiki/Atomic_swap\nAlgorithm 2 pay txs and 2 claim tx claim txs are singed at first, locked with time 2 pay txs are encrypted by x, affects only when x is reveal on the network Initialization A: random number x\ntx1: A pay B A Pay BTC to B\u0026rsquo;s public key if x known \u0026amp; singed by B or Signed by A \u0026amp; B\ntx2: A claim tx1 pay BTC to A\u0026rsquo;s public key locked 48 hours signed by A\nA -\u0026gt; B tx2 B -\u0026gt; A tx2 signed by A \u0026amp; B\nA -\u0026gt; submit tx1 tx3: B pay A alt-coin B Pay A alt-coin if x known \u0026amp; singed by A or signed by A \u0026amp; B\ntx4: B claim tx3 pay B alt-coins locked 48 hours signed by B\nB -\u0026gt; A tx4 A -\u0026gt; B tx4 signed by A \u0026amp; B\nB submit tx3 A spends tx3, reveal x B spends tx1 using x Specialized Alt-chain ","permalink":"https://chechia.net/posts/2019-11-08-blockchain-atomic-swap/","summary":"\u003cp\u003e\u003ca href=\"https://en.bitcoin.it/wiki/Atomic_swap\"\u003ehttps://en.bitcoin.it/wiki/Atomic_swap\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"algorithm\"\u003eAlgorithm\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e2 pay txs and 2 claim tx\u003c/li\u003e\n\u003cli\u003eclaim txs are singed at first, locked with time\u003c/li\u003e\n\u003cli\u003e2 pay txs are encrypted by x, affects only when x is reveal on the network\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"0\"\u003e\n\u003cli\u003eInitialization\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eA: random number x\u003c/p\u003e\n\u003cp\u003etx1: A pay B\nA Pay BTC to B\u0026rsquo;s public key\nif x known \u0026amp; singed by B\nor Signed by A \u0026amp; B\u003c/p\u003e\n\u003cp\u003etx2: A claim\ntx1 pay BTC to A\u0026rsquo;s public key\nlocked 48 hours\nsigned by A\u003c/p\u003e","title":"Ablockchain Atomic Swap"},{"content":"BEP3 Atomic Swap Binance åœ¨ BEP3: HTLC and Atomic Peg æåˆ°ï¼ŒBEP å³å°‡åœ¨ binance chain ä¸Šæ”¯æ´åŸç”Ÿçš„ Hash Timer Locked Transfer (HTLT) ï¼Œé€™ä½¿è·¨éˆçš„åŸå­æ€§äº¤æ› (atomic swap) è®Šå¾—å¯è¡Œï¼Œé€é HTLC åœ¨å…©é‚Šçš„éˆä¸Šé–ä½ (peg) tokensï¼Œç„¶å¾Œåªæœ‰åœ¨åŸ·è¡Œäº¤æ›çš„æ™‚å€™ï¼Œé€é hash äº¤æ›ï¼Œä¸€æ¬¡åŸ·è¡Œé›™é‚Šçš„äº¤æ˜“ã€‚\né—œæ–¼ Atomic Swap ç¶²è·¯æœ‰éå¸¸å¤šçš„è¨Šæ¯ï¼Œæœ‰èˆˆè¶£çš„è©±å¯ä»¥çœ‹é€™ç¯‡\näº¤æ˜“åªæœ‰åœ¨é›™é‚Šå®Œæˆå¾Œæ‰å®Œæˆï¼Œå®Œæˆä¹‹å‰ä¸èƒ½å‹•ç”¨äº¤æ›çš„è³‡ç”¢ åœ¨ä»»ä½•éšæ®µå¤±æ•ˆéƒ½å¯ä»¥å®Œå…¨ fallbackï¼Œä¸¦é€²è¡Œ refund äº¤æ˜“çš„èªè­‰æ˜¯å»ä¸­å¿ƒåŒ–çš„ é€™é‚Šæœ‰å€‹ä½†æ›¸ï¼ŒEthereum ä¸Šæ˜¯é€é smart contract å¯¦ç¾ï¼Œä½† Binance chain ä¸Šé‚„æ˜¯é  Binance èªè­‰ XD Binance åœ¨ BEP3 ä¸­æ”¯æ´ HTLCï¼Œæˆ‘å€‘é€™é‚Šä¸»è¦çš„è³‡è¨Šä¾†æºæ˜¯ binance.org çš„å®˜æ–¹èªªæ˜æ–‡ä»¶ï¼Œé€™é‚Šé‡å°æ–‡ç« é€²è¡Œé©—è­‰ï¼Œä¸¦ä¸”è£œè¶³æ–‡ä»¶ç¼ºæ¼çš„éƒ¨åˆ†ï¼Œæé†’éç¨‹ä¸­å¯èƒ½æœƒè¸©åˆ°çš„é›·ã€‚\nè·¨éŠ(Cross Chain) äº¤æ˜“ åœ¨éƒ¨ç½² asset / token çš„æ™‚å€™ï¼Œæˆ‘å€‘æœƒé¸æ“‡åˆé©çš„éˆä½œç‚ºç™¼å¸ƒè³‡ç”¢ä¸¦é‹è¡Œ block chain appã€‚å¸¸ç”¨çš„æ‡‰ç”¨éˆå¦‚ ethereum èˆ‡ binance chain ç­‰ç­‰ã€‚ä¸åŒçš„ä¸»éˆä¸Šæœ‰å„è‡ªçš„å„ªç¼ºé»ï¼Œä¾‹å¦‚ä½¿ç”¨ ethereum ï¼Œå¯ä»¥èˆ‡è¨±å¤š token èˆ‡æ‡‰ç”¨äº’å‹•ï¼Œä¹Ÿæ˜¯æœ€å¤šäººä½¿ç”¨çš„æ‡‰ç”¨ä¸»éˆã€‚è€Œåœ¨ binance éˆä¸ŠåŸ·è¡Œï¼Œå‰‡èƒ½å¤ å¿«é€Ÿçš„ç™¼ç”Ÿ transactionsï¼Œä¸¦ä¸”å¯ä»¥èˆ‡ binance ä¸Šçš„è³‡ç”¢èˆ‡äº¤æ˜“æ‰€äº’å‹•ã€‚\nåœ¨æŸäº›æ‡‰ç”¨å ´æ™¯ï¼Œæˆ‘å€‘æœƒå¸Œæœ›å…©å€‹ç¨ç«‹ä¸»éˆä¸Šçš„è³‡ç”¢èƒ½å¾Œäº’å‹•ï¼Œä¾‹å¦‚åœ¨ binance chain ä¸ŠåŸ·è¡Œå¿«é€Ÿçš„ transactionï¼Œç„¶è€Œä¹Ÿè¦ä½¿ç”¨ etheruem ä¸Šæ—¢æœ‰çš„ ERC-20 tokensï¼Œé€™æ™‚ä¾¿éœ€è¦ä¸€å€‹æºé€šå…©æ¢éˆçš„æ©Ÿåˆ¶ã€‚\næ–‡ç« åˆ†ç‚ºä¸‰å€‹éƒ¨åˆ† åœ¨ Binance Chain ä¸Šäº’æ›å…©å€‹ address çš„ binance asset å¾ ethereum token åˆ° binance å¾ binance chain åˆ° ethereum Atomic Swap on Binance Chain æˆ‘å€‘ä»Šå¤©æœƒå¯¦ä½œ Atomic Peg Swapï¼Œé€é HTLT é–ä½ Binance Chain ä¸Šå…©å€‹ address çš„è³‡ç”¢ï¼Œä¸¦é€²è¡ŒåŸå­æ€§çš„ä¸€æ¬¡äº¤æ˜“ï¼Œä¾†é”æˆéˆä¸Šçš„è³‡ç”¢äº’æ›ã€‚é€™é‚Šç›´æ¥ä½¿ç”¨ binance æä¾›çš„ bnbcli ä¾†åŸ·è¡Œã€‚\nä½¿ç”¨æƒ…å¢ƒ å…©å€‹åœ¨ Binance Chain ä¸Šçš„ address æƒ³äº¤æ›è³‡ç”¢\nClient: HTLT çš„ç™¼èµ·æ–¹ï¼Œæ“æœ‰ä¸€éƒ¨åˆ† assetï¼Œç™¼èµ· HTLT å¸Œæœ›åŸ·è¡Œè³‡ç”¢äº’æ› Recipient: HTLT çš„æ”¶å—æ–¹ï¼Œæ”¶åˆ° HTLTï¼Œéœ€è¦æ–¼æ™‚é™å…§ deposit æŒ‡å®šæ•¸é‡çš„è³‡ç”¢åˆ° swap ä¸­ æœå‹™å…ƒä»¶ HTLT transactions on binance chain: ä¾†é–ä½ä¸¦ claim assets Client tooling: tbnbcli è®“å®¢æˆ¶å¯ä»¥æ“ä½œï¼Œç›£æ¸¬éˆä¸Š swap çš„ç‹€æ³ æµç¨‹ Client ä½¿ç”¨ tbnbcli ç™¼èµ· HTLT Recipient æ”¶åˆ°ç™¼èµ·æ–¹é€ä¾†çš„ swap info èˆ‡ asset (frozen) Recipient Deposit æŒ‡å®šæ•¸é‡çš„ asset åˆ° swap ä¸­ Binance Chain è‡ªå‹•å®Œæˆ swapï¼Œå®Œæˆäº¤æ›ï¼Œè§£é–å…©é‚Šäº¤æ›çš„è³‡ç”¢ å–å¾— tbnbcli tbnbcli çš„èªªæ˜æ–‡ä»¶\nç”±æ–¼ bnbcli repo ä¸­ä½¿ç”¨ Git Large File Storage ä¾†å­˜æ”¾ binaryï¼Œé€™é‚Šè¦å•Ÿç”¨ git-lfs ä¾†ä¸‹è¼‰ binary\n# Mac port sudo port install git-lfs Git clone repo\ngit clone git@github.com:binance-chain/node-binary.git cd node-binary git chechout v0.6.2 git lfs pull --include cli/testnet/0.6.2/mac/tbnbcli sudo copy cli/testnet/0.6.2/mac/tbnbcli /usr/local/bin é€™é‚Šè¦æ³¨æ„ä½¿ç”¨ v0.6.2+ çš„ç‰ˆæœ¬ï¼Œä¸ç„¶æœƒæ²’æœ‰ HTLT çš„ subcommands\næ¸¬è©¦ tbnbcli tbnbcli status --node http://data-seed-pre-0-s3.binance.org:80 { \u0026quot;node_info\u0026quot;: { \u0026quot;protocol_version\u0026quot;: { \u0026quot;p2p\u0026quot;: \u0026quot;7\u0026quot;, \u0026quot;block\u0026quot;: \u0026quot;10\u0026quot;, \u0026quot;app\u0026quot;: \u0026quot;0\u0026quot; }, \u0026quot;id\u0026quot;: \u0026quot;34ac6eb6cd914014995b5929be8d7bc9c16f724d\u0026quot;, \u0026quot;listen_addr\u0026quot;: \u0026quot;aa13359cd244f11e988520ad55ba7f5a-c3963b80c9b991b7.elb.us-east-1.amazonaws.com:27146\u0026quot;, \u0026quot;network\u0026quot;: \u0026quot;Binance-Chain-Nile\u0026quot;, \u0026quot;version\u0026quot;: \u0026quot;0.31.5\u0026quot;, \u0026quot;channels\u0026quot;: \u0026quot;36402021222330380041\u0026quot;, \u0026quot;moniker\u0026quot;: \u0026quot;data-seed-0\u0026quot;, \u0026quot;other\u0026quot;: { \u0026quot;tx_index\u0026quot;: \u0026quot;on\u0026quot;, \u0026quot;rpc_address\u0026quot;: \u0026quot;tcp://0.0.0.0:27147\u0026quot; } }, \u0026quot;sync_info\u0026quot;: { \u0026quot;latest_block_hash\u0026quot;: \u0026quot;359AD9BF36B7DEEB069A86D53D3B65D9F4BB77A1A65E40E1289B5798D4C1094F\u0026quot;, \u0026quot;latest_app_hash\u0026quot;: \u0026quot;E748CFA5806B587D9678F55DFDDB336E3669CDF421191CDA6D2DF8AA7A3461F3\u0026quot;, \u0026quot;latest_block_height\u0026quot;: \u0026quot;45868456\u0026quot;, \u0026quot;latest_block_time\u0026quot;: \u0026quot;2019-10-23T07:36:38.176957281Z\u0026quot;, \u0026quot;catching_up\u0026quot;: false }, \u0026quot;validator_info\u0026quot;: { \u0026quot;address\u0026quot;: \u0026quot;1C360E22E04035E22A71A3765E4A8C5A6D586132\u0026quot;, \u0026quot;pub_key\u0026quot;: { \u0026quot;type\u0026quot;: \u0026quot;tendermint/PubKeyEd25519\u0026quot;, \u0026quot;value\u0026quot;: \u0026quot;T56yDoH+B+OY8PP2tmeFtJtk+9ftnBUVHykKfLS45Es=\u0026quot; }, \u0026quot;voting_power\u0026quot;: \u0026quot;0\u0026quot; } } Acquire Valid Binance Testnet Account Check Testnet Doc\nGo to Binance Testnet Create a wallet Save address, mn, keystore, private key Use testnet faucet to fund testnet account Receive 200 BNB on testnet Client Create HTLT é€™é‚Šä½¿ç”¨ç°¡å–®çš„ç¯„ä¾‹ï¼Œé–ä½å…©å€‹ BEP2 tokens ä¾†é€²è¡Œäº¤æ›ï¼Œå±•ç¤ºä¸€ä¸‹ tbnbcli çš„ HTLT\næº–å‚™å…©å€‹ addressï¼Œé€™é‚Šæ˜¯æˆ‘è‡ªå·±çš„å…©å€‹ testnet address\ntbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p (179 BNB) Explorer ä¸ŠæŸ¥çœ‹ tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce (20 BNB) Exporler ä¸ŠæŸ¥çœ‹ ç›®æ¨™ï¼š\nHTLT tbnb\u0026hellip;j9p -\u0026gt; 0.3 BNB -\u0026gt; tbnb\u0026hellip;7ce tbnb\u0026hellip;j9p \u0026lt;- 0.1 BNB \u0026lt;- tbnb\u0026hellip;7ce tbnbcli åŸ·è¡Œ HTLTï¼Œå¾ from address åŸ·è¡Œ HTLTï¼Œçµ¦ recipient-addr 0.3 BNBï¼Œä¸¦é æœŸå°æ–¹å› 0.1 BNBï¼Œç­‰å¾… height-span å€‹ block æ™‚é–“(360 \u0026gt; 2 minutes)\ntbnbcli key å¯¦éš›åŸ·è¡Œå‰ï¼Œç”±æ–¼æˆ‘å€‘éœ€è¦é€é tbnbcli æ“ä½œ from-addressï¼Œè¦å…ˆé€é tbnbcli æŠŠ address çš„ key åŠ é€²åˆ°æœ¬åœ°\ntbnbcli keys add tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce --recover tbnbcli keys list NAME:\tTYPE:\tADDRESS:\tPUBKEY: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tlocal\ttbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tbnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4 å¯¦éš›åŸ·è¡Œ åƒæ•¸ï¼š\nFROM ADDR: tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\nRECIPIENT ADDR: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\nhightspan: 3600ï¼Œheight-span æ˜¯ç™¼èµ· HTLTï¼Œå—æ–¹ depositï¼Œç™¼èµ·æ–¹å» claim çš„æ™‚é™ã€‚\namount: asset * 10^8\ntbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p åŸ·è¡Œ HTLT\nçµ¦ tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce 0.3 BNB\né æœŸå°æ–¹å› 0.1 BNB\nç­‰å¾… 3600 å€‹ block æ™‚é–“\nFROM_ADDR=tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p RECIPIENT_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce HEIGHT_SPAN=3600 tbnbcli token HTLT \\ --recipient-addr ${RECIPIENT_ADDR} \\ --amount 30000000:BNB \\ --expected-income 10000000:BNB \\ --height-span ${HEIGHT_SPAN} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 ç”¢ç”Ÿ swap çš„çµæœï¼Œå¯ä»¥æ–¼Testnet Explorer ä¸Šçœ‹åˆ°\nCommitted at block 47218942 (tx hash: 8F865C5C9E5CD06239DE99746BCE73AACA2F3AD881C26765FB90C9465EF06EF0, response: {Code:0 Data:[77 138 29 51 186 65 213 125 105 217 5 102 170 194 248 149 189 188 56 208 166 93 48 159 188 196 143 111 31 66 151 249] Log:Msg 0: swapID: 4d8a1d33ba41d57d69d90566aac2f895bdbc38d0a65d309fbcc48f6f1f4297f9 Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 104 113 54 118 52 57 97 110 51 119 119 104 114 100 56 110 121 55 113 106 51 101 120 103 102 109 118 112 118 117 101 108 107 99 97 106 57 112] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) Query Atomic Swap ç”¢ç”Ÿäº† atomic swapï¼Œé€™é‚Šå¯ä»¥ä½¿ç”¨ tbnbcli æŸ¥è©¢ swap çš„ç‹€æ…‹\nSWAP_ID=4d8a1d33ba41d57d69d90566aac2f895bdbc38d0a65d309fbcc48f6f1f4297f9 tbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 å›å‚³ swap çš„ç‹€æ…‹\n{\u0026quot;from\u0026quot;:\u0026quot;tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\u0026quot;,\u0026quot;to\u0026quot;:\u0026quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\u0026quot;,\u0026quot;out_amount\u0026quot;:[{\u0026quot;denom\u0026quot;:\u0026quot;BNB\u0026quot;,\u0026quot;amount\u0026quot;:\u0026quot;30000000\u0026quot;}],\u0026quot;in_amount\u0026quot;:null,\u0026quot;expected_income\u0026quot;:\u0026quot;10000000:BNB\u0026quot;,\u0026quot;recipient_other_chain\u0026quot;:\u0026quot;\u0026quot;,\u0026quot;random_number_hash\u0026quot;:\u0026quot;4cf88f1acf8bcbc628609f3257406913f67e009e5c61f2671b601e40f4e5cc6a\u0026quot;,\u0026quot;random_number\u0026quot;:\u0026quot;\u0026quot;,\u0026quot;timestamp\u0026quot;:\u0026quot;1572506189\u0026quot;,\u0026quot;cross_chain\u0026quot;:false,\u0026quot;expire_height\u0026quot;:\u0026quot;47222542\u0026quot;,\u0026quot;index\u0026quot;:\u0026quot;2254\u0026quot;,\u0026quot;closed_time\u0026quot;:\u0026quot;0\u0026quot;,\u0026quot;status\u0026quot;:\u0026quot;Open\u0026quot;} Deposit HTLT å—æ–¹ reciept-address é€™é‚Šè¦æŠŠ 1 BNB æ‰“é€²å» swap ä¸­\næ³¨æ„é€™é‚Šçš„ from-address å·²ç¶“è®Šæˆç•¶åˆçš„ recipient-addr tbnb\u0026hellip;j9p\nç•¶ç„¶é€™é‚Šè¦å­˜å–ï¼Œä¹Ÿè¦æœ‰ tbnb\u0026hellip;j9p çš„ keyï¼Œé€™æ¨£æˆ‘å€‘æœ¬åœ°å°±æœƒæœ‰ç™¼å—å…©æ–¹çš„ keyï¼Œä½†ä¸€èˆ¬ä¾†èªªæ‡‰è©²æ˜¯å…©å€‹ä¸åŒçš„äºº\ntbnbcli keys add tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p--recover tbnbcli keys list NAME:\tTYPE:\tADDRESS:\tPUBKEY: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tlocal\ttbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tbnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4 tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\tlocal\ttbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\tbnbp1addwnpepqwk5zx3jnrq5guxc9tsgrte9aw9knla0ahunwynypkm0jvst6y7l2q83ueq å—æ–¹æŠŠç´„å¥½çš„éŒ¢å­˜é€²å»\ntbnbcli token deposit \\ --swap-id ${SWAP_ID} \\ --amount 10000000:BNB \\ --from ${RECIPIENT_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 å¯ä»¥æˆåŠŸ depositï¼Œæª¢æŸ¥é€™æ¬¡ tx Deposit swap çš„å…§å®¹\nPassword to sign with 'tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce': Committed at block 47219070 (tx hash: FDCC528B9F98E9CEEDCB113A398A747F440666061340535D44C526D79F9CD667, response: {Code:0 Data:[] Log:Msg 0: Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[100 101 112 111 115 105 116 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) ç™¼èµ·æ–¹ Claim HTLT é‡å°æ¯ç­† HTLT ï¼Œè§£é–é–ä½çš„ assetsã€‚æ¯å€‹ HTLT åªèƒ½è¢«è§£é–ä¸€æ¬¡ã€‚\ntbnbcli token claim \\ --swap-id ${SWAP_ID} \\ --random-number ${RANDOM_NUMBER} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 å¯ä»¥æˆåŠŸ claimï¼Œæª¢æŸ¥é€™æ¬¡ tx Deposit swap çš„å…§å®¹\nPassword to sign with 'tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p': Committed at block 47219128 (tx hash: D08F81D0315F0A7B13E510782F6E56804803B5198F4914C8EB10E3A5084F2BAA, response: {Code:0 Data:[] Log:Msg 0: Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 104 113 54 118 52 57 97 110 51 119 119 104 114 100 56 110 121 55 113 106 51 101 120 103 102 109 118 112 118 117 101 108 107 99 97 106 57 112] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[99 108 97 105 109 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) æŸ¥è©¢ swap ç‹€æ…‹ å¾ open è®Šæˆ completed\ntbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 {\u0026quot;from\u0026quot;:\u0026quot;tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\u0026quot;,\u0026quot;to\u0026quot;:\u0026quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\u0026quot;,\u0026quot;out_amount\u0026quot;:[{\u0026quot;denom\u0026quot;:\u0026quot;BNB\u0026quot;,\u0026quot;amount\u0026quot;:\u0026quot;30000000\u0026quot;}],\u0026quot;in_amount\u0026quot;:[{\u0026quot;denom\u0026quot;:\u0026quot;BNB\u0026quot;,\u0026quot;amount\u0026quot;:\u0026quot;10000000\u0026quot;}],\u0026quot;expected_income\u0026quot;:\u0026quot;10000000:BNB\u0026quot;,\u0026quot;recipient_other_chain\u0026quot;:\u0026quot;\u0026quot;,\u0026quot;random_number_hash\u0026quot;:\u0026quot;4cf88f1acf8bcbc628609f3257406913f67e009e5c61f2671b601e40f4e5cc6a\u0026quot;,\u0026quot;random_number\u0026quot;:\u0026quot;cb5f6296078fd73b86d03eb58bc8a6e0af8d4b60c1cd678b71f8c185e206db53\u0026quot;,\u0026quot;timestamp\u0026quot;:\u0026quot;1572506189\u0026quot;,\u0026quot;cross_chain\u0026quot;:false,\u0026quot;expire_height\u0026quot;:\u0026quot;47222542\u0026quot;,\u0026quot;index\u0026quot;:\u0026quot;2254\u0026quot;,\u0026quot;closed_time\u0026quot;:\u0026quot;1572506323\u0026quot;,\u0026quot;status\u0026quot;:\u0026quot;Completed\u0026quot;} é€™æ¨£ swap å°±å®Œæˆäº†\nè¶…æ™‚ (Expired) è™•ç† ç”±æ–¼ HTLT æ˜¯æœ‰æ™‚é–“é™åˆ¶ï¼Œæœ‰å¯èƒ½æœƒè¶…æ™‚ï¼Œæœƒç„¡æ³•ç¹¼çºŒæ“ä½œï¼Œä¾‹å¦‚å¦å¤–ä¸€ç­† HTLT åœ¨å—æ–¹ deposit æ™‚ç„¡æ³• deposit\ntbnbcli token deposit \\ --swap-id ${SWAP_ID} \\ --amount 1:BNB \\ --from ${RECIPIENT_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 ERROR: { \u0026quot;codespace\u0026quot;:8, \u0026quot;code\u0026quot;:14, \u0026quot;abci_code\u0026quot;:524302, \u0026quot;message\u0026quot;:\u0026quot;Current block height is 46046996, the swap expire height(46043293) is passed\u0026quot; } è¶…é swap block height äº†ï¼Œå—æ–¹é€™é‚Šé€¾æ™‚å»å­˜éŒ¢ï¼Œå°è‡´æ•´å€‹ swap expiredï¼Œä¸èƒ½åœ¨åšä»€éº¼äº‹\nç™¼èµ·æ–¹å»é€é refund è§£é–\nRefund HTLT è‹¥æ˜¯å·²ç¶“ complete æˆ–æ˜¯ timeout expiredï¼Œç™¼èµ· HTLT çš„ address å¯ä»¥é€é refund ä¾†å–å›è³‡ç”¢\ntbnbcli token refund \\ --swap-id ${SWAP_ID} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 å›è¦† tx çš„ç‹€æ…‹ï¼Œå¯ä»¥åœ¨explorer ä¸Šçœ‹åˆ°ï¼Œtransaction type ç‚º refund swap\nCommitted at block 46047771 ( tx hash: F0F5AB40EF7B1CCFE54EBAE0B8022E9B3C381D0029C55A8FE7C3C87E8ACF800D, response: { Code:0 Data:[] Log:Msg 0: Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[114 101 102 117 110 100 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0 } ) é‡æ–°æŸ¥è©¢ swap ç‹€æ…‹ï¼Œå·²ç¶“è®Šæˆ expired\ntbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 { \u0026quot;from\u0026quot;: \u0026quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\u0026quot;, \u0026quot;to\u0026quot;: \u0026quot;tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\u0026quot;, \u0026quot;out_amount\u0026quot;: [{ \u0026quot;denom\u0026quot;: \u0026quot;BNB\u0026quot;, \u0026quot;amount\u0026quot;: \u0026quot;3\u0026quot; }], \u0026quot;in_amount\u0026quot;: null, \u0026quot;expected_income\u0026quot;: \u0026quot;1:BNB\u0026quot;, \u0026quot;recipient_other_chain\u0026quot;: \u0026quot;\u0026quot;, \u0026quot;random_number_hash\u0026quot;: \u0026quot;2c2588c81a5f08bf55a183cc2d61a123368405638741169933e200c90f4532e5\u0026quot;, \u0026quot;random_number\u0026quot;: \u0026quot;\u0026quot;, \u0026quot;timestamp\u0026quot;: \u0026quot;1571905650\u0026quot;, \u0026quot;cross_chain\u0026quot;: false, \u0026quot;expire_height\u0026quot;: \u0026quot;46043293\u0026quot;, \u0026quot;index\u0026quot;: \u0026quot;2239\u0026quot;, \u0026quot;closed_time\u0026quot;: \u0026quot;1571908256\u0026quot;, \u0026quot;status\u0026quot;: \u0026quot;Expired\u0026quot; } å¾ Ethereum swap åˆ° Binance Chain é€™é‚Šæˆ‘å€‘è¦å¾ ethereum ä¸Šï¼Œå°‡ ERC-20 token èˆ‡ binance chain ä¸Šçš„ BNB åšäº¤æ›ï¼Œå…ˆæº–å‚™éœ€è¦ç”¨åˆ°çš„æ±è¥¿\nbinance testnet æº–å‚™å¥½ address èˆ‡ BNBï¼Œé€™é‚Šæ²¿ç”¨æˆ‘å€‘ä¸Šç¯‡ä½¿ç”¨çš„ address tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p ethereum testnet (ropsten) Admin Address [ropsten etherscan] éƒ¨ç½² ERC20 token [ropsten etherscan]ï¼Œæˆ‘è‡ªå·±ç™¼è¡Œçš„ Party Parrot Token (PPT) éƒ¨ç½² ERC20 Atomic Swapper æ™ºèƒ½åˆç´„ binance-chain/bep3-smartcontract æä¾› Node/VM ç”¨ä¾†åŸ·è¡Œ bep3 deputy process https://github.com/binance-chain/bep3-deputy æä¾› workflow æˆ‘å€‘çœ‹ä¸€ä¸‹å®˜æ–¹æä¾›çš„é€™å¼µåœ–\nWallet Address åœ¨ ERC20 Token (PPToken) approve() Swap Contract ä¸€éƒ¨åˆ† Token åˆå§‹åŒ– Swap Transaction(tx) Deputy ç›£æ¸¬åˆ° Ethereum éˆä¸Šçš„ swap txï¼Œå‘ Binance Chain ç™¼èµ·ä¸€å€‹å°æ‡‰çš„ HTLT txï¼Œç­‰å¾… Binance ä¸Šçš„ claim tx Wallet Address å‘ Binance Chain åŸ·è¡Œ HTLT claim() Deputy ç›£æ¸¬åˆ° Binance Chain ä¸Šçš„ claim tx èˆ‡ swap completeï¼Œä»£ç‚ºå‘ Ethereum claim ERC-20 åŸ·è¡Œ deputy æˆ‘å€‘å¯ä»¥å…ˆå°‡ deputy ç¨‹åºè·‘èµ·ä¾†ï¼Œé€™é‚Šä½¿ç”¨çš„æ˜¯ Binance Chaing/bep3-deputy\ngo get github.com/binance-chain/bep3-deputy cd ${GOPATH}/src/github.com/binance-chain/bep3-deputy $ go mod download $ make build go build -o build/deputy main.go å•Ÿå‹•æœ¬åœ° MySQLï¼Œé€™é‚Šç›´æ¥ç”¨ docker èµ·ä¸€å€‹ç„¡å¯†ç¢¼çš„\n$ docker run \\ --name some-mysql \\ -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \\ -e MYSQL_DATABASE=deputy \\ -d \\ mysql:5.7.27 è¨­å®š config/confg.json\n{ \u0026quot;db_config\u0026quot;: { \u0026quot;dialect\u0026quot;: \u0026quot;mysql\u0026quot;, \u0026quot;db_path\u0026quot;: \u0026quot;root:@(localhost:3306)/deputy?charset=utf8\u0026amp;parseTime=True\u0026amp;loc=Local\u0026quot;, }, \u0026quot;chain_config\u0026quot;: { \u0026quot;bnb_start_height\u0026quot;: 42516056, \u0026quot;other_chain\u0026quot;: \u0026quot;ETH\u0026quot;, \u0026quot;other_chain_start_height\u0026quot;: 6495598 }, \u0026quot;admin_config\u0026quot;: { \u0026quot;listen_addr\u0026quot;: \u0026quot;127.0.0.1:8080\u0026quot; }, \u0026quot;bnb_config\u0026quot;: { \u0026quot;key_type\u0026quot;: \u0026quot;mnemonic\u0026quot;, \u0026quot;mnemonic\u0026quot;: \u0026quot;\u0026lt;my-mnemonic\u0026gt;\u0026quot;, \u0026quot;rpc_addr\u0026quot;: \u0026quot;tcp://data-seed-pre-0-s1.binance.org:80\u0026quot;, \u0026quot;symbol\u0026quot;: \u0026quot;BNB\u0026quot;, \u0026quot;deputy_addr\u0026quot;: \u0026quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\u0026quot;, \u0026quot;fetch_interval\u0026quot;: 2, }, \u0026quot;eth_config\u0026quot;: { \u0026quot;swap_type\u0026quot;: \u0026quot;erc20_swap\u0026quot;, \u0026quot;key_type\u0026quot;: \u0026quot;private_key\u0026quot;, \u0026quot;private_key\u0026quot;: \u0026quot;\u0026lt;my-private-key\u0026gt;\u0026quot;, \u0026quot;provider\u0026quot;: \u0026quot;https://ropsten.infura.io/v3/cd9643b1870b489b93477921cb767882\u0026quot;, \u0026quot;swap_contract_addr\u0026quot;: \u0026quot;0xA08E0F38462eCd107adE62Ee3004850f2448f3d6\u0026quot;, \u0026quot;token_contract_addr\u0026quot;: \u0026quot;0xDec348688B060fB44144971461b3BAaC8BD1e571\u0026quot;, \u0026quot;deputy_addr\u0026quot;: \u0026quot;0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b\u0026quot;, \u0026quot;gas_limit\u0026quot;: 300000, \u0026quot;gas_price\u0026quot;: 20000000000, } } é€™æ¨£æ³¨æ„å¹¾å€‹åœ°æ–¹\ndb_config å¡«ä¸Š mysql urlï¼Œæœ‰è¨­å¯†ç¢¼çš„è©±ä¸€ä½µå¸¶å…¥ chain_config.bnb_start_height å¯ä»¥å…ˆè¿½åˆ°ç›®å‰çš„ block heightï¼Œç•¢ç«Ÿæˆ‘å€‘çš„ swap tx éƒ½åœ¨ deputy èµ·ä¾†ä¹‹å¾Œæ‰æœƒç”¢ç”Ÿï¼Œå¯ä»¥è·³éå•Ÿå‹•æ™‚ sync block çš„æ™‚é–“ã€‚å¦‚æœæ˜¯è¦è¿½éå»çš„ txï¼Œå°±è¦èª¿æ•´ block çš„é«˜åº¦ï¼Œä¸¦ä¸”çµ¦äºˆè¶³å¤ çš„æ™‚é–“ä¸Š deputy å» sync blockã€‚å¯ä»¥åˆ° testnet-explorer æŸ¥ç›®å‰çš„ block heightã€‚ chain_config.other_chain_start_height ä¹Ÿè¿½åˆ°æœ€æ–°çš„ eth block heightï¼Œå¯ä»¥åˆ° Etherscan æŸ¥ç›®å‰çš„ block height bnb_config å¡«ä¸Š bnb addr èˆ‡åŠ©è¨˜ç¥  eth_config å¡«ä¸Š eth addr èˆ‡ private key eth_config.deupty_addr ä½¿ç”¨ Admin addrï¼Œä¸¦å¡«ä¸Š private key æŠŠ deputy ä»¥ testnet ç‚ºç›®æ¨™åŸ·è¡Œèµ·ä¾†\n./build/deputy --help ./build/deputy \\ --bnb-network 0 \\ --config-type local \\ --config-path config/config.json 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 INFO fetch ETH cur height: 6641795 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 INFO fetch BNB cur height: 46215517 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 INFO fetch try to get ahead block, chain=BNB, height=46215518 deputy å•Ÿå‹•å¾Œï¼Œå°±æœƒä¾æ“š db ä¸­çš„ block è³‡æ–™ï¼Œé–‹å§‹ä¸€è·¯è¿½ blockï¼Œç™¼ç¾æ˜¯ç›¸é—œçš„ addr å°±æŠŠ tx æ‹‰ä¸‹ä¾†è™•ç†ã€‚\nç”±æ–¼æˆ‘å€‘é€™é‚Šæ˜¯æ–° dbï¼Œæˆ‘å€‘åˆç›´æ¥è·³åˆ°æœ€æ–°çš„ blockï¼Œæ‡‰è©²ä¸æœƒéœ€è¦å¤ªå¤šæ™‚é–“å°±èƒ½è¿½ä¸Šã€‚\ndeputy æœ‰ admin api å¯ä»¥ä½¿ç”¨\ncurl http://localhost:8080 curl http://localhost:8080/failed_swaps/1 the number of total failed swaps is 0, the offset of query is 0 curl http://localhost:8080/status { \u0026quot;mode\u0026quot;: \u0026quot;NormalMode\u0026quot;, \u0026quot;bnb_chain_height\u0026quot;: 46215719, \u0026quot;bnb_sync_height\u0026quot;: 46215718, \u0026quot;other_chain_height\u0026quot;: 6641804, \u0026quot;other_chain_sync_height\u0026quot;: 6641804, \u0026quot;bnb_chain_last_block_fetched_at\u0026quot;: \u0026quot;2019-10-25T17:18:52+08:00\u0026quot;, \u0026quot;other_chain_last_block_fetched_at\u0026quot;: \u0026quot;2019-10-25T17:18:40+08:00\u0026quot;, \u0026quot;bnb_status\u0026quot;: { \u0026quot;balance\u0026quot;: [ { \u0026quot;symbol\u0026quot;: \u0026quot;BNB\u0026quot;, \u0026quot;free\u0026quot;: \u0026quot;18.99812504\u0026quot;, \u0026quot;locked\u0026quot;: \u0026quot;0.00000000\u0026quot;, \u0026quot;frozen\u0026quot;: \u0026quot;0.00000000\u0026quot; } ] }, \u0026quot;other_chain_status\u0026quot;: { \u0026quot;allowance\u0026quot;: \u0026quot;9.8e+13\u0026quot;, \u0026quot;erc20_balance\u0026quot;: \u0026quot;9.999999969e+20\u0026quot;, \u0026quot;eth_balance\u0026quot;: \u0026quot;6.982922764\u0026quot; } } å¯ä»¥çœ‹åˆ° deputy ä¸Šè¨­å®šçš„ bnb_addr, eth_addr çš„ç‹€æ…‹\nother_chain_status.allowance: 9.8e+13 é–‹å§‹ Swap è¤‡ç¿’ä¸€ä¸‹æµç¨‹\néƒ¨ç½²å¥½ swap contract \u0026amp; deputyï¼Œå•Ÿå‹• deputy process Wallet Address åœ¨ ERC20 Token (PPToken) approve()ï¼Œçµ¦ Swap Contract ä¸€éƒ¨åˆ† Token åˆå§‹åŒ– Swap Transaction(tx) Deputy ç›£æ¸¬åˆ° Ethereum éˆä¸Šçš„ swap txï¼Œå‘ Binance Chain ç™¼èµ·ä¸€å€‹å°æ‡‰çš„ HTLT txï¼Œç­‰å¾… Binance ä¸Šçš„ claim tx Wallet Address å‘ Binance Chain åŸ·è¡Œ HTLT claim() Deputy ç›£æ¸¬åˆ° Binance Chain ä¸Šçš„ claim tx èˆ‡ swap completeï¼Œä»£ç‚ºå‘ Ethereum claim ERC-20 ERC20 contract Approve() åˆ° ERC20 contract çš„é é¢ï¼Œé¸æ“‡ approve\nspender: swap contract address value: 10000 PPToken (ä¹˜ä¸Š 10^18)\nåˆ° etherscan ä¸ŠæŸ¥çœ‹\nCall HTLT function Go to swap contractï¼Œcall htlt()\nç”¨ etherscan é€ä¸Šå»ï¼Œç„¶å¾Œå°±å£æ‰äº†ï¼ŒEtherscan ä¸Šå£æ‰çš„ tx ä¸çŸ¥ç‚ºä»€éº¼ QAQ\né–‹ remix IDEï¼Œé‡æ–°å˜—è©¦åƒæ•¸\nrandomNumberHash: SHA256(randomNumber||timestamp), randomNumber is 32-length random byte array. 0x0000000000000000000000000000000000000000000000000000000000000000 timestamp: it should be about 10 mins span around current timestamp. unix timestamp 1572250902 (now + 60 sec * 10 min) heightSpan: it\u0026rsquo;s a customized filed for deputy operator. it should be more than 200 for this deputy. 10000 recipientAddr: deputy address on Ethereum. 0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b bep2SenderAddr: omit this field with 0x0 0x0000000000000000000000000000000000000000 bep2RecipientAddr: Decode your testnet address from bech32 encoded to hex 0xee82ca237387495e9603f4d8d7efed128bdd59a6 outAmount: approved amount, should be bumped by e^10. 10 0000000000 bep2Amount: outAmount * exchange rate, the default rate is 1. 10 0000000000 Deputy Call HTLT on Binance Chain Deputy ç›£æ¸¬ Ethereum ä¸Šçš„ block ç‹€æ…‹ï¼Œç‰¹åˆ¥æ˜¯æœƒå–å¾— Swap contract address çš„ swap txï¼Œä¸¦åœ¨ Binance Chain ä¸Šç”¢ç”Ÿå°æ‡‰çš„ HTLTã€‚\nClaim HTLT on Binance Chain Binance Chain ä¸Šç”¢ç”Ÿ HTLT å¾Œï¼Œå®¢æˆ¶ç«¯é€™é‚Šå¯ä»¥ä½¿ç”¨ tbnb ä»¥ recipient addr æŸ¥è©¢ Binance Chain ä¸Šçš„ Swap ID\ntbnbcli token query-swapIDs-by-recipient \\ --recipient-addr tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 ç²å¾—éå»ç”¢ç”Ÿçš„ swap list\n[ \u0026quot;c2be98ac3b9ee7153e5ba84edfefca1917b6e2ec72d2576bf6cce584cbd6095e\u0026quot;, \u0026quot;18c938b994c62bcce9e8cedcb426a603863d95565a246c323a1df89d5c4226c1\u0026quot;, \u0026quot;5c4fdd60ce44fa4be6de70e65df3f8295df88178fd381b4242a8c2d047663a1b\u0026quot;, \u0026quot;a47c89dfca910cbb34dec92acebebb59d2c62e7f90bf216a87c2c23c84e48d4f\u0026quot; ] éƒ½æ˜¯éå»ä½¿ç”¨çš„ swap idï¼Œå¦‚æœéƒ½æ²’æœ‰æ–°çš„ swap å‡ºä¾†ï¼Œå¯èƒ½æ˜¯ height span å¤ªé«˜ï¼Œå°è‡´ä¸€ç›´éƒ½çˆ¬ä¸åˆ°\nSWAP_ID=c2be98ac3b9ee7153e5ba84edfefca1917b6e2ec72d2576bf6cce584cbd6095e tbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 é€™é‚Šè¦å°ä¸€ä¸‹ random number, to wallet addr, out amount ç­‰åƒæ•¸ï¼Œå¦‚æœ HTLT ç¬¦åˆï¼Œå®¢æˆ¶å°±å¯ä»¥åŸ·è¡Œ Claim HTLT\ntbnbcli token claim \\ --swap-id ${SWAP_ID} \\ --random-number ${RANDOM_NUMBER} \\ --from ${FROM_KEY} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 Deputy Claim ERC20 Token å®¢æˆ¶ç«¯åœ¨ Binance Chain ä¸Š Claim HTLTï¼ŒDeputy åœ¨ Ethereuem ä¸Š Claim HTLTï¼Œè‡³æ­¤å®Œæˆ Atomic Swap å…©é‚Šçš„æµç¨‹ã€‚å®¢æˆ¶ç«¯å¾ Binance Chain Claimï¼ŒDeputy å¾ Ethereuem ä¸Š Claimã€‚å®Œæ•´æµç¨‹ å¦‚ä¸‹ï¼š\nClient Call HTLT on Ethereum -\u0026gt; Deputy Call HTLT on Binance Chain Client Check HTLT Status on Binance Chain Client Call Claim HTLT on Binance Chain -\u0026gt; Deputy Call Claim HTLT on Ethereum Client APP javascript Demo å¸Œæœ›ç›´æ¥å¯«æˆ javascript app å¯ä»¥åƒè€ƒé€™ç¯‡\nSwap Tokens from Binance Chain to Ethereum é€™é‚Šé€²è¡Œåå‘æ“ä½œï¼Œå®¢æˆ¶ç™¼èµ·å¾ Binance Chain æ›åˆ° Ethereum ä¸Šçš„è«‹æ±‚ï¼ŒDeputy åšå°æ‡‰çš„è™•ç†ï¼ŒæŠŠ Token Swap åˆ° Ethereumã€‚æˆ‘å€‘ä¾æ¨£ä¾ç…§é€™ä»½æ–‡ä»¶æ“ä½œã€‚\nå®¢æˆ¶ç«¯åœ¨ Binance Chain ä¸Š Call HTLT() Deputy åœ¨ Ethereum ä¸Š Init Swap tx Deputy Call Approve() åˆ° ethereum swap contract å®¢æˆ¶ç«¯å–å¾— swap è³‡è¨Š å®¢æˆ¶ç«¯åœ¨ Ethereum ä¸Š Call Claim()ï¼Œå–å¾— ERC-20 Token Deputy åœ¨ Binance ä¸Š Call Claim()ï¼Œå–å¾— Binance Chain Token åœ¨ Binance Chain ä¸Š HTLT å®¢æˆ¶ç«¯ç™¼èµ· HTLT è«‹æ±‚ï¼Œéœ€è¦å¾å®¢æˆ¶ç«¯ Wallet é€å‡ºï¼ˆä½†å› ç‚ºæˆ‘å€‘é€™é‚Šåªä½¿ç”¨ä¸€å€‹ Binance Addressï¼Œæ‰€ä»¥ç™¼èµ·çš„ Addr è·Ÿ Deputy Binance addr æ˜¯ä¸€æ¨£çš„ã€‚\né€™é‚Šé–é€² 10:BNBï¼Œç­‰å¾… 100:PPT å¾ ethereum è¿‘ä¾†\nDEPUTY_BNB_WALLET_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce CLIENT_BNB_WALLET_ADDR=${DEPUTY_BNB_WALLET_ADDR} CLIENT_ETHEREUM_ADDR=0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b tbnbcli token HTLT \\ --from ${CLIENT_BNB_WALLET_ADDR} \\ --recipient-addr ${DEPUTY_BNB_WALLET_ADDR} \\ --chain-id Binance-Chain-Nile \\ --height-span 500 \\ --amount 10:BNB \\ --expected-income 100:PPT \\ --recipient-other-chain ${CLIENT_ETHEREUM_ADDR} \\ --cross-chain \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 HTLT å›å¾©çš„çµæœå¦‚ä¸‹ï¼Œå¯ä»¥åœ¨Binance Testnet Explorer\nRandom number: 75267ba4cc4f2d9ddbf9f90dc1ea813ae2a4d2114eb2ef2cb7ff0a5d285c7396 Timestamp: 1572337686 Random number hash: dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b Password to sign with 'tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce': Committed at block 46889130 (tx hash: D653FC7B5D2048A2A165F49426CDCAD733703CF534367133819091892E3A1F14, response: {Code:0 Data:[119 24 196 176 181 1 29 177 60 107 100 166 55 16 253 136 159 3 204 56 109 46 63 87 93 9 239 158 138 172 21 129] Log:Msg 0: swapID: 7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) å–å¾— swap id èˆ‡ random numberï¼Œä½¿ç”¨ swap ip æŸ¥è©¢\nSWAP_ID=7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 tbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 å›å¾©ç•¶å‰çš„ç‹€æ…‹\n{ \u0026quot;from\u0026quot;:\u0026quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\u0026quot;, \u0026quot;to\u0026quot;:\u0026quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\u0026quot;, \u0026quot;out_amount\u0026quot;:[ { \u0026quot;denom\u0026quot;:\u0026quot;BNB\u0026quot;, \u0026quot;amount\u0026quot;:\u0026quot;10\u0026quot; } ], \u0026quot;in_amount\u0026quot;:null, \u0026quot;expected_income\u0026quot;:\u0026quot;100:PPT\u0026quot;, \u0026quot;recipient_other_chain\u0026quot;:\u0026quot;0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b\u0026quot;, \u0026quot;random_number_hash\u0026quot;:\u0026quot;dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b\u0026quot;, \u0026quot;random_number\u0026quot;:\u0026quot;\u0026quot;, \u0026quot;timestamp\u0026quot;:\u0026quot;1572337686\u0026quot;, \u0026quot;cross_chain\u0026quot;:true, \u0026quot;expire_height\u0026quot;:\u0026quot;46889630\u0026quot;, \u0026quot;index\u0026quot;:\u0026quot;2245\u0026quot;, \u0026quot;closed_time\u0026quot;:\u0026quot;0\u0026quot;, \u0026quot;status\u0026quot;:\u0026quot;Open\u0026quot; } Deputy Appove Token Deputy å·²ç¶“æŠ“åˆ° Binance Chain ä¸Šçš„ txï¼Œæœƒè¨˜éŒ„åœ¨ Mysql å…§\nuse deputy; select * from tx_log limit 10; | id | chain | swap_id | tx_type | tx_hash | contract_addr | sender_addr | receiver_addr | sender_other_chain | other_chain_addr | in_amount | out_amount | out_coin | random_number_hash | expire_height | timestamp | random_number | block_hash | height | status | confirmed_num | create_time | update_time | | 2 | BNB | 7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 | BEP2_HTLT | d653fc7b5d2048a2a165f49426cdcad733703cf534367133819091892e3a1f14 | | tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce | tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce | | 0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b | 100:PPT | 10 | BNB | dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b | 46889630 | 1572337686 | | 6948f34e4013da29c9922306b60b2c12f174925c63ff2a46d6b2fc3acd7a3774 | 46889130 | CONFIRMED | 6 | 1572337694 | 1572337695 | Deputy Send HTLT on Ethereum æŸ¥è©¢ Ethereum ä¸Šçš„ HTLT\nå®¢æˆ¶ç«¯ Call Claim å–å¾— ERC-20 Token å®¢æˆ¶ç«¯å–å¾— 100:PPT\nDeputy Call HTLT Claim å–å¾— Binance Token Deputy å–å¾— 10:BNB\nGCE gcloud compute ssh dep3-deputy sudo apt-get update sudo apt-get install mysql-server sudo cat /etc/mysql/debian.cnf wget https://dl.google.com/go/go1.13.3.linux-amd64.tar.gz tar -C /usr/local -xzf go1.13.3.linux-amd64.tar.gz export PATH=$PATH:/usr/local/go/bin go get github.com/binance-chain/bep3-deputy go mod tidy go build -o build/deputy main.go References Binace Chain Doc Binance BEP3 spec ","permalink":"https://chechia.net/posts/2019-10-22-blockchain-bep3-atomic-swap/","summary":"\u003ch1 id=\"bep3-atomic-swap\"\u003eBEP3 Atomic Swap\u003c/h1\u003e\n\u003cp\u003eBinance åœ¨ \u003ca href=\"https://github.com/binance-chain/BEPs/blob/master/BEP3.md\"\u003eBEP3: HTLC and Atomic Peg\u003c/a\u003e æåˆ°ï¼ŒBEP å³å°‡åœ¨ binance chain ä¸Šæ”¯æ´åŸç”Ÿçš„ Hash Timer Locked Transfer (HTLT) ï¼Œé€™ä½¿è·¨éˆçš„åŸå­æ€§äº¤æ› (atomic swap) è®Šå¾—å¯è¡Œï¼Œé€é HTLC åœ¨å…©é‚Šçš„éˆä¸Šé–ä½ (peg) tokensï¼Œç„¶å¾Œåªæœ‰åœ¨åŸ·è¡Œäº¤æ›çš„æ™‚å€™ï¼Œé€é hash äº¤æ›ï¼Œä¸€æ¬¡åŸ·è¡Œé›™é‚Šçš„äº¤æ˜“ã€‚\u003c/p\u003e\n\u003cp\u003eé—œæ–¼ Atomic Swap ç¶²è·¯æœ‰éå¸¸å¤šçš„è¨Šæ¯ï¼Œæœ‰èˆˆè¶£çš„è©±å¯ä»¥çœ‹\u003ca href=\"https://en.bitcoin.it/wiki/Atomic_swap\"\u003eé€™ç¯‡\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eäº¤æ˜“åªæœ‰åœ¨é›™é‚Šå®Œæˆå¾Œæ‰å®Œæˆï¼Œå®Œæˆä¹‹å‰ä¸èƒ½å‹•ç”¨äº¤æ›çš„è³‡ç”¢\u003c/li\u003e\n\u003cli\u003eåœ¨ä»»ä½•éšæ®µå¤±æ•ˆéƒ½å¯ä»¥å®Œå…¨ fallbackï¼Œä¸¦é€²è¡Œ refund\u003c/li\u003e\n\u003cli\u003eäº¤æ˜“çš„èªè­‰æ˜¯å»ä¸­å¿ƒåŒ–çš„\n\u003cul\u003e\n\u003cli\u003eé€™é‚Šæœ‰å€‹ä½†æ›¸ï¼ŒEthereum ä¸Šæ˜¯é€é smart contract å¯¦ç¾ï¼Œä½† Binance chain ä¸Šé‚„æ˜¯é  Binance èªè­‰ XD\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBinance åœ¨ BEP3 ä¸­æ”¯æ´ HTLCï¼Œæˆ‘å€‘é€™é‚Šä¸»è¦çš„è³‡è¨Šä¾†æºæ˜¯ binance.org çš„\u003ca href=\"https://docs.binance.org/atomic-swap.html\"\u003eå®˜æ–¹èªªæ˜æ–‡ä»¶\u003c/a\u003eï¼Œé€™é‚Šé‡å°æ–‡ç« é€²è¡Œé©—è­‰ï¼Œä¸¦ä¸”è£œè¶³æ–‡ä»¶ç¼ºæ¼çš„éƒ¨åˆ†ï¼Œæé†’éç¨‹ä¸­å¯èƒ½æœƒè¸©åˆ°çš„é›·ã€‚\u003c/p\u003e\n\u003ch3 id=\"è·¨éŠcross-chain-äº¤æ˜“\"\u003eè·¨éŠ(Cross Chain) äº¤æ˜“\u003c/h3\u003e\n\u003cp\u003eåœ¨éƒ¨ç½² asset / token çš„æ™‚å€™ï¼Œæˆ‘å€‘æœƒé¸æ“‡åˆé©çš„éˆä½œç‚ºç™¼å¸ƒè³‡ç”¢ä¸¦é‹è¡Œ block chain appã€‚å¸¸ç”¨çš„æ‡‰ç”¨éˆå¦‚ ethereum èˆ‡ binance chain ç­‰ç­‰ã€‚ä¸åŒçš„ä¸»éˆä¸Šæœ‰å„è‡ªçš„å„ªç¼ºé»ï¼Œä¾‹å¦‚ä½¿ç”¨ ethereum ï¼Œå¯ä»¥èˆ‡è¨±å¤š token èˆ‡æ‡‰ç”¨äº’å‹•ï¼Œä¹Ÿæ˜¯æœ€å¤šäººä½¿ç”¨çš„æ‡‰ç”¨ä¸»éˆã€‚è€Œåœ¨ binance éˆä¸ŠåŸ·è¡Œï¼Œå‰‡èƒ½å¤ å¿«é€Ÿçš„ç™¼ç”Ÿ transactionsï¼Œä¸¦ä¸”å¯ä»¥èˆ‡ binance ä¸Šçš„è³‡ç”¢èˆ‡äº¤æ˜“æ‰€äº’å‹•ã€‚\u003c/p\u003e","title":"Blockchain Bep3 Atomic Swap"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ è¶…ç°¡çŸ­æ¨å‘ oeprator-sdk éµäººè³½å¿ƒå¾— æ‰¿ä¸Š ä¸Šç¯‡ä»‹ç´¹äº† crd èˆ‡ controllerï¼Œç„¶è€Œæ²’æœ‰èªªæ˜ controller çš„ç·¨å¯«èˆ‡æ“ä½œï¼Œå› ç‚º controller çš„éƒ¨åˆ†æ¯”è¼ƒè¤‡é›œï¼Œæˆ‘å€‘éµäººæŒ‘æˆ°è³½å°¾è²ï¼Œç¯‡å¹…èªªå¯¦åœ¨æ˜¯ä¸å¤ªå¤ ã€‚\næœ‰èˆˆè¶£è©³ç´°äº†è§£çš„å¤§å¾·ï¼Œè«‹åƒè€ƒç›¸åŒéµäººæŒ‘æˆ°åœ˜éšŠçš„éšŠå‹æ–‡ç« ï¼Œè£é ­å° controller æœ‰è©³ç´°ä»‹ç´¹ï¼Œé€™é‚Šå°±ä¸è´…è¿°ã€‚ç›´æ¥æä¾›å€‹äººä½¿ç”¨è¦ºå¾—æœ€ç°¡å–®ä¸Šæ‰‹çš„ operator sdk\nOperator SDK Operator SDK æ˜¯ Operator framework ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œèƒ½æœ‰æ•ˆä¸”è‡ªå‹•åŒ–çš„ç®¡ç† kubernetes native apps, operator çš„ç®¡ç†å·¥å…·ã€‚\nè¤‡é›œçš„ kubernetes application æ˜¯éå¸¸é›£ç®¡ç†çš„ï¼Œå¯« operator ä¹Ÿæ˜¯å¾ˆæœ‰æŒ‘æˆ°ï¼Œä¸åƒ…è¦è™•ç†å¤§é‡ kubernetes åº•å±¤çš„ APIï¼Œè¦å¯«å¾ˆå¤šæ¨£ç‰ˆã€‚ operator SDK ä½¿ç”¨ controller-runtime çš„ library è®“ç·¨å¯« native application è®Šå¾—ç°¡å–®è¨±å¤š\nå¯ä»¥ä½¿ç”¨ä¸Šå±¤çš„ API èˆ‡æŠ½è±¡ä¾†ç·¨å¯« operator é‚è¼¯ å¿«é€Ÿä½¿ç”¨ code generation æœ‰æ“´å……å¥—ä»¶ Workflow é€™é‚Šä»¥ golang ç‚ºä¾‹èªªæ˜\nå®‰è£ operator sdk å®šç¾©æ–°çš„ API resource (custom resource definition) å®šç¾© controller ä¾†ç›£æ¸¬ custom resource ç·¨å¯« reconciling é‚è¼¯ä¾† sync desired state èˆ‡ current state ä½¿ç”¨ sdk cli é€²è¡Œæ¸¬è©¦ ä½¿ç”¨ sdk cli ä¾† buildï¼Œä¸¦ç”¢ç”Ÿéƒ¨å±¬ç”¨çš„ manifests å®‰è£è«‹ä¾ç…§ å®‰è£èªªæ˜ æ“ä½œå³å¯ã€‚\né€™é‚Šä½¿ç”¨ sdk cli ä¾†å¢åŠ æ–°çš„ crd\n# Add a new API for the custom resource AppService $ operator-sdk add api --api-version=app.example.com/v1alpha1 --kind=AppService ç”¢ç”Ÿçš„ go æºç¢¼æœƒæ”¾åœ¨ pkg ä¸­ï¼Œå¯ä»¥ä¾è‡ªå·±éœ€æ±‚èª¿æ•´ crd çš„çµæ§‹\né€™é‚Šä½¿ç”¨ sdk cli ç”¢ç”Ÿå°æ‡‰ crd çš„ controllerï¼Œè£é ­å·²ç¶“å¯«å¥½å¤§éƒ¨åˆ†çš„ code gene èˆ‡ reconcile çš„æ¨£æ¿ï¼Œç›´æ¥ä¿®æ”¹å°±å¯ä½¿ç”¨ï¼Œéå¸¸æ–¹ä¾¿\n# Add a new controller that watches for AppService $ operator-sdk add controller --api-version=app.example.com/v1alpha1 --kind=AppService ä¿®æ”¹å®Œï¼Œç›´æ¥ä½¿ç”¨ sdk cli build æˆ imageï¼Œç„¶å¾Œæ¨åˆ° image hub ä¸Š\n# Build and push the app-operator image to a public registry such as quay.io $ operator-sdk build quay.io/example/app-operator $ docker push quay.io/example/app-operator éƒ¨å±¬å‰æª¢æŸ¥ä¸€ä¸‹ manefests æª”æ¡ˆï¼Œç‰¹åˆ¥æ˜¯ crd.yaml èˆ‡ operator.yamlï¼Œå¦‚æœæºç¢¼æœ‰èª¿æ•´è¨˜å¾—åšå°æ‡‰çš„ä¿®æ”¹ã€‚\n# Setup Service Account $ kubectl create -f deploy/service_account.yaml # Setup RBAC $ kubectl create -f deploy/role.yaml $ kubectl create -f deploy/role_binding.yaml # Setup the CRD $ kubectl create -f deploy/crds/app.example.com_appservices_crd.yaml # Deploy the app-operator $ kubectl create -f deploy/operator.yaml é€™æ¨£ä¾¿éƒ¨å±¬äº† operatorï¼Œoperator æœƒç›£çœ‹æŒ‡å®šçš„ custom resourceï¼Œä¸¦ä¾ç…§ controller çš„é‚è¼¯é€²è¡Œ reconcileã€‚\né€™é‚Šä»¥å¢åŠ  custom resource ç‚ºä¾‹\n# Create an AppService CR # The default controller will watch for AppService objects and create a pod for each CR $ kubectl create -f deploy/crds/app.example.com_v1alpha1_appservice_cr.yaml å¢åŠ ä¸€å€‹ cr åˆ° kubernetes ä¸Šï¼Œé€™æ™‚ operator æœƒåµæ¸¬åˆ° cr çš„è®ŠåŒ–ï¼Œä¸¦ä¸”ä¾ç…§ reconcile çš„é‚è¼¯ sync\næª¢æŸ¥ä¸€ä¸‹ cr èˆ‡ operator çš„ç‹€æ…‹\n# Verify that a pod is created $ kubectl get pod -l app=example-appservice NAME READY STATUS RESTARTS AGE example-appservice-pod 1/1 Running 0 1m è©³ç´°çš„æ“ä½œæ­¥é©Ÿå¯ä»¥çœ‹ é€™é‚Š\nå°çµ äº‹å¯¦ä¸Šï¼Œoperator sdk çš„åŠŸèƒ½é‚„æœ‰éå¸¸å¤šï¼Œç´°è¬›åˆè¦èŠ±å¥½å¹¾ç¯‡æ–‡ç« è¬›ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒæœƒæ”¾åœ¨æˆ‘çš„å€‹äººç¶²ç«™ä¸Šã€‚\nå¦å¤– operator sdk ä¹Ÿæ­¡è¿å¤–éƒ¨çš„ Issue èˆ‡ PRï¼Œåœ˜éšŠçš„äººéå¸¸ nice æœƒé¡˜æ„èŠ±æ™‚é–“è·Ÿç¤¾ç¾¤æœ‹å‹æºé€šï¼Œæœ‰èˆˆè¶£è«‹ä¾† contributeã€‚\né€™ç³»åˆ—éµäººæ–‡ç« ï¼Œèªªå¯¦åœ¨æ²’æœ‰ä»€éº¼å¾ˆæ·±å…¥çš„æŠ€è¡“è¨è«–ï¼Œå¤šåŠè³‡æ–™éƒ½æ˜¯å„å€‹é …ç›®çš„å®˜æ–¹æ–‡ä»¶ç¿»è­¯ï¼ŒåŠ ä¸Šä¸€äº›å€‹äººçš„ç¶“é©—èˆ‡è§£è®€ï¼Œä¸¦ä¸æ˜¯å«é‡‘é‡å¾ˆé«˜çš„æ–‡ç« ã€‚ç„¶è€Œæˆ‘å€‹äººåœ¨æ¥è§¸é€™äº›é …ç›®æ™‚ï¼Œå»å¾€å¾€å› ç‚ºæ‰¾ä¸åˆ°ç´°ç¯€æ“ä½œçš„æ­¥é©Ÿåˆ†äº«æ–‡ç« ï¼Œåœ¨è¨±å¤šå°ç´°ç¯€ä¸Šæ’ç‰†å¾ˆä¹…ï¼Œä¹Ÿå› æ­¤æ‰æœ‰äº†é€™ç³»åˆ—æ–‡ç« ã€‚\né€™ç³»åˆ—æ–‡å°±åªæ˜¯è¸©é›·ä¹‹æ—…ï¼Œè®“å¾Œäººå¦‚æœæœ‰ç”¨åˆ°é€™äº›æ–‡ç« ï¼Œç”Ÿæ´»èƒ½éå¾—é–‹å¿ƒä¸€é»ï¼Œé€™ 30 å¤©çš„æ™‚é–“å°±æœ‰äº†åƒ¹å€¼ã€‚\néµäººæŒ‘æˆ°è³½çš„æœ€å¾Œä¸€å¤©ï¼Œæ„Ÿè¬å„è·¯å¤§å¾·ä¸€è·¯ç›¸éš¨ï¼Œè®“æˆ‘åœ¨å‡æ—¥ä¹Ÿèƒ½å¿ƒç”˜æƒ…é¡˜åœ°åä¸‹ä¾†å¯«æ–‡ç« ã€‚æ¸¸æ–¼è—å¤©ä¸€ç¯‡çœŸçš„å¾ˆé€¼äººï¼Œæœ‰å¹¾å¤©çš„æ–‡ç« å“è³ªæ˜¯æœ‰è »å¤šå•é¡Œçš„ï¼Œä¹Ÿæ„Ÿè¬å¤§å¾·å€‘å”åŠ©æ‰éŒ¯ï¼Œçµ¦äºˆå¾ˆå¤šå»ºè­°ã€‚\nè¬è¬å„ä½ã€‚\n","permalink":"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eè¶…ç°¡çŸ­æ¨å‘ oeprator-sdk\u003c/li\u003e\n\u003cli\u003eéµäººè³½å¿ƒå¾—\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"æ‰¿ä¸Š\"\u003eæ‰¿ä¸Š\u003c/h1\u003e\n\u003cp\u003eä¸Šç¯‡ä»‹ç´¹äº† crd èˆ‡ controllerï¼Œç„¶è€Œæ²’æœ‰èªªæ˜ controller çš„ç·¨å¯«èˆ‡æ“ä½œï¼Œå› ç‚º controller çš„éƒ¨åˆ†æ¯”è¼ƒè¤‡é›œï¼Œæˆ‘å€‘éµäººæŒ‘æˆ°è³½å°¾è²ï¼Œç¯‡å¹…èªªå¯¦åœ¨æ˜¯ä¸å¤ªå¤ ã€‚\u003c/p\u003e","title":"Kubernetes Custom Resources with Operator SDK"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ CRD å…§å®¹ Deploy CRD Use custom resource Recap åœ¨ä¸Šæ¬¡çš„ cert-manager å…§å®¹ä¸­æˆ‘å€‘èµ°é cert-manager çš„å®‰è£æ­¥é©Ÿï¼Œå…¶ä¸­æœ‰ä¸€å€‹æ­¥é©Ÿæ˜¯ apply cert-manager çš„ manigests æª”æ¡ˆ *.yaml)\nhttps://github.com/jetstack/cert-manager/tree/release-0.11/deploy/manifests\n$ git clone https://github.com/jetstack/cert-manager $ git checkout release-0.11 $ ls deploy/manifest 00-crds.yaml 01-namespace.yaml BUILD.bazel\tREADME.md\thelm-values.yaml æˆ‘å€‘å¿«é€Ÿçœ‹ä¸€ä¸‹é€™å€‹ 00-crds.yamlï¼Œé€™å€‹ yaml éå¸¸é•·ï¼Œç›´æ¥è·³åˆ° certificates.certmanager.k8s.io\nå¸Œæœ›çœ‹ golang æºç¢¼æ–‡ä»¶çš„è©±ï¼Œå¯ä»¥æ­é…godoc.org/k8s.io/apiextensions ä¾†é–±è®€ï¼Œæ›´èƒ½ç†è§£ definitionã€‚\nåœ¨çœ‹ä¹‹å‰å…ˆæ³¨æ„å¹¾ä»¶äº‹ï¼ŒCRD å…§é™¤äº† schema å¤–ï¼Œé‚„å®šç¾©äº†è¨±å¤šä¸åŒæƒ…å¢ƒçš„ä½¿ç”¨è³‡æ–™ã€‚\nCRD å…§å®šç¾©äº† custom resource çš„è³‡æ–™å„²å­˜ .spec.validation.openAPIV3Schemaï¼Œä½¿ç”¨ custom resource æœƒé€é validator é©—è­‰ .openAPIV3Schema å…§å®šç¾©äº† .specï¼Œä»¥åŠ rumtime ä¸­ç´€éŒ„ .status çš„è³‡æ–™ controller å¯ä»¥æŠŠç‹€æ…‹ sync åˆ° custom resource çš„ .status ä¸­ç´€éŒ„ controller å¯ä»¥æ¯”å° .spec èˆ‡ .status ä¾†æ±ºå®šæ˜¯å¦è¦ sync ä»¥åŠå¦‚ä½• sync CRD å…§å®šç¾©äº†èˆ‡ server ä»¥åŠ client äº’å‹•çš„æ–¹å¼ï¼Œ names ä¸­å®šç¾©å„ç¨®ä½¿ç”¨æƒ…å¢ƒçš„ custom resource åç¨± additionalPrinterColumns ä¸­æ·»åŠ  kubectl ä¸­çš„é¡¯ç¤ºå…§å®¹ // é€™é‚Šä½¿ç”¨çš„æ˜¯ v1beta1 çš„ API (deprecated at v1.16) ï¼Œæ–°ç‰ˆé–‹ç™¼å»ºè­°ä½¿ç”¨ apiextension.k8s.io/v1 çš„ api apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: creationTimestamp: null name: certificates.cert-manager.io spec: // ä½¿ç”¨ kubectl æœƒé¡å¤–é¡¯ç¤ºçš„è³‡è¨Šå…§å®¹ï¼Œé€é jsonpath å» parse é¡¯ç¤º additionalPrinterColumns: - JSONPath: .status.conditions[?(@.type==\u0026quot;Ready\u0026quot;)].status name: Ready type: string - JSONPath: .spec.secretName name: Secret type: string - JSONPath: .spec.issuerRef.name name: Issuer priority: 1 type: string - JSONPath: .status.conditions[?(@.type==\u0026quot;Ready\u0026quot;)].message name: Status priority: 1 type: string - JSONPath: .metadata.creationTimestamp description: CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. name: Age type: date group: cert-manager.io // å®šç¾© CRD åœ¨ä¸åŒæƒ…å¢ƒä¸‹ä½¿ç”¨çš„åç¨± names: kind: Certificate listKind: CertificateList plural: certificates shortNames: - cert - certs singular: certificate scope: Namespaced subresources: status: {} validation: // openAPIV3Schema ä¸­æ˜¯ custom resource å¯¦éš›æ“ä½œæœƒä½¿ç”¨çš„å…§å®¹ // properties ä½¿ç”¨ . .description .type ï¼Œåˆ†åˆ¥å®šç¾©åç¨±ï¼Œæè¿°ï¼Œæª¢æŸ¥å‹åˆ¥ openAPIV3Schema: description: Certificate is a type to represent a Certificate from ACME properties: apiVersion: description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources' type: string kind: description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds' type: string // custom resource runtime ä¸­çš„ metadata metadata: type: object // custom resource ä½¿ç”¨æ™‚çš„ specï¼Œå®šç¾© custom resoure çš„ desired status spec: ... // custom controller ç›£æ¸¬ custom resource çš„ current statusï¼Œé€™é‚Šçš„è³‡æ–™å®Œå…¨è¦– controller å¯¦ä½œä¾†ç”¢ç”Ÿï¼Œå¦‚æœæ²’æœ‰å¯¦ä½œ sync statusï¼Œä¹Ÿå¯ä»¥æ²’æœ‰è³‡æ–™ status: ... type: object // é€™å€‹æ˜¯ CRD ç‰©ä»¶çš„ versionï¼Œå¯ä»¥å®šç¾©å¤šå€‹ä¸åŒ version çš„ CRDï¼Œèª¿ç”¨æ™‚éœ€è¦è¨»æ˜ç‰ˆæœ¬ version: v1alpha2 versions: - name: v1alpha2 served: true storage: true // é€™å€‹æ˜¯ CRD ç‰©ä»¶çš„ statusï¼Œæè¿° CRD éƒ¨ç½²åˆ° API server çš„ç‹€æ…‹ï¼Œä¾‹å¦‚ CRD å„²å­˜é©ç”¨ configmap çš„å„²å­˜ç©ºé–“ï¼Œé€™é‚Šé¡¯ç¤ºåœ¨ API server ä¸Šçš„å„²å­˜ç‹€æ…‹ã€‚ä¸è¦è·Ÿ custom resource çš„ status å¼„æ··äº† status: acceptedNames: kind: \u0026quot;\u0026quot; plural: \u0026quot;\u0026quot; conditions: [] storedVersions: [] helm-values.yaml èˆ‡ 01-namespace.yaml å¾ˆå–®ç´”ï¼Œå‰è€…æ˜¯ä½¿ç”¨ helm éƒ¨ç½²çš„å¯è¨­å®šåƒæ•¸ï¼Œé è¨­åªæœ‰ kubernetes resourcesï¼Œå¾Œè€…å‰‡æ˜¯ç‚ºä¹‹å¾Œçš„ cert-manager å…ƒä»¶æ–°å¢ä¸€å€‹ kubernetes namespaceã€‚\nå°çµ CRD å…§å®¹ (apiextensions/v1beta1) CRD é¡¯ç¤ºåç¨±ï¼Œå…§å®¹ CRD spec é©—è­‰ custom resource custom resource schema CRD è‡ªèº«éƒ¨ç½²ç‹€æ…‹ éƒ¨ç½² éƒ¨ç½²ç›¸è¼ƒå®šç¾©æœ¬èº«å°±éå¸¸ç°¡å–®ï¼Œç›´æ¥ kubectl apply åˆ° kubernetes ä¸Š\nä½¿ç”¨ custom resource æœ‰äº† CRDï¼Œæˆ‘å€‘ä¾¿å¯ä»¥ä½¿ç”¨ CRUD APIï¼Œäº’å‹•æ¨¡å¼èˆ‡å…¶ä»– build-in kubernetes resources ç›¸åŒï¼Œåªæ˜¯å…§å®¹æœƒç…§ CRD ä¸Šçš„å®šç¾©èª¿æ•´\nkubectl get certificates.certmanager.k8s.io kubectl get certificates kubectl get certs --all-namespaces kubectl get cert -n cert-manager NAMESPACE NAME READY SECRET AGE cert-manager ingress-nginx-tls True ingress-nginx-tls 221d é€™é‚Šçœ‹åˆ°çš„å…§å®¹å¯èƒ½æœƒæœ‰äº›è½å·®ï¼Œå› ç‚ºæˆ‘ç•¶åˆç”¨çš„ç‰ˆæœ¬æ¯”è¼ƒèˆŠï¼Œä½†å…§å®¹å¤§åŒå°ç•°ã€‚\nåº•ä¸‹çš„ describe å…§å®¹å·²ç¶“è·Ÿä¸Šé¢çš„ CRD ç‰ˆæœ¬å·®å¤ªå¤šï¼Œå°ä¸èµ·ä¾†äº†ã€‚ä½†æˆ‘ä¹Ÿæ‡¶å¾—å†ä½ˆä¸€çµ„ï¼Œé‚„è¦é‡åš dnsName èˆ‡ authotization challenge\nç›´æ¥è®“å¤§å®¶æ„Ÿå—ä¸€ä¸‹èˆŠç‰ˆçš„å…§å®¹XD\n$ kubectl describe cert ingress-nginx-tls Name: ingress-nginx-tls Namespace: cert-manager API Version: certmanager.k8s.io/v1alpha1 Kind: Certificate Metadata: Creation Timestamp: 2019-03-06T06:48:26Z Generation: 4 Owner References: API Version: extensions/v1beta1 Block Owner Deletion: true Controller: true Kind: Ingress Name: ingress-nginx Self Link: /apis/certmanager.k8s.io/v1alpha1/namespaces/default/certificates/ingress-nginx-tls Spec: Acme: Config: Domains: chechiachang.com Http 01: Ingress: Ingress Class: nginx Dns Names: chechiachang.com Issuer Ref: Kind: ClusterIssuer Name: letsencrypt-prod Secret Name: ingress-nginx-tls // ç•¶å‰çš„ statusï¼Œcontroller sync ä¸Šä¾† // controller æœƒæ¯”å° .spec èˆ‡ .statusï¼Œåˆ¤æ–·æ˜¯å¦éœ€è¦åšäº‹ï¼Œex. renew Status: Acme: Order: URL: https://acme-v02.api.letsencrypt.org/acme/order/* Conditions: Last Transition Time: 2019-09-02T03:52:03Z Message: Certificate renewed successfully Reason: CertRenewed Status: True Type: Ready Last Transition Time: 2019-09-02T03:52:01Z Message: Order validated Reason: OrderValidated Status: False Type: ValidateFailed Events: \u0026lt;none\u0026gt; æƒ³è¦æ–°å¢ï¼Œå¯ä»¥å›å»çœ‹ cert-manager tutorialï¼Œé€™å€‹æ˜¯æ–°ç‰ˆçš„æ–‡ä»¶\nç•¶ç„¶ï¼Œä¸çˆ½é€™å€‹ cert resource ä¹Ÿå¯ä»¥å¹¹æ‰\n$ kubectl delete cert ingress-nginx-tls -n cert-manager ä»¥ä¸Š\nå°çµ ç°¡ä»‹ CRD èˆ‡ CRD å…§å®¹ æ“ä½œ custom resource ","permalink":"https://chechia.net/posts/2019-10-13-kubernetes-custom-resource-deployment/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eCRD å…§å®¹\u003c/li\u003e\n\u003cli\u003eDeploy CRD\u003c/li\u003e\n\u003cli\u003eUse custom resource\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"recap\"\u003eRecap\u003c/h1\u003e\n\u003cp\u003eåœ¨ä¸Šæ¬¡çš„ cert-manager å…§å®¹ä¸­æˆ‘å€‘èµ°é cert-manager çš„å®‰è£æ­¥é©Ÿï¼Œå…¶ä¸­æœ‰ä¸€å€‹æ­¥é©Ÿæ˜¯ apply cert-manager çš„ manigests æª”æ¡ˆ \u003ccode\u003e*.yaml\u003c/code\u003e)\u003c/p\u003e","title":"Kubernetes Custom Resource Deployment"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ custom resources custom controllers ç°¡ä»‹ custom resources Kubernetes é å…ˆå®šç¾©è¨±å¤š resource ï¼Œé€™äº› resource æ˜¯ kubernetes API é å…ˆè¨­ç½®çš„ API objectsï¼Œä¾‹å¦‚ kubernetes pods resource åŒ…å«è¨±å¤š pods ç‰©ä»¶ã€‚\nCustom resoure å‰‡æ˜¯é€éæ“´å…… kubernetes API ï¼Œè®“è‡ªå®šç¾©çš„ç‰©ä»¶ä¹Ÿå¯ä»¥åœ¨ kubernetes ä¸Šä½¿ç”¨ã€‚ä¸Šç¯‡ cert-manager å°±ä½¿ç”¨äº†è¨±å¤š custom resourceï¼Œé€™äº› resource åœ¨ä¸€èˆ¬å®‰è£çš„ kubernetes ä¸Šæ²’æœ‰å®‰è£ï¼Œéœ€è¦å®‰è£ custom resource difinitionï¼Œå‘ kubernetes cluster å®šç¾©æ–°çš„ custom resourceã€‚ä¾‹å¦‚ certificates.certmanager.k8s.io å°±æ˜¯ cert-manager è‡ªå®šç¾©çš„è³‡æºï¼Œç”¨ä¾†ä»£è¡¨ç”¢ç”Ÿ x509 certificate çš„å…§å®¹ã€‚\nè¶Šä¾†è¶Šå¤šçš„ kubernetes core æ–¹æ³•ï¼Œå¦‚ä»Šä¹Ÿä½¿ç”¨ custom resources ä¾†å®šç¾©ï¼Œè®“ kubernetes æ ¸å¿ƒå…ƒä»¶æ›´åŠ æ¨¡çµ„åŒ–ã€‚\ncustom resource å¯ä»¥åœ¨é‹è¡Œä¸­çš„ kubernetes é›†ç¾¤ä¸­è¨»å†Š (registration) ï¼Œä¹Ÿå¯ä»¥å‹•æ…‹è¨»éŠ·ï¼Œcustom resource ä¸¦ä¸æœƒå½±éŸ¿é›†ç¾¤æœ¬èº«çš„é‹ä½œã€‚åªè¦å‘ kubernetes è¨»å†Šå®Œ custom resourceï¼Œå°±å¯ä»¥é€é API èˆ‡ kubectl æ§åˆ¶ custom resourceï¼Œå°±åƒæ“ä½œ Pod resource ä¸€æ¨£ã€‚\nCustom controllers custom resource ä¸€ä½†è¨»å†Šï¼Œå°±å¯ä»¥ä¾æ“š resource çš„ CRD (custom resource definition) ä¾†æ“ä½œï¼Œå› æ¬¡å¯ä»¥å„²å­˜å®¢è£½åŒ–çš„è³‡æ–™å…§å®¹ã€‚ç„¶è€Œåœ¨å¾ˆå¤šæƒ…å½¢ï¼Œæˆ‘å€‘ä¸¦ä¸åªè¦ custom resource ä¾†è®€å¯«ï¼Œè€Œæ˜¯å¸Œæœ› custom resource èƒ½åŸ·è¡Œå®šç¾©çš„å·¥ä½œï¼Œå¦‚åŒ Pod resource å¯ä»¥åœ¨ kubernetes é›†ç¾¤ä¸Šæ§åˆ¶ Podï¼Œåœ¨ Pod resource ä¸Šæè¿°çš„ desired state kubernetes æœƒé€éå®šç¾©åœ¨ Pod API ä¸­çš„ sync é‚è¼¯ï¼Œä¾†é”åˆ° current state èˆ‡ desired state çš„å¹³è¡¡ã€‚\næˆ‘å€‘å¸Œæœ› custom resource ä¹Ÿèƒ½åšåˆ°ä¸Šè¿°çš„åŠŸèƒ½ï¼Œæä¾› declarative APIï¼Œè®“ä½¿ç”¨è€…ä¸éœ€ç·¨å¯«å®Œæ•´çš„ç¨‹å¼é‚è¼¯ï¼Œåªè¦é€éæ§åˆ¶ custom resourceï¼Œå°±å¯ä»¥é€é controller å…§å®šç¾©çš„é‚è¼¯ï¼Œä¾†å¯¦ç¾ desired stateã€‚ä½¿ç”¨è€…åªéœ€è¦å°ˆæ³¨åœ¨æ§åˆ¶ custom resource ä¸Šçš„ desired stateï¼Œè®“ controller è™•ç†ç´°ç¯€å¯¦ä½œã€‚\nä¾‹å¦‚ï¼šæˆ‘å€‘åœ¨ cert-manager ä¸­è¨­å®š certificates.certmanager.k8s.io è³‡æºï¼Œä¾†æè¿°æˆ‘å€‘å¸Œæœ›å–å¾— x509 certificate çš„ desired stateï¼Œä½†æˆ‘å€‘åœ¨ certificates.certmanager ä¸Šé¢æ²’æœ‰å¯«ã€é€é Let\u0026rsquo;s Encrypt å–å¾— x509 certificateã€çš„å¯¦ç¾é‚è¼¯ï¼Œä»ç„¶èƒ½é€é cert-manager ç”¢ç”Ÿ x509 certiticateï¼Œå› ç‚º cert-manager å…§éƒ¨å·²ç¶“å®šç¾© certificates.certmanager.k8s.io çš„ custom controllerã€‚\nåŸºæœ¬çš„ custom resource æ“ä½œ\nè¨»å†Š custom resource definitionï¼Œè®“ kubernetes API çœ‹å¾—æ‡‚ custom resource ä¸ç„¶ API æœƒå›è¦† error: the server doesn\u0026rsquo;t have a resource type æœ‰ CRD ä¾¿å¯ä»¥ apply custom resource åˆ°é›†ç¾¤ä¸­ éƒ¨ç½² custom controllerï¼Œç›£æ¸¬ custom resource çš„ desired state å…§å®¹ï¼Œä¸¦å¯¦ç¾é”åˆ° desired state çš„æ¥­å‹™é‚è¼¯ æ²’æœ‰ custom controllerï¼Œcustom resource å°±åªæ˜¯å¯ä»¥ apply èˆ‡ update çš„è³‡æ–™å„²å­˜çµæ§‹ï¼Œæ²’æœ‰ cert-manager ä¸­ controller çš„é‚è¼¯ï¼Œä¹Ÿé‚„æ˜¯ç”Ÿä¸å‡º x509 certificateã€‚ kubectl get chechiachang error: the server doesn't have a resource type \u0026quot;chechiachang\u0026quot; custom controller ä¹Ÿå¯ä»¥è·Ÿå…¶ä»–çš„ kubernetes resource äº’å‹•ï¼Œä¾‹å¦‚ cert-manager åœ¨ç”¢ç”Ÿ certificate çš„æ™‚å€™ï¼ŒæœƒæŠŠç”¢ç”Ÿçš„ certificate æª”æ¡ˆæ”¾åœ¨ secret ä¸­ï¼Œcert-manager æœƒä¾æ“š order ä¸­å®šç¾©çš„ lifecycle ï¼ŒæŒçºŒæª¢æŸ¥ certificate çš„æœ‰æ•ˆæ€§ï¼Œå¦‚æœæ¥è¿‘éæœŸï¼Œå‰‡æœƒè§¸ç™¼æ–°çš„ä¸€è¼ª orderã€‚\næˆ‘å€‘ä¹Ÿå¯ä»¥å¯«ä¸€å€‹æ“ä½œ Configmap èˆ‡ Deployment Resource çš„ custom controllerï¼Œä¾†é€²è¡Œ deploymnet çš„ Image æ›´æ–°ã€‚\næˆ‘éœ€è¦ custom resource å— kubernetes åœ¨should I add custom resource æœ‰åˆ—è¡¨åˆ†æè©²ä¸è©²ä½¿ç”¨ custom resource ï¼Œå°‡ä½ çš„ API é‚è¼¯æ•´åˆåˆ° kubernetes API ä¸Šã€‚å¹¾å€‹åˆ¤æ–·åƒè€ƒ:\nAPI æ˜¯ declarative modelï¼Œå¦‚æœä¸æ˜¯å¯èƒ½ä¸é©åˆè·Ÿ kubernetes API æ•´åˆï¼Œç¨ç«‹æˆç‚ºä¸€å€‹è‡ªå·±é‹è¡Œçš„æœå‹™å³å¯ éœ€è¦ä½¿ç”¨ kubernetes éœ€è¦ä½¿ç”¨ kubectl æ§åˆ¶ API éœ€è¦ä½¿ç”¨ kubernetes æ”¯æ´çš„åŠŸèƒ½ æ­£å“‰é–‹ç™¼å…¨æ–°åŠŸèƒ½ï¼Œå› ç‚ºæ•´åˆèˆŠçš„æœå‹™åˆ° kubernetes API å·¥ç¨‹æµ©å¤§ ä¹Ÿè¨± configmap/secret å°±å¯ä»¥è§£æ±º å¦‚æœåªæ˜¯éœ€è¦å°‡è³‡æ–™å„²å­˜åœ¨ kubernetes ä¸Šï¼Œæœ‰ä¸€å€‹ build-int çš„ kubernetes resource å¾ˆé©åˆï¼Œå°±æ˜¯ configmapã€‚å¯ä»¥ç˜€è€ƒä»¥ä¸‹æ¢ä»¶ï¼Œåˆ¤æ–·æ˜¯å¦ configmap æ­é…èƒ½ç›£çœ‹ configmap çš„ controller å°±å¯ä»¥é”æˆéœ€æ±‚ã€‚\nå·²ç¶“æœ‰å®Œæ•´çš„ config fileï¼Œä¾‹å¦‚ mysql.cnf, nginx.conf\u0026hellip; ä¸»è¦ç”¨é€”æ˜¯æŠŠæª”æ¡ˆæ›è¼‰åˆ° Pod ä¸­çš„ process ä½¿ç”¨ ä½¿ç”¨æ™‚çš„æ ¼å¼ï¼Œæ˜¯æ•´å€‹æª”æ¡ˆæ”¾åœ¨ Pod ä¸­ï¼Œæˆ–æ˜¯ä½¿ç”¨ç’°å¢ƒè®Šæ•¸å¡åˆ° Pod è£¡é¢ï¼Œè€Œä¸æ˜¯é€é kubernetes API å­˜å– (ex ä½¿ç”¨ kubectl) æ›´æ–° configmpa æ™‚æ›´æ–° Podï¼Œæœƒæ¯”æ›´æ–° custom resource æ™‚æ›´æ–° Pod å®¹æ˜“ å¦‚æœä½¿ç”¨ CRD æˆ– Aggregated kubernetes APIï¼Œå¤§å¤šç¬¦åˆä¸‹åˆ—æ¢ä»¶\nä½¿ç”¨ kubernetes libraries èˆ‡å®¢æˆ¶ç«¯ (ex kubectl) æ“ä½œ custom resource éœ€è¦ top level çš„ kubernetes æ”¯æ´ï¼Œä¾‹å¦‚å¯ä»¥ kubectl get cheachiachang è‡ªå‹•åŒ– kubernetes ç‰©ä»¶ éœ€è¦ç”¨åˆ° .spec, .status, .metadataï¼Œé€™äº›æ¯”è¼ƒ desired state èˆ‡ currenty state çš„åŠŸèƒ½ éœ€è¦æŠ½è±¡é¡åˆ¥ä¾†ç®¡ç†ä¸€ç¾¤ controlled resource Custom Resource Definition Custom Resoure Definition è®“ä½¿ç”¨è€…å¯ä»¥å®šç¾© custom resourceï¼Œå®šç¾© custom resource çš„æ ¼å¼åŒ…æ‹¬åç¨±èˆ‡ data schemaï¼Œç„¶å¾Œäº¤çµ¦ kubernetes API å»è™•ç† custom resource çš„å„²å­˜ã€‚\nä¹Ÿå°±æ˜¯èªªï¼Œé€é CRD æˆ‘å€‘ä¸ç”¨å¯« custom resource çš„ APIï¼Œä¾‹å¦‚ cert-manager ä¸ç”¨å¯« certificates.certmanager.k8s.io çš„ APIï¼Œè€Œæ˜¯å‘ kubernetes API server è¨»å†Š CRDï¼Œè®“ kubernetes API server çœ‹å¾—æ‡‚ custom source çš„å®šç¾©ï¼Œä¸¦ä¸”ç›´æ¥ä½¿ç”¨ kubernetes API serverï¼Œé€²è¡Œ custom resource çš„ CRUDã€‚\næˆ‘å€‘å¯ä»¥é€é kubectl (API server) æ“ä½œ certificates.certmanager.k8s.ioï¼Œé€™å€‹è«‹æ±‚ä¹Ÿæ˜¯é€åˆ° kubernetes API serverã€‚\nAPI server aggregation èƒ½å¤ é€éè¨»å†Š CRD ï¼Œå°±å¯ä»¥ä½¿ç”¨åŸä¾†çš„ kubernetes API ä¾†é€²è¡Œ CRUD ï¼Œæ˜¯å› ç‚º kubernetes API å°æ–¼æ™®é€šçš„ API æ“ä½œæä¾›æ³›å‹ (generic) ä»‹é¢ï¼Œç›´æ¥ä½¿ç”¨ CRUD çš„é‚è¼¯ã€‚\nç”±æ–¼æ˜¯ kubernetes Aggregated API ï¼Œæ‰€æœ‰ kubernetes çš„ clients éƒ½ä¸€èµ·å…¼å®¹æ–°è¨»å†Šçš„ custom resourceï¼Œä¸ç”¨åœ¨ API è¦å®šç¾©ï¼Œåœ¨å†Šæˆ¶ç«¯ä¹Ÿè¦å®šç¾©ã€‚è¨»å†Šå®Œçš„ custom resource definitionï¼Œå¯ä»¥ç›´æ¥é€é kubectl å­˜å–ã€‚\nå°çµ custom resource ç°¡ä»‹ custom resource ä½¿ç”¨çš„æƒ…å¢ƒèˆ‡æ¢ä»¶ custom resource definition èˆ‡ Aggregated API ","permalink":"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003ecustom resources\u003c/li\u003e\n\u003cli\u003ecustom controllers\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"ç°¡ä»‹-custom-resources\"\u003eç°¡ä»‹ custom resources\u003c/h1\u003e\n\u003cp\u003eKubernetes é å…ˆå®šç¾©è¨±å¤š resource ï¼Œé€™äº› resource æ˜¯ \u003ca href=\"https://kubernetes.io/docs/reference/using-api/api-overview/\"\u003ekubernetes API\u003c/a\u003e é å…ˆè¨­ç½®çš„ \u003ca href=\"https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/\"\u003eAPI objects\u003c/a\u003eï¼Œä¾‹å¦‚ kubernetes pods resource åŒ…å«è¨±å¤š pods ç‰©ä»¶ã€‚\u003c/p\u003e","title":"Kubernetes Custom Resources Basic"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nRecap æ˜¨å¤©æˆ‘å€‘å¯¦éš›ä½¿ç”¨ cert-managerï¼Œç‚º nginx ingress controller ç”¢ç”Ÿ certificatesï¼Œéç¨‹ä¸­æˆ‘å€‘åšäº†å¹¾ä»¶äº‹\nè¨­ç½® Let\u0026rsquo;s Encript prod site çš„ Issuer è¨­ç½® certificates.certmanager.k8s.io è³‡æºä¾†å®šç¾© certificate çš„å–å¾—æ–¹å¼ æˆ–æ˜¯åœ¨ ingress ä¸­é…ç½® tlsï¼Œè®“ cert-manager è‡ªå‹•é€é ingress-shim ç”¢ç”Ÿ certifcates.cert-managerï¼Œä¸¦ä¸”ç”¢ç”Ÿ certificate ä»¥ä¸Šæ˜¯ä½¿ç”¨ cert-manager ç”¢ç”Ÿ certificate çš„åŸºæœ¬æ“ä½œï¼Œå‰©ä¸‹çš„æ˜¯ç”± cert-manager å®Œæˆã€‚å¯¦éš›ä¸Š cert-manager åœ¨ç”¢ç”Ÿå‡º certificate ä¹‹å‰é‚„åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œæˆ‘å€‘ä»Šå¤©å°±è©³ç´°èµ°éå®Œæ•´æµç¨‹ï¼Œè—‰æ­¤äº†è§£ cert-manager é…åˆ issuing certificate çš„æµç¨‹\nä½¿ç”¨è€…è¨­ç½® Issuer\nä½¿ç”¨è€…è¨­å®š certificate -\u0026gt; cert-manager æ ¹æ“š certificate -\u0026gt; ç”¢ç”Ÿ certificate\nCertificateRequests certificaterequests.certmanager æ˜¯ cert-manager ç”¢ç”Ÿ certificate éç¨‹ä¸­æœƒä½¿ç”¨çš„è³‡æºï¼Œä¸æ˜¯è¨­è¨ˆä¾†è®“äººé¡æ“ä½œçš„è³‡æºã€‚\nç•¶ cert-manager ç›£æ¸¬åˆ° certificate ç”¢ç”Ÿå¾Œï¼Œæœƒç”¢ç”Ÿ certificaterequests.certmanager.k8s.io è³‡æºï¼Œä¾†å‘ issuer request certificateï¼Œé€™å€‹éç¨‹èˆ‡ä½¿ç”¨å…¶ä»–å®¢æˆ¶ç«¯ (ex. certbot) ä¾†å‘ 3rd party CA server request certificate æ™‚çš„å…§å®¹ç›¸åŒï¼Œåªæ˜¯é€™é‚Šæˆ‘å€‘ä½¿ç”¨ kubernetes resource ä¾†å®šç¾©ã€‚\nåŒ…å«çš„ certificate requestï¼Œæœƒä»¥ pem encoded çš„å½¢å¼ï¼Œå†è®Šæˆ base64 encoded å­˜æ”¾åœ¨ resource ä¸­ã€‚é€™å€‹ pem key ä¹Ÿæœƒå¾åˆ°é æ–¹çš„ CA sercer (Let\u0026rsquo;s Encrypt prod) ä¾† request certificate\nå¦‚æœ issuance æˆåŠŸï¼Œcertificaterequest è³‡æºæ‡‰è©²æœƒè¢« cert-manager åƒæ‰ï¼Œä¸æœƒè¢«äººé¡çœ‹åˆ°ã€‚\nä¸€å€‹ certificaterequests.certmanager å¤§æ¦‚é•·é€™æ¨£\napiVersion: cert-manager.io/v1alpha2 kind: CertificateRequest metadata: name: my-ca-cr spec: csr: LS0tLS1CRUdJTiBDRVJUSUZJQ0FUR .................................. LQo= isCA: false duraton: 90d issuerRef: name: ca-issuer # We can reference ClusterIssuers by changing the kind here. # The default value is Issuer (i.e. a locally namespaced Issuer) kind: Issuer group: cert-manager.io é€™å€‹ certificaterequests.certmanager æœƒè®“ cert-manager å˜—è©¦å‘ Issuer (lets-encrypt-prod) request certificateã€‚\nOrder orders.certmanager.k8s.io è¢« ACME çš„ Issuer ä½¿ç”¨ï¼Œç”¨ä¾†ç®¡ç† signed TLD certificate çš„ ACME orderï¼Œé€™å€‹ resource ä¹Ÿæ˜¯ cert-manager è‡ªè¡Œç”¢ç”Ÿç®¡ç†çš„ resourceï¼Œä¸éœ€è¦äººé¡ä¾†æ›´æ”¹ã€‚\nç•¶ä¸€å€‹ certificates.certmanager ç”¢ç”Ÿï¼Œä¸”éœ€è¦ä½¿å‹‡ ACME isser æ™‚ï¼Œcertmanager æœƒç”¢ç”Ÿ orders.certmanager ï¼Œä¾†å–å¾— certificateã€‚\nChallenges challenges.certmanager è³‡æºæ˜¯ ACME Issuer ç®¡ç† issuing lifecycle æ™‚ï¼Œç”¨ä¾†å®Œæˆå–®ä¸€å€‹ DNS name/identifier authorization æ™‚æ‰€ä½¿ç”¨çš„ã€‚ç”¨ä¾†ç¢ºå®š issue certiticate çš„å®¢æˆ¶ç«¯çœŸçš„æ˜¯ DNS name çš„æ“æœ‰è€…ã€‚\nç•¶ cert-manager ç”¢ç”Ÿ order æ™‚ï¼Œorder controller æ¥åˆ° order ï¼Œå°±æœƒç‚ºæ¯ä¸€å€‹éœ€è¦ DNS certificate çš„ DNSname ï¼Œç”¢ç”Ÿ challenges.certmanagerã€‚\né€™æ®µä¹Ÿæ˜¯ order controller è‡ªå‹•ç”¢ç”Ÿï¼Œä¸¦ä¸éœ€è¦ä½¿ç”¨è€…åƒèˆ‡ã€‚\nACME certificate issuing user -\u0026gt; è¨­å®šå¥½ issuers.certmanager\nuser -\u0026gt; ç”¢ç”Ÿ certificates.certmanager -\u0026gt; é¸æ“‡ Issuer -\u0026gt;\ncert-manager -\u0026gt; ç”¢ç”Ÿ certificaterequest -\u0026gt;\ncert-manager æ ¹æ“š certiticfates.certmanager ç”¢ç”Ÿ orders.certmanager -\u0026gt;\norder controller æ ¹æ“š order ï¼Œä¸¦ä¸”è·Ÿæ¯ä¸€å€‹ DNS name targetï¼Œç”¢ç”Ÿä¸€å€‹ challenges.certmanager\nchallenges.certmanager ç”¢ç”Ÿå¾Œï¼Œæœƒé–‹å•Ÿé€™å€‹ DNS name challenge çš„ lifecycle\nchallenges ç‹€æ…‹ç‚º queued for processingï¼Œåœ¨ä½‡åˆ—ä¸­ç­‰å¾…ï¼Œ å¦‚æœæ²’æœ‰åˆ¥çš„ chellenges åœ¨é€²è¡Œï¼Œchallenges ç‹€æ…‹è®Šæˆ scheduledï¼Œé€™æ¨£å¯ä»¥é¿å…å¤šå€‹ DNS challenge åŒæ™‚ç™¼ç”Ÿï¼Œæˆ–æ˜¯ç›¸åŒåç¨±çš„ DNS challenge é‡è¤‡ challenges èˆ‡é ç«¯çš„ ACME server \u0026lsquo;synced\u0026rsquo; ç•¶å‰çš„ç‹€æ…‹ï¼Œæ˜¯å¦ valid å¦‚æœ ACME å›æ‡‰é€™å€‹ DNS name çš„ challenge é‚„æ˜¯æœ‰æ•ˆçš„ï¼Œå‰‡ç›´æ¥æŠŠ challenges çš„ç‹€æ…‹æ”¹æˆ validï¼Œç„¶å¾Œç§»å‡ºæ’ç¨‹ä½‡åˆ—ã€‚ å¦‚æœ challenges ç‹€æ…‹ä»ç„¶ç‚º pendingï¼Œchallenge controller æœƒä¾ç…§è¨­å®š present é€™å€‹ challengeï¼Œä½¿ç”¨ HTTP01 æˆ–æ˜¯ DNS01ï¼Œchallenges è¢«æ¨™è¨˜ç‚º presented challenges å…ˆåŸ·è¡Œ self checkï¼Œç¢ºå®š challenge ç‹€æ…‹å·²ç¶“å‚³æ’­çµ¦ dns serversï¼Œå¦‚æœ self check å¤±æ•—ï¼Œå‰‡æœƒä¾ç…§ interval retry ACME authorization é—œè¯åˆ° challenge cert-manager è™•ç† \u0026lsquo;scheduled\u0026rsquo; challenges.certmanager -\u0026gt; ACME challenge\n","permalink":"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"recap\"\u003eRecap\u003c/h1\u003e\n\u003cp\u003eæ˜¨å¤©æˆ‘å€‘å¯¦éš›ä½¿ç”¨ cert-managerï¼Œç‚º nginx ingress controller ç”¢ç”Ÿ certificatesï¼Œéç¨‹ä¸­æˆ‘å€‘åšäº†å¹¾ä»¶äº‹\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè¨­ç½® Let\u0026rsquo;s Encript prod site çš„ Issuer\u003c/li\u003e\n\u003cli\u003eè¨­ç½® certificates.certmanager.k8s.io è³‡æºä¾†å®šç¾© certificate çš„å–å¾—æ–¹å¼\u003c/li\u003e\n\u003cli\u003eæˆ–æ˜¯åœ¨ ingress ä¸­é…ç½® tlsï¼Œè®“ cert-manager è‡ªå‹•é€é ingress-shim ç”¢ç”Ÿ certifcates.cert-managerï¼Œä¸¦ä¸”ç”¢ç”Ÿ certificate\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä»¥ä¸Šæ˜¯ä½¿ç”¨ cert-manager ç”¢ç”Ÿ certificate çš„åŸºæœ¬æ“ä½œï¼Œå‰©ä¸‹çš„æ˜¯ç”± cert-manager å®Œæˆã€‚å¯¦éš›ä¸Š cert-manager åœ¨ç”¢ç”Ÿå‡º certificate ä¹‹å‰é‚„åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œæˆ‘å€‘ä»Šå¤©å°±è©³ç´°èµ°éå®Œæ•´æµç¨‹ï¼Œè—‰æ­¤äº†è§£ cert-manager é…åˆ issuing certificate çš„æµç¨‹\u003c/p\u003e","title":"Cert Manager Complete Workflow"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nä»Šå¤©æˆ‘å€‘ä¾†å¯¦éš›ä½¿ç”¨ cert-managerï¼Œç‚º nginx ingress controller ç”¢ç”Ÿ certificates with ACME Issuer\nCA Terminology å…ˆæŠŠå¯¦éš›åŸ·è¡Œ CA ç°½ç™¼çš„åè©å®šç¾©ä¸€ä¸‹ï¼Œä»¥å…è·Ÿ cert-manager çš„è³‡æºææ··\nCertificate: æ†‘è­‰ï¼Œx509 certificateï¼Œcert-manager è‡ªå‹•ç®¡ç†çš„ç›®æ¨™ï¼Œé€é let\u0026rsquo;s encript å–å¾—çš„ x509 certificates CA (Certificate Authority): issue signed certificate çš„æ©Ÿæ§‹ issue: é ’ç™¼ï¼ŒæŒ‡ CA ç”¢ç”Ÿ certificate èˆ‡ key (ä»Šå¤©çš„ç¯„ä¾‹æ ¼å¼æ˜¯ .crt èˆ‡ .key) Sign vs self-signed: ç°½æ ¸ï¼Œè‡ªå·±ç°½æ ¸ï¼Œä½¿ç”¨ä¿¡ä»»çš„ CA issue certificateï¼Œæˆ–æ˜¯ä½¿ç”¨è‡ªå·±ç”¢ç”Ÿçš„ CA self-signï¼Œç„¶å¾ŒæŠŠ CA åŠ åˆ°å¯ä»¥è¢«ä¿¡ä»»çš„ CA æ¸…å–®ä¸­ã€‚ Let\u0026rsquo;s Encript CA issues signed certificates\nKubernetes in-cluster CA issues self-signed certificates\ncert-manager çš„ CRD è³‡æºï¼Œä½¿ç”¨ä¾†æè¿° cert-manager å¦‚ä½•åŸ·è¡Œä¸Šè¿°æ“ä½œï¼ŒCRD åº•ä¸‹éƒ½æœƒåŠ ä¸Š ``*.certmanager.k8s.io` æ–¹ä¾¿è¾¨è­˜ã€‚\nè¨­å®š Issuer Issuer è¦æ€éº¼ç¿»æˆä¸­æ–‡XDï¼Œæ†‘è­‰é ’ç™¼æ©Ÿæ§‹ï¼Ÿ\nç¸½ä¹‹åœ¨é–‹å§‹ç°½ç™¼ certificates å‰ï¼Œè¦å…ˆå®šç¾© issuers.certmanager.k8s.io ï¼Œä»£è¡¨ä¸€å€‹èƒ½ç°½ç™¼ certificate CAï¼Œä¾‹å¦‚ Let\u0026rsquo;s Encriptï¼Œæˆ–æ˜¯ kubernetes å…§éƒ¨ä¹Ÿæœ‰å…§éƒ¨ä½¿ç”¨çš„æ†‘è­‰ç°½ç™¼ï¼Œæ”¾åœ¨ secrets ä¸­ã€‚\né€™äº› Issuer æœƒè®“ certificates.certmanager.k8s.i8o ä½¿ç”¨ï¼Œå®šç¾©å¦‚ä½•å–å¾— certificate æ™‚ï¼Œé¸æ“‡ Issuerã€‚\ncert-manager ä¸Šå¯ä»¥å®šç¾©å–®ä¸€ namespace çš„ issuers.certmanager èˆ‡é›†ç¾¤éƒ½å¯ä½¿ç”¨çš„ clusterissuers.certmanager\ncert-manager æœ‰æ”¯æ´å¹¾ç¨®çš„ issuer type\nCA: ä½¿ç”¨ x509 keypair ç”¢ç”Ÿcertificateï¼Œå­˜åœ¨ kubernetes secret Self signed: è‡ªç°½ certificate ACME: å¾ ACME (ex. Let\u0026rsquo;s Encrypt) server å–å¾— ceritificate Vault: å¾ Vault PKI backend é ’ç™¼ certificate Venafi: Venafi Cloud Certificate æœ‰äº†ç°½ç™¼æ†‘è­‰çš„å–®ä½ï¼Œæ¥ä¸‹ä¾†è¦å®šç¾©å¦‚ä½•å–å¾— certificateã€‚certificates.certmanager.k8s.io æ˜¯ CRDï¼Œç”¨ä¾†å‘Šè¨´ cert-manager è¦å¦‚ä½•å–å¾— certificate\ncertifcates.certmanager.k8s.io æä¾›äº†ç°¡å–®ç¯„ä¾‹\napiVersion: cert-manager.io/v1alpha2 kind: Certificate metadata: name: acme-crt spec: secretName: acme-crt-secret duration: 90d renewBefore: 30d dnsNames: - foo.example.com - bar.example.com acme: config: - http01: ingressClass: nginx domains: - foo.example.com - bar.example.com issuerRef: name: letsencrypt-prod # We can reference ClusterIssuers by changing the kind here. # The default value is Issuer (i.e. a locally namespaced Issuer) kind: Issuer ä¸Šé¢é€™å€‹ certificate.certmanger å‘Šè¨´ cert-manager\né‡å° foo.example.com èˆ‡ bar.example.com å…©å€‹ domainsc ä½¿ç”¨ letsencript-prd Issuer å»å–å¾— certificate key pair æˆåŠŸå¾ŒæŠŠ ceritifcate èˆ‡ key å­˜åœ¨ secret/acme-crt-secret ä¸­(ä»¥ tls.key, tls.crt çš„å½¢å¼) èˆ‡ certificate.certmanager éƒ½æ”¾åœ¨ç›¸åŒ namespace ä¸­ï¼Œç”¢ç”Ÿ certificate.certmanager çš„æ™‚å€™è¦æ³¨æ„æ‰ä¸æœƒæ‰¾ä¸åˆ° secret é€™é‚ŠæŒ‡å®šäº† certificate çš„æœ‰æ•ˆæœŸé–“èˆ‡ renew æ™‚é–“ (é è¨­å€¼)ï¼Œæœ‰éœ€è¦å¯ä»¥æ›´æ”¹ é…åˆ Ingress è¨­ç½® tls æœ‰ä¸Šè¿°çš„è¨­å®šï¼Œæ¥ä¸‹ä¾†å¯ä»¥è«‹æ±‚ tls certificate\nè¨˜å¾—æˆ‘å€‘ä¸Šç¯‡ Nginx Ingress Controller æåˆ°çš„ ingreess è¨­å®šå—ï¼Ÿé€™é‚Šæº–å‚™äº†ä¸€å€‹é©åˆé…åˆ nginx ingress ä½¿ç”¨çš„ tls è¨­å®š\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: my-nginx-ingress annotations: kubernetes.io/ingress.class: \u0026quot;nginx\u0026quot; cert-manager.io/issuer: \u0026quot;letsencrypt-prod\u0026quot; spec: tls: - hosts: - foo.example.com secretName: my-nginx-ingrss-tls rules: - host: foo.example.com http: paths: - path: / backend: serviceName: chechiachang-backend servicePort: 80 é€™å€‹ ingress apply å¾Œï¼Œå°±æœƒæ ¹æ“š spec.tls çš„ hosts è¨­å®šï¼Œè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ certificate.certmanager è³‡æºï¼Œä¸¦åœ¨é€™å€‹è³‡æºä½¿ç”¨ letsencryp-prodã€‚\nä¸ç”¨æˆ‘å€‘æ‰‹å‹• apply æ–°çš„ ceritificateï¼Œé€™é‚Šæ˜¯ cert-manager ä½¿ç”¨äº† annotation ä¾†è§¸ç™¼ Ingress-shimï¼Œç°¡å–®ä¾†èªªï¼Œç•¶ ingress ä¸Šæœ‰ä½¿ç”¨ cert-manager.io çš„ annotation æ™‚ï¼Œcert-manager å°±æœƒæ ¹æ“š ingress è¨­å®šå…§å®¹ï¼ŒæŠ½å‡º spec.tls èˆ‡ isuer annotationï¼Œä¾†ç”¢ç”ŸåŒåçš„ certificates.certmanagerï¼Œé€™å€‹ certificateas.certmanager æœƒè§¸ç™¼æ¥ä¸‹çš„ certificate é ’ç™¼éœ€æ±‚ã€‚\nåªè¦éƒ¨ç½² Issuer èˆ‡ Ingress å°±å¯ä»¥è‡ªå‹•ç”¢ç”Ÿ certificateã€‚ç•¶ç„¶ï¼Œå¸Œæœ›æ‰‹å‹• apply certificates.certmanager ä¹Ÿæ˜¯è¡Œå¾—é€šã€‚\næŠŠç”¢ç”Ÿäº† certificate.certmanager æ‹‰å‡ºä¾†çœ‹\nkubectl describe certificate my-nginx-ingress Name: my-nginx-ingress Namespace: default API Version: cert-manager.io/v1alpha2 Kind: Certificate Metadata: Cluster Name: Creation Timestamp: 2019-10-10T17:58:37Z Generation: 0 Owner References: API Version: extensions/v1beta1 Block Owner Deletion: true Controller: true Kind: Ingress Name: my-nginx-ingress Resource Version: 9295 Spec: Dns Names: example.your-domain.com Issuer Ref: Kind: Issuer Name: letsencrypt-prod Secret Name: my-nginx-ingress-tls Status: Acme: Order: URL: https://acme-prod-v02.api.letsencrypt.org/acme/order/7374163/13665676 Conditions: Last Transition Time: 2019-10-10T18:05:57Z Message: Certificate issued successfully Reason: CertIssued Status: True Type: Ready Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal CreateOrder 1d cert-manager Created new ACME order, attempting validation... Normal DomainVerified 1d cert-manager Domain \u0026quot;foo.example.com\u0026quot; verified with \u0026quot;http-01\u0026quot; validation Normal IssueCert 1d cert-manager Issuing certificate... Normal CertObtained 1d cert-manager Obtained certificate from ACME server Normal CertIssued 1d cert-manager Certificate issued Successfully æŠŠ certificate å¾ secret æ’ˆå‡ºä¾†çœ‹\n$ kubectl describe secret my-nginx-ingress-tls Name: my-nginx-ingress-tls Namespace: default Labels: cert-manager.io/certificate-name=my-nginx-ingrsss-tls Annotations: cert-manager.io/alt-names=foo.example.com cert-manager.io/common-name=foo.example.com cert-manager.io/issuer-kind=Issuer cert-manager.io/issuer-name=letsencrypt-prod Type: kubernetes.io/tls Data ==== tls.crt: 3566 bytes tls.key: 1675 bytes å¦‚æ­¤ä¾¿å¯ä»¥é€é ingress è¨­å®š nginx ä½¿ç”¨ https\nå°çµ äº†è§£ *.certmanager.k8s.io CRD å®šç¾©èˆ‡æ„ç¾© è¨­å®š Issuer èˆ‡ certificate é€é ingress-shim ç›´æ¥éƒ¨ç½² ingress ä¾†ç”¢ç”Ÿ certificate ","permalink":"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä»Šå¤©æˆ‘å€‘ä¾†å¯¦éš›ä½¿ç”¨ cert-managerï¼Œç‚º nginx ingress controller ç”¢ç”Ÿ certificates with ACME Issuer\u003c/p\u003e\n\u003ch1 id=\"ca-terminology\"\u003eCA Terminology\u003c/h1\u003e\n\u003cp\u003eå…ˆæŠŠå¯¦éš›åŸ·è¡Œ CA ç°½ç™¼çš„åè©å®šç¾©ä¸€ä¸‹ï¼Œä»¥å…è·Ÿ cert-manager çš„è³‡æºææ··\u003c/p\u003e","title":"Cert Manager How It Work"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Cert-manager Introduction Deploy cert-manager ç°¡ä»‹ cert-manager TLS certificate ç®¡ç†å¾ˆé‡è¦ï¼Œä½†åœ¨ kubernetes ä¸Šç®¡ç† TLS certificates å¾ˆéº»ç…©ã€‚\nä»¥å¾€æˆ‘å€‘ä½¿ç”¨ Let\u0026rsquo;s Encrypt æä¾›çš„å…è²»è‡ªå‹•åŒ–æ†‘è­‰é ’ç™¼ï¼Œæ­é… kube-lego ä¾†è‡ªå‹•è™•ç† certificate issuingï¼Œç„¶è€Œéš¨è‘— kube-lego å·²ä¸å†æ›´æ–°å¾Œï¼Œå®˜æ–¹å»ºè­°æ”¹ä½¿ç”¨ Cert-manager ä¾†é€²è¡Œ kubernetes ä¸Šçš„æ†‘è­‰è‡ªå‹•åŒ–ç®¡ç†ã€‚\ncert-manager æ˜¯ kubernetes åŸç”Ÿçš„æ†‘è­‰ç®¡ç† controllerã€‚æ˜¯çš„ä»–çš„æ ¸å¿ƒä¹Ÿæ˜¯ä¸€å€‹ controllerï¼Œé€é kubernetes object å®šç¾© desired stateï¼Œç›£æ§é›†ç¾¤ä¸Šçš„å¯¦éš›ç‹€æ…‹ï¼Œç„¶å¾Œæ ¹æ“š resource object ç”¢ç”Ÿæ†‘è­‰ã€‚cert-manager åšå¹¾ä»¶äº‹æƒ…\nåœ¨ kubernetes ä¸Š ä½¿ç”¨ CRD (Customized Resource Definition) ä¾†å®šç¾© certificate issuing çš„ desired state å‘ let\u0026rsquo;s encrypt å–å¾—å…¬é–‹çš„æ†‘è­‰ åœ¨ kubernetes ä¸Šè‡ªå‹•æª¢æŸ¥æ†‘è­‰çš„æœ‰æ•ˆæœŸé™ï¼Œä¸¦è‡ªå‹•åœ¨æœ‰æ•ˆæ™‚é™å…§ renew certificateã€‚ å®‰è£ å®˜æ–¹æ–‡ä»¶æœ‰æä¾› è©³ç´°æ­¥é©Ÿ å¯ä»¥ç›´æ¥ä½¿ç”¨ release çš„ yaml éƒ¨å±¬ï¼Œä¹Ÿå¯ä»¥é€é helmã€‚\nä½¿ç”¨ yaml éƒ¨å±¬ # Create a namespace to run cert-manager in kubectl create namespace cert-manager # Disable resource validation on the cert-manager namespace kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true é–‹ä¸€å€‹ç¨ç«‹çš„ namespace ä¾†ç®¡ç† cert-manager resources\nå–æ¶ˆ namespcae ä¸­çš„ kubernetes validating webhookã€‚ç”±æ–¼ cert-manager æœ¬èº«å°±æœƒä½¿ç”¨ ValidatingWebhookConfiguration ä¾†ç‚º cert-manager å®šç¾©çš„ Issuer, Certificate resource åš validatingã€‚ç„¶è€Œé€™æœƒé€ æˆ cert-manager èˆ‡ webhook çš„å¾ªç’°ä¾è³´ (circling dependency)\n# Install the CustomResourceDefinitions and cert-manager itself kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.10.1/cert-manager.yaml # Install the CustomResourceDefinitions and cert-manager itself kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.10.1/cert-manager.yaml é€™å€‹ yaml è£¡é¢é‚„æœ‰å¹¾å€‹å…ƒä»¶\nCluster Role-bindings CustomResourceDefinition certificaterequests.certmanager.k8s.io certificates.certmanager.k8s.io challenges.certmanager.k8s.io clusterissuers.certmanager.k8s.io issuers.certmanager.k8s.io orders.certmanager.k8s.io é€™äº›å…ƒä»¶çš„ç´°ç¯€ï¼Œç•™å¾…é‹ä½œåŸç†åˆ†ææ™‚å†è©³è§£ã€‚\nhelm deployment é€™é‚Šä¹Ÿé™„ä¸Šä½¿ç”¨ helm å®‰è£çš„æ­¥é©Ÿ\n#!/bin/bash # Install the CustomResourceDefinition resources separately kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.10/deploy/manifests/00-crds.yaml # Create the namespace for cert-manager kubectl create namespace cert-manager # Label the cert-manager namespace to disable resource validation kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true # Add the Jetstack Helm repository helm repo add jetstack https://charts.jetstack.io # Update your local Helm chart repository cache helm repo update # Install the cert-manager Helm chart helm install \\ --name cert-manager \\ --namespace cert-manager \\ --version v0.10.1 \\ jetstack/cert-managerNAMESPACE=cert-manager éƒ¨å±¬å®Œæª¢æŸ¥ä¸€ä¸‹\nkubectl get pods --namespace cert-manager NAME READY STATUS RESTARTS AGE cert-manager-5c6866597-zw7kh 1/1 Running 0 2m cert-manager-cainjector-577f6d9fd7-tr77l 1/1 Running 0 2m cert-manager-webhook-787858fcdb-nlzsq 1/1 Running 0 2m é€™é‚Šéƒ¨å±¬å®Œï¼Œæœƒç²å¾—å®Œæ•´çš„ cert-manager èˆ‡ cert-manager CRDï¼Œä½† certificate çš„ desired state object é‚„æ²’éƒ¨å±¬ã€‚ä¹Ÿå°±æ˜¯é—œæ–¼æˆ‘å€‘è¦å¦‚ä½• issue certificate çš„ç›¸é—œæè¿°ï¼Œéƒ½é‚„æ²’æœ‰ deployï¼Œ cert-manager è‡ªç„¶ä¸æœƒå·¥ä½œã€‚é—œæ–¼ issuing resources configurationï¼Œæˆ‘å€‘ä¸‹æ¬¡å†èŠã€‚\n","permalink":"https://chechia.net/posts/2019-10-10-cert-manager-deployment/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eCert-manager Introduction\u003c/li\u003e\n\u003cli\u003eDeploy cert-manager\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"ç°¡ä»‹-cert-manager\"\u003eç°¡ä»‹ cert-manager\u003c/h1\u003e\n\u003cp\u003eTLS certificate ç®¡ç†å¾ˆé‡è¦ï¼Œä½†åœ¨ kubernetes ä¸Šç®¡ç† TLS certificates å¾ˆéº»ç…©ã€‚\u003c/p\u003e","title":"Cert Manager Deployment on Kubernetes"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šè©²äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nNginx Ingress Controller ç°¡ä»‹ nginx \u0026amp; Ingress Controller éƒ¨å±¬ä¸¦è¨­å®š nginx ingress controller Nginx Introduction Nginx æ˜¯ä¸€æ¬¾é«˜æ•ˆèƒ½ã€è€ç”¨ã€ä¸”åŠŸèƒ½å¼·å¤§çš„ load balancer ä»¥åŠ web serverï¼Œä¹Ÿæ˜¯å¸‚å ç‡æœ€é«˜çš„ web server ä¹‹ä¸€ã€‚\né«˜æ•ˆèƒ½çš„ web serverï¼Œé å‹å‚³çµ± apache server çš„è³‡æºèˆ‡æ•ˆèƒ½ å¤§é‡çš„æ¨¡çµ„èˆ‡æ“´å……åŠŸèƒ½ æœ‰å……è¶³çš„å®‰å…¨æ€§åŠŸèƒ½èˆ‡è¨­å®š è¼•é‡ å®¹æ˜“æ°´å¹³æ“´å±• Ingress \u0026amp; Ingress Controller é€™é‚Šç°¡å–®è¬›ä¸€ä¸‹ kubernetes ingressã€‚ç•¶æˆ‘å€‘åœ¨ä½¿ç”¨ kubernetes æ™‚éœ€è¦å°‡å¤–éƒ¨æµé‡ route åˆ°é›†ç¾¤å…§éƒ¨ï¼Œé€™é‚Šä½¿ç”¨ Ingress é€™å€‹ api resourceï¼Œä¾†å®šç¾©å¤–éƒ¨åˆ°å…§éƒ¨çš„è¨­å®šï¼Œä¾‹å¦‚:\nservice é€£æ¥ load balance è¨­å®š SSL/TLS çµ‚ç«¯ è™›æ“¬ä¸»æ©Ÿè¨­å®š ä¸€å€‹ç°¡å–®çš„ ingress å¤§æ¦‚é•·é€™æ¨£\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: test-ingress annotations: nginx.ingress.kubernetes.io/rewrite-target: / spec: rules: - http: paths: - path: /testpath backend: serviceName: test servicePort: 80 é™¤äº†ä¸€èˆ¬çš„ k8s è³‡æºï¼Œnginx ä¸»è¦çš„è¨­å®šæœƒè½åœ¨ specï¼Œä»¥åŠä¾è³´åº•ä¸‹å¯¦ä½œä¸åŒï¼Œé¡å¤–è¨­å®šçš„ annotationã€‚\né€™é‚Šå¯ä»¥çœ‹åˆ° spec.rule å®šç¾©äº†å¤–éƒ¨ http æµé‡ï¼Œå¼•å°åˆ° backend service çš„è·¯å¾‘ã€‚\nannotations ä¸‹å·²ç¶“æ¨™è¨»çš„ nginx.ingress çš„ annotationï¼Œä¾†å¿«é€Ÿå¢åŠ é¡å¤–çš„è¨­å®šã€‚\nIngress \u0026amp; Ingress Controller é›–ç„¶å·²ç¶“æŒ‡å®š nginx çš„ annotationï¼Œä½†é€™é‚Šè¦æ³¨æ„ï¼Œingress resource æœ¬èº«æ˜¯ä¸æŒ‡å®šåº•å±¤çš„å¯¦ç¾ (ingress controller)ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œåº•ä¸‹æ˜¯ nginx ä¹Ÿå¥½ï¼Œtraefik ä¹Ÿè¡Œï¼Œåªè¦èƒ½å¤ å¯¦ç¾ ingress è£é ­è¨­å®šçš„ routing rules å°±å¯ä»¥ã€‚\nåªè¨­å®šå¥½ ingressï¼Œé›†ç¾¤ä¸Šæ˜¯ä¸æœƒæœ‰ä»»ä½•ä½œç”¨çš„ï¼Œé‚„éœ€è¦åœ¨é›†ç¾¤ä¸Šå®‰è£ ingress controller çš„å¯¦ä½œï¼Œå¯¦ä½œå®‰è£å®Œäº†ä»¥å¾Œï¼Œæœƒä¾æ“š ingress çš„è¨­å®šï¼Œåœ¨ controller è£é ­å¯¦ç¾ï¼Œä¸ç®¡æ˜¯ routingã€ssl/tls terminationã€load balancing ç­‰ç­‰åŠŸèƒ½ã€‚å¦‚åŒè¨±å¤š Kubernetes resource çš„è¨­è¨ˆç†å¿µä¸€æ¨£ï¼Œé€™é‚Šä¹Ÿå¾ˆå„ªé›…çš„ç”¨ ingress èˆ‡ ingress controllerï¼Œæ‹†åˆ†çš„éœ€æ±‚è¨­å®šèˆ‡å¯¦ä½œå¯¦ç¾å…©é‚Šçš„è·è²¬ã€‚\nä¾‹å¦‚ä»¥ nginx ingress controllerï¼Œå®‰è£å®Œå¾Œæœƒä¾æ“š ingress çš„è¨­å®šï¼Œåœ¨ nginx pod è£¡è¨­å®šå°æ‡‰çš„ routing rulesï¼Œå¦‚æœæœ‰ ssl/tls è¨­å®šï¼Œä¹Ÿä¸€ä½µè¼‰å…¥ã€‚\nKubernetes å®˜æ–¹æ–‡ä»¶æä¾›äº†è¨±å¤šä¸åŒçš„ controller å¯ä»¥ä¾ç…§éœ€æ±‚é¸æ“‡ã€‚\nä½†å¦‚æœä¸çŸ¥é“å¦‚ä½•é¸æ“‡ï¼Œå€‹äººæœƒæ¨è–¦ä½¿ç”¨ nginx ingress controllerï¼Œç©©å®šã€åŠŸèƒ½å¼·å¤§ã€è¨­å®šåˆä¸è‡³æ–¼å¤ªéè¤‡é›œï¼ŒåŸºæœ¬çš„è¨­å®šå°±èƒ½å¾ˆå¥½çš„æ”¯æ’æœå‹™ï¼Œä¸ç†Ÿæ‚‰çš„å¤§å¾·å€‘æ¯”è¼ƒä¸å®¹æ˜“è¢«é›·åˆ°ã€‚\nåº•ä¸‹æˆ‘å€‘å°±è¦ä¾†é–‹å§‹ä½¿ç”¨ nginx ingress controllerã€‚\nDeployment æˆ‘å€‘é€™é‚Šä½¿ç”¨çš„ ingress-nginx æ˜¯ kubernetes org å…§ç¶­è­·çš„å°ˆæ¡ˆï¼Œå°ˆæ¡ˆå…§å®¹ä¸»è¦æ˜¯å† k8s ä¸ŠåŸ·è¡Œ nginxï¼ŒæŠ½è±¡èˆ‡å¯¦ä½œçš„æ•´åˆï¼Œä¸¦é€é configmap ä¾†è¨­å®š nginxã€‚é‡å° nginx ingress kubernetes å®˜æ–¹æœ‰æä¾›éå¸¸è©³ç´°çš„èªªæ˜æ–‡ä»¶ ï¼Œå‰›æ¥è§¸ nginx çš„å¤§å¾·å¯ä»¥é€éé€™ä»½æ–‡ä»¶ï¼Œå¿«é€Ÿçš„æ“ä½œ nginx çš„è¨­å®šï¼Œè€Œä¸ç”¨ç›´æ¥å¯« nginx.conf çš„è¨­å®šæª”æ¡ˆã€‚\nrepo ç‰ˆæœ¬æ˜¯ nginx-0.26.1 Image ç‰ˆæœ¬æ˜¯ quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.26.1 Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼ŒNginx Ingress Controller Stable Chartï¼Œè®“å„ä½å¤§å¾·ç”¨æœ€ç°¡å–®çš„æ­¥é©Ÿï¼Œç²å¾—ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„ nginx ingress controllerã€‚\nèˆ‡å‰é¢å¹¾å€‹ helm chart ä¸€æ¨£ï¼Œæˆ‘å€‘å¯ä»¥å…ˆå–å¾— default values.yaml è¨­å®šæª”ï¼Œå†é€²è¡Œæ›´æ”¹ã€‚\n$ wget https://raw.githubusercontent.com/helm/charts/master/stable/nginx-ingress/values.yaml $ vim values.yaml å®‰è£æ™‚ä¹Ÿå¯ä»¥ä½¿ç”¨ \u0026ndash;set ä¾†è®Šæ›´å®‰è£ chart æ™‚çš„ parameters\n$ helm install stable/nginx-ingress \\ --set controller.metrics.enabled=true \\ -f values.yaml å®‰è£å®Œå¾Œï¼Œresource å¾ˆå¿«å°±èµ·ä¾†ã€‚\nkubectl get all --selector app=nginx-ingress NAME READY STATUS RESTARTS AGE pod/nginx-ingress-controller-7bbcbdcf7f-tx69n 1/1 Running 0 216d pod/nginx-ingress-default-backend-544cfb69fc-rnn6h 1/1 Running 0 216d NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/nginx-ingress-controller LoadBalancer 10.15.246.22 34.35.36.37 80:30782/TCP,443:31933/TCP 216d service/nginx-ingress-default-backend ClusterIP 10.15.243.19 \u0026lt;none\u0026gt; 80/TCP 216d NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-ingress-controller 1/1 1 1 216d deployment.apps/nginx-ingress-default-backend 1/1 1 1 216d NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-ingress-controller-7bbcbdcf7f 1 1 1 216d replicaset.apps/nginx-ingress-default-backend-544cfb69fc 1 1 1 216d kubectl get configmap -l app=nginx-ingress NAME DATA AGE nginx-ingress-controller 2 216d kubectl get ingress NAME HOSTS ADDRESS PORTS AGE ingress-nginx api.chechiachang.com 34.35.36.37 80, 443 216d å…©å€‹ Pods\nNginx ingress controller æ˜¯ä¸»è¦çš„ nginx podï¼Œè£¡é¢è·‘çš„æ˜¯ nginx Nginx default backend è·‘çš„æ˜¯ default backendï¼Œnginx çœ‹ä¸æ‡‚äº† route request éƒ½å¾€é€™é‚Šé€ã€‚ Service\nnginx-ingress-contrller æ˜¯æˆ‘å€‘åœ¨ GCP ä¸Šï¼Œåœ¨é›†ç¾¤å¤–éƒ¨çš„ GCP ä¸Šçš„å°å¤–æ¥å£ã€‚å¦‚æœåœ¨ä¸åŒå¹³å°ä¸Šï¼Œä¾æ“šé è¨­ service load balancer æœ‰ä¸åŒå¯¦ä½œã€‚ åœ¨ gcp ä¸Šï¼Œæœƒéœ€è¦æ™‚é–“ä¾†å•Ÿå‹• load balancerï¼Œç­‰ load balancer å•Ÿå‹•å®Œæˆï¼Œservice é€™é‚Šå°±å¯ä»¥å–å¾—å¤–éƒ¨çš„ ipï¼Œæ¥å— load balancer ä¾†çš„æµé‡ å¦å¤–ä¸€å€‹ service å°±æ˜¯ default backend çš„ service è¸©é›· ç¬¬ä¸€å€‹é›·é»æ˜¯ helm chart install å¸¶å…¥çš„ parametersï¼Œæœ‰äº› parameter æ˜¯ç›´æ¥å½±éŸ¿ deployment çš„è¨­å®šï¼Œå¦‚æœæ²’æ³¨æ„åˆ°ï¼Œå®‰è£å®Œå¾Œæ²’è¾¦æ³•é€é hot reload ä¾†è™•ç†ï¼Œåªèƒ½å¹¹æ‰é‡ä¾†ã€‚å»ºè­°æŠŠé€™ä»½è¡¨æ ¼éƒ½çœ‹éä¸€æ¬¡ï¼Œå†ä¾ç…§ç’°å¢ƒèˆ‡éœ€æ±‚è£œä¸Šã€‚\n$ helm install stable/nginx-ingress \\ --set controller.metrics.enabled=true \\ --set controller.service.externalTrafficPolicy=Local \\ -f values.yaml é€™é‚Šé–‹äº† prometheus metrics exporterï¼Œä»¥åŠ source IP preservationã€‚\nNginx Config å†å®‰è£å®Œå¾Œï¼Œå¤–éƒ¨çš„ load balancer å•Ÿç”¨å¾Œï¼Œå°±å¯ä»¥é€é GCP çš„ external ip é€£å…¥ nginxï¼Œnginx ä¾ç…§è¨­å®šçš„ rule å‘å¾Œç«¯æœå‹™åšé›†ç¾¤å…§çš„ load balancing èˆ‡ routingã€‚\nå¦‚æœåœ¨ä½¿ç”¨éç¨‹ä¸­ï¼Œæœ‰éœ€è¦åŸ·è¡Œæ›´æ”¹è¨­å®šï¼Œæˆ–æ˜¯ hot reload configï¼Œåœ¨ kubernetes ä¸Šè¦å¦‚ä½•åšå‘¢? æˆ‘å€‘ä¸‹å›åˆ†è§£ã€‚\n","permalink":"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šè©²äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"nginx-ingress-controller\"\u003eNginx Ingress Controller\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eç°¡ä»‹ nginx \u0026amp; Ingress Controller\u003c/li\u003e\n\u003cli\u003eéƒ¨å±¬ä¸¦è¨­å®š nginx ingress controller\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"nginx-introduction\"\u003eNginx Introduction\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://nginx.org/en/docs/\"\u003eNginx\u003c/a\u003e æ˜¯ä¸€æ¬¾é«˜æ•ˆèƒ½ã€è€ç”¨ã€ä¸”åŠŸèƒ½å¼·å¤§çš„ load balancer ä»¥åŠ web serverï¼Œä¹Ÿæ˜¯å¸‚å ç‡æœ€é«˜çš„ web server ä¹‹ä¸€ã€‚\u003c/p\u003e","title":"Kubernetes Nginx Ingress Controller"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \né€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\nNginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Nginx Ingress Controller é‹ä½œåŸç† è¨­å®š Nginx Ingress Controller é‹ä½œåŸç† æ˜¨å¤©è¬›å®Œ nginx ingress controller éƒ¨å±¬ï¼Œä»Šå¤©ä¾†è«‡è«‡ controller æ˜¯å¦‚ä½•é‹ä½œçš„ã€‚\nNginx ä½¿ç”¨ config file (nginx.conf) åšå…¨åŸŸè¨­å®šï¼Œç‚ºäº†è®“ nginx èƒ½éš¨ config file æ›´æ–°ï¼Œcontroller è¦åµæ¸¬ config file è®Šæ›´ï¼Œä¸¦ä¸” reload nginx é‡å° upstream (å¾Œç«¯ app çš„ endpoint) è®Šæ›´ï¼Œä½¿ç”¨ lua-nginx-module ä¾†æ›´æ–°ã€‚å› ç‚º kubernetes ä¸Šï¼Œservice å¾Œçš„æœå‹™å¸¸å¸¸æœƒå‹•æ…‹çš„è®Šæ›´ï¼Œscalingï¼Œä½† endpint ip list åˆéœ€è¦æ›´æ–°åˆ° nginxï¼Œæ‰€ä»¥ä½¿ç”¨ lua é¡å¤–è™•ç† åœ¨ kubernetes ä¸Šè¦å¦‚ä½•åšåˆ°ä¸Šè¿°å…©ä»¶äº‹å‘¢?\nä¸€èˆ¬ controller éƒ½ä½¿ç”¨åŒæ­¥ loop ä¾†æª¢æŸ¥ current state æ˜¯å¦èˆ‡ desired state desired state ä½¿ç”¨ k8s object æè¿°ï¼Œä¾‹å¦‚ ingress, services, configmap ç­‰ç­‰ object Nginx ingress controller é€™é‚Šä½¿ç”¨çš„æ˜¯ client-go ä¸­çš„ Kubernetes Informer çš„ SharedInformerï¼Œå¯ä»¥æ ¹æ“š object çš„æ›´æ–°åŸ·è¡Œ callback ç”±æ–¼ç„¡æ³•æª¢æŸ¥æ¯ä¸€æ¬¡çš„ object æ›´å‹•ï¼Œæ˜¯å¦å° config ç”¢ç”Ÿå½±éŸ¿ï¼Œé€™é‚Šç›´æ¥æ¯æ¬¡æ›´å‹•éƒ½ç”¢ç”Ÿå…¨æ–°çš„ model å¦‚æœæ–°ç”¢ç”Ÿçš„ model èˆ‡ç¾æœ‰ç›¸åŒï¼Œå°±è·³é reload å¦‚æœ model åªå½±éŸ¿ endpointï¼Œä½¿ç”¨ nginx å…§éƒ¨çš„ lua handler ç”¢ç”Ÿæ–°çš„ endpoint listï¼Œä¾†é¿å…å› ç‚º upstream æœå‹™è®Šæ›´é€ æˆçš„é »ç¹ reload å¦‚æœæ–° Model å½±éŸ¿ä¸åª endpointï¼Œå‰‡å–ä»£ç¾æœ‰ modelï¼Œç„¶å¾Œè§¸ç™¼ reload å…·é«”æœƒè§¸ç™¼ reload çš„äº‹ä»¶ï¼Œè«‹è¦‹å®˜æ–¹æ–‡ä»¶\né™¤äº†ç›£æ¸¬ objectsï¼Œbuild modelï¼Œè§¸ç™¼ reloadï¼Œä¹‹å‰ controller é‚„æœƒå°‡ ingress é€åˆ° kubernetes validating admission webhook server åšé©—è­‰ï¼Œé¿å…æè¿° desired state çš„ ingress æœ‰ syntax errorï¼Œå°è‡´æ•´å€‹ controller çˆ†ç‚¸ã€‚\nConfiguration è¦é€é controller æ›´æ”¹ nginx è¨­å®šï¼Œæœ‰ä»¥ä¸‹ä¸‰ç¨®æ–¹å¼\næ›´æ”¹ configmapï¼Œå°å…¨åŸŸçš„ controller è¨­å®š æ›´æ”¹ ingress ä¸Šçš„ annotationï¼Œé€™äº› annotation é‡å°ç¨ç«‹ ingress ç”Ÿæ•ˆ æœ‰æ›´æ·±å…¥çš„å®¢è£½åŒ–ï¼Œæ˜¯ä¸Šè¿°å…©è€…é”ä¸åˆ°æˆ–å°šæœªå¯¦ä½œï¼Œå¯ä»¥ä½¿ç”¨ Custom Template ä¾†åšåˆ°ï¼ŒæŠŠ nginx.tmpl mount é€² controller Configmap ç”±æ–¼æŠŠå…¨åŸŸè¨­å®šæ”¾åˆ° configmap ä¸Šï¼Œnginx ingress controller éå¸¸å¥½èª¿åº¦èˆ‡æ“´å±•ï¼Œcontroller å®˜æ–¹èªªæ˜æ–‡ä»¶ é™¤äº†åˆ—å‡ºç›®å‰å·²ç¶“æ”¯æ´çš„è¨­å®šå¤–ï¼Œä¹Ÿç›´æ¥é™„ä¸Š nginx å®˜æ–¹çš„æ–‡ä»¶èªªæ˜é€£çµï¼Œè®“ä½¿ç”¨è€…æŸ¥è©¢æ™‚æ–¹ä¾¿æ¯”å°ã€‚\nç•¶éœ€è¦æ›´æ”¹éœ€æ±‚ï¼Œå¯ä»¥ google nginx çš„é—œéµå­—ï¼Œæ‰¾åˆ° nginx ä¸Šè¨­å®šçš„åŠŸèƒ½é¸é …å¾Œï¼Œä¾† controller çš„æ–‡ä»¶ï¼Œæ‰¾çœ‹çœ‹ç›®å‰æ˜¯å¦å·²ç¶“æ”¯æ´ã€‚æœ‰æ™‚å€™æœ‰éœ€è¦å°ç…§ nginx å®˜æ–¹æ–‡ä»¶ï¼Œä¾†æ­£ç¢ºè¨­å®š controllerã€‚\nAnnotation æœ‰å¾ˆå¤š Nginx çš„è¨­å®šæ˜¯æ ¹æ“š ingress ä¸åŒè€Œæœ‰èª¿æ•´ï¼Œä¾‹å¦‚é‡å°é€™å€‹ ingress åšç™½åå–®ï¼Œè¨­å®š sessionï¼Œè¨­å®š ssl ç­‰ç­‰ï¼Œé€™äº›é‡å°ç‰¹å®š ingress æ‰€åšçš„è¨­å®šï¼Œå¯ä»¥ç›´æ¥å¯«åœ¨ ingress annotation è£¡é¢ã€‚\nä¾‹å¦‚ä¸‹é¢é€™å€‹ Ingress\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: ingress-nginx annotations: kubernetes.io/ingress.class: nginx kubernetes.io/tls-acme: 'true' certmanager.k8s.io/cluster-issuer: letsencrypt-prod kubernetes.io/ingress.allow-http: \u0026quot;true\u0026quot; ingress.kubernetes.io/force-ssl-redirect: \u0026quot;true\u0026quot; nginx.ingress.kubernetes.io/whitelist-source-range: \u0026quot;34.35.36.37\u0026quot; nginx.ingress.kubernetes.io/proxy-body-size: \u0026quot;20m\u0026quot; ingress.kubernetes.io/proxy-body-size: \u0026quot;20m\u0026quot; # https://github.com/Shopify/ingress/blob/master/docs/user-guide/nginx-configuration/annotations.md#custom-nginx-upstream-hashing nginx.ingress.kubernetes.io/load-balance: \u0026quot;ip_hash\u0026quot; # https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/ nginx.org/server-snippets: gzip on; nginx.ingress.kubernetes.io/affinity: \u0026quot;cookie\u0026quot; nginx.ingress.kubernetes.io/session-cookie-name: \u0026quot;route\u0026quot; nginx.ingress.kubernetes.io/session-cookie-hash: \u0026quot;sha1\u0026quot; nginx.ingress.kubernetes.io/session-cookie-expires: \u0026quot;3600\u0026quot; nginx.ingress.kubernetes.io/session-cookie-max-age: \u0026quot;3600\u0026quot; nginx.ingress.kubernetes.io whitelist-source-range: åªå…è¨±ç™½åå–® ip load-balance: \u0026ldquo;ip_hash\u0026rdquo;: æ›´æ”¹é è¨­ round_robin çš„ load balanceï¼Œç‚ºäº†åš session cookie affinity: \u0026ldquo;cookie\u0026rdquo;: è¨­å®š upstream çš„ session affinity session-cookie-name: \u0026ldquo;route\u0026rdquo; session-cookie-hash: \u0026ldquo;sha1\u0026rdquo; session-cookie-expires: \u0026ldquo;3600\u0026rdquo; session-cookie-max-age: \u0026ldquo;3600\u0026rdquo; å¦‚æœå¾Œç«¯ server æœ‰ session éœ€æ±‚ï¼Œå¸Œæœ›ç›¸åŒ source ip ä¾†çš„ request èƒ½æŒçºŒåˆ°ç›¸åŒçš„ endpointã€‚æ‰åšäº†ä»¥ä¸Šè¨­å®šã€‚\nhelm configuration helm çš„ configuration ä¹Ÿæ˜¯é‡è¦çš„è¨­å®šï¼Œé€™è£¡åœ¨å®‰è£æ™‚æ±ºå®šäº† nginx ingress controller çš„ topologyã€replicasã€resourceã€k8s runtime è¨­å®šå¦‚ healthz \u0026amp; readinessã€å…¶å¯¦éƒ½æœƒå½±éŸ¿ nginx å…·é«”çš„è¨­å®šã€‚é€™éƒ¨åˆ†å°±æœƒæœ‰å¾ˆå¤šè€ƒé‡ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘å†ä¾†åˆ†äº«ã€‚\n","permalink":"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cp\u003eé€™é‚Šæ”¹äº†ä¸€äº›å¤§ç¶±ï¼ŒåŸæœ¬çš„å…§å®¹é‚„æœ‰ä¸€äº› kubernetes çš„è¨­å®šï¼Œä»¥åŠ GCP ç›¸é—œæœå‹™çš„ä»‹ç´¹ã€‚ä½†æ—¢ç„¶æˆ‘å€‘çš„ä¸»é¡Œæ˜¯æŠŠæ±è¥¿æ¬ä¸Š k8s çš„è¸©é›·æ—…ç¨‹ï¼Œé‚£æˆ‘å€‘å°±ç¹¼çºŒæ¬ï¼Œç¹¼çºŒè¸©ã€‚å‰©ä¸‹çš„æ™‚é–“å¤§æ¦‚æœƒæœ‰å››å€‹é¡Œç›®ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-controller/\"\u003eDeploy Nginx Ingress Controller\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-08-kubernetes-nginx-ingress-config/\"\u003eConfigure Nginx Ingress\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCert-manager (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-10-cert-manager-deployment/\"\u003eDeploy cert-manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-11-cert-manager-how-it-work/\"\u003eHow cert-manager work\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-12-cert-manager-complete-workflow/\"\u003eCert-manager complete workflow\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKubernetes CRD \u0026amp; Operator-sdk (3)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eIntroduction about custom resource\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-13-kubernetes-custom-resources-basic/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/\"\u003eDeployment \u0026amp; Usage\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eNginx Ingress Controller é‹ä½œåŸç†\u003c/li\u003e\n\u003cli\u003eè¨­å®š Nginx Ingress Controller\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"é‹ä½œåŸç†\"\u003eé‹ä½œåŸç†\u003c/h1\u003e\n\u003cp\u003eæ˜¨å¤©è¬›å®Œ nginx ingress controller éƒ¨å±¬ï¼Œä»Šå¤©ä¾†è«‡è«‡ controller æ˜¯å¦‚ä½•é‹ä½œçš„ã€‚\u003c/p\u003e","title":"Kubernetes Nginx Ingress Controller Config"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nå¦‚æœè¦é€é prometheus ä¾†ç›£æ§é›†ç¾¤çš„é‹è¡Œç‹€æ³ï¼Œæœ‰å…©å€‹ exporter æ˜¯å¿…è£çš„ï¼Œä¸€å€‹æ˜¯æŠŠ node ç‹€æ…‹ export å‡ºä¾†çš„ node exporterï¼Œä¸€å€‹æ˜¯æŠŠ kubernetes é›†ç¾¤ç‹€æ…‹ export å‡ºä¾†çš„ kube state metrics exporterã€‚\nNode Exporter ç°¡ä»‹ kube metrics exporter å®‰è£èˆ‡è¨­å®š Node Exporter Node Exporter æ˜¯ prometheus å®˜æ–¹ç¶­è­·çš„ä¸€å€‹å­é …ç›®ï¼Œä¸»è¦åœ¨æŠŠé¡ unix ç¡¬é«” kernel çš„ metrics é€å‡ºä¾†ã€‚å®˜æ–¹ä¹Ÿæ”¯æ´ windows node èˆ‡ nvidia gpu metricsï¼Œå¯ä»¥èªªæ˜¯åŠŸèƒ½å¼·å¤§ã€‚\nç‚ºäº†èƒ½å¤ ç›£æ¸¬ kubernetes node çš„åŸºç¤è¨­æ–½ç‹€æ…‹ï¼Œé€šå¸¸éƒ½æœƒä½¿ç”¨ node exporterã€‚\nnode exporter å®‰è£ï¼Œæˆ‘å€‘åœ¨å®‰è£ prometheus helm chart æ™‚å°±ä¸€ä¸¦å®‰è£äº†ã€‚é€™é‚Šçœ‹ä¸€ä¸‹è¨­å®šèˆ‡é‹è¡Œã€‚\nCollectors Node exporter æŠŠä¸åŒä½ç½®æ”¶é›†åˆ°çš„ä¸åŒé¡å‹çš„ metrics ï¼Œåšæˆå„è‡ªç¨ç«‹çš„ colletorï¼Œä½¿ç”¨è€…å¯ä»¥æ ¹æ“šæ±‚éœ€æ±‚ä¾†å•Ÿç”¨æˆ–æ˜¯ä¸å•Ÿç”¨ collectorï¼Œå®Œæ•´çš„ collector ç›®éŒ„ åœ¨é€™é‚Šã€‚\nå¦‚æœæœ‰çœ‹æˆ‘å€‘ç¬¬ä¸€éƒ¨ä»½çš„ ELK partï¼Œæ‡‰è©²æœƒè¦ºå¾—é€™è£¡çš„è¨­å®šï¼Œè·Ÿ metricbeat éå¸¸åƒï¼ŒåŸºæœ¬ä¸Šé€™å…©è€…åšçš„äº‹æƒ…æ˜¯å¤§åŒå°ç•°çš„ï¼Œæ”¶é›† metrics ä¾†æºéƒ½æ˜¯åŒæ¨£çš„é¡ unix ç³»çµ±ï¼Œåªæ˜¯å¾€å¾Œé€çš„ç›®æ¨™ä¸ä¸€æ¨£ (é›–ç„¶ç¾åœ¨å…©è€…éƒ½å¯ä»¥å…¼å®¹æ··æ­äº†)ã€‚å¦‚æœæœ‰æ¥è§¸éå…¶ä»–å¹³å°çš„ metrics collectorï¼Œä¹Ÿæœƒç™¼ç¾å…¶å¯¦å¤§å®¶åšçš„éƒ½å·®ä¸å¤šã€‚\nTextfile Collector Prometheus é™¤äº†æœ‰ scrape æ©Ÿåˆ¶ï¼Œè®“ prometheus å» exporter æ’ˆè³‡æ–™å¤–ï¼Œé‚„æœ‰å¦å¤–ä¸€å€‹æ©Ÿåˆ¶ï¼Œå«åš Pushgatewayï¼Œé€™å€‹æˆ‘å€‘åœ¨éƒ¨å±¬ prometheus æ™‚ä¹Ÿéƒ¨å±¬äº†ä¸€å€‹ã€‚é€™é‚Šç°¡å–®èªªæ˜ä¸€ä¸‹ã€‚\nç¶“å¸¸æ€§åŸ·è¡Œçš„æœå‹™(redis, kafka,\u0026hellip;)æœƒä¸€ç›´é‹è¡Œï¼Œprometheus é€éé€™äº›æœå‹™çš„ metrics å–å¾— runtime metricsï¼Œä½œç‚ºç›£æ§è³‡æ–™ã€‚å¯æ˜¯æœ‰ä¸€äº› job æ˜¯æš«æ™‚æ€§çš„ä»»å‹™ï¼Œä¾‹å¦‚æœä¸€å€‹ batch jobï¼Œé€™äº›æœå‹™ä¸æœƒæœ‰ä¸€ç›´é‹è¡Œçš„ runtime metricsï¼Œä¹Ÿä¸æœƒæœ‰ exporterã€‚ä½†é€™æ™‚åˆå¸Œæœ›ç›£æ§é€™äº› job çš„ç‹€æ…‹ï¼Œå°±å¯ä»¥ä½¿ç”¨ Pushgatewayã€‚\nPushgateway çš„ä½œç”¨æ©Ÿåˆ¶ï¼Œå°±æ˜¯æŒ‡å®šæ”¶é›†çš„ç›®æ¨™è³‡æ–™å¤¾ï¼Œéœ€è¦ç›£æ¸¬çš„ batch jobï¼Œåªè¦æŠŠå¸Œæœ›ç›£æ¸¬çš„è³‡æ–™ï¼Œå¯«åˆ°è©²è³‡æ–™å¤¾ã€‚Pushgateway æœƒä¾æ“šå¯«å…¥çš„è³‡æ–™ï¼Œè½‰æˆ time series metricsï¼Œä¸¦ä¸” export å‡ºä¾†ã€‚\né€™ç¨®å» tail æŒ‡å®šç›®éŒ„æª”æ¡ˆï¼Œç„¶å¾ŒæŠŠ metrics å¾Œé€çš„æ©Ÿåˆ¶ï¼Œæ˜¯å¦è·Ÿ filebeat æœ‰ä¸€é»é¡ä¼¼? åªæ˜¯ filebeat ä¸€èˆ¬å–å¾—è³‡æ–™å¾Œï¼Œæœƒä¸»å‹•æ¨é€åˆ° ELK ä¸Šï¼Œprometheus pushgateway æœƒæš´éœ²å‡º metrics å¾Œï¼Œè®“ prometheus server ä¾† scrapeã€‚\nPushgateway ä¹Ÿæœƒåœ¨æ”¶é›†è³‡æ–™æ™‚æ‰“ä¸Šéœ€è¦çš„ labelï¼Œæ–¹é¢å¾Œæ®µè™•ç†è³‡æ–™ã€‚\nKubernetes State Metrics (Exporter) Node Exporter å°‡ kubernetes é›†ç¾¤åº•ä¸‹çš„ Node çš„ç¡¬é«”ç‹€æ…‹ï¼Œä¾‹å¦‚ cpu, memory, storage,\u0026hellip; expose å‡ºä¾†ï¼Œç„¶è€Œæˆ‘å€‘åœ¨ç¶­é‹ kubernetes é‚„éœ€è¦å¾ api server ç²å¾—é›†ç¾¤å…§éƒ¨çš„è³‡æ–™ï¼Œä¾‹å¦‚èªª pod state, container state, endpoints, service, \u0026hellip;ç­‰ï¼Œé€™é‚Šå¯ä»¥ä½¿ç”¨ kube-state-metrics ä¾†è™•ç†ã€‚\nkube-state-metrics æ˜¯ kubernetes å®˜æ–¹ç¶­è­·çš„å°ˆæ¡ˆï¼Œåšçš„äº‹æƒ…å°±æ˜¯å‘ api server è©¢å• kubernetes çš„ stateï¼Œä¾‹å¦‚ pod state, deployment stateï¼Œç„¶å¾Œè·Ÿ prometheus exporter ä¸€ï¼Œé–‹æ”¾ä¸€å€‹ http endpointï¼Œè®“éœ€è¦çš„æœå‹™ä¾† scrape metricsã€‚\nå·¥ä½œé›²è£¡ä¹Ÿå¾ˆå–®ç´”ï¼Œkubernetes api server å¯ä»¥æŸ¥è©¢ pod ç•¶ä¸‹çš„ç‹€æ…‹ï¼Œkube-state-metrics å‰‡æœƒæŠŠç•¶ä¸‹çš„ç‹€æ…‹ä¾ç…§æ™‚é–“åºï¼Œåšæˆ time series çš„ metricsï¼Œä¾‹å¦‚é€™å€‹ pod ä»€éº¼æ™‚å€™æ˜¯æ´»è‘—ï¼Œä»€éº¼æ™‚å€™å› ç‚ºæ•…éšœè€Œ errorã€‚\nkube-state-metrics é è¨­çš„è¼¸å‡ºæ ¼å¼æ˜¯ plaintextï¼Œç›´æ¥ç¬¦åˆ Prometheus client endpoint çš„æ ¼å¼\nDeployment å¦‚æœä¾ç…§ç¬¬ä¸€ç¯‡å®‰è£ prometheus helm çš„æ­¥é©Ÿï¼Œç¾åœ¨æ‡‰è©²å·²ç¶“å®‰è£å®Œ kube-state-metrics äº†ã€‚å¦‚æœæ²’æœ‰å®‰è£ï¼Œä¹Ÿå¯ä»¥ä¾ç…§å®˜æ–¹èªªæ˜çš„åŸºæœ¬ç¯„ä¾‹å®‰è£ã€‚\ngit clone git@github.com:kubernetes/kube-state-metrics.git cd kube-state-metrics kubectl apply -f examples/standard/*.yaml å®‰è£å®Œå¯ä»¥çœ‹åˆ°\n$ kubectl get pods --selector 'app=prometheus,component=kube-state-metrics' NAME READY STATUS RESTARTS AGE prometheus-kube-state-metrics-85f6d75f8b-7vlkp 1/1 Running 0 201d $ kubectl get svc --selector 'app=prometheus,component=kube-state-metrics' NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE prometheus-kube-state-metrics ClusterIP None \u0026lt;none\u0026gt; 80/TCP 201d æˆ‘å€‘å¯ä»¥é€é service æ‰“åˆ° pod çš„ /metrics ä¾†å–å¾— metricsã€‚\nkubectl exec -it busybox sh curl prometheus-kube-state-metrics:8080 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Kube Metrics Server\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Kube Metrics\u0026lt;/h1\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href='/metrics'\u0026gt;metrics\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href='/healthz'\u0026gt;healthz\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; curl prometheus-kube-state-metrics:8081 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Kube-State-Metrics Metrics Server\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Kube-State-Metrics Metrics\u0026lt;/h1\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt; \u0026lt;a href='/metrics'\u0026gt;metrics\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; é€™é‚Šæœ‰å…©å¥— metricsï¼Œä¸€å€‹æ˜¯ kube-state-metrics è‡ªå·±è‡ªæˆ‘ç›£æ¸¬çš„ metricsï¼Œåœ¨ 8081ï¼Œå¦å¤–ä¸€å€‹æ‰æ˜¯ kube metricsï¼Œåœ¨ 8080ï¼Œå…©å€‹éƒ½è¦æ”¶ï¼Œè¨˜å¾—ä¸è¦æ”¶éŒ¯äº†ã€‚\n$ curl prometheus-kube-state-metrics:8080/metrics æ‰“ä¸‹å»å°±å¯ä»¥çœ‹åˆ°è¶…å¤š metrics ã€‚ Metrics çš„æ¸…å–®èˆ‡èªªæ˜æ–‡ä»¶ï¼Œæœ‰ç”¨åˆ°çš„ metrics ä½¿ç”¨å‰éƒ½å¯ä»¥ä¾†æŸ¥ä¸€ä¸‹å®šç¾©è§£é‡‹ã€‚\nç†è«–ä¸Šä¸ç”¨æ¯å€‹ metrics éƒ½ expose å‡ºä¾†ï¼Œæœ‰éœ€è¦å¯ä»¥æŠŠä¸æœƒç”¨åˆ°çš„ metrics é—œä¸€é—œï¼Œå¯ä»¥ç¯€çœ kube-state-metrics çš„ cpu æ¶ˆè€—ã€‚\nResource Recommendation kube-state-metrics å¾ˆè²¼å¿ƒçš„é‚„é™„ä¸Šå»ºè­°çš„è³‡æºåˆ†é…\nAs a general rule, you should allocate 200MiB memory 0.1 cores For clusters of more than 100 nodes, allocate at least 2MiB memory per node 0.001 cores per node Scaling kube-state-metrics é‚„æœ‰æä¾› horizontal scaling çš„è§£æ±ºæ–¹æ¡ˆï¼Œå¦‚æœä½ çš„é›†ç¾¤å¾ˆå¤§ï¼Œnode æ•¸é‡å·²ç¶“è®“ kube-state-metrics ç„¡æ³•è² è·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ sharding çš„æ©Ÿåˆ¶ï¼ŒæŠŠ metrics çš„å·¥ä½œæ•£å¸ƒåˆ°å¤šå€‹ kube-state-metricsï¼Œå†è®“ prometheus å»æ”¶é›†çµ±æ•´ã€‚é€™éƒ¨åˆ†æˆ‘è¦ºå¾—å¾ˆæœ‰è¶£ï¼Œä½†é‚„æ²’å¯¦ä½œéï¼Œæˆ‘æŠŠæ–‡ä»¶ æ”¾åœ¨é€™é‚Šï¼Œæœ‰ç·£å¤§å¾·æœ‰æ™‚åšéè«‹ä¾†è¨è«–åˆ†äº«ã€‚\nDashboard metrics æŠ“å‡ºä¾†ï¼Œç•¶ç„¶è¦é–‹ä¸€ä¸‹ dashboardï¼Œé€™é‚Šä½¿ç”¨çš„æ˜¯é€™å€‹kubernetes clusterï¼Œæ”¯æ´\nnode exporter kube state metrics nginx ingress controller ä¸‰å€‹é¡˜æœ›ä¸€æ¬¡æ»¿è¶³~\nå°çµ è·‘ kubernetes å‹™å¿…ä½¿ç”¨é€™å…©å€‹ exporter kube-state-metrics æ•´ç†å¾—å¾ˆèˆ’æœï¼Œæœ‰æ™‚é–“å¯ä»¥å¤šçœ‹çœ‹é€™å€‹å°ˆæ¡ˆ ","permalink":"https://chechia.net/posts/2019-10-07-prometheus-kube-state-metrics-exporter/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus / Grafana (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deployment-on-kubernetes/\"\u003eGKE ä¸Šè‡ªæ¶ Prometheus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deploy-grafana/\"\u003eGKE ä¸Šè‡ªæ¶ Grafana\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-scrape/\"\u003escrape config \u0026amp; exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-06-prometheus-exporter-library-redis-exporter/\"\u003eDive into Redis Exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-07-prometheus-kube-state-metrics-exporter/\"\u003eè¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eå¦‚æœè¦é€é prometheus ä¾†ç›£æ§é›†ç¾¤çš„é‹è¡Œç‹€æ³ï¼Œæœ‰å…©å€‹ exporter æ˜¯å¿…è£çš„ï¼Œä¸€å€‹æ˜¯æŠŠ node ç‹€æ…‹ export å‡ºä¾†çš„ node exporterï¼Œä¸€å€‹æ˜¯æŠŠ kubernetes é›†ç¾¤ç‹€æ…‹ export å‡ºä¾†çš„ kube state metrics exporterã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNode Exporter ç°¡ä»‹\u003c/li\u003e\n\u003cli\u003ekube metrics exporter å®‰è£èˆ‡è¨­å®š\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"node-exporter\"\u003eNode Exporter\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/prometheus/node_exporter\"\u003eNode Exporter\u003c/a\u003e æ˜¯ prometheus å®˜æ–¹ç¶­è­·çš„ä¸€å€‹å­é …ç›®ï¼Œä¸»è¦åœ¨æŠŠé¡ unix ç¡¬é«” kernel çš„ metrics é€å‡ºä¾†ã€‚å®˜æ–¹ä¹Ÿæ”¯æ´ windows node èˆ‡ nvidia gpu metricsï¼Œå¯ä»¥èªªæ˜¯åŠŸèƒ½å¼·å¤§ã€‚\u003c/p\u003e","title":"Prometheus \u0026 Kubernetes State Metrics Exporter"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Exporter å·¥ä½œåŸç†ç°¡ä»‹ Prometheus exporter library Exporter workflow ä¸Šæ¬¡è¬›åˆ° exporter å¯ä»¥å¾æœå‹™ç«¯æŠŠé‹è¡Œè³‡æ–™æŠ½å‡ºä¾†ï¼Œä¸¦é–‹æˆ http endpointï¼Œè®“ prometheus ä¾† scrape metricsã€‚é‚£ exporter æœ¬èº«æ˜¯å¦‚ä½•å–å¾—æœå‹™å…§éƒ¨çš„ metrics å‘¢? æˆ‘å€‘ä»Šå¤©å°±ç¨å¾®çœ‹ä¸€ä¸‹ã€‚\nRedis Exporter æˆ‘å€‘ä»Šå¤©ä»¥ Redis Exporter ç‚ºä¾‹ï¼Œç ”ç©¶ä¸€ä¸‹å¤–éƒ¨çš„ exporter æ˜¯å¦‚ä½•å–å¾— redis å…§éƒ¨çš„ metrcsã€‚\nRedis exporter æ˜¯ç”¨ golang å¯«çš„ä¸€å€‹å°ç¨‹å¼ï¼Œç¸½å…±ç®—ç®—æ‰ 1000 è¡Œï¼Œè€Œä¸”å¾ˆå¤šéƒ½æ˜¯å° redis å…§éƒ¨ metrics çš„æ¸…å–®ï¼Œä»¥åŠè½‰åŒ–æˆ prometheus metrics çš„ tool functionsï¼Œä¸»è¦çš„é‚è¼¯éå¸¸ç°¡å–®ã€‚æˆ‘å€‘ç°¡å–®çœ‹ä¸€ä¸‹æºç¢¼ã€‚\nCollect æ˜¯ä¸»è¦çš„æ”¶é›†é‚è¼¯ï¼Œå°±æ˜¯åŸ·è¡Œ scrapeRedisHost(ch) ï¼Œç„¶å¾ŒæŠŠæ”¶é›†åˆ°çš„è³‡è¨Šï¼Œä½¿ç”¨ Prometheus Go Client Library çš„å·¥å…·å°‡è³‡æ–™è¨»å†Šæˆ prometheus metrics\nfunc (e *Exporter) Collect(ch chan\u0026lt;- prometheus.Metric) { e.Lock() defer e.Unlock() e.totalScrapes.Inc() if e.redisAddr != \u0026quot;\u0026quot; { start := time.Now().UnixNano() var up float64 = 1 // å¾ host scrape è³‡æ–™ï¼Œç„¶å¾Œå¡é€² channel streaming å‡ºä¾†ã€‚ if err := e.scrapeRedisHost(ch); err != nil { up = 0 e.registerConstMetricGauge(ch, \u0026quot;exporter_last_scrape_error\u0026quot;, 1.0, fmt.Sprintf(\u0026quot;%s\u0026quot;, err)) } else { e.registerConstMetricGauge(ch, \u0026quot;exporter_last_scrape_error\u0026quot;, 0, \u0026quot;\u0026quot;) } e.registerConstMetricGauge(ch, \u0026quot;up\u0026quot;, up) e.registerConstMetricGauge(ch, \u0026quot;exporter_last_scrape_duration_seconds\u0026quot;, float64(time.Now().UnixNano()-start)/1000000000) } ch \u0026lt;- e.totalScrapes ch \u0026lt;- e.scrapeDuration ch \u0026lt;- e.targetScrapeRequestErrors } scrapeRedisHost å…§éƒ¨çš„ä¸»è¦é‚è¼¯ï¼Œåˆé›†ä¸­åœ¨åŸ·è¡Œ Info\n// åŸ·è¡Œ info infoAll, err := redis.String(doRedisCmd(c, \u0026quot;INFO\u0026quot;, \u0026quot;ALL\u0026quot;)) if err != nil { infoAll, err = redis.String(doRedisCmd(c, \u0026quot;INFO\u0026quot;)) if err != nil { log.Errorf(\u0026quot;Redis INFO err: %s\u0026quot;, err) return err } } ä¹Ÿå°±æ˜¯èªªç•¶æˆ‘å€‘åœ¨ redis-cli é€£å…¥ redis æ™‚ï¼Œå¯ä»¥åŸ·è¡Œ Info commandï¼Œå–å¾— redis å…§éƒ¨çš„è³‡è¨Šï¼ŒåŒ…å«ç¯€é»è¨­åº—èˆ‡ç‹€æ…‹ï¼Œé›†ç¾¤è¨­å®šï¼Œè³‡æ–™çš„çµ±è¨ˆæ•¸æ“šç­‰ç­‰ã€‚ç„¶å¾Œ exporter é€™é‚Šç¶­è­·æŒçºŒå»å‘ redis æ›´æ–° info ï¼Œä¸¦ä¸”æŠŠ info data è½‰åŒ–æˆ time series çš„ metrcsï¼Œå†é€é Prometheus Client promhttp æä¾›çš„ http endpoint libraryï¼Œè®Šæˆ http endpointã€‚\né¦–å…ˆçœ‹ä¸€ä¸‹ redis info command çš„æ–‡ä»¶ï¼Œé€™é‚Šæœ‰èªªæ˜ info çš„ option ï¼Œä»¥åŠ option å„è‡ªæä¾›çš„è³‡æ–™ï¼ŒåŒ…æ‹¬ server ç‹€æ…‹ï¼Œè³€æˆ¶ç«¯é€£ç·šç‹€æ³ï¼Œç³»çµ±è³‡æºï¼Œè¤‡æœ¬ç‹€æ…‹ç­‰ç­‰ã€‚æˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªå·±é€é info å–å¾—è³‡æ–™ã€‚\n$ kubectl get po | grep redis redis-2-redis-ha-server-0 3/3 Running 0 11d redis-2-redis-ha-server-1 3/3 Running 0 11d redis-2-redis-ha-server-2 3/3 Running 0 11d $ kubectl exec -it redis-2-redis-ha-server-0 sh $ redis-cli -h haproxy-service -a REDIS_PASSWORD $ haproxy-service:6379\u0026gt; $ haproxy-service:6379\u0026gt; info server # Server redis_version:5.0.5 redis_git_sha1:00000000 redis_git_dirty:0 redis_build_id:4d072dc1c62d5672 redis_mode:standalone os:Linux 4.14.127+ x86_64 arch_bits:64 multiplexing_api:epoll atomicvar_api:atomic-builtin gcc_version:8.3.0 process_id:1 run_id:63a97460b7c3745577931dad406df9609c4e2464 tcp_port:6379 uptime_in_seconds:976082 uptime_in_days:11 ... $ haproxy-service:6379\u0026gt; info clients # Clients connected_clients:100 client_recent_max_input_buffer:2 client_recent_max_output_buffer:0 blocked_clients:1 Redis exporter æ”¶é›†é€™äº›æ•¸æ“šï¼Œé€é prometheus client library æŠŠè³‡æ–™è½‰æˆ time series prometheus metricsã€‚ç„¶å¾Œé€é library æ”¾åœ¨ http enpoint ä¸Šã€‚\né…åˆä¸Šæ¬¡èªªéçš„ redis overview dashboardï¼Œå¯ä»¥ç›´æ¥åœ¨ Grafana ä¸Šä½¿ç”¨\né€™é‚Š dashboard é¡¯ç¤ºå¹¾å€‹é‡è¦çš„ metrics\nUptime Memory Usageï¼Œè¦è¨­å®šç”¨é‡å¤ªé«˜è‡ªå‹•å ±è­¦ Command çš„åŸ·è¡Œç‹€æ³ï¼Œå›æ‡‰æ™‚é–“ è¨Šæ¯çš„æµé‡ï¼Œä»¥åŠè¶…å‡º time-to-live çš„è³‡æ–™æ¸…é™¤ã€‚ éƒ½æ˜¯éœ€è¦å¥½å¥½åŠ ä¸Š alert çš„æ ¸å¿ƒ metrics\nè²¢ç» exporter å…¶ä»–æœå‹™çš„ exporter å·¥ä½œåŸç†ä¹Ÿç›¸ä¼¼ï¼Œå¦‚æœæœå‹™æœ¬èº«æœ‰å…§éƒ¨çš„ metricsï¼Œå¯ä»¥é€é client command æˆ–æ˜¯ API å–å¾—ï¼Œexporter çš„å·¥ä½œå°±åªæ˜¯è½‰æˆ time series dataã€‚\nå¦‚æœæœ‰æ¯”è¼ƒç‰¹æ®Šçš„ metrics æ²’æœ‰åŒ¯å‡ºï¼Œä¾‹å¦‚èªªè‡ªå®¶çš„ metrics ï¼Œä½†åˆå¸Œæœ›èƒ½æ”¾åˆ° prometheus ä¸Šç›£æ¸¬ï¼Œä¾‹å¦‚æ¯ç§’æ”¶åˆ°å¤šå°‘ request countï¼Œå›æ‡‰é€Ÿåº¦ï¼ŒéŒ¯èª¤è¨Šæ¯çš„çµ±è¨ˆ\u0026hellip;\u0026hellip;ç­‰ï¼Œé€™é»ä¹Ÿå¯ä»¥ä½¿ç”¨ client library è‡ªå¹¹ exporter ç„¶å¾Œ expose http endpointï¼Œé€™æ¨£åœ¨ prometheus ä¸Šä¹Ÿå¯ä»¥çœ‹åˆ°è‡ªå®¶ç”¢å“çš„ metricsï¼Œéå¸¸å¥½ç”¨ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘ä¾†èŠè‡ªå¹¹ exporterã€‚\n","permalink":"https://chechia.net/posts/2019-10-06-prometheus-exporter-library-redis-exporter/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus / Grafana (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deployment-on-kubernetes/\"\u003eGKE ä¸Šè‡ªæ¶ Prometheus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deploy-grafana/\"\u003eGKE ä¸Šè‡ªæ¶ Grafana\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-scrape/\"\u003escrape config \u0026amp; exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-06-prometheus-exporter-library-redis-exporter/\"\u003eDive into Redis Exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-07-prometheus-kube-state-metrics-exporter/\"\u003eè¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eExporter å·¥ä½œåŸç†ç°¡ä»‹\u003c/li\u003e\n\u003cli\u003ePrometheus exporter library\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"exporter-workflow\"\u003eExporter workflow\u003c/h1\u003e\n\u003cp\u003eä¸Šæ¬¡è¬›åˆ° exporter å¯ä»¥å¾æœå‹™ç«¯æŠŠé‹è¡Œè³‡æ–™æŠ½å‡ºä¾†ï¼Œä¸¦é–‹æˆ http endpointï¼Œè®“ prometheus ä¾† scrape metricsã€‚é‚£ exporter æœ¬èº«æ˜¯å¦‚ä½•å–å¾—æœå‹™å…§éƒ¨çš„ metrics å‘¢? æˆ‘å€‘ä»Šå¤©å°±ç¨å¾®çœ‹ä¸€ä¸‹ã€‚\u003c/p\u003e\n\u003ch1 id=\"redis-exporter\"\u003eRedis Exporter\u003c/h1\u003e\n\u003cp\u003eæˆ‘å€‘ä»Šå¤©ä»¥ \u003ca href=\"https://github.com/oliver006/redis_exporter\"\u003eRedis Exporter\u003c/a\u003e ç‚ºä¾‹ï¼Œç ”ç©¶ä¸€ä¸‹å¤–éƒ¨çš„ exporter æ˜¯å¦‚ä½•å–å¾— redis å…§éƒ¨çš„ metrcsã€‚\u003c/p\u003e\n\u003cp\u003eRedis exporter æ˜¯ç”¨ golang å¯«çš„ä¸€å€‹å°ç¨‹å¼ï¼Œç¸½å…±ç®—ç®—æ‰ 1000 è¡Œï¼Œè€Œä¸”å¾ˆå¤šéƒ½æ˜¯å° redis å…§éƒ¨ metrics çš„æ¸…å–®ï¼Œä»¥åŠè½‰åŒ–æˆ prometheus metrics çš„ tool functionsï¼Œä¸»è¦çš„é‚è¼¯éå¸¸ç°¡å–®ã€‚æˆ‘å€‘ç°¡å–®çœ‹ä¸€ä¸‹æºç¢¼ã€‚\u003c/p\u003e","title":"Prometheus Exporter Library \u0026 Redis Exporter"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Prometheus Introduction Deploy Prometheus Prometheus Introduction ç”Ÿç”¢ç’°å¢ƒèˆ‡éç”Ÿç”¢ç’°å¢ƒï¼Œå…¶ä¸­çš„ä¸€æŒ‡æ¨™å°±æ˜¯æœ‰æ²’æœ‰è¶³å¤ å®Œæ•´çš„æœå‹™ç›£æ¸¬ç³»çµ±ï¼Œé€™å¥è©±å¯ä»¥çœ‹å‡ºæœå‹™ç›£æ¸¬å°æ–¼ç”¢å“åŒ–æ˜¯å¤šéº¼é‡è¦ã€‚è€Œç›£æ§è³‡æ–™ (metrics) çš„æ”¶é›†èˆ‡å¯è¦–åŒ–å·¥å…·å…¶å¯¦éå¸¸å¤šï¼Œä¾‹å¦‚ä¸Šå‘¨ä»‹ç´¹çš„ ELK Stackï¼Œé€™æ¬¡æˆ‘å€‘è¦ä¾†ä»‹ç´¹å¦å¤–ä¸€å€‹å¾ˆå¤šäººä½¿ç”¨çš„ prometheusã€‚\nPromethues åœ¨å®˜ç¶²ä¸Šæåˆ° æ˜¯ä¸€å€‹ Monitoring system and time series database\nå¯ä»¥æ”¶é›†é«˜ç¶­åº¦çš„è³‡æ–™ ä½¿ç”¨è‡ªå·±çš„ PromQL åšæœ‰æ•ˆä¸”ç²¾ç°¡çš„è³‡æ–™æŸ¥è©¢ å…§å»ºè³‡æ–™ç€è¦½å™¨ï¼Œä¸¦ä¸”èˆ‡ Grafana é«˜åº¦æ•´åˆ æ”¯æ´ sharding èˆ‡ federationï¼Œä¾†é”åˆ°æ°´å¹³æ“´å±• æœ‰è¨±å¤šéš¨æ’å³ç”¨çš„æ•´åˆ exporterï¼Œä¾‹å¦‚ redis-exporter, kafka-exporterï¼Œkubernetes-exporter ï¼Œéƒ½å¯ä»¥ç›´æ¥å–å¾—è³‡æ–™ æ”¯æ´ alertï¼Œä½¿ç”¨ PromQL ä»¥åŠå¤šåŠŸèƒ½çš„å‘Šè­¦ï¼Œå¯ä»¥è¨­å®šç²¾æº–çš„å‘Šè­¦æ¢ä»¶ èˆ‡ ELK åšæ¯”è¼ƒ åŸºæœ¬ä¸Š Prometheus è·Ÿ ELK æ¯”ï¼Œå…¶å¯¦æ˜¯å¾ˆå¥‡æ€ªçš„ä¸€ä»¶äº‹ï¼Œä½†é€™ä¹Ÿæ˜¯æœ€å¸¸è¢«å•çš„ä¸€å€‹å•é¡Œã€‚å…©è€…åœ¨æœ¬è³ªä¸Šæ˜¯å®Œå…¨ä¸åŒçš„ç³»çµ±ã€‚\nPrometheus æ˜¯ based on time series database çš„è³‡æ–™æ”¶é›†ç³»çµ± ELK æ˜¯åŸºæ–¼å…¨æ–‡æœç´¢å¼•æ“çš„è³‡æ–™æŸ¥è©¢ç³»çµ± æ˜¯çš„ï¼Œä»–å€‘éƒ½èƒ½åš metrics æ”¶é›†ï¼Œåœ¨æœ‰é™çš„å°ºåº¦ä¸‹ï¼Œèƒ½é”åˆ°ä¸€æ¨£çš„æ•ˆæœã€‚ä½†é€™æ¨£èªªçš„æ„æ€å°±ç­‰æ–¼æ˜¯åœ¨èªª mesos DC/OS èˆ‡ kubenetes éƒ½èƒ½è·‘ container cluster ä¸€æ¨£ï¼Œåº•ä¸‹æ˜¯å®Œå…¨ä¸ä¸€æ¨£çš„æ±è¥¿ã€‚\nå…©è€…çš„å·®ç•°ä½¿ç”¨ä¸Šå·®éå¸¸å¤š\nmetrics çµæ§‹: ELK å€ŸåŠ©å…¨æ–‡æœç´¢å¼•æ“ï¼ŒåŸºæœ¬ä¸Šé€ä»€éº¼è³‡æ–™è¿‘ä¾†éƒ½å¯ä»¥æŸ¥æ‰¾ã€‚Prometheus metrics æ‹‰é€²ä¾†æ˜¯ time series çš„ key-value pairsã€‚ ç¶­è­·åŒæ¨£çš„ metricsï¼Œprometheus çš„ä½¿ç”¨çš„å„²å­˜ç©ºé–“é å°æ–¼ elasticsearch prometheus é‡å° time based çš„æœå°‹åšäº†å¾ˆå¤šå„ªåŒ–ï¼Œæ•ˆèƒ½å¾ˆé«˜ Prometheus å°æ–¼è¨˜æ†¶é«”èˆ‡ cpu çš„æ¶ˆè€—ä¹Ÿå°‘å¾ˆå¤š Elasticsearch è³‡æºä¸Šå¾ˆè²´ï¼Œæ˜¯å› ç‚ºåœ¨è™•ç†å¤§é‡ text log çš„æ™‚å€™ï¼Œä»–èƒ½å¤ ç”¨å¾Œæ®µçš„ pipeline è™•ç†å…§å®¹ï¼Œå†é€²è¡Œäº¤å‰æ¯”å°ï¼Œå¯ä»¥å¾ text è£¡é¢æå–å¾ˆå¤šæœªäº‹å…ˆå®šç¾©çš„è³‡æ–™ Elasticsearch çš„ç¶­è­·å·¥ä½œä¹Ÿæ¯”è¼ƒè¤‡é›œå›°é›£ å¦‚æœè¦æ”¶é›†æœå‹™é‹è¡Œè³‡æ–™ï¼Œå¯ä»¥ç›´æ¥é¸ prometheusã€‚å¦‚æœæœ‰æ”¶é›† log é€²è¡Œäº¤å‰æ¯”å°ï¼Œå¯ä»¥è€ƒæ…® elkã€‚\nHelm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼Œä¹‹æ‰€ä»¥ç”¨ helm ï¼Œå› ç‚ºé€™æ˜¯æˆ‘æƒ³åˆ°æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œèƒ½è®“è¼•é¬†æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´çš„ prometheusã€‚æ‰€ä»¥æˆ‘å€‘å…ˆç”¨ã€‚\næ²’ç”¨é helm çš„å¤§å¾·å¯ä»¥åƒè€ƒ Helm Quickstartï¼Œå…ˆæŠŠ helm cli èˆ‡ kubernetes ä¸Šçš„ helm tiller éƒ½è¨­å®šå¥½\nDeploy Prometheus æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½æ”¾åœ¨é€™äº†https://github.com/chechiachang/prometheus-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash HELM_NAME=prometheus-1 helm upgrade --install ${HELM_NAME} stable/prometheus \\ --namespace default \\ --values values-staging.yaml Configuration Prometheus Stable Chart\nvalues.yaml å¾ˆé•·ï¼Œä½†å…¶å¯¦å„å€‹å…ƒä»¶è¨­å®šæ˜¯é‡è¤‡çš„,è¨­å®šå¥½å„è‡ªçš„ image, replicas, service, topology ç­‰ç­‰\nalertmanager: enabled: true kubeStateMetrics: enabled: true nodeExporter: enabled: true server: enabled: true pushgateway: enabled: true åº•ä¸‹æœ‰æ›´å¤š runtime çš„è¨­å®šæª”\nå®šç¾©å¥½ global çš„ scrape é–“è·ï¼Œè¶ŠçŸ­ metrics ç¶­åº¦å°±è¶Šç²¾æº– PersistenVolume å¼·è¬å»ºè­°é–‹èµ·ä¾†ï¼Œç¶­æŒæ­·å²çš„è³‡æ–™ åŠ ä¸Š storage usage çš„ self monitoringï¼ˆä¹‹å¾Œæœƒè¬›) æ‰ä¸æœƒæ»¿å‡ºä¾† server æ›æ‰ server çš„ scrapeConfigs æ˜¯ server å»æ”¶é›†çš„ job è¨­å®šã€‚ç¨å¾Œå†ä¾†ç´°è¬›ã€‚ server: global: ## How frequently to scrape targets by default ## scrape_interval: 10s ## How long until a scrape request times out ## scrape_timeout: 10s ## How frequently to evaluate rules ## evaluation_interval: 10s persistentVolume: ## If true, Prometheus server will create/use a Persistent Volume Claim ## If false, use emptyDir ## enabled: true ## Prometheus server data Persistent Volume access modes ## Must match those of existing PV or dynamic provisioner ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/ ## accessModes: - ReadWriteOnce ## Prometheus server data Persistent Volume annotations ## annotations: {} ## Prometheus server data Persistent Volume existing claim name ## Requires server.persistentVolume.enabled: true ## If defined, PVC must be created manually before volume will be bound existingClaim: \u0026quot;\u0026quot; ## Prometheus server data Persistent Volume mount root path ## mountPath: /data ## Prometheus server data Persistent Volume size ## size: 80Gi alertmanagerFiles: serverFiles: éƒ¨å±¬å®Œçœ‹ä¸€ä¸‹\nkubectl get pods --selector='app=prometheus' NAME READY STATUS RESTARTS AGE prometheus-alertmanager-694d6694c6-dvkwd 2/2 Running 0 8d prometheus-kube-state-metrics-85f6d75f8b-7vlkp 1/1 Running 0 8d prometheus-node-exporter-2mpjc 1/1 Running 0 8d prometheus-node-exporter-kg7fj 1/1 Running 0 51d prometheus-node-exporter-snnn5 1/1 Running 0 8d prometheus-pushgateway-5cdfb4979c-dnmjn 1/1 Running 0 8d prometheus-server-59b8b8ccb4-bplkx 2/2 Running 0 8d kubectl get services --selector='app=prometheus' NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE prometheus-alertmanager ClusterIP 10.15.241.66 \u0026lt;none\u0026gt; 80/TCP 197d prometheus-kube-state-metrics ClusterIP None \u0026lt;none\u0026gt; 80/TCP 197d prometheus-node-exporter ClusterIP None \u0026lt;none\u0026gt; 9100/TCP 197d prometheus-pushgateway ClusterIP 10.15.254.0 \u0026lt;none\u0026gt; 9091/TCP 197d prometheus-server ClusterIP 10.15.245.10 \u0026lt;none\u0026gt; 80/TCP 197d kubectl get endpoints --selector='app=prometheus' NAME ENDPOINTS AGE prometheus-alertmanager 10.12.6.220:9093 197d prometheus-kube-state-metrics 10.12.6.222:8080 197d prometheus-node-exporter 10.140.0.30:9100,10.140.0.9:9100,10.140.15.212:9100 197d prometheus-pushgateway 10.12.6.211:9091 197d prometheus-server 10.12.3.14:9090 197d ç°¡å–®èªªæ˜ä¸€ä¸‹\nprometheus-server æ˜¯ä¸»è¦çš„ api-server ä»¥åŠ time series database alertmanager è² è²¬å‘Šè­¦å·¥ä½œ pushgateway æä¾› client ç«¯ä¸»å‹•æ¨é€ metrics çµ¦ server çš„ endpoint kube-state-metrics æ˜¯é–‹ä¾†æ”¶é›† cluster wide çš„ metrics, åƒæ˜¯ pods running counts, deployment ready count, total pods number ç­‰ç­‰ metrics node-exporter æ˜¯ daemonsets, æŠŠæ¯ä¸€å€‹ node çš„ metrics, åƒæ˜¯ memory, cpu, disk\u0026hellip;ç­‰è³‡æ–™,æ”¶é›†å‡ºä¾† ä¸»è¦æœå‹™å­˜å–å°±æ˜¯é€é prometheus-server\nAccess Prometheus server é™¤äº†ç›´æ¥ exec -it é€²å» prometheus-server ä»¥å¤–ï¼Œç”±æ–¼ prometheus æœ¬èº«æœ‰æä¾› web portal, æ‰€ä»¥æˆ‘å€‘é€™é‚Šé€é port forwarding æ‰“åˆ°æœ¬æ©Ÿä¸Š\nPROMETHEUS_POD_NAME=$(kc get po -n default --selector='app=prometheus,component=server' -o=jsonpath='{.items[0].metadata.name}') kubectl --namespace default port-forward ${PROMETHEUS_POD_NAME} 9090 é€é browser å°±å¯ä»¥é€£å…¥æ“ä½œ\nhttp://localhost:9090 ä¹Ÿå¯ä»¥é€é HTTP API ç”¨ç¨‹å¼æ¥å…¥æ§åˆ¶\nPrometheus Web Prometheus æœ¬æ…æä¾›çš„ UI å…¶å¯¦åŠŸèƒ½å°±å¾ˆå¼·å¤§\nå¯ä»¥æŸ¥åˆ° (å·²ç¶“åŒ¯å…¥å­˜åœ¨) çš„ metrics å¯ä»¥åœ¨ä¸Šé¢åŸ·è¡Œ PromQL æŸ¥è©¢èªæ³• æŸ¥è©¢é‹è¡Œçš„ status æŸ¥è©¢ç›®å‰æ‰€æœ‰æ”¶é›†çš„ targets çš„ç‹€æ…‹,æœ‰æ”¶é›†å™¨æ›äº†ä¹Ÿå¯ä»¥åœ¨é€™é‚Šçœ‹åˆ° å°çµ è¼•é¬†è‡ªæ¶ prometheus Prometheus é é¢æœ‰ç²¾ç°¡ï¼Œä½†æ˜¯åŠŸèƒ½å®Œæ•´çš„ graph è£½åœ– ä½†å¤§å®¶é€šå¸¸æœƒä½¿ç”¨ Grafana æ­é…ä½¿ç”¨, ç”¨ééƒ½èªªè®š, æˆ‘å€‘æ˜å¤©ç¹¼çºŒ ","permalink":"https://chechia.net/posts/2019-10-04-prometheus-deployment-on-kubernetes/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus / Grafana (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deployment-on-kubernetes/\"\u003eGKE ä¸Šè‡ªæ¶ Prometheus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deploy-grafana/\"\u003eGKE ä¸Šè‡ªæ¶ Grafana\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-scrape/\"\u003escrape config \u0026amp; exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-06-prometheus-exporter-library-redis-exporter/\"\u003eDive into Redis Exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-07-prometheus-kube-state-metrics-exporter/\"\u003eè¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus Introduction\u003c/li\u003e\n\u003cli\u003eDeploy Prometheus\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"prometheus-introduction\"\u003ePrometheus Introduction\u003c/h1\u003e\n\u003cp\u003eç”Ÿç”¢ç’°å¢ƒèˆ‡éç”Ÿç”¢ç’°å¢ƒï¼Œå…¶ä¸­çš„ä¸€æŒ‡æ¨™å°±æ˜¯æœ‰æ²’æœ‰è¶³å¤ å®Œæ•´çš„æœå‹™ç›£æ¸¬ç³»çµ±ï¼Œé€™å¥è©±å¯ä»¥çœ‹å‡ºæœå‹™ç›£æ¸¬å°æ–¼ç”¢å“åŒ–æ˜¯å¤šéº¼é‡è¦ã€‚è€Œç›£æ§è³‡æ–™ (metrics) çš„æ”¶é›†èˆ‡å¯è¦–åŒ–å·¥å…·å…¶å¯¦éå¸¸å¤šï¼Œä¾‹å¦‚ä¸Šå‘¨ä»‹ç´¹çš„ ELK Stackï¼Œé€™æ¬¡æˆ‘å€‘è¦ä¾†ä»‹ç´¹å¦å¤–ä¸€å€‹å¾ˆå¤šäººä½¿ç”¨çš„ prometheusã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://prometheus.io/\"\u003ePromethues åœ¨å®˜ç¶²ä¸Šæåˆ°\u003c/a\u003e æ˜¯ä¸€å€‹ Monitoring system and time series database\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¯ä»¥æ”¶é›†é«˜ç¶­åº¦çš„è³‡æ–™\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨è‡ªå·±çš„ PromQL åšæœ‰æ•ˆä¸”ç²¾ç°¡çš„è³‡æ–™æŸ¥è©¢\u003c/li\u003e\n\u003cli\u003eå…§å»ºè³‡æ–™ç€è¦½å™¨ï¼Œä¸¦ä¸”èˆ‡ Grafana é«˜åº¦æ•´åˆ\u003c/li\u003e\n\u003cli\u003eæ”¯æ´ sharding èˆ‡ federationï¼Œä¾†é”åˆ°æ°´å¹³æ“´å±•\u003c/li\u003e\n\u003cli\u003eæœ‰è¨±å¤šéš¨æ’å³ç”¨çš„æ•´åˆ exporterï¼Œä¾‹å¦‚ redis-exporter, kafka-exporterï¼Œkubernetes-exporter ï¼Œéƒ½å¯ä»¥ç›´æ¥å–å¾—è³‡æ–™\u003c/li\u003e\n\u003cli\u003eæ”¯æ´ alertï¼Œä½¿ç”¨ PromQL ä»¥åŠå¤šåŠŸèƒ½çš„å‘Šè­¦ï¼Œå¯ä»¥è¨­å®šç²¾æº–çš„å‘Šè­¦æ¢ä»¶\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"èˆ‡-elk-åšæ¯”è¼ƒ\"\u003eèˆ‡ ELK åšæ¯”è¼ƒ\u003c/h1\u003e\n\u003cp\u003eåŸºæœ¬ä¸Š Prometheus è·Ÿ ELK æ¯”ï¼Œå…¶å¯¦æ˜¯å¾ˆå¥‡æ€ªçš„ä¸€ä»¶äº‹ï¼Œä½†é€™ä¹Ÿæ˜¯æœ€å¸¸è¢«å•çš„ä¸€å€‹å•é¡Œã€‚å…©è€…åœ¨æœ¬è³ªä¸Šæ˜¯å®Œå…¨ä¸åŒçš„ç³»çµ±ã€‚\u003c/p\u003e","title":"Prometheus Deployment on Kubernetes"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Grafana Introduction Deploy Grafana Grafana Introduction ä¸Šåæˆ‘å€‘ç°¡å–®ä»‹ç´¹äº† Prometheusï¼Œprometheus çš„ Web Portol å·²ç¶“é™„ä¸Šç°¡å–®çš„ Query èˆ‡ Graph å·¥å…·ï¼Œä½†ä¸€èˆ¬æˆ‘å€‘åœ¨ä½¿ç”¨æ™‚ï¼Œé‚„æ˜¯æœƒæ­é… Grafana ä¾†ä½¿ç”¨ã€‚\nGrafana åœ¨å®˜ç¶²ä¸Šæåˆ° æ˜¯ä¸€å€‹ Analytics systemï¼Œå¯ä»¥å”åŠ©äº†è§£é‹è¡Œè³‡æ–™ï¼Œå»ºç«‹å®Œæ•´çš„ dashboardã€‚\næ”¯æ´è¨±å¤šåœ–è¡¨ï¼Œç›´ç·šåœ–ï¼Œé•·æ¢åœ–ï¼Œå€åŸŸåˆ†æï¼ŒåŸºæœ¬ä¸Šéœ€è¦çš„éƒ½æœ‰ åœ¨åœ–è¡¨ä¸Šå®šç¾© alterï¼Œä¸¦ä¸”ä¸»å‹•å‘Šè­¦ï¼Œæ•´åˆå…¶ä»–é€šè¨Šè»Ÿé«” å°å¾Œç«¯ data source çš„æ•´åˆï¼Œå¯ä»¥åŒæ™‚ä½¿ç”¨ ELK, prometheus, influxdb ç­‰ 30 å¤šç¨®çš„è³‡æ–™ä¾†æº æœ‰è¨±å¤šå…¬é–‹çš„ plugin èˆ‡ dashboard å¯ä»¥åŒ¯å…¥ä½¿ç”¨ ç¸½ä¹‹åŠŸèƒ½å¼·å¤§ï¼Œè‡³æ–¼ç”¨èµ·ä¾†çš„æ„Ÿè¦ºï¼Œå€‹äººæ˜¯éå¸¸æ¨è–¦ã€‚å¦‚æœæœ‰å¤§å¾—æƒ³è¦è©¦ç©çœ‹çœ‹ï¼Œå¯ä»¥ç›´æ¥åˆ° Grafana Live Demo ä¸Šé¢è©¦ç©\nä¸€èˆ¬ä½¿ç”¨éƒ½æœƒåœç¹ dashboard ç‚ºæ ¸å¿ƒï¼Œé€éå–®ä¸€ç•«é¢ï¼Œä¸€è¦½ç›®å‰ä½¿ç”¨è€…éœ€è¦è®€å–çš„è³‡æ–™ å·¦ä¸Šè§’çš„ä¸‹æ‹‰é¸å–®ï¼Œå¯ä»¥é¸æ“‡ä¸åŒçš„ dashboards èˆ‡ Kibana åšæ¯”è¼ƒ é›–ç„¶å¤§éƒ¨åˆ†ä½¿ç”¨ä¸Šï¼Œæˆ‘å€‘éƒ½æœƒä½¿ç”¨ ELK ä¸€å¥—ï¼Œè€Œ Prometheus + Grafana å¦ä¸€å¥—ã€‚ä½†å…¶å¯¦å…©é‚Šçš„ data source éƒ½å¯ä»¥äº’æ¥ã€‚ä¾‹å¦‚ grafana å¯ä»¥åƒ elasticsearch çš„ data sourceï¼Œè€Œ kibana æœ‰ prometheus moduleã€‚\næˆ‘å€‘é€™é‚ŠåŸºæ–¼å…©æ¬¾å‰ç«¯åˆ†æå·¥å…·ï¼Œç¨å¾®åšå€‹æ¯”è¼ƒï¼Œåº•å±¤çš„ data source å·®ç•°é€™é‚Šå…ˆä¸æã€‚\néƒ½æ˜¯é–‹æº: å…©è€…çš„é–‹æºç¤¾ç¾¤éƒ½éå¸¸å¼·å¤§ å…©è€…å…§å»ºçš„ dashboard éƒ½éå¸¸å®Œæ•´ï¼Œè€Œä¸”ä¸æ–·æ¨å‡ºæ–°åŠŸèƒ½ Log vs Metrics: Kibana çš„ metrics ä¹Ÿæ˜¯åƒ log ä¸€æ¨£çš„ key value pairsï¼Œèƒ½å¤  explore æœªå®šç¾©çš„ log Grafana çš„ UI å°ˆæ³¨æ–¼å‘ˆç¾ time series çš„ metricsï¼Œä¸¦æ²’æœ‰æä¾› data çš„æ¬„ä½æœå°‹ï¼Œè€Œæ˜¯ä½¿ç”¨èªæ³• Query ä¾†å–å¾—æ•¸æ“š Data source: Grafana å¯ä»¥æ”¶é›†å„ç¨®ä¸åŒçš„å¾Œç«¯è³‡æ–™ä¾†æº ELK ä¸»è¦æ ¸å¿ƒé‚„æ˜¯ ELK stackï¼Œç”¨å…¶ä»– Module è¼”åŠ©å…¶ä»–è³‡æ–™æº Deploy Grafana æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½æ”¾åœ¨é€™äº†https://github.com/chechiachang/prometheus-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncd grafana cat install.sh #!/bin/bash HELM_NAME=grafana-1 helm upgrade --install grafana stable/grafana \\ --namespace default \\ --values values-staging.yaml Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼ŒGrafana Stable Chart\nConfiguration ç°¡å–®çœ‹ä¸€ä¸‹è¨­å®šæª”\nvim values-staging.yaml replicas: 1 deploymentStrategy: RollingUpdate Grafana æ˜¯æ”¯æ´ Grafana HA ï¼Œå…¶å¯¦ä¹Ÿéå¸¸ç°¡å–®ï¼Œå°±æ˜¯æŠŠ grafana æœ¬èº«çš„ dashboard database å¾æ¯å€‹ grafana ä¸€å° SQLiteï¼Œè®Šæˆå¤–éƒ¨çµ±ä¸€çš„ MySQLï¼Œçµ±ä¸€è®€å–å¾Œç«¯è³‡æ–™ï¼Œå‰ç«¯å°±å¯æ°´å¹³æ“´å±•ã€‚\nreadinessProbe: httpGet: path: /api/health port: 3000 livenessProbe: httpGet: path: /api/health port: 3000 initialDelaySeconds: 60 timeoutSeconds: 30 failureThreshold: 10 image: repository: grafana/grafana tag: 6.0.0 pullPolicy: IfNotPresent ## Optionally specify an array of imagePullSecrets. ## Secrets must be manually created in the namespace. ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/ ## # pullSecrets: # - myRegistrKeySecretName ä¸€äº› Pod çš„åŸºæœ¬é…ç½®ï¼Œ health check ä½¿ç”¨å…§å»ºçš„ apiï¼Œæœ‰éœ€è¦ä¹Ÿå¯ä»¥ç›´æ¥æ‰“ api\nsecurityContext: runAsUser: 472 fsGroup: 472 extraConfigmapMounts: [] # - name: certs-configmap # mountPath: /etc/grafana/ssl/ # configMap: certs-configmap # readOnly: true æœ‰è¦é–‹å¤–éƒ¨ ingressï¼Œéœ€è¦ ssl çš„è©±å¯ä»¥å¾é€™é‚Šæ›é€²å»\n## Expose the grafana service to be accessed from outside the cluster (LoadBalancer service). ## or access it from within the cluster (ClusterIP service). Set the service type and the port to serve it. ## ref: http://kubernetes.io/docs/user-guide/services/ ## service: type: LoadBalancer port: 80 targetPort: 3000 # targetPort: 4181 To be used with a proxy extraContainer annotations: {} labels: {} ingress: enabled: false annotations: {} # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \u0026quot;true\u0026quot; labels: {} path: / hosts: - chart-example.local tls: [] # - secretName: chart-example-tls # hosts: # - chart-example.local é€™é‚Šå¯ä»¥é–‹ service load balancer, ä»¥åŠ ingressï¼Œçœ‹å¯¦éš›ä½¿ç”¨çš„éœ€æ±‚\npersistence: enabled: true initChownData: true # storageClassName: default accessModes: - ReadWriteOnce size: 10Gi # annotations: {} # subPath: \u0026quot;\u0026quot; # existingClaim: Persistent Volume ä½œç‚ºæœ¬åœ°å„²å­˜å»ºè­°éƒ½é–‹èµ·ä¾†ï¼Œ\n# Administrator credentials when not using an existing secret (see below) adminUser: admin # adminPassword: strongpassword # Use an existing secret for the admin user. admin: existingSecret: \u0026quot;\u0026quot; userKey: admin-user passwordKey: admin-password å¸³è™Ÿå¯†ç¢¼å»ºè­°ä½¿ç”¨ secret æ›é€²å»\ndatasources: {} # datasources.yaml: # apiVersion: 1 # datasources: # - name: Prometheus # type: prometheus # url: http://prometheus-prometheus-server # access: proxy # isDefault: true ## Configure grafana dashboard providers ## ref: http://docs.grafana.org/administration/provisioning/#dashboards ## ## `path` must be /var/lib/grafana/dashboards/\u0026lt;provider_name\u0026gt; ## dashboardProviders: {} # dashboardproviders.yaml: # apiVersion: 1 # providers: # - name: 'default' # orgId: 1 # folder: '' # type: file # disableDeletion: false # editable: true # options: # path: /var/lib/grafana/dashboards/default ## Configure grafana dashboard to import ## NOTE: To use dashboards you must also enable/configure dashboardProviders ## ref: https://grafana.com/dashboards ## ## dashboards per provider, use provider name as key. ## dashboards: {} # default: # some-dashboard: # json: | # $RAW_JSON # custom-dashboard: # file: dashboards/custom-dashboard.json # prometheus-stats: # gnetId: 2 # revision: 2 # datasource: Prometheus # local-dashboard: # url: https://example.com/repository/test.json # local-dashboard-base64: # url: https://example.com/repository/test-b64.json # b64content: true Data source, Dashboard æƒ³è¦ç›´æ¥è¼‰å…¥ï¼Œå¯ä»¥åœ¨é€™é‚Šè¨­å®šï¼Œæˆ–æ˜¯ grafana èµ·ä¾†å¾Œï¼Œé€é Web UI é€²å»æ–°å¢ä¹Ÿå¯ä»¥\n## Grafana's primary configuration ## NOTE: values in map will be converted to ini format ## ref: http://docs.grafana.org/installation/configuration/ ## grafana.ini: paths: data: /var/lib/grafana/data logs: /var/log/grafana plugins: /var/lib/grafana/plugins provisioning: /etc/grafana/provisioning analytics: check_for_updates: true log: mode: console grafana_net: url: https://grafana.net ç„¶å¾Œæ˜¯ grafana.ini æ ¸å¿ƒ runtime è¨­å®šï¼Œæ›´å¤šè¨­å®šå¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶\nDeployment éƒ¨å±¬å®Œçœ‹ä¸€ä¸‹\nkubectl get po --selector='app=grafana' Access å¦‚æœæ²’æœ‰é€é service load balancer æ‰“å‡ºä¾†ï¼Œä¸€æ¨£å¯ä»¥ä½¿ç”¨ kubectl åš port forwardingï¼Œæ¬Šé™å°±æ˜¯ context çš„æ¬Šé™ï¼Œæ²’æœ‰ cluster context çš„ä½¿ç”¨è€…å°±æœƒé€²æ­¥ä¾†\nGRAFANA_POD_NAME=$(kc get po -n default --selector='app=grafana' -o=jsonpath='{.items[0].metadata.name}') kubectl --namespace default port-forward ${GRAFANA_POD_NAME} 3000 http://localhost:3000 ç”±æ–¼æˆ‘å€‘é€é service load balancerï¼Œgcp æœƒåœ¨å¤–éƒ¨å¹«å¿™æ¶ä¸€å€‹ load balancerï¼Œ å¯ä»¥ç›´æ¥é€é load balancer ip å­˜å–ï¼Œå¦‚æœæƒ³è¨­å®š dnsï¼ŒæŒ‡å‘é€™å€‹ ip å¾Œè¨˜å¾—å»èª¿æ•´ grafana çš„ server hostnameã€‚\nä½¿ç”¨ secret çš„å¯†ç¢¼ç™»å…¥ï¼Œusername: grafanaï¼Œé€™å€‹æ˜¯ç³»çµ±ç®¡ç†å“¡\nkubectl get secret --namespace default grafana -o jsonpath=\u0026quot;{.data.admin-password}\u0026quot; | base64 --decode ; echo Configuration è¿‘ä¾†ç•«é¢å¾Œå…ˆåˆ°å·¦é‚Šçš„Configuration èª¿æ•´\nç”¢ç”Ÿæ–°çš„ user org èˆ‡ userï¼ŒæŠŠ admin æ¬Šé™æ§åˆ¶åœ¨éœ€è¦çš„äººæ‰‹ä¸Š æŠŠ prometheus data source åŠ é€²ä¾†ï¼Œå°±å¯ä»¥ç›´æ¥çœ‹åˆ° prometheus è£¡é¢çš„è³‡æ–™ã€‚ åˆ‡æ›åˆ°éç®¡ç†å“¡çš„ user ç¹¼çºŒæ“ä½œ Import Dashboard Grafana ç¶²ç«™ä¸Šå·²ç¶“æœ‰è¶…å¤šè¨­ç½®å¥½çš„ Dashboard å¯ä»¥ç›´æ¥ importï¼Œå¤§éƒ¨åˆ†çš„æœå‹™éƒ½å·²ç¶“æœ‰åˆ¥äººå¹«æˆ‘å€‘æŠŠè¦–è¦ºç•«åœ–è¡¨æ‹‰å¥½ï¼Œä½¿ç”¨ç¤¾ç¾¤ä¸»æµçš„ exporter çš„è©±ï¼Œåƒæ•¸ç›´æ¥æ¥å¥½ã€‚æˆ‘å€‘åŒ¯å…¥å¾Œå†é€²è¡Œç°¡å–®çš„å®¢è£½åŒ–èª¿æ•´å³å¯ã€‚\næˆ‘å€‘éµäººè³½æœ‰ç”¨åˆ°çš„æœå‹™ï¼Œéƒ½å·²ç¶“æœ‰ dashboard\nkubernetes Cluster: 6417 https://grafana.com/dashboards/6417 Kafka Exporter Overview: 7589 https://grafana.com/dashboards/7589 Prometheus Redis: 763 https://grafana.com/dashboards/763 Kubernetes Deployment Statefulset Daemonset metrics: 8588 https://grafana.com/dashboards/8588 Haproxy Metrics Servers: 367 https://grafana.com/dashboards/367 Go to grafana lab to find more dashboards Export Dashboard dashboard æœƒä¾ç…§ç™»å…¥ä½¿ç”¨è€…çš„éœ€æ±‚åšèª¿æ•´ï¼Œæ¯å€‹è…³è‰²éœ€è¦çœ‹åˆ°çš„åœ–è¡¨éƒ½ä¸åŒï¼ŒåŸºæœ¬ä¸Šè®“å„å€‹è…³è‰²éƒ½èƒ½ä¸€çœ¼çœ‹åˆ°æ‰€éœ€çš„è¡¨æ ¼å³å¯\nè‡ªå·±çš„èª¿æ•´éçš„ dashboard ä¹Ÿå¯ä»¥åŒ¯å‡ºåˆ†äº«\nå°çµ åˆ°é€™é‚Šå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ grafanaäº†ï¼Œè³‡æ–™ä¾†æºçš„ exporter æˆ‘å€‘æœƒæ­é…å‰å¹¾å‘¨åˆ†äº«éçš„æœå‹™ï¼Œä¸€èµ·ä¾†è¬›\n","permalink":"https://chechia.net/posts/2019-10-04-prometheus-deploy-grafana/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus / Grafana (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deployment-on-kubernetes/\"\u003eGKE ä¸Šè‡ªæ¶ Prometheus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deploy-grafana/\"\u003eGKE ä¸Šè‡ªæ¶ Grafana\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-scrape/\"\u003escrape config \u0026amp; exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-06-prometheus-exporter-library-redis-exporter/\"\u003eDive into Redis Exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-07-prometheus-kube-state-metrics-exporter/\"\u003eè¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eGrafana Introduction\u003c/li\u003e\n\u003cli\u003eDeploy Grafana\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"grafana-introduction\"\u003eGrafana Introduction\u003c/h1\u003e\n\u003cp\u003eä¸Šåæˆ‘å€‘ç°¡å–®ä»‹ç´¹äº† Prometheusï¼Œprometheus çš„ Web Portol å·²ç¶“é™„ä¸Šç°¡å–®çš„ Query èˆ‡ Graph å·¥å…·ï¼Œä½†ä¸€èˆ¬æˆ‘å€‘åœ¨ä½¿ç”¨æ™‚ï¼Œé‚„æ˜¯æœƒæ­é… Grafana ä¾†ä½¿ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://grafana.com/grafana/\"\u003eGrafana åœ¨å®˜ç¶²ä¸Šæåˆ°\u003c/a\u003e æ˜¯ä¸€å€‹ Analytics systemï¼Œå¯ä»¥å”åŠ©äº†è§£é‹è¡Œè³‡æ–™ï¼Œå»ºç«‹å®Œæ•´çš„ dashboardã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ”¯æ´è¨±å¤šåœ–è¡¨ï¼Œç›´ç·šåœ–ï¼Œé•·æ¢åœ–ï¼Œå€åŸŸåˆ†æï¼ŒåŸºæœ¬ä¸Šéœ€è¦çš„éƒ½æœ‰\u003c/li\u003e\n\u003cli\u003eåœ¨åœ–è¡¨ä¸Šå®šç¾© alterï¼Œä¸¦ä¸”ä¸»å‹•å‘Šè­¦ï¼Œæ•´åˆå…¶ä»–é€šè¨Šè»Ÿé«”\u003c/li\u003e\n\u003cli\u003eå°å¾Œç«¯ data source çš„æ•´åˆï¼Œå¯ä»¥åŒæ™‚ä½¿ç”¨ ELK, prometheus, influxdb ç­‰ 30 å¤šç¨®çš„è³‡æ–™ä¾†æº\u003c/li\u003e\n\u003cli\u003eæœ‰è¨±å¤šå…¬é–‹çš„ plugin èˆ‡ dashboard å¯ä»¥åŒ¯å…¥ä½¿ç”¨\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç¸½ä¹‹åŠŸèƒ½å¼·å¤§ï¼Œè‡³æ–¼ç”¨èµ·ä¾†çš„æ„Ÿè¦ºï¼Œå€‹äººæ˜¯éå¸¸æ¨è–¦ã€‚å¦‚æœæœ‰å¤§å¾—æƒ³è¦è©¦ç©çœ‹çœ‹ï¼Œå¯ä»¥ç›´æ¥åˆ° \u003ca href=\"https://play.grafana.org/d/000000029/prometheus-demo-dashboard?orgId=1\u0026amp;refresh=5m\"\u003eGrafana Live Demo\u003c/a\u003e ä¸Šé¢è©¦ç©\u003c/p\u003e","title":"Prometheus Deploy Grafana"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nPrometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Prometheus scrape scrape_configs Node exporter Scrape Prometheus æ”¶é›† metrics çš„æ–¹å¼ï¼Œæ˜¯å¾è¢«ç›£æ¸¬çš„ç›®æ¨™çš„ http endpoints æ”¶é›† (scrape) metricsï¼Œç›®æ¨™æœå‹™æœ‰æä¾› export metrics çš„ endpoint çš„è©±ï¼Œç¨±ä½œ exporterã€‚ä¾‹å¦‚ kafka-exporter å°±æœƒæ”¶é›† kafka é‹è¡Œçš„ metricsï¼Œè®Šæˆ http endpoint instanceï¼Œprometheus å¾ instance ä¸Šé¢æ”¶é›†è³‡æ–™ã€‚\nPromethesu è‡ªå·±ä¹Ÿæ˜¯ä¹Ÿæä¾› metrics endpointï¼Œä¸¦ä¸”è‡ªå·±é€é scrape è‡ªå·±çš„ metrics endpoint ä¾†å–å¾— self-monitoring çš„ metricsã€‚æŠŠè‡ªå·±ç•¶ä½œå¤–éƒ¨æœå‹™ç›£æ¸¬ã€‚ä¸‹é¢çš„è¨­å®šå°±æ˜¯ç›´æ¥é€é http://localhost:9090/metrics å–å¾—ã€‚\nglobal: scrape_interval: 15s # By default, scrape targets every 15 seconds. # Attach these labels to any time series or alerts when communicating with # external systems (federation, remote storage, Alertmanager). external_labels: monitor: 'codelab-monitor' # A scrape configuration containing exactly one endpoint to scrape: # Here it's Prometheus itself. scrape_configs: # The job name is added as a label `job=\u0026lt;job_name\u0026gt;` to any timeseries scraped from this config. - job_name: 'prometheus' # Override the global default and scrape targets from this job every 5 seconds. scrape_interval: 5s static_configs: - targets: ['localhost:9090'] é€é Grafana -\u0026gt; explore å°±å¯ä»¥çœ‹åˆ° Prometheus çš„ metrics\nè€Œä½¿ç”¨ metrics æ™‚æœ€å¥½å…ˆæŸ¥åˆ°èªªæ˜æ–‡ä»¶ï¼Œç¢ºå®š metrics çš„å®šç¾©èˆ‡è¨ˆç®—æ–¹æ³•ï¼Œæ‰å¯ä»¥æœ‰æ•ˆçš„è£½åœ–ã€‚é—œæ–¼ Prometheus Exporter çš„ metrics èªªæ˜ å¯ä»¥åˆ°é€™è£¡ä¾†æ‰¾ã€‚\nDashboard æ”¶é›†åˆ° metrics ä¹‹å¾Œå°±å¯ä»¥åœ¨ prometheus ä¸­ queryï¼Œä½†ä¸€èˆ¬ä½¿ç”¨ä¸æœƒä¸€ç›´è·‘é€²ä¾†ä¸‹ queryï¼Œè€Œæ˜¯æœƒç›´æ¥æ­é… dashboard è£½åœ–å‘ˆç¾ï¼Œè®“è³‡æ–™ä¸€è¦½ç„¡éºã€‚\nä¾‹å¦‚ prometheus è‡ªèº«çš„ metrics ä¹Ÿå·²ç¶“æœ‰æ­é…å¥½çš„ Prometheus overview dashboard å¯ä»¥ä½¿ç”¨ã€‚\nä½¿ç”¨æ–¹æ³•éå¸¸ç°¡å–®ï¼Œç›´æ¥é€é Grafana import dashboardï¼Œè£¡é¢å°±æŠŠé‡è¦çš„ prometheus metrics éƒ½æ”¾åœ¨ dashboard ä¸Šäº†ã€‚ä¸èƒ½æ›´æ–¹ä¾¿äº†ã€‚\nExporters Prometheus æ”¯æ´è¶…ç´šå¤š exporterï¼ŒåŒ…å« prometheus è‡ªèº«ç›´æ¥ç¶­è­·çš„ exporterï¼Œé‚„æœ‰éå¸¸å¤šå¤–éƒ¨æœå‹™å‹ä¹Ÿé–‹æºçš„ exporter å¯ä»¥ä½¿ç”¨ï¼Œæ¸…å–®å¯ä»¥åˆ°é€™è£¡çœ‹\næœ‰å¸Œæœ›è‡ªå·±å…¬å¸çš„æœå‹™ï¼Œä¹Ÿä½¿ç”¨ prometheus\nNode Exporter prometheus/node_exporter æ˜¯ Prometheus ç›´æ¥ç¶­è­·çš„ projectï¼Œä¸»è¦ç”¨é€”å°±æ˜¯å°‡ node / vm çš„é‹è¡Œ metrics export å‡ºä¾†ã€‚æœ‰é»é¡ä¼¼ ELK çš„ metricbeatã€‚\næˆ‘å€‘é€™é‚Šæ˜¯åœ¨ kubernetes ä¸ŠåŸ·è¡Œï¼Œæ‰€ä»¥ç›´æ¥åšæˆ daemonsets åœ¨ k8s ä¸Šè·‘ï¼Œéƒ¨å±¬æ–¹é¢åœ¨ deploy prometheus-server çš„ helm chart ä¸­ï¼Œå°±å·²ç¶“é™„å¸¶æ•´åˆï¼Œéƒ¨å±¬åˆ°æ¯ä¸€å° node ä¸Šã€‚\nå¦‚æœæ˜¯åœ¨ kubernetes å¤–çš„ç’°å¢ƒï¼Œä¾‹å¦‚èªª on premise serverï¼Œæˆ–æ˜¯ gcp instanceï¼Œå¸Œæœ›è‡ªå·±éƒ¨å±¬ node exporter çš„è©±ï¼Œå¯ä»¥åƒè€ƒé€™ç¯‡æ•™å­¸æ–‡ç« ã€‚\næˆ‘å€‘é€™é‚Šå¯ä»¥çœ‹ä¸€ä¸‹ configï¼Œä»¥åŠ job å®šç¾©ã€‚\nvim values-staging.yaml # Enable nodeExporter nodeExporter: create: true prometheus.yml: rule_files: - /etc/config/rules - /etc/config/alerts scrape_configs: # Add kubernetes node job - job_name: 'kubernetes-nodes' # Default to scraping over https. If required, just disable this or change to # `http`. scheme: https # This TLS \u0026amp; bearer token file config is used to connect to the actual scrape # endpoints for cluster components. This is separate to discovery auth # configuration because discovery \u0026amp; scraping are two separate concerns in # Prometheus. The discovery auth config is automatic if Prometheus runs inside # the cluster. Otherwise, more config options have to be provided within the # \u0026lt;kubernetes_sd_config\u0026gt;. tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt # If your node certificates are self-signed or use a different CA to the # master CA, then disable certificate verification below. Note that # certificate verification is an integral part of a secure infrastructure # so this should only be disabled in a controlled environment. You can # disable certificate verification by uncommenting the line below. # insecure_skip_verify: true bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token kubernetes_sd_configs: - role: node relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/$1/proxy/metrics kubernetes_sd_config: å¯ä»¥é€é kubernetes API ä¾†å–å¾— scrape targetï¼Œä»¥é€™é‚Šçš„è¨­å®šï¼Œæ˜¯ä½¿ç”¨ node role å»é›†ç¾¤å–å¾— nodeï¼Œä¸¦ä¸”æ¯ä¸€å° node éƒ½ç•¶æˆä¸€å€‹ targetï¼Œé€™æ¨£å°±ä¸ç”¨æŠŠæ‰€æœ‰ node éƒ½æ‰‹å‹•åŠ åˆ° job çš„ instance list è£¡é¢ã€‚\nå¾ node role å–å¾—çš„ instance æœƒä½¿ç”¨ ip æ¨™è¨»æˆ–æ˜¯ hostname æ¨™è¨»ã€‚node role æœ‰æä¾› node ç¯„åœçš„ meta labelsï¼Œä¾‹å¦‚ __meta_kubernetes_node_name, _meta_kubernetes_node_address ç­‰ç­‰ï¼Œæ–¹ä¾¿æŸ¥æ‰¾æ•´ç†è³‡æ–™ã€‚\nrelabel_configs: é‡å°è³‡æ–™åšé¡å¤–æ¨™è¨˜ï¼Œæ–¹ä¾¿ä¹‹å¾Œåœ¨ grafana ä¸Šé¢ä¾æ“šéœ€æ±‚ queryã€‚\n","permalink":"https://chechia.net/posts/2019-10-04-prometheus-scrape/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus / Grafana (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deployment-on-kubernetes/\"\u003eGKE ä¸Šè‡ªæ¶ Prometheus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-deploy-grafana/\"\u003eGKE ä¸Šè‡ªæ¶ Grafana\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-04-prometheus-scrape/\"\u003escrape config \u0026amp; exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-06-prometheus-exporter-library-redis-exporter/\"\u003eDive into Redis Exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-07-prometheus-kube-state-metrics-exporter/\"\u003eè¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus scrape\u003c/li\u003e\n\u003cli\u003escrape_configs\u003c/li\u003e\n\u003cli\u003eNode exporter\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"scrape\"\u003eScrape\u003c/h1\u003e\n\u003cp\u003ePrometheus æ”¶é›† metrics çš„æ–¹å¼ï¼Œæ˜¯å¾è¢«ç›£æ¸¬çš„ç›®æ¨™çš„ http endpoints æ”¶é›† (scrape) metricsï¼Œç›®æ¨™æœå‹™æœ‰æä¾› export metrics çš„ endpoint çš„è©±ï¼Œç¨±ä½œ exporterã€‚ä¾‹å¦‚ kafka-exporter å°±æœƒæ”¶é›† kafka é‹è¡Œçš„ metricsï¼Œè®Šæˆ http endpoint instanceï¼Œprometheus å¾ instance ä¸Šé¢æ”¶é›†è³‡æ–™ã€‚\u003c/p\u003e","title":"Prometheus Scrape"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Failure Case Recovery Topology ä¸Šç¯‡çš„ä¾‹å­å®Œæˆæ‡‰è©²æ˜¯é€™æ¨£\n+-------+ +--------+ +------------+ +---------+ |Clients|---|HAProxys|----|redis master|----|sentinels| +-------+ +--------+ +------------+ +---------+ HAproxy ä½œç‚ºå¾Œç«¯ redis çš„ gateway Client é€é HAproxy é€£å…¥ redis master sentinel è² è²¬ç›£æ¸¬ redis ç‹€æ…‹èˆ‡ failoverï¼Œåªæ˜¯ client ä¸å†é€é sentinel å»å–å¾— masterï¼Œè€Œæ˜¯é€é HAProxyã€‚ é‚£ç¾åœ¨å°±ä¾†èŠèŠé€™äº›æœå‹™å¯èƒ½æ€éº¼æ­»çš„ï¼Œå›å¾©çš„æ©Ÿåˆ¶åˆæ˜¯å¦‚ä½•\nFailure Recovery Redis master æ•…éšœ é€™å€‹æ˜¯ç›®å‰æˆ‘å€‘é€™å€‹ Redis HAProxy é…ç½®ä¸»è¦æƒ³è§£æ±ºçš„å•é¡Œï¼Œæ•…éšœèˆ‡å›è¦†çš„æµç¨‹å¤§æ¦‚æ˜¯é€™æ¨£\nRedis Master failing Sentinels detect master failure sentinel ç­‰å¾… down-after-millisecondsï¼Œè¶…éæ‰åˆ¤å®š master failure sentinel å½¼æ­¤å–å¾— quorumï¼Œæˆæ¬Šå…¶ä¸­ä¸€å° sentinel åŸ·è¡Œ failover sentinel æŒ‡æ´¾æ–°çš„ master master æ•…éšœåŒæ™‚ï¼ŒHAProxy ä¹Ÿåµæ¸¬ master failure HAProxy ç™¼ç¾æ²’æœ‰å¯ç”¨çš„ master tcp checklist å†æ¬¡åŸ·è¡Œæ™‚ï¼Œç”±æ–¼æ–°çš„ master å°šæœªé¸å‡ºä¾†ï¼Œä»æœƒé¡¯ç¤ºä¸‰å° server éƒ½é›¢ç·š ç›´åˆ° master é¸å‡ºï¼Œrole:master çš„ tcp check æœ‰å›æ‡‰å¾Œï¼Œæ‰æœƒå°‡å¾Œç«¯æ¥åˆ°æ–°çš„ master Client ç”±æ–¼ HAProxy æ²’æœ‰å¯ç”¨çš„ masterï¼Œæ‰€ä»¥é€£ç·šæ–·æ‰ æŒçºŒä¸­æ–·åˆ° HAProxy å›å¾© é€™é‚Šçš„å¹¾å€‹é‡è¦çš„åƒæ•¸\nsentinel\ndown-after-milliseconds: æ–·ç·šå¤šä¹…æ‰æœƒè¦ºå¾— master æ­»äº†éœ€è¦ failoverï¼Œå¯ä»¥ç›¡é‡ç¸®çŸ­ï¼ŒåŠ é€Ÿ failure ç™¼ç”Ÿ failover çš„æ™‚é–“ haproxy.cfg\nserver check inter 1s: å¤šä¹…è·‘ä¸€æ¬¡ tcp-check è¶ŠçŸ­ï¼Œä¾¿èƒ½è¶Šæ—©æ¥å—åˆ° redis instance failure çš„ç™¼ç”Ÿ å¾é€™å€‹ä¾‹å­ä¾†çœ‹ï¼Œé€™å€‹é…ç½®çš„ HA å…¶å¯¦é‚„æ˜¯æœ‰é›¢ç·šæ™‚é–“\ndown-after-milliseconds è¨­å®šç‚º 2s ï¼Œé‚£å¾ failure ç™¼ç”Ÿï¼Œåˆ° sentinel é–‹å§‹ failover çš„æ™‚é–“å°±æœƒè¶…é 2sï¼Œé€™å…©ç§’å®¢æˆ¶ç«¯ç„¡æ³•å¯«å…¥ã€‚ äº‹å¯¦ä¸Šï¼Œé€™ä¹Ÿæ˜¯ redis master-slave çš„æ¨¡å¼çš„å•é¡Œï¼Œä¸¦ç„¡æ³•ç¢ºä¿ zero downtime èƒ½åšåˆ°çš„æ˜¯ç§’ç´šçš„ auto-recovery Sentinel Failure é€™å€‹æ˜¯å¾ˆå¥½è§£æ±ºçš„éŒ¯èª¤ï¼Œå¦‚åŒæˆ‘å€‘åœ¨ topology é€™ç¯‡æåˆ°çš„ï¼ŒåŸå‰‡ä¸Šåªè¦èƒ½ç¶­æŒ quorum ä»¥ä¸Šçš„ sentinel æ­£å¸¸é‹ä½œï¼Œå°±å¯ä»¥å®¹å¿å¤šå€‹ sentinel çš„éŒ¯èª¤\nä¾‹å¦‚ 5 sentinelï¼Œquorum 3ï¼Œå°±å¯ä»¥å…è¨±å…©å€‹ sentinel éŒ¯èª¤ æœå‹™éƒ½æ­£å¸¸ zero downtime ç­‰å¾…éŒ¯èª¤çš„ sentinels å¾©åŸ éŒ¯èª¤ä¸ä¸€å®šæ˜¯å…©å€‹ sentinel æ­»äº†ï¼Œå¯èƒ½æ˜¯ç¶²è·¯æ–·é–‹ï¼ŒæŠŠ 3 sentinels èˆ‡ 2 sentinels éš”é–‹ï¼Œç„¡æ³•æºé€šã€‚ é€™æ™‚ä¹Ÿä¸ç”¨æœƒæœ‰è¤‡æ•¸ failover ç”¢ç”Ÿï¼Œå› ç‚º quorum åªæœ‰ 3 sentinels çš„é€™ç«¯å¯ä»¥å–å¾—æˆæ¬Šï¼Œæ­£å¸¸åŸ·è¡Œ failover 2 sentinels çš„é€™é‚Šåªæœƒéœå¾…ç¶²è·¯å›å¾©ã€‚ HAProxy Failure é€™å€‹åœ¨ kubernetes ä¸Šä¹Ÿæ˜¯å¾ˆå¥½è§£æ±º\nHAProxy ä¸ç”¨çŸ¥é“å½¼æ­¤ï¼Œåªè¦èƒ½å¤ ç›£æ¸¬å¾Œç«¯æœå‹™ï¼Œä¸¦ä¸” proxy request å³å¯\næˆ‘å€‘å•Ÿå‹• HAProxy æ™‚æœƒä¸€æ¬¡å•Ÿå‹•å¤šå€‹ HAProxy\nHAProxy æ˜¯ç„¡ç‹€æ…‹çš„æœå‹™ï¼Œå¯ä»¥ç›´æ¥æ°´å¹³æ“´å±• (Horizontal Scale) ç®—æ˜¯æˆæœ¬çš„åœ°æ–¹ï¼Œå°±æ˜¯ HAProxy instance æœƒå„è‡ªå°å¾Œç«¯ redis åš tcp-checkï¼Œé »ç¹çš„ checkï¼Œé‚„æ˜¯æœƒæœ‰æˆæœ¬ï¼Œä½†ç›¸è¼ƒæ–¼ client request æ‡‰è©²æ˜¯æ¯”è¼ƒè¼• HAProxy æ˜¯é«˜æ•ˆèƒ½ï¼Œè€Œä¸”åªåš proxyï¼Œä¸€å¥”ä¾†èªªåªè¦ç¶­æŒæœ‰å¤šé¤˜çš„å‰¯æœ¬å‚™ç”¨å³å¯ï¼Œä¸ç”¨é–‹å¤ªå¤š Kubernetes æœƒè‡ªå‹•é€é stats portï¼Œå° HAPRoxy åš liveness checkï¼Œcheck å¤±æ•—å°±ä¸æœƒæŠŠæµé‡å°è¿‘ä¾†\nHAproxy å‰ç«¯çš„ kubernetes service æœƒè‡ªå‹• load balance client åˆ°æ­£å¸¸é‹ä½œçš„ HAProxy ä¸Š\nä¾‹å¦‚èµ·äº† 3 HAProxy\n3 HAProxy éƒ½å„è‡ªå‘ redis instance åš tcp-checkï¼Œæ¯ç§’ 3 * 3 çµ„ check\nå®¢æˆ¶ç«¯é€£å…¥ä»»ä¸€ HAProxyï¼Œéƒ½å¯ä»¥é€£å…¥æ­£ç¢ºçš„ master\nHAProxy åªè¦è‡³å°‘æœ‰ä¸€å€‹æ´»è‘—å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ­» 2 å€‹\nKubernetes service æœƒè‡ªå‹•å°å‘æ´»è‘—çš„ HAProxy\n2 HAPRoxy å›å¾©çš„æ™‚å€™ï¼Œå°±æ˜¯ HAProxy é‡å•Ÿå¾Œé‡æ–°é–‹å§‹æœå‹™\næ‹†åˆ† read write client ç”±æ–¼æ•ˆèƒ½ç“¶é ¸é‚„æ˜¯åœ¨ redis masterï¼Œç‚ºäº†èƒ½æ”¯æ’å¤ å¤š clientï¼Œæœ€å¥½æŠŠ client éœ€è¦è®€å¯«çš„æ‹†åˆ†é–‹ä¾†\nHAProxy çš„è¨­å®šï¼Œå°±æœƒéœ€è¦\næŠŠ frontend redis_gate æ‹†æˆ redis_slaves_gate: æ¥æ”¶è®€å–çš„ client redis_master_gate: æ¥æ”¶å¯«å…¥çš„ client æŠŠ redis_servers æ‹†æˆ redis_slaves: æ›´æ”¹ tcp-check å»æ‰¾ role:slave çš„ redisï¼Œæ‡‰è©²æœ‰å…©å° redis_master: ç¶­æŒæ‰¾å°‹ role:master çš„ redis é€™æ¨£å¯ä»¥è¼•æ˜“åœ°é€é scale slave ä¾†æ“´å¤§è®€å–çš„æµé‡å¸¶å¯¬\nRedis Cluster Intro çš„æ™‚å€™æœ‰æåˆ°ï¼Œredis cluster æ˜¯å¦ä¸€å€‹é¢å‘çš„ redis solutionã€‚\nä½¿ç”¨ redis cluster å°‡è³‡æ–™åš shardingï¼Œåˆ†æ•£åˆ°ä¸åŒç¾¤çµ„å…§ï¼Œpartitions ç”±è¤‡æ•¸çš„ master ä¾†å­˜å–\né€™éƒ¨ä»½æˆ‘å€‘ä¸‹å›å¾…çºŒ\n","permalink":"https://chechia.net/posts/2019-10-03-redis-ha-failure-recovery/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-28-redis-ha-deployment/\"\u003eä½¿ç”¨ helm éƒ¨ç½² redis-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-29-redis-ha-sentinel/\"\u003eRedis HA with sentinel\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-30-redis-ha-topology/\"\u003eRedis sentinel topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-02-redis-ha-on-haproxy/\"\u003eRedis HA with HAproxy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-03-redis-ha-failure-recovery/\"\u003eRedis HA Failure Recovery\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eFailure Case\u003c/li\u003e\n\u003cli\u003eRecovery\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"topology\"\u003eTopology\u003c/h1\u003e\n\u003cp\u003eä¸Šç¯‡çš„ä¾‹å­å®Œæˆæ‡‰è©²æ˜¯é€™æ¨£\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\n   +-------+   +--------+    +------------+    +---------+\n   |Clients|---|HAProxys|----|redis master|----|sentinels|\n   +-------+   +--------+    +------------+    +---------+\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eHAproxy ä½œç‚ºå¾Œç«¯ redis çš„ gateway\u003c/li\u003e\n\u003cli\u003eClient é€é HAproxy é€£å…¥ redis master\u003c/li\u003e\n\u003cli\u003esentinel è² è²¬ç›£æ¸¬ redis ç‹€æ…‹èˆ‡ failoverï¼Œåªæ˜¯ client ä¸å†é€é sentinel å»å–å¾— masterï¼Œè€Œæ˜¯é€é HAProxyã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé‚£ç¾åœ¨å°±ä¾†èŠèŠé€™äº›æœå‹™å¯èƒ½æ€éº¼æ­»çš„ï¼Œå›å¾©çš„æ©Ÿåˆ¶åˆæ˜¯å¦‚ä½•\u003c/p\u003e","title":"Redis Ha Failure Recovery"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ HAProxy Introduction Redis Sentinel with HAProxy HAProxy Intro HAproxy å…¨åæ˜¯ High Availability Proxyï¼Œæ˜¯ä¸€æ¬¾é–‹æº TCP/HTTP load balancerï¼Œä»–å¯ä»¥\nè½ tcp socketï¼Œé€£ serverï¼Œç„¶å¾ŒæŠŠ socket æ¥åœ¨ä¸€èµ·è®“é›™å‘æµé€š å¯åš Http reverse-proxy (Http gateway)ï¼Œè‡ªå·±ä½œç‚ºä»£ç† serverï¼ŒæŠŠæ¥å—åˆ°çš„ connection å‚³åˆ°å¾Œç«¯çš„ serverã€‚ SSL çµ‚ç«¯ï¼Œå¯æ”¯æ´ client-side èˆ‡ server-side çš„ ssl/tls ç•¶ tcp/http normalizer æ›´æ”¹ http çš„ request èˆ‡ response ç•¶ switchï¼Œæ±ºå®š request å¾Œé€çš„ç›®æ¨™ åš load balancerï¼Œç‚ºå¾Œç«¯ server åšè² è¼‰å‡è¡¡ èª¿ç¯€æµé‡ï¼Œè¨­å®š rate limitï¼Œæˆ–æ˜¯æ ¹æ“šå…§å®¹èª¿æ•´æµé‡ HAProxy é‚„æœ‰å…¶ä»–éå¸¸å¤šçš„åŠŸèƒ½ï¼Œæƒ³äº†è§£ç´°ç¯€å¯ä»¥ä¾†çœ‹åŸç†è§£èªªæ–‡ä»¶\nTopology æˆ‘å€‘ä»Šå¤©çš„ç¯„ä¾‹æ˜¯åœ¨å¾Œç«¯çš„ redis èˆ‡ clients ä¸­é–“å¤šæ”¾ä¸€å±¤ HAProxys\n+-------+ +--------+ +------------+ +---------+ |Clients|---|HAProxys|----|redis master|----|sentinels| +-------+ +--------+ +------------+ +---------+ å¯èƒ½æœ‰äººæœƒå•èªªï¼Œé‚£å‰å…©å¤©è¬›çš„ redis sentinelï¼Œè·‘å»å“ªè£¡äº†ã€‚\nsentinel é‚„åœ¨æ­£å¸¸é‹ä½œï¼Œè² è²¬ç›£æ¸¬ redis ç‹€æ…‹èˆ‡ failoverï¼Œåªæ˜¯ client ä¸å†é€é sentinel å»å–å¾— masterï¼Œè€Œæ˜¯é€é HAProxyã€‚\nDeploy HAProxy æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½åœ¨é€™äº†https://github.com/chechiachang/haproxy-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash # redis-db-credentials should already exists #kubectl create secret generic redis-db-credentials \\ --from-literal=REDIS_PASSWORD=123456 # Update haproxy.cfg as configmap kubectl create configmap haproxy-config \\ --from-file=haproxy.cfg \\ --output yaml \\ --dry-run | kubectl apply -f - kubectl apply -f deployment.yaml kubectl apply -f service.yaml é€™é‚Šåšçš„äº‹æƒ…æœ‰å¹¾ä»¶\nå–å¾— redis çš„ auth REDIS_PASSWORD æ”¾åœ¨ secret ä¸­ï¼Œå¦‚æœå‰é¢æ˜¯ç…§æˆ‘å€‘çš„ç¯„ä¾‹ï¼Œé‚£éƒ½å·²ç¶“è¨­å®šäº† æŠŠ haproxy.cfg çš„è¨­å®šæª”ï¼Œä½¿ç”¨ configmap çš„æ–¹å¼æ”¾åˆ° kubernetes ä¸Š éƒ¨å±¬ HAProxy deployment éƒ¨å±¬ HAProxy service ç°¡å–®çœ‹ä¸€ä¸‹ deployment\napiVersion: apps/v1beta1 kind: Deployment metadata: name: haproxy spec: replicas: 3 template: metadata: labels: app: haproxy app.kubernetes.io/name: haproxy component: haproxy spec: volumes: - name: haproxy-config configMap: name: haproxy-config affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: \u0026quot;app\u0026quot; operator: \u0026quot;In\u0026quot; values: - \u0026quot;haproxy\u0026quot; topologyKey: kubernetes.io/hostname containers: - name: haproxy image: haproxy:2.0.3-alpine command: [\u0026quot;haproxy\u0026quot;, \u0026quot;-f\u0026quot;, \u0026quot;/usr/local/etc/haproxy/config/haproxy.cfg\u0026quot;] readinessProbe: initialDelaySeconds: 15 periodSeconds: 5 timeoutSeconds: 1 successThreshold: 2 failureThreshold: 2 tcpSocket: port: 26999 port: 6379 volumeMounts: - name: haproxy-config mountPath: /usr/local/etc/haproxy/config resources: requests: cpu: 10m memory: 30Mi env: - name: REDIS_PASSWORD valueFrom: secretKeyRef: name: redis-db-credentials key: REDIS_PASSWORD ports: - containerPort: 8000 name: http - containerPort: 9000 name: https - containerPort: 26999 name: stats - containerPort: 6379 name: redis Replicas: 3 ï¼Œé–‹èµ·ä¾†æ˜¯ä¸‰å€‹ HAProxy podAntiAffinityï¼Œä¸‰å€‹åˆ†å¸ƒåˆ°ä¸åŒ node ä¸Šï¼Œç›¡é‡ç¶­æŒ HA readinessProbeï¼Œç­‰ tcpSocket 26999 (HAProxy Stats) èˆ‡ 6370 (Redis Proxy) é€šäº†æ‰ READY æŠŠ redis password æ›é€²å» æŠŠ haproxy.cfg æ›é€²å» é–‹å¹¾å€‹ port çœ‹ä¸€ä¸‹ service\nkind: Service apiVersion: v1 metadata: name: haproxy-service spec: sessionAffinity: ClientIP sessionAffinityConfig: clientIP: timeoutSeconds: 10800 # 3 hr selector: app: haproxy ports: - name: http protocol: TCP port: 8000 - name: https protocol: TCP port: 9000 - name: stats protocol: TCP port: 26999 - name: redis protocol: TCP port: 6379 - name: redis-exporter protocol: TCP port: 8404 å¾ˆå–®ç´”ï¼Œå°±æ˜¯æŠŠå¹¾å€‹ port æ¥å‡ºä¾† æŠŠ sessionAffinity é–‹èµ·ä¾† é€™é‚Šå¸Œæœ›ä¾†è‡ªç›¸åŒ clientIP (kubernetes å…§éƒ¨ app clients) çš„ session èƒ½æŒçºŒèµ°åŒä¸€å€‹ server å¯ä»¥é™ä½é€²åˆ° service å¾€å¾Œé€åˆ°ä¸€ç›´é‡é€£æµªè²»è³‡æº ä½†ä¸€ç›´é€£è‘—ä¹Ÿä¸å¥½ï¼Œå¯èƒ½æœƒ connection not closed ä¸€ç›´ä½”è‘— HAProxy1 HAProxy2 HAProxy3ï¼Œä¸Šæ¬¡ Client1 é€£ HAProxy1ï¼Œservice ä¹Ÿç›¡é‡è®“ä½ ä¸‹å€‹ request ä¹Ÿèµ° HAPRoxy1 kubectl get po | grep haproxy haproxy-56d94f857f-gmd4s 1/1 Running 0 47d haproxy-56d94f857f-p2vj6 1/1 Running 0 47d haproxy-56d94f857f-vhz8b 1/1 Running 0 47d HAProxy Config çœ‹ä¸€ä¸‹ haproxy.cfg\n# https://cbonte.github.io/haproxy-dconv/2.0/configuration.html # https://github.com/prometheus/haproxy_exporter # https://www.haproxy.com/blog/haproxy-exposes-a-prometheus-metrics-endpoint/ # curl http://localhost:8404/metrics # curl http://localhost:8404/stats frontend stats mode http timeout client 30s bind *:8404 option http-use-htx http-request use-service prometheus-exporter if { path /metrics } stats enable stats uri /stats stats refresh 10s # Redis frontend redis_gate mode tcp timeout client 7d bind 0.0.0.0:6379 name redis default_backend redis_servers backend redis_servers mode tcp timeout connect 3s timeout server 7d option tcp-check tcp-check connect tcp-check send AUTH\\ \u0026quot;${REDIS_PASSWORD}\u0026quot;\\r\\n tcp-check send PING\\r\\n tcp-check expect string PONG tcp-check send info\\ replication\\r\\n tcp-check expect string role:master tcp-check send QUIT\\r\\n tcp-check expect string +OK server R1 redis-2-redis-ha-announce-0:6379 check inter 1s server R2 redis-2-redis-ha-announce-1:6379 check inter 1s server R3 redis-2-redis-ha-announce-2:6379 check inter 1s å…©å€‹ frontendï¼Œåƒå‰ç«¯ (client) ä¾†çš„ request frontend stats æ˜¯ HAProxy æœ¬èº«æœå‹™çš„ stats æŠŠ prometheus-exporter é–‹èµ·ä¾†ï¼Œè®“ prometheus é€²ä¾† scrape metrics frontend redis_gate æ˜¯ç”¨ä¾†æœå‹™ redis client é‚è¼¯å¾ˆç°¡å–®ï¼Œé€²ä¾†çš„ request å¾€æœ‰æ•ˆçš„ backend redis_server é€ï¼Œé€™é‚Šçš„æœ‰æ•ˆæŒ‡çš„æ˜¯ redis master timeout 7dï¼Œå› ç‚ºæˆ‘å€‘çš„æœå‹™æœ‰é•·æ™‚é–“ä¸é–“æ–·çš„ pubsubï¼Œå¯ä»¥è¦–éœ€æ±‚èª¿æ•´ ä¸€å€‹ backendï¼ŒHAProxy æœƒç¶­è­·ä¸¦ç›£æ¸¬ç‹€æ…‹ï¼Œç„¶å¾ŒæŠŠ frontend proxy éå» mode tcpï¼Œä½¿ç”¨ tcp å» probe option tcp-checkï¼Œä¸‹é¢æ˜¯ä¸€ä¸² tcp checklistï¼Œé…åˆ redis çš„ tcp auth protocol å»å–å¾— tcp connect é€£ä¸Š send AUTH å¯†ç¢¼ åˆ° redis send pingï¼Œredis è¦å› pong send info replication ç›´æ¥æ‰“ redis tcp info API é æœŸ string å…§æœ‰ role:master æ„æ€æ˜¯é€™å° redis æ˜¯ master é€€å‡ºï¼Œredis è¦å› ok server æœ‰ä¸‰å°ï¼Œé€é redis å„è‡ªçš„ ha-announce service å»æ‰“ HAProxy æœƒç¶­è­· backend çš„ proxy statsï¼Œæ‰¾åˆ°ä¸‰å° redis ä¸­ï¼Œæ˜¯ master çš„é€™å°\nRunning Log\nkubectl logs -f haproxy-123-123456789 [WARNING] 273/153936 (1) : Server redis_servers/R2 is DOWN, reason: Layer7 timeout, info: \u0026quot; at step 6 of tcp-check (expect string 'role:master')\u0026quot;, check duration: 1000ms. 2 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue. [WARNING] 273/153937 (1) : Server redis_servers/R3 is DOWN, reason: Layer7 timeout, info: \u0026quot; at step 6 of tcp-check (expect string 'role:master')\u0026quot;, check duration: 1001ms. 1 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue. HAProxy å» redis å•ï¼Œä½ æ˜¯ master å—ï¼Œå…©å€‹äººå›ä¸æ˜¯ï¼Œåªæœ‰ä¸€å€‹å› role:masterï¼Œæ‰€ä»¥æŠŠ client å°éå»\nHAProxy vs Sentinel Client ä¸ç”¨çŸ¥é“ä¸­é–“çš„ proxyï¼Œåªè¦çŸ¥é“é€é HAproxy service å°±æœƒè¢« proxy åˆ° master HAproxy æ˜¯ statelessï¼Œéå¸¸å¥½ scale Client ä¸ç”¨æ”¯æ´ sentinelï¼Œåªè¦ä¸€èˆ¬çš„ redis-cli å°±å¯ä»¥é€£å…¥ ","permalink":"https://chechia.net/posts/2019-10-02-redis-ha-on-haproxy/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-28-redis-ha-deployment/\"\u003eä½¿ç”¨ helm éƒ¨ç½² redis-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-29-redis-ha-sentinel/\"\u003eRedis HA with sentinel\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-30-redis-ha-topology/\"\u003eRedis sentinel topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-02-redis-ha-on-haproxy/\"\u003eRedis HA with HAproxy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-03-redis-ha-failure-recovery/\"\u003eRedis HA Failure Recovery\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eHAProxy Introduction\u003c/li\u003e\n\u003cli\u003eRedis Sentinel with HAProxy\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"haproxy-intro\"\u003eHAProxy Intro\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"http://www.haproxy.org/#docs\"\u003eHAproxy\u003c/a\u003e å…¨åæ˜¯ High Availability Proxyï¼Œæ˜¯ä¸€æ¬¾é–‹æº TCP/HTTP load balancerï¼Œä»–å¯ä»¥\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè½ tcp socketï¼Œé€£ serverï¼Œç„¶å¾ŒæŠŠ socket æ¥åœ¨ä¸€èµ·è®“é›™å‘æµé€š\u003c/li\u003e\n\u003cli\u003eå¯åš Http reverse-proxy (Http gateway)ï¼Œè‡ªå·±ä½œç‚ºä»£ç† serverï¼ŒæŠŠæ¥å—åˆ°çš„ connection å‚³åˆ°å¾Œç«¯çš„ serverã€‚\u003c/li\u003e\n\u003cli\u003eSSL çµ‚ç«¯ï¼Œå¯æ”¯æ´ client-side èˆ‡ server-side çš„ ssl/tls\u003c/li\u003e\n\u003cli\u003eç•¶ tcp/http normalizer\u003c/li\u003e\n\u003cli\u003eæ›´æ”¹ http çš„ request èˆ‡ response\u003c/li\u003e\n\u003cli\u003eç•¶ switchï¼Œæ±ºå®š request å¾Œé€çš„ç›®æ¨™\u003c/li\u003e\n\u003cli\u003eåš load balancerï¼Œç‚ºå¾Œç«¯ server åšè² è¼‰å‡è¡¡\u003c/li\u003e\n\u003cli\u003eèª¿ç¯€æµé‡ï¼Œè¨­å®š rate limitï¼Œæˆ–æ˜¯æ ¹æ“šå…§å®¹èª¿æ•´æµé‡\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHAProxy é‚„æœ‰å…¶ä»–éå¸¸å¤šçš„åŠŸèƒ½ï¼Œæƒ³äº†è§£ç´°ç¯€å¯ä»¥ä¾†çœ‹\u003ca href=\"http://cbonte.github.io/haproxy-dconv/1.9/intro.html#3\"\u003eåŸç†è§£èªªæ–‡ä»¶\u003c/a\u003e\u003c/p\u003e","title":"Redis Ha HAProxy"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Redis Sentinel Topology Topology Masters: M1, M2, M3, \u0026hellip;, Mn. Slaves: R1, R2, R3, \u0026hellip;, Rn (R stands for replica). Sentinels: S1, S2, S3, \u0026hellip;, Sn. Clients: C1, C2, C3, \u0026hellip;, Cn. æ¯å€‹æ–¹æ ¼ä»£è¡¨ä¸€å°æ©Ÿå™¨æˆ–æ˜¯ VM 2 Sentinels DON\u0026rsquo;T DO THIS\n+----+ +----+ | M1 |---------| R1 | | S1 | | S2 | +----+ +----+ Configuration: quorum = 1 é€™å€‹è¨­å®šä¸‹ï¼Œå¦‚æœ M1 æ›äº†éœ€è¦ failoverï¼Œå¾ˆæœ‰å¯èƒ½ S1 è·Ÿè‘—æ©Ÿå™¨ä¸€èµ·æ›äº†ï¼ŒS2 æœƒæ²’æœ‰è¾¦æ³•å–å¾—å¤šæ•¸ä¾†åŸ·è¡Œ failoverï¼Œæ•´å€‹ç³»çµ±æ›æ‰\n3 VM +----+ | M1 | | S1 | +----+ | +----+ | +----+ | R2 |----+----| R3 | | S2 | | S3 | +----+ +----+ Configuration: quorum = 2 é€™æ˜¯æœ€åŸºæœ¬çš„è›‹åˆå…¼é¡§å®‰å…¨è¨­å®šçš„è¨­ç½®\nå¦‚æœ M1 æ­»äº† S1 è·Ÿè‘—æ©Ÿå™¨æ•…éšœï¼ŒS2 èˆ‡ S3 é‚„å¯ä»¥å–å¾—å¤šæ•¸ï¼Œé †åˆ© failover åˆ° R2 æˆ–æ˜¯ R3ã€‚\nå¯«å…¥è³‡æ–™éºå¤± +----+ | M1 | | S1 | \u0026lt;- C1 (writes will be lost) +----+ | / / +------+ | +----+ | [M2] |----+----| R3 | | S2 | | S3 | +------+ +----+ failover ä¹‹å‰ï¼ŒM1 æ˜¯ masterï¼ŒClient çš„å¯«å…¥å¾€ M1 å¯« M1 ç¶²è·¯æ•…éšœï¼ŒM2 failover å¾Œæˆç‚ºæ–°çš„ masterï¼Œå¯æ˜¯ Client å¾€ M1 å¯«å…¥çš„è³‡æ–™ä¸¦ç„¡æ³• sync å› M2 ç­‰ç¶²è·¯ä¿®å¾©å¾Œï¼ŒM1 å›è¦†å¾Œæœƒè®Šæˆ R1 è®Šæˆ slaveï¼Œç”± M2 å» sync R1ï¼Œè®Šæˆ R1 åœ¨ master æ™‚æ”¶åˆ°çš„å¯«å…¥è³‡æ–™éºå¤± ç‚ºäº†é¿å…é€™ç¨®æƒ…å½¢ï¼Œåšé¡å¤–çš„è¨­å®š\nmin-slaves-to-write 1 min-slaves-max-lag 10 ç•¶ master ç™¼ç¾è‡ªå·±å†ä¹Ÿç„¡æ³• sync åˆ°è¶³å¤ çš„ slaveï¼Œè¡¨ç¤º master å¯èƒ½è¢«å­¤ç«‹ï¼Œé€™æ™‚ä¸»å‹•æ‹’çµ•å®¢æˆ¶ç«¯çš„å¯«å…¥è«‹æ±‚ã€‚å®¢æˆ¶ç«¯è¢«æ‹’çµ•å¾Œï¼Œæœƒå†å‘ sentinel å–å¾—æœ‰æ•ˆçš„ masterï¼Œé‡æ–°åŸ·è¡Œå¯«å…¥è«‹æ±‚ï¼Œç¢ºä¿è³‡æ–™å¯«åˆ°æœ‰æ•ˆçš„ master ä¸Šã€‚\nSentinel æ”¾åœ¨ Client ç«¯ +----+ +----+ | M1 |----+----| R1 | | | | | | +----+ | +----+ | +------------+------------+ | | | | | | +----+ +----+ +----+ | C1 | | C2 | | C3 | | S1 | | S2 | | S3 | +----+ +----+ +----+ æœ‰äº›æƒ…å½¢ï¼Œredis é€™ç«¯åªæœ‰å…©å°å¯ç”¨æ©Ÿå™¨ï¼Œé€™ç¨®æƒ…å½¢å¯ä»¥è€ƒæ…®æŠŠ sentinel æ”¾åœ¨å®¢æˆ¶ç«¯çš„æ©Ÿå™¨ä¸Š\nä»ç„¶ç¶­æŒäº†ç¨ç«‹çš„ 3 sentinels çš„ç©©å®š sentinel èˆ‡ client æ‰€è§€å¯Ÿåˆ°çš„ redis ç‹€æ…‹æ˜¯ç›¸åŒçš„ å¦‚æœ M1 æ­»äº†ï¼Œè¦ failover ï¼Œå®¢æˆ¶ç«¯çš„ 3 sentinel å¯ä»¥æ­£ç¢ºåœ°åŸ·è¡Œ failoverï¼Œä¸å—æ•…éšœå½±éŸ¿ å®¢æˆ¶ç«¯åˆä¸è¶³ 3 å€‹ +----+ +----+ | M1 |----+----| R1 | | S1 | | | S2 | +----+ | +----+ | +------+-----+ | | | | +----+ +----+ | C1 | | C2 | | S3 | | S4 | +----+ +----+ Configuration: quorum = 3 +----+ +----+ | M1 |----+----| R1 | | S1 | | | S2 | +----+ | +----+ | | | +----+ | C1 | | S3 | +----+ Configuration: quorum = 2 è·Ÿä¸Šå€‹ä¾‹å­é¡ä¼¼ï¼Œä½†åˆé¡å¤–ç¢ºä¿ 3 sentinels å¦‚æœ M1 æ­»äº†ï¼Œå‰©ä¸‹çš„ sentinel å¯ä»¥æ­£ç¢º failover ","permalink":"https://chechia.net/posts/2019-09-30-redis-ha-topology/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-28-redis-ha-deployment/\"\u003eä½¿ç”¨ helm éƒ¨ç½² redis-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-29-redis-ha-sentinel/\"\u003eRedis HA with sentinel\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-30-redis-ha-topology/\"\u003eRedis sentinel topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-02-redis-ha-on-haproxy/\"\u003eRedis HA with HAproxy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-03-redis-ha-failure-recovery/\"\u003eRedis HA Failure Recovery\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eRedis Sentinel Topology\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"topology\"\u003eTopology\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eMasters: M1, M2, M3, \u0026hellip;, Mn.\u003c/li\u003e\n\u003cli\u003eSlaves: R1, R2, R3, \u0026hellip;, Rn (R stands for replica).\u003c/li\u003e\n\u003cli\u003eSentinels: S1, S2, S3, \u0026hellip;, Sn.\u003c/li\u003e\n\u003cli\u003eClients: C1, C2, C3, \u0026hellip;, Cn.\u003c/li\u003e\n\u003cli\u003eæ¯å€‹æ–¹æ ¼ä»£è¡¨ä¸€å°æ©Ÿå™¨æˆ–æ˜¯ VM\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"2-sentinels\"\u003e2 Sentinels\u003c/h3\u003e\n\u003cp\u003eDON\u0026rsquo;T DO THIS\u003c/p\u003e","title":"Redis Ha Topology"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ redis-sentinel redis sentinel èˆ‡ redis ä½¿ç”¨ç›¸å®¹çš„ apiï¼Œç›´æ¥ä½¿ç”¨ redis-cli é€é 26479 port é€£å…¥ï¼Œå¯ä»¥é€£åˆ° sentinelï¼Œé€é sentinel å¯ä»¥å–å¾— redis master çš„ç‹€æ…‹èˆ‡é€£ç·šè¨­å®šã€‚\nredis-cli -h redis-redis-ha -p 26479 ä¸Šç¯‡æˆ‘å€‘çš„ redis-ha å®‰è£å®Œè®Šé€™æ¨£\n$ kubectl get po | grep redis NAME READY STATUS RESTARTS AGE redis-1-redis-ha-server-0 3/3 Running 0 3d4h redis-1-redis-ha-server-1 3/3 Running 0 3d5h redis-1-redis-ha-server-2 3/3 Running 0 3d4h æœ‰ä¸‰å€‹ Podï¼Œè£¡é¢éƒ½æ˜¯ä¸€å€‹ redis, sentinel, è·Ÿ exporterï¼Œé€™ç¯‡æ–‡ç« æœƒå°ˆæ³¨è¬› sentinel çš„åŠŸèƒ½èˆ‡æ©Ÿåˆ¶\nRedis Sentinel redis-sentinel ç‚º Redis æä¾›é«˜å¯ç”¨æœå‹™ï¼Œå¯¦å‹™ä¸Šå¯ä»¥é€é sentinel åœ¨éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œè‡ªå‹•é€²è¡Œ failoverã€‚é™¤æ­¤ä¹‹å¤– sentinel ä¹Ÿæä¾›ç›£æ¸¬ï¼Œé€šçŸ¥ï¼Œèˆ‡ redis çš„è¨­å®šã€‚\nMonitoring: æŒçºŒæª¢æ¸¬ master èˆ‡ slave instances çš„ç‹€æ…‹ Notification: æœ‰äº‹ä»¶ç™¼ç”Ÿå¯ä»¥ç™¼å‡ºé€šçŸ¥ Automatic failover: å¦‚æœ master å¤±æ•ˆè‡ªå‹•å•Ÿå‹• failover ç¨‹åºï¼Œå°‡ä¸€å€‹ slave æŒ‡æ’ç‚º masterï¼Œä¸¦è¨­å®šå…¶ä»– slave ä½¿ç”¨æ–°çš„ master Configuration provider: ç‚ºå®¢æˆ¶ç«¯æä¾› service discoveryï¼Œå®¢æˆ¶å¯ä»¥é€šé sentinel å–å¾— master çš„é€£ç·šè³‡æ–™ã€‚ Distributed Sentinel æœ¬èº«æ˜¯ä¸€å€‹åˆ†æ•£å¼ç³»çµ±ï¼Œå¦‚æˆ‘å€‘çš„ç¯„ä¾‹æ‰€ç¤ºï¼Œä¸‰å€‹ Pod ç«‹é¢å€‹å«æœ‰ä¸€å€‹ sentinelï¼Œçµ„æˆ 3 å€‹ instace çš„ sentinel clusterã€‚\néŒ¯èª¤æª¢æ¸¬æ˜¯ç”±å¤šå€‹ sentinel åˆ¤å®šï¼Œè¦æœ‰å¤šå€‹ sentinel éƒ½æ¥æ”¶ master å·²å¤±æ•ˆçš„è¨Šæ¯ï¼Œæ‰æœƒåˆ¤å®šæˆå¤±æ•ˆã€‚é€™æ¨£å¯ä»¥é™ä½ false positive çš„æ©Ÿç‡ã€‚ åˆ†æ•£è®“ sentinel æœ¬èº«ä¹Ÿå…·å‚™é«˜å¯ç”¨æ€§ï¼Œå¯ä»¥æ‰¿å—ä¸€å®šç¨‹åº¦çš„éŒ¯èª¤ã€‚ç”¨ä¾† fail over çš„ç³»çµ±ï¼Œä¸èƒ½å› ç‚ºè‡ªèº«çš„å–®é»éŒ¯èª¤(single point failure) è€Œå€’æ˜¯æ•´å€‹ redis å¤±æ•ˆã€‚ Fundamental ä¸€å€‹è€ç”¨çš„ sentinel éœ€è¦è‡³å°‘ä¸‰å€‹ instance æœ€å¥½æŠŠ instance åˆ†æ•£åœ¨å¤šå€‹ç¨ç«‹çš„éš”é›¢å€åŸŸï¼Œæ„æ€æ˜¯èªªï¼Œä¸‰å€‹ä¸æœƒæ”¾åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šï¼Œæˆ–æ˜¯æ”¾åœ¨åŒä¸€å€‹å€åŸŸå…§ï¼Œå› ç‚ºä¸€å€‹å€åŸŸç¶²è·¯æ•…éšœå°±å…¨æ­»ã€‚ app ä½¿ç”¨ sentinel çš„è©±ï¼Œå®¢æˆ¶ç«¯è¦æ”¯æ´ æœ‰æ™‚å¸¸æ¸¬è©¦çš„ HA ç’°å¢ƒï¼Œæ‰æ˜¯æœ‰æ•ˆçš„ HA Configuration Sentinel specific configuration options åœ¨ä¸Šç¯‡æˆ‘å€‘è·³é sentinel çš„è¨­å®šï¼Œé€™é‚Šèªªæ˜ä¸€ä¸‹\nsentinel: port: 26379 quorum: 2 config: ## Additional sentinel conf options can be added below. Only options that ## are expressed in the format simialar to 'sentinel xxx mymaster xxx' will ## be properly templated. ## For available options see http://download.redis.io/redis-stable/sentinel.conf down-after-milliseconds: 10000 ## Failover timeout value in milliseconds failover-timeout: 180000 parallel-syncs: 5 ## Custom sentinel.conf files used to override default settings. If this file is ## specified then the sentinel.config above will be ignored. # customConfig: |- # Define configuration here resources: {} # requests: # memory: 200Mi # cpu: 100m # limits: # memory: 200Mi Quorum quorum æ˜¯æ¯æ¬¡ç¢ºå®š master å¤±æ•ˆæ™‚ï¼Œéœ€è¦é”æˆå…±è­˜çš„ sentinel æ•¸é‡ã€‚ Quorum ä½¿ç”¨åœ¨éŒ¯èª¤æª¢æ¸¬ï¼Œç¢ºå®šéŒ¯èª¤çœŸçš„ç™¼ç”Ÿå¾Œï¼Œsentinel æœƒä»¥å¤šæ•¸æ±º(majority) çš„æ–¹å¼é¸å‡º sentinel leaderï¼Œè®“ leader è™•ç† failoverã€‚ ä»¥æˆ‘å€‘çš„ä¾‹å­ç‚ºä¾‹ï¼Œç¸½å…±ä¸‰å€‹ï¼Œç¢ºèª master æ­»æ‰åªè¦å…©å€‹ sentinel é”æˆå…±è­˜å³å¯å•Ÿå‹• failover ç¨‹åºã€‚å¯ä»¥ç›´æ¥æ¸¬è©¦ä¸€ä¸‹ã€‚\nkubectl logs -f redis-1-redis-ha-server-0 kubectl delete po redis-1-redis-ha-server-1 log ä¸€å€‹ Pod ï¼Œç„¶å¾Œç›´æ¥æŠŠå¦ä¸€å€‹ Pod å¹¹æ‰ é€™æ¨£æœƒæœ‰ 1/3 çš„æ©Ÿç‡ç åˆ° masterï¼Œç ä¸­çš„è©±å¯ä»¥çœ‹åˆ° redis failover ï¼Œé¸å‡ºæ–°çš„ master çš„éç¨‹ã€‚\né€™é‚Šè¦æ³¨æ„ï¼Œç”±æ–¼æˆ‘å€‘çš„ sentinel èˆ‡ redis æ˜¯æ”¾åœ¨åŒæ¨£ä¸€å€‹ Podï¼Œå¹¹æ‰çš„åŒæ™‚ä¹Ÿæ®ºäº†ä¸€å€‹ sentinelï¼Œåªå‰© 2 å€‹ï¼Œå‰›å¥½é”æˆå…±è­˜ã€‚å¦‚æœ quorum æ˜¯ä¸‰ï¼Œå°±è¦ç­‰ç¬¬ä¸‰å€‹ sentinel å›ä¾†æ‰èƒ½å–å¾— quorumã€‚\nsentinel èˆ‡ redis çš„é…ç½®ä½ç½®ï¼Œä¹‹å¾Œçš„ topology æœƒè¨è«–ã€‚\nConfigurations down-after-milliseconds: è¶…éå¤šå°‘æ™‚é–“æ²’å›æ‡‰ ping æˆ–æ­£ç¢ºå›æ‡‰ï¼Œæ‰è¦ºå¾— master å£äº† parallel-syncs: failover æ™‚ï¼Œè¦é‡æ–°èˆ‡æ–° master sync çš„ slave æ•¸é‡ã€‚æ•¸é‡è¶Šå¤š sync æ™‚é–“å°±è¶Šä¹…ï¼Œæ•¸é‡å°‘å°±æœ‰è¼ƒå¤š slave æ²’ sync è³‡æ–™ï¼Œå¯èƒ½æœƒè®“ client read åˆ°èˆŠçš„è³‡æ–™ é›–ç„¶ sync æ˜¯ non-blockingÂ ï¼Œä½†åœ¨ sync å¤§ç­†è³‡æ–™æ™‚ï¼Œslave å¯èƒ½æœƒæ²’æœ‰å›æ‡‰ã€‚è¨­å®šç‚º 1 çš„è©±ï¼Œæœ€å¤šåªæœƒæœ‰ä¸€å€‹ slave ä¸‹ç·š syncã€‚ é€™äº›åƒæ•¸ä¹Ÿå¯ä»¥é€é redis-cli ç›´æ¥é€£å…¥æ›´æ”¹ï¼Œä½†æˆ‘å€‘æ˜¯åœ¨ kubernetes ä¸Šè·‘ï¼Œè‡¨æ™‚çš„æ›´æ”¹ä¸æ˜“ä¿å­˜ï¼Œæ‰€ä»¥ç›¡å¯èƒ½æŠŠé€™äº›configurations æ”¾åœ¨ configmap è£¡é¢ã€‚\nSentinel command 6379 port é€£å…¥ redisï¼Œ26379 é€£å…¥ redis sentinelã€‚éƒ½æ˜¯ä½¿ç”¨ redis-cliï¼Œå…©è€…å…¼å®¹çš„ protocolã€‚\n# ä½¿ç”¨ kubectl é€£å…¥ï¼Œå¤šå€‹ container è¦æ˜ç¢ºæŒ‡å‡ºé€£å…¥çš„ container kubectl exec -it redis-1-redis-ha-server-0 --container redis sh redis-cli -h redis-redis-ha -p 26479 # è¿‘ä¾†å…ˆ ping ä¸€ä¸‹ $ ping PONG # åˆ—å‡ºæ‰€æœ‰ master çš„è³‡è¨Šï¼Œä»¥åŠè¨­å®šè³‡è¨Š sentinel master redis-2-redis-ha:26379\u0026gt; sentinel masters 1) 1) \u0026quot;name\u0026quot; 2) \u0026quot;mymaster\u0026quot; 3) \u0026quot;ip\u0026quot; 4) \u0026quot;10.15.242.245\u0026quot; 5) \u0026quot;port\u0026quot; 6) \u0026quot;6379\u0026quot; 7) \u0026quot;runid\u0026quot; 8) \u0026quot;63a97460b7c3745577931dad406df9609c4e2464\u0026quot; 9) \u0026quot;flags\u0026quot; 10) \u0026quot;master\u0026quot; 11) \u0026quot;link-pending-commands\u0026quot; 12) \u0026quot;0\u0026quot; 13) \u0026quot;link-refcount\u0026quot; 14) \u0026quot;1\u0026quot; 15) \u0026quot;last-ping-sent\u0026quot; 16) \u0026quot;0\u0026quot; 17) \u0026quot;last-ok-ping-reply\u0026quot; 18) \u0026quot;479\u0026quot; 19) \u0026quot;last-ping-reply\u0026quot; 20) \u0026quot;479\u0026quot; 21) \u0026quot;down-after-milliseconds\u0026quot; 22) \u0026quot;5000\u0026quot; 23) \u0026quot;info-refresh\u0026quot; 24) \u0026quot;5756\u0026quot; 25) \u0026quot;role-reported\u0026quot; 26) \u0026quot;master\u0026quot; 27) \u0026quot;role-reported-time\u0026quot; 28) \u0026quot;348144787\u0026quot; 29) \u0026quot;config-epoch\u0026quot; 30) \u0026quot;13\u0026quot; 31) \u0026quot;num-slaves\u0026quot; 32) \u0026quot;2\u0026quot; 33) \u0026quot;num-other-sentinels\u0026quot; 34) \u0026quot;2\u0026quot; 35) \u0026quot;quorum\u0026quot; 36) \u0026quot;2\u0026quot; 37) \u0026quot;failover-timeout\u0026quot; 38) \u0026quot;180000\u0026quot; 39) \u0026quot;parallel-syncs\u0026quot; 40) \u0026quot;5\u0026quot; # å–å¾—é›†ç¾¤ä¸­çš„ master è¨Šæ¯ï¼Œç›®å‰æœ‰ä¸€å€‹ master $ sentinel master mymaster # å–å¾—é›†ç¾¤ä¸­çš„ slaves è¨Šæ¯ï¼Œç›®å‰æœ‰å…©å€‹ slave $ sentinel slaves mymaster # å–å¾—é›†ç¾¤ä¸­çš„ master è¨Šæ¯ $ sentinel sentinels mymaster # æª¢æŸ¥ sentinel çš„ quorum $ sentinel ckquorum mymaster OK 3 usable Sentinels. Quorum and failover authorization can be reached # å¼·è¿«è§¸ç™¼ä¸€æ¬¡ failover sentinel failover mymaster Sentinel Connection æœ‰æ”¯æ´çš„å®¢æˆ¶ç«¯è¨­å®šï¼Œä»¥Golang FZambia/sentinel ç‚ºä¾‹ï¼Œé€é sentinel å–å¾— redis-poolã€‚\n# ä½¿ç”¨ç¨ç«‹çš„ pod service é€£å…¥ sentinelï¼Œå”åŠ©å½¼æ­¤è­˜åˆ¥ sntnl := \u0026amp;sentinel.Sentinel{ Addrs: []string{\u0026quot;redis-2-redis-ha-announce-0:26379\u0026quot;, \u0026quot;redis-2-redis-ha-announce-0:26379\u0026quot;, \u0026quot;redis-2-redis-ha-announce-0:26379\u0026quot;}, MasterName: \u0026quot;mymaster\u0026quot;, Dial: func(addr string) (redis.Conn, error) { timeout := 500 * time.Millisecond c, err := redis.DialTimeout(\u0026quot;tcp\u0026quot;, addr, timeout, timeout, timeout) if err != nil { return nil, err } return c, nil }, } # ç”¢ç”Ÿ connection pool return \u0026amp;redis.Pool{ MaxIdle: 3, MaxActive: 64, Wait: true, IdleTimeout: 240 * time.Second, Dial: func() (redis.Conn, error) { # é€é sentinel å–å¾— master addressï¼Œå¦‚æœ master æ­»äº†ï¼Œå†åŸ·è¡Œå¯ä»¥æ‹¿åˆ°æ–°çš„ master masterAddr, err := sntnl.MasterAddr() if err != nil { return nil, err } c, err := redis.Dial(\u0026quot;tcp\u0026quot;, masterAddr) if err != nil { return nil, err } return c, nil }, TestOnBorrow: func(c redis.Conn, t time.Time) error { if !sentinel.TestRole(c, \u0026quot;master\u0026quot;) { return errors.New(\u0026quot;Role check failed\u0026quot;) } else { return nil } }, } é€™é‚Šè¦æ³¨æ„ï¼Œå®¢æˆ¶ç«¯ (golang) è™•ç† connection çš„ exceptionï¼Œè¦è¨˜å¾—é‡æ–°åŸ·è¡Œ sntnl.MasterAddr() ä¾†å–å¾— failover å¾Œæ–°æŒ‡æ´¾çš„ masterã€‚\nClient æ¸¬è©¦ å¯«ä¸€å€‹ golang redis çš„ client è·‘èµ·ä¾†ã€‚é€™å€‹éƒ¨åˆ†æˆ‘å€‘åœ¨ kafkaçš„ç« ç¯€åšéé¡ä¼¼çš„äº‹æƒ…ï¼Œå¯ä»¥ç°¡å–®æ¹Šä¸€å€‹ç©ç©ã€‚\nå»¶ä¼¸å•é¡Œ ä½¿ç”¨ä¸Šé¢çš„ golang ç¯„ä¾‹ï¼Œç¢ºå¯¦æ˜¯èƒ½é€é sentinel å–å¾— masterï¼Œå†å‘ master å–å¾—é€£ç·šã€‚ä½†é€™é‚Šæœ‰å…©å€‹å•é¡Œ\nå®¢æˆ¶ç«¯éœ€è¦æ”¯æ´ sentinel å®¢æˆ¶ç«¯è¦æ„ŸçŸ¥ sentinel çš„ä½å€é€£ç·šï¼Œæ‰èƒ½çŸ¥é“æ‰€æœ‰ sentinel çš„ä½ç½®ï¼Œè¨­å®šåˆç”¢ç”Ÿè€¦åˆ ä¸èƒ½å½ˆæ€§çš„èª¿åº¦ sentinelï¼Œå¦‚æœéœ€è¦å¢åŠ æˆ–æ˜¯æ¸›å°‘ sentinelï¼Œå®¢æˆ¶ç«¯éœ€è¦é‡æ–°è¨­å®š é›–ç„¶ sentinel æœ‰ HAï¼Œå¯æ˜¯å®¢æˆ¶ç«¯å° sentinel çš„è¨­å®šæ²’æœ‰ HAï¼Œè¬ä¸€å·²çŸ¥çš„æ‰€æœ‰ sentinel æ›äº†å°±å…¨æ› æœ‰æ²’æœ‰æ›´å„ªé›…çš„æ–¹å¼ä½¿ç”¨ sentinelï¼Œæˆ‘å€‘ä¸‹ç¯‡æœƒè¨è«–ä½¿ç”¨ HAProxy ä¾†å®Œæˆ\n","permalink":"https://chechia.net/posts/2019-09-29-redis-ha-sentinel/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-28-redis-ha-deployment/\"\u003eä½¿ç”¨ helm éƒ¨ç½² redis-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-29-redis-ha-sentinel/\"\u003eRedis HA with sentinel\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-30-redis-ha-topology/\"\u003eRedis sentinel topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-02-redis-ha-on-haproxy/\"\u003eRedis HA with HAproxy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-03-redis-ha-failure-recovery/\"\u003eRedis HA Failure Recovery\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eredis-sentinel\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eredis sentinel èˆ‡ redis ä½¿ç”¨ç›¸å®¹çš„ apiï¼Œç›´æ¥ä½¿ç”¨ redis-cli é€é 26479 port é€£å…¥ï¼Œå¯ä»¥é€£åˆ° sentinelï¼Œé€é sentinel å¯ä»¥å–å¾— redis master çš„ç‹€æ…‹èˆ‡é€£ç·šè¨­å®šã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eredis-cli -h redis-redis-ha -p 26479\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¸Šç¯‡æˆ‘å€‘çš„ redis-ha å®‰è£å®Œè®Šé€™æ¨£\u003c/p\u003e","title":"Redis Ha Sentinel"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nä»Šå¤©çš„æ–‡æœƒæ¯”è¼ƒçŸ­ï¼Œå› ç‚ºæˆ‘æ—©ä¸Šåœ¨ç¶ å³¶å·²ç¶“æ°´è‚ºæ½›æ°´æ½›äº†ä¸‰è¶Ÿï¼Œæœ‰é»ç´¯å“ˆå“ˆ\nRedis introduction Redis æ˜¯å¸¸ç”¨çš„ in-memory çš„è³‡æ–™å„²å­˜åº«ï¼Œå¯ä½œç‚ºè³‡æ–™åº«ï¼Œå¿«å–ï¼Œmessage broker ä½¿ç”¨ï¼Œéƒ½éå¸¸å¥½ç”¨ã€‚Redis å®˜æ–¹æ”¯æ´ high availabilityï¼Œä½¿ç”¨çš„æ˜¯ redis-sentinel ï¼Œä»Šå¤©æˆ‘å€‘å°±ä¾†éƒ¨ç½²ä¸€å€‹æœ‰å®Œæ•´ sentinel çš„ redis-haã€‚\nRedis å¦å¤–æä¾›äº†ä¸€å€‹ solution Redis cluster (multiple writer solution)ï¼Œä½œç‚ºå¢åŠ è³‡æ–™è¼¸å‡ºå¸¶å¯¬ï¼Œèˆ‡å¢åŠ è³‡æ–™è€ç”¨åº¦çš„åˆ†æ•£å¼è§£æ±ºæ–¹æ¡ˆï¼Œèˆ‡ redis sentinel æ‰€è™•ç†çš„ ha å•é¡Œæ˜¯ä¸ç›¸åŒçš„ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘ä¹Ÿä¾†è«‡ã€‚\nDeploy æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½åœ¨é€™äº†https://github.com/chechiachang/go-redis-ha\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash HELM_NAME=redis-1 # Stable: chart version: redis-ha-3.6.1\tapp version: 5.0.5 helm upgrade --install ${HELM_NAME} stable/redis-ha --version 3.6.1 -f values-staging.yaml Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼Œä¹‹æ‰€ä»¥ç”¨ helm ï¼Œå› ç‚ºé€™æ˜¯æˆ‘æƒ³åˆ°æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œèƒ½è®“è¼•é¬†æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´çš„ kafkaã€‚æ‰€ä»¥æˆ‘å€‘å…ˆç”¨ã€‚\næ²’ç”¨é helm çš„å¤§å¾·å¯ä»¥åƒè€ƒ Helm Quickstartï¼Œå…ˆæŠŠ helm cli èˆ‡ kubernetes ä¸Šçš„ helm tiller éƒ½è¨­å®šå¥½\nRedis-ha helm chart github\nInstall é€™é‚Šæ˜¯ç”¨ upgrade \u0026ndash;installï¼Œå·²å®‰è£å°± upgradeï¼Œæ²’å®‰è£å°± installï¼Œä¹‹å¾Œå¯ä»¥ç”¨é€™å€‹æŒ‡ä»¤å‡ç‰ˆ\nhelm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml values-staging å®Œæ•´çš„ values.yaml åœ¨ helm chart github\nimage: repository: redis tag: 5.0.5-alpine pullPolicy: IfNotPresent ## replicas number for each component replicas: 3 servers: serviceType: ClusterIP # [ClusterIP|LoadBalancer] annotations: {} auth: true ## Redis password ## Defaults to a random 10-character alphanumeric string if not set and auth is true ## ref: https://github.com/kubernetes/charts/blob/master/stable/redis-ha/templates/redis-auth-secret.yaml ## #redisPassword: ## Use existing secret containing key `authKey` (ignores redisPassword) existingSecret: redis-credentials ## Defines the key holding the redis password in existing secret. authKey: auth é€™é‚Šæœ‰æº–å‚™ secret/redis-credentials è£¡é¢çš„ key[auth] å­˜æ”¾ redis å¯†ç¢¼ï¼Œè¦é€£å…¥çš„ pod éœ€è¦æ›è¼‰ secret ä¸¦æŠŠ auth åŒ¯å…¥ã€‚\nVersion é€™é‚Šä½¿ç”¨çš„ç‰ˆæœ¬ï¼š\nchart version: redis-ha-3.6.1 app version: 5.0.5 Redis Image: redis:5.0.5-alpine Redis exporter: oliver006/redis_exporter:v0.31.0 å®‰è£å®Œè®Šé€™æ¨£\n$ kubectl get po | grep redis NAME READY STATUS RESTARTS AGE redis-1-redis-ha-server-0 3/3 Running 0 3d4h redis-1-redis-ha-server-1 3/3 Running 0 3d5h redis-1-redis-ha-server-2 3/3 Running 0 3d4h describe pod å¯ä»¥çœ‹åˆ°è£¡é¢æœ‰ä¸‰å€‹ container\nredis: ä¸»è¦çš„ redis sentinel: ç¶­è­· redis å¯ç”¨æ€§çš„æœå‹™ï¼Œæœƒç›£æ¸¬ redis ç‹€æ…‹ï¼Œä¸¦æŠŠé€£ç·šæŒ‡æ´¾åˆ°æ–°çš„ master redis-exporter: æŠŠ redis çš„é‹è¡Œè³‡æ–™(metrics) é€å‡ºåˆ° promethues Networking Service\nNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR redis-redis-ha ClusterIP None \u0026lt;none\u0026gt; 6379/TCP,26379/TCP,9121/TCP 46m app=redis-ha,release=redis redis-redis-ha-announce-0 ClusterIP 10.3.243.81 \u0026lt;none\u0026gt; 6379/TCP,26379/TCP 46m app=redis-ha,release=redis,statefulset.kubernetes.io/pod-name=redis-redis-ha-server-0 redis-redis-ha-announce-1 ClusterIP 10.3.250.151 \u0026lt;none\u0026gt; 6379/TCP,26379/TCP 46m app=redis-ha,release=redis,statefulset.kubernetes.io/pod-name=redis-redis-ha-server-1 redis-redis-ha-announce-2 ClusterIP 10.3.242.59 \u0026lt;none\u0026gt; 6379/TCP,26379/TCP 46m app=redis-ha,release=redis,statefulset.kubernetes.io/pod-name=redis-redis-ha-server-2 nslookup redis-redis-ha Name: redis-redis-ha Address 1: 10.0.0.42 redis-redis-ha-server-1.redis-redis-ha.default.svc.cluster.local Address 2: 10.0.1.13 redis-redis-ha-server-2.redis-redis-ha.default.svc.cluster.local Address 3: 10.0.2.8 redis-redis-ha-server-0.redis-redis-ha.default.svc.cluster.local Name: redis-redis-ha-server-1.redis-redis-ha.default.svc.cluster.local Address 1: 10.0.0.43 redis-redis-ha-server-1.redis-redis-ha.default.svc.cluster.local é€£ç·š æ‰€æœ‰é€£ç·šé€é redis-redis-ha service é€£å…¥\nredis-cli -h redis-redis-ha -p 6479 -a \u0026lt;password\u0026gt; æˆ–æ˜¯ç›´æ¥æŒ‡å®š redis instance é€£å…¥ã€‚\nredis-cli -h redis-redis-ha-announce-0 -p 6479 -a \u0026lt;password\u0026gt; redis-cli -h redis-redis-ha-announce-1 -p 6479 -a \u0026lt;password\u0026gt; redis-cli -h redis-redis-ha-announce-2 -p 6479 -a \u0026lt;password\u0026gt; ä½†ä¸Šé¢å…©è€…æœƒæœ‰å•é¡Œï¼Œredis åªæœ‰ master æ˜¯ writableï¼Œé€£å…¥ slave æœƒè®Šæˆ readonlyï¼Œå¦‚æœæ²’æœ‰ä»»ä½• probe æ©Ÿæ™ºï¼Œé‚£å°±æ˜¯æ¯æ¬¡é€£ç·šæ™‚æœ‰ 2/3 æ©Ÿç‡æœƒé€£åˆ° readonly çš„ redis slave ã€‚æ‰€ä»¥é€£ç·šå‰è¦å…ˆæ‰¾åˆ°æ­£ç¢ºçš„ master\nSentinel Sentinel æ˜¯ redis å®˜æ–¹æä¾›çš„ HA solutionï¼Œä¸»è¦è² è²¬ç›£æ§ redis çš„ç‹€æ…‹ï¼Œä¸¦æ§åˆ¶ redis master çš„ failover æ©Ÿåˆ¶ï¼Œä¸€ä½†è¶…é thresholdï¼Œsentinel å°±æœƒæŠŠ master failover åˆ°å…¶ä»– slave ä¸Šã€‚ä¸¦æŠŠ master é€£ç·šæŒ‡å‘æ–° masterã€‚\nredis sentinel èˆ‡ redis ä½¿ç”¨ç›¸å®¹çš„ apiï¼Œç›´æ¥ä½¿ç”¨ redis-cli é€é 26479 port é€£å…¥ï¼Œå¯ä»¥é€£åˆ° sentinelï¼Œé€é sentinel å¯ä»¥å–å¾— redis master çš„ç‹€æ…‹èˆ‡é€£ç·šè¨­å®šã€‚\nredis-cli -h redis-redis-ha -p 26479 App ç«¯æ”¯æ´ sentinel éœ€è¦æœ‰æ”¯æ´ sentinel çš„ redis client libraryï¼Œä¾‹å¦‚: python redis-py æœ‰æ”¯æ´ sentinel çš„è¨­å®šã€‚\né€™é‚Šå°±æœƒæ¯”è¼ƒéº»ç…©ï¼Œå› ç‚ºä¸æ˜¯æ‰€æœ‰çš„èªè¨€å° redis-sentinel çš„æ”¯æ´æ€§éƒ½å¤ å¥½ï¼Œæˆ–æ˜¯æ²’è¾¦æ³•è¨­å®šåˆ°å¦®æ—ºä½¿ç”¨çš„æƒ…å¢ƒä¸Šã€‚\nå¦‚æœä½ æ‰¾å¾—åˆ°æ”¯æ´æ€§è‰¯å¥½çš„å¥—ä»¶ï¼Œæ­å–œä½ ã€‚ä¸ç„¶å°±åƒæˆ‘å€‘å…¬å¸ï¼Œèˆ‡æˆ‘å€‘çš„éœ€æ±‚æœ‰è¡çªï¼Œåªå¥½è‡ªå·± fork libraryã€‚\næ‰€ä»¥èªªç›´æ¥ä½¿ç”¨æœ‰æ”¯æ´ redis-sentinel å¯èƒ½æœƒé‡åˆ°ä¸€äº›å•é¡Œã€‚é‚£ä¹Ÿæ²’æœ‰æ›´å¥½çš„è§£æ±ºæ–¹æ³•ï¼Ÿæˆ‘å€‘ä¸‹æ¬¡èªªæ˜ä½¿ç”¨ HAproxy çš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚\nBenchmark éƒ¨ç½²å®Œå¾Œï¼Œå¯ä»¥è·‘ä¸€ä¸‹ benchmarkï¼Œçœ‹çœ‹åœ¨ kubernetes ä¸Šé‹è¡Œçš„æ•ˆèƒ½æœ‰æ²’æœ‰ç¬¦åˆéœ€æ±‚ã€‚\nRun a redis pod with sleep command NOTE: CPU usage (rapidly) increasing during benchmark DON\u0026rsquo;T DO THIS on PRODUCTION\nkubectl run test-redis --image redis:5.0.5-alpine --command sleep 36000 kubectl exec -it test-redis-xxxxxxxxx-xxxxx sh Benchmark\nredis-benchmark --help redis-benchmark \\ -h haproxy-service.local \\ -p 6379 \\ -c 100 \\ -d 30 \\ -n 1000000 ====== MSET (10 keys) ====== 100000 requests completed in 2.32 seconds 50 parallel clients 3 bytes payload keep alive: 1 85.37% \u0026lt;= 1 milliseconds 98.06% \u0026lt;= 2 milliseconds 99.18% \u0026lt;= 3 milliseconds 99.62% \u0026lt;= 4 milliseconds 99.93% \u0026lt;= 5 milliseconds 100.00% \u0026lt;= 5 milliseconds 43066.32 requests per second ","permalink":"https://chechia.net/posts/2019-09-28-redis-ha-deployment/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-28-redis-ha-deployment/\"\u003eä½¿ç”¨ helm éƒ¨ç½² redis-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-29-redis-ha-sentinel/\"\u003eRedis HA with sentinel\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-30-redis-ha-topology/\"\u003eRedis sentinel topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-02-redis-ha-on-haproxy/\"\u003eRedis HA with HAproxy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-10-03-redis-ha-failure-recovery/\"\u003eRedis HA Failure Recovery\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003eä»Šå¤©çš„æ–‡æœƒæ¯”è¼ƒçŸ­ï¼Œå› ç‚ºæˆ‘æ—©ä¸Šåœ¨ç¶ å³¶å·²ç¶“æ°´è‚ºæ½›æ°´æ½›äº†ä¸‰è¶Ÿï¼Œæœ‰é»ç´¯å“ˆå“ˆ\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Exausted Cat Face\" loading=\"lazy\" src=\"https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"redis-introduction\"\u003eRedis introduction\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://redis.io/\"\u003eRedis\u003c/a\u003e æ˜¯å¸¸ç”¨çš„ in-memory çš„è³‡æ–™å„²å­˜åº«ï¼Œå¯ä½œç‚ºè³‡æ–™åº«ï¼Œå¿«å–ï¼Œmessage broker ä½¿ç”¨ï¼Œéƒ½éå¸¸å¥½ç”¨ã€‚Redis å®˜æ–¹æ”¯æ´ high availabilityï¼Œä½¿ç”¨çš„æ˜¯ \u003ca href=\"https://redis.io/topics/sentinel\"\u003eredis-sentinel\u003c/a\u003e\nï¼Œä»Šå¤©æˆ‘å€‘å°±ä¾†éƒ¨ç½²ä¸€å€‹æœ‰å®Œæ•´ sentinel çš„ redis-haã€‚\u003c/p\u003e\n\u003cp\u003eRedis å¦å¤–æä¾›äº†ä¸€å€‹ solution \u003ca href=\"https://redis.io/topics/cluster-tutorial\"\u003eRedis cluster (multiple writer solution)\u003c/a\u003eï¼Œä½œç‚ºå¢åŠ è³‡æ–™è¼¸å‡ºå¸¶å¯¬ï¼Œèˆ‡å¢åŠ è³‡æ–™è€ç”¨åº¦çš„åˆ†æ•£å¼è§£æ±ºæ–¹æ¡ˆï¼Œèˆ‡ redis sentinel  æ‰€è™•ç†çš„ ha å•é¡Œæ˜¯ä¸ç›¸åŒçš„ã€‚æœ‰æ©Ÿæœƒæˆ‘å€‘ä¹Ÿä¾†è«‡ã€‚\u003c/p\u003e","title":"Redis Ha Deployment"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Kafka\u0026rsquo;s quorum set Kafka çš„ quorum set é€™ç¯‡è·Ÿä¸Šç¯‡å…¶å¯¦å†è¬› quorumï¼Œæ‡‰è©²é€£åœ¨ä¸€èµ·ï¼Œä½†ç¤™æ–¼ç¯‡å¹…ï¼ˆä»¥åŠæˆ‘å€‹äººçš„æ™‚é–“ï¼±ï¼±ï¼‰æ‹†æˆäº†å…©ç¯‡ã€‚å„ä½æœ‰éœ€è¦å¯ä»¥å›é¡§ä¸€ä¸‹ã€‚\nReplicated log commit decision ä¸Šç¯‡æåˆ°äº†å…©å€‹ç¶­æŒ replicated log çš„ model\næœ‰æ›´æ–°é€²ä¾†ï¼Œleader ç­‰å¾…æ‰€æœ‰ follower éƒ½ ackï¼Œæ‰ commitã€‚ æœ‰æ›´æ–°é€²ä¾†ï¼Œleader å–å¾—æ‰€æœ‰ node (2n+1) ä¸­çš„å¤šæ•¸ node å›æ‡‰(n+1)ï¼Œå°± commitã€‚è€Œ leader election æ™‚ï¼Œå¿…é ˆæ¯”å° node ä¸Šçš„ logï¼Œæ±ºå®šèª°æ˜¯ electable leader(æœ‰æœ€å®Œæ•´ log çš„ follower)ï¼Œé€™æ¨£ç¨±ç‚ºå…±è­˜(Quorum) å‰è€…çš„å¥½è™•æ˜¯ï¼Œæ‰€æœ‰ node éƒ½æœ‰å®Œæ•´çš„ log å¾Œï¼Œleader æ‰æœƒ commitï¼Œå›è¦†çµ¦å®¢æˆ¶ commit çš„è³‡è¨Šï¼Œæ‰€ä»¥æ¯å€‹ follower éƒ½æ˜¯ leader electable äººäººéƒ½å¯ä»¥ç•¶ leaderï¼Œleader ä¸€æ•…éšœå°±é¸æ“‡æ–°çš„ leader å³å¯ã€‚å£è™•å°±æ˜¯ leader åœ¨ç­‰å¾…æ‰€æœ‰ follow ack çš„æ™‚é–“æœƒéå¸¸ä¹…ï¼Œè€Œä¸”æ™‚é–“è¤‡é›œåº¦å¯èƒ½æœƒéš¨ cluster size scaleï¼Œæˆ–æ˜¯è®Šæˆè¦ç­‰æœ€æ…¢çš„ node å›æ‡‰(worst case)ã€‚é€™æ¨£åœ¨ node æ•¸é‡å¤šçš„æ™‚å€™éå¸¸ä¸ç¶“æ¿Ÿã€‚\nå¾Œè€…çš„å¥½è™•æ˜¯ï¼Œn+1 node ack å¾Œå°± commitï¼Œleader commit çš„é€Ÿåº¦æ˜¯ç”±å‰æ®µç­çš„å›æ‡‰é€Ÿåº¦æ±ºå®šã€‚leader å‡ºç¾æ•…éšœï¼Œä»èƒ½ç¶­æŒå¤šæ•¸ node çš„è³‡æ–™æ­£ç¢ºã€‚\nLeader election decision Leader Election çš„å•é¡Œä¹Ÿæ˜¯é¡ä¼¼ï¼Œå¦‚æœé¸æ“‡ leader æ™‚ï¼Œæ‰€æœ‰çš„ follower éƒ½æ¯”å°é logï¼Œé€™æ¨£èŠ±çš„æ™‚é–“æœƒå¾ˆä¹…ã€‚è¦çŸ¥é“ï¼Œé€™æ˜¯å€‹åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œæ²’æœ‰ä¸­å¿ƒåŒ–çš„ controllerï¼Œä¹Ÿå°±æ˜¯ follower å½¼æ­¤éœ€è¦äº¤äº’æ¯”å°ã€‚è€Œä¸”æ™‚é–“éš¨ follower æ•¸é‡ scaleã€‚ é€ æˆtopic partition æ²’æœ‰ leader çš„æ™‚é–“(downtime)å¤ªé•·ã€‚\nå¦‚æœä½¿ç”¨ majorityï¼Œä¹Ÿå°±æ˜¯ç•¶ leader æ­»æ‰ï¼Œç”¢ç”Ÿæ–°çš„ leader election æ™‚ï¼Œåªè©¢å• n+1 å€‹ follower ï¼Œç„¶å¾Œå¾é¸å‡º log æœ€å®Œæ•´çš„äººç•¶ leaderï¼Œ é€™æ¨£éç¨‹ä¸­æ¯å€‹ follower å½¼æ­¤æ¯”å°ï¼Œç¢ºèªï¼Œç„¶å¾Œæ‰é¸å‡º leaderï¼Œç¢ºèª leader çš„çµæœï¼Œæ‰€èŠ±çš„æ™‚é–“æœƒå¤§å¹…ç¸®çŸ­ã€‚\nç•¶ç„¶ï¼Œé€™éº¼åšç”¢ç”Ÿçš„ tradeoffï¼Œå°±æ˜¯è¬ä¸€å–å¾—å¤šæ•¸æ±ºçš„ n+1 å€‹ follower è£¡é¢ï¼Œæ²’æœ‰æœ€å®Œæ•´çš„ log ï¼Œé‚£å¾è£¡é ­é¸å‡ºä¾†çš„ leader è‡ªç„¶ä¹Ÿæ²’æœ‰å®Œæ•´ logï¼Œé¸å‡ºä¾†çš„ leader å°±æœƒéºå¤±è³‡æ–™ã€‚\nä¸€å€‹å®Œæ•´çš„ Quorum æ©Ÿåˆ¶ é€™ä¸æ˜¯ kafka çš„æ©Ÿåˆ¶ï¼Œä½†æˆ‘å€‘é †å¸¶èŠèŠã€‚\ncommit decision ä½¿ç”¨å¤šæ•¸æ±º(majority) leader election ä¹Ÿä½¿ç”¨å¤šæ•¸æ±º ç¸½å…±æœ‰ 2n+1 replicasï¼Œleader å–å¾— n+1 ack æ‰èƒ½ commit messageã€‚ç„¶å¾Œ leader election æ™‚ï¼Œå¾è‡³å°‘ n+1 å€‹ follower ä¸­å–å¾—å¤šæ•¸æ±ºæ‰èƒ½é¸å‡º leaderã€‚æœ‰éåŠçš„å®Œæ•´logï¼ŒåŠ ä¸Šå–å¾—éåŠæ•¸çš„äººç¢ºèªï¼Œå…©è€…ç”¢ç”Ÿ overlapã€‚é€™æ¨£çš„å…±è­˜å°±ç¢ºä¿æœ‰å®Œæ•´çš„ log çš„ follower ä¸€å®šæœƒå‡ºç¾åœ¨ leader election ä¸­ï¼Œç¢ºä¿é¸å‡ºä¾†çš„ leader æœ‰å®Œæ•´ logã€‚\nå¥½è™•å¦‚å‰é¢æè¿°ï¼Œæ•´é«”æ•ˆèƒ½ç”±å‰æ®µç­çš„é€Ÿåº¦æ±ºå®šã€‚\nå£è™•æ˜¯ï¼Œå¾ˆå®¹æ˜“å°±æ²’æœ‰è¶³å¤ çš„ electable leaderã€‚è¦å®¹å¿ 1 å€‹éŒ¯èª¤ï¼Œéœ€è¦ 3 å€‹å®Œæ•´å‚™ä»½ï¼Œè¦å®¹å¿ 2 å€‹éŒ¯èª¤éœ€è¦ 5 å€‹å‚™ä»½ã€‚åœ¨å¯¦å‹™ä¸Šï¼Œåªé ä¾è³´å¤ å¤šçš„ redundency å®¹éŒ¯éå¸¸çš„ä¸å¯¦éš›ï¼šæ¯ä¸€æ¬¡å¯«å…¥éœ€è¦ 5 å€å¯«å…¥è·Ÿç¡¬ç¢Ÿç©ºé–“ï¼Œä½†æ•´é«”æ•ˆèƒ½åªæœ‰ 1/5ã€‚è³‡æ–™é‡å¤§å°±ç›´æ¥ï¼§ï¼§ã€‚æ‰€ä»¥ quorum æ‰æœƒåªå­˜åœ¨åˆ†æ•£å¼é›†ç¾¤(ex. zookeeper)ï¼Œè€Œä¸æœƒç›´æ¥ç”¨åœ¨å„²å­˜ç³»çµ±ã€‚\nKafka\u0026rsquo;s approach Kafka ä¸ä½¿ç”¨ majority voteï¼Œè€Œæ˜¯å»å‹•æ…‹ç¶­è­·ä¸€å¥— in-sync replicas(ISR) ï¼Œé€™äº› ISR æœƒè·Ÿä¸Š leader çš„é€²åº¦ï¼Œè€Œåªæœ‰é€™äº› ISR æ‰èƒ½æ˜¯ leader eligibleã€‚ä¸€å€‹ update åªæœ‰åœ¨æ‰€æœ‰ ISR éƒ½ ack å¾Œæ‰æœƒ commitã€‚\nISR çš„ç‹€æ…‹ä¸æ”¾åœ¨ kafka è€Œæ”¾åœ¨ zookeeper ä¸Šï¼Œä¹Ÿå°±æ˜¯ç›®å‰å“ªäº› node æ˜¯ ISR çš„è¨˜éŒ„å­˜åœ¨ zookeeperã€‚é€™ä»¶äº‹å°ç¶­æŒ kafka ç¯€é»ä¸Šï¼Œleader èƒ½å¤ åˆ†æ•£åœ¨å„å€‹ kafka node ä¸Š(leader rebalance)æ˜¯å¾ˆé‡è¦çš„ã€‚\nkafka\u0026rsquo;s approach èˆ‡ majority voteï¼Œåœ¨ç­‰å¾… message commit ack ä¸Šæ‰€èŠ±çš„æˆæœ¬æ˜¯ä¸€æ¨£çš„ã€‚ ç„¶è€Œåœ¨ leader election ä¸Šï¼Œkafka çš„ ISR ç¢ºä¿äº†æ›´å¤šå€‹ eligiable leader çš„æ•¸é‡ï¼ŒæŒçºŒç¶­æŒåœ¨åˆç†çš„æ•¸é‡ï¼Œè€Œä¸æœƒè¦ç¶­æŒå¤§é‡å€‹ redundencyã€‚ISR æ”¾åœ¨å¤–éƒ¨ï¼Œæ›´æ–¹ä¾¿ kafka åš leader rebalanceï¼Œå¢åŠ ç©©å®šåº¦ã€‚\nUnclean leader election å¦‚æœ leaders éƒ½æ­»å…‰äº†æœƒæ€æ¨£ï¼Ÿ\nåªè¦æœ‰ä¸€å€‹ replica in-syncï¼ŒKafka å°±ä¿è­‰è³‡æ–™çš„å®Œæ•´æ€§ã€‚ç„¶è€Œæ‰€æœ‰å¯ç”¨çš„ leaders éƒ½æ­»äº†ï¼Œé€™å€‹å°±ç„¡æ³•ä¿è­‰ã€‚\nå¦‚æœé€™å€‹æƒ…å½¢ç™¼ç”Ÿäº†ï¼Œkafka æœƒåšä»¥ä¸‹è™•ç†\nç­‰ ISR ä¸­æœ‰äººå®Œå…¨å›å¾©éä¾†ï¼Œç„¶å¾Œé¸é€™å€‹ node ä½œç‚º leader(æœ‰è³‡æ–™éºå¤±çš„é¢¨éšª) ç›´æ¥é¸æ“‡ç¬¬ä¸€å€‹å›è¦†çš„ node (ä¸ä¸€å®šåœ¨ ISR ä¸­)ï¼Œå…ˆå›è¦†çš„å°±æŒ‡æ´¾ç‚º leader å‰è€…çŠ§ç‰² availability ï¼ˆå›è¦†å‰æ²’æœ‰ leader å¯ä½œè®€å¯«ï¼‰ä¾†ç¢ºä¿è³‡æ–™æ˜¯ä¾†è‡ª ISRï¼Œé›–ç„¶éŒ¯èª¤ä¸­ç„¡æ³•è®€å¯«(downtime)ï¼Œä½†å¯ä»¥ç¢ºå®šéŒ¯èª¤å‰è·ŸéŒ¯èª¤å¾Œçš„è³‡æ–™éƒ½ä¾†è‡ª ISR\nå¾Œè€…çŠ§ç‰² consistency ï¼ˆä¾†è‡ªé ISR çš„ leader å¯èƒ½å°è‡´è³‡æ–™ä¸æ­£ç¢ºï¼‰ï¼Œç„¶è€Œå»èƒ½æ›´å¿«çš„å¾éŒ¯èª¤ä¸­å›è¦†ï¼Œæ¸›å°‘ downtime\n0.11.0.0 å¾Œçš„ kafka é è¨­æ˜¯é¸æ“‡å‰è€…ï¼Œä¹Ÿå°±æ˜¯ consistency over availabilityï¼Œç•¶ç„¶é€™å¯ä»¥åœ¨è¨­å®šæ›´æ”¹ã€‚\nAvailability and Durability Guarantees è¿‘ä¸€æ­¥è€ƒæ…® client çš„å½±éŸ¿ã€‚\nProducer åœ¨å¯«å…¥æ™‚å¯ä»¥é¸æ“‡ message éœ€è¦å¤šå°‘ acknowledgeï¼Œ0, 1 or allï¼Œack=all æŒ‡çš„æ˜¯ message æ”¶åˆ°æ‰€æœ‰ in-sync replicas çš„ ack\nå¦‚æœ 2 replicas ä¸­æœ‰ 1 å€‹æ•…éšœï¼Œé€™æ™‚å¯«å…¥åªè¦æ”¶åˆ° 1 å€‹ ISR çš„ ackï¼Œå°±é”æˆ ack=all ä½†å¦‚æœä¸å¹¸å‰©ä¸‹ä¸€å€‹ replicas ä¹Ÿæ­»äº† (0/0 ack)ï¼Œå¯«å…¥çš„è³‡æ–™å°±æœƒéºå¤± æœ‰äº›ä½¿ç”¨æƒ…å¢ƒï¼Œæœƒå¸Œæœ›è³‡æ–™çš„è€ç”¨åº¦(Durability)å„ªå…ˆæ–¼å¯ç”¨æ€§(Availability)ï¼Œå¯ä»¥é€éä»¥ä¸‹å…©å€‹æ–¹å¼è¨­å®š\nç¦ç”¨ unclean leader electionï¼Œæ•ˆæœæ˜¯å¦‚æœæ‰€æœ‰çš„ replicas éƒ½å¤±æ•ˆï¼Œå‰‡æ•´å€‹ partition éƒ½å¤±æ•ˆï¼Œç›´åˆ°å‰ä¸€å€‹ leader å›å¾©æ­£å¸¸ã€‚ æŒ‡å®šå¯æ¥å—çš„æœ€å°‘ ISRï¼Œå¦‚æœ partition ä¸­çš„ ISR ä½æ–¼é€™å€‹æ•¸é‡ï¼Œå°±åœæ­¢å¯«å…¥é€™å€‹ partitionï¼Œç›´åˆ° ISR çš„æ•¸é‡å›è¦†ã€‚ é€™æ¨£é›–ç„¶çŠ§ç‰²äº†å¯ç”¨æ€§ï¼Œå»å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°ç¢ºä¿è³‡æ–™çš„å¯é æ€§ã€‚\nè¤‡æœ¬ç®¡ç† ä¸Šé¢çš„è¨è«–éƒ½åªæ˜¯å†èªªä¸€å€‹ topicï¼Œå¯¦å‹™ä¸­ kafka ä¸­æœƒæœ‰å¤§é‡çš„ topic ï¼Œä¹˜ä¸Š partition number èˆ‡ replication factorï¼Œæˆåƒä¸Šè¬çš„è¤‡æœ¬åˆ†æ•£åœ¨é›†ç¾¤ä¸­ï¼Œkafka æœƒè©¦åœ–åˆ†æ•£ replicas åˆ°é›†ç¾¤ä¸­ï¼Œä¸¦è®“ leader çš„æ•¸é‡å¹³å‡åœ¨ node ä¸Š\n","permalink":"https://chechia.net/posts/2019-09-26-kafka-ha-continued/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e","title":"Kafka HA Continued"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ Zookeeper Multi-server setup Kafka Multi-broker setup Zookeeper Multi-Server ç‚ºäº†ç¶­æŒ zookeeper æœ‰æ•ˆé‹ä½œï¼Œcluster å¿…é ˆç¶­æŒ majority (å¤šæ•¸)ï¼Œä¹Ÿå°±æ˜¯è‡³å°‘ä¸€åŠçš„æ©Ÿå™¨åœ¨ç·šã€‚å¦‚æœç¸½å…± 3 å°ï¼Œä¾¿å¯ä»¥å¿å— 1 å°æ•…éšœä»ä¿æœ‰ majorityã€‚å¦‚æœæ˜¯ 5 å°å°±å¯ä»¥å®¹å¿ 2 å°æ•…éšœã€‚ä¸€èˆ¬ä¾†èªªéƒ½å»ºè­°ä½¿ç”¨åŸºæ•¸æ•¸é‡ã€‚Zookeeper Multi Server Setup\næ™®éæƒ…æ³ï¼Œ3 å° zookeeper å·²ç¶“æ˜¯ production ready çš„ç‹€æ…‹ï¼Œä½†å¦‚æœç‚ºäº†æ›´é«˜çš„å¯ç”¨æ€§ï¼Œä»¥æ–¹ä¾¿é€²è¡Œå–®ç¯€é»åœæ©Ÿç¶­è­·ï¼Œå¯ä»¥å¢åŠ ç¯€é»æ•¸é‡ã€‚\nTopology éœ€è¦å°‡ zookeeper æ”¾åœ¨ä¸åŒçš„æ©Ÿå™¨ä¸Šï¼Œä¸åŒçš„ç¶²è·¯ç’°å¢ƒï¼Œç”šè‡³æ˜¯ä¸åŒçš„é›²å¹³å°å€åŸŸä¸Šï¼Œä»¥æ‰¿å—ä¸åŒç¨‹åº¦çš„æ•…éšœã€‚ä¾‹å¦‚å–®å°æ©Ÿå™¨æ•…éšœï¼Œæˆ–æ˜¯å€åŸŸæ€§çš„ç¶²è·¯æ•…éšœã€‚\næˆ‘å€‘é€™é‚Šæœƒä½¿ç”¨ Kubernetes PodAntiAffinityï¼Œè¦æ±‚ scheduler åœ¨éƒ¨å±¬æ™‚ï¼Œå¿…é ˆå°‡ zookeeper åˆ†æ•£åˆ°ä¸åŒçš„æ©Ÿå™¨ä¸Šã€‚è¨­å®šå¦‚ä¸‹ï¼š\nvim values-staging.yaml zookeeper: enabled: true resources: ~ env: ZK_HEAP_SIZE: \u0026quot;1G\u0026quot; persistence: enabled: false image: PullPolicy: \u0026quot;IfNotPresent\u0026quot; url: \u0026quot;\u0026quot; port: 2181 ## Pod scheduling preferences (by default keep pods within a release on separate nodes). ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity ## By default we don't set affinity: affinity: # Criteria by which pod label-values influence scheduling for zookeeper pods. podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - topologyKey: \u0026quot;kubernetes.io/hostname\u0026quot; labelSelector: matchLabels: release: zookeeper ä½¿ç”¨ podAntiAffinity.requiredDuringSchedulingIgnoredDuringExecutionï¼Œå¦‚æœ topologyKey å·²ç¶“æœ‰æŒ‡å®š label çš„ pod å­˜åœ¨ï¼Œå‰‡ç„¡æ³•éƒ¨ç½²ï¼Œéœ€è¦æ•¸åˆ°å…¶ä»–å°æ©Ÿå™¨ã€‚\nkubectl get pods --output wide | grep zookeeper NAME READY STATUS RESTARTS AGE IP NODE kafka-0-zookeeper-0 1/1 Running 0 42d 10.8.12.4 gke-chechiachang-pool-1-e06e6d00-pc98 kafka-0-zookeeper-1 1/1 Running 0 42d 10.8.4.4 gke-chechiachang-pool-1-e06e6d00-c29q kafka-0-zookeeper-2 1/1 Running 0 42d 10.8.3.6 gke-chechiachang-pool-1-e06e6d00-krwc æ•ˆæœæ˜¯ zookeeper éƒ½åˆ†é…åˆ°ä¸åŒçš„æ©Ÿå™¨ä¸Šã€‚\nGuarantees Zookeeper å°æ–¼è³‡æ–™ä¸€è‡´æ€§ï¼Œæœ‰é€™äº›ä¿éšœ Consistency Guarantees\né †åºä¸€è‡´æ€§ï¼šè³‡æ–™æ›´æ–°çš„é †åºï¼Œèˆ‡ç™¼é€çš„é †åºä¸€è‡´ åŸå­æ€§ï¼šè³‡æ–™æ›´æ–°åªæœ‰æˆåŠŸæˆ–å¤±æ•—ï¼Œæ²’æœ‰éƒ¨ä»½æ•ˆæœ ç³»çµ±ä¸€è‡´æ€§ï¼šå¯æˆ¶ç«¯é€£åˆ° server çœ‹åˆ°çš„æ±è¥¿éƒ½æ˜¯ä¸€æ¨£ï¼Œç„¡é—œé€£å…¥å“ªå€‹ server å¯é æ€§ï¼š å®¢æˆ¶ç«¯çš„æ›´æ–°è«‹æ±‚ï¼Œä¸€ä½†æ”¶åˆ° server å›è¦†æ›´æ–°æˆåŠŸï¼Œä¾¿æœƒæŒçºŒä¿å­˜ç‹€æ…‹ã€‚æŸäº›éŒ¯èª¤æœƒé€ æˆå®¢æˆ¶ç«¯æ”¶ä¸åˆ°å›è¦†ï¼ŒÂ å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œï¼Œæˆ–æ˜¯ server å…§éƒ¨å•é¡Œï¼Œé€™é‚Šå°±ç„¡æ³•ç¢ºå®š server ä¸Šçš„ç‹€æ…‹ï¼Œæ˜¯å¦è¢«æ›´æ–°äº†ï¼Œæˆ–æ˜¯è«‹æ±‚å·²ç¶“éºå¤±äº†ã€‚ å¾å®¢æˆ¶è®€å–åˆ°çš„è³‡æ–™éƒ½æ˜¯ä»¥ç¢ºèªçš„è³‡æ–™ï¼Œä¸æœƒå› ç‚º server æ•…éšœå›æ»¾(Roll back)è€Œå›åˆ°èˆŠçš„ç‹€æ…‹ Kafka çš„è¨­å®š ## The StatefulSet installs 3 pods by default replicas: 3 resources: limits: cpu: 200m memory: 4096Mi requests: cpu: 100m memory: 1024Mi kafkaHeapOptions: \u0026quot;-Xmx4G -Xms1G\u0026quot; è¨­å®š broker çš„æ•¸é‡ï¼Œä»¥åŠ Pod æä¾›çš„ resourceï¼Œä¸¦ä¸”é€é heapOption æŠŠè¨˜æ†¶é«”è¨­å®šå¡é€² JVM\naffinity: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - kafka topologyKey: \u0026quot;kubernetes.io/hostname\u0026quot; podAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 50 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - zookeeper é€™é‚Šä¸‹äº†å…©å€‹ affinity\npodAntiAffinity ç›¡é‡è®“ kafka-broker åˆ†æ•£åˆ°ä¸åŒæ©Ÿå™¨ä¸Š podAffinity è®“ broker prefer è·Ÿ zookeeper æ”¾åœ¨ä¸€èµ· åˆ†æ•£çš„ç†ç”±åŒä¸Šï¼Œä¸å¸Œæœ›ä¸€å°æ©Ÿå™¨æ­»äº†ï¼Œå°±è®“å¤šå€‹ broker è·Ÿè‘—æ­»\nè¦å’Œ zookeeper æ”¾åœ¨ä¸€èµ·ï¼Œå°±è¦çœ‹éœ€æ±‚èˆ‡å¯¦éš›ç’°å¢ƒèª¿æ•´\nconfigurationOverrides: \u0026quot;default.replication.factor\u0026quot;: 3 \u0026quot;offsets.topic.replication.factor\u0026quot;: 2 # Increased from 1 to 2 for higher output \u0026quot;offsets.topic.num.partitions\u0026quot;: 3 \u0026quot;confluent.support.metrics.enable\u0026quot;: false # Disables confluent metric submission \u0026quot;auto.leader.rebalance.enable\u0026quot;: true \u0026quot;auto.create.topics.enable\u0026quot;: true \u0026quot;message.max.bytes\u0026quot;: \u0026quot;16000000\u0026quot; # Extend global topic max message bytes to 16 Mb é€™é‚Šå†æŠŠ broker é‹è¡Œçš„è¨­å®šåƒæ•¸å¡é€²å»ï¼Œåƒæ•¸çš„ç”¨é€”å¤§å¤šèˆ‡è¤‡æœ¬èˆ‡é«˜å¯ç”¨æ©Ÿåˆ¶æœ‰é—œä¸‹é¢éƒ½æœƒæåˆ°ã€‚\nKafka çš„è¤‡æœ¬æ©Ÿåˆ¶ kafka çš„å‰¯æœ¬æ©Ÿåˆ¶ é è¨­å°‡å„å€‹ topic partition çš„ log åˆ†æ•£åˆ° server ä¸Šï¼Œå¦‚æœå…¶ä¸­ä¸€å° server æ•…éšœï¼Œè³‡æ–™ä»ç„¶å¯ç”¨ã€‚\nå…©å€‹é‡è¦çš„è¨­å®š\nnum.partitions=N default.replication.factor=M kafka é è¨­ä½¿ç”¨è¤‡æœ¬ï¼Œæ‰€æœ‰æ©Ÿåˆ¶èˆ‡è¨­è¨ˆéƒ½åœç¹è‘—è¤‡æœ¬ã€‚å¦‚æœï¼ˆå› ç‚ºæŸäº›åŸå› ï¼‰ä¸å¸Œæœ›ä½¿ç”¨è¤‡æœ¬ï¼Œå¯å°‡ replication factor è¨­ç‚º 1ã€‚\nreplication çš„å–®ä½æ˜¯ topic partitionï¼Œæ­£å¸¸ç‹€æ³ä¸‹\nä¸€å€‹ partition æœƒæœ‰ä¸€å€‹ leaderï¼Œä»¥åŠé›¶å€‹æˆ–ä»¥ä¸Šå€‹ follower leader + follower ç¸½æ•¸æ˜¯ replication factor æ‰€æœ‰è®€å¯«éƒ½æ˜¯å° leader è®€å¯« leader çš„ log æœƒåŒæ­¥åˆ° follower ä¸Šï¼Œleader èˆ‡ follower ç‹€æ…‹æ˜¯ä¸€æ¨£çš„ Election \u0026amp; Load balance é€šå¸¸ä¸€å€‹ topic æœƒæœ‰å¤šå€‹ partitionï¼Œä¹Ÿå°±æ˜¯èªªï¼Œæ¯å€‹ topic æœƒæœ‰å¤šå€‹ partition leaderï¼Œåˆ†æ•£è² è¼‰\né€šå¸¸ topic partition çš„ç¸½æ•¸æœƒæ¯” broker çš„æ•¸é‡å¤š\nä»¥ä¸Šä¸€ç¯‡ç¯„ä¾‹ï¼Œæˆ‘å€‘æœ‰ä¸‰å€‹ kafka-0-broker å„è‡ªæ˜¯ä¸€å€‹ Pod æœ‰ topic: ticker è·Ÿé è¨­çš„ __consumer_offset__ï¼Œä¹˜ä¸Š partition number çš„è¨­å®šå€¼(N)ï¼Œæœƒæœ‰ 2N å€‹ partitions partitiion æœƒæœ‰å„è‡ªçš„è¤‡æœ¬ï¼Œkafka æœƒç›¡é‡å°‡ç›¸åŒ topic çš„è¤‡æœ¬åˆ†æ•£åˆ°ä¸åŒ broker ä¸Š kafka ä¹Ÿæœƒç›¡é‡ç¶­æŒ partition çš„ leader åˆ†æ•£åœ¨ä¸åŒçš„ broker ä¸Šï¼Œé€™å€‹éƒ¨åˆ† kafka æœƒé€éç®—æ³•åš leader electionï¼Œä¹Ÿå¯æ‰‹å‹•ä½¿ç”¨è…³æœ¬åš Balancing leadership ç¸½ä¹‹ï¼Œtopic çš„ partition èˆ‡ leader æœƒåˆ†æ•£åˆ° broker ä¸Šï¼Œç¶­æŒ partition çš„å¯ç”¨æ€§ã€‚\nsync node è¦èƒ½å¤ ç¶­æŒ zookeeper çš„ session (zookeeper æœ‰ heartbeat æ©Ÿåˆ¶) follower ä¸èƒ½è½å¾Œ leader å¤ªå¤š kafka èƒ½ä¿éšœè³‡æ–™ä¸æœƒéºå¤±ï¼Œåªè¦è‡³å°‘ä¸€å€‹ node æ˜¯åœ¨ sync çš„ç‹€æ…‹ã€‚ä¾‹å¦‚æœ¬ä¾†æœ‰ä¸‰å€‹ partitionï¼Œå…¶ä¸­å…©å€‹ partition ä¸åŒæ­¥ï¼Œåªè¦å…¶ä¸­ä¸€å€‹ partition æ˜¯åŒæ­¥ï¼Œä¾¿èƒ½ä½œç‚º leader æŒçºŒæä¾›æ­£ç¢ºçš„ messageã€‚\nReplicated Logs kafka é€é replicated log ç¶­æŒåˆ†æ•£å¼çš„ partition\nè¤‡æœ¬é–“è¦ç¶­æŒå…±è­˜(consensus)çš„æœ€ç°¡å–®æ©Ÿåˆ¶ï¼Œå°±æ˜¯å–®ä¸€ leader æ±ºå®šï¼Œå…¶ä»– follower è·Ÿéš¨ã€‚ç„¶è€Œè¬ä¸€ leader æ­»äº†ï¼Œé¸å‡ºçš„æ–° leader å»é‚„æ²’è·Ÿä¸ŠåŸå…ˆ leader çš„è³‡æ–™ã€‚é€™æ™‚ä¾¿ä½¿ç”¨ replicated logï¼Œä¾†ç¢ºä¿æ–°çš„ leader å°±ç®—åŸå…ˆæ²’è·Ÿä¸Šï¼Œä¹Ÿèƒ½é€é replicated log éš¨å¾Œè·Ÿä¸Šä¸”ä¸éºå¤±è³‡æ–™ã€‚ç¶­æŒ log ä¸€ç›´éƒ½åŒæ­¥çš„å‰æï¼Œå°±æ˜¯ leader è¦ä¸€ç›´ç¢ºèª followers çš„ log éƒ½æœ‰è·Ÿä¸Šï¼Œé€™å€‹å…¶å¯¦å°±æ˜¯è®Šç›¸çš„å¤š leaderï¼Œæ•ˆèƒ½æ¶ˆè€—è¼ƒå¤§ã€‚\nå¦ä¸€å€‹ç¶­æŒ log æ©Ÿåˆ¶ï¼Œå¦‚æœå¸Œæœ› follower å½¼æ­¤çš„ log æ‡‰è©²å…ˆé€²è¡Œæ¯”å°ï¼Œè®“è³‡æ–™äº¤æ¥éç¨‹æœ‰ overlapï¼Œé€™å€‹éç¨‹ç¨±ç‚º Quorumã€‚ä¸€å€‹å¸¸ç”¨çš„æ–¹å¼æ˜¯å¤šæ•¸æ±º(majority)\nå¦‚æœç¸½å…±æœ‰ 2n+1 çš„ nodeï¼Œleader è¦å‘ n+1 å€‹ follower å–å¾—å…±è­˜ï¼Œæ‰ç¢ºå®šé€™å€‹ log å·²ç¶“ commit äº† leader ç¸½æ˜¯ç¶­æŒ n+1 follower çš„ log æœ‰è·Ÿä¸Šï¼Œå› æ­¤å¯ä»¥å®¹å¿æœ€å¤š n å€‹ node æ­»äº†ï¼Œé›†ç¾¤æ•´é«”èƒ½æœ‰ n+1 çš„ node ç¶­æŒè‘—æ­£ç¢ºçš„ commited log ä¸ç”¨å‘æ‰€æœ‰ node ç¢ºèªæ‰ commit ï¼Œç¯€çœäº†ä¸€åŠçš„ ack majarity çš„å¦ä¸€å€‹å¥½è™•æ˜¯ï¼Œn+1 å…±è­˜çš„é€Ÿåº¦æ˜¯ç”±å‰ 1/2 å¿«çš„ node æ±ºå®šçš„ã€‚ç”±æ–¼åªè¦å…ˆå–å¾— n+1 å°±å¯ä»¥ commitï¼Œé€Ÿåº¦å¿«çš„ node æœƒå…ˆå›æ‡‰ï¼Œè®“æ•´é«”é€Ÿåº¦æå‡ã€‚ ","permalink":"https://chechia.net/posts/2019-09-25-kafka-ha-topology/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e","title":"Kafka HA Topology"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ å¾ Zookeeper ç²å–è³‡è¨Š å–å¾—ä¸¦è™•ç† topic benchmark kafka zookeeper zookeeper æ˜¯ kafka çš„åˆ†æ•£å¼å”èª¿ç³»çµ±ï¼Œåœ¨ kafka ä¸Šå¤šå€‹ç¯€é»é–“éœ€è¦å”èª¿çš„å…§å®¹ï¼Œä¾‹å¦‚ï¼šå½¼æ­¤ç¯€é»çš„IDï¼Œä½ç½®èˆ‡ç•¶å‰ç‹€æ…‹ï¼Œæˆ–æ˜¯è·¨ç¯€é» topic çš„è¨­å®šèˆ‡ç‹€æ…‹ã€‚å–åå«åš zookeeper å°±æ˜¯åœ¨å”èª¿æ··äº‚çš„åˆ†æ•£å¼ç³»çµ±ï¼Œ,è£¡é¢å„ç¨®ä¸åŒç¨®é¡çš„æœå‹™éƒ½è¦å”èª¿ï¼Œè±¡å€‹å‹•ç‰©åœ’ç®¡ç†å“¡ã€‚Zookeeper çš„å®˜æ–¹æ–‡ä»¶ æœ‰æ›´è©³ç´°çš„èªªæ˜ã€‚\nKafka çš„ç¯€é»è³‡è¨Šï¼Œèˆ‡ç•¶å‰ç‹€æ…‹ï¼Œæ˜¯æ”¾åœ¨ zookeeper ä¸Šï¼Œæˆ‘å€‘å¯ä»¥é€éä»¥ä¸‹æŒ‡ä»¤å–å¾—\n# é¦–å…ˆå…ˆå–å¾— zkCli çš„ cliï¼Œé€™å€‹åªæœ‰é€£é€²ä»»ä½•ä¸€å° zookeeper å…§éƒ¨éƒ½æœ‰ kubectl exec -it kafka-0-zookeeper-0 --container kafka-broker bash # ç”±æ–¼æ˜¯åœ¨ Pod å…§éƒ¨ï¼Œç›´æ¥ localhost è©¢å•æœ¬åœ° /usr/bin/zkCli.sh -server localhost:2181 Connecting to localhost:2181 2019-09-25 15:02:36,089 [myid:] - INFO [main:Environment@100] - Client environment:zookeeper.version=3.4.10-39d3a4f269333c922ed3db283be479f9deacaa0f, built on 03/23/2017 10:13 GMT 2019-09-25 15:02:36,096 [myid:] - INFO [main:Environment@100] - Client environment:host.name=kafka-0-zookeeper-0.kafka-0-zookeeper-headless.default.svc.cluster.local 2019-09-25 15:02:36,096 [myid:] - INFO [main:Environment@100] - Client environment:java.version=1.8.0_131 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.vendor=Oracle Corporation 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.home=/usr/lib/jvm/java-8-openjdk-amd64/jre 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.class.path=/usr/bin/../build/classes:/usr/bin/../build/lib/*.jar:/usr/bin/../share/zookeeper/zookeeper-3.4.10.jar:/usr/bin/../share/zookeeper/slf4j-log4j12-1.6.1.jar:/usr/bin/../share/zookeeper/slf4j-api-1.6.1.jar:/usr/bin/../share/zookeeper/netty-3.10.5.Final.jar:/usr/bin/../share/zookeeper/log4j-1.2.16.jar:/usr/bin/../share/zookeeper/jline-0.9.94.jar:/usr/bin/../src/java/lib/*.jar:/usr/bin/../etc/zookeeper: 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib/x86_64-linux-gnu/jni:/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/usr/lib/jni:/lib:/usr/lib 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.io.tmpdir=/tmp 2019-09-25 15:02:36,100 [myid:] - INFO [main:Environment@100] - Client environment:java.compiler=\u0026lt;NA\u0026gt; 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:os.name=Linux 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:os.arch=amd64 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:os.version=4.14.127+ 2019-09-25 15:02:36,101 [myid:] - INFO [main:Environment@100] - Client environment:user.name=zookeeper 2019-09-25 15:02:36,102 [myid:] - INFO [main:Environment@100] - Client environment:user.home=/home/zookeeper 2019-09-25 15:02:36,102 [myid:] - INFO [main:Environment@100] - Client environment:user.dir=/ 2019-09-25 15:02:36,105 [myid:] - INFO [main:ZooKeeper@438] - Initiating client connection, connectString=localhost:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@42110406 Welcome to ZooKeeper! 2019-09-25 15:02:36,160 [myid:] - INFO [main-SendThread(localhost:2181):ClientCnxn$SendThread@1032] - Opening socket connection to server localhost/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error) JLine support is enabled 2019-09-25 15:02:36,374 [myid:] - INFO [main-SendThread(localhost:2181):ClientCnxn$SendThread@876] - Socket connection established to localhost/127.0.0.1:2181, initiating session 2019-09-25 15:02:36,393 [myid:] - INFO [main-SendThread(localhost:2181):ClientCnxn$SendThread@1299] - Session establishment complete on server localhost/127.0.0.1:2181, sessionid = 0x16d67baf1310001, negotiated timeout = 30000 WATCHER:: WatchedEvent state:SyncConnected type:None path:null [zk: localhost:2181(CONNECTED) 0] å–å¾— kafka broker è³‡æ–™\n# List root Nodes $ ls / [cluster, controller, controller_epoch, brokers, zookeeper, admin, isr_change_notification, consumers, log_dir_event_notification, latest_producer_id_block, config] # Brokers çš„è³‡æ–™ç¯€é» $ ls /brokers [ids, topics, seqid] # List /brokers/ids å¾—åˆ°ä¸‰å€‹ kafka broker $ ls /brokers/ids [0, 1, 2] # åˆ—å‡ºæ‰€æœ‰ topic åç¨± ls /brokers/topics [ticker] ticker æ˜¯ä¸Šç¯‡ç¯„åˆ©ç”¨åˆ°çš„ topic\nç°¡å–®ä¾†èªªï¼Œzookeeper å­˜æ”¾é€™äº›ç‹€æ…‹èˆ‡ topic çš„ metadata\nå„²å­˜æ ¸å¿ƒçš„ç‹€æ…‹èˆ‡è³‡æ–™ï¼Œç‰¹åˆ¥æ˜¯ broker è¬ä¸€æ›æ‰ï¼Œä¹Ÿé‚„éœ€è¦ç¶­æŒçš„è³‡æ–™ å”èª¿å·¥ä½œï¼Œä¾‹å¦‚å”åŠ© broker è™•ç† quorumï¼Œç´€éŒ„ partition master ç­‰ # é›¢é–‹ zkCli quit Kafka é€™é‚Šä¸€æ¨£å…ˆé€£ç·šé€²å»ä¸€å° brokerï¼Œå–å¾— kafka binary\nkubectl exec -it kafka-0-0 --container kafka-broker bash ls /usr/bin/ | grep kafka kafka-acls kafka-broker-api-versions kafka-configs kafka-console-consumer kafka-console-producer kafka-consumer-groups kafka-consumer-perf-test kafka-delegation-tokens kafka-delete-records kafka-dump-log kafka-log-dirs kafka-mirror-maker kafka-preferred-replica-election kafka-producer-perf-test kafka-reassign-partitions kafka-replica-verification kafka-run-class kafka-server-start kafka-server-stop kafka-streams-application-reset kafka-topics kafka-verifiable-consumer kafka-verifiable-producer å¾ˆå¤šå·¥å…·ï¼Œæˆ‘å€‘é€™é‚Šåªæœƒçœ‹å…¶ä¸­å¹¾å€‹\ntopic è³‡è¨Š Topic çš„è³‡è¨Šï¼Œè·Ÿ zookeeper è¦\n# List topics /usr/bin/kafka-topics --list --zookeeper kafka-0-zookeeper ticker æ“ä½œ message å¾ topic å–å¾— message\n# This will create a new console-consumer and start consuming message to stdout /usr/bin/kafka-console-consumer \\ --bootstrap-server localhost:9092 \\ --topic engine_topic_soundwave_USD \\ --timeout 0 \\ --from-beginning å¦‚æœ ticker é‚£å€‹ example pod é‚„åœ¨åŸ·è¡Œï¼Œé€™é‚Šå°±æœƒæ”¶åˆ° ticker çš„æ¯ç§’ message\nå¦‚æœæ²’æœ‰ï¼Œä¹Ÿå¯ä»¥é–‹å•Ÿå¦ä¸€å€‹ broker çš„é€£ç·š\nkubectl exec -it kafka-0-1 --container kafka-broker bash # ä½¿ç”¨ producer çš„ console é€£å…¥ï¼Œtopic æŠŠ message å¡é€²å» /usr/bin/kafka-console-producer \\ --broker-list localhost:9092\\ --topic ticker tick [enter] tick [enter] kafka-console-consumer é‚£å€‹ terminal å°±æœƒæ”¶åˆ° message\ntick tick ç•¶ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ consumer group\n# Use consumer to check ticker topics /usr/bin/kafka-console-consumer \\ --bootstrap-server localhost:9092 \\ --topic ticker \\ --group test æœ‰åšéä¸Šé¢çš„æ“ä½œç”¢ç”Ÿ consumer groupï¼Œå°±å¯ä»¥é€é consumer APIï¼Œå–å¾— consumer group ç‹€æ…‹\n# Check consumer group /usr/bin/kafka-consumer-groups \\ --bootstrap-server localhost:9092 \\ --group ticker \\ --describe Consumer group 'test' has no active members. TOPIC PARTITION CURRENT-OFFSET LOG-END-OFFSET LAG CONSUMER-ID HOST CLIENT-ID ticker 0 23 23 0 - - - Topic è¨­å®šæ“ä½œ Topic è¨­å®šæ–‡ä»¶ åœ¨æ­¤\né€™é‚Šé€é kafka-configs å¾ zookeeper å–å¾— topic è¨­å®šï¼Œé€™é‚Šçš„ max.message.bytesï¼Œæ˜¯é€™å€‹ topic æ¯å€‹ message çš„æœ€å¤§ä¸Šé™ã€‚\n/usr/bin/kafka-configs --zookeeper kafka-0-zookeeper:2181 --describe max.message.bytes --entity-type topics Configs for topic '__consumer_offsets' are segment.bytes=104857600,cleanup.policy=compact,compression.type=producer Configs for topic 'ticker' are __consumer__offsets æ˜¯ç³»çµ±çš„ topic ï¼Œç´€éŒ„ç›®å‰ consumer è®€å–çš„ä½ç½®ã€‚\nticker æ²’æœ‰è¨­å®šï¼Œå°±æ˜¯ producer ç•¶åˆç”¢ç”Ÿ topic æ™‚æ²’æœ‰æŒ‡å®šï¼Œä½¿ç”¨ default å€¼\nç”±æ–¼æˆ‘å€‘å…¬å¸çš„ä½¿ç”¨æƒ…å¢ƒå¸¸å¸¸æœƒè¶…éï¼Œæ‰€ä»¥å¯ä»¥æª¢æŸ¥ producer app é‚£ç«¯é€å‡ºçš„ message å¤§å°ï¼Œåœ¨æ¯”è¼ƒé€™é‚Šçš„è¨­å®šã€‚ç•¶ç„¶ç¾åœ¨ ticker çš„ç¯„ä¾‹ï¼Œåªæœ‰ä¸€å€‹ 0-60 çš„æ•¸å€¼ï¼Œä¸¦ä¸æœƒè¶…éã€‚é€™å€‹å¯ä»¥åœ¨ helm install çš„æ™‚å€™ï¼Œä½¿ç”¨ value.yaml å‚³å…¥æ™‚æ›´æ”¹ã€‚\nä¸å–œæ­¡é€™å€‹å€¼ï¼Œå¯ä»¥æ›´æ”¹ï¼Œé€™é‚Šå¢åŠ åˆ° 16MB\nTOPIC=ticker /usr/bin/kafka-configs \\ --zookeeper kafka-3-zookeeper:2181 \\ --entity-type topics \\ --alter \\ --entity-name ${TOPIC} \\ --add-config max.message.bytes=16000000 Benchmark ä½¿ç”¨å…§å»ºå·¥å…·è·‘ benchmark\nProducer\n/usr/bin/kafka-producer-perf-test \\ --num-records 100 \\ --record-size 100 \\ --topic performance-test \\ --throughput 100 \\ --producer-props bootstrap.servers=kafka:9092 max.in.flight.requests.per.connection=5 batch.size=100 compression.type=none 100 records sent, 99.108028 records/sec (0.01 MB/sec), 26.09 ms avg latency, 334.00 ms max latency, 5 ms 50th, 70 ms 95th, 334 ms 99th, 334 ms 99.9th. Consumer\n/usr/bin/kafka-consumer-perf-test \\ --messages 100 \\ --broker-list=kafka:9092 \\ --topic performance-test \\ --group performance-test \\ --num-fetch-threads 1 ","permalink":"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e","title":"Kafka Operation Scripts"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næ‘˜è¦ åœ¨ Kubernetes ä¸­é€£ç·š kafka ä½¿ç”¨ golang library é€£ç·šåˆ° Kafka é€é kafka script æ“ä½œ kafka kubernetes ä¸­é€£ç·š kafka å…ˆçœ‹ä¸€çœ‹ kafka pods\n$ kubectl get pods --selector='app=kafka' NAME READY STATUS RESTARTS AGE kafka-1-0 1/1 Running 1 26d kafka-1-1 1/1 Running 0 26d kafka-1-2 1/1 Running 0 26d $ kubectl get pods -l 'app=zookeeper' NAME READY STATUS RESTARTS AGE kafka-1-zookeeper-0 1/1 Running 0 26d kafka-1-zookeeper-1 1/1 Running 0 26d kafka-1-zookeeper-2 1/1 Running 0 26d $ kubectl get pods -l 'app=kafka-exporter' NAME READY STATUS RESTARTS AGE kafka-1-exporter-88786d84b-z954z 1/1 Running 5 26d kubectl describe pods kafka-1-0 Name: kafka-1-0 Namespace: default Priority: 0 Node: gke-chechiachang-pool-1-e4622744-wcq0/10.140.15.212 Labels: app=kafka controller-revision-hash=kafka-1-69986d7477 release=kafka-1 statefulset.kubernetes.io/pod-name=kafka-1-0 Annotations: kubernetes.io/limit-ranger: LimitRanger plugin set: cpu request for container kafka-broker Status: Running IP: 10.12.6.178 Controlled By: StatefulSet/kafka-1 Containers: kafka-broker: Image: confluentinc/cp-kafka:5.0.1 Port: 9092/TCP Host Port: 0/TCP Command: sh -exc unset KAFKA_PORT \u0026amp;\u0026amp; \\ export KAFKA_BROKER_ID=${POD_NAME##*-} \u0026amp;\u0026amp; \\ export KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://${POD_IP}:9092 \u0026amp;\u0026amp; \\ exec /etc/confluent/docker/run Requests: cpu: 100m Liveness: exec [sh -ec /usr/bin/jps | /bin/grep -q SupportedKafka] delay=30s timeout=5s period=10s #success=1 #failure=3 Readiness: tcp-socket :kafka delay=30s timeout=5s period=10s #success=1 #failure=3 Environment: POD_IP: (v1:status.podIP) POD_NAME: kafka-1-0 (v1:metadata.name) POD_NAMESPACE: default (v1:metadata.namespace) KAFKA_HEAP_OPTS: -Xmx4G -Xms1G KAFKA_ZOOKEEPER_CONNECT: kafka-1-zookeeper:2181 KAFKA_LOG_DIRS: /opt/kafka/data/logs KAFKA_CONFLUENT_SUPPORT_METRICS_ENABLE: false KAFKA_DEFAULT_REPLICATION_FACTOR: 3 KAFKA_MESSAGE_MAX_BYTES: 16000000 KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 KAFKA_JMX_PORT: 5555 Mounts: /opt/kafka/data from datadir (rw) /var/run/secrets/kubernetes.io/serviceaccount from default-token-2tm8c (ro) Conditions: Volumes: datadir: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: datadir-kafka-1-0 ReadOnly: false default-token-2tm8c: Type: Secret (a volume populated by a Secret) SecretName: default-token-2tm8c Optional: false è¬›å¹¾å€‹é‡é»ï¼š\né€™é‚Šè·‘èµ·ä¾†çš„æ˜¯ kafka-brokerï¼Œæ¥æ”¶ producer èˆ‡ consumer ä¾†çš„ request é€™é‚Šç”¨çš„æ˜¯ statefulsetsï¼Œä¸æ˜¯å®Œå…¨ç„¡ç‹€æ…‹çš„ kafka brokerï¼Œè€ŒæŠŠ message è¨˜åœ¨ datadir ä¸Šï¼Œé™ä½æ•…éšœé‡å•Ÿæ™‚å¯èƒ½éºå¤±è³‡æ–™çš„é¢¨éšªã€‚ å•Ÿå‹•æ™‚ï¼ŒæŠŠ kubernetes æŒ‡å®šçš„ pod name å¡é€²ç’°å¢ƒè®Šæ•¸ï¼Œç„¶å¾Œä½œç‚ºç•¶å‰ broker çš„ ID æ²’æœ‰è¨­å®š Pod antiAffinityï¼Œæ‰€ä»¥æœ‰å¯èƒ½æœƒå•Ÿä¸‰å€‹ kafka çµæœä¸‰å€‹è·‘åœ¨åŒä¸€å° node ä¸Šï¼Œé€™æ¨£ node æ•…éšœå°±å…¨æ­»ï¼Œæ²’æœ‰HA Service \u0026amp; Endpoints çœ‹ä¸€ä¸‹ service èˆ‡ endpoints zookeeper èˆ‡ exporter æˆ‘å€‘é€™é‚Šå…ˆæ éä¸è«‡ï¼Œåˆ°å°ˆç« è¬›é«˜å¯ç”¨æ€§èˆ‡æœå‹™ç›£æ¸¬æ™‚ï¼Œå†ä¾†è¨è«–ã€‚\n$ kubectl get service -l 'app=kafka' NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kafka-1 ClusterIP 10.15.242.178 \u0026lt;none\u0026gt; 9092/TCP 26d kafka-1-headless ClusterIP None \u0026lt;none\u0026gt; 9092/TCP 26d å…©å€‹ services\nä¸€å€‹æ˜¯ cluster-ip serviceï¼Œæœ‰ single cluster IP èˆ‡ load-balanceï¼ŒDNS æœƒé kube-proxyã€‚ ä¸€å€‹æ˜¯ headless serviceï¼ŒDNS æ²’æœ‰é kube-proxyï¼Œè€Œæ˜¯ç”± endpoint controller ç›´æ¥ address recordï¼ŒæŒ‡å‘æŠŠç¬¦åˆ service selector çš„ podã€‚é©åˆåš service discoveryï¼Œä¸æœƒä¾è³´æ–¼ kubernetes çš„å¯¦ç¾ã€‚ è©³ç´°èªªæ˜åœ¨å®˜æ–¹æ–‡ä»¶\nç°¡å–®ä¾†èªªï¼Œkafka broker æœƒåš auto service discoveryï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ headless serviceã€‚\nå®¢æˆ¶ç«¯(consumer \u0026amp; producer) é€£å…¥æ™‚ï¼Œå‰‡ä½¿ç”¨ cluster-ip serviceï¼Œåš load balancingã€‚\n$ kubectl get endpoints -l 'app=kafka' NAME ENDPOINTS AGE kafka-1 10.12.1.14:9092,10.12.5.133:9092,10.12.6.178:9092 26d kafka-1-headless 10.12.1.14:9092,10.12.5.133:9092,10.12.6.178:9092 26d Golang Example é™„ä¸Šç°¡å–®çš„ Golang å®¢æˆ¶ç«¯ï¼Œå®Œæ•´ Github Repository åœ¨é€™é‚Š\npackage main import ( \u0026quot;context\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;strconv\u0026quot; \u0026quot;time\u0026quot; \u0026quot;github.com/segmentio/kafka-go\u0026quot; // ä½¿ç”¨çš„å¥—ä»¶ ) func main() { topic := \u0026quot;ticker\u0026quot; // æŒ‡å®š message è¦ä½¿ç”¨çš„ topic partition := 0 // æŒ‡å®š partitionï¼Œç”±æ–¼åº•ä¸‹é€£ç·šæŒ‡å®šé€£ç·šåˆ° partition çš„ leaderï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®š partition kafkaURL := \u0026quot;kafka-0:9092\u0026quot; // æŒ‡å®š kafkaURLï¼Œä¹Ÿå¯ä»¥é€é os.GetEnv() å¾ç’°å¢ƒè®Šæ•¸è£¡æ‹¿åˆ°ã€‚ // producer å°æŒ‡å®š topic, partition çš„ leader ç”¢ç”Ÿé€£ç·š producerConn, _ := kafka.DialLeader(context.Background(), \u0026quot;tcp\u0026quot;, kafkaURL, topic, partition) // ç¨‹å¼çµæŸæœ€å¾ŒæŠŠ connection é—œæ‰ã€‚ä¸é—œæœƒé€ æˆ broker ç´¯ç©å¤§é‡ connectionï¼Œéœ€è¦ç­‰å¾… broker ç«¯ timeout æ‰æœƒé‡‹æ”¾ã€‚ defer producerConn.Close() //producerConn.SetWriteDeadline(time.Now().Add(10 * time.Second)) // ä½¿ç”¨ go routine è·‘ä¸€å€‹ subprocess for loopï¼Œä¸€ç›´ç”¢ç”Ÿ message åˆ° kafka topicï¼Œé€™é‚Šçš„ç¯„ä¾‹æ˜¯æ¯ç§’æ¨ä¸€å€‹ç§’æ•¸ã€‚ go func() { for { producerConn.WriteMessages( kafka.Message{ Value: []byte(strconv.Itoa(time.Now().Second())), }, ) time.Sleep(1 * time.Second) } }() // make a new reader that consumes from topic-A, partition 0 r := kafka.NewReader(kafka.ReaderConfig{ Brokers: []string{kafkaURL}, Topic: topic, Partition: 0, MinBytes: 10e2, // 1KB MaxBytes: 10e3, // 10KB }) defer r.Close() //r.SetOffset(42) // å°å‡º reader æ”¶åˆ°çš„ message for { m, err := r.ReadMessage(context.Background()) if err != nil { break } fmt.Printf(\u0026quot;%v message at offset %d: %s = %s\\n\u0026quot;, time.Now(), m.Offset, string(m.Key), string(m.Value)) } } é€™é‚Šå¯ä»¥ä½¿ç”¨ Dockerfile åŒ…æˆä¸€å€‹ container imageï¼Œç„¶å¾Œä¸Ÿä¸Š kubernetes\næˆ‘ç¨æ™šè£œä¸€ä¸‹ docker image è·Ÿ deployment æ–¹ä¾¿å¤§å®¶æ“ä½œå¥½äº†ã€‚\næˆ–æ˜¯æ”‹äººæ¸¬è©¦ï¼Œç›´æ¥ kubectl run ä¸€å€‹ golang base image è®“å®ƒ sleepï¼Œç„¶å¾Œåœ¨é€£é€²å»\nkubectl run DEPLOYMENT_NAME --image=golang:1.13.0-alpine3.10 sleep 3600 kubectl exec -it POD_NAME sh # è£¡é¢æ²’æœ‰ Git è·Ÿ vim è£ä¸€ä¸‹ apk add git vim go get github.com/chechiachang/kafka-on-kubernetes cd src/github.com/chechiachang/kafka-on-kubernetes/ vim main.go go build . ./kafka-on-kubernetes 2019-09-24 14:20:46.872554693 +0000 UTC m=+9.154112787 message at offset 1: = 46 2019-09-24 14:20:47.872563087 +0000 UTC m=+9.154121166 message at offset 2: = 47 2019-09-24 14:20:48.872568848 +0000 UTC m=+9.154126926 message at offset 3: = 48 2019-09-24 14:20:49.872574499 +0000 UTC m=+9.154132576 message at offset 4: = 49 2019-09-24 14:20:50.872579957 +0000 UTC m=+9.154138032 message at offset 5: = 50 2019-09-24 14:20:51.872588823 +0000 UTC m=+9.154146892 message at offset 6: = 51 2019-09-24 14:20:52.872594672 +0000 UTC m=+9.154152748 message at offset 7: = 52 2019-09-24 14:20:53.872599986 +0000 UTC m=+9.154158060 message at offset 8: = 53 é€™æ¨£å°±é€£ä¸Šäº†ï¼Œå®Œæˆä¸€å€‹æœ€ç°¡å–®çš„ä½¿ç”¨ç¯„ä¾‹ã€‚\né€™å€‹ä¾‹å­å¤ªéç°¡å–®ï¼Œä¸Šä¸€ç¯‡è¬›çš„ consumer group, partitions, offset ä»€éº¼è¨­å®šå…¨éƒ½æ²’ç”¨ä¸Šã€‚å¯¦å‹™ä¸Šé€™äº›éƒ½éœ€è¦å¥½å¥½æ€è€ƒï¼Œä¸¦ä¸”ä¾æ“šéœ€æ±‚åšèª¿æ•´è¨­å®šã€‚\nClean up æŠŠæ¸¬è©¦ç”¨çš„ deployment å¹¹æ‰\nkubectl delete deployment DEPLOYMENT_NAME å°çµ ç°¡è¿° kafka åœ¨ kubernetes ä¸Šé‹è¡Œçš„ç‹€æ³ï¼Œé€£ç·šæ–¹æ³• Demo ä¸€å€‹å°ç¨‹å¼ ","permalink":"https://chechia.net/posts/2019-09-24-kafka-basic-usage/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e","title":"Kafka-basic-usage"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nå¯«äº†éƒ¨å±¬ï¼Œæœ¬æƒ³è«‡ä¸€ä¸‹ kafka çš„é«˜å¯ç”¨æ€§é…ç½®ï¼Œçœ‹åˆ°å¤§å¾·çš„ç•™è¨€ï¼Œæ‰æƒ³åˆ°æ‡‰è©²è¦å…ˆè·Ÿå„ä½ä»‹ç´¹ä¸€ä¸‹ kafkaï¼Œè·Ÿ kafka çš„ç”¨é€”ã€‚ä¹Ÿæ„Ÿè¬å¤§å¾·è·¯éç™¼å•ï¼Œæˆ‘ä¹Ÿæœƒé †ä»£èª¿æ•´å…§å®¹ã€‚ä»Šå¤©å°±èªªæ˜ä½•ç‚º kafkaï¼Œä»¥åŠåœ¨ä»€éº¼æ¨£çš„ç‹€æ³ä½¿ç”¨ã€‚\næ‘˜è¦ ç°¡ä»‹ kafka åŸºæœ¬å…ƒä»¶ Kafka çš„å·¥ä½œæµç¨‹ ç°¡ä»‹ Kafka Kafka æ˜¯åˆ†æ•£å¼çš„ streaming platformï¼Œå¯ä»¥ subscribe \u0026amp; publish è¨Šæ¯ï¼Œå¯ä»¥ç•¶ä½œæ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„ message queue ç³»çµ±ï¼Œç”±æ–¼åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œè®“ kafka æœ‰å¾ˆå¤§ç¨‹åº¦çš„ fault toleranceã€‚åŸç‰ˆçš„èªªæ˜åœ¨é€™é‚Š\né€™é‚Šæœ‰å¹¾å€‹æ±è¥¿è¦è§£é‡‹ã€‚\nMessage Queue System ç•¶ä¸€å€‹ç³»çµ±é–‹å§‹é‹ä½œæ™‚ï¼Œè£¡é ­æœƒæœ‰å¾ˆå¤šè®Šæ•¸ï¼Œé€™äº›è®Šæ•¸å…¶å¯¦å°±æ˜¯åœ¨ä¸€å®šçš„ç¯„åœ(scopeï¼‰å…§ï¼Œåšè¨Šæ¯(message)çš„å‚³éã€‚ä¾‹å¦‚åœ¨ app å¯«äº†ä¸€å€‹ function ï¼Œå‚³å…¥ä¸€å€‹è®Šæ•¸çš„å€¼çµ¦ functionã€‚\nåœ¨è¤‡é›œçš„ç³»çµ±ä¸­ï¼Œæœå‹™å…ƒä»¶å½¼æ­¤ä¹Ÿæœƒæœ‰å‚³éè¨Šæ¯çš„éœ€æ±‚ã€‚ä¾‹å¦‚æˆ‘åŸæœ¬æœ‰ä¸€å€‹ api-serverï¼Œå…¶ä¸­ä¸€æ®µç¨‹å¼ç¢¼æ˜¯æ•ˆèƒ½ç“¶é ¸ï¼Œæˆ‘æŠŠå®ƒåˆ‡å‡ºä¾†ç¨ç«‹æˆä¸€å€‹ worker çš„å…ƒä»¶ï¼Œè®“å®ƒå¯ä»¥åœ¨æ›´é«˜æ•ˆèƒ½åœ°æ–¹åŸ·è¡Œï¼Œç”šè‡³ horizontal scalingã€‚é€™ç¨®æƒ…å¢ƒï¼Œè¾¨å¯èƒ½æ­²éœ€è¦æŠŠä¸€éƒ¨åˆ†çš„ message å¾ api-server å‚³åˆ° workerï¼Œworker æŠŠåƒæ•ˆèƒ½çš„å·¥ä½œåšå®Œï¼Œå†æŠŠçµæœå›å‚³çµ¦ api-serverã€‚é€™æ™‚å°±æœƒéœ€è¦ä¸€å€‹ç©©å®šçš„ message queue systemï¼Œä¾†ç©©å®šï¼Œä¸”é«˜æ•ˆèƒ½çš„å‚³éé€™äº› messageã€‚\nMessage Queue System å¯¦åšå¾ˆå¤šï¼ŒActiveMQ, RabbitMQ, \u0026hellip; ç­‰ï¼Œä¸€äº› database åš message queue åœ¨æŸäº›æ‡‰ç”¨å ´æ™¯ä¸‹ä¹Ÿååˆ†é©åˆï¼Œä¾‹å¦‚ Redis æ˜¯ in-memory key-value databaseï¼Œå…§éƒ¨ä¹Ÿå¯¦åš pubsubï¼Œèƒ½å¤ åœ¨æŸäº›ç’°å¢ƒç©©å®šçš„å‚³é€ messageã€‚\nRequest-Response vs Publish-Subscribe è¨Šæ¯çš„å‚³é€æœ‰å¾ˆå¤šæ–¹å¼ï¼Œä¾‹å¦‚ Http request-response å¾ˆé©åˆ server åœ¨ç„¡ç‹€æ…‹(stateless) ä¸‹æ¥å—ä¾†è‡ªå®¢æˆ¶ç«¯çš„è¨Šæ¯ï¼Œæ¯æ¬¡å‚³é€éƒ½é‡æ–°å»ºç«‹æ–°çš„ http connectionï¼Œé€™æ¨£åšæœ‰å¾ˆå¤šå¥½è™•ä¹Ÿå¾ˆå¤šå£è™•ã€‚å…¶ä¸­æ˜é¡¯çš„å£è™•æ˜¯ç¶²è·¯è³‡æºçš„æµªè²»ï¼Œä»¥åŠè¨Šæ¯çš„ä¸å¤ å³æ™‚ï¼ŒæŒ‡å®šç‰¹å®šæ”¶ä»¶äººæ™‚ç™¼ä»¶äººæœƒé€ æˆé¡å¤–è² æ“”ç­‰ã€‚\nä½¿ç”¨ Pub-sub patternçš„å¥½è™•ï¼Œæ˜¯ publisher ä¸éœ€è¦é¡å¤–è™•ç†ã€é€™å€‹è¨Šæ¯è¦é€çµ¦èª°ã€çš„å·¥ä½œï¼Œè€Œæ˜¯è®“ subscriber ä¾†è¨‚é–±éœ€è¦çš„è¨Šæ¯é¡åˆ¥ï¼Œä¸€æœ‰æ–°çš„ event é€åˆ°è©²è¨Šæ¯é¡åˆ¥ï¼Œç›´æ¥é€é broker æ¨æ’­çµ¦ subscriberã€‚ä¸åƒ…å³æ™‚ï¼Œç¯€çœæ•ˆèƒ½ï¼Œè€Œä¸”è¨‚é–±çš„å½ˆæ€§å¾ˆå¤§ã€‚\nKafka producer \u0026amp; Consumer API Kafka ä½œç‚º client èˆ‡ server å…©é‚Šçš„æºé€šå¹³å°ï¼Œæä¾›äº†è¨±å¤š API è‘›ä¸åŒè§’è‰²ä½¿ç”¨ã€‚Producer ç”¢ç”Ÿ message åˆ°ç‰¹å®š topic ä¸Šï¼Œconsumer è¨‚é–±ç‰¹å®š topicsï¼Œkafak æŠŠç¬¦åˆæ¢ä»¶çš„è¨Šæ¯æ¨æ’­çµ¦ consumerã€‚\nProducer API: è®“ app publish ä¸€é€£çš„è¨Šæ¯ Consumer API: è®“ app subscribe è¨±å¤šç‰¹å®š topicï¼Œä¸¦è™•ç†è¨Šæ¯ä¸²æµ(stream) Stream API: è®“ app ä½œç‚ºä¸²æµä¸­ä»‹è™•ç†(stream processor) Connect API: èˆ‡ producer èˆ‡ consumer å¯ä»¥å°å¤–éƒ¨æœå‹™é€£çµ Topics \u0026amp; Logs Topic æ˜¯ kafka ç‚ºè¨Šæ¯ä¸²æµæä¾›çš„æŠ½è±¡ï¼Œtopic æ˜¯è¨Šæ¯å‚³é€åˆ° kafka æ™‚è³¦äºˆçš„é¡åˆ¥(category)ï¼Œä½œç‚º publish èˆ‡ consume çš„åˆ¤æ–·ä¾æ“šã€‚\nPartition è¨Šæ¯ä¾æ“š topic åˆ†é¡å­˜æ”¾ï¼Œä¸¦å¯ä»¥ä¾æ“š replication factor è¨­å®šï¼Œåœ¨ kafka ä¸­å­˜æ”¾å¤šå€‹è¨Šæ¯åˆ†å‰²(partition)ã€‚partition å¯ä»¥æƒ³æˆæ˜¯ message queue çš„å¹³è¡ŒåŒ– (parallel)ï¼Œä½µç™¼è™•ç†è¨Šæ¯å¯ä»¥å¤§å¹…ææ˜‡è¨Šæ¯æ¥æ”¶èˆ‡ç™¼é€çš„é€Ÿåº¦ï¼Œä¸¦ä¸”å¤šå€‹å‰¯æœ¬ä¹Ÿæé«˜è³‡æ–™çš„å¯ç”¨æ€§ã€‚\nç”±æ–¼è¨Šæ¯ç™¼é€è·Ÿæ¥æ”¶éç¨‹å¯èƒ½å› ç‚ºç¶²è·¯èˆ‡ç’°å¢ƒè€Œä¸ç©©å®šï¼Œé€™äº›ç›¸åŒ topic çš„ partition ä¸ä¸€å®šæœƒå®Œå…¨ä¸€æ¨£ã€‚ä½† kafka ç¢ºä¿äº†ä»¥ä¸‹å¹¾é»ã€‚\nGuarantees è‰¯å¥½é…ç½®çš„ kafka æœ‰ä»¥ä¸‹ä¿è­‰\nè¨Šæ¯åœ¨ç³»çµ±ä¸­é€å‡ºè·Ÿè¢«æ”¶åˆ°çš„æ™‚é–“ä¸ä¸€å®šï¼Œä½†kafakä¸­ï¼Œå¾ç›¸åŒ producer é€å‡ºçš„è¨Šæ¯ï¼Œé€åˆ° topic partition æœƒç¶­æŒé€å‡ºçš„é †åº Consumer çœ‹è¦‹çš„è¨Šæ¯æ˜¯èˆ‡ kafka ä¸­çš„å­˜æ”¾é †åºä¸€è‡´ æœ‰ replication factor ç‚º N çš„ topic ï¼Œå¯ä»¥å®¹å¿(fault-tolerance) N-1 å€‹ kafka-server å£æ‰ï¼Œè€Œä¸å½±éŸ¿è³‡æ–™ã€‚ ç•¶ç„¶ï¼Œé€™é‚Šçš„å‰ææ˜¯æœ‰è‰¯å¥½é…ç½®ã€‚éŒ¯èª¤çš„é…ç½®å¯èƒ½æœƒå°è‡´è¨Šæ¯ä¸ç©©å®šï¼Œæ•ˆèƒ½ä½è½ï¼Œç”šè‡³éºå¤±ã€‚\nProducer Producer è² è²¬æŠŠè¨Šæ¯æ¨å‘ä¸€å€‹ topicï¼Œä¸¦æŒ‡å®šè¨Šæ¯æ‡‰è©²æ”¾åœ¨ topic çš„å“ªå€‹ partitionã€‚\nConsumer Consumer æœƒè‡ªè¡Œæ¨™è¨˜ï¼Œå½¢æˆ consumer groupï¼Œé€é consumer group ä¾†ä¿éšœè¨Šæ¯å‚³éçš„æ¬¡åºï¼Œå®¹éŒ¯ï¼Œä»¥åŠæ“´å±•çš„æ•ˆç‡ã€‚\nConsumer é€é consumer group å…±äº«ä¸€å€‹ group.idã€‚ Consumer group å»æ‰€æœ‰ partitions è£¡æ‹¿è¨Šæ¯ï¼Œæ‰€æœ‰ partitions çš„è¨Šæ¯åˆ†é…åˆ° consumer group ä¸­çš„ consumerã€‚ app åœ¨æ¥æ”¶è¨Šæ¯æ™‚ï¼Œè¨­ç½®æ­£ç¢ºçš„åŒ–ï¼Œåœ¨ä¸€å€‹ consumer group ä¸­ï¼Œå¯ä»¥å®¹å¿ consumer å¤±æ•ˆï¼Œä»èƒ½ç¢ºä¿è¨Šæ¯ä¸€æŒ‡å®šçš„æ¬¡åºé€é”ã€‚åœ¨éœ€è¦å¤§æµé‡æ™‚ï¼Œä¹Ÿå¯èª¿æ•´ consumer çš„æ•¸é‡æé«˜è² è¼‰ã€‚\nç”¨ä¾‹ kafka çš„ä½¿ç”¨ä¾‹å­éå¸¸çš„å¤šï¼Œä½¿ç”¨ç¯„åœéå¸¸å»£æ³›ã€‚\nåŸºæœ¬ä¸Šæ˜¯è¨Šæ¯å‚³éçš„ä½¿ç”¨ä¾‹å­ï¼Œkafka å¤§å¤šèƒ½å‹ä»»ã€‚\nå°çµ é€™é‚Šåªæäº† kafka çš„åŸºæœ¬æ¦‚å¿µï¼ŒåŸºæœ¬å…ƒä»¶ï¼Œä»¥åŠ consumer group æ©Ÿåˆ¶ï¼Œç‚ºæˆ‘å€‘åº•ä¸‹è¦è«‡çš„ configuration èˆ‡ topology é‹ªè·¯ã€‚\n","permalink":"https://chechia.net/posts/2019-09-23-kafka-introduction/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e","title":"Kafka-introduction"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\n","permalink":"https://chechia.net/posts/2019-09-23-kafka-helm-configuration/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e","title":"Kafka Helm Configuration"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nELK Stack Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ ç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nç¢å¿µ 30 å¤©æ¯å¤©ä¸€æ–‡çœŸçš„è »é€¼äººçš„ï¼Œæ¯ä¸€ç¯‡éƒ½æ˜¯æ–°å¯«ï¼Œé‚„è¦ç›¡å¯èƒ½é¡§åŠæ–‡ç« å“è³ªï¼Œä¸‹ç­è¶•æ–‡ç« ï¼Œå„ä½å¤§å¾·å¯«çœ‹çœ‹å°±çŸ¥é“\né€™é‚Šèª¿æ•´äº†ç•¶åˆæƒ³å¯«çš„æ–‡ç« ï¼Œå…§å®¹æ‡‰è©²éƒ½æœƒå¸¶åˆ° elk kafka-ha reids-ha prometheus kubernetes on gcp ä½†ä¸æœƒå†ä¸€ç¯‡ 10000 å­—äº†ï¼Œé€¼æ­»æˆ‘å§\u0026hellip; å¯«ä¸å®Œçš„éƒ¨ä»½ 30 å¤©å€™æœƒåœ¨ITé‚¦å¹«å¿™ï¼Œæˆ–æ˜¯æˆ‘çš„ Github Page https://chechia.net/è£œå®Œ å¯«æ–‡ç« çœŸçš„æ˜¯é«”åŠ›æ´»ï¼Œè¦ºå¾—æˆ‘çš„æ–‡ç« é‚„æœ‰åƒè€ƒåƒ¹å€¼ï¼Œè«‹å·¦é‚Šå¹«æˆ‘é»è®šæŒ‰å€‹å–œæ­¡ï¼Œå³ä¸Šè§’å¹«æˆ‘æŒ‰å€‹è¿½ç¸±ï¼Œåº•ä¸‹æ­¡è¿ç•™è¨€è¨è«–ã€‚çµ¦æˆ‘ä¸€é»ç¹¼çºŒèµ°ä¸‹å»çš„å‹•åŠ›ã€‚\næ‘˜è¦ ç°¡ä»‹ kafka éƒ¨å±¬ kafka åˆ° kubernetes ä¸Š ç°¡ä»‹ kafka Kafka æ˜¯åˆ†æ•£å¼çš„ streaming platformï¼Œå¯ä»¥ subscribe \u0026amp; publish è¨Šæ¯ï¼Œå¯ä»¥ç•¶ä½œæ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„ message queue ç³»çµ±ï¼Œç”±æ–¼åˆ†æ•£å¼çš„æ¶æ§‹ï¼Œè®“ kafka æœ‰å¾ˆå¤§ç¨‹åº¦çš„ fault toleranceã€‚\næˆ‘å€‘ä»Šå¤©å°±ä¾†éƒ¨å±¬ä¸€å€‹ kafkaã€‚\nDeploy æˆ‘æŠŠæˆ‘çš„å¯¶è—éƒ½åœ¨é€™äº†https://github.com/chechiachang/kafka-on-kubernetes\nä¸‹è¼‰ä¸‹ä¾†çš„ .sh ï¼Œè·‘ä¹‹å‰é¤Šæˆç¿’æ…£è²“ä¸€ä¸‹\ncat install.sh #!/bin/bash # # https://github.com/helm/charts/tree/master/incubator/kafka #HELM_NAME=kafka HELM_NAME=kafka-1 helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator # Stable: chart version: kafka-0.16.2\tapp version: 5.0.1 helm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml Helm æˆ‘å€‘é€™é‚Šç”¨ helm éƒ¨å±¬ï¼Œä¹‹æ‰€ä»¥ç”¨ helm ï¼Œå› ç‚ºé€™æ˜¯æˆ‘æƒ³åˆ°æœ€ç°¡å–®çš„æ–¹æ³•ï¼Œèƒ½è®“è¼•é¬†æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´çš„ kafkaã€‚æ‰€ä»¥æˆ‘å€‘å…ˆç”¨ã€‚\næ²’ç”¨é helm çš„å¤§å¾·å¯ä»¥åƒè€ƒ Helm Quickstartï¼Œå…ˆæŠŠ helm cli èˆ‡ kubernetes ä¸Šçš„ helm tiller éƒ½è¨­å®šå¥½\nhelm init Helm Chart ä¸€å€‹ helm chart å¯ä»¥ç•¶æˆä¸€å€‹ç¨ç«‹çš„å°ˆæ¡ˆï¼Œä¸åŒçš„ chart å¯ä»¥åœ¨ kubernetes ä¸Šå”åŠ©éƒ¨å±¬ä¸åŒçš„é …ç›®ã€‚\né€™é‚Šä½¿ç”¨äº†é‚„åœ¨ incubator çš„chartï¼Œé›–ç„¶æ˜¯ prod readyï¼Œä¸éä½¿ç”¨ä¸Šé‚„æ˜¯è¦æ³¨æ„ã€‚\nä½¿ç”¨å‰å…ˆæŠŠ incubator çš„ helm repo åŠ é€²ä¾†\nhelm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator Install é€™é‚Šæ˜¯ç”¨ upgrade \u0026ndash;installï¼Œå·²å®‰è£å°± upgradeï¼Œæ²’å®‰è£å°± installï¼Œä¹‹å¾Œå¯ä»¥ç”¨é€™å€‹æŒ‡ä»¤å‡ç‰ˆ\nhelm upgrade --install ${HELM_NAME} incubator/kafka --version 0.16.2 -f values-staging.yaml Version é€™é‚Šä½¿ç”¨çš„ç‰ˆæœ¬ï¼š\nchart version: kafka-0.16.2 app version: 5.0.1 kafka Image: confluentinc/cp-kafka:5.0.1 zookeeper Image: gcr.io/google_samples/k8szk:v3 kafka exporter: danielqsj/kafka-exporter:v1.2.0 values-staging é€é helm chartï¼ŒæŠŠå•Ÿå‹•åƒæ•¸å¸¶é€²å»ï¼Œé€™é‚Šæˆ‘å€‘çœ‹å¹¾å€‹æ¯”è¼ƒé‡è¦çš„ï¼Œç´°ç¯€ä¹‹å¾Œçš„æ–‡ç« åœ¨ä¸€èµ·è¨è«–ã€‚\nhttps://github.com/chechiachang/kafka-on-kubernetes/blob/master/values-staging.yaml\nreplicas: 3 å®‰è£ä¸‰å€‹ kafkaï¼Œtopology çš„æ±è¥¿ä¹Ÿæ˜¯æ•¬å¾…ä¸‹ç¯‡XD\n## The kafka image repository image: \u0026quot;confluentinc/cp-kafka\u0026quot; ## The kafka image tag åº•å±¤åŸ·è¡Œçš„ kafka æ˜¯ conluent kafka Configure resource requests and limits ref: http://kubernetes.io/docs/user-guide/compute-resources/ resources: {}\nlimits: cpu: 200m memory: 4096Mi requests: cpu: 100m memory: 1024Mi kafkaHeapOptions: \u0026ldquo;-Xmx4G -Xms1G\u0026rdquo;\né€™é‚Šå¯ä»¥èª¿æ•´åœ¨ kubernetes ä¸Šé¢çš„ limit è·Ÿ request * Deploy æœƒå…ˆå»è·Ÿ node å•å¤ ä¸å¤ ï¼Œå¤ çš„è©±è¦æ±‚ node ä¿ç•™é€™äº›è³‡æºçµ¦ Pod * Runtime è¶…é limitï¼ŒPod æœƒè¢« kubernetes å¹¹æ‰ï¼Œä¸éæˆ‘å€‘æ˜¯ JVMï¼Œå¤–éƒ¨ resource çˆ†æ‰å‰ï¼Œæ‡‰è©²æœƒå…ˆå›  heap æ»¿è€Œæ­»ã€‚ä¸€å€‹æ–½ä¸»è‡ªç›¡çš„æ„Ÿè¦ºã€‚ * CPU è »çœçš„ï¼Œåƒæ¯”è¼ƒå¤šæ˜¯ memoryã€‚ä½†ä¹Ÿè¦çœ‹ä½ çš„ä½¿ç”¨æƒ…å¢ƒ prometheus\nå°æˆ‘å€‘æœ‰ä¸Š promethuesï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ kafka-exporter æŠŠ kafka metrics å€’å‡ºå» prometheusï¼Œé€™å€‹ä¹Ÿæ˜¯è©³è¦‹ä¸‹å›åˆ†è§£ã€‚ # è·‘èµ·ä¾†äº† $ kubectl get po | grep kafka\nNAME READY STATUS RESTARTS AGE kafka-1-0 1/1 Running 0 224d kafka-1-1 1/1 Running 0 224d kafka-1-2 1/1 Running 0 224d kafka-1-exporter-88786d84b-z954z 1/1 Running 0 224d kafka-1-zookeeper-0 1/1 Running 0 224d kafka-1-zookeeper-1 1/1 Running 0 224d kafka-1-zookeeper-2 1/1 Running 0 224d\n","permalink":"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eELK Stack\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKafka HA on Kubernetes(6)\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-22-kafka-deployment-on-kubernetes/\"\u003eDeploy kafka-ha\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-23-kafka-introduction/\"\u003eKafka Introduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-24-kafka-basic-usage/\"\u003ekafka åŸºæœ¬ä½¿ç”¨\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-operation-scripts/\"\u003ekafka operation scripts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-25-kafka-ha-topology/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA topology\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-26-kafka-ha-continued/\"\u003eé›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePrometheus Metrics Exporter å¾ˆé‡è¦\u003c/li\u003e\n\u003cli\u003eæ•ˆèƒ½èª¿æ ¡\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"ç¢å¿µ\"\u003eç¢å¿µ\u003c/h1\u003e\n\u003cp\u003e30 å¤©æ¯å¤©ä¸€æ–‡çœŸçš„è »é€¼äººçš„ï¼Œæ¯ä¸€ç¯‡éƒ½æ˜¯æ–°å¯«ï¼Œé‚„è¦ç›¡å¯èƒ½é¡§åŠæ–‡ç« å“è³ªï¼Œä¸‹ç­è¶•æ–‡ç« ï¼Œå„ä½å¤§å¾·å¯«çœ‹çœ‹å°±çŸ¥é“\u003c/p\u003e","title":"Kafka Deployment on Kubernetes"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\næ‘˜è¦ ç°¡ä»‹ logstash å°‡ logstash éƒ¨å±¬åˆ° kubernetes ä¸Š è¨­å®š logstash pipeline è™•ç† nginx access log ä»‹ç´¹ Logstash Logstash æ˜¯é–‹å…ƒçš„è³‡æ–™è™•ç†å¼•æ“ï¼Œå¯ä»¥å‹•æ…‹çš„å°‡è¼¸å…¥çš„è³‡æ–™åšå¤§é‡çš„è™•è£¡ã€‚åŸå…ˆçš„ç›®çš„æ˜¯è™•ç† log ï¼Œä½†ç›®å‰ä»¥ä¸é™æ–¼è™•ç† log ï¼Œå„ç¨® ELK beat æˆ–æ˜¯å…¶ä»–ä¾†æºçš„ä¸åŒç›£æ¸¬æ•¸æ“šï¼Œéƒ½èƒ½è™•ç†ã€‚\nLogastash å…§éƒ¨çš„åŠŸèƒ½ä¹Ÿå¤§å¤šæ¨¡çµ„åŒ–ï¼Œå› æ­¤å¯ä»¥çµ„è£ä¸åŒçš„ pluginï¼Œä¾†å¿«é€Ÿè™•ç†ä¸åŒä¾†æºè³‡æ–™ã€‚\nåŸºæœ¬ä¸Šå¸¸è¦‹çš„è³‡æ–™ä¾†æºï¼Œlogstash éƒ½èƒ½å¤ è™•ç†ï¼Œä¸¦ä¸”æœ‰å¯«å¥½çš„ plugin å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œç´°ç¯€è«‹è¦‹logstash å®˜æ–¹æ–‡ä»¶\nå¾Œé€è³‡æ–™åº«èˆ‡æœ€çµ‚å„²å­˜åº« åœ¨é–‹å§‹æ¶è¨­ logstash è¦å…ˆè€ƒæ…® pipeline è™•ç†éå¾Œé€çš„è³‡æ–™åº«ï¼Œå¯ä½¿ç”¨çš„è³‡æ–™åº«éå¸¸å¤šï¼Œé€™é‚Šæœƒå±•ç¤ºçš„æœ‰ï¼š\nELK Stack æ¨™æº–é…å‚™é€åˆ° Elasticsearch å­˜æ”¾æœƒæ™‚å¸¸æŸ¥è©¢çš„ç†±è³‡æ–™ï¼Œåªå­˜æ”¾ä¸€æ®µæ™‚é–“å‰çš„è³‡æ–™ å¤ªèˆŠçš„è³‡æ–™è‡ªå‹• Rollout æœ€çµ‚ archieving çš„è³‡æ–™åº«ï¼Œé€™é‚Šä½¿ç”¨ GCP çš„ Big Query å­˜æ”¾æŸ¥æ‰¾æ¬¡æ•¸å°‘ï¼Œä½†éå¸¸å¤§é‡çš„æ­·å²ç´€éŒ„ã€‚ Elasticsearch åœ¨å‰å¹¾ç¯‡å·²ç¶“æ¶è¨­å¥½ï¼ŒGCP Big Query çš„è¨­å®šä¹Ÿäº‹å…ˆé–‹å¥½ã€‚\néƒ¨å±¬ Logstash kubernetes resource çš„ yaml è«‹åƒè€ƒ æˆ‘çš„ github elk-kubernetes\nkubectl apply -f config-configmap.yaml kubectl apply -f pipelines-configmap.yam kubectl apply -f deployment.yaml kubectl apply -f service.yaml æ”¾ä¸Šå»çš„ resource\nconfig-configmap: Logstash æœå‹™æœ¬èº«å•Ÿå‹•çš„è¨­å®šåƒæ•¸ pipelines-configmap: Logstash çš„ pipelines è¨­å®šæª”æ¡ˆ Lostagh Deployment Logastash çš„æœå‹™ instance å¯ä»¥å‹•æ…‹ scalingï¼Œä¹Ÿå°±æ˜¯æœƒæœ‰è¤‡æ•¸ Logstash instance åšè² è¼‰å‡è¡¡ Logstash service å¯é€é kubernetes å…§éƒ¨çš„ kube-dns æœå‹™ é›†ç¾¤å…§çš„ filebeat å¯ä»¥ç›´æ¥é€é logstash.default.svc.chechiachang-cluster.local çš„ dns é€£ç·š logstash é›†ç¾¤å…§çš„ç¶²è·¯ï¼Œç›´æ¥ä½¿ç”¨ httpï¼ˆç•¶ç„¶ä½¿ç”¨ https ä¹Ÿæ˜¯å¯ä»¥ï¼Œç›¸é—œæ­¥é©Ÿè«‹è¦‹å‰å¹¾ç¯‡æ–‡ç« ï¼‰ ç°¡å–®è¬›ä¸€ä¸‹ kubernetes service çš„è² è¼‰å‡è¡¡ï¼Œé—œæ–¼ kubernetes service ç´°ç¯€é€™ç¯‡é™„ä¸Šæ–‡ä»¶\n$ kubectl get services NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE logstash ClusterIP 10.15.254.47 \u0026lt;none\u0026gt; 5044/TCP 182d $ kubectl get endpoints NAME ENDPOINTS AGE logstash 10.12.0.132:5044,10.12.10.162:5044,10.12.9.167:5044 + 12 more... 182d åœ¨ Kubernetes å…§éƒ¨æ¯å€‹ Pod éƒ½èƒ½çœ‹åˆ° logstash, logstash.default.svc.chechiachang-cluster.local é€™å…©å€‹ dns DNS ç›´æ¥æŒ‡å‘è¤‡æ•¸çš„ logstash endpointsï¼Œ æ¯ä¸€å€‹ ip éƒ½æ˜¯ kubernetes å…§éƒ¨é…ç½®çš„ä¸€å€‹ Pod çš„ IPï¼Œé–‹å•Ÿ 5044 çš„ logstash port Service çš„ load balance æ©Ÿåˆ¶è¦– service è¨­å®šï¼Œç´°ç¯€å¯ä»¥çœ‹é€™é‚Š è¬›åˆ°æœ€ç™½ï¼Œå°±æ˜¯ filebeat LOGSTASH URL è¨­å®šç‚º http://logstash å°±æœƒæ‰“åˆ°å…¶ä¸­ä¸€å° logstash\næ›´æ”¹ filebeat configmap\n$ kubectl edit configmap filebeat-configmap # Disable output to elasticsearch output.elasticsearch: enabled: false # Output to logstash output.logstash: hosts: [\u0026quot;logstash:5044\u0026quot;] protocol: \u0026quot;http\u0026quot; username: \u0026quot;elastic\u0026quot; password: è¨­å®š logstash é€™é‚Šè¦å…ˆèªªï¼Œlogstash ä¹Ÿæ”¯æ´ centralized configurationï¼Œå¦‚æœä½ çš„ logstash ä¸æ˜¯è·‘åœ¨ Kubernetes ä¸Šï¼Œæ²’è¾¦æ³•é…ç½®ä¸€å¥— configmap å°±æ‡‰ç”¨åˆ°å…¨éƒ¨çš„ instanceï¼Œè¨˜çš„ä¸€å®šè¦ä½¿ç”¨ã€‚\nLogastash çš„é‹è¡Œè¨­å®š logstash.ymlï¼Œé€™é‚Šæˆ‘å€‘æ²’æœ‰åšè¨­å®šï¼Œéƒ½æ˜¯é è¨­å€¼ï¼Œæœ‰éœ€æ±‚å¯ä»¥è‡ªè¡Œæ›´æ”¹\nç•¶ç„¶ä¹‹å¾Œè¦èª¿æ•´ batch size æˆ–æ˜¯ queue, cache ç­‰ç­‰æ•ˆèƒ½èª¿æ ¡ï¼Œä¹Ÿæ˜¯ä¾†é€™é‚Šæ”¹ï¼Œæ”¹å®Œ configmap ï¼Œrolling update logstash å°±å¯ä»¥ã€‚\né€™é‚Šä¸»è¦æ˜¯ä¾†è¬› pipeline è¨­å®šã€‚\n$ kubectl describe configmap pipelines-configmap apiVersion: v1 kind: ConfigMap metadata: name: logstash-pipelines namespace: elk labels: k8s-app: logstash data: # Nginx Template # https://www.elastic.co/guide/en/logstash/7.3/logstash-config-for-filebeat-modules.html#parsing-nginx nginx.conf: | ... Configmap è£¡é¢åªæœ‰ä¸€å€‹ pipelineï¼Œå°±æ˜¯ nginx.confï¼Œæˆ‘å€‘é€™é‚Šå°±åªæœ‰ä¸€æ¢ï¼Œé€™é‚Šä¸€æ®µä¸€æ®µçœ‹\nInput input { beats { # The lisening port of logstash port =\u0026gt; 5044 host =\u0026gt; \u0026quot;0.0.0.0\u0026quot; } } è¨­å®š Input ä¾†æºï¼Œæ˜¯ beat å¾ 5044 é€²ä¾†\nFilter æ¥ä¸‹ä¾†ä¸€å¤§æ®µæ˜¯ filterï¼Œæ¯å€‹ filter ä¸­é–“çš„ block éƒ½æ˜¯ä¸€å€‹ pluginï¼Œlogstash æ”¯æ´éå¸¸å¤šæœ‰è¶£çš„ plugin ï¼Œè™•ç†ä¸åŒä¾†æºçš„å·¥ä½œï¼Œç´°ç¯€è«‹çœ‹é€™ç¯‡\nfilter { # Ignore data from other source in case filebeat input is incorrectly configured. if [kubernetes][container][name] == \u0026quot;nginx-ingress-controller\u0026quot; { # Parse message with grok # Use grok debugger in kibana -\u0026gt; dev_tools -\u0026gt; grok_debugger grok { match =\u0026gt; { \u0026quot;message\u0026quot; =\u0026gt; \u0026quot;%{IPORHOST:[nginx][access][remote_ip]} - \\[%{IPORHOST:[nginx][access][remote_ip_list]}\\] - %{DATA:[nginx][access][user_name]} \\[%{HTTPDATE:[nginx][access][time]}\\] \\\u0026quot;%{WORD:[nginx][access][method]} %{DATA:[nginx][access][request_url]} HTTP/%{NUMBER:[nginx][access][http_version]}\\\u0026quot; %{NUMBER:[nginx][access][response_code]} %{NUMBER:[nginx][access][body_sent][bytes]} \\\u0026quot;%{DATA:[nginx][access][referrer]}\\\u0026quot; \\\u0026quot;%{DATA:[nginx][access][agent]}\\\u0026quot; %{NUMBER:[nginx][access][request_length]} %{NUMBER:[nginx][access][request_time]} \\[%{DATA:[nginx][access][proxy_upstream_name]}\\] %{DATA:[nginx][access][upstream_addr]} %{NUMBER:[nginx][access][upstream_response_length]} %{NUMBER:[nginx][access][upstream_response_time]} %{NUMBER:[nginx][access][upstream_status]} %{DATA:[nginx][access][req_id]}\u0026quot; } } # Match url parameters if has params grok { match =\u0026gt; { \u0026quot;[nginx][access][request_url]\u0026quot; =\u0026gt; \u0026quot;%{DATA:[nginx][access][url]}\\?%{DATA:[nginx][access][url_params]}\u0026quot; } } # Remove and add fields mutate { remove_field =\u0026gt; \u0026quot;[nginx][access][request_url]\u0026quot; add_field =\u0026gt; { \u0026quot;read_timestamp\u0026quot; =\u0026gt; \u0026quot;%{@timestamp}\u0026quot; } # Add fileset.module:nginx to fit nginx dashboard add_field =\u0026gt; { \u0026quot;[fileset][module]\u0026quot; =\u0026gt; \u0026quot;nginx\u0026quot;} add_field =\u0026gt; { \u0026quot;[fileset][name]\u0026quot; =\u0026gt; \u0026quot;access\u0026quot;} } # Parse date string into timestamp date { match =\u0026gt; [ \u0026quot;[nginx][access][time]\u0026quot;, \u0026quot;dd/MMM/YYYY:H:m:s Z\u0026quot; ] remove_field =\u0026gt; \u0026quot;[nginx][access][time]\u0026quot; } # Split url_parameters with \u0026amp; # /api?uuid=123\u0026amp;query=456 # become # nginx.access.url_params.uuid=123 nginx.access.url_params.query=456 kv { source =\u0026gt; \u0026quot;[nginx][access][url_params]\u0026quot; field_split =\u0026gt; \u0026quot;\u0026amp;\u0026quot; } # Parse useragent useragent { source =\u0026gt; \u0026quot;[nginx][access][agent]\u0026quot; target =\u0026gt; \u0026quot;[nginx][access][user_agent]\u0026quot; remove_field =\u0026gt; \u0026quot;[nginx][access][agent]\u0026quot; } # Search remote_ip with GeoIP database, output geoip information for map drawing geoip { source =\u0026gt; \u0026quot;[nginx][access][remote_ip]\u0026quot; target =\u0026gt; \u0026quot;[nginx][access][geoip]\u0026quot; #fields =\u0026gt; [\u0026quot;country_name\u0026quot;,\u0026quot;city_name\u0026quot;,\u0026quot;real_region_name\u0026quot;,\u0026quot;latitude\u0026quot;,\u0026quot;longitude\u0026quot;,\u0026quot;ip\u0026quot;,\u0026quot;location\u0026quot;] } # ============== # Remove message to reduce data # ============== if [nginx][access][url] { mutate { # source:/var/lib/docker/containers/6e608bfc0a437c038a1dbdf2e3d28619648b58a1d1ac58635f8178fc5f871109/6e608bfc0a437c038a1dbdf2e3d28619648b58a1d1ac58635f8178fc5f871109-json.log remove_field =\u0026gt; \u0026quot;[source]\u0026quot; # Origin message remove_field =\u0026gt; \u0026quot;[message]\u0026quot; #add_field =\u0026gt; { \u0026quot;[nginx][access][message]\u0026quot; =\u0026gt; \u0026quot;[message]\u0026quot;} remove_field =\u0026gt; \u0026quot;[nginx][access][message]\u0026quot; # url_params:client_id=1d5ffd378296c154d3e32e5890d6f4eb\u0026amp;timestamp=1546849955\u0026amp;nonce=9a52e3e6283f2a9263e5301b6724e2c0d723def860c4724c9121470152a42318 remove_field =\u0026gt; \u0026quot;[nginx][access][url_params]\u0026quot; } } } # nginx-ingress-controller } # filter Grok Grok æœ¬èº«çš„æ–‡ä»¶åˆæ˜¯ä¸€å¤§æ®µï¼Œå€‹äººå»ºè­°å„è·¯å¤§å¾·ï¼Œå¦‚æœè¦ä½¿ç”¨ï¼Œè«‹ç›´æ¥æœå°‹äººå®¶é…ç½®å¥½çš„è¨­å®šï¼Œä¸è¦è‡ªå·±å¯«\nçœŸçš„è¦å¯«çš„è©±è¦å–„ç”¨å·¥å…·\nKibana Grok Debugger YOUR_KIBANA_HOST/app/kibana#/dev_tools/grokdebugger æˆ–æ˜¯ä¸çŸ¥åå¤§å¾·è²¢ç»ç·šä¸Š Debugger grok { match =\u0026gt; { \u0026quot;message\u0026quot; =\u0026gt; \u0026quot;%{IPORHOST:[nginx][access][remote_ip]} - \\[%{IPORHOST:[nginx][access][remote_ip_list]}\\] - %{DATA:[nginx][access][user_name]} \\[%{HTTPDATE:[nginx][access][time]}\\] \\\u0026quot;%{WORD:[nginx][access][method]} %{DATA:[nginx][access][request_url]} HTTP/%{NUMBER:[nginx][access][http_version]}\\\u0026quot; %{NUMBER:[nginx][access][response_code]} %{NUMBER:[nginx][access][body_sent][bytes]} \\\u0026quot;%{DATA:[nginx][access][referrer]}\\\u0026quot; \\\u0026quot;%{DATA:[nginx][access][agent]}\\\u0026quot; %{NUMBER:[nginx][access][request_length]} %{NUMBER:[nginx][access][request_time]} \\[%{DATA:[nginx][access][proxy_upstream_name]}\\] %{DATA:[nginx][access][upstream_addr]} %{NUMBER:[nginx][access][upstream_response_length]} %{NUMBER:[nginx][access][upstream_response_time]} %{NUMBER:[nginx][access][upstream_status]} %{DATA:[nginx][access][req_id]}\u0026quot; } } å…¶å¯¦å°±æ˜¯ nginx çš„ access log\n1.2.3.4 - [1.2.3.4] - - [21/Sep/2019:07:21:21 +0000] \u0026quot;GET /v1/core/api/list?type=queued\u0026amp;timestamp=1569050481\u0026amp;nonce=d1e80e00381e0ba6e42d4601912befcf03fbf291748e77b178230c19cd1fdbe2 HTTP/1.1\u0026quot; 200 3 \u0026quot;-\u0026quot; \u0026quot;python-requests/2.18.4\u0026quot; 425 0.031 [default-chechiachang-server-80] 10.12.10.124:8003 3 0.031 200 f43db228afe66da67b2c7417d0ad2c04 é è¨­çš„ log é€ä»¶ä¾†ï¼Œæ ¼å¼æ˜¯ textï¼Œç¶“é pattern matching å¾Œè®Šæˆ json-like formatï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¾è³‡æ–™çµæ§‹å–å¾— .nginx.access.remote_ip é€™æ¨£çš„æ¬„ä½ï¼Œè®“åŸæœ¬çš„ access log å¾ text è®Šæˆå¯ä»¥æŸ¥æ‰¾çš„å…§å®¹ã€‚\nåŸæœ¬çš„ text é€é€² elasticsearch ç•¶ç„¶ä¹Ÿå¯ä»¥æŸ¥æ‰¾ï¼Œä½†å°±æœƒåœ¨ text è£¡é¢åšå…¨æ–‡æª¢ç´¢ï¼ŒåŠŸèƒ½å¾ˆä¾·é™ï¼Œæ•ˆç‡å¾ˆå·®ã€‚\nOutput logstash æ”¯æ´çš„ output ä»¥åŠè¨­å®šåœ¨é€™é‚Š\noutput { elasticsearch { hosts =\u0026gt; [\u0026quot;https://${ELASTICSEARCH_HOST}:${ELASTICSEARCH_PORT}\u0026quot;] user =\u0026gt; \u0026quot;${ELASTICSEARCH_USERNAME}\u0026quot; password =\u0026gt; \u0026quot;${ELASTICSEARCH_PASSWORD}\u0026quot; index =\u0026gt; \u0026quot;%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}\u0026quot; manage_template =\u0026gt; false } } Elasticsearch çš„é…ç½®å¾ˆå–®ç´”\noutput { google_bigquery { project_id =\u0026gt; ${GCP_PROJECT_ID} dataset =\u0026gt; ${GCP_BIG_QUERY_DATASET_NAME} csv_schema =\u0026gt; \u0026quot;path:STRING,status:INTEGER,score:FLOAT\u0026quot; json_key_file =\u0026gt; ${GCP_JSON_KEY_FILE_PATH} error_directory =\u0026gt; \u0026quot;/tmp/bigquery-errors\u0026quot; date_pattern =\u0026gt; \u0026quot;%Y-%m-%dT%H:00\u0026quot; flush_interval_secs =\u0026gt; 30 } } å…¶ä¸­çš„è®Šæ•¸ï¼Œæˆ‘å€‘å…¨éƒ½ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œåœ¨ deployment.yaml é…ç½®ï¼Œå•Ÿå‹• logstash pods æ™‚ä»£å…¥\nGCP_JSON_KEY_FILE_PATH é€™é‚Šè¦é…ç½®ä¸€éš» GCP çš„æœå‹™å¸³è™Ÿé‡‘é‘°ï¼Œä¸€å€‹æœ‰ Big Query å¯«å…¥æ¬Šé™çš„ service accountï¼ŒæŠŠ json ä½¿ç”¨ kubernetes secret æ”¾åˆ°é›†ç¾¤ä¸Šï¼Œç„¶å¾Œåœ¨ pod ä¸Šä½¿ç”¨ volume from secret æ›è¼‰é€²ä¾†ã€‚ csv_schema =\u0026gt; \u0026quot;path:STRING,status:INTEGER,score:FLOAT\u0026quot; é€™é‚Šè¦é…ç½®ä¹‹å¾Œæœƒå­˜å…¥ Big Query çš„ csv çµæ§‹\nå°çµ éƒ¨å±¬ Logstash deployment åˆ° kubernetes ä¸Š è¨­å®š pipelineï¼Œè¶…å¤š pluginï¼Œæ—ç¹ä¸åŠå‚™è¼‰ Grok é…ç½® Big Query output é…ç½® ","permalink":"https://chechia.net/posts/2019-09-21-logstash-on-gke/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\u003c/p\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"æ‘˜è¦\"\u003eæ‘˜è¦\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eç°¡ä»‹ logstash\u003c/li\u003e\n\u003cli\u003eå°‡ logstash éƒ¨å±¬åˆ° kubernetes ä¸Š\u003c/li\u003e\n\u003cli\u003eè¨­å®š logstash pipeline è™•ç† nginx access log\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"ä»‹ç´¹-logstash\"\u003eä»‹ç´¹ Logstash\u003c/h1\u003e\n\u003cp\u003eLogstash æ˜¯é–‹å…ƒçš„è³‡æ–™è™•ç†å¼•æ“ï¼Œå¯ä»¥å‹•æ…‹çš„å°‡è¼¸å…¥çš„è³‡æ–™åšå¤§é‡çš„è™•è£¡ã€‚åŸå…ˆçš„ç›®çš„æ˜¯è™•ç† log ï¼Œä½†ç›®å‰ä»¥ä¸é™æ–¼è™•ç† log ï¼Œå„ç¨® ELK beat æˆ–æ˜¯å…¶ä»–ä¾†æºçš„ä¸åŒç›£æ¸¬æ•¸æ“šï¼Œéƒ½èƒ½è™•ç†ã€‚\u003c/p\u003e","title":"Logstash on GKE"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\né€™ç¯‡ä¾†è¦ Kubernetes ç’°å¢ƒ(GKE)è£¡é¢çš„ log æŠ“å‡ºä¾†ï¼Œé€åˆ° ELK ä¸Šã€‚\nå®˜æ–¹æ–‡ä»¶ ï¼Œå¯«å¾—å¾ˆç°¡æ˜“ï¼Œå¦‚æœå·²ç¶“å¾ˆç†Ÿ kubernetes çš„äººå¯ä»¥ç›´æ¥è…¦è£œå…¶ä»–çš„éƒ¨å±¬è¨­å®šã€‚\né€™é‚Šæœ‰å¹¾å€‹åšæ³•ï¼Œä¾ç…§ filebeat éƒ¨ç½²çš„ä½ç½®èˆ‡æ”¶é›†ç›®æ¨™ç°¡å–®åˆ†ç‚ºï¼š\nnode: è™•ç†æ¯ä¸€å° node çš„ log ï¼ŒåŒ…å« system log èˆ‡ node ç›£æ¸¬è³‡æ–™(metrics) cluster: è™•ç† cluster ç­‰ç´šçš„ log, event æˆ–æ˜¯ metrics pod: é‡å°ç‰¹å®š pod ç›´æ¥å»æ›ä¸€å€‹ sidecar ä¸Šé¢çš„æ–¹æ³•æ˜¯å¯ä»¥æ··æ­çš„ï¼Œkubernetes å€‹å€‹å±¤ç´šæœ‰log è™•ç†æµç¨‹ï¼Œæˆ‘å€‘é€™é‚ŠæŠŠ log é€å¾€ç¬¬ä¸‰æ–¹å¹³å°ï¼Œä¹Ÿæ˜¯éœ€è¦ä¾ç…§åŸæœ¬çš„ log æµç¨‹ï¼Œå»æ”¶å–æˆ‘å€‘æƒ³æ”¶é›†çš„ logã€‚\nç°¡å–®ä¾†èªªï¼Œæ˜¯å»å°çš„åœ°æ–¹æ‰¾å°çš„ logã€‚åœ¨æ¶æ§‹ä¸Šè¦æ³¨æ„ scalability èˆ‡ resource åˆ†é…ï¼Œä¸è¦å½±éŸ¿æœ¬èº«æä¾›æœå‹™çš„ GKE ï¼Œä½†åˆèƒ½ç²å¾—ç›¡é‡å³æ™‚çš„ logã€‚\næˆ‘å€‘é€™é‚Šç›´æ¥é€²å…¥ kubernetes resource çš„è¨­å®šï¼Œåº•ä¸‹æœƒé™„ä¸Šåœ¨ GKE æ‰¾ log çš„éç¨‹ã€‚\nNode level log harvest ç‚ºæ¯ä¸€å€‹ node é…ç½® filebeatï¼Œç„¶å¾Œåœ¨ node ä¸Šé¢å°‹æ‰¾ logï¼Œç„¶å¾Œå¦‚æˆ‘å€‘ä¸Šç¯‡æ‰€æ•˜è¿°åŠ åˆ° input ï¼Œå°±å¯ä»¥æŠŠ log å€’å‡ºä¾†ã€‚\nç›´è¦ºæƒ³åˆ°å°±æ˜¯é€é daemonsets ç‚ºæ¯å€‹ node éƒ¨ç½²ä¸€å€‹ filebeat podï¼Œç„¶å¾Œ mount node çš„ log è³‡æ–™å¤¾ï¼Œåœ¨è¨­ç½® inputã€‚\nDeploy daemonsets kubernetes resource çš„ yaml è«‹åƒè€ƒ æˆ‘çš„ github elk-kubernetes\nçµ¦äºˆè¶³å¤ çš„ clusterrolebinding åˆ° elk\nkubectl apply -f filebeat/7.3.1/clusterrolebinding.yaml å…ˆæ›´æ”¹ filebeat çš„è¨­å®šï¼Œå¦‚ä½•è¨­å®š elasticsearch èˆ‡ kibanaï¼Œè«‹åƒè€ƒä¸Šç¯‡ã€‚è‡³æ–¼ input çš„éƒ¨ä»½å·²ç¶“é…ç½®å¥½äº†ã€‚\nvim filebeat/7.3.1/daemonsets-config-configmap.yaml kubectl apply -f filebeat/7.3.1/daemonsets-config-configmap.yaml éƒ¨å±¬ filebeat daemonsetsï¼Œæœƒæ¯ä¸€å€‹ node éƒ¨å±¬ä¸€å€‹ filebeat\nkubectl apply -f filebeat/7.3.1/daemonsets.yaml å–å¾— daemonsets çš„ç‹€æ…‹\nkubectl --namespcae elk get pods NAME READY STATUS RESTARTS AGE filebeat-bjfp9 1/1 Running 0 6m56s filebeat-fzr9n 1/1 Running 0 6m56s filebeat-vpkm7 1/1 Running 0 6m56s ... æœ‰è¨­å®šæˆåŠŸçš„è©±ï¼Œkibana é€™é‚Šå°±æœƒæ”¶åˆ° kubernetes ä¸Šé¢ pod çš„ log\nlog havest for specific pods ç”±æ–¼ kubernetes ä¸Šæˆ‘å€‘å¯ä»¥ä¾¿åˆ©çš„èª¿åº¦ filebeat çš„éƒ¨å±¬æ–¹å¼ï¼Œé€™é‚Šä¹Ÿå¯ä»¥ä¹Ÿå¯ä»¥ä½¿ç”¨ deployment ï¼Œé…åˆ pod affinityï¼ŒæŠŠ filebeat æ”¾åˆ°æŸå€‹æƒ³è¦ç›£æ¸¬çš„ podï¼Œé€™é‚Šçš„ä¾‹å­æ˜¯ nginx-ingress-controllerã€‚\nKubernetes ä¸Šæœ‰ä¸€å€‹æˆ–å¤šå€‹ nginx ingress controller éƒ¨å±¬ä¸€å€‹æˆ–å¤šå€‹ filebeat åˆ°æœ‰ nginx çš„ node ä¸Š filebeat å»æŠ“å– nginx çš„ inputï¼Œ ä¸¦ä½¿ç”¨ filebeat çš„ nginx module åšé è™•ç† nginx module é è¨­è·¯å¾‘éœ€è¦èª¿æ•´ï¼Œé€™é‚Šä½¿ç”¨ filebeat autodiscover ä¾†è™•ç† ä¸€æ¨£ apply å‰è¨˜å¾—å…ˆæª¢æŸ¥è·Ÿè¨­å®š\nvim filebeat/7.3.1/nginx-config-configmap.yaml kubectl apply -f filebeat/7.3.1/nginx-config-configmap.yaml éƒ¨å±¬ filebeat deployment ç”±æ–¼æœ‰è¨­å®š pod affinity ï¼Œé€™å€‹ filebeat åªæœƒè¢«æ”¾åˆ°æœ‰ nginx ingress controller çš„é€™å€‹ç¯€é»ä¸Šï¼Œä¸¦ä¸”ä¾ç…§ autodiscover è¨­å®šçš„æ¢ä»¶å»è’é›† nginx çš„ log\nkubectl apply -f filebeat/7.3.1/nginx-deployment.yaml æœ‰è¨­å®šæˆåŠŸçš„è©±ï¼Œkibana é€™é‚Šå°±æœƒæ”¶åˆ° kubernetes ä¸Šé¢ pod çš„ log\nå¦å¤–ï¼Œç”±æ–¼æœ‰å•Ÿå‹• nginx moduleï¼Œlogstash æ”¶åˆ°çš„å…§å®¹å·²ç¶“æ˜¯è™•ç†éå¾—å…§å®¹ã€‚\nGCP fluentd å¦‚æœæ˜¯ä½¿ç”¨ GKE çš„æœ‹å‹ï¼Œå¯ä»¥æŠ•éé–‹å•Ÿ stackdriver logging çš„åŠŸèƒ½ï¼ŒæŠŠé›†ç¾¤ä¸­æœå‹™çš„ log å€’åˆ° stackdriverï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ node -\u0026gt; (daemonsets) fluentd -\u0026gt; stackdriverã€‚\né€™å€‹ fluentd æ˜¯ GCP å¦‚æœæœ‰å•Ÿå‹• Stackdriver Logging çš„è©±ï¼Œè‡ªå‹•å¹«ä½ ç¶­è­·çš„ daemonsetsï¼Œè¨­å®šä¸å¯æ”¹ï¼Œæ”¹äº†æœƒè¢« overwrite æœƒå»ï¼Œæ‰€ä»¥ä¸å¤ªæ–¹ä¾¿å¾é€™é‚Šå‹•æ‰‹è…³ã€‚\nBtw stackdriver æœ€è¿‘å¥½åƒæ”¹ç‰ˆï¼Œç›®å‰åš example çš„ç‰ˆæœ¬å·²ç¶“è®Šæˆ lagency ï¼ˆæ·š\nä½†æˆ‘å€‘å…ˆå‡è¨­æˆ‘å€‘å°é€™å€‹ pod çš„ log å¾ˆæœ‰èˆˆè¶£ï¼Œç„¶å¾ŒæŠŠé€™é‚Šçš„ log é€é filebeat é€åˆ° ELK ä¸ŠXD\nå› ç‚º GKE é€é fluentd æŠŠ GKE ä¸Šé¢çš„ log å€’åˆ° stackdriverï¼Œè€Œæˆ‘å€‘æ˜¯æƒ³æŠŠ log å€’åˆ° ELKï¼Œæ—¢ç„¶é€™æ¨£æˆ‘å€‘çš„ input ä¾†æºæ˜¯ç›¸åŒçš„ï¼Œè€Œä¸”å¾ˆå¤šè™•ç†æ­¥é©Ÿéƒ½å¯ä»¥åœ¨ ELK ä¸Šé¢äº’é€šï¼ŒçœŸçš„å¯ä»¥å·çœ‹ä¸€ä¸‹ fluentd æ˜¯å»å“ªæ”¶é›† log ï¼Œæ€éº¼è™•ç† log pipelineï¼Œæˆ‘å€‘åªè¦åšç›¸æ‡‰è¨­å®šå°±å¥½ã€‚\nç•¢ç«Ÿ google éƒ½å¹«æˆ‘å€‘å¼„å¾—å¦¥å¦¥çš„ï¼Œä¸åƒè€ƒä¸€ä¸‹ä»–çš„æµç¨‹å¤ªå¯æƒœã€‚\nå·çœ‹ä¸€ä¸‹ GKE ä¸Š fluentd æ˜¯å»å“ªæ‰¾ log ï¼Œé€™å€‹æ˜¯ fluentd gcp configmapï¼Œé›–ç„¶çœ‹åˆ°é€™é‚Šæ„Ÿè¦ºæ‰¯é äº†ï¼Œä½†å› ç‚ºå¾ˆæœ‰è¶£æ‰€æœ‰æˆ‘å°±ç¹¼çºŒçœ‹ä¸‹å»ï¼Œå„ä½å¤§å¾·å¯ä»¥è·³éXD\nconfigmap ä¸­çš„é€™å€‹ input è¨­å®šæª”ï¼Œå…¶ä¸­ä¸€å€‹ source å°±æ˜¯ä¸€å€‹è³‡æ–™ä¾†æºï¼Œç›¸ç•¶æ–¼ filebeat çš„ inputã€‚é€™é‚Šé€™å€‹ source å°±æ˜¯å» /var/log/containers/*.log æ”¶ log\né€™é‚Šé‚„åšäº†å¹¾ä»¶äº‹ï¼š\næ‰“ä¸Š reform.* tagï¼Œè®“ä¸‹å€‹ match å¯ä»¥ æ”¶é€²å» pipeline è™•ç† é™„å¸¶ parse å‡º time containers.input.conf \u0026lt;source\u0026gt; @type tail path /var/log/containers/*.log pos_file /var/log/gcp-containers.log.pos # Tags at this point are in the format of: # reform.var.log.containers.\u0026lt;POD_NAME\u0026gt;_\u0026lt;NAMESPACE_NAME\u0026gt;_\u0026lt;CONTAINER_NAME\u0026gt;-\u0026lt;CONTAINER_ID\u0026gt;.log tag reform.* read_from_head true \u0026lt;parse\u0026gt; @type multi_format \u0026lt;pattern\u0026gt; format json time_key time time_format %Y-%m-%dT%H:%M:%S.%NZ \u0026lt;/pattern\u0026gt; \u0026lt;pattern\u0026gt; format /^(?\u0026lt;time\u0026gt;.+) (?\u0026lt;stream\u0026gt;stdout|stderr) [^ ]* (?\u0026lt;log\u0026gt;.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z \u0026lt;/pattern\u0026gt; \u0026lt;/parse\u0026gt; \u0026lt;/source\u0026gt; ä»–é€™é‚Šåšä¸€äº› error handlingï¼Œç„¶å¾Œç”¨ ruby (!) parseï¼Œé€™é‚Šå°±çœŸçš„å¤ªé ï¼Œç´°ç¯€å¤§å®¶å¯ä»¥ google ï¼¸ï¼¤ã€‚ä¸éé€™é‚Šä½¿ç”¨çš„ pattern matching æˆ‘å€‘å¾Œå¹¾ç¯‡åœ¨ logstash pipeline ä¸Šï¼Œä¹Ÿæœƒæœ‰æ©Ÿæœƒæåˆ°ï¼Œæ©Ÿåˆ¶æ˜¯é¡ä¼¼çš„ã€‚\n\u0026lt;filter reform.**\u0026gt; @type parser format /^(?\u0026lt;severity\u0026gt;\\w)(?\u0026lt;time\u0026gt;\\d{4} [^\\s]*)\\s+(?\u0026lt;pid\u0026gt;\\d+)\\s+(?\u0026lt;source\u0026gt;[^ \\]]+)\\] (?\u0026lt;log\u0026gt;.*)/ reserve_data true suppress_parse_error_log true emit_invalid_record_to_error false key_name log \u0026lt;/filter\u0026gt; \u0026lt;match reform.**\u0026gt; @type record_reformer enable_ruby true \u0026lt;record\u0026gt; # Extract local_resource_id from tag for 'k8s_container' monitored # resource. The format is: # 'k8s_container.\u0026lt;namespace_name\u0026gt;.\u0026lt;pod_name\u0026gt;.\u0026lt;container_name\u0026gt;'. \u0026quot;logging.googleapis.com/local_resource_id\u0026quot; ${\u0026quot;k8s_container.#{tag_suffix[4].rpartition('.')[0].split('_')[1]}.#{tag_suffix[4].rpartition('.')[0].split('_')[0]}.#{tag_suffix[4].rpartition('.')[0].split('_')[2].rpartition('-')[0]}\u0026quot;} # Rename the field 'log' to a more generic field 'message'. This way the # fluent-plugin-google-cloud knows to flatten the field as textPayload # instead of jsonPayload after extracting 'time', 'severity' and # 'stream' from the record. message ${record['log']} # If 'severity' is not set, assume stderr is ERROR and stdout is INFO. severity ${record['severity'] || if record['stream'] == 'stderr' then 'ERROR' else 'INFO' end} \u0026lt;/record\u0026gt; tag ${if record['stream'] == 'stderr' then 'raw.stderr' else 'raw.stdout' end} remove_keys stream,log \u0026lt;/match\u0026gt; ssh é€²å»é€› æƒ³çœ‹æ©Ÿå™¨ä¸Šå¯¦éš›çš„ log ç‹€æ³ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥ç›´æ¥ ssh é€²å»\nå…ˆé€é kubectl çœ‹ä¸€ä¸‹ pod\n$ kubectl get daemonsets --namespace kube-system NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE fluentd-gcp-v3.2.0 7 7 7 7 7 beta.kubernetes.io/fluentd-ds-ready=true 196d $ kubectl get pods --output wide --namespace kube-system NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES fluentd-gcp-scaler-1234567890-vfbhc 1/1 Running 0 37d 10.140.0. gke-chechiachang-pool-1-123456789-5gqn \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; fluentd-gcp-v3.2.0-44tl7 2/2 Running 0 37d 10.140.0. gke-chechiachang-pool-1-123456789-wcq0 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; fluentd-gcp-v3.2.0-5vc6l 2/2 Running 0 37d 10.140.0. gke-chechiachang-pool-1-123456789-tp05 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; fluentd-gcp-v3.2.0-6rqvc 2/2 Running 0 37d 10.140.0. gke-chechiachang-pool-1-123456789-5gqn \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; fluentd-gcp-v3.2.0-mmwk4 2/2 Running 0 37d 10.140.0. gke-chechiachang-pool-1-123456789-vxld \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; å…ˆé€é kubectl çœ‹ä¸€ä¸‹ node\n$ kubectl get node NAME STATUS ROLES AGE VERSION gke-chechaichang-pool-1-123456789-3bzp Ready \u0026lt;none\u0026gt; 37d v1.13.7-gke.8 gke-chechaichang-pool-1-123456789-5gqn Ready \u0026lt;none\u0026gt; 37d v1.13.7-gke.8 gke-chechaichang-pool-1-123456789-8n8z Ready \u0026lt;none\u0026gt; 37d v1.13.7-gke.8 ... gcloud compute ssh gke-chechaichang-pool-1-123456789-3bzp å¦‚ä½¿ç”¨å…¶ä»–é›²å¹³å°çš„ kubernetes serviceï¼Œæˆ–æ˜¯ bare metal çš„é›†ç¾¤ï¼Œè«‹ä¾ç…§å„è‡ªç³»çµ±çš„æ–¹å¼é€£é€²å»çœ‹çœ‹ã€‚\nssh node æ‰¾ log ssh é€²å»å¾Œå°±å¯ä»¥åˆ°è™•ä¾†æ¢éšªï¼Œé †ä¾¿çœ‹çœ‹ GKE è·‘åœ¨æ©Ÿå™¨ä¸Šåˆ°åº•åšäº†ä»€éº¼äº‹æƒ…ã€‚\nå¦‚æœå®˜æ–¹æœ‰å‡ºæ–‡ä»¶ï¼Œå¯èƒ½å¯ä»¥ä¸ç”¨é€²ä¾†çœ‹ã€‚å„ä½å¤§å¾·æœ‰ç™¼ç¾æ–‡ä»¶è«‹ç•™è¨€è·Ÿæˆ‘èªªã€‚æˆ‘å€‹äººå¾ˆå–œæ­¡è‡ªå·±æ¶é›†ç¾¤èµ·ä¾†é€£å°±å»çœ‹ï¼Œé¢å°ç…§å®˜æ–¹æ–‡ä»¶ä¸Šå¯«çš„æ±è¥¿ï¼Œç•¶ç„¶å¤§éƒ¨ä»½æ™‚å€™éƒ½æ˜¯æ–‡ä»¶æ²’æœ‰å¸¶åˆ°ï¼Œæœ‰å¾ˆå¤šç™¼ç¾ã€‚\n$ ls /var/log gcp-*-log.pos kube-proxy.log containers/ metrics/ pods/ ... /var/log/containers çœ‹ä¸€ä¸‹ï¼Œæ ¼å¼æ˜¯ pod_namespace_container é€™é‚Šæ˜¯ link åˆ° /var/log/pods/\n$ ls -al /var/log/containers lrwxrwxrwx 1 root root 105 Aug 12 07:42 fluentd-gcp-v3.2.0-st6cl_kube-system_fluentd-gcp-5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac.log -\u0026gt; /var/log/pods/kube-system_fluentd-gcp-v3.2.0-st6cl_b76bed0b-bcd4-11e9-a55c-42010a8c0008/fluentd-gcp/0.log çœ‹åˆ° pods å°±è¦ºå¾—æ˜¯ä½ äº†ï¼Œè£¡é¢æœ‰ pod è³‡æ–™å¤¾ï¼Œæ ¼å¼æ˜¯ namespace_pod_uuid\nls /var/log/pods default_pod-1-1234567890-fxxhp_uuid kube-system_fluentd-gcp-v3.2.0-st6cl_b76bed0b-bcd4-11e9-a55c-42010a8c0008 kube-system_heapster-v1.6.0-beta.1- kube-system_kube-proxy-gke- kube-system_l7-default-backend- kube-system_prometheus-to-sd- å†é€²å»æœ‰ container logï¼Œæ ¼å¼æ˜¯ pod_namespace_container.logï¼Œä¹Ÿæ˜¯ link\nls -al /var/log/pods/kube-system_fluentd-gcp-v3.2.0-st6cl_b76bed0b-bcd4-11e9-a55c-42010a8c0008/fluentd-gcp/ lrwxrwxrwx 1 root root 165 Aug 12 07:42 0.log -\u0026gt; /var/lib/docker/containers/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac-json.log æœ€çµ‚ link åˆ°\nsudo su $ ls -alh /var/lib/docker/containers/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac/ total 3.9M drwx------ 4 root root 4.0K Aug 12 07:42 . drwx------ 92 root root 20K Sep 18 11:28 .. -rw-r----- 1 root root 3.8M Sep 18 11:29 5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac-json.log drwx------ 2 root root 4.0K Aug 12 07:42 checkpoints -rw------- 1 root root 7.8K Aug 12 07:42 config.v2.json -rw-r--r-- 1 root root 2.3K Aug 12 07:42 hostconfig.json drwx------ 2 root root 4.0K Aug 12 07:42 mounts é ­å°¾å·å–µä¸€ä¸‹ï¼Œç¢ºå®šæ˜¯æˆ‘å€‘åœ¨æ‰¾çš„æ±è¥¿\nhead /var/lib/docker/containers/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac-json.log tail /var/lib/docker/containers/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac/5e38c9b63c8d767091b122a9aa48c576a88cc20b4470d9ca18a820afa5c168ac-json.log é€™æ¨£å°±æ‰¾åˆ°æˆ‘å€‘çš„ log äº†\nå°ç¯€ ä½¿ç”¨ filebeat å»æŸ¥æ‰¾ é€é kubernetes daemonsets å¯ä»¥å¿«é€Ÿä½ˆç½®ä¸€ä»½ filebeat åˆ°æ‰€æœ‰ nodeï¼Œä¸”è¨­å®šéƒ½æ˜¯ä¸€èµ·æ›´æ–° é€é kubernetes deployment å¯ä»¥æŒ‡å®š filebeat çš„ä½ç½®ï¼Œå»è·Ÿéš¨æƒ³è¦ç›£æ¸¬çš„æœå‹™ å¦‚æœä¸ç†Ÿ log è™•ç†æµç¨‹ï¼Œå¯ä»¥ç›´æ¥çœ‹å·çœ‹å¤§å» çš„æœå‹™ï¼Œæœƒæœ‰å¾ˆå¤šéˆæ„Ÿ æ²’äº‹å¯ä»¥å¤šè·‘é€² Kubernetes æœå‹™ç¯€é»é€›é€›ï¼Œæœ‰å¾ˆå¤šæœ‰è¶£çš„æ±è¥¿ ","permalink":"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\u003c/p\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eé€™ç¯‡ä¾†è¦ Kubernetes ç’°å¢ƒ(GKE)è£¡é¢çš„ log æŠ“å‡ºä¾†ï¼Œé€åˆ° ELK ä¸Šã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/en/beats/filebeat/7.3/running-on-kubernetes.html\"\u003eå®˜æ–¹æ–‡ä»¶\u003c/a\u003e ï¼Œå¯«å¾—å¾ˆç°¡æ˜“ï¼Œå¦‚æœå·²ç¶“å¾ˆç†Ÿ kubernetes çš„äººå¯ä»¥ç›´æ¥è…¦è£œå…¶ä»–çš„éƒ¨å±¬è¨­å®šã€‚\u003c/p\u003e\n\u003cp\u003eé€™é‚Šæœ‰å¹¾å€‹åšæ³•ï¼Œä¾ç…§ filebeat éƒ¨ç½²çš„ä½ç½®èˆ‡æ”¶é›†ç›®æ¨™ç°¡å–®åˆ†ç‚ºï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003enode: è™•ç†æ¯ä¸€å° node çš„ log ï¼ŒåŒ…å« system log èˆ‡ node ç›£æ¸¬è³‡æ–™(metrics)\u003c/li\u003e\n\u003cli\u003ecluster: è™•ç† cluster ç­‰ç´šçš„ log,  event æˆ–æ˜¯ metrics\u003c/li\u003e\n\u003cli\u003epod: é‡å°ç‰¹å®š pod ç›´æ¥å»æ›ä¸€å€‹ sidecar\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸Šé¢çš„æ–¹æ³•æ˜¯å¯ä»¥æ··æ­çš„ï¼Œkubernetes å€‹å€‹å±¤ç´šæœ‰\u003ca href=\"https://kubernetes.io/docs/concepts/cluster-administration/logging/\"\u003elog è™•ç†æµç¨‹\u003c/a\u003eï¼Œæˆ‘å€‘é€™é‚ŠæŠŠ log é€å¾€ç¬¬ä¸‰æ–¹å¹³å°ï¼Œä¹Ÿæ˜¯éœ€è¦ä¾ç…§åŸæœ¬çš„ log æµç¨‹ï¼Œå»æ”¶å–æˆ‘å€‘æƒ³æ”¶é›†çš„ logã€‚\u003c/p\u003e","title":"Monitoring GKE With Elk"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nELK çš„ beats æ˜¯è¼•é‡ç´šçš„ç³»çµ±ç›£æ¸¬æ”¶é›†å™¨ï¼Œbeats æ”¶é›†åˆ°çš„ data ç¶“é mapping å¯ä»¥é€åˆ° Elasticsearch å¾Œï¼Œé€²è¡Œå½ˆæ€§çš„æœå°‹æ¯”å°ã€‚\nbeat æœ‰è¨±å¤šç¨®é¡ï¼Œä¾æ“šæ”¶é›†çš„ data å€åˆ¥ï¼š\nAuditbeat: Audit data Filebeat: Log files Functionbeat: Cloud data Heartbeat: Availability Journalbeat: Systemd journals Metricbeat: Metrics Packetbeat: Network traffic Winlogbeat: Windows event logs é€™é‚Šå…ˆä»¥ filebeat ç‚ºä¾‹ï¼Œåœ¨ GCE ä¸Šæ”¶é›†åœ“ç«¯æœå‹™ç¯€é»ä¸Šçš„æœå‹™æ—¥èªŒèˆ‡ç³»çµ±æ—¥èªŒï¼Œä¸¦åœ¨ ELK ä¸­å‘ˆç¾ã€‚\nInstallation å®‰è£åŠ filebeat å®‰å…¨æ€§è¨­å®šçš„æ­¥é©Ÿï¼Œåœ¨é€™ç¯‡Secure ELK Stack ä¸­å·²ç¶“èªªæ˜ã€‚é€™é‚ŠæŒ‡é™„ä¸Šé€£çµï¼Œä»¥åŠå®˜æ–¹æ–‡ä»¶ æä¾›åƒè€ƒã€‚\nConfiguration é€™é‚Šè«‡å¹¾å€‹ä½¿ç”¨æ–¹é¢çš„è¨­å®šã€‚\né¦–å…ˆï¼Œapt å®‰è£çš„ filebeat é è¨­çš„ /etc/filebeat/filebeat.yml ä¸å¤ å®Œæ•´ï¼Œæˆ‘å€‘å…ˆåˆ° github æŠŠå°æ‡‰ç‰ˆæœ¬çš„å®Œæ•´è¼‰ä¸‹ä¾†ã€‚\nwget https://raw.githubusercontent.com/elastic/beats/master/filebeat/filebeat.reference.yml sudo mv filebeat.reference.yml /etc/filebeat/filebeat.yml Beats central management beats é€éæ‰‹å‹•æ›´æ”¹ config éƒ½å¯ä»¥ç›´æ¥è¨­å®šï¼Œä½†é€™é‚Šä¸æ¨è–¦åœ¨æ­¤è¨­å®šï¼Œç†ç”±æ˜¯\nç³»çµ±ä¸­é€šå¸¸æœƒæœ‰å¤§é‡çš„ filebeatï¼Œæ¯å€‹éƒ½è¦è¨­å®šï¼Œæ•¸é‡å¤šæ™‚æ ¹æœ¬ä¸å¯èƒ½ æ›´æ”¹è¨­å®šæ™‚ï¼Œå¦‚æœä¸ä¸€èµ·æ›´æ”¹ï¼Œæœƒé€ æˆè³‡æ–™æ ¼å¼ä¸çµ±ä¸€ï¼Œä¹‹å¾Œæ¸…ç†ä¹Ÿå¾ˆéº»ç…© æ¨è–¦çš„æ–¹å¼æ˜¯é€é Kibana å°æ‰€æœ‰ filebeat åšé›†ä¸­å¼çš„çš„ç®¡ç†é…ç½®ï¼Œåªè¦åˆå§‹è¨­å®šé€£ä¸Š kibanaï¼Œå‰©ä¸‹çš„éƒ½é€é kibana è¨­å®šã€‚æ–‡ä»¶åœ¨æ­¤ï¼Œæˆ‘å€‘æœ‰ç©ºæœ‰å¯ä»¥åˆ†ç¯‡è«‡é€™å€‹ä¸»é¡Œã€‚\nä¸éé€™é‚Šé‚„æ˜¯å¾…å¤§å®¶éä¸€ä¸‹å¹¾å€‹é‡è¦çš„è¨­å®šã€‚ç•¢ç«Ÿè¦åœ¨ kibana ä¸Šé…ç½®ï¼Œfilebeat çš„è¨­å®šæ¦‚å¿µé‚„æ˜¯è¦æœ‰ã€‚\nmodules filebeat æœ‰è¨±å¤šæ¨¡çµ„ï¼Œè£¡é¢å·²ç¶“åŒ…å«è¨±å¤šé è¨­çš„ template ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ default çš„è¨­å®šå»ç³»çµ±é è¨­çš„è·¯å¾‘æŠ“å–æª”æ¡ˆï¼Œä¸¦ä¸”å…ˆé€²ä¸€æ­¥è™•ç†ï¼Œæ¸›å°‘æˆ‘å€‘è¼¸å‡ºåˆ° logstash é‚„è¦å†åš pipeline é è™•ç†ï¼Œéå¸¸æ–¹ä¾¿ã€‚\nä¾‹å¦‚é€™å€‹ system module æœƒè™•ç†ç³»çµ±é è¨­çš„ log è·¯å¾‘ï¼Œåªè¦é–‹å•Ÿ module ï¼Œå°±æœƒè‡ªå‹•è™•ç†å°æ‡‰çš„ inputã€‚\n- module: system syslog: enabled: true å‰©ä¸‹çš„å°±æ˜¯ç…§éœ€æ±‚å•Ÿç”¨ module ï¼Œä¸¦ä¸”çµ¦äºˆå°æ‡‰çš„ inputã€‚\nELK ç‚ºè‡ªå·±çš„æœå‹™è¨­å®šäº†ä¸å°‘ module ï¼Œç›´æ¥å•Ÿç”¨å°±å¯ä»¥ç²å–é€™å”æœå‹™å…ƒä»¶é‹è¡Œçš„ log èˆ‡ç›£æ¸¬æ•¸å€¼ã€‚é€™ä¹Ÿæ˜¯ self-monitoring ç›£æ¸¬æ•¸æ“šçš„ä¸»è¦ä¾†æºã€‚\n- module: kibana - module: elasticsearch - module: logstash ... input filebeat æ”¯æ´è¤‡æ•¸ inputsï¼Œæ¯å€‹ input æœƒå•Ÿå‹•ä¸€å€‹æ”¶é›†å™¨ï¼Œè€Œ filebeat æ”¶é›†ç›®æ¨™æ˜¯ log æª”æ¡ˆã€‚åŸºæœ¬ä¸Šå¯ä»¥ç°¡å–®ç†è§£ç‚º filebeat å»è®€å–é€™äº› log æª”æ¡ˆï¼Œä¸¦ä¸”åœ¨ç³»çµ±ä¸Šç´€éŒ„è®€å–çš„é€²åº¦ï¼Œåµæ¸¬åˆ° log æœ‰å¢åŠ ï¼Œè®Šç¹¼çºŒè®€å–æ–°çš„ logã€‚\nfilebeat å…·é«”çš„å·¥ä½œæ©Ÿåˆ¶ï¼Œå¯ä»¥çœ‹é€™ç¯‡How Filebeat works?\né€™ç¯‡æ–‡ä»¶ä¹Ÿæåˆ° filebeat æ˜¯ç¢ºä¿è‡³å°‘ä¸€æ¬¡(at-least-once delivery)çš„æ•¸æ“šè®€å–ï¼Œä½¿ç”¨æ™‚è¦ç‰¹åˆ¥æ³¨æ„é‡è¤‡ç²å–çš„å¯èƒ½ã€‚\né¦–å…ˆæŠŠ input åŠ ä¸Š ubuntu é è¨­çš„ log è·¯å¾‘\nfilebeat.inputs: - type: log enabled: true paths: - /var/log/*.log é€™é‚Šæ³¨æ„ input æ”¯æ´å¤šç¨® typeï¼Œåƒç…§å®Œæ•´è¨­å®šæª”æ¡ˆçš„èªªæ˜é…åˆè‡ªå·±çš„éœ€æ±‚ä½¿ç”¨ã€‚\nProcessor åœ¨ filebeat ç«¯å…ˆé€²è¡Œè³‡æ–™çš„ç¬¬ä¸€å±¤è™•ç†ï¼Œå¯ä»¥å¤§å¹…è¬›å°‘ä¸å¿…è¦çš„è³‡æ–™ï¼Œé™ä½æª”æ¡ˆå‚³è¼¸ï¼Œä»¥åŠå° elasticsearch server çš„è² æ“”ã€‚\noutput output ä¹Ÿæ˜¯ filebeat ååˆ†é‡è¦çš„ä¸€ç’°ï¼Œå¥½çš„ filebeat output è¨­å®šï¼Œå¯ä»¥å¤§å¹…é™ä½æ•´é«” ELK stack çš„è² æ“”ã€‚å£çš„è¨­å®šä¹Ÿæœƒç›´æ¥å¡çˆ† ELK staskã€‚\noutput.elasticsearch: ç›´æ¥å‘å¾Œé€é€² elasticsearch output.logstash: å…ˆå‘å¾Œé€åˆ° logstash\né€™é‚Šéå¸¸æ¨è–¦å¤§å®¶ï¼Œæ‰€æœ‰çš„ beat å¾€å¾Œé€é€² elasticsearch ä¹‹å‰éƒ½å…ˆéä¸€å±¤ logstashï¼Œå°±ç®—ä½ çš„ logstash å…§éƒ¨å®Œå…¨ä¸æ›´æ”¹ dataï¼Œæ²’æœ‰ pipeline mutationï¼Œé‚„æ˜¯ä¸è¦çœé€™ä¸€å±¤ã€‚\nbeat çš„æ•¸é‡æœƒéš¨æ‡‰ç”¨æ„ˆä¾†è¶Šå¤šè€Œç·šæ€§å¢åŠ ï¼Œelasticsearch å¾ˆé›£ç·šæ€§ scaleï¼Œæˆ–æ˜¯ scale æˆæœ¬å¾ˆå¤§ filebeat æ²’æœ‰å¥½å¥½èª¿æ ¡çš„è©±ï¼Œå°æ–¼è¼¸å‡ºç«¯çš„ç¶²è·¯è² æ“”å¾ˆå¤§ï¼Œä¸åƒ…ä½”ç”¨å¤§é‡é€£ç·šï¼Œå‚³è¼¸æª”æ¡ˆçš„å¤§å°ä¹Ÿå¾ˆå¤§ã€‚ logstash çš„ queue èˆ‡å¾Œé€çš„ batch æ©Ÿåˆ¶æ¯” filebeat å¥½ä½¿ç”¨ filebeat æ˜¯æ”¶ log çš„ï¼Œé€šå¸¸ log çˆ†ç‚¸çš„æ™‚å€™ï¼Œæ˜¯æ‡‰ç”¨å‡ºå•é¡Œçš„æ™‚å€™ï¼Œé€™æ™‚å€™éœ€è¦ log äº¤å‰æ¯”å°ï¼Œç™¼ç¾ elasticsearch æµé‡ä¹Ÿçˆ†è¡ï¼Œåæ‡‰å¾ˆæ‡‰ç”¨ logstash é€éä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥å¾ˆè¼•æ˜“çš„ scaleï¼Œç”±æ–¼ pipeline æœ¬èº«å¯ä»¥åˆ†æ•£æ˜¯å¹³è¡Œè™•ç†ï¼Œscale logstash ä¸¦ä¸æœƒå½±éŸ¿è³‡æ–™æœ€çµ‚ç‹€æ…‹ã€‚ load balance æœ‰ç¶²å‹ç•™è¨€è©¢å• logstash å‰é¢çš„ load balance å¦‚ä½•è™•ç†æ¯”è¼ƒå¥½ï¼Œæˆ‘é€™é‚Šä¹Ÿé †ä¾¿é™„ä¸Šã€‚ä¸åªæ˜¯ logstash ï¼Œæ‰€æœ‰è‡ªèº«ç„¡ç‹€æ…‹(stateless) çš„æœå‹™éƒ½å¯ä»¥ç…§é€™æ¨£å» scaleã€‚\nåœ¨ kubernetes ä¸Šå¾ˆå¥½è™•ç†ï¼Œä½¿ç”¨ k8s é è¨­çš„ service å°±è¼•æ˜“ä½œåˆ°ç°¡æ˜“çš„ load balance\nè¨­ç½®è¤‡æ•¸ logstash instances ä½¿ç”¨ kubernetes å…§éƒ¨ç¶²è·¯ service å¯¦ç¾ load balancingã€‚ åœ¨ GCE ä¸Šå¯¦ç¾çš„è©±ï¼Œæˆ‘èªªå¯¦è©±æ²’å¯¦ä½œéï¼Œæ‰€ä»¥ä»¥ä¸‹æ˜¯éµç›¤å¯¦ç¾XDã€‚\nå®˜æ–¹æ–‡ä»¶ å»ºè­°ä½¿ç”¨ beats ç«¯è¨­å®šå¤šå€‹ logstash url ä¾†åš load balancingã€‚\nä½†æˆ‘ä¸æ˜¯å¾ˆå–œæ­¡ beat å»é…ç½®å¤šå€‹ logstash url çš„ä½œæ³•ï¼šbeat è¦æ„ŸçŸ¥ logstash æ•¸é‡è·Ÿ url ï¼Œå¢åŠ æ¸›å°‘ logstash instance é‚„è¦æ›´æ”¹ beats é…ç½®ï¼Œç”¢ç”Ÿé…ç½®çš„ä¾è³´è·Ÿè€¦åˆã€‚\næœ€å¥½æ˜¯åœ¨ logstash å‰éä¸€å±¤ HAproxy æˆ–æ˜¯é›²ç«¯æœå‹™çš„ Load balancerï¼ˆex. GCP https/tcp load balancerï¼‰ï¼Œbeat ç›´æ¥é€é€² load balance çš„ç«¯é»ã€‚\nautodiscover å¦‚æœæœ‰ä½¿ç”¨ container ï¼Œä¾‹å¦‚ docker æˆ– kubernetesï¼Œç”±æ–¼ container å…§çš„ log åœ¨ä¸»æ©Ÿä¸Šçš„ä½ç½®æ˜¯å‹•æ…‹è·¯å¾‘ï¼Œé€™é‚Šå¯ä»¥ä½¿ç”¨ autodiscover å»å°‹æ‰¾ã€‚\nåœ¨ kubernetes ä¸Šé¢çš„è¨­å®šï¼Œä¹‹å¾Œæœƒå¦é–‹ä¸€å¤©è¨è«–ã€‚\ndashboard kibana é è¨­æ˜¯ç©ºçš„ï¼Œæ²’æœ‰é å…ˆè¼‰å…¥ dashboardï¼Œä½†æˆ‘å€‘æœƒå¸Œæœ›è³‡æ–™é€é€²å»ï¼Œå°±æœ‰è¨­å®šå¥½çš„ dashboard ï¼Œåœ–åƒåŒ–æŠŠè³‡æ–™å‘ˆç¾å‡ºä¾†ã€‚é€™éƒ¨ä»½éœ€è¦å¾ beat é€™é‚Šå‘ kibana å¯«å…¥ã€‚\nåœ¨ä¸Šé¢çš„éƒ¨ä»½è¨­å®šå¥½ kibana çš„é€£ç·šè³‡æ–™ï¼Œæ²’æœ‰è¨­å®šçš„è©± beat å•Ÿå‹•æœƒè­¦å‘Šã€‚\nsetup.dashboards.enabled: true ä¸€èµ·ä¸­å°±æœƒæª¢æŸ¥ kibana æ˜¯å¦æœ‰åŒ¯å…¥ dashboardï¼Œæ²’æœ‰çš„è©±å°±åŒ¯å…¥ã€‚\nä¹Ÿæœƒä¸€ä½µåŒ¯å…¥ modules çš„ dashboardï¼Œä¾‹å¦‚å¦‚æœæœ‰å•Ÿç”¨ nginx module è™•ç† nginx çš„ access logï¼Œnginx module æœƒè™•ç† request source ip ï¼Œä¸¦é€é geoip database, å°‡ ip è½‰æœƒæˆç¶“ç·¯åº¦åº§æ¨™ã€‚é€™æ™‚å¦‚æœåœ¨ kibana ä¸Šæœ‰åŒ¯å…¥ nginx dashboardï¼Œå°±å¯ä»¥çœ‹åˆ°åœ–åƒåŒ–çš„å…¨çƒ request åˆ†ä½ˆåœ–ã€‚\nå°çµ å–å¾—å®Œæ•´ filebeat è¨­å®šæª”æ¡ˆä¸¦è¨­å®š filebeat ç›¡é‡é€é beat central management ä¾†ç®¡ç† beat çš„è¨­å®šæª” å•Ÿç”¨å°æ‡‰ module ä¾†æ›´å„ªé›…çš„è™•ç† log å¾Œé€åˆ° elasticsearch å‰çš„è³‡æ–™éƒ½å¿…é ˆç¶“éç²¾ç´°çš„è™•ç†ï¼Œé€é€²å»å¾Œå°±ä¸å¥½åˆªæ”¹äº† ","permalink":"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\u003c/p\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eELK çš„ beats æ˜¯è¼•é‡ç´šçš„ç³»çµ±ç›£æ¸¬æ”¶é›†å™¨ï¼Œbeats æ”¶é›†åˆ°çš„ data ç¶“é mapping å¯ä»¥é€åˆ° Elasticsearch å¾Œï¼Œé€²è¡Œå½ˆæ€§çš„æœå°‹æ¯”å°ã€‚\u003c/p\u003e\n\u003cp\u003ebeat æœ‰è¨±å¤šç¨®é¡ï¼Œä¾æ“šæ”¶é›†çš„ data å€åˆ¥ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAuditbeat: Audit data\u003c/li\u003e\n\u003cli\u003eFilebeat: Log files\u003c/li\u003e\n\u003cli\u003eFunctionbeat: Cloud data\u003c/li\u003e\n\u003cli\u003eHeartbeat: Availability\u003c/li\u003e\n\u003cli\u003eJournalbeat: Systemd journals\u003c/li\u003e\n\u003cli\u003eMetricbeat: Metrics\u003c/li\u003e\n\u003cli\u003ePacketbeat: Network traffic\u003c/li\u003e\n\u003cli\u003eWinlogbeat: Windows event logs\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé€™é‚Šå…ˆä»¥ filebeat ç‚ºä¾‹ï¼Œåœ¨ GCE ä¸Šæ”¶é›†åœ“ç«¯æœå‹™ç¯€é»ä¸Šçš„æœå‹™æ—¥èªŒèˆ‡ç³»çµ±æ—¥èªŒï¼Œä¸¦åœ¨ ELK ä¸­å‘ˆç¾ã€‚\u003c/p\u003e","title":"Monitoring GCE With ELK"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP å°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\næœ‰æ¿å‹å•åˆ°ï¼Œè¦å¦‚ä½•é¸æ“‡è¦ä¸è¦ç”¨ ELKï¼Œå…¶å¯¦ä¹Ÿé€™æ˜¯æ•´ç¯‡ ELK çš„åˆè¡·ã€‚é€™é‚Šåˆ†äº«ä¸€ä¸‹ ELK èˆ‡å…¶ä»–é¸æ“‡ï¼Œä»¥åŠé¸æ“‡è§£æ±ºæ–¹æ¡ˆæ‡‰è©²è€ƒæ…®çš„äº‹æƒ…ã€‚\nå…¶ä»–å¸¸ç”¨çš„æœå‹™ Prometheus: é–‹æºçš„ time series metrics æ”¶é›†ç³»çµ±\nStackdriver: GCP çš„ log èˆ‡ metrics å¹³å°\nElastic Cloud: ELK çš„ Sass\nSelf-hosted ELK\næˆ–æ˜¯ä¾ç…§éœ€æ±‚æ··æ­ï¼Œå„å€‹æœå‹™ä½¿ç”¨çš„å„å±¤å¥—ä»¶æ˜¯å¯ä»¥ç›¸å®¹ï¼Œä¾‹å¦‚\nåœ¨ GKE ä¸Šä¸ç”¨ beat å¯ä»¥ç”¨ fluentd\nPrometheus -\u0026gt; Stackdriver\nELK -\u0026gt; Stackdriver\nFluentd -\u0026gt; Prometheus \u0026hellip;\nSass vs cloud self-hosted vs on-premised\nMetrics: ELK vs Prometheus vs Stackdriver\nLogging: ELK vs Stackdriver\nå–æ¨åŸå‰‡ å„å€‹æ–¹æ³•éƒ½å„æœ‰åˆ©å¼Šï¼Œå®Œå…¨å–æ±ºæ–¼éœ€æ±‚\nå·²çŸ¥æ¢ä»¶é™åˆ¶ï¼Œä¾‹å¦‚å®‰å…¨æ€§è€ƒé‡å°±æ˜¯è¦æ”¾åœ¨ç§æœ‰ç¶²è·¯é˜²ç«ç‰†å…§ï¼Œæˆ–æ˜¯é ç®— è³‡æ–™è®€å–æ–¹å¼ï¼Œæœ‰æ²’æœ‰è¦äº¤å‰æ¯”å°æ”¶é›†çš„è³‡æ–™ï¼Œé‚„æ˜¯å–®ç´”ä¾ç…§æ™‚é–“åºæŸ¥è©¢ æˆ–æ˜¯è³‡æ–™é‡éå¸¸å¤§ï¼Œæ‡‰ç”¨æ•¸é‡éå¸¸å¤š ç¶­è­·çš„åœ˜éšŠï¼Œæœ‰æ²’æœ‰æƒ³ï¼Œæˆ–æœ‰æ²’æœ‰èƒ½åŠ›è‡ªå·±é¤Š self-host æœå‹™ Sass vs Self-hosted vs On-premised Sass: æŒ‡çš„æ˜¯ç›´æ¥ç”¨ Elasitc Cloudï¼Œæˆ–æ˜¯ç›´æ¥ä½¿ç”¨å…¬æœ‰é›²çš„æœå‹™(ex. åœ¨ GCP ä¸Šä½¿ç”¨ stackdriver)\nCloud Self-hosted: åœ¨å…¬æœ‰é›²ä¸Šä½¿ç”¨ ELK\nOn-Premised: è‡ªå·±åœ¨æ©Ÿæˆ¿æ­è¨­\nå®‰å…¨æ€§ çœ‹å…¬å¸çš„å®‰å…¨æ”¿ç­–ï¼Œå…è¨±å°‡æ—¥èªŒåŠç›£æ§æ•¸æ“šï¼Œé€åˆ°ç§æœ‰ç¶²è·¯ä»¥å¤–çš„åœ°æ–¹å—ï¼Ÿå¦‚æœåœ¨é˜²ç«ç‰†å…§ï¼Œæä¸å¥½ port æ ¹æœ¬å°±ä¸é–‹çµ¦ä½ ï¼Œæ ¹æœ¬ä¸ç”¨è€ƒæ…®ä½¿ç”¨å¤–éƒ¨æœå‹™ã€‚\nè¦çŸ¥é“æœå‹™çš„ log å…¶å¯¦å¯ä»¥çœ‹å‡ºå¾ˆå¤šæ±è¥¿ï¼å¦‚æœæœ‰ç‰¹åˆ¥åšè³‡æ–™åˆ†æï¼Œæ•æ„Ÿçš„è³‡æ–™ï¼Œé‡‘æµç›¸é—œæ•¸æ“šï¼Œé€šå¸¸ä¸æœƒæƒ³è¦å€’åˆ°ç¬¬ä¸‰æ–¹æœå‹™å¹³å°ã€‚\nå¯èƒ½æœ‰åšé‡‘æµçš„ï¼Œå…‰æ˜¯å®‰å…¨æ€§é€™é»ï¼Œå°±å¿…é ˆé¸æ“‡è‡ªæ¶ã€‚\næˆæœ¬ é‡‘éŒ¢æˆæœ¬ + ç¶­è­·æˆæœ¬\né‡‘éŒ¢æˆæœ¬å°±çœ‹å„å€‹æœå‹™çš„è¨ˆè²»æ–¹å¼\nElastic Cloud Pricing Self-hosted ELK \u0026amp; Prometheusï¼šæ©Ÿå™¨æˆæœ¬ å…¬æœ‰é›²æœå‹™(ex. GCP Stackdriver): ç”¨é‡è¨ˆè²» ç¶­è­·æˆæœ¬: å·¥ç¨‹å¸«çš„æœˆè–ª * æ¯å€‹æœˆè¦èŠ±åœ¨ç¶­è­·æœå‹™çš„å·¥æ™‚æ¯”ä¾‹\nä¸€èˆ¬ Sass ä»£ç®¡çš„æœå‹™ï¼Œæœƒé™ä½ç¶­è­·æˆæœ¬ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯åšåˆ°ç¶²é é»ä¸€é»å°±å¯ä»¥ç”¨ã€‚\nå¦‚æœå…¬å¸æœ‰å®Œæ•´çš„ç¶­è­·åœ˜éšŠï¼Œæœ‰æ©Ÿæˆ¿ï¼Œæœå‹™çš„ä½¿ç”¨é‡ä¹Ÿå¾ˆå¤§ï¼Œç•¶ç„¶ self-hosted æ˜¯æ¯”è¼ƒçœã€‚ ä¸­å°å‹ä¼æ¥­ä»¥åŠæ–°å‰µï¼Œæœå‹™åœ¨å…¬æœ‰é›²ä¸Šçš„ï¼Œç›´æ¥ä½¿ç”¨Sass æœå‹™å¾€å¾€æ¯”è¼ƒç¯€çœæˆæœ¬ï¼Œæœå‹™ç›´æ¥ç”± Sass ç¶­è­·ï¼Œç¯€çœå¾ˆå¤šæ©Ÿå™¨ä¸Šç®¡ç†è·Ÿæ—¥å¸¸ç¶­è­·ã€‚\né¿å…è¿·æ€ï¼Œè²·å¤–éƒ¨æœå‹™çš„å¸³å–®æ˜¯é¡¯æ€§çš„ï¼Œå ±å¸³æ™‚çœ‹å¾—åˆ°ï¼Œè€Œå·¥ç¨‹å¸«ç¶­è­·çš„æ™‚é–“æˆæœ¬æ˜¯éš±æ€§çš„ã€‚self-host å¯èƒ½çœä¸‹ Sass è²»ç”¨ï¼Œä½†å·¥ç¨‹å› ç‚ºåˆ†äº†æ™‚é–“å»ç¶­è­·ï¼Œè€Œå½±éŸ¿é€²åº¦ã€‚é€™éƒ¨åˆ†å°±çœ‹åœ˜éšŠå¦‚ä½•å–æ¨ã€‚\næ˜“ç”¨æ€§ å¦‚æœæ‡‰ç”¨éƒ½è·‘åœ¨å…¬æœ‰é›²ä¸Šï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨é›²å¹³å°æä¾›çš„ç›£æ¸¬æœå‹™ï¼Œä½¿ç”¨ä¾¿åˆ©ï¼Œè€Œä¸”æ•´åˆåº¦é«˜ã€‚ex GCP ä¸Šï¼Œè¦å•Ÿç”¨ Stackdriver æ˜¯éå¸¸è¼•é¬†çš„äº‹æƒ…ï¼Œåªæ˜¯æ”¹ä¸€å…©å€‹é¸é …ï¼Œå°±å¯ä»¥é–‹å•Ÿ / é—œé–‰ logging èˆ‡ metrics\nå¦‚æœæ˜¯ On-premised è‡ªå®¶æ©Ÿæˆ¿ï¼Œä¹Ÿè¨± self-hosted æœƒæ›´ç‚ºé©åˆã€‚\nå®¢è£½åŒ–ç¨‹åº¦ åœ¨å¤§å¤šæ•¸æ™‚å€™ï¼Œæ²’æœ‰éœ€è¦æ›´æ”¹åˆ°æœå‹™çš„æ ¸å¿ƒè¨­å®šï¼Œéƒ½å¯ä»¥ä¸å¯å¾‹å®¢è£½åŒ–ç¨‹åº¦ï¼Œç›´æ¥ä½¿ç”¨ Sass çš„è¨­å®šï¼Œå°±èƒ½æ»¿è¶³å¤§éƒ¨åˆ†éœ€æ±‚ã€‚å¯ä»¥ç­‰æœ‰æœ‰æ˜ç¢ºéœ€æ±‚å¾Œå†è€ƒæ…®é€™ä¸€é»ã€‚çŸ­æœŸå…§æ²’æœ‰ç‰¹æ®Šéœ€æ±‚å°±å¯ä»¥å¾ç°¡ä½¿ç”¨ã€‚\nä½¿ç”¨GKE åˆ° Stackdriver çš„è©±ï¼Œå°ä¸»æ©Ÿæœ¬èº«çš„æ©Ÿå™¨æ˜¯æ²’æœ‰æ§åˆ¶æ¬Šçš„ï¼ŒåŸ·è¡Œçš„ pipeline ä¹Ÿä¸å¤ªèƒ½æ›´æ”¹ Elastic Cloud æœ‰æä¾›ä¸Šå‚³ elasticsearch config æª”æ¡ˆçš„ä»‹é¢ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ›´æ”¹ server é‹è¡Œçš„åƒæ•¸è¨­å®š Self-Hosted é™¤äº†ä¸Šè¿°çš„è¨­å®šï¼Œé‚„å¯ä»¥ä¾ç…§éœ€æ±‚æ›´æ”¹ ELK / prometheus æœå‹™ï¼Œåœ¨å¯¦é«”æ©Ÿå™¨ä¸Šçš„ topologyï¼Œcpu è¨˜æ†¶é«”çš„è³‡æºé…ç½®ï¼Œå„²å­˜ç©ºé–“é…ç½®ç­‰ï¼Œå¯ä»¥æœ€å¤§åŒ–æ©Ÿå™¨çš„æ•ˆèƒ½ã€‚\nScalability è³‡æ–™æµé‡å¤§ï¼Œå„²å­˜ç©ºé–“æ¶ˆè€—å¤šï¼Œæœå‹™è² æ“”å¤§ï¼Œå¯èƒ½å°±æœƒéœ€è¦æ“´å±•ã€‚\nä¸€å€‹æ˜¯è³‡æ–™é‡çš„æ“´å±•ã€‚ä¸€å€‹æ˜¯ç‚ºäº†æ‡‰ä»˜æœå‹™çš„è² æ“”ï¼Œå° ELK æœå‹™å…ƒä»¶åšæ°´å¹³æ“´å±•ã€‚\né™¤äº† elasticsearch ä»¥çˆ²çš„å…ƒä»¶ï¼Œä¾‹å¦‚ kibanaï¼Œapm-server, beats éƒ½å¯ä»¥é€é kubernetes è¼•æ˜“çš„æ“´å±•ï¼Œå”¯æœ‰ elasticsearch ï¼Œç”±æ–¼åˆç‰½æ‰¯ä¸Šè¿°è³‡æ–™é‡çš„æ“´å±•ï¼Œä»¥åŠåˆ†ä½ˆï¼Œé‚„æœ‰å‰¯æœ¬ç®¡ç†ï¼Œindex æœ¬èº«çš„ lifecycle ç®¡ç†ã€‚Elasticsearch çš„ scaling è¨­å®šä¸Šæ˜¯è »è¤‡é›œçš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šå·¥è¦åšã€‚index çš„ shards / replicas è¨­å®šéƒ½è¦æ³¨æ„åˆ°ã€‚å¦å‰‡ä¸€è·¯ scale ä¸Šå»ï¼Œé›†ç¾¤å¤§çš„æ™‚å€™å½¼æ­¤ sharding sync çš„æ•ˆèƒ½æ¶ˆè€—æ˜¯å¦æœƒå¤ªé‡ã€‚\nStackdriver å¾ä½¿ç”¨è€…çš„è§’åº¦ï¼Œæ˜¯ä¸å­˜åœ¨æœå‹™ç¯€é»çš„æ“´å±•å•é¡Œï¼Œç¯€é»çš„ç¶­è­·å…¨éƒ½çµ¦ Sass ç®¡ç†ã€‚è³‡æ–™é‡çš„æ“´å±•å•é¡Œä¹Ÿä¸å¤§ï¼Œåªè¦æ•´ç†è³‡æ–™ pipelineï¼Œè®“æœ€å¾Œå„²å­˜çš„è³‡æ–™å®¹æ˜“è¢«æŸ¥æ‰¾ã€‚\nTimeseries vs non-timeseriese Prometheus æ˜¯è‡ªå¸¶ time series databaseï¼Œstackdriver ä¹Ÿæ˜¯ time series çš„å„²å­˜ã€‚ELK çš„ elasticsearch æ˜¯å…¨æ–‡æœç´¢å¼•æ“ï¼Œç”¨äº† timestamp åšåˆ†ææ‰€ä»¥å¯ä»¥åšåˆ° time series çš„è³‡æ–™ç´€éŒ„èˆ‡åˆ†æã€‚é€™é»åœ¨æœ¬è³ªä¸Šæ˜¯å®Œå…¨ä¸åŒçš„ã€‚\nå…‰åªè™•ç† time series dataï¼ŒPrometheus çš„ query æ•ˆèƒ½æ˜¯æ¯” elasticsearch å¥½å¾ˆå¤š Elasticsearch æœ‰å¤§é‡çš„ index ç¶­è­·ï¼Œéœ€è¦è¼ƒå¤šç³»çµ±è³‡æºè™•ç†ï¼Œåœ¨æ²’æœ‰ query å£“åŠ›çš„æƒ…å½¢ä¸‹æœƒæœ‰ç³»çµ±è‡ªå‹•ç¶­è­·çš„æ•ˆèƒ½æ¶ˆè€— ELK çš„è³‡æ–™ä¸éœ€è¦é å…ˆå»ºæ¨¡ï¼Œå°±å¯ä»¥åšåˆ°éå¸¸å½ˆæ€§çš„æœå°‹æŸ¥æ‰¾ã€‚Stackdriver çš„è©±ï¼Œç„¡æ³•ç”¨æœªå»ºæ¨¡çš„è³‡æ–™æ¬„ä½äº¤å‰æŸ¥æ‰¾ã€‚ Log æ”¶é›†æ–¹é¢ Elasticsearch ä¸­çš„è³‡æ–™æ¬„ä½é€é tempalte åŒ¯å…¥å¾Œï¼Œéƒ½æ˜¯æœ‰åš index ï¼Œæ‰€ä»¥äº¤å‰æŸ¥æ‰¾ï¼Œä¾‹å¦‚å¯ä»¥å¾ log text ä¸­åŒ…å«ç‰¹å®šå­—ä¸²çš„ç´€éŒ„ï¼Œåœ¨åš aggregate ç®—å‡ºå…¶ä»–æ¬„ä½çš„è³‡æ–™åˆ†ä½ˆã€‚æœƒæ¯”è¼ƒæ…¢ï¼Œä½†æ˜¯æ˜¯åšå¾—åˆ°çš„å…¨æ–‡æœç´¢ Stackdriver å¯ä»¥åšåŸºæœ¬çš„ filter ï¼Œä¾‹å¦‚ filter æŸå€‹æ¬„ä½ï¼Œä½†ä¸èƒ½åšå¤ªè¤‡é›œçš„äº¤å‰æ¯”å°ï¼Œä¹Ÿä¸èƒ½é‡å° text å…§å®¹ä½œäº¤äº’æŸ¥æ‰¾ï¼Œéœ€è¦æ›å‡ºä¾†å¦å¤–è™•ç†ã€‚ Metrics æ”¶é›†æ–¹é¢ (åŒä¸Š) Elasticsearch å¯ä»¥ç”¨å…¨æ–‡æœç´¢ï¼Œåšåˆ°å¾ˆè¤‡é›œçš„äº¤å‰æ¯”å°ï¼Œä¾‹å¦‚ï¼šå¾ metrics æ•¸å€¼ï¼Œè¨ˆç®—åœ¨æ™‚é–“ç¯„åœçš„åˆ†ä½ˆæƒ…å½¢(cpu è¶…é 50% è½åœ¨ä¸€å¤© 24 å°æ™‚ï¼Œå„å€‹å°æ™‚çš„æ¬¡æ•¸) Stackdriver åªèƒ½åšåŸºæœ¬çš„ time series æŸ¥æ‰¾ï¼Œç„¶å¾Œé€éé å…ˆå®šç¾©å¥½çš„ field filter è³‡æ–™ï¼Œå†å„è‡ªåœ–åƒåŒ–ã€‚ Prometheus ä¹Ÿæ˜¯å¿…é ˆä¾ç…§ time series æŸ¥æ‰¾ï¼Œèªæ³•ä¸Šå½ˆæ€§æ¯” stackdriver å¤šå¾ˆå¤šï¼Œä½†ä¾æ¨£ä¸èƒ½æœå°‹æ²’æœ‰ index çš„æ¬„ä½ é€™é‚Šè¦æ›¿åˆ¥æï¼Œé›–ç„¶ Elasticsearch èƒ½ç”¨å…¨æ–‡æœç´¢è¼•æ˜“åœ°åšåˆ°è¤‡é›œçš„æŸ¥è©¢èªæ³•ï¼Œä½†ä»¥ metrics ä¾†èªªï¼Œå…¶å¯¦æ²’æœ‰å¤ªå¤šè·³è„« time series æŸ¥æ‰¾çš„éœ€æ±‚ã€‚èƒ½åšåˆ°ï¼Œä½†æœ‰æ²’æœ‰å¿…è¦é€™æ¨£åšï¼Œå¯ä»¥æ‰“å€‹å•è™Ÿã€‚ å€‹äººå¿ƒå¾—ï¼Œå¦‚æœé©—è­‰å…¨æ–°çš„ business modelï¼Œæˆ–æ˜¯é‚„ä¸ç¢ºå®šçš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ ELK åšå„ç¨®è¤‡é›œçš„æŸ¥è©¢\nå¦‚æœéœ€æ±‚æ˜ç¢ºï¼Œæ”¶é€²ä¾†çš„ log è™•ç†æµç¨‹éƒ½å¾ˆæ˜ç¢ºï¼Œä¹Ÿè¨±ä¸ç”¨ä½¿ç”¨ ELKã€‚\nè«–ç³»çµ±è³‡æº CP å€¼ä»¥åŠæ•ˆèƒ½ï¼Œtime series çš„ db éƒ½æœƒæ¯” Elasticsearch å¥½ä¸Šä¸å°‘ã€‚ Elasticsearch ä¸­ä¹Ÿä¸å¤ªé©åˆä¸€ç›´å­˜æ”¾å¤§é‡çš„è³‡æ–™åœ¨ hot å¯å¯«å¯è®€ç‹€æ…‹ï¼Œç¹ªå¸Œå¥½å¾ˆå¤šç³»çµ±è³‡æºã€‚ å…¶ä»–æœå‹™ Elastic æœ‰å‡ºè¨±å¤šä¸åŒçš„å¢å€¼æœå‹™\nApplication Performance Monitoring(APM) Realtime User Monitoring(RUM) Machine Learning(ELK ML) è€Œ ELK ä»¥å¤–ä¹Ÿéƒ½æœ‰ä¸åŒçš„è§£æ±ºæ–¹æ¡ˆï¼Œä¾‹å¦‚\nGCP ä¹Ÿå‡ºäº†è‡ªå·±çš„ APM Sass Google Analytics(GA) ä¸åƒ…èƒ½åšå¤šæ¨£çš„å‰ç«¯ä½¿ç”¨è€…è¡Œç‚ºåˆ†æï¼Œé‚„èƒ½æ•´åˆ Google æ”¶é›†åˆ°çš„ä½¿ç”¨è€…è¡Œç‚ºï¼Œåšæ›´å¤šç¶­åº¦çš„åˆ†æ ç›¸è¼ƒä¹‹ä¸‹ ELK åœ¨é€™å¡Šå…¶å¯¦æ²’æœ‰ç‰¹åˆ¥å„ªå‹¢ã€‚\nElastic Cloud æˆ‘é€™é‚Šè¦ç‰¹åˆ¥èªª Elastic Cloud vs ELK\nElatic Cloud çš„é‹è¡Œæ–¹å¼ï¼Œæ˜¯ä»£ç‚ºå‘å…¬èˆ‡æ©å¹³å°(aaws, gcp,\u0026hellip;)ï¼Œå¸¶å®¢æˆ¶å‘å¹³å°ç§Ÿç”¨æ©Ÿå™¨ï¼Œç„¶å¾ŒæŠŠ ELK æœå‹™éƒ¨ç½²åˆ°ç§Ÿç”¨çš„æ©Ÿå™¨ä¸Šã€‚ç”¨æˆ¶é€™é‚Šç„¡æ³•ç›´æ¥å­˜å–æ©Ÿå™¨ï¼Œåªèƒ½é€é ELK ä»‹é¢æˆ–æ˜¯ Kibana , API é€²å…¥ ELKã€‚Elastic Cloud æœƒç›£æ§ç„¡èª¤ç¯€é»çš„ç‹€æ³ï¼Œä¸¦åšåˆ°ä¸€å®šç¨‹åº¦çš„ä»£ç®¡ã€‚\né€™é‚ŠæŒ‡çš„ä¸€å®šç¨‹åº¦çš„ä»£ç®¡ï¼Œæ˜¯ Elastic Cloud åªæ˜¯ä»£ç‚ºéƒ¨ç½²æœå‹™ï¼Œç›£æ§ã€‚æœ‰æ•…éšœæ™‚ä¸¦ä¸è² è²¬æ’é™¤ï¼Œå¦‚æœ ELK æ•…éšœï¼Œç°¡å–®çš„å•é¡Œï¼ˆex. è¨˜æ†¶é«”è³‡æºä¸è¶³ï¼‰æœƒä»£ç‚ºé‡é–‹æ©Ÿå™¨ï¼Œä½†å¦‚æœæ˜¯è¤‡é›œçš„å•é¡Œï¼Œé‚„æ˜¯è¦ç”¨æˆ¶è‡ªå·±è™•ç†ï¼ä½†æ˜¯ç”¨æˆ¶åˆæ²’æœ‰ä¸»æ©Ÿç¯€é»çš„ç›´æ¥å­˜å–æ¬Šé™ï¼Œæ‰€ä»¥å¯èƒ½æœƒé€ æˆæœå‹™å¡ä½ç„¡æ³•å•Ÿå‹•ï¼Œåªèƒ½é€é Elastic Cloud çš„ç®¡ç†ä»‹é¢å˜—è©¦ä¿®å¾©ã€‚\nä½¿ç”¨æœå‹™é™¤äº†æŠŠæœå‹™éƒ½æ¶è¨­å®Œä»¥å¤–ï¼Œé‚„æ˜¯éœ€è¦å®šæœŸè¦èŠ±æ™‚é–“è™•ç† performance tuningï¼Œè¨­å®šå®šæœŸæ¸…ç†è·Ÿç¶­è­·ã€‚åŒ…æ‹¬ kafka, redis, mongoDB, cassandra, SQLs\u0026hellip;éƒ½æ˜¯ä¸€æ¨£ï¼Œæ¶æ§‹è¶Šè¤‡é›œï¼Œæ•ˆèƒ½è¦æ±‚è¶Šé«˜ï¼Œé€™éƒ¨åˆ†çš„å·¥éƒ½æœƒæ›´å¤šã€‚å¦‚æœå…¬å¸æœ‰ DBAï¼Œæˆ–æ˜¯å°ˆè·ç¶­è­·å·¥ç¨‹å¸«ï¼Œé‚£æ­å–œå°±ä¸ç”¨ç…©æƒ±ã€‚\nElasticsearch server ç›®å‰ç”¨èµ·ä¾†ï¼Œç®—æ˜¯æ˜¯æ•¸æœå‹™ä¸­ï¼Œç¶­è­·ä¸ŠæœƒèŠ±æ¯”è¼ƒå¤šæ™‚é–“çš„æœå‹™ã€‚\nå› ç‚ºå¼•æ“æœ¬èº«è¨­è¨ˆçš„æ¶æ§‹ï¼Œä¸¦ä¸æ˜¯å¾ˆå¤šäººéƒ½ç†Ÿæ‚‰ã€‚åœ¨ä½¿ç”¨ELKåŒæ™‚ï¼Œå°ELKåº•å±¤å¼•æ“çš„é‹ä½œæµç¨‹æœ‰å¤šç†Ÿæ‚‰ï¼Œæœƒç›´æ¥å½±éŸ¿ç©©å®šæ€§è·Ÿè·‘å‡ºä¾†çš„æ•ˆèƒ½ã€‚ éœ€è¦å¥½å¥½è™•ç†è¨­è¨ˆè³‡æ–™çš„å„²å­˜ï¼Œå¦‚æœä½¿ç”¨ä¸Šæ²’è™•ç†å¥½ï¼Œæœƒç›´æ¥è®“æ•´å€‹ELK æ›æ‰ã€‚ ç„¶å¾Œç”¢å“æœ¬èº«çš„ç¶­è­·ä»‹é¢ï¼Œç›®å‰åªæ˜¯åœ¨å ªç”¨ï¼Œè¨±å¤šé‡è¦çš„åŠŸèƒ½ä¹Ÿé‚„åœ¨é–‹ç™¼ä¸­ã€‚ å¦‚æœå…¬å¸æœ‰äººæœƒç®¡ ELKï¼Œå€‹äººå»ºè­°æ˜¯å¯ä»¥ self-host\nå°çµ å¼„æ¸…æ¥šéœ€æ±‚ï¼Œå¦‚æœæ²’æœ‰ç‰¹æ®Šéœ€æ±‚å¯ä»¥èµ° general solution Sass vs Self-hosted vs On-premised Time series vs non time series ","permalink":"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eæœ‰æ¿å‹å•åˆ°ï¼Œè¦å¦‚ä½•é¸æ“‡è¦ä¸è¦ç”¨ ELKï¼Œå…¶å¯¦ä¹Ÿé€™æ˜¯æ•´ç¯‡ ELK çš„åˆè¡·ã€‚é€™é‚Šåˆ†äº«ä¸€ä¸‹ ELK èˆ‡å…¶ä»–é¸æ“‡ï¼Œä»¥åŠé¸æ“‡è§£æ±ºæ–¹æ¡ˆæ‡‰è©²è€ƒæ…®çš„äº‹æƒ…ã€‚\u003c/p\u003e\n\u003ch1 id=\"å…¶ä»–å¸¸ç”¨çš„æœå‹™\"\u003eå…¶ä»–å¸¸ç”¨çš„æœå‹™\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://prometheus.io/\"\u003ePrometheus\u003c/a\u003e: é–‹æºçš„ time series metrics æ”¶é›†ç³»çµ±\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://cloud.google.com/stackdriver/?hl=zh-tw\"\u003eStackdriver\u003c/a\u003e: GCP çš„ log èˆ‡ metrics å¹³å°\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/cloud/\"\u003eElastic Cloud\u003c/a\u003e: ELK çš„ Sass\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://chechia.net/posts/self-host-elk-stack-on-gcp/\"\u003eSelf-hosted ELK\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eæˆ–æ˜¯ä¾ç…§éœ€æ±‚æ··æ­ï¼Œå„å€‹æœå‹™ä½¿ç”¨çš„å„å±¤å¥—ä»¶æ˜¯å¯ä»¥ç›¸å®¹ï¼Œä¾‹å¦‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eåœ¨ GKE ä¸Šä¸ç”¨ beat å¯ä»¥ç”¨ fluentd\u003c/p\u003e","title":"ELK or Not ELK"},{"content":"ç°¡å–®è¬›ä¸€ä¸‹ certificate X.509 æ˜¯å…¬é‘°æ†‘è­‰(public key certificate) çš„ä¸€å¥—æ¨™æº–ï¼Œç”¨åœ¨å¾ˆå¤šç¶²è·¯é€šè¨Šå”å®š (åŒ…å« TLS/SSL)\ncertificate åŒ…å«å…¬é‘°åŠè­˜åˆ¥è³‡è¨Š(hostname, organization, \u0026hellip;ç­‰è³‡è¨Š)\ncertificate æ˜¯ç”± certificate authority(CA) ç°½ç½²ï¼Œæˆ–æ˜¯è‡ªç°½(Self-signed)\nä½¿ç”¨ browser é€£å…¥ https serveræ™‚ï¼Œæœƒæª¢æŸ¥ server çš„ certificate æ˜¯å¦æœ‰æ•ˆï¼Œç¢ºå®šé€™å€‹ server çœŸçš„æ˜¯åˆæ³•çš„ site\nåœ¨ elastic stack ä¸Šï¼Œå¦‚æœæœ‰å¤šå€‹ elasticsearch server node å½¼æ­¤é€£ç·šï¼Œç”±æ–¼ node å½¼æ­¤æ˜¯ client ä¹Ÿæ˜¯ server\nä½¿ç”¨ self-signed CA ç”¢å‡ºä¾†çš„ certificateï¼Œé€£å…¥æ™‚æœƒæª¢æŸ¥ä½¿ç”¨çš„ certificate æ˜¯å¦ç”±åŒä¸€çµ„ CA ç°½ç½² server ä½¿ç”¨ certificateï¼Œç¢ºå®šé€£å…¥ server çš„ client éƒ½å¸¶æœ‰æ­£ç¢ºçš„ç§é‘°èˆ‡ public certificateï¼Œæ˜¯ authenticated user é™„å¸¶èªªæ˜ï¼ŒX.509 æœ‰å¤šç¨®æª”æ¡ˆæ ¼å¼\n.pem .cer, .crt, .der .p12 .p7b, .p7c \u0026hellip; å¦å¤–æª”æ¡ˆæ ¼å¼å¯ä»¥æœ‰å…¶ä»–ç”¨é€”ï¼Œä¹Ÿå°±æ˜¯èªªè£¡é¢è£çš„ä¸ä¸€å®šæ˜¯ X.509 æ†‘è­‰\nCA $ openssl pkcs12 -in /etc/elasticsearch/config/elastic-stack-ca.p12 -info -nokeys MAC: sha1, Iteration 100000 MAC length: 20, salt length: 20 PKCS7 Data Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration 50000 PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration 50000 Certificate bag Bag Attributes friendlyName: ca localKeyID: subject=CN = Elastic Certificate Tool Autogenerated CA issuer=CN = Elastic Certificate Tool Autogenerated CA -----BEGIN CERTIFICATE----- -----END CERTIFICATE----- issuer command name ç‚º Elastic autogen CA subject command name ç‚º Elastic autogen CA\nhttps://shazi.info/openssl-%E6%AA%A2%E6%B8%AC-ssl-%E7%9A%84%E6%86%91%E8%AD%89%E4%B8%B2%E9%8D%8A-certificate-chain/\nopenssl s_client -connect google.com https://medium.com/@superseb/get-your-certificate-chain-right-4b117a9c0fce\nopenssl verify -CAfile client-ca.cer client.cer openssl verify -show_chain -CAfile client-ca.cer client.cer Certificate ç”¨ openssl å·¥å…·çœ‹ä¸€ä¸‹å…§å®¹ï¼Œå¦‚æœæœ‰å¯†ç¢¼é€™é‚Šè¦ç”¨å¯†ç¢¼è§£é–\n$ openssl pkcs12 -in /etc/elasticsearch/config/elastic-certificates.p12 -info -nokeys MAC: sha1, Iteration 100000 MAC length: 20, salt length: 20 PKCS7 Data Shrouded Keybag: pbeWithSHA1And3-KeyTripleDES-CBC, Iteration 50000 PKCS7 Encrypted data: pbeWithSHA1And40BitRC2-CBC, Iteration 50000 Certificate bag Bag Attributes friendlyName: elk.asia-east1-b.c.machi-x.internal localKeyID: subject=CN = elk.asia-east1-b.c.machi-x.internal issuer=CN = Elastic Certificate Tool Autogenerated CA -----BEGIN CERTIFICATE----- -----END CERTIFICATE----- Certificate bag Bag Attributes friendlyName: ca 2.16.840.1.113894.746875.1.1: \u0026lt;Unsupported tag 6\u0026gt; subject=CN = Elastic Certificate Tool Autogenerated CA issuer=CN = Elastic Certificate Tool Autogenerated CA -----BEGIN CERTIFICATE----- -----END CERTIFICATE----- ","permalink":"https://chechia.net/posts/2020-09-17-x.509-certificate/","summary":"\u003ch1 id=\"ç°¡å–®è¬›ä¸€ä¸‹-certificate\"\u003eç°¡å–®è¬›ä¸€ä¸‹ certificate\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eX.509 æ˜¯å…¬é‘°æ†‘è­‰(public key certificate) çš„ä¸€å¥—æ¨™æº–ï¼Œç”¨åœ¨å¾ˆå¤šç¶²è·¯é€šè¨Šå”å®š (åŒ…å« TLS/SSL)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecertificate åŒ…å«å…¬é‘°åŠè­˜åˆ¥è³‡è¨Š(hostname, organization, \u0026hellip;ç­‰è³‡è¨Š)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecertificate æ˜¯ç”± certificate authority(CA) ç°½ç½²ï¼Œæˆ–æ˜¯è‡ªç°½(Self-signed)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eä½¿ç”¨ browser é€£å…¥ https serveræ™‚ï¼Œæœƒæª¢æŸ¥ server çš„ certificate æ˜¯å¦æœ‰æ•ˆï¼Œç¢ºå®šé€™å€‹ server çœŸçš„æ˜¯åˆæ³•çš„ site\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eåœ¨ elastic stack ä¸Šï¼Œå¦‚æœæœ‰å¤šå€‹ elasticsearch server node å½¼æ­¤é€£ç·šï¼Œç”±æ–¼ node å½¼æ­¤æ˜¯ client ä¹Ÿæ˜¯ server\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä½¿ç”¨ self-signed CA ç”¢å‡ºä¾†çš„ certificateï¼Œé€£å…¥æ™‚æœƒæª¢æŸ¥ä½¿ç”¨çš„ certificate æ˜¯å¦ç”±åŒä¸€çµ„ CA ç°½ç½²\u003c/li\u003e\n\u003cli\u003eserver ä½¿ç”¨ certificateï¼Œç¢ºå®šé€£å…¥ server çš„ client éƒ½å¸¶æœ‰æ­£ç¢ºçš„ç§é‘°èˆ‡ public certificateï¼Œæ˜¯ authenticated user\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé™„å¸¶èªªæ˜ï¼ŒX.509 æœ‰å¤šç¨®æª”æ¡ˆæ ¼å¼\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e.pem\u003c/li\u003e\n\u003cli\u003e.cer, .crt, .der\u003c/li\u003e\n\u003cli\u003e.p12\u003c/li\u003e\n\u003cli\u003e.p7b, .p7c\u003c/li\u003e\n\u003cli\u003e\u0026hellip;\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå¦å¤–æª”æ¡ˆæ ¼å¼å¯ä»¥æœ‰å…¶ä»–ç”¨é€”ï¼Œä¹Ÿå°±æ˜¯èªªè£¡é¢è£çš„ä¸ä¸€å®šæ˜¯ X.509 æ†‘è­‰\u003c/p\u003e","title":"X.509 certificate"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP å°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\n\u0026ndash;\nä¸Šç¯‡Self-host ELK stack on GCP ä»‹ç´¹äº†ï¼Œelk stack åŸºæœ¬çš„å®‰è£ï¼Œå®‰è£å®Œç²å¾—ä¸€å€‹åªæ”¯æ´ http (è£¸å¥”)çš„ elk stackï¼Œæ²’æœ‰ https åœ¨å…¬é–‹ç¶²è·¯ä¸Šä½¿ç”¨æ˜¯éå¸¸å±éšªçš„ã€‚é€™ç¯‡è¦ä¾†ä»‹ç´¹å¦‚ä½•åšå®‰å…¨æ€§è¨­å®šã€‚\nå®˜æ–¹çš„æ–‡ä»¶åœ¨é€™è£¡ï¼Œç¢å¿µä¸€ä¸‹ï¼Œé™¤éå° ELK çš„åŠŸèƒ½æœ‰ä¸€å®šäº†è§£ï¼Œä¸ç„¶é€™ä»½çœŸçš„ä¸æ˜¯å¾ˆå‹å–„ã€‚å»ºè­°å¾å®˜æ–¹æ–‡ä»¶åº•ä¸‹çš„Tutorial: Getting started with security é–‹å§‹ï¼Œéç¨‹æ¯”è¼ƒä¸æœƒé€™éº¼è¡€å°¿ã€‚\nç¸½ä¹‹ç‚ºäº†å•Ÿç”¨ authentication \u0026amp; httpsï¼Œé€™ç¯‡è¦åšçš„äº‹æƒ…ï¼š\nenable x-pack \u0026amp; activate basic license Generate self-signed ca, server certificate, client certificate Configure Elasticsearch, Kibana, \u0026amp; other components to use server certificate when act as server use client certificate when connect to an ELK server å•Ÿç”¨ X-pack Elasticsearch çš„å®‰å…¨æ€§æ¨¡çµ„ç”± x-pack extension æä¾›ï¼Œåœ¨ 6.3.0 ä¹‹å¾Œçš„ç‰ˆæœ¬ï¼Œå®‰è£ elasticsearch çš„éç¨‹ä¸­å°±é è¨­å®‰è£ x-packã€‚\né™„ä¸Šå•Ÿç”¨çš„å®˜æ–¹æ–‡ä»¶\nç„¶è€Œï¼Œç”±æ–¼èˆŠç‰ˆçš„ x-pack æ˜¯ä»˜è²»å…§å®¹ï¼Œç›®å‰çš„ elasticsearch å®‰è£å®Œå¾Œï¼Œelasticsearch.yml è¨­å®šé è¨­ä¸å•Ÿç”¨ x-packï¼Œä¹Ÿå°±æ˜¯èªªæ²’çœ‹åˆ°é€™ç¯‡å®˜æ–¹æ–‡ä»¶çš„è©±ï¼Œå¾ˆå®¹æ˜“å°±ç²å¾—æ²’æœ‰ä»»ä½• security åŠŸèƒ½çš„ ELKã€‚\né›–ç„¶ç›®å‰å·²ç¶“å¯ä»¥ä½¿ç”¨å…è²»çš„ basic license ä½¿ç”¨ security åŠŸèƒ½ï¼Œé‚„æ˜¯å¸Œæœ›å®˜æ–¹å¯ä»¥ default å•Ÿç”¨ securityã€‚\n$ sudo vim /etc/elasticsearch/elasticsearch.yml xpack.security.enabled: true xpack.license.self_generated.type: basic discovery.type: single-node æˆ‘å€‘é€™é‚Šå•Ÿç”¨ xpack.securityï¼ŒåŒæ™‚å°‡ self-generated license ç”Ÿå‡ºä¾†ï¼Œæˆ‘å€‘é€™é‚Šåªä½¿ç”¨åŸºæœ¬çš„ basic subscriptionã€‚è‹¥å¸Œæœ›å•Ÿç”¨æ›´å¤šåŠŸèƒ½ï¼Œå¯ä»¥çœ‹å®˜æ–¹subcription æ–¹æ¡ˆä»‹ç´¹\nå¦å¤–ï¼Œå¦‚æœä¸åŒæ™‚è¨­å®šç‚º single-node çš„è©±ï¼Œé è¨­æœƒå°‹æ‰¾å…¶ä»–elasticsearch node ä¾†çµ„æˆ clusterï¼Œè€Œæˆ‘å€‘å°±å¿…é ˆè¦åœ¨æ‰€æœ‰ node ä¸Šå•Ÿç”¨ securityï¼Œé€™ç¯‡åªå¸¶å¤§å®¶åšä¸€å€‹ single node clusterï¼Œç°¡åŒ–æ­¥é©Ÿã€‚\né‡å•Ÿ elasticsearch ï¼Œæª¢æŸ¥ logï¼Œçœ‹å•Ÿå‹•æ™‚æœ‰æ²’æœ‰è¼‰å…¥ x-pack\nsudo systemctl restart elasticsearch $ tail -f /var/log/elasticsearch/elasticsearch.log [2019-09-16T07:39:49,467][INFO ][o.e.e.NodeEnvironment ] [elk] using [1] data paths, mounts [[/mnt/disks/elk (/dev/sdb)]], net usable_space [423.6gb], net total_space [491.1gb], types [ext4] [2019-09-16T07:39:49,474][INFO ][o.e.e.NodeEnvironment ] [elk] heap size [3.9gb], compressed ordinary object pointers [true] [2019-09-16T07:39:50,858][INFO ][o.e.n.Node ] [elk] node name [elk], node ID [pC22j9D4R6uiCM7oTc1Fiw], cluster name [elasticsearch] [2019-09-16T07:39:50,866][INFO ][o.e.n.Node ] [elk] version[7.3.1], pid[17189], build[default/deb/4749ba6/2019-08-19T20:19:25.651794Z], OS[Linux/4.15.0-1040-gcp/amd64], JVM[Oracle Corporation/OpenJDK 64-Bit Server VM/12.0.2/12.0.2+10] [2019-09-16T07:39:50,878][INFO ][o.e.n.Node ] [elk] JVM home [/usr/share/elasticsearch/jdk] ... [2019-09-16T07:39:59,108][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-ccr] [2019-09-16T07:39:59,109][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-core] ... [2019-09-16T07:39:59,111][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-logstash] [2019-09-16T07:39:59,113][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-voting-only-node] [2019-09-16T07:39:59,114][INFO ][o.e.p.PluginsService ] [elk] loaded module [x-pack-watcher] [2019-09-16T07:39:59,115][INFO ][o.e.p.PluginsService ] [elk] no plugins loaded [2019-09-16T07:40:07,964][INFO ][o.e.x.s.a.s.FileRolesStore] [elk] parsed [0] roles from file [/etc/elasticsearch/roles.yml] [2019-09-16T07:40:10,369][INFO ][o.e.x.m.p.l.CppLogMessageHandler] [elk] [controller/17314] [Main.cc@110] controller (64 bit): Version 7.3.1 (Build 1d93901e09ef43) Copyright (c) 2019 Elasticsearch BV [2019-09-16T07:40:11,776][DEBUG][o.e.a.ActionModule ] [elk] Using REST wrapper from plugin org.elasticsearch.xpack.security.Security [2019-09-16T07:40:14,396][INFO ][o.e.d.DiscoveryModule ] [elk] using discovery type [single-node] and seed hosts providers [settings] [2019-09-16T07:40:16,222][INFO ][o.e.n.Node ] [elk] initialized [2019-09-16T07:40:16,224][INFO ][o.e.n.Node ] [elk] starting ... [2019-09-16T07:40:16,821][INFO ][o.e.t.TransportService ] [elk] publish_address {10.140.0.10:9300}, bound_addresses {[::]:9300} [2019-09-16T07:40:16,872][INFO ][o.e.c.c.Coordinator ] [elk] cluster UUID [1CB6_Lt-TUWEmRoN9SE49w] [2019-09-16T07:40:17,088][INFO ][o.e.c.s.MasterService ] [elk] elected-as-master ([1] nodes joined)[{elk}{pC22j9D4R6uiCM7oTc1Fiw}{Os-2FBjgSTOd1G_I3QYwVQ}{10.140.0.10}{10.140.0.10:9300}{dim}{ml.machine_memory=7836028928, xpack.installed=true, ml.max_open_jobs=20} elect leader, _BECOME_MASTER_TASK_, _FINISH_ELECTION_], term: 9, version: 921, reason: master node changed {previous [], current [{elk}{pC22j9D4R6uiCM7oTc1Fiw}{Os-2FBjgSTOd1G_I3QYwVQ}{10.140.0.10}{10.140.0.10:9300}{dim}{ml.machine_memory=7836028928, xpack.installed=true, ml.max_open_jobs=20}]} [2019-09-16T07:40:17,819][INFO ][o.e.c.s.ClusterApplierService] [elk] master node changed {previous [], current [{elk}{pC22j9D4R6uiCM7oTc1Fiw}{Os-2FBjgSTOd1G_I3QYwVQ}{10.140.0.10}{10.140.0.10:9300}{dim}{ml.machine_memory=7836028928, xpack.installed=true, ml.max_open_jobs=20}]}, term: 9, version: 921, reason: Publication{term=9, version=921} [2019-09-16T07:40:17,974][INFO ][o.e.h.AbstractHttpServerTransport] [elk] publish_address {10.140.0.10:9200}, bound_addresses {[::]:9200} [2019-09-16T07:40:17,975][INFO ][o.e.n.Node ] [elk] started [2019-09-16T07:40:18,455][INFO ][o.e.c.s.ClusterSettings ] [elk] updating [xpack.monitoring.collection.enabled] from [false] to [true] [2019-09-16T07:40:22,555][INFO ][o.e.l.LicenseService ] [elk] license [************************************] mode [basic] - valid [2019-09-16T07:40:22,557][INFO ][o.e.x.s.s.SecurityStatusChangeListener] [elk] Active license is now [BASIC]; Security is enabled Enable user authentication å•Ÿç”¨ security ä¹‹å‰ï¼Œæˆ‘å€‘ç›´æ¥é€£å…¥ Kibana http://10.140.0.10:5601 ï¼Œä¸ç”¨ä»»ä½•ä½¿ç”¨è€…ç™»å…¥ï¼Œä¾¿å¯ä»¥å®Œæ•´ä½¿ç”¨ Kibana åŠŸèƒ½ï¼ˆåŒ…å« admin ç®¡ç†ä»‹é¢ï¼‰ã€‚\nå•Ÿç”¨ security å¾Œï¼Œä¾¿éœ€è¦ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ç™»å…¥ã€‚åœ¨é€™é‚Šå…ˆç”¨å·¥å…·æŠŠä½¿ç”¨è€…å¯†ç¢¼ç”¢ç”Ÿå‡ºä¾†ã€‚\n# äº’å‹•å¼ /usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive # è‡ªå‹•ç”¢ç”Ÿ /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto å¯†ç¢¼ç”Ÿå‡ºä¾†å¾Œï¼Œå°±æŠŠå¸³è™Ÿå¯†ç¢¼æ”¶å¥½ï¼Œç­‰ç­‰æœƒç”¨åˆ°ã€‚ä¹‹å¾Œåˆæ¬¡ç™»å…¥ä¹Ÿæ˜¯ä½¿ç”¨é€™äº›å¯†ç¢¼ã€‚\nConfigure passwords on client-side ç”±æ–¼å·²ç¶“å•Ÿç”¨ authenticationï¼Œå…¶ä»– ELK å…ƒä»¶ (Kibana, logstash, filebeat, apm-server,\u0026hellip;) é€£å…¥ Elasticsearch ä¹Ÿéƒ½æœƒéœ€è¦å„è‡ªçš„å¸³è™Ÿå¯†ç¢¼é©—è­‰ã€‚\nä»¥ Kibana ç‚ºä¾‹ï¼Œå¯ä»¥ç›´æ¥åœ¨ kibana.yml ä¸­ç›´æ¥è¨­å®šå¸³è™Ÿå¯†ç¢¼\n$ sudo vim /etc/kibana/kibana.yml elasticsearch.hosts: [\u0026quot;http://localhost:9200\u0026quot;] xpack.security.enabled: true elasticsearch.username: \u0026quot;kibana\u0026quot; elasticsearch.password: \u0026quot;***********\u0026quot; ç•¶ç„¶ï¼Œé€™é‚Šå°±æ˜¯æ˜ç¢¼çš„ï¼Œçœ‹äº†ä¸å¤ªå®‰å…¨ã€‚\næˆ–æ˜¯ä½¿ç”¨ keystore æŠŠ built-in user çš„å¯†ç¢¼åŠ å¯†ï¼Œå­˜åœ¨ kibana çš„ keystore è£¡é¢ï¼Œé‡å•Ÿ kibana æ™‚ä¾¿æœƒè¼‰å…¥ã€‚\n/usr/share/kibana/bin/kibana-keystore create /usr/share/kibana/bin/kibana-keystore add elasticsearch.username /usr/share/kibana/bin/kibana-keystore add elasticsearch.password å¦‚æœæœ‰å•Ÿç”¨ Filebeat åŠŸèƒ½ï¼Œbeat å…ƒä»¶é€£å…¥ elasticsearch ä¸€æ¨£éœ€è¦è¨­å®š\n/usr/share/apm-server/bin/filebeat keystore create /usr/share/apm-server/bin/filebeat add elasticsearch.username /usr/share/apm-server/bin/filebeat add elasticsearch.password å¦‚æœæœ‰å•Ÿç”¨ application performance monitoring(APM) åŠŸèƒ½ï¼Œapm-server å…ƒä»¶é€£å…¥ elasticsearch ä¸€æ¨£éœ€è¦è¨­å®š\n/usr/share/apm-server/bin/apm-server keystore create /usr/share/apm-server/bin/apm-server add elasticsearch.username /usr/share/apm-server/bin/apm-server add elasticsearch.password Encrypting Communications ä¸Šé¢åŠ äº† username/password authenticationï¼Œä½†å¦‚æœæ²’ https/tls åŸºæœ¬ä¸Šé‚„æ˜¯è£¸å¥”ã€‚æ¥ä¸‹ä¾†è¦è™•ç†é€£ç·šåŠ å¯†ã€‚\nå®˜æ–¹ tutorial\nä¸€å †å®˜æ–¹æ–‡ä»¶ï¼Œæˆ‘å€‘å…ˆè·³éXD\nelasticsearch security elastic stack ssl tls elasticsearch configuring tls certutil åˆ†æä¸€ä¸‹éœ€æ±‚è·Ÿè¦æ ¼ æˆ‘å€‘éœ€è¦ç‚ºæ¯ä¸€å€‹ node ç”Ÿä¸€çµ„ node certificateï¼Œä½¿ç”¨ node certificate ç”¢ç”Ÿ client certificates æä¾›çµ¦å…¶ä»– clientï¼Œé€£å…¥æ™‚æœƒé©—è­‰ client æ˜¯å¦ç‚º authenticated userã€‚\né‡å°ç›®å‰é€™å€‹ single-node ELK stackï¼Œæˆ‘å€‘å¯èƒ½æœ‰å¹¾ç¨®é¸æ“‡\nç°½ç½²ä¸€å€‹ localhostï¼Œç•¶ç„¶é€™å€‹åªèƒ½åœ¨ localhost ä¸Šçš„å®¢æˆ¶ç«¯å…ƒä»¶ä½¿ç”¨ï¼Œåˆ¥çš„ node ç„¡æ³•ç”¨é€™å€‹é€£å…¥ ç°½ç½²ä¸€å€‹ public DNS elk.chechiachang.comï¼Œå¯ä»¥åœ¨å…¬é–‹ç¶²è·¯ä¸Šä½¿ç”¨ï¼Œåˆ¥äººä¹Ÿå¯ä»¥ä½¿ç”¨é€™å€‹DNSå˜—è©¦é€£å…¥ ç°½ç½²ä¸€å€‹ç§æœ‰ç¶²åŸŸçš„ DNSï¼Œä¾‹å¦‚åœ¨ GCP ä¸Šå¯ä»¥ä½¿ç”¨å…§éƒ¨dnsæœå‹™ é•·é€™æ¨£ elk.asia-east1-b.c.chechiachang.internal [INSTANCE_NAME].[ZONE].c.[PROJECT_ID].internal æœ‰éœ€è¦ä¹Ÿå¯ä»¥ä¸€ä»½ server certificate ä¸­ç°½ç½²è¤‡æ•¸å€‹ site æˆ‘å€‘é€™é‚Šé¸æ“‡ä½¿ç”¨å…§éƒ¨ dnsï¼Œelk.asia-east1-b-c-chechaichang.internalï¼Œè®“é€™å€‹ single-node elk åªèƒ½é€éå…§éƒ¨ç¶²è·¯å­˜å–ã€‚\nelasticsearch: elk.asia-east1-b.c.chechaichang.internal:9200 kibana: elk.asia-east1-b.c.chechaichang.internal:5601 å¤–éƒ¨è¦é€£è¿‘ä¾† kibanaï¼Œæˆ‘å€‘ä½¿ç”¨ vpn æœå‹™é€£é€²ç§æœ‰ç¶²è·¯ å¦‚æœæƒ³ä½¿ç”¨å¤–éƒ¨ dnsï¼Œè®“ elk stack åœ¨å…¬é–‹ç¶²è·¯å¯ä»¥ä½¿ç”¨ï¼Œex. elk.chechiachang.comï¼Œå¯ä»¥\nGCP çš„ load balanceræ›é€²ä¾†ï¼Œç”¨ GCP çš„ certificate manager è‡ªå‹•ç®¡ç† certificate æˆ–æ˜¯åœ¨ node ä¸Šé–‹ä¸€å€‹ nginx serverï¼Œå†æŠŠ certificate ç”¨ certbot ç”Ÿå‡ºä¾† Generate certificates å…ˆæŠŠ X.509 digital certificate çš„ certificate authority(CA) ç”Ÿå‡ºä¾†ã€‚æˆ‘å€‘å¯ä»¥è¨­å®šå¯†ç¢¼ä¿è­·é€™å€‹æª”æ¡ˆ\nmkdir -p /etc/elasticsearch/config # CA generated with Elastic tool /usr/share/elasticsearch/bin/elasticsearch-certutil ca \\ -out /etc/elasticsearch/config/elastic-stack-ca.p12 ç”Ÿå‡ºä¾†æ˜¯ PKCS#12 æ ¼å¼çš„ keystoreï¼ŒåŒ…å«ï¼š\nCA çš„ public certificate CA çš„åŸºæœ¬è³‡è¨Š ç°½ç½²å…¶ä»– node certificates ä½¿ç”¨çš„ç§é‘°(private key) ç”¨ openssl å·¥å…·çœ‹ä¸€ä¸‹å…§å®¹ï¼Œå¦‚æœæœ‰å¯†ç¢¼é€™é‚Šè¦ç”¨å¯†ç¢¼è§£é–\n$ openssl pkcs12 -in /etc/elasticsearch/config/elastic-stack-ca.p12 -info -nokeys é™„å¸¶èªªæ˜ï¼ŒX.509 æœ‰å¤šç¨®æª”æ¡ˆæ ¼å¼\n.pem .cer, .crt, .der .p12 .p7b, .p7c \u0026hellip; å¦å¤–æª”æ¡ˆæ ¼å¼å¯ä»¥æœ‰å…¶ä»–ç”¨é€”ï¼Œä¹Ÿå°±æ˜¯èªªè£¡é¢è£çš„ä¸ä¸€å®šæ˜¯ X.509 æ†‘è­‰ã€‚è£¡é¢çš„å…§å®¹ä¹Ÿä¸åŒã€‚\nELK è¨­å®šçš„éç¨‹ä¸­ï¼Œç”±æ–¼ä¸æ˜¯æ‰€æœ‰çš„ ELK component éƒ½æ”¯æ´ä½¿ç”¨ .p12 æª”æ¡ˆï¼Œæˆ‘å€‘åœ¨è¨­å®šéç¨‹ä¸­æœƒäº’ç›¸å°ˆæ›ï¼Œæˆ–æ˜¯æ··ç”¨å¤šç¨®æª”æ¡ˆæ ¼å¼ã€‚\nGenerate certificate \u0026laquo;\u0026laquo;\u0026laquo;\u0026lt; HEAD\næˆ‘å€‘ç”¨ elastic-stack-ca.p12 é€™çµ„ keystoreè£¡é¢çš„ CA èˆ‡ private keyï¼Œç‚º elk.asia-east1-b.c.chechiachang.internal ç°½ä¸€å€‹ p12 keystoreï¼Œè£¡é¢æœ‰\nnode certificate node key CA certificate é€™é‚Šåªç”¢ç”Ÿä¸€çµ„ server certificate çµ¦ single-node cluster çš„ node-1\n=======\næˆ‘å€‘ç”¨ elastic-stack-ca.p12 é€™çµ„ keystoreè£¡é¢çš„ CA èˆ‡ private keyï¼Œç‚º elk.asia-east1-b.c.chechiachang.internal ç°½ä¸€å€‹ p12 keystoreï¼Œè£¡é¢æœ‰\nnode certificate node key CA certificate é€™é‚Šåªç”¢ç”Ÿä¸€çµ„ server certificate çµ¦ single-node cluster çš„ node-1\nå¦‚æœ cluster ä¸­æœ‰å¤šå€‹ elasticsearchï¼Œç‚ºæ¯å€‹ node ç”¢ç”Ÿ certificate æ™‚éƒ½è¦ä½¿ç”¨åŒæ¨£ CA ä¾†ç°½ç½²ï¼Œè®“ server ä¿¡ä»»é€™çµ„ CAã€‚\nä½¿ç”¨ elasticsearch-certutil ç°¡åŒ–ç°½ç½²éç¨‹ï¼Œå¾ç”¢ç”Ÿ CA ï¼Œåˆ°ä½¿ç”¨ CA ç°½ç½² certificateã€‚å¦å¤–ï¼Œå†ç”¢ç”Ÿ certificate ä¸­ä½¿ç”¨ Subject Alternative Name(SAN)ï¼Œä¸¦è¼¸å…¥ ip èˆ‡ dnsã€‚\n# certificate for site: private dns with Elastic CA /usr/share/elasticsearch/bin/elasticsearch-certutil cert \\ --ca /etc/elasticsearch/config/elastic-stack-ca.p12 \\ --name elk.asia-east1-b.c.chechaichang.internal \\ --dns elk.asia-east1-b.c.chechaichang.internal \\ --ip 10.140.0.10 \\ -out /etc/elasticsearch/config/node-1.p12 ç”¨ openssl çœ‹ä¸€ä¸‹å…§å®¹ï¼Œå¦‚æœæœ‰å¯†ç¢¼é€™é‚Šè¦ç”¨å¯†ç¢¼è§£é–\n$ openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -info -nokeys server ç”¨é€™å€‹ certificate ï¼Œå•Ÿç”¨ sslã€‚\nclient ä½¿ç”¨é€™å€‹ certificate ç”¢ç”Ÿå‡ºä¾†çš„ client.cer èˆ‡ client.key èˆ‡ server é€£ç·šï¼Œserver æ‰æ¥å—å®¢æˆ¶ç«¯æ˜¯å®‰å…¨çš„ã€‚\n25f5ab795b9e698333a36fde7ecf23a8ba9d4595 è¨˜å¾—æŠŠæ‰€æœ‰æ¬Šé‚„çµ¦ elasticsearch çš„ä½¿ç”¨è€…ï¼Œé¿å… permission denied\n# Change owner to fix read permission chown -R elasticsearch:elasticsearch /etc/elasticsearch/config æœ‰å¯†ç¢¼è¨˜å¾—ä¹Ÿè¦ç”¨ keystore æŠŠå¯†ç¢¼åŠ å¯†å¾Œå–‚çµ¦ elasticsearch\n/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password é—œæ–¼ X.509 Certifcate ä¹‹å¾Œæœ‰ç©ºæˆ‘å€‘ä¾†èŠä¸€ä¸‹\næ›´æ–° elasticsearch è¨­å®š Certificates éƒ½ç”Ÿå®Œäº†ï¼Œæ¥ä¸‹ä¾†æ›´æ”¹ elasticsearch çš„åƒæ•¸ï¼Œåœ¨ transport layer å•Ÿç”¨ sslã€‚å•Ÿç”¨ security å¾Œï¼Œåœ¨ transport layer å•Ÿå‹• ssl æ˜¯å¿…é ˆçš„ã€‚\n$ sudo vim /etc/elasticsearch/elasticsearch.yml xpack.security.enabled: true xpack.security.transport.ssl.enabled: true # use certificate. full will verify dns and ip xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/config/node-1.p12 xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/config/node-1.p12 å•Ÿç”¨ security èˆ‡ transport layer çš„ sslï¼Œç„¶å¾ŒæŒ‡å®š keystoreè·¯å¾‘ï¼Œè®“ server åŸ·è¡Œ client authentication ç”±æ–¼é€™ç­† p12 å¸¶æœ‰ CA certificate ä½œç‚º trusted certificate entryï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é †ä¾¿ç•¶ä½œ trustoreï¼Œè®“ client ä¿¡ä»»é€™å€‹ CA\nsecurity é€™é‚Šæä¾›äº† server side (elasticsearch) åœ¨æª¢æŸ¥å®¢æˆ¶ç«¯é€£ç·šæ™‚çš„æª¢æŸ¥æ¨¡å¼(vertification mode)ï¼Œæ–‡ä»¶æœ‰èªªæ˜ï¼Œå¯ä»¥è¨­å®š\ncertificate: æª¢æŸ¥ certificate åŠ å¯†æ˜¯å¦æœ‰æ•ˆ full: ç°½ node certificate æ™‚å¯ä»¥æŒ‡å®š ip dnsï¼Œå•Ÿç”¨æœƒæª¢æŸ¥ä¾†æº node ip dns æ˜¯å¦ä¹Ÿæ­£ç¢º (Optional) HTTP layer å•Ÿå‹• ssl\nvim /etc/elasticsearch/elasticsearch.yml xpack.security.http.ssl.enabled: true xpack.security.http.ssl.keystore.path: /etc/elasticsearch/config/node-1.p12 xpack.security.http.ssl.truststore.path: /etc/elasticsearch/config/node-1.p12 /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.truststore.secure_password é‡å•Ÿ elasticsearchï¼Œçœ‹ä¸€ä¸‹ log\nsudo systemctl restart elasticsearch tail -f /var/log/elasticsearch/elasticsearch.log ç„¶å¾Œä½ å°±ç™¼ç¾ï¼ŒåŸä¾† kibana é€£å…¥ çš„ http é€£ç·šï¼Œä¸æ–·è¢« server é€™ç«¯æ‹’çµ•ã€‚æ‰€ä»¥ä»¥ä¸‹è¦ä¾†è¨­å®š kibana\nKibana using kibana with security kibana configuring tls ä½¿ç”¨å‰›å‰›ç°½çš„ server certificateï¼Œå¾è£¡é¢ parse å‡º client-ca.cerï¼Œé‚„æœ‰ client.cer èˆ‡ client.key\nmkdir -p /etc/kibana/config $ openssl pkcs12 --help Usage: pkcs12 [options] Valid options are: -chain Add certificate chain -nokeys Don't output private keys -nocerts Don't output certificates -clcerts Only output client certificates -cacerts Only output CA certificates -info Print info about PKCS#12 structure -nodes Don't encrypt private keys -in infile Input filename # no certs, no descript openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -nocerts -nodes \u0026gt; /etc/kibana/config/client.key openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -clcerts -nokeys \u0026gt; /etc/kibana/config/client.cer openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -cacerts -nokeys -chain \u0026gt; /etc/kibana/config/client-ca.cer sudo chown -R kibana:kibana /etc/kibana/config/ æ›´æ”¹ kibana é€£å…¥ elasticsearch çš„é€£ç·šè¨­å®š\nsudo vim /etc/kigana/kibana.yml elasticsearch.hosts: [\u0026quot;https://elk.asia-east1-b.c.chechaichang.internal:9200\u0026quot;] xpack.security.enabled: true elasticsearch.ssl.certificate: /etc/kibana/config/client.cer elasticsearch.ssl.key: /etc/kibana/config/client.key elasticsearch.ssl.certificateAuthorities: [ \u0026quot;/etc/kibana/config/client-ca.cer\u0026quot; ] elasticsearch.ssl.verificationMode: full æŒ‡å®š ssl.certificate, ssl.key åšé€£ç·š elasticsearch server æ™‚çš„ user authentication ç”±æ–¼æˆ‘å€‘æ˜¯ self-signed CAï¼Œæ‰€ä»¥éœ€è¦è®“å®¢æˆ¶ç«¯ä¿¡ä»»é€™å€‹æˆ‘å€‘è‡ªç°½çš„ CA æ³¨æ„é€™é‚Š elasticsearch.hosts æˆ‘å€‘å·²ç¶“å¾ http://localhost æ›æˆ https çš„å…§éƒ¨ dnsï¼ŒåŸæœ‰çš„ localhost å·²ç¶“ç„¡æ³•ä½¿ç”¨ï¼ˆå¦‚æœ elasicsearch æœ‰ enforce https çš„è©±ï¼‰\né‡å•Ÿ Kibanaï¼Œçœ‹ä¸€ä¸‹ log\nsudo systemctl restart kibana journalctl -fu kibana å¦‚æœæ²’æœ‰ä¸€ç›´å™´ ssl certificate error çš„è©±ï¼Œæ­å–œä½ æˆåŠŸäº†\nç„¶è€Œï¼Œé™¤äº† kibana ä»¥å¤–ï¼Œæˆ‘å€‘é‚„æœ‰å…¶ä»–çš„ client éœ€è¦é€£å…¥ elasticsearch\næŠŠä¸Šè¿°æ­¥é©Ÿåœ¨ apm-server, filebeat, å…¶ä»–çš„ beat ä¸Šä¹Ÿè¨­å®š å¦‚æœåœ¨ k8s ä¸Šï¼Œè¦æŠŠ cer, key ç­‰æª”æ¡ˆç”¨ volume æ›é€²å» \u0026laquo;\u0026laquo;\u0026laquo;\u0026lt; HEAD Kibana æœ¬èº«ä¹Ÿæœ‰ server çš„åŠŸèƒ½ï¼Œè®“å…¶ä»– client é€£å…¥ã€‚ä¾‹å¦‚è®“ filebeat è‡ªå‹•å°‡ document tempalte åŒ¯å…¥ kibanaï¼Œæˆ‘å€‘ä¹Ÿéœ€è¦è¨­å®š\nkibana server certificate filebeat client to kibana server =======\nKibana æœ¬èº«ä¹Ÿæœ‰ server çš„åŠŸèƒ½ï¼Œè®“å…¶ä»– client é€£å…¥ã€‚ä¾‹å¦‚è®“ filebeat è‡ªå‹•å°‡ document tempalte åŒ¯å…¥ kibanaï¼Œæˆ‘å€‘ä¹Ÿéœ€è¦è¨­å®š\nkibana server certificate filebeat client to kibana server å°±æ˜¯ä»–å€‘å½¼æ­¤äº’æ‰“ï¼Œéƒ½è¦æœ‰ ca, key, cert\nä½†åŸºæœ¬ä¸Šçš„è¨­å®šéƒ½ä¸€æ¨£ï¼Œä¸‹é¢å¯ä»¥ä¸ç”¨çœ‹ä¸‹å»äº†XD å¦‚æœæœ‰ç”¨åˆ°å†æŸ¥æ–‡ä»¶å°±å¥½ï¼Œé€™é‚Šç›´æ¥å°çµ\nè¨­å®š security å‰è¦å…ˆæƒ³è™Ÿè‡ªå·±çš„éœ€æ±‚ï¼Œå¦‚ä½•é€£å…¥ï¼Œå®‰å…¨æ€§è¨­å®šåˆ°å“ªé‚Š ä½¿ç”¨ utility è‡ªç°½ CAï¼Œç„¶å¾Œç”¢ç”Ÿ server certificate ä½¿ç”¨ server certificate å† parse å‡º ca-certificate, client cers, key kibana ä½œç‚º server å·¥ä½œè·¯å¾‘å¯èƒ½æ˜¯é€™æ¨£ï¼š app(apm-client library) -\u0026gt; apm-server -\u0026gt; kibana -\u0026gt; elasticsearch\nkibana é€£å…¥ elasticsearchæ™‚ï¼Œ kibana æ˜¯ client åƒ elasticsearch çš„æ†‘è­‰ apm-server é€£å…¥ kibanaæ™‚ï¼Œkibana æ˜¯ serverï¼Œapm-server åƒ kibana çš„æ†‘è­‰ é¦–å…ˆæ›´æ”¹ kibana è¨­å®š\n$ sudo vim /etc/kibana/kibana.yml server.ssl.enabled: true server.ssl.certificate: /etc/kibana/config/client.cer server.ssl.key: /etc/kibana/config/client.key é‡å•Ÿ kibana\njournalctl -fu kibana Apm-server https://www.elastic.co/guide/en/apm/server/7.3/securing-apm-server.html\næ‡‰ç”¨ç«¯çš„ apm-client (ex. apm-python-client)ï¼Œé€£å…¥ apm-server\nåœ¨ http çš„ç‹€æ³ä¸‹ï¼Œé›–ç„¶æœ‰ä½¿ç”¨ secret-tokenï¼Œä½†é‚„æ˜¯è£¸å¥” åœ¨ https çš„ç‹€æ³ä¸‹ï¼Œè¦æŠŠ certificatesï¼Œç„¶å¾Œé¤µçµ¦æ‡‰ç”¨ç«¯çš„client library æ›´æ”¹ apm-server çš„è¨­å®š\nsudo vim /etc/apm-server/apm-server.yml host: \u0026quot;0.0.0.0:8200\u0026quot; secret_token: \u0026lt;è¨­å®šä¸€çµ„å¤ å®‰å…¨çš„ token\u0026gt; rum: enabled: true kibana: protocol: \u0026quot;https\u0026quot; ssl.enabled: true output.kibana: enable: false # can only have 1 output output.elasticsearch: monitoring.elasticsearch: protocol: \u0026quot;https\u0026quot; username: \u0026quot;elastic\u0026quot; password: \u0026quot;*******************\u0026quot; hosts: [\u0026quot;elk.asia-east1-b.c.checahichang.internal:9200\u0026quot;] ssl.enabled: true ssl.verification_mode: full ssl.certificate_authorities: [\u0026quot;/etc/apm-server/config/client-ca.cer\u0026quot;] ssl.certificate: \u0026quot;/etc/apm-server/config/client.cer\u0026quot; ssl.key: \u0026quot;/etc/apm-server/config/client.key\u0026quot; é‡å•Ÿ apm-server\nsystemctl restart apm-server journalctl -fu apm-server APM library æ‡‰ç”¨ç«¯çš„è¨­å®šå°±éœ€è¦ä¾æ“š library çš„å¯¦åšè¨­å®šï¼Œä¾‹å¦‚ flask-apmagent-python\nELASTIC_APM_SERVER_CERT=/etc/elk/certificates/client.cer apm agent python config server cert\nfilebeat è¨˜å¾—æˆ‘å€‘åœ¨ node ä¸Šæœ‰å®‰è£ Self-monitoring filebeatï¼Œelasticsearch æ”¹æˆ ssl é€™é‚Šç•¶ç„¶ä¹Ÿé€£ä¸ç›¡å»äº†ï¼Œå†åšåŒæ¨£æ“ä½œ\nhttps://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html\nsudo apt-get install filebeat mkdir -p /etc/filebeat/config openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -nocerts -nodes \u0026gt; /etc/filebeat/config/client.key openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -clcerts -nokeys \u0026gt; /etc/filebeat/config/client.cer openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -cacerts -nokeys -chain \u0026gt; /etc/filebeat/config/client-ca.cer Restart filebeat\nsystemctl restart filebeat journalctl -fu filebeat å¦‚æœä½ çš„æ‡‰ç”¨åœ¨ kubernetes ä¸Š å¯ä»¥ä½¿ç”¨ä¸‹é¢æ–¹æ³•æ‹¿åˆ° client.cer ï¼Œç„¶å¾Œç”¨ secret å¡é€² k8sï¼Œåœ¨ç”¨ volume from secretsï¼Œæ›çµ¦ç›£æ¸¬æ‡‰ç”¨çš„ filebeat\nmkdir -p /etc/beats/config openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -nocerts -nodes \u0026gt; /etc/beats/config/client.key openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -clcerts -nokeys \u0026gt; /etc/beats/config/client.cer openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -cacerts -nokeys -chain \u0026gt; /etc/beats/config/client-ca.cer gcloud compute scp elk:/etc/beats/config/* . client-ca.cer client.cer client.key kubectl -n elk create secret generic elk-client-certificates \\ --from-file=client-ca.cer=client-ca.cer \\ --from-file=client.cer=client.cer \\ --from-file=client.key=client.key kubectl apply -f elk/gke/filebeat/ ","permalink":"https://chechia.net/posts/2019-09-15-secure-elk-stack/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u0026ndash;\u003c/p\u003e\n\u003cp\u003eä¸Šç¯‡\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e ä»‹ç´¹äº†ï¼Œelk stack åŸºæœ¬çš„å®‰è£ï¼Œå®‰è£å®Œç²å¾—ä¸€å€‹åªæ”¯æ´ http (è£¸å¥”)çš„ elk stackï¼Œæ²’æœ‰ https åœ¨å…¬é–‹ç¶²è·¯ä¸Šä½¿ç”¨æ˜¯éå¸¸å±éšªçš„ã€‚é€™ç¯‡è¦ä¾†ä»‹ç´¹å¦‚ä½•åšå®‰å…¨æ€§è¨­å®šã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/en/elastic-stack-overview/7.3/elasticsearch-security.html\"\u003eå®˜æ–¹çš„æ–‡ä»¶åœ¨é€™è£¡\u003c/a\u003eï¼Œç¢å¿µä¸€ä¸‹ï¼Œé™¤éå° ELK çš„åŠŸèƒ½æœ‰ä¸€å®šäº†è§£ï¼Œä¸ç„¶é€™ä»½çœŸçš„ä¸æ˜¯å¾ˆå‹å–„ã€‚å»ºè­°å¾å®˜æ–¹æ–‡ä»¶åº•ä¸‹çš„\u003ca href=\"https://www.elastic.co/guide/en/elastic-stack-overview/7.3/security-getting-started.html\"\u003eTutorial: Getting started with security\u003c/a\u003e é–‹å§‹ï¼Œéç¨‹æ¯”è¼ƒä¸æœƒé€™éº¼è¡€å°¿ã€‚\u003c/p\u003e\n\u003cp\u003eç¸½ä¹‹ç‚ºäº†å•Ÿç”¨ authentication \u0026amp; httpsï¼Œé€™ç¯‡è¦åšçš„äº‹æƒ…ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eenable x-pack \u0026amp; activate basic license\u003c/li\u003e\n\u003cli\u003eGenerate self-signed ca, server certificate, client certificate\u003c/li\u003e\n\u003cli\u003eConfigure Elasticsearch, Kibana, \u0026amp; other components to\n\u003cul\u003e\n\u003cli\u003euse server certificate when act as server\u003c/li\u003e\n\u003cli\u003euse client certificate when connect to an ELK server\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch1 id=\"å•Ÿç”¨-x-pack\"\u003eå•Ÿç”¨ X-pack\u003c/h1\u003e\n\u003cp\u003eElasticsearch çš„å®‰å…¨æ€§æ¨¡çµ„ç”± x-pack extension æä¾›ï¼Œåœ¨ \u003ca href=\"https://www.elastic.co/what-is/open-x-pack\"\u003e6.3.0 ä¹‹å¾Œçš„ç‰ˆæœ¬\u003c/a\u003eï¼Œå®‰è£ elasticsearch çš„éç¨‹ä¸­å°±é è¨­å®‰è£ x-packã€‚\u003c/p\u003e","title":"Secure Elk Stack"},{"content":"2020 Ité‚¦å¹«å¿™éµäººè³½ ç³»åˆ—æ–‡ç« \nSelf-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP ä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\nç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\nå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š https://chechia.net é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\n\u0026ndash;\nç°¡ä»‹ ELK stack å®˜æ–¹èªªæ˜æ–‡ä»¶\nELK çš„å…ƒä»¶ Elasticsearch: åŸºæ–¼ Lucene çš„åˆ†æ•£å¼å…¨æ–‡æœç´¢å¼•æ“ Logstash: æ•¸æ“šè™•ç† pipeline Kibana: ELK stack çš„ç®¡ç†å¾Œå°èˆ‡æ•¸æ“šè¦–è¦ºåŒ–å·¥å…· Beats: è¼•é‡ç´šçš„æ‡‰ç”¨ç«¯æ•¸æ“šæ”¶é›†å™¨ï¼Œæœƒå¾è¢«ç›£æ§ç«¯æ”¶é›† log èˆ‡ç›£æ§æ•¸æ“š(metrics) ELK çš„å·¥ä½œæµç¨‹ beats -\u0026gt; (logstash) -\u0026gt; elasticsearch -\u0026gt; kibana\nå°‡ beats æ”¾åœ¨æ‡‰ç”¨ç«¯çš„ä¸»æ©Ÿä¸Šï¼Œæˆ–æ˜¯åœ¨å®¹å™¨åŒ–ç’°å¢ƒç¨®ä½œç‚º sidecarï¼Œè·Ÿæ‡‰ç”¨æ”¾åœ¨ä¸€èµ· è¨­å®š beats å¾æŒ‡å®šçš„è·¯å¾‘æ”¶é›† log èˆ‡ metrics è¨­å®š beats å‘å¾Œè¼¸å‡ºçš„é ç«¯ç›®æ¨™ (Optional) beats è¼¸å‡ºåˆ° logstash ï¼Œå…ˆé€²è¡Œæ•¸æ“šçš„è®Šæ›´ã€æ ¼å¼æ•´ç†ï¼Œåœ¨å¾Œé€åˆ° elasticsearch beats å‘å¾Œè¼¸å‡ºåˆ° elasticsearchï¼Œå„²å­˜æ•¸æ“šæ–‡ä»¶(document)ï¼Œä¸¦ä¾ç…§æ¨£å¼(template)èˆ‡ç´¢å¼•(index)å„²å­˜ï¼Œä¾¿å¯åœ¨ elasticsearch ä¸Šå…¨æ–‡æœç´¢æ•¸æ“š é€é Kibanaï¼Œå°‡ elasticsearch ä¸Šçš„ log é¡¯ç¤º å®˜æ–¹ä¸æ˜¯æœ‰å‡ºæ–‡ä»¶å— Elastic å®˜æ–¹æº–å‚™äº†å¤§é‡çš„æ–‡ä»¶ï¼Œç†è«–ä¸Šè¦è·Ÿè‘—æ–‡ä»¶ä¸€æ­¥ä¸€æ­¥æ¶è¨­é€™æ•´å¥—å·¥å…·æ‡‰è©²æ˜¯ååˆ†å®¹æ˜“ã€‚ç„¶è€Œå¯¦éš›ç…§è‘—åšå»é‡ä¸Šå¾ˆå¤šå›°é›£ã€‚ç”±æ–¼ç¼ºä¹ get-started çš„ç¯„ä¾‹æ–‡ä»¶ï¼Œä¸ç†Ÿæ‚‰ ELK è¨­å®šçš„ä½¿ç”¨è€…ï¼Œå¸¸å¸¸éœ€è¦åœä¸‹ä¾†é™¤éŒ¯ï¼Œç”šè‡³å› ç‚ºæ¼æ‰æŸå€‹æ­¥é©Ÿï¼Œè€Œéœ€è¦å›é ­é‡åšä¸€éã€‚\nèªªç©¿äº†æœ¬ç¯‡çš„æŠ€è¡“å«é‡ä¸é«˜ï¼Œå°±åªæ˜¯ä¸€å€‹è¸©é›·éç¨‹ã€‚\nLets get our hands dirty.\nWARNING é€™ç¯‡å®‰è£éç¨‹æ²’æœ‰åšå®‰å…¨æ€§è¨­å®šï¼Œç”±æ–¼ ELK stack çš„å®‰å…¨æ€§åŠŸèƒ½æ¨¡çµ„ï¼Œåœ¨v6.3.0 ä»¥å‰çš„ç‰ˆæœ¬æ˜¯ä¸åŒ…å«å®‰å…¨æ€§æ¨¡çµ„çš„ï¼Œå®˜æ–¹çš„å®‰è£èªªæ˜æ–‡ä»¶å°‡å®‰å…¨æ€§è¨­å®šå¦æˆä¸€ç¯‡ã€‚æˆ‘ç¬¬ä¸€æ¬¡å®‰è£ï¼Œå…¨éƒ¨å®‰è£å®Œå¾Œï¼Œæ‰ç™¼ç¾è£é ­æ²’æœ‰ä»»ä½•å®‰å…¨æ€§è¨­å®šï¼ŒåŒ…å«å¸³è™Ÿå¯†ç¢¼ç™»å…¥ã€api secret tokenã€https/tls é€šé€šæ²’æœ‰ï¼Œæ•´çµ„ elk è£¸å¥”ã€‚\næˆ‘é€™é‚Šåˆ†é–‹çš„ç›®çš„ï¼Œä¸æ˜¯è®“å¤§å®¶éƒ½è·Ÿæˆ‘ä¸€æ¨£è¢«é›·(XD)ï¼Œè€Œæ˜¯å› ç‚º\nå¦èµ·ä¸€ç¯‡å°å®‰å…¨æ€§è¨­å®šå¤šåŠ èªªæ˜ åœ¨å®‰å…¨çš„å…§ç¶²ä¸­ï¼Œæ²’æœ‰å®‰å…¨æ€§è¨­å®šï¼Œå¯ä»¥å¤§å¹…åŠ é€Ÿé–‹ç™¼èˆ‡é™¤éŒ¯ é›–ç„¶æ²’æœ‰å®‰å…¨æ€§è¨­å®šï¼Œä½†ä»ç„¶æœ‰å®Œæ•´çš„åŠŸèƒ½ï¼Œå¦‚æœåªæ˜¯åœ¨æ¸¬è©¦ç’°å¢ƒï¼Œæˆ–æ˜¯æƒ³è¦è©•ä¼°è©¦ç”¨ self-hosted ELKï¼Œé€™ç¯‡çš„èªªæ˜å·²è¶³å¤ ã€‚ä½†åƒè¬ä¸è¦ç”¨é€™ç¯‡ä¸Š public network æˆ–æ˜¯ç”¨åœ¨ production ç’°å¢ƒå–”ã€‚\nå¦‚æœå¸Œæœ›ç¬¬ä¸€æ¬¡å®‰è£å°±æœ‰å®Œæ•´çš„ security è¨­å®šï¼Œè«‹ç­‰å¾…ä¸‹ç¯‡ Secure ELK Stask\nè¨è«–éœ€æ±‚èˆ‡è¦æ ¼ é€™é‚Šåªæ˜¯å¸¶å¤§å®¶éä¸€ä¸‹åŸºç¤å®‰è£æµç¨‹ï¼Œæˆ‘å€‘åœ¨ç§æœ‰ç¶²è·¯ä¸­æ­å»ºä¸€å° standalone çš„ ELK stackï¼Œé€šé€šæ”¾åœ¨ä¸€å°ç¯€é»(node)ä¸Šã€‚\nelk-node-standalone 10.140.0.10 app-node-1 10.140.0.11 ... ... æœ¬æ©Ÿçš„ ELK stack å…ƒä»¶ï¼Œå½¼æ­¤é€é localhost é€£ç·š\nElasticsearch: localhost:9200 Kibana: localhost:5601 Apm-server: localhost:8200 Self Monitoring Services ç§æœ‰ç¶²è·¯ä¸­çš„å¤–éƒ¨æœå‹™é€é 10.140.0.10\nbeats å¾å…¶ä»– node è¼¸å‡ºåˆ° Elasticsearch: 10.140.0.10:9200 beats å¾å…¶ä»– node è¼¸å‡ºåˆ° Apm-server: 10.140.0.10:8200 åœ¨å…§éƒ¨ç¶²è·¯ä¸­ é€é browser å­˜å– Kibana: 10.140.0.10:5601 standalone çš„å¥½è™•:\næ–¹ä¾¿ (å†æ¬¡å¼·èª¿é€™ç¯‡åªæ˜¯ç¤ºç¯„ï¼Œå¯¦å‹™ä¸Šä¸è¦è²ªä¸€æ™‚æ–¹ä¾¿ï¼Œç¶­é‹å´©æ½°) æœ€ç°¡åŒ–è¨­å®šï¼ŒELK æœ‰éå¸¸å¤§é‡çš„è¨­å®šå¯ä»¥èª¿æ•´ï¼Œé€™ç¯‡ç°¡åŒ–äº†å¤§éƒ¨åˆ† Standaloneå¯èƒ½é€ æˆçš„å•é¡Œ:\nNo High Availablity: æ²’æœ‰ä»»ä½•å®¹éŒ¯å‚™æ´å¯ä»¥ failoverï¼Œé€™å°æ›å°±å…¨æ› å¤–éƒ¨æœå‹™å¤šçš„è©±ï¼Œå¾ˆå®¹æ˜“å°±è¶…é node ä¸Šå°æ–¼ç¶²è·¯å­˜å–çš„é™åˆ¶ï¼Œé€ æˆ tcp drop æˆ– delayã€‚éœ€è¦èª¿æ•´ ulimit ä¾†å¢åŠ ç¶²è·¯ï¼Œç•¶ç„¶é€™åœ¨é›²ç«¯ä¸Šæœƒçµ¦ç¶­é‹å¸¶ä¾†æ›´å¤šéº»ç…©ï¼Œä¸æ˜¯ä¸€å€‹å¥½è§£æ³•ã€‚ å¦‚æœè¦æœ‰ production ready çš„ ELK\nHA é–‹èµ·ä¾† æŠŠæœå‹™åˆ†æ•£åˆ°ä¸åŒ node ä¸Š, æ–¹ä¾¿ä¹‹å¾Œ scale out å¤šé–‹å¹¾å° elasticsearch-1, elasticsearch-2, elasticsearch-3\u0026hellip; kibana-1 apm-server-1, apm-server-2, \u0026hellip; å¦‚æœæ‡‰ç”¨åœ¨å·²ç¶“å®¹å™¨åŒ–, é€™äº›æœå‹™å…ƒä»¶ä¹Ÿå¯ä»¥ä¸Š Kubernetes åšå®¹å™¨è‡ªå‹•åŒ–ï¼Œé€™å€‹éƒ¨ä»½è »å¥½ç©ï¼Œå¦‚æœæœ‰æ™‚é–“æˆ‘å€‘ä¾†èŠé€™ç¯‡ ä¸»æ©Ÿè¨­å®š Elasticsearch å„²å­˜æ•¸æ“šæœƒä½”ç”¨ä¸å°‘ç¡¬ç¢Ÿç©ºé–“ï¼Œæˆ‘å€‹äººçš„ç¿’æ…£æ˜¯åªè¦æœ‰é¡å¤–å ç”¨å„²å­˜ç©ºé–“ï¼Œéƒ½è¦å¦å¤–æ›è¼‰ç¡¬ç¢Ÿï¼Œä¸è¦å ç”¨ rootï¼Œæ‰€ä»¥é€™é‚Šæœƒéœ€è¦å¦å¤–æ›è¼‰ç¡¬ç¢Ÿã€‚\nGCP ä¸Šä½¿ç”¨ Google Compote Engine çš„æœ‹å‹ï¼Œå¯ä»¥ç…§ Google å®˜æ–¹æ“ä½œæ­¥é©Ÿæ“ä½œ\nå®Œæˆå¾Œæ¥è¿‘é€™æ¨£\n$ df -h $ df --human-readable Filesystem Size Used Avail Use% Mounted on /dev/sda1 9.6G 8.9G 682M 93% / /dev/sdb 492G 63G 429G 13% /mnt/disks/elk $ ls /mnt/disks/elk /mnt/disks/elk/elasticsearch /mnt/disks/elk/apm-server /mnt/disks/elk/kibana è‡³æ–¼éœ€è¦å¤šå°‘å®¹é‡ï¼Œå–æ±ºæ”¶é›†æ•¸æ“šçš„æ•¸é‡ï¼Œè½å·®éå¸¸å¤§ï¼Œå¯ä»¥å…ˆä¸Šå€‹ 100Gb ï¼Œè©¦è·‘ä¸€æ®µæ™‚é–“ï¼Œå†è¦–æƒ…æ³ scale storage diskã€‚\né–‹é˜²ç«ç‰† éœ€è¦é–‹æ”¾ 10.140.0.10 é€™å°æ©Ÿå™¨çš„å¹¾å€‹ port\nelasticsearch :9200 ä¾†æºåªé–‹æ”¾ç§æœ‰ç¶²è·¯å…¶ä»– ip 10.140.0.0/9 apm-server :8200 (åŒä¸Š) kibana :5601 (åŒä¸Š)ï¼Œå¦‚æœæƒ³å¾å¤–éƒ¨é€é browseré–‹ï¼Œéœ€è¦ whitelist ip GCP ä¸Šæœ‰ default çš„é˜²ç«ç‰†å…è¨±è¦å‰‡ï¼Œç§æœ‰ç¶²è·¯å¯ä»¥å½¼æ­¤é€£ç·š\ndefault-allow-internal: :all :10.140.0.0/9 tcp:0-65535 Install Elasticsearch Install Elasticsearch å®˜æ–¹æ–‡ä»¶ 7.3\næˆ‘å€‘é€™é‚Šç›´æ¥åœ¨ ubuntu 18.04 ä¸Šä½¿ç”¨ apt ä½œç‚ºå®‰è£\nsudo apt-get install apt-transport-https wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - add-apt-repository \u0026quot;deb https://artifacts.elastic.co/packages/7.x/apt stable main\u0026quot; sudo apt-get update sudo apt-get install elasticsearch å®‰è£å®Œå¾Œè·¯å¾‘é•·é€™æ¨£\n/etc/elasticsearch /etc/elasticsearch/elasticsearch.yml /etc/elasticsearch/jvm.options # Utility /usr/share/elasticsearch/bin/ # Log /var/log/elasticsearch/elasticsearch.log æœ‰éœ€è¦ä¹Ÿå¯ä»¥è¤‡å¯«è¨­å®šæª”ï¼ŒæŠŠ log ä¹Ÿç§»åˆ° /mnt/disks/elk/elasticsearch/logs\næœå‹™æ§åˆ¶ é€é systemd ç®¡ç†ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ systemctl æ§åˆ¶ï¼Œ ç”¨æˆ¶ elasticsearch:elasticsearchï¼Œæ“ä½œæ™‚æœƒéœ€è¦ sudo æ¬Šé™ã€‚\nä½†åœ¨å•Ÿå‹•å‰è¦å…ˆèª¿æ•´æ•¸æ“šå„²å­˜è·¯å¾‘ï¼Œä¸¦æŠŠæ¬Šé™ç§»è½‰çµ¦ä½¿ç”¨è€…ã€‚\nmkdir -p /mnt/disks/elk/elasticsearch chown elasticsearch:elasticsearch /mnt/disks/elk/elasticsearch è¨­å®šæª”æ¡ˆ ELK æä¾›äº†è¨±å¤šå¯è¨­å®šèª¿æ•´çš„è¨­å®š,ä½†é¾å¤§çš„è¨­å®šæª”æ¡ˆä¹Ÿååˆ†é›£ä¸Šæ‰‹ã€‚æˆ‘å€‘é€™é‚Šå…ˆç°¡å–®æ›´æ”¹ä»¥ä¸‹è¨­å®šæª”æ¡ˆ\nsudo vim /etc/elasticsearch/elasticsearch.yml # Change Network network.host: 0.0.0.0 # Change data path path.data: /mnt/disks/elk/elasticsearch vim /etc/elasticsearch/jvm-options # Adjust heap to 4G -Xms4g -Xmx4g # Enable xpack.security discovery.seed_hosts: [\u0026quot;10.140.0.10\u0026quot;] discovery.type: \u0026quot;single-node\u0026quot; xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.license.self_generated.type: basic 6.3.0 å¾Œçš„ç‰ˆæœ¬å·²ç¶“é™„ä¸Šå®‰å…¨æ€§æ¨¡çµ„ xpackï¼Œé€™é‚Šé †ä¾¿é–‹èµ·ä¾†ã€‚é—œæ–¼ xpack çš„å®‰å…¨æ€§è¨­å®šï¼Œé€™é‚Šå…ˆç•¥éä¸æã€‚\næœ‰å•Ÿç”¨ xpack ï¼Œå¯ä»¥è®“æˆ‘å€‘é€é elasticsearch é™„å¸¶çš„å·¥å…·ï¼Œç”¢ç”Ÿä½¿ç”¨è€…èˆ‡å¸³è™Ÿå¯†ç¢¼ã€‚\n/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto # Keep your passwords safe ç„¶å¾ŒæŠŠå•Ÿå‹• Elasticsearch\nsudo systemctl enable elasticsearch.service sudo systemctl start elasticsearch.service sudo systemctl status elasticsearch.service çœ‹ä¸€ä¸‹ logï¼Œç¢ºå®šæœå‹™æœ‰åœ¨æ­£å¸¸å·¥ä½œ\ntail -f /var/log/elasticsearch/elasticsearch.log åœ¨ node ä¸Šè©¦æ‰“ Elasticsearch API\n$ curl localhost:9200 { \u0026quot;name\u0026quot; : \u0026quot;elk\u0026quot;, \u0026quot;cluster_name\u0026quot; : \u0026quot;elasticsearch\u0026quot;, \u0026quot;cluster_uuid\u0026quot; : \u0026quot;uiMZe7VETo-H6JLFLF4SZg\u0026quot;, \u0026quot;version\u0026quot; : { \u0026quot;number\u0026quot; : \u0026quot;7.3.1\u0026quot;, \u0026quot;build_flavor\u0026quot; : \u0026quot;default\u0026quot;, \u0026quot;build_type\u0026quot; : \u0026quot;deb\u0026quot;, \u0026quot;build_hash\u0026quot; : \u0026quot;4749ba6\u0026quot;, \u0026quot;build_date\u0026quot; : \u0026quot;2019-08-19T20:19:25.651794Z\u0026quot;, \u0026quot;build_snapshot\u0026quot; : false, \u0026quot;lucene_version\u0026quot; : \u0026quot;8.1.0\u0026quot;, \u0026quot;minimum_wire_compatibility_version\u0026quot; : \u0026quot;6.8.0\u0026quot;, \u0026quot;minimum_index_compatibility_version\u0026quot; : \u0026quot;6.0.0-beta1\u0026quot; }, \u0026quot;tagline\u0026quot; : \u0026quot;You Know, for Search\u0026quot; } Kibana æœ‰äº†æ­£å¸¸å·¥ä½œçš„ Elasticsearchï¼Œæ¥ä¸‹ä¾†è¦å®‰è£ kibanaï¼Œç”±æ–¼ apt repository å·²ç¶“åŒ¯å…¥ï¼Œé€™é‚Šç›´æ¥\nsudo apt-get update sudo apt-get install kibana ä¸€æ¨£å¿«é€Ÿè¨­å®šä¸€ä¸‹\n$ vim /etc/kibana/kinana.yml # change server.host from localhost to 0.0.0.0 to allow outside requests server.host: \u0026quot;0.0.0.0\u0026quot; # Add elasticsearch password elasticsearch.username: \u0026quot;kibana\u0026quot; elasticsearch.password: sudo systemctl enable kibana.service sudo systemctl start kibana.service sudo systemctl status kibana.service æª¢æŸ¥ log ä¸¦è©¦æ‰“ä¸€ä¸‹\nsudo systemctl status kibana $ curl localhost:5601 é€éå…§ç¶² ip ä¹Ÿå¯ä»¥ç”¨ browser å­˜å– ä½¿ç”¨ elastic é€™çµ„å¸³è™Ÿå¯†ç¢¼ç™»å…¥ï¼Œå¯ä»¥æœ‰ç®¡ç†å“¡æ¬Šé™ å¯ä»¥æª¢è¦–ä¸€ä¸‹ kibana çš„é é¢ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦ç³»çµ±åŠŸèƒ½éƒ½ä¸Šå¸¸ä¸Šç·š http://10.140.0.10/app/monitoring#\nFilebeat ä»¥ä¸Šæ˜¯ ELK æœ€åŸºæœ¬æ¶æ§‹: elasticsearch å¼•æ“èˆ‡å‰ç«¯è¦–è¦ºåŒ–ç®¡ç†å·¥å…· Kibanaã€‚ç•¶ç„¶ç¾åœ¨é€²å» kibana æ˜¯æ²’æœ‰æ•¸æ“šçš„ï¼Œæ‰€ä»¥æˆ‘å€‘ç¾åœ¨ä¾†å®‰è£ç¬¬ä¸€å€‹ beatï¼Œæ”¶é›†ç¬¬ä¸€ç­†æ•¸æ“šã€‚\nä½ å¯èƒ½æœƒè¦ºå¾—å¥‡æ€ª: æˆ‘ç¾åœ¨æ²’æœ‰ä»»ä½•éœ€è¦ç›£æ§çš„æ‡‰ç”¨ï¼Œå»å“ªæ”¶é›†æ•¸æ“š?\nELK æä¾›çš„è‡ªæˆ‘ç›£æ¸¬ (self-monitoring) çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åœ¨ node ä¸Šéƒ¨å±¬ filebeat ä¸¦å•Ÿç”¨ modulesï¼Œä¾¿å¯ä»¥æŠŠé€™å° node ä¸Šçš„ elasticsearch é‹è¡Œçš„ç‹€æ³ï¼ŒåŒ…å«cpu ç‹€æ³ã€è¨˜æ†¶é«”ç”¨é‡ã€å„²å­˜ç©ºé–“ç”¨é‡ã€å®‰å…¨æ€§å‘Šè­¦ã€\u0026hellip;éƒ½åšç‚ºæ•¸æ“šï¼Œå‚³åˆ° elasticsearch ä¸­ï¼Œä¸¦åœ¨ Kibana monitoring é é¢è£½åœ–é¡¯ç¤ºã€‚\né€™é‚Šä¹Ÿå‰›å¥½åšç‚ºæˆ‘å€‘ ELK stack çš„ç¬¬ä¸€ç­†æ•¸æ“šæ”¶é›†ã€‚\nWARNING: é€™é‚Šä¸€æ¨£è¦æé†’ï¼Œ production ç’°å¢ƒå¤šåŠæœƒä½¿ç”¨å¦å¤–ä¸€çµ„çš„ elasticsearch ä¾†ç›£æ§ä¸»è¦çš„é€™çµ„ elastic stackï¼Œä»¥ç¶­æŒ elk stack çš„ç©©å®šæ€§ï¼Œæ‰ä¸æœƒè‡ªå·± monitoring è‡ªå·±ï¼Œçµæœ elastic æ›äº†ï¼Œmetrics è·ŸéŒ¯èª¤è¨Šæ¯éƒ½çœ‹ä¸åˆ°ã€‚\nå®˜æ–¹å®‰è£æ–‡ä»¶\nsudo apt-get update sudo apt-get install filebeat é è¨­çš„ filebeat.yml è¨­å®šæª”æ¡ˆä¸æ˜¯å®Œæ•´çš„ï¼Œè«‹åˆ°å®˜ç¶²ä¸‹è¼‰å®Œæ•´ç‰ˆï¼Œä½†å®˜ç¶²æ²’çµ¦æª”æ¡ˆé€£çµ(æ…˜)ï¼Œåªæœ‰ç¶²é ç‰ˆ https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html\næˆ‘å€‘ä¸Š github æŠŠå¥¹è¼‰ä¸‹ä¾†\n$ wget https://raw.githubusercontent.com/elastic/beats/v7.3.1/filebeat/filebeat.reference.yml $ sudo mv filebeat-reference-y $ sudo vim /etc/filebeat/filebeat.yml # Enable elasticsearch module and kibana module to process metrics of localhost elasticsearch \u0026amp; kibana filebeat.modules: - module: elasticsearch # Server log server: enabled: true - module: kibana # All logs log: enabled: true # The name will be added to metadata name: filebeat-elk fields: env: elk # Add additional cloud_metadata since we're on GCP processors: - add_cloud_metadata: ~ # Output to elasticsearch output.elasticsearch: enabled: true hosts: [\u0026quot;localhost:9200\u0026quot;] protocol: \u0026quot;http\u0026quot; username: \u0026quot;elastic\u0026quot; password: # Configure kibana with filebeat: add template, dashboards, etc... setup.kibana: host: \u0026quot;localhost:5601\u0026quot; protocol: \u0026quot;http\u0026quot; username: \u0026quot;elastic\u0026quot; password: å•Ÿå‹• filebeat\nsudo systemctl start filebeat çœ‹ä¸€ä¸‹ logï¼Œfilebeat æœƒé–‹å§‹æ”¶é›† elasticsearch çš„ log èˆ‡ metricsï¼Œå¯ä»¥åœ¨ log ä¸Šçœ‹åˆ°æ”¶é›†çš„ç‹€æ³ã€‚\n$ sudo journalctl -fu filebeat Sep 15 06:28:50 elk filebeat[9143]: 2019-09-15T06:28:50.176Z INFO [monitoring] log/log.go:145 Non-zero metrics in the last 30s {\u0026quot;monitoring\u0026quot;: {\u0026quot;metrics\u0026quot;: {\u0026quot;beat\u0026quot;:{\u0026quot;cpu\u0026quot;:{\u0026quot;system\u0026quot;:{\u0026quot;ticks\u0026quot;:1670860,\u0026quot;time\u0026quot;:{\u0026quot;ms\u0026quot;:66}},\u0026quot;total\u0026quot;:{\u0026quot;ticks\u0026quot;:6964660,\u0026quot;time\u0026quot;:{\u0026quot;ms\u0026quot;:336},\u0026quot;value\u0026quot;:6964660},\u0026quot;user\u0026quot;:{\u0026quot;ticks\u0026quot;:5293800,\u0026quot;time\u0026quot;:{\u0026quot;ms\u0026quot;:270}}},\u0026quot;handles\u0026quot;:{\u0026quot;limit\u0026quot;:{\u0026quot;hard\u0026quot;:4096,\u0026quot;soft\u0026quot;:1024},\u0026quot;open\u0026quot;:11},\u0026quot;info\u0026quot;:{\u0026quot;ephemeral_id\u0026quot;:\u0026quot;62fd4bfa-1949-4356-9615-338ca6a95075\u0026quot;,\u0026quot;uptime\u0026quot;:{\u0026quot;ms\u0026quot;:786150373}},\u0026quot;memstats\u0026quot;:{\u0026quot;gc_next\u0026quot;:7681520,\u0026quot;memory_alloc\u0026quot;:4672576,\u0026quot;memory_total\u0026quot;:457564560376,\u0026quot;rss\u0026quot;:-32768},\u0026quot;runtime\u0026quot;:{\u0026quot;goroutines\u0026quot;:98}},\u0026quot;filebeat\u0026quot;:{\u0026quot;events\u0026quot;:{\u0026quot;active\u0026quot;:-29,\u0026quot;added\u0026quot;:1026,\u0026quot;done\u0026quot;:1055},\u0026quot;harvester\u0026quot;:{\u0026quot;open_files\u0026quot;:4,\u0026quot;running\u0026quot;:4}},\u0026quot;libbeat\u0026quot;:{\u0026quot;config\u0026quot;:{\u0026quot;module\u0026quot;:{\u0026quot;running\u0026quot;:0}},\u0026quot;output\u0026quot;:{\u0026quot;events\u0026quot;:{\u0026quot;acked\u0026quot;:1055,\u0026quot;active\u0026quot;:-50,\u0026quot;batches\u0026quot;:34,\u0026quot;total\u0026quot;:1005},\u0026quot;read\u0026quot;:{\u0026quot;bytes\u0026quot;:248606},\u0026quot;write\u0026quot;:{\u0026quot;bytes\u0026quot;:945393}},\u0026quot;pipeline\u0026quot;:{\u0026quot;clients\u0026quot;:9,\u0026quot;events\u0026quot;:{\u0026quot;active\u0026quot;:32,\u0026quot;published\u0026quot;:1026,\u0026quot;total\u0026quot;:1026},\u0026quot;queue\u0026quot;:{\u0026quot;acked\u0026quot;:1055}}},\u0026quot;registrar\u0026quot;:{\u0026quot;states\u0026quot;:{\u0026quot;current\u0026quot;:34,\u0026quot;update\u0026quot;:1055},\u0026quot;writes\u0026quot;:{\u0026quot;success\u0026quot;:35,\u0026quot;total\u0026quot;:35}},\u0026quot;system\u0026quot;:{\u0026quot;load\u0026quot;:{\u0026quot;1\u0026quot;:1.49,\u0026quot;15\u0026quot;:0.94,\u0026quot;5\u0026quot;:1.15,\u0026quot;norm\u0026quot;:{\u0026quot;1\u0026quot;:0.745,\u0026quot;15\u0026quot;:0.47,\u0026quot;5\u0026quot;:0.575}}}}}} å¦‚æœæ•¸æ“šéƒ½æœ‰é€å‡ºï¼Œå°±å¯ä»¥å›åˆ° kibana çš„é é¢ï¼Œçœ‹ä¸€ä¸‹ç›®å‰é€™å€‹ elasticsearch é›†ç¾¤ï¼Œæœ‰é–‹å•Ÿ monitoring åŠŸèƒ½çš„å…ƒä»¶å€‘ï¼Œæ˜¯å¦éƒ½æœ‰æ­£å¸¸å·¥ä½œã€‚\nhttp://10.140.0.10/app/monitoring#\né é¢é•·å¾—åƒé€™æ¨£\nStandalone cluster ä¸­çš„ filebeatï¼Œæ˜¯é‚„æœªè·Ÿ elasticsearch é…å°å®Œæˆçš„æ•¸æ“šï¼Œæœƒé¡¯ç¤ºåœ¨å¦å¤–ä¸€å€‹é›†ç¾¤ä¸­ï¼Œé…å°å®Œå¾Œæœƒæ­¸åˆ° elk cluster ä¸­ï¼Œå°±æ˜¯æˆ‘å€‘çš„ä¸»è¦ clusterã€‚\né»é€²å»å¯ä»¥çœ‹å„å€‹å…ƒä»¶çš„æœå‹™æƒ…å½¢ã€‚\nå°çµ ç°¡å–®æ€è€ƒ self-host ELK stack æ­å»ºçš„æ¶æ§‹ åœ¨å–®ä¸€ node ä¸Šå®‰è£æœ€ç°¡æ˜“çš„ elastic stack è¨­å®šå…ƒä»¶çš„ output ä½ç½® è¨­å®š self-monitoring æ­å–œå„ä½ç²å¾—ä¸€å€‹è£¸å¥”ä½†æ˜¯åŠŸèƒ½å®Œæ•´çš„ ELK, æˆ‘å€‘ä¸‹ç¯‡å†å‘å®‰å…¨æ€§é‚é€²ã€‚\n","permalink":"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/","summary":"\u003cp\u003e\u003ca href=\"https://ithelp.ithome.com.tw/2020ironman\"\u003e2020 Ité‚¦å¹«å¿™éµäººè³½\u003c/a\u003e ç³»åˆ—æ–‡ç« \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-self-host-elk-stack-on-gcp/\"\u003eSelf-host ELK stack on GCP\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-15-secure-elk-stack/\"\u003eSecure ELK Stask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-monitoring-gce-with-elk/\"\u003eç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-19-monitoring-gke-with-elk/\"\u003eç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-18-elastic-or-not-elastic/\"\u003eæ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chechia.net/posts/2019-09-21-logstash-on-gke/\"\u003eä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç†\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eElasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜\u003c/li\u003e\n\u003cli\u003eDebug ELK stack on GCP\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä½œç‚ºç¯„ä¾‹çš„ ELK çš„ç‰ˆæœ¬æ˜¯ç•¶å‰çš„ stable release 7.3.1ã€‚\u003c/p\u003e\n\u003cp\u003eç”±æ–¼æˆ‘æ¯”è¼ƒç†Ÿæ‚‰ GCP / GKE çš„æœå‹™ï¼Œé€™ç¯‡çš„æ“ä½œéç¨‹éƒ½æœƒä»¥ GCP å¹³å°ä½œç‚ºç¯„ä¾‹ï¼Œä¸éæ“ä½œéç¨‹å¤§é«”ä¸Šæ˜¯è·¨å¹³å°é€šç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå°æˆ‘çš„æ–‡ç« æœ‰èˆˆè¶£ï¼Œæ­¡è¿åˆ°æˆ‘çš„ç¶²ç«™ä¸Š \u003ca href=\"https://chechia.net\"\u003ehttps://chechia.net\u003c/a\u003e é–±è®€å…¶ä»–æŠ€è¡“æ–‡ç« ï¼Œæœ‰ä»»ä½•è¬¬èª¤ä¹Ÿè«‹å„æ–¹å¤§å¾·ç›´æ¥è¯ç¹«æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\u003c/p\u003e\n\u003cp\u003e\u0026ndash;\u003c/p\u003e\n\u003ch1 id=\"ç°¡ä»‹-elk-stack\"\u003eç°¡ä»‹ ELK stack\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://www.elastic.co/guide/index.html\"\u003eå®˜æ–¹èªªæ˜æ–‡ä»¶\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"elk-çš„å…ƒä»¶\"\u003eELK çš„å…ƒä»¶\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eElasticsearch: åŸºæ–¼ Lucene çš„åˆ†æ•£å¼å…¨æ–‡æœç´¢å¼•æ“\u003c/li\u003e\n\u003cli\u003eLogstash: æ•¸æ“šè™•ç† pipeline\u003c/li\u003e\n\u003cli\u003eKibana: ELK stack çš„ç®¡ç†å¾Œå°èˆ‡æ•¸æ“šè¦–è¦ºåŒ–å·¥å…·\u003c/li\u003e\n\u003cli\u003eBeats: è¼•é‡ç´šçš„æ‡‰ç”¨ç«¯æ•¸æ“šæ”¶é›†å™¨ï¼Œæœƒå¾è¢«ç›£æ§ç«¯æ”¶é›† log èˆ‡ç›£æ§æ•¸æ“š(metrics)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"elk-çš„å·¥ä½œæµç¨‹\"\u003eELK çš„å·¥ä½œæµç¨‹\u003c/h3\u003e\n\u003cp\u003ebeats -\u0026gt; (logstash) -\u0026gt; elasticsearch -\u0026gt; kibana\u003c/p\u003e","title":"Self-host ELK stack - Installation"},{"content":"å„ä½å¥½ï¼Œæˆ‘æ˜¯Che-Chia Changï¼Œç¤¾ç¾¤ä¸Šå¸¸ç”¨çš„åå­æ˜¯ David Changã€‚æ˜¯å€‹è»Ÿé«”å·¥ç¨‹å¸«ï¼Œå°ˆé•·çš„é ˜åŸŸæ˜¯å¾Œç«¯é–‹ç™¼ï¼Œé–‹ç™¼ç¶­é‹ï¼Œå®¹å™¨åŒ–æ‡‰ç”¨ï¼Œä»¥åŠKubernetesé–‹ç™¼ç®¡ç†ã€‚ç›®å‰ç‚º Golang Taiwan Meetup çš„ organizerã€‚\nå—åˆ°å‹äººå€‘é‚€è«‹ï¼ˆæ¨å‘ï¼‰åƒåŠ äº†2020 Ité‚¦å¹«å¿™éµäººè³½ï¼ŒæŒ‘æˆ°åœ¨30å¤©å…§ï¼Œæ¯å¤©ç™¼ä¸€ç¯‡æŠ€è¡“åˆ†äº«æ–‡ç« ã€‚ä¸€æ–¹é¢å°‡å·¥ä½œä¸Šé‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•åˆ†äº«çµ¦ç¤¾ç¾¤ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯çµ¦è‡ªå·±ä¸€é»æˆé•·çš„å£“åŠ›ï¼ŒæŠŠé€™æ®µæ™‚é–“çš„å¿ƒå¾—æ²ˆæ¾±ä¸‹ä¾†ï¼Œå› æ­¤ä¹Ÿäº†é€™ç³»åˆ—æ–‡ç« ã€‚\næœ¬ç³»åˆ—æ–‡ç« é‡é»æœ‰ä¸‰ï¼š\næä¾›çš„è§£æ±ºæ–¹æ¡ˆï¼Œé™„ä¸Šä¸€æ­¥æ­¥çš„æ“ä½œæ­¥é©Ÿã€‚å¸Œæœ›è®“è®€è€…å¯ä»¥é‡ç¾å®Œæ•´æ“ä½œæ­¥é©Ÿï¼Œç›´æ¥ä½¿ç”¨ï¼Œæˆ–æ˜¯åŠ ä»¥ä¿®æ”¹\nè‘—é‡ Google Cloud Platformï¼Œç‰¹åˆ¥æ˜¯Google Compute Engine (GCE) èˆ‡Google Kubernetes Engine (GKE) å…©å¤§æœå‹™ã€‚é€™ä¹Ÿæ˜¯æˆ‘æœ€ç†Ÿæ‚‰çš„å¹³å°ï¼Œé †ä¾¿æ¨å»£ï¼Œä¸¦åˆ†äº«ä¸€äº›é›·é»ã€‚\nå¾ç¶­é‹çš„è§’åº¦é™¤éŒ¯ï¼Œåˆ†æå•é¡Œï¼Œæå‡ç©©å®šæ€§ã€‚\né å®šçš„ä¸»é¡Œå¦‚ä¸‹ï¼ˆå¯èƒ½æœƒä¾ç…§å¯¦éš›æ’°å¯«ç‹€æ³å¾®èª¿ï¼‰\nELK Stask on GCP (8) Self-host ELK stack on GCP Secure ELK Stask ç›£æ¸¬ Google Compute Engine ä¸Šæœå‹™çš„å„é …æ•¸æ“š ç›£æ¸¬ Google Kubernetes Engine çš„å„é …æ•¸æ“š æ˜¯å¦é¸æ“‡ ELK ä½œç‚ºè§£æ±ºæ–¹æ¡ˆ ä½¿ç”¨ logstash pipeline åšæ•¸æ“šå‰è™•ç† Elasticsearch æ—¥å¸¸ç¶­è­·ï¼šæ•¸æ“šæ¸…ç†ï¼Œæ•ˆèƒ½èª¿æ ¡ï¼Œæ°¸ä¹…å„²å­˜ Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka åŸºæœ¬ä½¿ç”¨ kafka operation scripts é›†ç¾¤å…§éƒ¨çš„ HA topology é›†ç¾¤å…§éƒ¨çš„ HA ç´°ç¯€ Prometheus Metrics Exporter å¾ˆé‡è¦ æ•ˆèƒ½èª¿æ ¡ åœ¨ GKE ä¸Šéƒ¨ç½² Redis HA (5) ä½¿ç”¨ helm éƒ¨ç½² redis-ha Redis HA with sentinel Redis sentinel topology Redis HA with HAproxy Redis HA Failure Recovery Prometheus Metrics Exporter Prometheus / Grafana (5) GKE ä¸Šè‡ªæ¶ Prometheus GKE ä¸Šè‡ªæ¶ Grafana scrape config \u0026amp; exporter Dive into Redis Exporter è¼¸å‡º kube-state çš„ç›£æ¸¬æ•¸æ“š Nginx Ingress (3) Deploy Nginx Ingress Controller Configure Nginx Ingress Cert-manager (3) Deploy cert-manager How cert-manager work Cert-manager complete workflow Kubernetes CRD \u0026amp; Operator-sdk (3) Introduction about custom resource Deployment \u0026amp; Usage Deployment \u0026amp; Usage æ–‡ç« ç™¼è¡¨æ–¼éµäººæŒ‘æˆ°é é¢ï¼ŒåŒæ™‚ç™¼å¸ƒèˆ‡æœ¬ç«™å‚™ä»½ã€‚æœ‰ä»»ä½•è¬¬èª¤ï¼Œé‚„ç…©è«‹å„æ–¹å¤§å¾·\u0026lt;3é€éåº•ä¸‹çš„è¯çµ¡æ–¹å¼è¯çµ¡æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\nFeatures\nstep-by-step guide for deployment: guarentee a running deployment on GCP basic configuration, usage, monitoring, networking on GKE debugging, stability analysis in an aspect of devop Topics\nELK stack(8) Deploy self-hosted ELK stack on GCE instance Secure ELK stack with SSL and role-based authentication Monitoring services on Kubernetes with ELK beats Monitoring services on GCE instances Logstash pipelines and debugging walk through Elasticsearch operations: house-cleaning, tuning, pernament storage Elasticsearch maitainence, trouble shooting Get-Started with Elastic Cloud SASS General operations on Kubernetes(4) Kubernetes Debug SOP Kubectl cheat sheet Secure services with SSL by cert-manager Speed up container updating with operator My operator example Deploy Kafka HA on Kubernetes(4) deploy kafka-ha on Kubernertes with helm in-cluster networking configuration for high availability basic app-side usage, performance tuning Operate Kafka: update config, upgrade version, migrate data Promethus / grafana(5) Deploy Prometheus / Grafana stack on GCE instance Monitoring services on Kubernetes with exporters Export Kubernetes metrics to Prometheus Export Redis-ha metrics to Prometheus Export Kafka metrics to Prometheus GCP networking(4) Firewall basic concept for private network with GCE instances \u0026amp; Kubernetes Load balancer for Kubernetes service \u0026amp; ingress DNS on GCP from Kube-dns to GCP DNS service GCP log management(3) Basic usage about GCP logging \u0026amp; GCP Error Report Stackdriver, metrics, alerts Logging on GKE from gcp-fluentd to stackdriver ","permalink":"https://chechia.net/posts/2019-09-09-ithome-ironman-challenge/","summary":"2019 ITé‚¦å¹«å¿™éµäººè³½","title":"2019 ITé‚¦å¹«å¿™éµäººè³½"},{"content":"å„ä½å¥½ï¼Œæˆ‘æ˜¯Che-Chia Changï¼Œå°ˆé•· DevOps \u0026amp; Kubernetes\nä»Šå¹´ä¸ä¿è­‰ä¸çˆ›å°¾çš„ 2021 éµäººæŒ‘æˆ°é é¢ ç¬¬ä¸€æ‰‹æ¶ˆæ¯ç™¼å¸ƒï¼Œå…è²»ç·šä¸Šè«®è©¢ï¼Œè«‹è¦‹ FB å¾€å¹´å›é¡§ 4 è¬é¤˜å­—çš„è¡€æ·š 30 æ—¥ - 2020 éµäººæŒ‘æˆ° å„ªç­‰ å›åˆ° 2021 å¹´ï¼Œæœ¬ç³»åˆ—æœƒå¯«å¾—å¾ˆéš¨èˆˆï¼Œè®€è€…æœ‰å¹«åŠ©ç‚ºç›®çš„æ’°å¯«ï¼Œ\nå¦‚æœæœ‰èˆˆè¶£çš„é¡Œç›®ï¼Œæˆ–æ˜¯å¥½å¥‡æƒ³å•å•é¡Œï¼Œæ­¡è¿åº•ä¸‹ç•™è¨€ï¼Œæˆ–åˆ°æˆ‘çš„ FB ç§è¨Šï¼Œæˆ‘éƒ½æœƒä¸€å°ä¸€å›å¾©ã€‚åŸºæ–¼ã€Œå–ä¹‹ç¤¾ç¾¤å›é¥‹ç¤¾ç¾¤ã€çš„ç²¾ç¥ï¼Œè«®è©¢èŠå¤©éƒ½æ˜¯æ°¸é å…è²»ã€‚\nåŸºæ–¼æ˜ç¢ºéœ€æ±‚ï¼Œè¨è«–è§£æ±ºæ–¹æ¡ˆ è·Ÿ Kubernetes æœ‰é—œ æä¾›æ‰‹æŠŠæ‰‹ SOP å–œæ­¡ä¹Ÿè«‹å¹«æˆ‘é»å€‹è®šï¼Œæˆ–æ˜¯ç•™è¨€è®“æˆ‘çŸ¥é“ï¼Œè®“æˆ‘æœ‰é»å‹•åŠ›ç¹¼çºŒå¯«ï¼Œå¤§å¹…é™ä½æˆ‘å·æ‡¶çˆ›å°¾çš„æ©Ÿç‡(XD)\né å®šçš„ä¸»é¡Œï¼ˆå¯èƒ½æœƒå¾®èª¿æˆ–å¤§æ”¹XDï¼‰\nå¥½æ–‡ç¿»è­¯åˆ†äº« Borg, Omega, Kubernetes - Google å®¹å™¨åŒ–é–‹ç™¼åå¹´ç¶“é©—ï¼ŒKubernetes çš„å‰æ—¥ä»Šç”Ÿ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - æˆ‘é€™é‚Šæœ‰ä¸€æ‰¹ä¾¿å®œçš„å¥½ VM æ‰“ä¸‰æŠ˜è³£ä½ ï¼ŒPreemptible / Spot Instance å…ˆå ç¯€é»å¯¦æˆ°åˆ†äº« å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼ŒåŸç†ç°¡ä»‹èˆ‡è¦æ ¼ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼Œé©ç”¨æ¡ˆä¾‹å¯¦æˆ°åˆ†æ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼Œä½¿ç”¨ç¯„ä¾‹ å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - Preemptible / Spot Instance å…ˆå ç¯€é»ï¼Œç¶“é©—åˆ†äº«ï¼Œé›·é» å…¬æœ‰é›²çœéŒ¢å¤§ä½œæˆ° - æˆ‘è·‘äº†ä¸€å€‹ botï¼Œ24 å°æ™‚ä¸Šç·šï¼Œ GCP ä¸€å¤©æ”¶ä½  4 å…ƒå°å¹£ å¤§å®¶éƒ½ä¾†ç”¨ Terraformï¼ŒInfrastructure as Code æ¼”è¬›å…¨æ–‡åˆ†äº« iThome Cloud Summit è¬›åˆ°æ™‚é–“è¶…éï¼Œä¸€å°æ±è¥¿æ²’è¬›ï¼Œæ‰€ä»¥ä¾†é€™é‚Šç™¼æ–‡ çœŸçš„å¥½ç”¨ï¼Œå¯¦æˆ°ç¶“é©—åˆ†äº« è§£ç­”ç²‰å°ˆç§è¨Šå•é¡Œèˆ‡è§€çœ¾ç™¼å• åˆ†æ•£å¼å·¥å…·å¯¦é©—å®¤ - Scalable Database on Kubernetes Thanos - Scalable HA Prometheus ç°¡ä»‹ éœ€æ±‚åˆ†æï¼ŒUnlimited Retention éµä¸€èˆ¬çš„éœ€æ±‚ ä¸€æ­¥æ­¥å¸¶ä½ æ¶ Scalable DB å¯¦é©—- Cockroach DB - è€ç”¨æ‰“ä¸æ­»åˆé«˜æ•ˆèƒ½çš„å°å¼·è³‡æ–™åº« å‰è¨€ï¼Œåˆ†æ•£å¼ç³»çµ±ä¸‹çš„å›°å¢ƒï¼Œè³‡æ–™åº«ç“¶é ¸ Cockroach DB åŸºæœ¬åŸç†ç°¡ä»‹ Cockroach DB Free Trial ç©èµ·ä¾† Cassandra - æ”¯æ’ç™¾è¬ç´šå¯«å…¥çš„åˆ†æ•£å¼è³‡æ–™åº« Cassandra ç°¡ä»‹ Cassandra ç´°éƒ¨åŸç†ï¼Œåˆ†æ•£å¼çš„è³‡æ–™åº«è¨­è¨ˆè¶…å¥½ç© Cassandra ç´°éƒ¨åŸç†ï¼ŒConsistency Hashing Cassandra ç´°éƒ¨åŸç†ï¼ŒData modeling Netflix case study - å·å­¸ Netflix èƒ½å­¸åˆ°å¹¾æˆåŠŸåŠ›å‘¢ æœ‰ä»»ä½•è¬¬èª¤ï¼Œé‚„ç…©è«‹å„æ–¹å¤§å¾·\u0026lt;3è¯çµ¡æˆ‘ï¼Œæ„Ÿæ¿€ä¸ç›¡ã€‚\n","permalink":"https://chechia.net/posts/2020-09-09-ithome-ironman-challenge/","summary":"2020 ITé‚¦å¹«å¿™éµäººè³½","title":"2020 ITé‚¦å¹«å¿™éµäººè³½"},{"content":"This post is about my learning steps for quantum-computing.\nFor a quick-start tutorial, check my workshop project throught the project link above.\nResources Courses\nCoursera\non MIT x pro\nQuantum Information Processing from UW Madison\nQuantum Computation by John Preskill\nIBM Q Experience\nhttps://github.com/Qiskit/openqasm\nhttps://github.com/Qiskit/qiskit-tutorials\nIBM Q Experience Day 1 Getting Started with Circuit Composer\nHello Quantum World circuit transformed two qubits, from $ \\vert0\\rangle $ to $ \\frac{\\vert00\\rangle + \\vert11\\rangle}{\\sqrt{2}} $\nQuestions\n[] Hadamard Gate [] Bell states [] Annotations ","permalink":"https://chechia.net/posts/2019-06-02-journey-to-quantum-computing/","summary":"\u003cp\u003eThis post is about my learning steps for quantum-computing.\u003c/p\u003e\n\u003cp\u003eFor a quick-start tutorial, check my workshop project throught the project link above.\u003c/p\u003e\n\u003ch1 id=\"resources\"\u003eResources\u003c/h1\u003e\n\u003cp\u003eCourses\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.coursera.org/learn/quantum-computing-algorithms\"\u003eCoursera\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://mitxpro.mit.edu/courses/course-v1:MITxPRO\u0026#43;QCx0\u0026#43;1T2019/about\"\u003eon MIT x pro\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://pages.cs.wisc.edu/~dieter/Courses/2010f-CS880/lectures.html\"\u003eQuantum Information Processing from UW Madison\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://www.theory.caltech.edu/people/preskill/ph229/\"\u003eQuantum Computation by John Preskill\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://quantum-computing.ibm.com\"\u003eIBM Q Experience\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Qiskit/openqasm\"\u003ehttps://github.com/Qiskit/openqasm\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Qiskit/qiskit-tutorials\"\u003ehttps://github.com/Qiskit/qiskit-tutorials\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"ibm-q-experience\"\u003eIBM Q Experience\u003c/h1\u003e\n\u003ch3 id=\"day-1\"\u003eDay 1\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://quantum-computing.ibm.com/support/guides/getting-started-with-circuit-composer\"\u003eGetting Started with Circuit Composer\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHello Quantum World circuit transformed two qubits, from $ \\vert0\\rangle $ to $ \\frac{\\vert00\\rangle + \\vert11\\rangle}{\\sqrt{2}} $\u003c/p\u003e","title":"Journey to Quantum Computing"},{"content":"Create GKE gcloud beta container --project \u0026quot;istio-playground-239810\u0026quot; clusters create \u0026quot;istio-playground\u0026quot; \\ --zone \u0026quot;asia-east1-b\u0026quot; \\ --username \u0026quot;admin\u0026quot; \\ --cluster-version \u0026quot;1.11.8-gke.6\u0026quot; \\ --machine-type \u0026quot;n1-standard-2\u0026quot; \\ --image-type \u0026quot;COS\u0026quot; \\ --disk-type \u0026quot;pd-standard\u0026quot; \\ --disk-size \u0026quot;100\u0026quot; \\ --preemptible \\ --num-nodes \u0026quot;1\u0026quot; \\ --enable-cloud-logging \\ --enable-cloud-monitoring \\ --no-enable-ip-alias \\ --addons HorizontalPodAutoscaling,HttpLoadBalancing,KubernetesDashboard,Istio \\ --istio-config auth=MTLS_PERMISSIVE \\ --no-enable-autoupgrade \\ --enable-autorepair Take a Peek $ kubectl get namespaces NAME STATUS AGE default Active 2m istio-system Active 1m kube-public Active 2m kube-system Active 2m $ kubectl get po -n istio-system NAME READY STATUS RESTARTS AGE istio-citadel-7f6f77cd7b-nxfbf 1/1 Running 0 3m istio-cleanup-secrets-h454m 0/1 Completed 0 3m istio-egressgateway-7c56db84cc-nlrwq 1/1 Running 0 3m istio-galley-6c747bdb4f-45jrp 1/1 Running 0 3m istio-ingressgateway-6ff68cf95d-tlkq4 1/1 Running 0 3m istio-pilot-8ff66f8c4-q9chz 2/2 Running 0 3m istio-policy-69b78b7d6-c8pld 2/2 Running 0 3m istio-sidecar-injector-558996c897-hr6q4 1/1 Running 0 3m istio-telemetry-f96459fb-5cbpg 2/2 Running 0 3m promsd-ff878d44b-hv8nh 2/2 Running 1 3m Deploy app kubectl label namespace default istio-injection=enabled Bookinfo Application\nkubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/bookinfo/platform/kube/bookinfo.yaml kubectl get pods kubectl get services Gateway\nkubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/bookinfo/networking/bookinfo-gateway.yaml kubectl get gateways kubectl get svc istio-ingressgateway -n istio-system Go to ingress public ip\nexport INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}') export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==\u0026quot;http2\u0026quot;)].port}') export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==\u0026quot;https\u0026quot;)].port}') curl -v ${INGRESS_HOST}:{$INGRESS_PORT}/productpage 404 Not Found Apply destination rules\nkubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/bookinfo/networking/destination-rule-all.yaml curl -v ${INGRESS_HOST}:{$INGRESS_PORT}/productpage Brief review kubectl get virtualservices kubectl get destinationrules kubectl get gateways Istio Tasks https://istio.io/docs/tasks/traffic-management/\n","permalink":"https://chechia.net/posts/2019-05-06-service-mesh-for-microservice-on-kubernetes/","summary":"åŸºæ–¼ Kubernetes å¹³å°ä¸Šçš„ Istio ï¼Œå¯¦éš›éƒ¨ç½²ï¼Œä¸¦ä¸€æ­¥ä¸€æ­¥æ“ä½œIstio çš„åŠŸèƒ½ã€‚","title":"Istio ä¸‰åˆ†é˜å°±å…¥å‘ ä½ˆç½²ç¯‡"},{"content":"Jenkins is one of the earliest open source antomation server and remains the most common option in use today. Over the years, Jenkins has evolved into a powerful and flexible framework with hundreds of plugins to support automation for any project.\nJenkins X, on the other hand, is a CI/CD platform (Jenkins Platform) for modern cloud applications on Kubernetes.\nHere we talk about some basic concepts about Jenkins X and provide a hand-to-hand guide to deploy jenkins-x on Kubernetes.\nArchitecture of Jenkins X Install Jenkins with jx Create a Pipeline with jx Develope with jx client For more information about jx itself, check Jenkins-X Github Repo\nArchitecture Check this beautiful diagram.\nhttps://jenkins-x.io/architecture/diagram/ Install Create GKE cluster \u0026amp; Get Credentials gcloud init gcloud components update CLUSTER_NAME=jenkins-server #CLUSTER_NAME=jenkins-serverless gcloud container clusters create ${CLUSTER_NAME} \\ --num-nodes 1 \\ --machine-type n1-standard-4 \\ --enable-autoscaling \\ --min-nodes 1 \\ --max-nodes 2 \\ --zone asia-east1-b \\ --preemptible # After cluster initialization, get credentials to access cluster with kubectl gcloud container clusters get-credentials ${CLUSTER_NAME} # Check cluster stats. kubectl get nodes Install jx on Local Machine [Jenkins X Release](https://github.com/jenkins-x/jx/releases](https://github.com/jenkins-x/jx/releases)\nJX_VERSION=v2.0.2 OS_ARCH=darwin-amd64 #OS_ARCH=linux-amd64 curl -L https://github.com/jenkins-x/jx/releases/download/\u0026quot;${JX_VERSION}\u0026quot;/jx-\u0026quot;${OS_ARCH}\u0026quot;.tar.gz | tar xzv sudo mv jx /usr/local/bin jx version NAME VERSION jx 2.0.2 Kubernetes cluster v1.11.7-gke.12 kubectl v1.11.9-dispatcher helm client v2.11.0+g2e55dbe helm server v2.11.0+g2e55dbe git git version 2.20.1 Operating System Mac OS X 10.14.4 build 18E226 (Option 1) Install Serverless Jenkins Pipeline DEFAULT_PASSWORD=mySecretPassWord123 jx install \\ --default-admin-password=${DEFAULT_PASSWORD} \\ --provider='gke' Options:\nEnter Github user name Enter Github personal api token for CI/CD Enable Github as Git pipeline server Select Jenkins installation type: Serverless Jenkins X Pipelines with Tekon Static Master Jenkins Pick default workload build pack Kubernetes Workloads: Automated CI+CD with GitOps Promotion Library Workloads: CI+Release but no CD Select the organization where you want to create the environment repository: chechiachang Your Kubernetes context is now set to the namespace: jx INFO[0231] To switch back to your original namespace use: jx namespace jx INFO[0231] Or to use this context/namespace in just one terminal use: jx shell INFO[0231] For help on switching contexts see: https://jenkins-x.io/developing/kube-context/ INFO[0231] To import existing projects into Jenkins: jx import INFO[0231] To create a new Spring Boot microservice: jx create spring -d web -d actuator INFO[0231] To create a new microservice from a quickstart: jx create quickstart (Option 2) Install Static Jenkins Server DEFAULT_PASSWORD=mySecretPassWord123 jx install \\ --default-admin-password=${DEFAULT_PASSWORD} \\ --provider='gke' Options:\nEnter Github user name Enter Github personal api token for CI/CD Enable Github as Git pipeline server Select Jenkins installation type: Serverless Jenkins X Pipelines with Tekon Static Master Jenkins Pick default workload build pack Kubernetes Workloads: Automated CI+CD with GitOps Promotion Library Workloads: CI+Release but no CD Select the organization where you want to create the environment repository: chechiachang INFO[0465]Your Kubernetes context is now set to the namespace: jx INFO[0465] To switch back to your original namespace use: jx namespace default INFO[0465] Or to use this context/namespace in just one terminal use: jx shell INFO[0465] For help on switching contexts see: https://jenkins-x.io/developing/kube-context/ INFO[0465] To import existing projects into Jenkins: jx import INFO[0465] To create a new Spring Boot microservice: jx create spring -d web -d actuator INFO[0465] To create a new microservice from a quickstart: jx create quickstart Access Static Jenkins Server through Domain with username and password Domain http://jenkins.jx.11.22.33.44.nip.io/\nUninstall jx uninstall # rm -rf ~/.jx Setup CI/CD Pipeline Create Quickstart Repository kubectl get pods --namespace jx --watch # cd workspace jx create quickstart Options:\nWhich organisation do you want to use? chechiachang Enter the new repository name: serverless-jenkins-quickstart select the quickstart you wish to create [Use arrows to move, type to filter] angular-io-quickstart aspnet-app dlang-http golang-http jenkins-cwp-quickstart jenkins-quickstart node-http\nINFO[0121] Watch pipeline activity via: jx get activity -f serverless-jenkins-quickstart -w INFO[0121] Browse the pipeline log via: jx get build logs chechiachang/serverless-jenkins-quickstart/master INFO[0121] Open the Jenkins console via jx console INFO[0121] You can list the pipelines via: jx get pipelines INFO[0121] Open the Jenkins console via jx console INFO[0121] You can list the pipelines via: jx get pipelines INFO[0121] When the pipeline is complete: jx get applications Check log of the first run jx logs pipeline Add Step to Pipeline Add a setup step for pullrequest\ncd serverless-jenkins-quickstart jx create step --pipeline pullrequest \\ --lifecycle setup \\ --mode replace \\ --sh \u0026quot;echo hello world\u0026quot; Validate pipeline step for each modification\njx step validate A build-pack pod started after git push. Watch pod status with kubectl.\nkubectl get pods --namespace jx --watch Check Build Status on Prow (Serverless) http://deck.jx.130.211.245.13.nip.io/ Login with username and password\nImport Existing Repository In source code repository:\nImport jx to remote jenkins-server. This will apply a Jenkinsfile to repository by default\njx import --url git@github.com:chechiachang/serverless-jenkins-quickstart.git Update jenkins-x.yml\njx create step git commit \u0026amp; push\nTrouble Shooting Failed to get jx resources\njx get pipelines Make sure your jx (or kubectl) context is with the correct GKE and namespace\nkc config set-context gke_my-project_asia-east1-b_jenkins \\ --namespace=jx Why not use helm chart? It\u0026rsquo;s readlly depend on what we need in CI/CD automation.\nJenkins Helm Chart create Jenkins master and slave cluster on Kubernetes utilizing the Jenkins Kubernetes plugin. Jenkin Platform with jx is Jenkins Platform native to Kubernetes. It comes with powerful cloud native components like Prow automation, Nexus, Docker Registry, Tekton Pipeline, \u0026hellip;\nCheck jenkins-x examples https://github.com/jenkins-x-buildpacks/jenkins-x-kubernetes/tree/master/packs\nClient jx get urls Name URL jenkins http://jenkins.jx.11.22.33.44.nip.io jenkins-x-chartmuseum http://chartmuseum.jx.11.22.33.44.nip.io jenkins-x-docker-registry http://docker-registry.jx.11.22.33.44.nip.io jenkins-x-monocular-api http://monocular.jx.11.22.33.44.nip.io jenkins-x-monocular-ui http://monocular.jx.11.22.33.44.nip.io nexus http://nexus.jx.11.22.33.44.nip.io Get Cluster Status jx diagnose Get Applications \u0026amp; Pipelines jx get applications jx get pipelines Get CI Activities \u0026amp; build log jx get activities jx get activities --filter='jenkins-x-on-kubernetes' jx get build log INFO[0003] view the log at: http://jenkins.jx.11.22.33.44.nip.io/job/chechiachang/job/jenkins-x-on-kubernetes/job/feature-add-test/3/console ... Trigger Build \u0026amp; Check Activity jx start pipeline jx start pipeline --filter='jenkins-x-on-kubernetes/feature-add-test' jx get activities --filter='jenkins-x-on-kubernetes' Create Pull Request jx create pullrequest ","permalink":"https://chechia.net/posts/2019-04-19-jenkins-x-on-kubernetes/","summary":"\u003cp\u003e\u003ca href=\"https://jenkins.io/\"\u003eJenkins\u003c/a\u003e is one of the earliest open source antomation server and remains the most common option in use today. Over the years, Jenkins has evolved into a powerful and flexible framework with hundreds of plugins to support automation for any project.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://jenkins-x.io/\"\u003eJenkins X\u003c/a\u003e, on the other hand, is a CI/CD platform (Jenkins Platform) for modern cloud applications on Kubernetes.\u003c/p\u003e\n\u003cp\u003eHere we talk about some basic concepts about Jenkins X and provide a hand-to-hand guide to deploy jenkins-x on Kubernetes.\u003c/p\u003e","title":"Jenkins X on Kubernetes"},{"content":"","permalink":"https://chechia.net/posts/2018-10-06-kubernetes-container-runtime-interface/","summary":"","title":"Kubernetes Container Runtime Interface"}]