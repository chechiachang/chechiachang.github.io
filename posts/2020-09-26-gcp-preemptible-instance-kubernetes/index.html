<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Gcp Preemptible Instance Kubernetes | Che-Chia Chang</title><meta name=keywords content="kubernetes,gcp,preemptible,spot-instance,鐵人賽2020"><meta name=description content="先占虛擬機與 Kubernetes
在 GCP 使用先占虛擬機，會需要面對先占虛擬機的額外限制

資料中心會 (可預期或不可預期地) 終止先占虛擬機
先占虛擬機不能自動重啟，而是會被資料中心終止後回收
GCP 不保證有足夠的先占虛擬機

節點的終止會造成額外的維運成本，例如

管理多個節點，容忍先占虛擬機的移除，自動補充新的先占虛擬機
管理多個應用複本，節點終止時，維護整體應用的可用性
將移除節點上的應用，重新排程到其他可用節點
動態維護應用複本的服務發現 (Service Discovery) 與服務端點 (Endpoints)

意思是應用關閉重啟後，換了一個新 IP，還要能持續存取應用。舊的 IP 要主動失效
配合應用的健康檢查 (Health Check) 與可用檢查 (Readiness Check)，再分配網路流量



這些需求，必須要有自動化的管理工具，是不可能人工管理的，想像你手上使用 100 個先占節點，平均每天會有 10% - 15% 的先占節點被資料中心回收，維運需要

補足被移除的 15 個節點
計算被移除的應用，補足移除的應用數量
移除失效的應用端點，補上新的應用端點
持續監控應用狀態
&mldr;

沒有自動化管理工具，看了心已累 (貓爪掩面)
我們使用 Kubernetes 協助維運自動化，在 GCP 上我們使用 GKE，除了上述提到的容器應用管理自動化外，GKE 還額外整合先占虛擬機的使用

啟用先占虛擬機的節點池 (node-pool)，設定節點池的自動拓展，自動補足先占節點的數量
GKE 自動維護先占虛擬機的 labels

關於 GKE 的先占虛擬機的完整細節，請見GCP 官方文件。這份文件底下也提供了 GCP 官方建議的先占虛擬機最佳實踐

架構設計需要假設，部分或是全部的先占虛擬機都不可用的情形
Pod 不一定有時間能優雅終止 (graceful shutdown)
同時使用隨選虛擬機與先占虛擬機，以維持先占虛擬機不可用時，服務依然可用
注意節點替換時的 IP 變更
避免使用有狀態的 Pod 在先占虛擬機上 (這點稍後的文章，我們會試圖超越)
使用 node taint 來協助排程到先占虛擬機，與非先占虛擬機

總之，由於有容器自動化管理，我們才能輕易的使用先占虛擬機。"><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-kubernetes/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-kubernetes/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYR8JCDGM9"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYR8JCDGM9")}</script><meta property="og:url" content="https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-kubernetes/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Gcp Preemptible Instance Kubernetes"><meta property="og:description" content="先占虛擬機與 Kubernetes 在 GCP 使用先占虛擬機，會需要面對先占虛擬機的額外限制
資料中心會 (可預期或不可預期地) 終止先占虛擬機 先占虛擬機不能自動重啟，而是會被資料中心終止後回收 GCP 不保證有足夠的先占虛擬機 節點的終止會造成額外的維運成本，例如
管理多個節點，容忍先占虛擬機的移除，自動補充新的先占虛擬機 管理多個應用複本，節點終止時，維護整體應用的可用性 將移除節點上的應用，重新排程到其他可用節點 動態維護應用複本的服務發現 (Service Discovery) 與服務端點 (Endpoints) 意思是應用關閉重啟後，換了一個新 IP，還要能持續存取應用。舊的 IP 要主動失效 配合應用的健康檢查 (Health Check) 與可用檢查 (Readiness Check)，再分配網路流量 這些需求，必須要有自動化的管理工具，是不可能人工管理的，想像你手上使用 100 個先占節點，平均每天會有 10% - 15% 的先占節點被資料中心回收，維運需要
補足被移除的 15 個節點 計算被移除的應用，補足移除的應用數量 移除失效的應用端點，補上新的應用端點 持續監控應用狀態 … 沒有自動化管理工具，看了心已累 (貓爪掩面)
我們使用 Kubernetes 協助維運自動化，在 GCP 上我們使用 GKE，除了上述提到的容器應用管理自動化外，GKE 還額外整合先占虛擬機的使用
啟用先占虛擬機的節點池 (node-pool)，設定節點池的自動拓展，自動補足先占節點的數量 GKE 自動維護先占虛擬機的 labels 關於 GKE 的先占虛擬機的完整細節，請見GCP 官方文件。這份文件底下也提供了 GCP 官方建議的先占虛擬機最佳實踐
架構設計需要假設，部分或是全部的先占虛擬機都不可用的情形 Pod 不一定有時間能優雅終止 (graceful shutdown) 同時使用隨選虛擬機與先占虛擬機，以維持先占虛擬機不可用時，服務依然可用 注意節點替換時的 IP 變更 避免使用有狀態的 Pod 在先占虛擬機上 (這點稍後的文章，我們會試圖超越) 使用 node taint 來協助排程到先占虛擬機，與非先占虛擬機 總之，由於有容器自動化管理，我們才能輕易的使用先占虛擬機。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-26T17:24:20+08:00"><meta property="article:modified_time" content="2020-09-26T17:24:20+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Gcp"><meta property="article:tag" content="Preemptible"><meta property="article:tag" content="Spot-Instance"><meta property="article:tag" content="鐵人賽2020"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Gcp Preemptible Instance Kubernetes"><meta name=twitter:description content="先占虛擬機與 Kubernetes
在 GCP 使用先占虛擬機，會需要面對先占虛擬機的額外限制

資料中心會 (可預期或不可預期地) 終止先占虛擬機
先占虛擬機不能自動重啟，而是會被資料中心終止後回收
GCP 不保證有足夠的先占虛擬機

節點的終止會造成額外的維運成本，例如

管理多個節點，容忍先占虛擬機的移除，自動補充新的先占虛擬機
管理多個應用複本，節點終止時，維護整體應用的可用性
將移除節點上的應用，重新排程到其他可用節點
動態維護應用複本的服務發現 (Service Discovery) 與服務端點 (Endpoints)

意思是應用關閉重啟後，換了一個新 IP，還要能持續存取應用。舊的 IP 要主動失效
配合應用的健康檢查 (Health Check) 與可用檢查 (Readiness Check)，再分配網路流量



這些需求，必須要有自動化的管理工具，是不可能人工管理的，想像你手上使用 100 個先占節點，平均每天會有 10% - 15% 的先占節點被資料中心回收，維運需要

補足被移除的 15 個節點
計算被移除的應用，補足移除的應用數量
移除失效的應用端點，補上新的應用端點
持續監控應用狀態
&mldr;

沒有自動化管理工具，看了心已累 (貓爪掩面)
我們使用 Kubernetes 協助維運自動化，在 GCP 上我們使用 GKE，除了上述提到的容器應用管理自動化外，GKE 還額外整合先占虛擬機的使用

啟用先占虛擬機的節點池 (node-pool)，設定節點池的自動拓展，自動補足先占節點的數量
GKE 自動維護先占虛擬機的 labels

關於 GKE 的先占虛擬機的完整細節，請見GCP 官方文件。這份文件底下也提供了 GCP 官方建議的先占虛擬機最佳實踐

架構設計需要假設，部分或是全部的先占虛擬機都不可用的情形
Pod 不一定有時間能優雅終止 (graceful shutdown)
同時使用隨選虛擬機與先占虛擬機，以維持先占虛擬機不可用時，服務依然可用
注意節點替換時的 IP 變更
避免使用有狀態的 Pod 在先占虛擬機上 (這點稍後的文章，我們會試圖超越)
使用 node taint 來協助排程到先占虛擬機，與非先占虛擬機

總之，由於有容器自動化管理，我們才能輕易的使用先占虛擬機。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Gcp Preemptible Instance Kubernetes","item":"https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-kubernetes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Gcp Preemptible Instance Kubernetes","name":"Gcp Preemptible Instance Kubernetes","description":"先占虛擬機與 Kubernetes 在 GCP 使用先占虛擬機，會需要面對先占虛擬機的額外限制\n資料中心會 (可預期或不可預期地) 終止先占虛擬機 先占虛擬機不能自動重啟，而是會被資料中心終止後回收 GCP 不保證有足夠的先占虛擬機 節點的終止會造成額外的維運成本，例如\n管理多個節點，容忍先占虛擬機的移除，自動補充新的先占虛擬機 管理多個應用複本，節點終止時，維護整體應用的可用性 將移除節點上的應用，重新排程到其他可用節點 動態維護應用複本的服務發現 (Service Discovery) 與服務端點 (Endpoints) 意思是應用關閉重啟後，換了一個新 IP，還要能持續存取應用。舊的 IP 要主動失效 配合應用的健康檢查 (Health Check) 與可用檢查 (Readiness Check)，再分配網路流量 這些需求，必須要有自動化的管理工具，是不可能人工管理的，想像你手上使用 100 個先占節點，平均每天會有 10% - 15% 的先占節點被資料中心回收，維運需要\n補足被移除的 15 個節點 計算被移除的應用，補足移除的應用數量 移除失效的應用端點，補上新的應用端點 持續監控應用狀態 \u0026hellip; 沒有自動化管理工具，看了心已累 (貓爪掩面)\n我們使用 Kubernetes 協助維運自動化，在 GCP 上我們使用 GKE，除了上述提到的容器應用管理自動化外，GKE 還額外整合先占虛擬機的使用\n啟用先占虛擬機的節點池 (node-pool)，設定節點池的自動拓展，自動補足先占節點的數量 GKE 自動維護先占虛擬機的 labels 關於 GKE 的先占虛擬機的完整細節，請見GCP 官方文件。這份文件底下也提供了 GCP 官方建議的先占虛擬機最佳實踐\n架構設計需要假設，部分或是全部的先占虛擬機都不可用的情形 Pod 不一定有時間能優雅終止 (graceful shutdown) 同時使用隨選虛擬機與先占虛擬機，以維持先占虛擬機不可用時，服務依然可用 注意節點替換時的 IP 變更 避免使用有狀態的 Pod 在先占虛擬機上 (這點稍後的文章，我們會試圖超越) 使用 node taint 來協助排程到先占虛擬機，與非先占虛擬機 總之，由於有容器自動化管理，我們才能輕易的使用先占虛擬機。\n","keywords":["kubernetes","gcp","preemptible","spot-instance","鐵人賽2020"],"articleBody":"先占虛擬機與 Kubernetes 在 GCP 使用先占虛擬機，會需要面對先占虛擬機的額外限制\n資料中心會 (可預期或不可預期地) 終止先占虛擬機 先占虛擬機不能自動重啟，而是會被資料中心終止後回收 GCP 不保證有足夠的先占虛擬機 節點的終止會造成額外的維運成本，例如\n管理多個節點，容忍先占虛擬機的移除，自動補充新的先占虛擬機 管理多個應用複本，節點終止時，維護整體應用的可用性 將移除節點上的應用，重新排程到其他可用節點 動態維護應用複本的服務發現 (Service Discovery) 與服務端點 (Endpoints) 意思是應用關閉重啟後，換了一個新 IP，還要能持續存取應用。舊的 IP 要主動失效 配合應用的健康檢查 (Health Check) 與可用檢查 (Readiness Check)，再分配網路流量 這些需求，必須要有自動化的管理工具，是不可能人工管理的，想像你手上使用 100 個先占節點，平均每天會有 10% - 15% 的先占節點被資料中心回收，維運需要\n補足被移除的 15 個節點 計算被移除的應用，補足移除的應用數量 移除失效的應用端點，補上新的應用端點 持續監控應用狀態 … 沒有自動化管理工具，看了心已累 (貓爪掩面)\n我們使用 Kubernetes 協助維運自動化，在 GCP 上我們使用 GKE，除了上述提到的容器應用管理自動化外，GKE 還額外整合先占虛擬機的使用\n啟用先占虛擬機的節點池 (node-pool)，設定節點池的自動拓展，自動補足先占節點的數量 GKE 自動維護先占虛擬機的 labels 關於 GKE 的先占虛擬機的完整細節，請見GCP 官方文件。這份文件底下也提供了 GCP 官方建議的先占虛擬機最佳實踐\n架構設計需要假設，部分或是全部的先占虛擬機都不可用的情形 Pod 不一定有時間能優雅終止 (graceful shutdown) 同時使用隨選虛擬機與先占虛擬機，以維持先占虛擬機不可用時，服務依然可用 注意節點替換時的 IP 變更 避免使用有狀態的 Pod 在先占虛擬機上 (這點稍後的文章，我們會試圖超越) 使用 node taint 來協助排程到先占虛擬機，與非先占虛擬機 總之，由於有容器自動化管理，我們才能輕易的使用先占虛擬機。\nGKE 然而，決定使用 GKE 後，就有許多關於成本的事情需要討論\n先看 GKE 的計費方式 pricing\n每個 GKE 集群管理費用 $0.1/hr = $72/hr 這個費用是固定收費，只要開一個集群，不論集群的節點數量。所以在節點多、算力大的集群裡，這個費用會被稀釋，但在節點少的集群裡比例會被放大。\n然後 GKE 還是會有一些自己的毛，俗話說有一好沒兩好，我們使用它的好處同時，也要注意許多眉眉角角。再來爬文件。如同最前面宣導，用產品就要乖乖把文件看完，不過這裡先針對與先占虛擬機相關的議題\nAllocatable Resource Regional Cluster Cluster autoscaler Allocatable Resource 在網路上看到這篇好文 GKE 上的可使用的資源 Allocatable Resource。啥意思呢？難道還有不能使用的資源嗎？\n沒錯，GKE 會保留一定的機器資源 (e.g. cpu, memory, disk)，來維持節點的管理元件，例如 container runtime (e.g. Docker)、kubelet、cAdvisor。\n也就是說，就算我們跟 GCP 購買了算力，有一個比例的資源我們是使用不到的。細節請見 理解 GKE 集群架構。這會影響我們單一節點的規格，我們也需要一並計算，能實際使用的資源 (allocatable resource)。\nAllocatable = Capacity - Reserved - Eviction Threshold\nCapacity，是機器上實際裝載的資源，例如 n1-standard-4 提供 4 cpu 15 Gb memory Reserved，公有雲代管集群，預保留的資源 Eviction Threshold：Kubernetes 設定的 kubelet 驅逐門檻 驅逐門檻 (Eviction threshold) Kubelet 會主動監測節點上的資源使用狀況，當節點發生資源不足的狀況時，kubelet 會主動終止某些 Pod 的運行，並回收節點的資源，來避免整個節點資源不足導致的系統不穩定。被終止的 Pod 可以再次排程到其他資源足夠的節點上。細節請見 官方文件 Scheduling and Eviction\n在 Kubernetes 上，我們可以進一步設定驅逐門檻，當節點的可用資源低於驅逐的門檻，kubelet 會觸發 Pod 驅逐機制\nGKE 上每個節點會額外保留 100 MiB 的記憶體，作為驅逐門檻，意思是當節點耗盡資源，導致剩餘記憶體低於 100 MiB 的時候，會直接觸發 GKE 的 Pod Eviction，終止並回收部分的 Pod。換句話說，這 100 MiB 是不能被使用的資源。細節請見官方文件\n集群保留資源精算 資源的定義，使用雲平台的一般費用大多來自此\ncpu memory storage 然後是這個表，注意保留的資源是累進級距\n255 MiB of memory for machines with less than 1 GB of memory 25% of the first 4GB of memory 20% of the next 4GB of memory (up to 8GB) 10% of the next 8GB of memory (up to 16GB) 6% of the next 112GB of memory (up to 128GB) 2% of any memory above 128GB\n值計上能夠用到的資源，底下 GCP 也整理好了，例如 n1-standard-4 實際使用的是 memory 12.3/15，cpu 3.92/4。\n在維持合理的使用率下，開啟大的機器，可以降低被保留的資源比例，依照筆者公司過去經驗，GKE 起跳就是 n1-standard-4 或是以上規格，如果低於這個規格，可調度的資源比例真的太低，應該重新考慮一下這個解決方案是否合乎成本。\n但究竟什麼規格的機器適合我們的需求，說實在完全要看執行的應用而定。\n","wordCount":"264","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2020-09-26T17:24:20+08:00","dateModified":"2020-09-26T17:24:20+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-kubernetes/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://chechia.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chechia.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Gcp Preemptible Instance Kubernetes</h1><div class=post-meta><span title='2020-09-26 17:24:20 +0800 CST'>September 26, 2020</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;264 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2020-09-26-gcp-preemptible-instance-kubernetes.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#先占虛擬機與-kubernetes>先占虛擬機與 Kubernetes</a></li><li><a href=#gke>GKE</a></li><li><a href=#allocatable-resource>Allocatable Resource</a></li><li><a href=#驅逐門檻-eviction-threshold>驅逐門檻 (Eviction threshold)</a></li><li><a href=#集群保留資源精算>集群保留資源精算</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h3 id=先占虛擬機與-kubernetes>先占虛擬機與 Kubernetes<a hidden class=anchor aria-hidden=true href=#先占虛擬機與-kubernetes>#</a></h3><p>在 GCP 使用先占虛擬機，會需要面對先占虛擬機的額外限制</p><ul><li>資料中心會 (可預期或不可預期地) 終止先占虛擬機</li><li>先占虛擬機不能自動重啟，而是會被資料中心終止後回收</li><li>GCP 不保證有足夠的先占虛擬機</li></ul><p>節點的終止會造成額外的維運成本，例如</p><ul><li>管理多個節點，容忍先占虛擬機的移除，自動補充新的先占虛擬機</li><li>管理多個應用複本，節點終止時，維護整體應用的可用性</li><li>將移除節點上的應用，重新排程到其他可用節點</li><li>動態維護應用複本的服務發現 (Service Discovery) 與服務端點 (Endpoints)<ul><li>意思是應用關閉重啟後，換了一個新 IP，還要能持續存取應用。舊的 IP 要主動失效</li><li>配合應用的健康檢查 (Health Check) 與可用檢查 (Readiness Check)，再分配網路流量</li></ul></li></ul><p>這些需求，必須要有自動化的管理工具，是不可能人工管理的，想像你手上使用 100 個先占節點，平均每天會有 10% - 15% 的先占節點被資料中心回收，維運需要</p><ul><li>補足被移除的 15 個節點</li><li>計算被移除的應用，補足移除的應用數量</li><li>移除失效的應用端點，補上新的應用端點</li><li>持續監控應用狀態</li><li>&mldr;</li></ul><p>沒有自動化管理工具，看了心已累 (貓爪掩面)</p><p>我們使用 Kubernetes 協助維運自動化，在 GCP 上我們使用 GKE，除了上述提到的容器應用管理自動化外，GKE 還額外整合先占虛擬機的使用</p><ul><li>啟用先占虛擬機的節點池 (node-pool)，設定節點池的自動拓展，自動補足先占節點的數量</li><li>GKE 自動維護先占虛擬機的 labels</li></ul><p>關於 GKE 的先占虛擬機的完整細節，請見<a href=https://cloud.google.com/kubernetes-engine/docs/how-to/preemptible-vms>GCP 官方文件</a>。這份文件底下也提供了 GCP 官方建議的先占虛擬機最佳實踐</p><ul><li>架構設計需要假設，部分或是全部的先占虛擬機都不可用的情形</li><li>Pod 不一定有時間能優雅終止 (graceful shutdown)</li><li>同時使用隨選虛擬機與先占虛擬機，以維持先占虛擬機不可用時，服務依然可用</li><li>注意節點替換時的 IP 變更</li><li>避免使用有狀態的 Pod 在先占虛擬機上 (這點稍後的文章，我們會試圖超越)</li><li>使用 node taint 來協助排程到先占虛擬機，與非先占虛擬機</li></ul><p>總之，由於有容器自動化管理，我們才能輕易的使用先占虛擬機。</p><h3 id=gke>GKE<a hidden class=anchor aria-hidden=true href=#gke>#</a></h3><p>然而，決定使用 GKE 後，就有許多關於成本的事情需要討論</p><p>先看 <a href=https://cloud.google.com/kubernetes-engine/pricing>GKE 的計費方式 pricing</a></p><ul><li>每個 GKE 集群管理費用 $0.1/hr = $72/hr</li></ul><p>這個費用是固定收費，只要開一個集群，不論集群的節點數量。所以在節點多、算力大的集群裡，這個費用會被稀釋，但在節點少的集群裡比例會被放大。</p><p>然後 GKE 還是會有一些自己的毛，俗話說有一好沒兩好，我們使用它的好處同時，也要注意許多眉眉角角。再來爬<a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-architecture>文件</a>。如同最前面宣導，用產品就要乖乖把文件看完，不過這裡先針對與先占虛擬機相關的議題</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-architecture#memory_cpu>Allocatable Resource</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/regional-clusters>Regional Cluster</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler>Cluster autoscaler</a></li></ul><h3 id=allocatable-resource>Allocatable Resource<a hidden class=anchor aria-hidden=true href=#allocatable-resource>#</a></h3><p>在網路上看到這篇好文 <a href=https://learnk8s.io/allocatable-resources>GKE 上的可使用的資源 Allocatable Resource</a>。啥意思呢？難道還有不能使用的資源嗎？</p><p>沒錯，GKE 會保留一定的機器資源 (e.g. cpu, memory, disk)，來維持節點的管理元件，例如 container runtime (e.g. Docker)、kubelet、cAdvisor。</p><p>也就是說，就算我們跟 GCP 購買了算力，有一個比例的資源我們是使用不到的。細節請見 <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-architecture#memory_cpu>理解 GKE 集群架構</a>。這會影響我們單一節點的規格，我們也需要一並計算，能實際使用的資源 (allocatable resource)。</p><p>Allocatable = Capacity - Reserved - Eviction Threshold</p><ul><li>Capacity，是機器上實際裝載的資源，例如 n1-standard-4 提供 4 cpu 15 Gb memory</li><li>Reserved，公有雲代管集群，預保留的資源</li><li><a href=https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#eviction-thresholds>Eviction Threshold</a>：Kubernetes 設定的 kubelet 驅逐門檻</li></ul><h3 id=驅逐門檻-eviction-threshold>驅逐門檻 (Eviction threshold)<a hidden class=anchor aria-hidden=true href=#驅逐門檻-eviction-threshold>#</a></h3><p>Kubelet 會主動監測節點上的資源使用狀況，當節點發生資源不足的狀況時，kubelet 會主動終止某些 Pod 的運行，並回收節點的資源，來避免整個節點資源不足導致的系統不穩定。被終止的 Pod 可以再次排程到其他資源足夠的節點上。細節請見 <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/eviction-policy/>官方文件 Scheduling and Eviction</a></p><p>在 Kubernetes 上，我們可以進一步設定驅逐門檻，當節點的可用資源低於驅逐的門檻，kubelet 會觸發 Pod 驅逐機制</p><p>GKE 上每個節點會額外保留 100 MiB 的記憶體，作為驅逐門檻，意思是當節點耗盡資源，導致剩餘記憶體低於 100 MiB 的時候，會直接觸發 GKE 的 Pod Eviction，終止並回收部分的 Pod。換句話說，這 100 MiB 是不能被使用的資源。細節請見<a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-architecture#eviction_threshold>官方文件</a></p><h3 id=集群保留資源精算>集群保留資源精算<a hidden class=anchor aria-hidden=true href=#集群保留資源精算>#</a></h3><p>資源的定義，使用雲平台的一般費用大多來自此</p><ul><li>cpu</li><li>memory</li><li>storage</li></ul><p>然後是這個表，注意保留的資源是累進級距</p><p>255 MiB of memory for machines with less than 1 GB of memory
25% of the first 4GB of memory
20% of the next 4GB of memory (up to 8GB)
10% of the next 8GB of memory (up to 16GB)
6% of the next 112GB of memory (up to 128GB)
2% of any memory above 128GB</p><p>值計上能夠用到的資源，底下 GCP 也整理好了，例如 n1-standard-4 實際使用的是 memory 12.3/15，cpu 3.92/4。</p><p>在維持合理的使用率下，開啟大的機器，可以降低被保留的資源比例，依照筆者公司過去經驗，GKE 起跳就是 n1-standard-4 或是以上規格，如果低於這個規格，可調度的資源比例真的太低，應該重新考慮一下這個解決方案是否合乎成本。</p><p>但究竟什麼規格的機器適合我們的需求，說實在完全要看執行的應用而定。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/kubernetes/>Kubernetes</a></li><li><a href=https://chechia.net/tags/gcp/>Gcp</a></li><li><a href=https://chechia.net/tags/preemptible/>Preemptible</a></li><li><a href=https://chechia.net/tags/spot-instance/>Spot-Instance</a></li><li><a href=https://chechia.net/tags/%E9%90%B5%E4%BA%BA%E8%B3%BD2020/>鐵人賽2020</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2020-10-02-terraform-infrastructure-as-code-repository-example/><span class=title>« Prev</span><br><span>Terraform Infrastructure as Code: Example repository</span>
</a><a class=next href=https://chechia.net/posts/2020-09-26-gcp-preemptible-instance-introduction/><span class=title>Next »</span><br><span>Gcp Preemptible Instance Introduction</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on x" href="https://x.com/intent/tweet/?text=Gcp%20Preemptible%20Instance%20Kubernetes&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f&amp;hashtags=kubernetes%2cgcp%2cpreemptible%2cspot-instance%2c%e9%90%b5%e4%ba%ba%e8%b3%bd2020"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f&amp;title=Gcp%20Preemptible%20Instance%20Kubernetes&amp;summary=Gcp%20Preemptible%20Instance%20Kubernetes&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f&title=Gcp%20Preemptible%20Instance%20Kubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on whatsapp" href="https://api.whatsapp.com/send?text=Gcp%20Preemptible%20Instance%20Kubernetes%20-%20https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on telegram" href="https://telegram.me/share/url?text=Gcp%20Preemptible%20Instance%20Kubernetes&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Gcp Preemptible Instance Kubernetes on ycombinator" href="https://news.ycombinator.com/submitlink?t=Gcp%20Preemptible%20Instance%20Kubernetes&u=https%3a%2f%2fchechia.net%2fposts%2f2020-09-26-gcp-preemptible-instance-kubernetes%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>