<!DOCTYPE html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: 2024年10月18日 --><html lang="zh-Hant" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Hugo Blox Builder 5.9.7" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.f6689966c0a10712f95f034011917db0.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  






<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYR8JCDGM9"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'G-QYR8JCDGM9', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>




<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NSBJFRS');
</script>





















  
  
  






  <meta name="author" content="張哲嘉" />





  

<meta name="description" content="2020 It邦幫忙鐵人賽 系列文章
Self-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP 對我的文章有興趣，歡迎到我的網站上 https://chechia." />



  <link rel="alternate" hreflang="en" href="https://chechia.net/en/post/2019-09-15-secure-elk-stack/" />

<link rel="alternate" hreflang="zh-Hant" href="https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/" />
<link rel="canonical" href="https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/" />



  <link rel="manifest" href="/zh-hant/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png" />

<meta name="theme-color" content="#1565c0" />










  
  






<meta property="twitter:card" content="summary" />

  <meta property="twitter:site" content="@chechiachang" />
  <meta property="twitter:creator" content="@chechiachang" />
<meta property="twitter:image" content="https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" />



  

<meta property="og:type" content="article" />
<meta property="og:site_name" content="Che-Chia Chang" />
<meta property="og:url" content="https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/" />
<meta property="og:title" content="Secure Elk Stack | Che-Chia Chang" />
<meta property="og:description" content="2020 It邦幫忙鐵人賽 系列文章
Self-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP 對我的文章有興趣，歡迎到我的網站上 https://chechia." /><meta property="og:image" content="https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="zh-Hant" />

  
    <meta
      property="article:published_time"
      content="2019-09-15T23:00:33&#43;08:00"
    />
  
  
    <meta property="article:modified_time" content="2023-09-11T22:33:54&#43;08:00">
  






    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/"
  },
  "headline": "Secure Elk Stack",
  
  "datePublished": "2019-09-15T23:00:33+08:00",
  "dateModified": "2023-09-11T22:33:54+08:00",
  
  "author": {
    "@type": "Person",
    "name": "張哲嘉"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "chechia-net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "2020 It邦幫忙鐵人賽 系列文章\nSelf-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP 對我的文章有興趣，歡迎到我的網站上 https://chechia."
}
</script>

  

  




  
  
  

  
  

  


  
  <title>Secure Elk Stack | Che-Chia Chang</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="251492a4ac45b0e56225488343f29cc8" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>搜尋</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="關閉"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜尋..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜尋...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header header--fixed">
  
  
  
  
  












<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/zh-hant/">Che-Chia Chang</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切換導航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/zh-hant/">Che-Chia Chang</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#talks"><span>演講</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#posts"><span>發文</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#projects"><span>專案</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://www.instagram.com/c.c.leather/" target="_blank" rel="noopener"><span>皮件</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://www.instagram.com/dive.with.cat.coach/" target="_blank" rel="noopener"><span>水肺</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5" target="_blank" rel="noopener"><span>微軟MVP</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/chechiachang" data-toggle="tooltip" data-placement="bottom" title="查看我的Github" target="_blank" rel="noopener" aria-label="查看我的Github">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.facebook.com/engineer.from.scratch" data-toggle="tooltip" data-placement="bottom" title="追蹤我的Facebook粉絲專頁" target="_blank" rel="noopener" aria-label="追蹤我的Facebook粉絲專頁">
                <i class="fab fa-facebook" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="搜尋"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="顯示選項">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>明亮</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>暗黑</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>自動</span>
            </a>
          </div>
        </li>
        

        
        
        <li class="nav-item dropdown i18n-dropdown">
          <a href="#" class="nav-link " data-toggle="dropdown"
             aria-haspopup="true" aria-label="語言">
            <i class="fas fa-globe mr-1" aria-hidden="true"></i></a>
          <div class="dropdown-menu">
            <div class="dropdown-item dropdown-item-active">
              <span>中文 (繁體)</span>
            </div>
            
            <a class="dropdown-item" href="https://chechia.net/en/post/2019-09-15-secure-elk-stack/">
              <span>English</span>
            </a>
            
          </div>
        </li>
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  













  

  
  
  
<div class="article-container pt-3">
  <h1>Secure Elk Stack</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
          最近更新於
      
    
    9月 11, 2023
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    8 閱讀時間（分鐘）
  </span>
  

  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/zh-hant/category/kubernetes/">kubernetes</a>, <a href="/zh-hant/category/elasticsearch/">elasticsearch</a></span>
  

</div>

    





  
</div>



  <div class="article-container">

    <div class="article-style">
      <p><a href="https://ithelp.ithome.com.tw/2020ironman" target="_blank" rel="noopener">2020 It邦幫忙鐵人賽</a> 系列文章</p>
<ul>
<li><a href="https://chechia.net/zh-hant/post/2019-09-15-self-host-elk-stack-on-gcp/">Self-host ELK stack on GCP</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/">Secure ELK Stask</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-18-monitoring-gce-with-elk/">監測 Google Compute Engine 上服務的各項數據</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-19-monitoring-gke-with-elk/">監測 Google Kubernetes Engine 的各項數據</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-18-elastic-or-not-elastic/">是否選擇 ELK 作為解決方案</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-21-logstash-on-gke/">使用 logstash pipeline 做數據前處理</a></li>
<li>Elasticsearch 日常維護：數據清理，效能調校，永久儲存</li>
<li>Debug ELK stack on GCP</li>
</ul>
<p>對我的文章有興趣，歡迎到我的網站上 <a href="https://chechia.net" target="_blank" rel="noopener">https://chechia.net</a> 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。</p>
<p>&ndash;</p>
<p>上篇<a href="https://chechia.net/zh-hant/post/2019-09-15-self-host-elk-stack-on-gcp/">Self-host ELK stack on GCP</a> 介紹了，elk stack 基本的安裝，安裝完獲得一個只支援 http (裸奔)的 elk stack，沒有 https 在公開網路上使用是非常危險的。這篇要來介紹如何做安全性設定。</p>
<p><a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.3/elasticsearch-security.html" target="_blank" rel="noopener">官方的文件在這裡</a>，碎念一下，除非對 ELK 的功能有一定了解，不然這份真的不是很友善。建議從官方文件底下的<a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.3/security-getting-started.html" target="_blank" rel="noopener">Tutorial: Getting started with security</a> 開始，過程比較不會這麼血尿。</p>
<p>總之為了啟用 authentication &amp; https，這篇要做的事情：</p>
<ul>
<li>enable x-pack &amp; activate basic license</li>
<li>Generate self-signed ca, server certificate, client certificate</li>
<li>Configure Elasticsearch, Kibana, &amp; other components to
<ul>
<li>use server certificate when act as server</li>
<li>use client certificate when connect to an ELK server</li>
</ul>
</li>
</ul>
<hr>
<h1 id="啟用-x-pack">啟用 X-pack</h1>
<p>Elasticsearch 的安全性模組由 x-pack extension 提供，在 <a href="https://www.elastic.co/what-is/open-x-pack" target="_blank" rel="noopener">6.3.0 之後的版本</a>，安裝 elasticsearch 的過程中就預設安裝 x-pack。</p>
<p>附上<a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.3/get-started-enable-security.html" target="_blank" rel="noopener">啟用的官方文件</a></p>
<p>然而，由於舊版的 x-pack 是付費內容，目前的 elasticsearch 安裝完後，elasticsearch.yml 設定預設不啟用 x-pack，也就是說沒看到這篇官方文件的話，很容易就獲得沒有任何 security 功能的 ELK。</p>
<p>雖然目前已經可以使用免費的 basic license 使用 security 功能，還是希望官方可以 default 啟用 security。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo vim /etc/elasticsearch/elasticsearch.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">xpack.security.enabled: true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">xpack.license.self_generated.type: basic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">discovery.type: single-node
</span></span></code></pre></div><p>我們這邊啟用 xpack.security，同時將 self-generated license 生出來，我們這邊只使用基本的 basic subscription。若希望啟用更多功能，可以看<a href="https://www.elastic.co/cn/subscriptions" target="_blank" rel="noopener">官方subcription 方案介紹</a></p>
<p>另外，如果不同時設定為 single-node 的話，預設會尋找其他elasticsearch node 來組成 cluster，而我們就必須要在所有 node 上啟用 security，這篇只帶大家做一個 single node cluster，簡化步驟。</p>
<p>重啟 elasticsearch ，檢查 log，看啟動時有沒有載入 x-pack</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">elasticsearch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">log</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">49</span><span class="p">,</span><span class="mi">467</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">NodeEnvironment</span>    <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">using</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">data</span> <span class="n">paths</span><span class="p">,</span> <span class="n">mounts</span> <span class="p">[[</span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">disks</span><span class="o">/</span><span class="n">elk</span> <span class="p">(</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span><span class="p">)]],</span> <span class="n">net</span> <span class="n">usable_space</span> <span class="p">[</span><span class="mf">423.6</span><span class="n">gb</span><span class="p">],</span> <span class="n">net</span> <span class="n">total_space</span> <span class="p">[</span><span class="mf">491.1</span><span class="n">gb</span><span class="p">],</span> <span class="n">types</span> <span class="p">[</span><span class="n">ext4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">49</span><span class="p">,</span><span class="mi">474</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">NodeEnvironment</span>    <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">heap</span> <span class="n">size</span> <span class="p">[</span><span class="mf">3.9</span><span class="n">gb</span><span class="p">],</span> <span class="n">compressed</span> <span class="n">ordinary</span> <span class="n">object</span> <span class="n">pointers</span> <span class="p">[</span><span class="bp">true</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">858</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">Node</span>               <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">node</span> <span class="n">name</span> <span class="p">[</span><span class="n">elk</span><span class="p">],</span> <span class="n">node</span> <span class="n">ID</span> <span class="p">[</span><span class="n">pC22j9D4R6uiCM7oTc1Fiw</span><span class="p">],</span> <span class="n">cluster</span> <span class="n">name</span> <span class="p">[</span><span class="n">elasticsearch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">866</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">Node</span>               <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">version</span><span class="p">[</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="n">pid</span><span class="p">[</span><span class="mi">17189</span><span class="p">],</span> <span class="n">build</span><span class="p">[</span><span class="n">default</span><span class="o">/</span><span class="n">deb</span><span class="o">/</span><span class="mi">4749</span><span class="n">ba6</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">19</span><span class="n">T20</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">25.651794</span><span class="n">Z</span><span class="p">],</span> <span class="ne">OS</span><span class="p">[</span><span class="n">Linux</span><span class="o">/</span><span class="mf">4.15</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">1040</span><span class="o">-</span><span class="n">gcp</span><span class="o">/</span><span class="n">amd64</span><span class="p">],</span> <span class="n">JVM</span><span class="p">[</span><span class="n">Oracle</span> <span class="n">Corporation</span><span class="o">/</span><span class="n">OpenJDK</span> <span class="mi">64</span><span class="o">-</span><span class="n">Bit</span> <span class="n">Server</span> <span class="n">VM</span><span class="o">/</span><span class="mf">12.0</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="mf">12.0</span><span class="o">.</span><span class="mi">2</span><span class="o">+</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">878</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">Node</span>               <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">JVM</span> <span class="n">home</span> <span class="p">[</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">jdk</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">108</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">PluginsService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">loaded</span> <span class="n">module</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">ccr</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">109</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">PluginsService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">loaded</span> <span class="n">module</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">core</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">111</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">PluginsService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">loaded</span> <span class="n">module</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">logstash</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">113</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">PluginsService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">loaded</span> <span class="n">module</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">voting</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">node</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">114</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">PluginsService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">loaded</span> <span class="n">module</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">watcher</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">115</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">PluginsService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">no</span> <span class="n">plugins</span> <span class="n">loaded</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">07</span><span class="p">,</span><span class="mi">964</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">FileRolesStore</span><span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">parsed</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">roles</span> <span class="n">from</span> <span class="n">file</span> <span class="p">[</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">roles</span><span class="o">.</span><span class="n">yml</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="mi">369</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">CppLogMessageHandler</span><span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="p">[</span><span class="n">controller</span><span class="o">/</span><span class="mi">17314</span><span class="p">]</span> <span class="p">[</span><span class="n">Main</span><span class="o">.</span><span class="n">cc</span><span class="err">@</span><span class="mi">110</span><span class="p">]</span> <span class="n">controller</span> <span class="p">(</span><span class="mi">64</span> <span class="n">bit</span><span class="p">):</span> <span class="n">Version</span> <span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">Build</span> <span class="mi">1</span><span class="n">d93901e09ef43</span><span class="p">)</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2019</span> <span class="n">Elasticsearch</span> <span class="n">BV</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="mi">776</span><span class="p">][</span><span class="n">DEBUG</span><span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">ActionModule</span>       <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">Using</span> <span class="n">REST</span> <span class="n">wrapper</span> <span class="n">from</span> <span class="n">plugin</span> <span class="n">org</span><span class="o">.</span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">Security</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="mi">396</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">DiscoveryModule</span>    <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">using</span> <span class="n">discovery</span> <span class="n">type</span> <span class="p">[</span><span class="n">single</span><span class="o">-</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">seed</span> <span class="n">hosts</span> <span class="n">providers</span> <span class="p">[</span><span class="n">settings</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="mi">222</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">Node</span>               <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">initialized</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="mi">224</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">Node</span>               <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">starting</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="mi">821</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">TransportService</span>   <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">publish_address</span> <span class="p">{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">:</span><span class="mi">9300</span><span class="p">},</span> <span class="n">bound_addresses</span> <span class="p">{[::]:</span><span class="mi">9300</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="mi">872</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">Coordinator</span>      <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">cluster</span> <span class="n">UUID</span> <span class="p">[</span><span class="mi">1</span><span class="n">CB6_Lt</span><span class="o">-</span><span class="n">TUWEmRoN9SE49w</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">17</span><span class="p">,</span><span class="mi">088</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">MasterService</span>    <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">elected</span><span class="o">-</span><span class="n">as</span><span class="o">-</span><span class="n">master</span> <span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="n">nodes</span> <span class="n">joined</span><span class="p">)[{</span><span class="n">elk</span><span class="p">}{</span><span class="n">pC22j9D4R6uiCM7oTc1Fiw</span><span class="p">}{</span><span class="n">Os</span><span class="o">-</span><span class="mi">2</span><span class="n">FBjgSTOd1G_I3QYwVQ</span><span class="p">}{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">}{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">:</span><span class="mi">9300</span><span class="p">}{</span><span class="n">dim</span><span class="p">}{</span><span class="n">ml</span><span class="o">.</span><span class="n">machine_memory</span><span class="o">=</span><span class="mi">7836028928</span><span class="p">,</span> <span class="n">xpack</span><span class="o">.</span><span class="n">installed</span><span class="o">=</span><span class="bp">true</span><span class="p">,</span> <span class="n">ml</span><span class="o">.</span><span class="n">max_open_jobs</span><span class="o">=</span><span class="mi">20</span><span class="p">}</span> <span class="n">elect</span> <span class="n">leader</span><span class="p">,</span> <span class="n">_BECOME_MASTER_TASK_</span><span class="p">,</span> <span class="n">_FINISH_ELECTION_</span><span class="p">],</span> <span class="n">term</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="mi">921</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="n">master</span> <span class="n">node</span> <span class="n">changed</span> <span class="p">{</span><span class="n">previous</span> <span class="p">[],</span> <span class="n">current</span> <span class="p">[{</span><span class="n">elk</span><span class="p">}{</span><span class="n">pC22j9D4R6uiCM7oTc1Fiw</span><span class="p">}{</span><span class="n">Os</span><span class="o">-</span><span class="mi">2</span><span class="n">FBjgSTOd1G_I3QYwVQ</span><span class="p">}{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">}{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">:</span><span class="mi">9300</span><span class="p">}{</span><span class="n">dim</span><span class="p">}{</span><span class="n">ml</span><span class="o">.</span><span class="n">machine_memory</span><span class="o">=</span><span class="mi">7836028928</span><span class="p">,</span> <span class="n">xpack</span><span class="o">.</span><span class="n">installed</span><span class="o">=</span><span class="bp">true</span><span class="p">,</span> <span class="n">ml</span><span class="o">.</span><span class="n">max_open_jobs</span><span class="o">=</span><span class="mi">20</span><span class="p">}]}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">17</span><span class="p">,</span><span class="mi">819</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">ClusterApplierService</span><span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">master</span> <span class="n">node</span> <span class="n">changed</span> <span class="p">{</span><span class="n">previous</span> <span class="p">[],</span> <span class="n">current</span> <span class="p">[{</span><span class="n">elk</span><span class="p">}{</span><span class="n">pC22j9D4R6uiCM7oTc1Fiw</span><span class="p">}{</span><span class="n">Os</span><span class="o">-</span><span class="mi">2</span><span class="n">FBjgSTOd1G_I3QYwVQ</span><span class="p">}{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">}{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">:</span><span class="mi">9300</span><span class="p">}{</span><span class="n">dim</span><span class="p">}{</span><span class="n">ml</span><span class="o">.</span><span class="n">machine_memory</span><span class="o">=</span><span class="mi">7836028928</span><span class="p">,</span> <span class="n">xpack</span><span class="o">.</span><span class="n">installed</span><span class="o">=</span><span class="bp">true</span><span class="p">,</span> <span class="n">ml</span><span class="o">.</span><span class="n">max_open_jobs</span><span class="o">=</span><span class="mi">20</span><span class="p">}]},</span> <span class="n">term</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="mi">921</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="n">Publication</span><span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">921</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">17</span><span class="p">,</span><span class="mi">974</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">AbstractHttpServerTransport</span><span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">publish_address</span> <span class="p">{</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">0.10</span><span class="p">:</span><span class="mi">9200</span><span class="p">},</span> <span class="n">bound_addresses</span> <span class="p">{[::]:</span><span class="mi">9200</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">17</span><span class="p">,</span><span class="mi">975</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">Node</span>               <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">started</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span><span class="mi">455</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">ClusterSettings</span>  <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">updating</span> <span class="p">[</span><span class="n">xpack</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">enabled</span><span class="p">]</span> <span class="n">from</span> <span class="p">[</span><span class="bp">false</span><span class="p">]</span> <span class="n">to</span> <span class="p">[</span><span class="bp">true</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="mi">555</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">LicenseService</span>     <span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">license</span> <span class="p">[</span><span class="o">************************************</span><span class="p">]</span> <span class="n">mode</span> <span class="p">[</span><span class="n">basic</span><span class="p">]</span> <span class="o">-</span> <span class="n">valid</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span><span class="n">T07</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="mi">557</span><span class="p">][</span><span class="n">INFO</span> <span class="p">][</span><span class="n">o</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">SecurityStatusChangeListener</span><span class="p">]</span> <span class="p">[</span><span class="n">elk</span><span class="p">]</span> <span class="n">Active</span> <span class="n">license</span> <span class="n">is</span> <span class="n">now</span> <span class="p">[</span><span class="n">BASIC</span><span class="p">];</span> <span class="n">Security</span> <span class="n">is</span> <span class="n">enabled</span>
</span></span></code></pre></div><h1 id="enable-user-authentication">Enable user authentication</h1>
<p>啟用 security 之前，我們直接連入 Kibana http://10.140.0.10:5601 ，不用任何使用者登入，便可以完整使用 Kibana 功能（包含 admin 管理介面）。</p>
<p>啟用 security 後，便需要使用帳號密碼登入。在這邊先用工具把使用者密碼產生出來。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 互動式
</span></span><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 自動產生
</span></span><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto
</span></span></code></pre></div><p>密碼生出來後，就把帳號密碼收好，等等會用到。之後初次登入也是使用這些密碼。</p>
<h1 id="configure-passwords-on-client-side">Configure passwords on client-side</h1>
<p>由於已經啟用 authentication，其他 ELK 元件 (Kibana, logstash, filebeat, apm-server,&hellip;) 連入 Elasticsearch 也都會需要各自的帳號密碼驗證。</p>
<p>以 Kibana 為例，可以直接在 kibana.yml 中直接設定帳號密碼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo vim /etc/kibana/kibana.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">elasticsearch.hosts: [&#34;http://localhost:9200&#34;]
</span></span><span class="line"><span class="cl">xpack.security.enabled: true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">elasticsearch.username: &#34;kibana&#34;
</span></span><span class="line"><span class="cl">elasticsearch.password: &#34;***********&#34;
</span></span></code></pre></div><p>當然，這邊就是明碼的，看了不太安全。</p>
<p>或是使用 keystore 把 built-in user 的密碼加密，存在 kibana 的 keystore 裡面，重啟 kibana 時便會載入。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/usr/share/kibana/bin/kibana-keystore create
</span></span><span class="line"><span class="cl">/usr/share/kibana/bin/kibana-keystore add elasticsearch.username
</span></span><span class="line"><span class="cl">/usr/share/kibana/bin/kibana-keystore add elasticsearch.password
</span></span></code></pre></div><p>如果有啟用 Filebeat 功能，beat 元件連入 elasticsearch 一樣需要設定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/usr/share/apm-server/bin/filebeat keystore create
</span></span><span class="line"><span class="cl">/usr/share/apm-server/bin/filebeat add elasticsearch.username
</span></span><span class="line"><span class="cl">/usr/share/apm-server/bin/filebeat add elasticsearch.password
</span></span></code></pre></div><p>如果有啟用 application performance monitoring(APM) 功能，apm-server 元件連入 elasticsearch 一樣需要設定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/usr/share/apm-server/bin/apm-server keystore create
</span></span><span class="line"><span class="cl">/usr/share/apm-server/bin/apm-server add elasticsearch.username
</span></span><span class="line"><span class="cl">/usr/share/apm-server/bin/apm-server add elasticsearch.password
</span></span></code></pre></div><hr>
<h1 id="encrypting-communications">Encrypting Communications</h1>
<p>上面加了 username/password authentication，但如果沒 https/tls 基本上還是裸奔。接下來要處理連線加密。</p>
<p><a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.3/encrypting-internode-communications.html" target="_blank" rel="noopener">官方 tutorial</a></p>
<p>一堆官方文件，我們先跳過XD</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.3/elasticsearch-security.html" target="_blank" rel="noopener">elasticsearch security</a></li>
<li><a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.3/ssl-tls.html" target="_blank" rel="noopener">elastic stack ssl tls</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/configuring-tls.html#configuring-tls" target="_blank" rel="noopener">elasticsearch configuring tls</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/certutil.html" target="_blank" rel="noopener">certutil</a></li>
</ul>
<h1 id="分析一下需求跟規格">分析一下需求跟規格</h1>
<p>我們需要為每一個 node 生一組 node certificate，使用 node certificate 產生 client certificates 提供給其他 client，連入時會驗證 client 是否為 authenticated user。</p>
<p>針對目前這個 single-node ELK stack，我們可能有幾種選擇</p>
<ul>
<li>簽署一個 localhost，當然這個只能在 localhost 上的客戶端元件使用，別的 node 無法用這個連入</li>
<li>簽署一個 public DNS elk.chechiachang.com，可以在公開網路上使用，別人也可以使用這個DNS嘗試連入</li>
<li>簽署一個私有網域的 DNS，例如在 GCP 上可以使用<a href="https://cloud.google.com/compute/docs/internal-dns?hl=zh-tw" target="_blank" rel="noopener">內部dns服務</a>
<ul>
<li>長這樣 elk.asia-east1-b.c.chechiachang.internal</li>
<li>[INSTANCE_NAME].[ZONE].c.[PROJECT_ID].internal</li>
</ul>
</li>
<li>有需要也可以一份 server certificate 中簽署複數個 site</li>
</ul>
<p>我們這邊選擇使用內部 dns，elk.asia-east1-b-c-chechaichang.internal，讓這個 single-node elk 只能透過內部網路存取。</p>
<ul>
<li>elasticsearch: elk.asia-east1-b.c.chechaichang.internal:9200</li>
<li>kibana: elk.asia-east1-b.c.chechaichang.internal:5601</li>
<li>外部要連近來 kibana，我們使用 vpn 服務連進私有網路</li>
</ul>
<p>如果想使用外部 dns，讓 elk stack 在公開網路可以使用，ex. elk.chechiachang.com，可以</p>
<ul>
<li>GCP 的 load balancer掛進來，用 GCP 的 certificate manager 自動管理 certificate</li>
<li>或是在 node 上開一個 nginx server，再把 certificate 用 certbot 生出來</li>
</ul>
<h1 id="generate-certificates">Generate certificates</h1>
<p>先把 X.509 digital certificate 的 certificate authority(CA) 生出來。我們可以設定密碼保護這個檔案</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA generated with Elastic tool</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">certutil</span> <span class="n">ca</span> \
</span></span><span class="line"><span class="cl">  <span class="o">-</span><span class="n">out</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">p12</span>
</span></span></code></pre></div><p>生出來是 PKCS#12 格式的 keystore，包含：</p>
<ul>
<li>CA 的 public certificate</li>
<li>CA 的基本資訊</li>
<li>簽署其他 node certificates 使用的私鑰(private key)</li>
</ul>
<p>用 openssl 工具看一下內容，如果有密碼這邊要用密碼解鎖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ openssl pkcs12 -in /etc/elasticsearch/config/elastic-stack-ca.p12 -info -nokeys
</span></span></code></pre></div><p>附帶說明，X.509 有多種檔案格式</p>
<ul>
<li>.pem</li>
<li>.cer, .crt, .der</li>
<li>.p12</li>
<li>.p7b, .p7c</li>
<li>&hellip;</li>
</ul>
<p>另外檔案格式可以有其他用途，也就是說裡面裝的不一定是 X.509 憑證。裡面的內容也不同。</p>
<p>ELK 設定的過程中，由於不是所有的 ELK component 都支援使用 .p12 檔案，我們在設定過程中會互相專換，或是混用多種檔案格式。</p>
<h1 id="generate-certificate">Generate certificate</h1>
<p>&laquo;&laquo;&laquo;&lt; HEAD</p>
<p>我們用 elastic-stack-ca.p12 這組 keystore裡面的 CA 與 private key，為 elk.asia-east1-b.c.chechiachang.internal 簽一個 p12 keystore，裡面有</p>
<ul>
<li>node certificate</li>
<li>node key</li>
<li>CA certificate</li>
</ul>
<p>這邊只產生一組 server certificate 給 single-node cluster 的 node-1</p>
<p>=======</p>
<p>我們用 elastic-stack-ca.p12 這組 keystore裡面的 CA 與 private key，為 elk.asia-east1-b.c.chechiachang.internal 簽一個 p12 keystore，裡面有</p>
<ul>
<li>node certificate</li>
<li>node key</li>
<li>CA certificate</li>
</ul>
<p>這邊只產生一組 server certificate 給 single-node cluster 的 node-1</p>
<p>如果 cluster 中有多個 elasticsearch，為每個 node 產生 certificate 時都要使用同樣 CA 來簽署，讓 server 信任這組 CA。</p>
<p>使用 elasticsearch-certutil 簡化簽署過程，從產生 CA ，到使用 CA 簽署 certificate。另外，再產生 certificate 中使用 Subject Alternative Name(SAN)，並輸入 ip 與 dns。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># certificate for site: private dns with Elastic CA
</span></span><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-certutil cert \
</span></span><span class="line"><span class="cl">  --ca /etc/elasticsearch/config/elastic-stack-ca.p12 \
</span></span><span class="line"><span class="cl">  --name elk.asia-east1-b.c.chechaichang.internal \
</span></span><span class="line"><span class="cl">  --dns elk.asia-east1-b.c.chechaichang.internal \
</span></span><span class="line"><span class="cl">  --ip 10.140.0.10 \
</span></span><span class="line"><span class="cl">  -out /etc/elasticsearch/config/node-1.p12
</span></span></code></pre></div><p>用 openssl 看一下內容，如果有密碼這邊要用密碼解鎖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -info -nokeys
</span></span></code></pre></div><p>server 用這個 certificate ，啟用 ssl。</p>
<p>client 使用這個 certificate 產生出來的 client.cer 與 client.key 與 server 連線，server 才接受客戶端是安全的。</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>25f5ab795b9e698333a36fde7ecf23a8ba9d4595
記得把所有權還給 elasticsearch 的使用者，避免 permission denied</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Change owner to fix read permission
</span></span><span class="line"><span class="cl">chown -R elasticsearch:elasticsearch /etc/elasticsearch/config
</span></span></code></pre></div><p>有密碼記得也要用 keystore 把密碼加密後喂給 elasticsearch</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
</span></span><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
</span></span></code></pre></div><p>關於 X.509 Certifcate 之後有空我們來聊一下</p>
<h1 id="更新-elasticsearch-設定">更新 elasticsearch 設定</h1>
<p>Certificates 都生完了，接下來更改 elasticsearch 的參數，在 transport layer 啟用 ssl。啟用 security 後，在 transport layer 啟動 ssl 是必須的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo vim /etc/elasticsearch/elasticsearch.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">xpack.security.enabled: true
</span></span><span class="line"><span class="cl">xpack.security.transport.ssl.enabled: true
</span></span><span class="line"><span class="cl"># use certificate. full will verify dns and ip
</span></span><span class="line"><span class="cl">xpack.security.transport.ssl.verification_mode: certificate
</span></span><span class="line"><span class="cl">xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/config/node-1.p12
</span></span><span class="line"><span class="cl">xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/config/node-1.p12
</span></span></code></pre></div><p>啟用 security 與 transport layer 的 ssl，然後指定 keystore路徑，讓 server 執行 client authentication
由於這筆 p12 帶有 CA certificate 作為 trusted certificate entry，所以也可以順便當作 trustore，讓 client 信任這個 CA</p>
<p>security 這邊提供了 server side (elasticsearch) 在檢查客戶端連線時的檢查模式(vertification mode)，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html#ssl-tls-settings" target="_blank" rel="noopener">文件有說明</a>，可以設定</p>
<ul>
<li>certificate: 檢查 certificate 加密是否有效</li>
<li>full: 簽 node certificate 時可以指定 ip dns，啟用會檢查來源 node ip dns 是否也正確</li>
</ul>
<p>(Optional) HTTP layer 啟動 ssl</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vim /etc/elasticsearch/elasticsearch.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">xpack.security.http.ssl.enabled: true
</span></span><span class="line"><span class="cl">xpack.security.http.ssl.keystore.path: /etc/elasticsearch/config/node-1.p12
</span></span><span class="line"><span class="cl">xpack.security.http.ssl.truststore.path: /etc/elasticsearch/config/node-1.p12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
</span></span><span class="line"><span class="cl">/usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.http.ssl.truststore.secure_password
</span></span></code></pre></div><p>重啟 elasticsearch，看一下 log</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">elasticsearch</span>
</span></span><span class="line"><span class="cl"><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">log</span>
</span></span></code></pre></div><p>然後你就發現，原來 kibana 連入 的 http 連線，不斷被 server 這端拒絕。所以以下要來設定 kibana</p>
<hr>
<h1 id="kibana">Kibana</h1>
<ul>
<li><a href="https://www.elastic.co/guide/en/kibana/7.3/using-kibana-with-security.html" target="_blank" rel="noopener">using kibana with security</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.3/configuring-tls.html" target="_blank" rel="noopener">kibana configuring tls</a></li>
</ul>
<p>使用剛剛簽的 server certificate，從裡面 parse 出 client-ca.cer，還有 client.cer 與 client.key</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir -p /etc/kibana/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ openssl pkcs12 --help
</span></span><span class="line"><span class="cl">Usage: pkcs12 [options]
</span></span><span class="line"><span class="cl">Valid options are:
</span></span><span class="line"><span class="cl"> -chain              Add certificate chain
</span></span><span class="line"><span class="cl"> -nokeys             Don&#39;t output private keys
</span></span><span class="line"><span class="cl"> -nocerts            Don&#39;t output certificates
</span></span><span class="line"><span class="cl"> -clcerts            Only output client certificates
</span></span><span class="line"><span class="cl"> -cacerts            Only output CA certificates
</span></span><span class="line"><span class="cl"> -info               Print info about PKCS#12 structure
</span></span><span class="line"><span class="cl"> -nodes              Don&#39;t encrypt private keys
</span></span><span class="line"><span class="cl"> -in infile          Input filename
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># no certs, no descript
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -nocerts -nodes &gt; /etc/kibana/config/client.key
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -clcerts -nokeys &gt; /etc/kibana/config/client.cer
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -cacerts -nokeys -chain &gt; /etc/kibana/config/client-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo chown -R kibana:kibana /etc/kibana/config/
</span></span></code></pre></div><p>更改 kibana 連入 elasticsearch 的連線設定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo vim /etc/kigana/kibana.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">elasticsearch.hosts: [&#34;https://elk.asia-east1-b.c.chechaichang.internal:9200&#34;]
</span></span><span class="line"><span class="cl">xpack.security.enabled: true
</span></span><span class="line"><span class="cl">elasticsearch.ssl.certificate: /etc/kibana/config/client.cer
</span></span><span class="line"><span class="cl">elasticsearch.ssl.key: /etc/kibana/config/client.key
</span></span><span class="line"><span class="cl">elasticsearch.ssl.certificateAuthorities: [ &#34;/etc/kibana/config/client-ca.cer&#34; ]
</span></span><span class="line"><span class="cl">elasticsearch.ssl.verificationMode: full
</span></span></code></pre></div><ul>
<li>指定 ssl.certificate, ssl.key 做連線 elasticsearch server 時的 user authentication</li>
<li>由於我們是 self-signed CA，所以需要讓客戶端信任這個我們自簽的 CA</li>
</ul>
<p>注意這邊 elasticsearch.hosts 我們已經從 http://localhost 換成 https 的內部 dns，原有的 localhost 已經無法使用（如果 elasicsearch 有 enforce https 的話）</p>
<p>重啟 Kibana，看一下 log</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo systemctl restart kibana
</span></span><span class="line"><span class="cl">journalctl -fu kibana
</span></span></code></pre></div><p>如果沒有一直噴 ssl certificate error 的話，恭喜你成功了</p>
<p>然而，除了 kibana 以外，我們還有其他的 client 需要連入 elasticsearch</p>
<ul>
<li>把上述步驟在 apm-server, filebeat, 其他的 beat 上也設定</li>
<li>如果在 k8s 上，要把 cer, key 等檔案用 volume 掛進去
&laquo;&laquo;&laquo;&lt; HEAD</li>
</ul>
<p>Kibana 本身也有 server 的功能，讓其他 client 連入。例如讓 filebeat 自動將 document tempalte 匯入 kibana，我們也需要設定</p>
<ul>
<li>kibana server certificate</li>
<li>filebeat client to kibana server</li>
</ul>
<p>=======</p>
<p>Kibana 本身也有 server 的功能，讓其他 client 連入。例如讓 filebeat 自動將 document tempalte 匯入 kibana，我們也需要設定</p>
<ul>
<li>kibana server certificate</li>
<li>filebeat client to kibana server</li>
</ul>
<p>就是他們彼此互打，都要有 ca, key, cert</p>
<h3 id="但基本上的設定都一樣下面可以不用看下去了xd">但基本上的設定都一樣，下面可以不用看下去了XD</h3>
<p>如果有用到再查文件就好，這邊直接小結</p>
<ul>
<li>設定 security 前要先想號自己的需求，如何連入，安全性設定到哪邊</li>
<li>使用 utility 自簽 CA，然後產生 server certificate</li>
<li>使用 server certificate 再 parse 出 ca-certificate, client cers, key</li>
</ul>
<hr>
<h1 id="kibana-作為-server">kibana 作為 server</h1>
<p>工作路徑可能是這樣： app(apm-client library) -&gt; apm-server -&gt; kibana -&gt; elasticsearch</p>
<ul>
<li>kibana 連入 elasticsearch時， kibana 是 client 吃 elasticsearch 的憑證</li>
<li>apm-server 連入 kibana時，kibana 是 server，apm-server 吃 kibana 的憑證</li>
</ul>
<p>首先更改 kibana 設定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo vim /etc/kibana/kibana.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server.ssl.enabled: true
</span></span><span class="line"><span class="cl">server.ssl.certificate: /etc/kibana/config/client.cer
</span></span><span class="line"><span class="cl">server.ssl.key: /etc/kibana/config/client.key
</span></span></code></pre></div><p>重啟 kibana</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">journalctl -fu kibana
</span></span></code></pre></div><h1 id="apm-server">Apm-server</h1>
<p><a href="https://www.elastic.co/guide/en/apm/server/7.3/securing-apm-server.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/apm/server/7.3/securing-apm-server.html</a></p>
<p>應用端的 apm-client (ex. apm-python-client)，連入 apm-server</p>
<ul>
<li>在 http 的狀況下，雖然有使用 secret-token，但還是裸奔</li>
<li>在 https 的狀況下，要把 certificates，然後餵給應用端的client library</li>
</ul>
<p>更改 apm-server 的設定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo vim /etc/apm-server/apm-server.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">host: &#34;0.0.0.0:8200&#34;
</span></span><span class="line"><span class="cl">  secret_token: &lt;設定一組夠安全的 token&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  rum:
</span></span><span class="line"><span class="cl">    enabled: true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kibana:
</span></span><span class="line"><span class="cl">  protocol: &#34;https&#34;
</span></span><span class="line"><span class="cl">  ssl.enabled: true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">output.kibana:
</span></span><span class="line"><span class="cl">  enable: false # can only have 1 output
</span></span><span class="line"><span class="cl">output.elasticsearch:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">monitoring.elasticsearch:
</span></span><span class="line"><span class="cl">  protocol: &#34;https&#34;
</span></span><span class="line"><span class="cl">  username: &#34;elastic&#34;
</span></span><span class="line"><span class="cl">  password: &#34;*******************&#34;
</span></span><span class="line"><span class="cl">  hosts: [&#34;elk.asia-east1-b.c.checahichang.internal:9200&#34;]
</span></span><span class="line"><span class="cl">  ssl.enabled: true
</span></span><span class="line"><span class="cl">  ssl.verification_mode: full
</span></span><span class="line"><span class="cl">  ssl.certificate_authorities: [&#34;/etc/apm-server/config/client-ca.cer&#34;]
</span></span><span class="line"><span class="cl">  ssl.certificate: &#34;/etc/apm-server/config/client.cer&#34;
</span></span><span class="line"><span class="cl">  ssl.key: &#34;/etc/apm-server/config/client.key&#34;
</span></span></code></pre></div><p>重啟 apm-server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">systemctl restart apm-server
</span></span><span class="line"><span class="cl">journalctl -fu apm-server
</span></span></code></pre></div><h1 id="apm-library">APM library</h1>
<p>應用端的設定就需要依據 library 的實做設定，例如 flask-apmagent-python</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ELASTIC_APM_SERVER_CERT=/etc/elk/certificates/client.cer
</span></span></code></pre></div><p><a href="https://www.elastic.co/guide/en/apm/agent/python/current/configuration.html#config-server-cert" target="_blank" rel="noopener">apm agent python config server cert</a></p>
<h1 id="filebeat">filebeat</h1>
<p>記得我們在 node 上有安裝 Self-monitoring filebeat，elasticsearch 改成 ssl 這邊當然也連不盡去了，再做同樣操作</p>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.3/filebeat-reference-yml.html</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo apt-get install filebeat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p /etc/filebeat/config
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -nocerts -nodes &gt; /etc/filebeat/config/client.key
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -clcerts -nokeys &gt; /etc/filebeat/config/client.cer
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -cacerts -nokeys -chain &gt; /etc/filebeat/config/client-ca.cer
</span></span></code></pre></div><p>Restart filebeat</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">systemctl restart filebeat
</span></span><span class="line"><span class="cl">journalctl -fu filebeat
</span></span></code></pre></div><hr>
<h1 id="如果你的應用在-kubernetes-上">如果你的應用在 kubernetes 上</h1>
<p>可以使用下面方法拿到 client.cer ，然後用 secret 塞進 k8s，在用 volume from secrets，掛給監測應用的 filebeat</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p /etc/beats/config
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -nocerts -nodes &gt; /etc/beats/config/client.key
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -clcerts -nokeys &gt; /etc/beats/config/client.cer
</span></span><span class="line"><span class="cl">openssl pkcs12 -in /etc/elasticsearch/config/node-1.p12 -cacerts -nokeys -chain &gt; /etc/beats/config/client-ca.cer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gcloud compute scp elk:/etc/beats/config/* .
</span></span><span class="line"><span class="cl"> client-ca.cer
</span></span><span class="line"><span class="cl"> client.cer
</span></span><span class="line"><span class="cl"> client.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl -n elk create secret generic elk-client-certificates \
</span></span><span class="line"><span class="cl">  --from-file=client-ca.cer=client-ca.cer \
</span></span><span class="line"><span class="cl">  --from-file=client.cer=client.cer \
</span></span><span class="line"><span class="cl">  --from-file=client.key=client.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl apply -f elk/gke/filebeat/
</span></span></code></pre></div>
    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2019/">鐵人賽2019</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/tls/">tls</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/elasticsearch/">elasticsearch</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/devops/">devops</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/logstash/">logstash</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-15-secure-elk-stack%2F&amp;text=Secure&#43;Elk&#43;Stack" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-15-secure-elk-stack%2F&amp;t=Secure&#43;Elk&#43;Stack" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=Secure%20Elk%20Stack&amp;body=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-15-secure-elk-stack%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-15-secure-elk-stack%2F&amp;title=Secure&#43;Elk&#43;Stack" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=Secure&#43;Elk&#43;Stack%20https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-15-secure-elk-stack%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-15-secure-elk-stack%2F&amp;title=Secure&#43;Elk&#43;Stack" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      <a href="https://chechia.net/"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/e56eaaf62e2112055827c197b938d620?s=200" alt="張哲嘉"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://chechia.net/">張哲嘉</a></h5>
      <h6 class="card-subtitle">Site Reliability Engineer</h6>
      <p class="card-text">我的研究領域包括網站可靠性工程、DevOps、Container和Kubernetes。</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/zh-hant/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/chechiachang" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/chechiachang" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.facebook.com/engineer.from.scratch" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/che-chia-chang-92194a4a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2024 Me. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      由<a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a>支持發布——免費<a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">開源</a>網站，為創作者賦能。
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.938a3a7554cd9f6602290411f64d2617.js"></script>




  

  
  

  













  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  

















<script id="page-data" type="application/json">{"use_headroom":true}</script>


  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>









  
  


<script src="/zh-hant/js/wowchemy.min.c1296fcfda1f6e2549c8cd4fe453ac58.js"></script>







  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">引用</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> 複製
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> 下載
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.9137013a66774049159934c29c3f0205.js" type="module"></script>


















</body>
</html>
