<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Blockchain Bep3 Atomic Swap | Che-Chia Chang</title><meta name=keywords content="blockchain,bep3,binance,ethereum,erc-20"><meta name=description content="BEP3 Atomic Swap
Binance 在 BEP3: HTLC and Atomic Peg 提到，BEP 即將在 binance chain 上支援原生的 Hash Timer Locked Transfer (HTLT) ，這使跨鏈的原子性交換 (atomic swap) 變得可行，透過 HTLC 在兩邊的鏈上鎖住 (peg) tokens，然後只有在執行交換的時候，透過 hash 交換，一次執行雙邊的交易。
關於 Atomic Swap 網路有非常多的訊息，有興趣的話可以看這篇

交易只有在雙邊完成後才完成，完成之前不能動用交換的資產
在任何階段失效都可以完全 fallback，並進行 refund
交易的認證是去中心化的

這邊有個但書，Ethereum 上是透過 smart contract 實現，但 Binance chain 上還是靠 Binance 認證 XD



Binance 在 BEP3 中支援 HTLC，我們這邊主要的資訊來源是 binance.org 的官方說明文件，這邊針對文章進行驗證，並且補足文件缺漏的部分，提醒過程中可能會踩到的雷。
跨鍊(Cross Chain) 交易
在部署 asset / token 的時候，我們會選擇合適的鏈作為發布資產並運行 block chain app。常用的應用鏈如 ethereum 與 binance chain 等等。不同的主鏈上有各自的優缺點，例如使用 ethereum ，可以與許多 token 與應用互動，也是最多人使用的應用主鏈。而在 binance 鏈上執行，則能夠快速的發生 transactions，並且可以與 binance 上的資產與交易所互動。"><meta name=author content="chechiachang"><link rel=canonical href=https://chechia.net/posts/2019-10-22-blockchain-bep3-atomic-swap/><meta name=google-site-verification content="G-QYR8JCDGM9"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://chechia.net/favicon/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://chechia.net/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chechia.net/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://chechia.net/favicon/favicon-32x32.png><link rel=mask-icon href=https://chechia.net/favicon/favicon-32x32.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chechia.net/posts/2019-10-22-blockchain-bep3-atomic-swap/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYR8JCDGM9"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYR8JCDGM9")}</script><meta property="og:url" content="https://chechia.net/posts/2019-10-22-blockchain-bep3-atomic-swap/"><meta property="og:site_name" content="Che-Chia Chang"><meta property="og:title" content="Blockchain Bep3 Atomic Swap"><meta property="og:description" content="BEP3 Atomic Swap Binance 在 BEP3: HTLC and Atomic Peg 提到，BEP 即將在 binance chain 上支援原生的 Hash Timer Locked Transfer (HTLT) ，這使跨鏈的原子性交換 (atomic swap) 變得可行，透過 HTLC 在兩邊的鏈上鎖住 (peg) tokens，然後只有在執行交換的時候，透過 hash 交換，一次執行雙邊的交易。
關於 Atomic Swap 網路有非常多的訊息，有興趣的話可以看這篇
交易只有在雙邊完成後才完成，完成之前不能動用交換的資產 在任何階段失效都可以完全 fallback，並進行 refund 交易的認證是去中心化的 這邊有個但書，Ethereum 上是透過 smart contract 實現，但 Binance chain 上還是靠 Binance 認證 XD Binance 在 BEP3 中支援 HTLC，我們這邊主要的資訊來源是 binance.org 的官方說明文件，這邊針對文章進行驗證，並且補足文件缺漏的部分，提醒過程中可能會踩到的雷。
跨鍊(Cross Chain) 交易 在部署 asset / token 的時候，我們會選擇合適的鏈作為發布資產並運行 block chain app。常用的應用鏈如 ethereum 與 binance chain 等等。不同的主鏈上有各自的優缺點，例如使用 ethereum ，可以與許多 token 與應用互動，也是最多人使用的應用主鏈。而在 binance 鏈上執行，則能夠快速的發生 transactions，並且可以與 binance 上的資產與交易所互動。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-22T10:35:20+08:00"><meta property="article:modified_time" content="2019-10-22T10:35:20+08:00"><meta property="article:tag" content="Blockchain"><meta property="article:tag" content="Bep3"><meta property="article:tag" content="Binance"><meta property="article:tag" content="Ethereum"><meta property="article:tag" content="Erc-20"><meta property="og:image" content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Blockchain Bep3 Atomic Swap"><meta name=twitter:description content="BEP3 Atomic Swap
Binance 在 BEP3: HTLC and Atomic Peg 提到，BEP 即將在 binance chain 上支援原生的 Hash Timer Locked Transfer (HTLT) ，這使跨鏈的原子性交換 (atomic swap) 變得可行，透過 HTLC 在兩邊的鏈上鎖住 (peg) tokens，然後只有在執行交換的時候，透過 hash 交換，一次執行雙邊的交易。
關於 Atomic Swap 網路有非常多的訊息，有興趣的話可以看這篇

交易只有在雙邊完成後才完成，完成之前不能動用交換的資產
在任何階段失效都可以完全 fallback，並進行 refund
交易的認證是去中心化的

這邊有個但書，Ethereum 上是透過 smart contract 實現，但 Binance chain 上還是靠 Binance 認證 XD



Binance 在 BEP3 中支援 HTLC，我們這邊主要的資訊來源是 binance.org 的官方說明文件，這邊針對文章進行驗證，並且補足文件缺漏的部分，提醒過程中可能會踩到的雷。
跨鍊(Cross Chain) 交易
在部署 asset / token 的時候，我們會選擇合適的鏈作為發布資產並運行 block chain app。常用的應用鏈如 ethereum 與 binance chain 等等。不同的主鏈上有各自的優缺點，例如使用 ethereum ，可以與許多 token 與應用互動，也是最多人使用的應用主鏈。而在 binance 鏈上執行，則能夠快速的發生 transactions，並且可以與 binance 上的資產與交易所互動。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chechia.net/posts/"},{"@type":"ListItem","position":2,"name":"Blockchain Bep3 Atomic Swap","item":"https://chechia.net/posts/2019-10-22-blockchain-bep3-atomic-swap/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Blockchain Bep3 Atomic Swap","name":"Blockchain Bep3 Atomic Swap","description":"BEP3 Atomic Swap Binance 在 BEP3: HTLC and Atomic Peg 提到，BEP 即將在 binance chain 上支援原生的 Hash Timer Locked Transfer (HTLT) ，這使跨鏈的原子性交換 (atomic swap) 變得可行，透過 HTLC 在兩邊的鏈上鎖住 (peg) tokens，然後只有在執行交換的時候，透過 hash 交換，一次執行雙邊的交易。\n關於 Atomic Swap 網路有非常多的訊息，有興趣的話可以看這篇\n交易只有在雙邊完成後才完成，完成之前不能動用交換的資產 在任何階段失效都可以完全 fallback，並進行 refund 交易的認證是去中心化的 這邊有個但書，Ethereum 上是透過 smart contract 實現，但 Binance chain 上還是靠 Binance 認證 XD Binance 在 BEP3 中支援 HTLC，我們這邊主要的資訊來源是 binance.org 的官方說明文件，這邊針對文章進行驗證，並且補足文件缺漏的部分，提醒過程中可能會踩到的雷。\n跨鍊(Cross Chain) 交易 在部署 asset / token 的時候，我們會選擇合適的鏈作為發布資產並運行 block chain app。常用的應用鏈如 ethereum 與 binance chain 等等。不同的主鏈上有各自的優缺點，例如使用 ethereum ，可以與許多 token 與應用互動，也是最多人使用的應用主鏈。而在 binance 鏈上執行，則能夠快速的發生 transactions，並且可以與 binance 上的資產與交易所互動。\n","keywords":["blockchain","bep3","binance","ethereum","erc-20"],"articleBody":"BEP3 Atomic Swap Binance 在 BEP3: HTLC and Atomic Peg 提到，BEP 即將在 binance chain 上支援原生的 Hash Timer Locked Transfer (HTLT) ，這使跨鏈的原子性交換 (atomic swap) 變得可行，透過 HTLC 在兩邊的鏈上鎖住 (peg) tokens，然後只有在執行交換的時候，透過 hash 交換，一次執行雙邊的交易。\n關於 Atomic Swap 網路有非常多的訊息，有興趣的話可以看這篇\n交易只有在雙邊完成後才完成，完成之前不能動用交換的資產 在任何階段失效都可以完全 fallback，並進行 refund 交易的認證是去中心化的 這邊有個但書，Ethereum 上是透過 smart contract 實現，但 Binance chain 上還是靠 Binance 認證 XD Binance 在 BEP3 中支援 HTLC，我們這邊主要的資訊來源是 binance.org 的官方說明文件，這邊針對文章進行驗證，並且補足文件缺漏的部分，提醒過程中可能會踩到的雷。\n跨鍊(Cross Chain) 交易 在部署 asset / token 的時候，我們會選擇合適的鏈作為發布資產並運行 block chain app。常用的應用鏈如 ethereum 與 binance chain 等等。不同的主鏈上有各自的優缺點，例如使用 ethereum ，可以與許多 token 與應用互動，也是最多人使用的應用主鏈。而在 binance 鏈上執行，則能夠快速的發生 transactions，並且可以與 binance 上的資產與交易所互動。\n在某些應用場景，我們會希望兩個獨立主鏈上的資產能後互動，例如在 binance chain 上執行快速的 transaction，然而也要使用 etheruem 上既有的 ERC-20 tokens，這時便需要一個溝通兩條鏈的機制。\n文章分為三個部分 在 Binance Chain 上互換兩個 address 的 binance asset 從 ethereum token 到 binance 從 binance chain 到 ethereum Atomic Swap on Binance Chain 我們今天會實作 Atomic Peg Swap，透過 HTLT 鎖住 Binance Chain 上兩個 address 的資產，並進行原子性的一次交易，來達成鏈上的資產互換。這邊直接使用 binance 提供的 bnbcli 來執行。\n使用情境 兩個在 Binance Chain 上的 address 想交換資產\nClient: HTLT 的發起方，擁有一部分 asset，發起 HTLT 希望執行資產互換 Recipient: HTLT 的收受方，收到 HTLT，需要於時限內 deposit 指定數量的資產到 swap 中 服務元件 HTLT transactions on binance chain: 來鎖住並 claim assets Client tooling: tbnbcli 讓客戶可以操作，監測鏈上 swap 的狀況 流程 Client 使用 tbnbcli 發起 HTLT Recipient 收到發起方送來的 swap info 與 asset (frozen) Recipient Deposit 指定數量的 asset 到 swap 中 Binance Chain 自動完成 swap，完成交換，解鎖兩邊交換的資產 取得 tbnbcli tbnbcli 的說明文件\n由於 bnbcli repo 中使用 Git Large File Storage 來存放 binary，這邊要啟用 git-lfs 來下載 binary\n# Mac port sudo port install git-lfs Git clone repo\ngit clone git@github.com:binance-chain/node-binary.git cd node-binary git chechout v0.6.2 git lfs pull --include cli/testnet/0.6.2/mac/tbnbcli sudo copy cli/testnet/0.6.2/mac/tbnbcli /usr/local/bin 這邊要注意使用 v0.6.2+ 的版本，不然會沒有 HTLT 的 subcommands\n測試 tbnbcli tbnbcli status --node http://data-seed-pre-0-s3.binance.org:80 { \"node_info\": { \"protocol_version\": { \"p2p\": \"7\", \"block\": \"10\", \"app\": \"0\" }, \"id\": \"34ac6eb6cd914014995b5929be8d7bc9c16f724d\", \"listen_addr\": \"aa13359cd244f11e988520ad55ba7f5a-c3963b80c9b991b7.elb.us-east-1.amazonaws.com:27146\", \"network\": \"Binance-Chain-Nile\", \"version\": \"0.31.5\", \"channels\": \"36402021222330380041\", \"moniker\": \"data-seed-0\", \"other\": { \"tx_index\": \"on\", \"rpc_address\": \"tcp://0.0.0.0:27147\" } }, \"sync_info\": { \"latest_block_hash\": \"359AD9BF36B7DEEB069A86D53D3B65D9F4BB77A1A65E40E1289B5798D4C1094F\", \"latest_app_hash\": \"E748CFA5806B587D9678F55DFDDB336E3669CDF421191CDA6D2DF8AA7A3461F3\", \"latest_block_height\": \"45868456\", \"latest_block_time\": \"2019-10-23T07:36:38.176957281Z\", \"catching_up\": false }, \"validator_info\": { \"address\": \"1C360E22E04035E22A71A3765E4A8C5A6D586132\", \"pub_key\": { \"type\": \"tendermint/PubKeyEd25519\", \"value\": \"T56yDoH+B+OY8PP2tmeFtJtk+9ftnBUVHykKfLS45Es=\" }, \"voting_power\": \"0\" } } Acquire Valid Binance Testnet Account Check Testnet Doc\nGo to Binance Testnet Create a wallet Save address, mn, keystore, private key Use testnet faucet to fund testnet account Receive 200 BNB on testnet Client Create HTLT 這邊使用簡單的範例，鎖住兩個 BEP2 tokens 來進行交換，展示一下 tbnbcli 的 HTLT\n準備兩個 address，這邊是我自己的兩個 testnet address\ntbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p (179 BNB) Explorer 上查看 tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce (20 BNB) Exporler 上查看 目標：\nHTLT tbnb…j9p -\u003e 0.3 BNB -\u003e tbnb…7ce tbnb…j9p \u003c- 0.1 BNB \u003c- tbnb…7ce tbnbcli 執行 HTLT，從 from address 執行 HTLT，給 recipient-addr 0.3 BNB，並預期對方回 0.1 BNB，等待 height-span 個 block 時間(360 \u003e 2 minutes)\ntbnbcli key 實際執行前，由於我們需要透過 tbnbcli 操作 from-address，要先透過 tbnbcli 把 address 的 key 加進到本地\ntbnbcli keys add tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce --recover tbnbcli keys list NAME:\tTYPE:\tADDRESS:\tPUBKEY: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tlocal\ttbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tbnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4 實際執行 參數：\nFROM ADDR: tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\nRECIPIENT ADDR: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\nhightspan: 3600，height-span 是發起 HTLT，受方 deposit，發起方去 claim 的時限。\namount: asset * 10^8\ntbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p 執行 HTLT\n給 tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce 0.3 BNB\n預期對方回 0.1 BNB\n等待 3600 個 block 時間\nFROM_ADDR=tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p RECIPIENT_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce HEIGHT_SPAN=3600 tbnbcli token HTLT \\ --recipient-addr ${RECIPIENT_ADDR} \\ --amount 30000000:BNB \\ --expected-income 10000000:BNB \\ --height-span ${HEIGHT_SPAN} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 產生 swap 的結果，可以於Testnet Explorer 上看到\nCommitted at block 47218942 (tx hash: 8F865C5C9E5CD06239DE99746BCE73AACA2F3AD881C26765FB90C9465EF06EF0, response: {Code:0 Data:[77 138 29 51 186 65 213 125 105 217 5 102 170 194 248 149 189 188 56 208 166 93 48 159 188 196 143 111 31 66 151 249] Log:Msg 0: swapID: 4d8a1d33ba41d57d69d90566aac2f895bdbc38d0a65d309fbcc48f6f1f4297f9 Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 104 113 54 118 52 57 97 110 51 119 119 104 114 100 56 110 121 55 113 106 51 101 120 103 102 109 118 112 118 117 101 108 107 99 97 106 57 112] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) Query Atomic Swap 產生了 atomic swap，這邊可以使用 tbnbcli 查詢 swap 的狀態\nSWAP_ID=4d8a1d33ba41d57d69d90566aac2f895bdbc38d0a65d309fbcc48f6f1f4297f9 tbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 回傳 swap 的狀態\n{\"from\":\"tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\",\"to\":\"tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\",\"out_amount\":[{\"denom\":\"BNB\",\"amount\":\"30000000\"}],\"in_amount\":null,\"expected_income\":\"10000000:BNB\",\"recipient_other_chain\":\"\",\"random_number_hash\":\"4cf88f1acf8bcbc628609f3257406913f67e009e5c61f2671b601e40f4e5cc6a\",\"random_number\":\"\",\"timestamp\":\"1572506189\",\"cross_chain\":false,\"expire_height\":\"47222542\",\"index\":\"2254\",\"closed_time\":\"0\",\"status\":\"Open\"} Deposit HTLT 受方 reciept-address 這邊要把 1 BNB 打進去 swap 中\n注意這邊的 from-address 已經變成當初的 recipient-addr tbnb…j9p\n當然這邊要存取，也要有 tbnb…j9p 的 key，這樣我們本地就會有發受兩方的 key，但一般來說應該是兩個不同的人\ntbnbcli keys add tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p--recover tbnbcli keys list NAME:\tTYPE:\tADDRESS:\tPUBKEY: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tlocal\ttbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\tbnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4 tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\tlocal\ttbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\tbnbp1addwnpepqwk5zx3jnrq5guxc9tsgrte9aw9knla0ahunwynypkm0jvst6y7l2q83ueq 受方把約好的錢存進去\ntbnbcli token deposit \\ --swap-id ${SWAP_ID} \\ --amount 10000000:BNB \\ --from ${RECIPIENT_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 可以成功 deposit，檢查這次 tx Deposit swap 的內容\nPassword to sign with 'tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce': Committed at block 47219070 (tx hash: FDCC528B9F98E9CEEDCB113A398A747F440666061340535D44C526D79F9CD667, response: {Code:0 Data:[] Log:Msg 0: Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[100 101 112 111 115 105 116 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) 發起方 Claim HTLT 針對每筆 HTLT ，解鎖鎖住的 assets。每個 HTLT 只能被解鎖一次。\ntbnbcli token claim \\ --swap-id ${SWAP_ID} \\ --random-number ${RANDOM_NUMBER} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 可以成功 claim，檢查這次 tx Deposit swap 的內容\nPassword to sign with 'tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p': Committed at block 47219128 (tx hash: D08F81D0315F0A7B13E510782F6E56804803B5198F4914C8EB10E3A5084F2BAA, response: {Code:0 Data:[] Log:Msg 0: Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 104 113 54 118 52 57 97 110 51 119 119 104 114 100 56 110 121 55 113 106 51 101 120 103 102 109 118 112 118 117 101 108 107 99 97 106 57 112] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[99 108 97 105 109 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) 查詢 swap 狀態 從 open 變成 completed\ntbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 {\"from\":\"tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\",\"to\":\"tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\",\"out_amount\":[{\"denom\":\"BNB\",\"amount\":\"30000000\"}],\"in_amount\":[{\"denom\":\"BNB\",\"amount\":\"10000000\"}],\"expected_income\":\"10000000:BNB\",\"recipient_other_chain\":\"\",\"random_number_hash\":\"4cf88f1acf8bcbc628609f3257406913f67e009e5c61f2671b601e40f4e5cc6a\",\"random_number\":\"cb5f6296078fd73b86d03eb58bc8a6e0af8d4b60c1cd678b71f8c185e206db53\",\"timestamp\":\"1572506189\",\"cross_chain\":false,\"expire_height\":\"47222542\",\"index\":\"2254\",\"closed_time\":\"1572506323\",\"status\":\"Completed\"} 這樣 swap 就完成了\n超時 (Expired) 處理 由於 HTLT 是有時間限制，有可能會超時，會無法繼續操作，例如另外一筆 HTLT 在受方 deposit 時無法 deposit\ntbnbcli token deposit \\ --swap-id ${SWAP_ID} \\ --amount 1:BNB \\ --from ${RECIPIENT_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 ERROR: { \"codespace\":8, \"code\":14, \"abci_code\":524302, \"message\":\"Current block height is 46046996, the swap expire height(46043293) is passed\" } 超過 swap block height 了，受方這邊逾時去存錢，導致整個 swap expired，不能在做什麼事\n發起方去透過 refund 解鎖\nRefund HTLT 若是已經 complete 或是 timeout expired，發起 HTLT 的 address 可以透過 refund 來取回資產\ntbnbcli token refund \\ --swap-id ${SWAP_ID} \\ --from ${FROM_ADDR} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 回覆 tx 的狀態，可以在explorer 上看到，transaction type 為 refund swap\nCommitted at block 46047771 ( tx hash: F0F5AB40EF7B1CCFE54EBAE0B8022E9B3C381D0029C55A8FE7C3C87E8ACF800D, response: { Code:0 Data:[] Log:Msg 0: Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[114 101 102 117 110 100 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0 } ) 重新查詢 swap 狀態，已經變成 expired\ntbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 { \"from\": \"tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\", \"to\": \"tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p\", \"out_amount\": [{ \"denom\": \"BNB\", \"amount\": \"3\" }], \"in_amount\": null, \"expected_income\": \"1:BNB\", \"recipient_other_chain\": \"\", \"random_number_hash\": \"2c2588c81a5f08bf55a183cc2d61a123368405638741169933e200c90f4532e5\", \"random_number\": \"\", \"timestamp\": \"1571905650\", \"cross_chain\": false, \"expire_height\": \"46043293\", \"index\": \"2239\", \"closed_time\": \"1571908256\", \"status\": \"Expired\" } 從 Ethereum swap 到 Binance Chain 這邊我們要從 ethereum 上，將 ERC-20 token 與 binance chain 上的 BNB 做交換，先準備需要用到的東西\nbinance testnet 準備好 address 與 BNB，這邊沿用我們上篇使用的 address tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p ethereum testnet (ropsten) Admin Address [ropsten etherscan] 部署 ERC20 token [ropsten etherscan]，我自己發行的 Party Parrot Token (PPT) 部署 ERC20 Atomic Swapper 智能合約 binance-chain/bep3-smartcontract 提供 Node/VM 用來執行 bep3 deputy process https://github.com/binance-chain/bep3-deputy 提供 workflow 我們看一下官方提供的這張圖\nWallet Address 在 ERC20 Token (PPToken) approve() Swap Contract 一部分 Token 初始化 Swap Transaction(tx) Deputy 監測到 Ethereum 鏈上的 swap tx，向 Binance Chain 發起一個對應的 HTLT tx，等待 Binance 上的 claim tx Wallet Address 向 Binance Chain 執行 HTLT claim() Deputy 監測到 Binance Chain 上的 claim tx 與 swap complete，代為向 Ethereum claim ERC-20 執行 deputy 我們可以先將 deputy 程序跑起來，這邊使用的是 Binance Chaing/bep3-deputy\ngo get github.com/binance-chain/bep3-deputy cd ${GOPATH}/src/github.com/binance-chain/bep3-deputy $ go mod download $ make build go build -o build/deputy main.go 啟動本地 MySQL，這邊直接用 docker 起一個無密碼的\n$ docker run \\ --name some-mysql \\ -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \\ -e MYSQL_DATABASE=deputy \\ -d \\ mysql:5.7.27 設定 config/confg.json\n{ \"db_config\": { \"dialect\": \"mysql\", \"db_path\": \"root:@(localhost:3306)/deputy?charset=utf8\u0026parseTime=True\u0026loc=Local\", }, \"chain_config\": { \"bnb_start_height\": 42516056, \"other_chain\": \"ETH\", \"other_chain_start_height\": 6495598 }, \"admin_config\": { \"listen_addr\": \"127.0.0.1:8080\" }, \"bnb_config\": { \"key_type\": \"mnemonic\", \"mnemonic\": \"\", \"rpc_addr\": \"tcp://data-seed-pre-0-s1.binance.org:80\", \"symbol\": \"BNB\", \"deputy_addr\": \"tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\", \"fetch_interval\": 2, }, \"eth_config\": { \"swap_type\": \"erc20_swap\", \"key_type\": \"private_key\", \"private_key\": \"\", \"provider\": \"https://ropsten.infura.io/v3/cd9643b1870b489b93477921cb767882\", \"swap_contract_addr\": \"0xA08E0F38462eCd107adE62Ee3004850f2448f3d6\", \"token_contract_addr\": \"0xDec348688B060fB44144971461b3BAaC8BD1e571\", \"deputy_addr\": \"0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b\", \"gas_limit\": 300000, \"gas_price\": 20000000000, } } 這樣注意幾個地方\ndb_config 填上 mysql url，有設密碼的話一併帶入 chain_config.bnb_start_height 可以先追到目前的 block height，畢竟我們的 swap tx 都在 deputy 起來之後才會產生，可以跳過啟動時 sync block 的時間。如果是要追過去的 tx，就要調整 block 的高度，並且給予足夠的時間上 deputy 去 sync block。可以到 testnet-explorer 查目前的 block height。 chain_config.other_chain_start_height 也追到最新的 eth block height，可以到 Etherscan 查目前的 block height bnb_config 填上 bnb addr 與助記祠 eth_config 填上 eth addr 與 private key eth_config.deupty_addr 使用 Admin addr，並填上 private key 把 deputy 以 testnet 為目標執行起來\n./build/deputy --help ./build/deputy \\ --bnb-network 0 \\ --config-type local \\ --config-path config/config.json 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 INFO fetch ETH cur height: 6641795 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 INFO fetch BNB cur height: 46215517 2019-10-25 17:16:48 DEBUG Debug sent a request 2019-10-25 17:16:48 INFO fetch try to get ahead block, chain=BNB, height=46215518 deputy 啟動後，就會依據 db 中的 block 資料，開始一路追 block，發現是相關的 addr 就把 tx 拉下來處理。\n由於我們這邊是新 db，我們又直接跳到最新的 block，應該不會需要太多時間就能追上。\ndeputy 有 admin api 可以使用\ncurl http://localhost:8080 curl http://localhost:8080/failed_swaps/1 the number of total failed swaps is 0, the offset of query is 0 curl http://localhost:8080/status { \"mode\": \"NormalMode\", \"bnb_chain_height\": 46215719, \"bnb_sync_height\": 46215718, \"other_chain_height\": 6641804, \"other_chain_sync_height\": 6641804, \"bnb_chain_last_block_fetched_at\": \"2019-10-25T17:18:52+08:00\", \"other_chain_last_block_fetched_at\": \"2019-10-25T17:18:40+08:00\", \"bnb_status\": { \"balance\": [ { \"symbol\": \"BNB\", \"free\": \"18.99812504\", \"locked\": \"0.00000000\", \"frozen\": \"0.00000000\" } ] }, \"other_chain_status\": { \"allowance\": \"9.8e+13\", \"erc20_balance\": \"9.999999969e+20\", \"eth_balance\": \"6.982922764\" } } 可以看到 deputy 上設定的 bnb_addr, eth_addr 的狀態\nother_chain_status.allowance: 9.8e+13 開始 Swap 複習一下流程\n部署好 swap contract \u0026 deputy，啟動 deputy process Wallet Address 在 ERC20 Token (PPToken) approve()，給 Swap Contract 一部分 Token 初始化 Swap Transaction(tx) Deputy 監測到 Ethereum 鏈上的 swap tx，向 Binance Chain 發起一個對應的 HTLT tx，等待 Binance 上的 claim tx Wallet Address 向 Binance Chain 執行 HTLT claim() Deputy 監測到 Binance Chain 上的 claim tx 與 swap complete，代為向 Ethereum claim ERC-20 ERC20 contract Approve() 到 ERC20 contract 的頁面，選擇 approve\nspender: swap contract address value: 10000 PPToken (乘上 10^18)\n到 etherscan 上查看\nCall HTLT function Go to swap contract，call htlt()\n用 etherscan 送上去，然後就壞掉了，Etherscan 上壞掉的 tx 不知為什麼 QAQ\n開 remix IDE，重新嘗試參數\nrandomNumberHash: SHA256(randomNumber||timestamp), randomNumber is 32-length random byte array. 0x0000000000000000000000000000000000000000000000000000000000000000 timestamp: it should be about 10 mins span around current timestamp. unix timestamp 1572250902 (now + 60 sec * 10 min) heightSpan: it’s a customized filed for deputy operator. it should be more than 200 for this deputy. 10000 recipientAddr: deputy address on Ethereum. 0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b bep2SenderAddr: omit this field with 0x0 0x0000000000000000000000000000000000000000 bep2RecipientAddr: Decode your testnet address from bech32 encoded to hex 0xee82ca237387495e9603f4d8d7efed128bdd59a6 outAmount: approved amount, should be bumped by e^10. 10 0000000000 bep2Amount: outAmount * exchange rate, the default rate is 1. 10 0000000000 Deputy Call HTLT on Binance Chain Deputy 監測 Ethereum 上的 block 狀態，特別是會取得 Swap contract address 的 swap tx，並在 Binance Chain 上產生對應的 HTLT。\nClaim HTLT on Binance Chain Binance Chain 上產生 HTLT 後，客戶端這邊可以使用 tbnb 以 recipient addr 查詢 Binance Chain 上的 Swap ID\ntbnbcli token query-swapIDs-by-recipient \\ --recipient-addr tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 獲得過去產生的 swap list\n[ \"c2be98ac3b9ee7153e5ba84edfefca1917b6e2ec72d2576bf6cce584cbd6095e\", \"18c938b994c62bcce9e8cedcb426a603863d95565a246c323a1df89d5c4226c1\", \"5c4fdd60ce44fa4be6de70e65df3f8295df88178fd381b4242a8c2d047663a1b\", \"a47c89dfca910cbb34dec92acebebb59d2c62e7f90bf216a87c2c23c84e48d4f\" ] 都是過去使用的 swap id，如果都沒有新的 swap 出來，可能是 height span 太高，導致一直都爬不到\nSWAP_ID=c2be98ac3b9ee7153e5ba84edfefca1917b6e2ec72d2576bf6cce584cbd6095e tbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 這邊要對一下 random number, to wallet addr, out amount 等參數，如果 HTLT 符合，客戶就可以執行 Claim HTLT\ntbnbcli token claim \\ --swap-id ${SWAP_ID} \\ --random-number ${RANDOM_NUMBER} \\ --from ${FROM_KEY} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 Deputy Claim ERC20 Token 客戶端在 Binance Chain 上 Claim HTLT，Deputy 在 Ethereuem 上 Claim HTLT，至此完成 Atomic Swap 兩邊的流程。客戶端從 Binance Chain Claim，Deputy 從 Ethereuem 上 Claim。完整流程 如下：\nClient Call HTLT on Ethereum -\u003e Deputy Call HTLT on Binance Chain Client Check HTLT Status on Binance Chain Client Call Claim HTLT on Binance Chain -\u003e Deputy Call Claim HTLT on Ethereum Client APP javascript Demo 希望直接寫成 javascript app 可以參考這篇\nSwap Tokens from Binance Chain to Ethereum 這邊進行反向操作，客戶發起從 Binance Chain 換到 Ethereum 上的請求，Deputy 做對應的處理，把 Token Swap 到 Ethereum。我們依樣依照這份文件操作。\n客戶端在 Binance Chain 上 Call HTLT() Deputy 在 Ethereum 上 Init Swap tx Deputy Call Approve() 到 ethereum swap contract 客戶端取得 swap 資訊 客戶端在 Ethereum 上 Call Claim()，取得 ERC-20 Token Deputy 在 Binance 上 Call Claim()，取得 Binance Chain Token 在 Binance Chain 上 HTLT 客戶端發起 HTLT 請求，需要從客戶端 Wallet 送出（但因為我們這邊只使用一個 Binance Address，所以發起的 Addr 跟 Deputy Binance addr 是一樣的。\n這邊鎖進 10:BNB，等待 100:PPT 從 ethereum 近來\nDEPUTY_BNB_WALLET_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce CLIENT_BNB_WALLET_ADDR=${DEPUTY_BNB_WALLET_ADDR} CLIENT_ETHEREUM_ADDR=0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b tbnbcli token HTLT \\ --from ${CLIENT_BNB_WALLET_ADDR} \\ --recipient-addr ${DEPUTY_BNB_WALLET_ADDR} \\ --chain-id Binance-Chain-Nile \\ --height-span 500 \\ --amount 10:BNB \\ --expected-income 100:PPT \\ --recipient-other-chain ${CLIENT_ETHEREUM_ADDR} \\ --cross-chain \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 HTLT 回復的結果如下，可以在Binance Testnet Explorer\nRandom number: 75267ba4cc4f2d9ddbf9f90dc1ea813ae2a4d2114eb2ef2cb7ff0a5d285c7396 Timestamp: 1572337686 Random number hash: dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b Password to sign with 'tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce': Committed at block 46889130 (tx hash: D653FC7B5D2048A2A165F49426CDCAD733703CF534367133819091892E3A1F14, response: {Code:0 Data:[119 24 196 176 181 1 29 177 60 107 100 166 55 16 253 136 159 3 204 56 109 46 63 87 93 9 239 158 138 172 21 129] Log:Msg 0: swapID: 7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}) 取得 swap id 與 random number，使用 swap ip 查詢\nSWAP_ID=7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 tbnbcli token query-swap \\ --swap-id ${SWAP_ID} \\ --chain-id Binance-Chain-Nile \\ --trust-node \\ --node http://data-seed-pre-0-s3.binance.org:80 回復當前的狀態\n{ \"from\":\"tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\", \"to\":\"tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce\", \"out_amount\":[ { \"denom\":\"BNB\", \"amount\":\"10\" } ], \"in_amount\":null, \"expected_income\":\"100:PPT\", \"recipient_other_chain\":\"0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b\", \"random_number_hash\":\"dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b\", \"random_number\":\"\", \"timestamp\":\"1572337686\", \"cross_chain\":true, \"expire_height\":\"46889630\", \"index\":\"2245\", \"closed_time\":\"0\", \"status\":\"Open\" } Deputy Appove Token Deputy 已經抓到 Binance Chain 上的 tx，會記錄在 Mysql 內\nuse deputy; select * from tx_log limit 10; | id | chain | swap_id | tx_type | tx_hash | contract_addr | sender_addr | receiver_addr | sender_other_chain | other_chain_addr | in_amount | out_amount | out_coin | random_number_hash | expire_height | timestamp | random_number | block_hash | height | status | confirmed_num | create_time | update_time | | 2 | BNB | 7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 | BEP2_HTLT | d653fc7b5d2048a2a165f49426cdcad733703cf534367133819091892e3a1f14 | | tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce | tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce | | 0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b | 100:PPT | 10 | BNB | dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b | 46889630 | 1572337686 | | 6948f34e4013da29c9922306b60b2c12f174925c63ff2a46d6b2fc3acd7a3774 | 46889130 | CONFIRMED | 6 | 1572337694 | 1572337695 | Deputy Send HTLT on Ethereum 查詢 Ethereum 上的 HTLT\n客戶端 Call Claim 取得 ERC-20 Token 客戶端取得 100:PPT\nDeputy Call HTLT Claim 取得 Binance Token Deputy 取得 10:BNB\nGCE gcloud compute ssh dep3-deputy sudo apt-get update sudo apt-get install mysql-server sudo cat /etc/mysql/debian.cnf wget https://dl.google.com/go/go1.13.3.linux-amd64.tar.gz tar -C /usr/local -xzf go1.13.3.linux-amd64.tar.gz export PATH=$PATH:/usr/local/go/bin go get github.com/binance-chain/bep3-deputy go mod tidy go build -o build/deputy main.go References Binace Chain Doc Binance BEP3 spec ","wordCount":"2861","inLanguage":"en","image":"https://chechia.net/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2019-10-22T10:35:20+08:00","dateModified":"2019-10-22T10:35:20+08:00","author":{"@type":"Person","name":"chechiachang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chechia.net/posts/2019-10-22-blockchain-bep3-atomic-swap/"},"publisher":{"@type":"Organization","name":"Che-Chia Chang","logo":{"@type":"ImageObject","url":"https://chechia.net/favicon/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chechia.net/ accesskey=h title="Home (Alt + H)"><img src=https://chechia.net/favicon/favicon-32x32.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chechia.net/#posts title=Posts><span>Posts</span></a></li><li><a href=https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5 title=MVP><span>MVP</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://chechia.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://chechia.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chechia.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chechia.net/>Home</a>&nbsp;»&nbsp;<a href=https://chechia.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Blockchain Bep3 Atomic Swap</h1><div class=post-meta><span title='2019-10-22 10:35:20 +0800 CST'>October 22, 2019</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;2861 words&nbsp;·&nbsp;chechiachang&nbsp;|&nbsp;<a href=https://github.com/chechiachang.github.io-src/content/posts/2019-10-22-blockchain-bep3-atomic-swap.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#跨鍊cross-chain-交易>跨鍊(Cross Chain) 交易</a></li><li><a href=#文章分為三個部分>文章分為三個部分</a></li><li><a href=#swap-on-binance-chain>Atomic Swap on Binance Chain</a></li><li><a href=#使用情境>使用情境</a></li><li><a href=#服務元件>服務元件</a></li><li><a href=#流程>流程</a></li><li><a href=#取得-tbnbcli>取得 tbnbcli</a></li><li><a href=#測試-tbnbcli>測試 tbnbcli</a></li><li><a href=#acquire-valid-binance-testnet-account>Acquire Valid Binance Testnet Account</a></li><li><a href=#client-create-htlt>Client Create HTLT</a></li><li><a href=#tbnbcli-key>tbnbcli key</a></li><li><a href=#實際執行>實際執行</a></li><li><a href=#query-atomic-swap>Query Atomic Swap</a></li><li><a href=#deposit-htlt>Deposit HTLT</a></li><li><a href=#發起方-claim-htlt>發起方 Claim HTLT</a></li><li><a href=#查詢-swap-狀態>查詢 swap 狀態</a></li><li><a href=#超時-expired-處理>超時 (Expired) 處理</a></li><li><a href=#refund-htlt>Refund HTLT</a></li></ul></li></ul><ul><li><ul><li><a href=#binance-testnet>binance testnet</a></li><li><a href=#ethereum-testnet-ropsten>ethereum testnet (ropsten)</a></li><li><a href=#nodevm>Node/VM</a></li><li><a href=#workflow>workflow</a></li><li><a href=#執行-deputy>執行 deputy</a></li></ul></li></ul><ul><li><ul><li><a href=#erc20-contract-approve>ERC20 contract Approve()</a></li><li><a href=#call-htlt-function>Call HTLT function</a></li><li><a href=#deputy-call-htlt-on-binance-chain>Deputy Call HTLT on Binance Chain</a></li><li><a href=#claim-htlt-on-binance-chain>Claim HTLT on Binance Chain</a></li><li><a href=#deputy-claim-erc20-token>Deputy Claim ERC20 Token</a></li><li><a href=#client-app-javascript-demo>Client APP javascript Demo</a></li></ul></li></ul><ul><li><ul><li><a href=#在-binance-chain-上-htlt>在 Binance Chain 上 HTLT</a></li><li><a href=#deputy-appove-token>Deputy Appove Token</a></li><li><a href=#deputy-send-htlt-on-ethereum>Deputy Send HTLT on Ethereum</a></li><li><a href=#客戶端-call-claim-取得-erc-20-token>客戶端 Call Claim 取得 ERC-20 Token</a></li><li><a href=#deputy-call-htlt-claim-取得-binance-token>Deputy Call HTLT Claim 取得 Binance Token</a></li><li><a href=#gce>GCE</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=bep3-atomic-swap>BEP3 Atomic Swap<a hidden class=anchor aria-hidden=true href=#bep3-atomic-swap>#</a></h1><p>Binance 在 <a href=https://github.com/binance-chain/BEPs/blob/master/BEP3.md>BEP3: HTLC and Atomic Peg</a> 提到，BEP 即將在 binance chain 上支援原生的 Hash Timer Locked Transfer (HTLT) ，這使跨鏈的原子性交換 (atomic swap) 變得可行，透過 HTLC 在兩邊的鏈上鎖住 (peg) tokens，然後只有在執行交換的時候，透過 hash 交換，一次執行雙邊的交易。</p><p>關於 Atomic Swap 網路有非常多的訊息，有興趣的話可以看<a href=https://en.bitcoin.it/wiki/Atomic_swap>這篇</a></p><ul><li>交易只有在雙邊完成後才完成，完成之前不能動用交換的資產</li><li>在任何階段失效都可以完全 fallback，並進行 refund</li><li>交易的認證是去中心化的<ul><li>這邊有個但書，Ethereum 上是透過 smart contract 實現，但 Binance chain 上還是靠 Binance 認證 XD</li></ul></li></ul><p>Binance 在 BEP3 中支援 HTLC，我們這邊主要的資訊來源是 binance.org 的<a href=https://docs.binance.org/atomic-swap.html>官方說明文件</a>，這邊針對文章進行驗證，並且補足文件缺漏的部分，提醒過程中可能會踩到的雷。</p><h3 id=跨鍊cross-chain-交易>跨鍊(Cross Chain) 交易<a hidden class=anchor aria-hidden=true href=#跨鍊cross-chain-交易>#</a></h3><p>在部署 asset / token 的時候，我們會選擇合適的鏈作為發布資產並運行 block chain app。常用的應用鏈如 ethereum 與 binance chain 等等。不同的主鏈上有各自的優缺點，例如使用 ethereum ，可以與許多 token 與應用互動，也是最多人使用的應用主鏈。而在 binance 鏈上執行，則能夠快速的發生 transactions，並且可以與 binance 上的資產與交易所互動。</p><p>在某些應用場景，我們會希望兩個獨立主鏈上的資產能後互動，例如在 binance chain 上執行快速的 transaction，然而也要使用 etheruem 上既有的 ERC-20 tokens，這時便需要一個溝通兩條鏈的機制。</p><h3 id=文章分為三個部分>文章分為三個部分<a hidden class=anchor aria-hidden=true href=#文章分為三個部分>#</a></h3><ul><li><a href=#swap-on-binance-chain>在 Binance Chain 上互換兩個 address 的 binance asset</a></li><li><a href=#from-ethereum-to-binance-chain>從 ethereum token 到 binance</a></li><li><a href=#from-binance-chain-to-ethereum>從 binance chain 到 ethereum</a></li></ul><hr><h3 id=swap-on-binance-chain>Atomic Swap on Binance Chain<a hidden class=anchor aria-hidden=true href=#swap-on-binance-chain>#</a></h3><p>我們今天會實作 Atomic Peg Swap，透過 HTLT 鎖住 Binance Chain 上兩個 address 的資產，並進行原子性的一次交易，來達成鏈上的資產互換。這邊直接使用 binance 提供的 bnbcli 來執行。</p><h3 id=使用情境>使用情境<a hidden class=anchor aria-hidden=true href=#使用情境>#</a></h3><p>兩個在 Binance Chain 上的 address 想交換資產</p><ul><li>Client: HTLT 的發起方，擁有一部分 asset，發起 HTLT 希望執行資產互換</li><li>Recipient: HTLT 的收受方，收到 HTLT，需要於時限內 deposit 指定數量的資產到 swap 中</li></ul><h3 id=服務元件>服務元件<a hidden class=anchor aria-hidden=true href=#服務元件>#</a></h3><ul><li>HTLT transactions on binance chain: 來鎖住並 claim assets</li><li>Client tooling: tbnbcli 讓客戶可以操作，監測鏈上 swap 的狀況</li></ul><h3 id=流程>流程<a hidden class=anchor aria-hidden=true href=#流程>#</a></h3><ol><li>Client 使用 tbnbcli 發起 HTLT</li><li>Recipient 收到發起方送來的 swap info 與 asset (frozen)</li><li>Recipient Deposit 指定數量的 asset 到 swap 中</li><li>Binance Chain 自動完成 swap，完成交換，解鎖兩邊交換的資產</li></ol><h3 id=取得-tbnbcli>取得 tbnbcli<a hidden class=anchor aria-hidden=true href=#取得-tbnbcli>#</a></h3><p><a href=https://docs.binance.org/api-reference/cli.html>tbnbcli 的說明文件</a></p><p>由於 bnbcli repo 中使用 Git Large File Storage 來存放 binary，這邊要啟用 git-lfs 來下載 binary</p><pre><code># Mac port
sudo port install git-lfs
</code></pre><p>Git clone repo</p><pre><code class=language-bash>git clone git@github.com:binance-chain/node-binary.git
cd node-binary

git chechout v0.6.2
git lfs pull --include cli/testnet/0.6.2/mac/tbnbcli
sudo copy cli/testnet/0.6.2/mac/tbnbcli /usr/local/bin
</code></pre><p>這邊要注意使用 v0.6.2+ 的版本，不然會沒有 HTLT 的 subcommands</p><h3 id=測試-tbnbcli>測試 tbnbcli<a hidden class=anchor aria-hidden=true href=#測試-tbnbcli>#</a></h3><pre><code class=language-bash>tbnbcli status --node http://data-seed-pre-0-s3.binance.org:80

{
	&quot;node_info&quot;: {
		&quot;protocol_version&quot;: {
			&quot;p2p&quot;: &quot;7&quot;,
			&quot;block&quot;: &quot;10&quot;,
			&quot;app&quot;: &quot;0&quot;
		},
		&quot;id&quot;: &quot;34ac6eb6cd914014995b5929be8d7bc9c16f724d&quot;,
		&quot;listen_addr&quot;: &quot;aa13359cd244f11e988520ad55ba7f5a-c3963b80c9b991b7.elb.us-east-1.amazonaws.com:27146&quot;,
		&quot;network&quot;: &quot;Binance-Chain-Nile&quot;,
		&quot;version&quot;: &quot;0.31.5&quot;,
		&quot;channels&quot;: &quot;36402021222330380041&quot;,
		&quot;moniker&quot;: &quot;data-seed-0&quot;,
		&quot;other&quot;: {
			&quot;tx_index&quot;: &quot;on&quot;,
			&quot;rpc_address&quot;: &quot;tcp://0.0.0.0:27147&quot;
		}
	},
	&quot;sync_info&quot;: {
		&quot;latest_block_hash&quot;: &quot;359AD9BF36B7DEEB069A86D53D3B65D9F4BB77A1A65E40E1289B5798D4C1094F&quot;,
		&quot;latest_app_hash&quot;: &quot;E748CFA5806B587D9678F55DFDDB336E3669CDF421191CDA6D2DF8AA7A3461F3&quot;,
		&quot;latest_block_height&quot;: &quot;45868456&quot;,
		&quot;latest_block_time&quot;: &quot;2019-10-23T07:36:38.176957281Z&quot;,
		&quot;catching_up&quot;: false
	},
	&quot;validator_info&quot;: {
		&quot;address&quot;: &quot;1C360E22E04035E22A71A3765E4A8C5A6D586132&quot;,
		&quot;pub_key&quot;: {
			&quot;type&quot;: &quot;tendermint/PubKeyEd25519&quot;,
			&quot;value&quot;: &quot;T56yDoH+B+OY8PP2tmeFtJtk+9ftnBUVHykKfLS45Es=&quot;
		},
		&quot;voting_power&quot;: &quot;0&quot;
	}
}
</code></pre><h3 id=acquire-valid-binance-testnet-account>Acquire Valid Binance Testnet Account<a hidden class=anchor aria-hidden=true href=#acquire-valid-binance-testnet-account>#</a></h3><p>Check <a href=https://www.binance.com/en/support/articles/360023912272>Testnet Doc</a></p><ul><li>Go to <a href=https://testnet.binance.org/en/>Binance Testnet</a></li><li>Create a wallet</li><li>Save address, mn, keystore, private key</li><li>Use <a href=https://www.binance.vision/tutorials/binance-dex-funding-your-testnet-account>testnet faucet</a> to fund testnet account</li><li>Receive 200 BNB on testnet</li></ul><hr><h3 id=client-create-htlt>Client Create HTLT<a hidden class=anchor aria-hidden=true href=#client-create-htlt>#</a></h3><p>這邊使用簡單的範例，鎖住兩個 BEP2 tokens 來進行交換，展示一下 tbnbcli 的 HTLT</p><p>準備兩個 address，這邊是我自己的兩個 testnet address</p><ul><li>tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p (179 BNB) <a href=https://testnet-explorer.binance.org/address/tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p>Explorer 上查看</a></li><li>tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce (20 BNB) <a href=https://testnet-explorer.binance.org/address/tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce>Exporler 上查看</a></li></ul><p>目標：</p><ul><li>HTLT</li><li>tbnb&mldr;j9p -> 0.3 BNB -> tbnb&mldr;7ce</li><li>tbnb&mldr;j9p &lt;- 0.1 BNB &lt;- tbnb&mldr;7ce</li></ul><p>tbnbcli 執行 HTLT，從 from address 執行 HTLT，給 recipient-addr 0.3 BNB，並預期對方回 0.1 BNB，等待 height-span 個 block 時間(360 > 2 minutes)</p><h3 id=tbnbcli-key>tbnbcli key<a hidden class=anchor aria-hidden=true href=#tbnbcli-key>#</a></h3><p>實際執行前，由於我們需要透過 tbnbcli 操作 from-address，要先<a href=https://docs.binance.org/keys.html>透過 tbnbcli 把 address 的 key 加進到本地</a></p><pre><code class=language-bash>tbnbcli keys add tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce --recover

tbnbcli keys list

NAME:	                                      TYPE:	ADDRESS:						                        PUBKEY:
tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce	local	tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce	bnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4
</code></pre><h3 id=實際執行>實際執行<a hidden class=anchor aria-hidden=true href=#實際執行>#</a></h3><p>參數：</p><ul><li><p>FROM ADDR: tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p</p></li><li><p>RECIPIENT ADDR: tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce</p></li><li><p>hightspan: 3600，height-span 是發起 HTLT，受方 deposit，發起方去 claim 的時限。</p></li><li><p>amount: asset * 10^8</p></li><li><p>tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p 執行 HTLT</p></li><li><p>給 tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce 0.3 BNB</p></li><li><p>預期對方回 0.1 BNB</p></li><li><p>等待 3600 個 block 時間</p></li></ul><pre><code class=language-bash>FROM_ADDR=tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p
RECIPIENT_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce
HEIGHT_SPAN=3600

tbnbcli token HTLT \
  --recipient-addr ${RECIPIENT_ADDR} \
  --amount 30000000:BNB \
  --expected-income 10000000:BNB \
  --height-span ${HEIGHT_SPAN} \
  --from ${FROM_ADDR} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>產生 swap 的結果，可以於<a href=https://testnet-explorer.binance.org/tx/8F865C5C9E5CD06239DE99746BCE73AACA2F3AD881C26765FB90C9465EF06EF0>Testnet Explorer 上看到</a></p><pre><code class=language-bash>Committed at block 47218942 (tx hash: 8F865C5C9E5CD06239DE99746BCE73AACA2F3AD881C26765FB90C9465EF06EF0, response: {Code:0 Data:[77 138 29 51 186 65 213 125 105 217 5 102 170 194 248 149 189 188 56 208 166 93 48 159 188 196 143 111 31 66 151 249] Log:Msg 0: swapID: 4d8a1d33ba41d57d69d90566aac2f895bdbc38d0a65d309fbcc48f6f1f4297f9 Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 104 113 54 118 52 57 97 110 51 119 119 104 114 100 56 110 121 55 113 106 51 101 120 103 102 109 118 112 118 117 101 108 107 99 97 106 57 112] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0})
</code></pre><h3 id=query-atomic-swap>Query Atomic Swap<a hidden class=anchor aria-hidden=true href=#query-atomic-swap>#</a></h3><p>產生了 atomic swap，這邊可以使用 tbnbcli 查詢 swap 的狀態</p><pre><code class=language-bash>SWAP_ID=4d8a1d33ba41d57d69d90566aac2f895bdbc38d0a65d309fbcc48f6f1f4297f9

tbnbcli token query-swap \
  --swap-id ${SWAP_ID} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>回傳 swap 的狀態</p><pre><code class=language-json>{&quot;from&quot;:&quot;tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p&quot;,&quot;to&quot;:&quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce&quot;,&quot;out_amount&quot;:[{&quot;denom&quot;:&quot;BNB&quot;,&quot;amount&quot;:&quot;30000000&quot;}],&quot;in_amount&quot;:null,&quot;expected_income&quot;:&quot;10000000:BNB&quot;,&quot;recipient_other_chain&quot;:&quot;&quot;,&quot;random_number_hash&quot;:&quot;4cf88f1acf8bcbc628609f3257406913f67e009e5c61f2671b601e40f4e5cc6a&quot;,&quot;random_number&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;1572506189&quot;,&quot;cross_chain&quot;:false,&quot;expire_height&quot;:&quot;47222542&quot;,&quot;index&quot;:&quot;2254&quot;,&quot;closed_time&quot;:&quot;0&quot;,&quot;status&quot;:&quot;Open&quot;}
</code></pre><h3 id=deposit-htlt>Deposit HTLT<a hidden class=anchor aria-hidden=true href=#deposit-htlt>#</a></h3><p>受方 reciept-address 這邊要把 1 BNB 打進去 swap 中</p><p>注意這邊的 from-address 已經變成當初的 recipient-addr tbnb&mldr;j9p</p><p>當然這邊要存取，也要有 tbnb&mldr;j9p 的 key，這樣我們本地就會有發受兩方的 key，但一般來說應該是兩個不同的人</p><pre><code class=language-bash>tbnbcli keys add tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p--recover

tbnbcli keys list

NAME:	                                      TYPE:	ADDRESS:						                        PUBKEY:
tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce	local	tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce	bnbp1addwnpepq0pw06d3y7ykg2j33pc604j3awgqgl5vhd88wdjhjg5sptnsfpqyx2rmhl4
tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p	local	tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p	bnbp1addwnpepqwk5zx3jnrq5guxc9tsgrte9aw9knla0ahunwynypkm0jvst6y7l2q83ueq
</code></pre><p>受方把約好的錢存進去</p><pre><code class=language-bash>tbnbcli token deposit \
  --swap-id ${SWAP_ID}  \
  --amount 10000000:BNB \
  --from ${RECIPIENT_ADDR} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>可以成功 deposit，<a href=https://testnet-explorer.binance.org/tx/FDCC528B9F98E9CEEDCB113A398A747F440666061340535D44C526D79F9CD667>檢查這次 tx Deposit swap 的內容</a></p><pre><code class=language-bash>Password to sign with 'tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce':
Committed at block 47219070 (tx hash: FDCC528B9F98E9CEEDCB113A398A747F440666061340535D44C526D79F9CD667, response: {Code:0 Data:[] Log:Msg 0:  Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[100 101 112 111 115 105 116 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0})
</code></pre><h3 id=發起方-claim-htlt>發起方 Claim HTLT<a hidden class=anchor aria-hidden=true href=#發起方-claim-htlt>#</a></h3><p>針對每筆 HTLT ，解鎖鎖住的 assets。每個 HTLT 只能被解鎖一次。</p><pre><code class=language-bash>tbnbcli token claim \
  --swap-id  ${SWAP_ID} \
  --random-number ${RANDOM_NUMBER} \
  --from ${FROM_ADDR} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>可以成功 claim，<a href=https://testnet-explorer.binance.org/tx/D08F81D0315F0A7B13E510782F6E56804803B5198F4914C8EB10E3A5084F2BAA>檢查這次 tx Deposit swap 的內容</a></p><pre><code class=language-bash>Password to sign with 'tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p':
Committed at block 47219128 (tx hash: D08F81D0315F0A7B13E510782F6E56804803B5198F4914C8EB10E3A5084F2BAA, response: {Code:0 Data:[] Log:Msg 0:  Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 104 113 54 118 52 57 97 110 51 119 119 104 114 100 56 110 121 55 113 106 51 101 120 103 102 109 118 112 118 117 101 108 107 99 97 106 57 112] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[99 108 97 105 109 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0})
</code></pre><h3 id=查詢-swap-狀態>查詢 swap 狀態<a hidden class=anchor aria-hidden=true href=#查詢-swap-狀態>#</a></h3><p>從 open 變成 completed</p><pre><code class=language-bash>tbnbcli token query-swap \
  --swap-id ${SWAP_ID} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><pre><code class=language-json>{&quot;from&quot;:&quot;tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p&quot;,&quot;to&quot;:&quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce&quot;,&quot;out_amount&quot;:[{&quot;denom&quot;:&quot;BNB&quot;,&quot;amount&quot;:&quot;30000000&quot;}],&quot;in_amount&quot;:[{&quot;denom&quot;:&quot;BNB&quot;,&quot;amount&quot;:&quot;10000000&quot;}],&quot;expected_income&quot;:&quot;10000000:BNB&quot;,&quot;recipient_other_chain&quot;:&quot;&quot;,&quot;random_number_hash&quot;:&quot;4cf88f1acf8bcbc628609f3257406913f67e009e5c61f2671b601e40f4e5cc6a&quot;,&quot;random_number&quot;:&quot;cb5f6296078fd73b86d03eb58bc8a6e0af8d4b60c1cd678b71f8c185e206db53&quot;,&quot;timestamp&quot;:&quot;1572506189&quot;,&quot;cross_chain&quot;:false,&quot;expire_height&quot;:&quot;47222542&quot;,&quot;index&quot;:&quot;2254&quot;,&quot;closed_time&quot;:&quot;1572506323&quot;,&quot;status&quot;:&quot;Completed&quot;}
</code></pre><p>這樣 swap 就完成了</p><h3 id=超時-expired-處理>超時 (Expired) 處理<a hidden class=anchor aria-hidden=true href=#超時-expired-處理>#</a></h3><p>由於 HTLT 是有時間限制，有可能會超時，會無法繼續操作，例如另外一筆 HTLT 在受方 deposit 時無法 deposit</p><pre><code class=language-bash>tbnbcli token deposit \
  --swap-id ${SWAP_ID}  \
  --amount 1:BNB \
  --from ${RECIPIENT_ADDR} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><pre><code class=language-json>ERROR: {
  &quot;codespace&quot;:8,
  &quot;code&quot;:14,
  &quot;abci_code&quot;:524302,
  &quot;message&quot;:&quot;Current block height is 46046996, the swap expire height(46043293) is passed&quot;
}
</code></pre><p>超過 swap block height 了，受方這邊逾時去存錢，導致整個 swap expired，不能在做什麼事</p><p>發起方去透過 refund 解鎖</p><h3 id=refund-htlt>Refund HTLT<a hidden class=anchor aria-hidden=true href=#refund-htlt>#</a></h3><p>若是已經 complete 或是 timeout expired，發起 HTLT 的 address 可以透過 refund 來取回資產</p><pre><code class=language-bash>tbnbcli token refund \
  --swap-id ${SWAP_ID} \
  --from ${FROM_ADDR}  \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>回覆 tx 的狀態，<a href=https://testnet-explorer.binance.org/tx/F0F5AB40EF7B1CCFE54EBAE0B8022E9B3C381D0029C55A8FE7C3C87E8ACF800D>可以在explorer 上看到</a>，transaction type 為 refund swap</p><pre><code class=language-bash>Committed at block 46047771 (
  tx hash: F0F5AB40EF7B1CCFE54EBAE0B8022E9B3C381D0029C55A8FE7C3C87E8ACF800D, 
  response: {
    Code:0 
    Data:[] 
    Log:Msg 
    0:  
      Info: 
        GasWanted:0 
        GasUsed:0 
        Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[114 101 102 117 110 100 72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] 
        Codespace: 
          XXX_NoUnkeyedLiteral:{} 
          XXX_unrecognized:[] 
          XXX_sizecache:0
  }
)
</code></pre><p>重新查詢 swap 狀態，已經變成 expired</p><pre><code class=language-bash>tbnbcli token query-swap \
  --swap-id ${SWAP_ID} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><pre><code class=language-json>{
	&quot;from&quot;: &quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce&quot;,
	&quot;to&quot;: &quot;tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p&quot;,
	&quot;out_amount&quot;: [{
		&quot;denom&quot;: &quot;BNB&quot;,
		&quot;amount&quot;: &quot;3&quot;
	}],
	&quot;in_amount&quot;: null,
	&quot;expected_income&quot;: &quot;1:BNB&quot;,
	&quot;recipient_other_chain&quot;: &quot;&quot;,
	&quot;random_number_hash&quot;: &quot;2c2588c81a5f08bf55a183cc2d61a123368405638741169933e200c90f4532e5&quot;,
	&quot;random_number&quot;: &quot;&quot;,
	&quot;timestamp&quot;: &quot;1571905650&quot;,
	&quot;cross_chain&quot;: false,
	&quot;expire_height&quot;: &quot;46043293&quot;,
	&quot;index&quot;: &quot;2239&quot;,
	&quot;closed_time&quot;: &quot;1571908256&quot;,
	&quot;status&quot;: &quot;Expired&quot;
}
</code></pre><hr><h1 id=from-ethereum-to-binance-chain>從 Ethereum swap 到 Binance Chain<a hidden class=anchor aria-hidden=true href=#from-ethereum-to-binance-chain>#</a></h1><p>這邊我們要從 ethereum 上，將 ERC-20 token 與 binance chain 上的 BNB 做交換，先準備需要用到的東西</p><h3 id=binance-testnet>binance testnet<a hidden class=anchor aria-hidden=true href=#binance-testnet>#</a></h3><ul><li>準備好 address 與 BNB，這邊沿用我們上篇使用的 address <a href=https://testnet-explorer.binance.org/address/tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p>tbnb1hq6v49an3wwhrd8ny7qj3exgfmvpvuelkcaj9p</a></li></ul><h3 id=ethereum-testnet-ropsten>ethereum testnet (ropsten)<a hidden class=anchor aria-hidden=true href=#ethereum-testnet-ropsten>#</a></h3><ul><li>Admin Address <a href=https://ropsten.etherscan.io/address/0x938a452d293c23c2cdeae0bf01760d8ecc4f826b>[ropsten etherscan]</a></li><li>部署 ERC20 token <a href=https://ropsten.etherscan.io/address/0xDec348688B060fB44144971461b3BAaC8BD1e571>[ropsten etherscan]</a>，我自己發行的 <a href=https://ropsten.etherscan.io/token/0xDec348688B060fB44144971461b3BAaC8BD1e571>Party Parrot Token (PPT)</a> <img loading=lazy src=https://cultofthepartyparrot.com/parrots/hd/parrot.gif></li><li>部署 ERC20 Atomic Swapper 智能合約<ul><li><a href=https://github.com/chechiachang/bep3-smartcontracts>binance-chain/bep3-smartcontract</a> 提供</li></ul></li></ul><h3 id=nodevm>Node/VM<a hidden class=anchor aria-hidden=true href=#nodevm>#</a></h3><ul><li>用來執行 bep3 deputy process<ul><li><a href=https://github.com/binance-chain/bep3-deputy>https://github.com/binance-chain/bep3-deputy</a> 提供</li></ul></li></ul><h3 id=workflow>workflow<a hidden class=anchor aria-hidden=true href=#workflow>#</a></h3><p>我們看一下官方提供的這張圖</p><p><img loading=lazy src=https://docs.binance.org/assets/eth2bnc.png></p><ol><li>Wallet Address 在 ERC20 Token (PPToken) approve() Swap Contract 一部分 Token</li><li>初始化 Swap Transaction(tx)</li><li>Deputy 監測到 Ethereum 鏈上的 swap tx，向 Binance Chain 發起一個對應的 HTLT tx，等待 Binance 上的 claim tx</li><li>Wallet Address 向 Binance Chain 執行 HTLT claim()</li><li>Deputy 監測到 Binance Chain 上的 claim tx 與 swap complete，代為向 Ethereum claim ERC-20</li></ol><h3 id=執行-deputy>執行 deputy<a hidden class=anchor aria-hidden=true href=#執行-deputy>#</a></h3><p>我們可以先將 deputy 程序跑起來，這邊使用的是 <a href=https://github.com/binance-chain/bep3-deputy>Binance Chaing/bep3-deputy</a></p><pre><code class=language-bash>go get github.com/binance-chain/bep3-deputy
cd ${GOPATH}/src/github.com/binance-chain/bep3-deputy

$ go mod download
$ make build
go build  -o build/deputy main.go
</code></pre><p>啟動本地 MySQL，這邊直接用 docker 起一個無密碼的</p><pre><code>$ docker run \
  --name some-mysql \
  -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \
  -e MYSQL_DATABASE=deputy \
  -d \
  mysql:5.7.27
</code></pre><p>設定 config/confg.json</p><pre><code class=language-json>{
  &quot;db_config&quot;: {
    &quot;dialect&quot;: &quot;mysql&quot;,
    &quot;db_path&quot;: &quot;root:@(localhost:3306)/deputy?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;,
  },
  &quot;chain_config&quot;: {
    &quot;bnb_start_height&quot;: 42516056,

    &quot;other_chain&quot;: &quot;ETH&quot;,
    &quot;other_chain_start_height&quot;: 6495598
  },
  &quot;admin_config&quot;: {
    &quot;listen_addr&quot;: &quot;127.0.0.1:8080&quot;
  },
  &quot;bnb_config&quot;: {
    &quot;key_type&quot;: &quot;mnemonic&quot;,
    &quot;mnemonic&quot;: &quot;&lt;my-mnemonic&gt;&quot;,
    &quot;rpc_addr&quot;: &quot;tcp://data-seed-pre-0-s1.binance.org:80&quot;,
    &quot;symbol&quot;: &quot;BNB&quot;,
    &quot;deputy_addr&quot;: &quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce&quot;,
    &quot;fetch_interval&quot;: 2,
  },
  &quot;eth_config&quot;: {
    &quot;swap_type&quot;: &quot;erc20_swap&quot;,
    &quot;key_type&quot;: &quot;private_key&quot;,
    &quot;private_key&quot;: &quot;&lt;my-private-key&gt;&quot;,
    &quot;provider&quot;: &quot;https://ropsten.infura.io/v3/cd9643b1870b489b93477921cb767882&quot;,
    &quot;swap_contract_addr&quot;: &quot;0xA08E0F38462eCd107adE62Ee3004850f2448f3d6&quot;,
    &quot;token_contract_addr&quot;: &quot;0xDec348688B060fB44144971461b3BAaC8BD1e571&quot;,
    &quot;deputy_addr&quot;: &quot;0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b&quot;,
    &quot;gas_limit&quot;: 300000,
    &quot;gas_price&quot;: 20000000000,
  }
}
</code></pre><p>這樣注意幾個地方</p><ul><li>db_config 填上 mysql url，有設密碼的話一併帶入</li><li>chain_config.bnb_start_height 可以先追到目前的 block height，畢竟我們的 swap tx 都在 deputy 起來之後才會產生，可以跳過啟動時 sync block 的時間。如果是要追過去的 tx，就要調整 block 的高度，並且給予足夠的時間上 deputy 去 sync block。可以到 <a href=https://testnet-explorer.binance.org/>testnet-explorer</a> 查目前的 block height。</li><li>chain_config.other_chain_start_height 也追到最新的 eth block height，可以到 <a href=https://ropsten.etherscan.io/>Etherscan</a> 查目前的 block height</li><li>bnb_config 填上 bnb addr 與助記祠</li><li>eth_config 填上 eth addr 與 private key</li><li>eth_config.deupty_addr 使用 Admin addr，並填上 private key</li></ul><p>把 deputy 以 testnet 為目標執行起來</p><pre><code class=language-bash>./build/deputy --help

./build/deputy \
  --bnb-network 0 \
  --config-type local \
  --config-path config/config.json

2019-10-25 17:16:48 DEBUG Debug sent a request
2019-10-25 17:16:48 INFO fetch ETH cur height: 6641795
2019-10-25 17:16:48 DEBUG Debug sent a request
2019-10-25 17:16:48 DEBUG Debug sent a request
2019-10-25 17:16:48 INFO fetch BNB cur height: 46215517
2019-10-25 17:16:48 DEBUG Debug sent a request
2019-10-25 17:16:48 INFO fetch try to get ahead block, chain=BNB, height=46215518
</code></pre><p>deputy 啟動後，就會依據 db 中的 block 資料，開始一路追 block，發現是相關的 addr 就把 tx 拉下來處理。</p><p>由於我們這邊是新 db，我們又直接跳到最新的 block，應該不會需要太多時間就能追上。</p><p>deputy 有 admin api 可以使用</p><pre><code class=language-bash>curl http://localhost:8080

curl http://localhost:8080/failed_swaps/1
the number of total failed swaps is 0, the offset of query is 0

curl http://localhost:8080/status
</code></pre><pre><code class=language-json>{
    &quot;mode&quot;: &quot;NormalMode&quot;,
    &quot;bnb_chain_height&quot;: 46215719,
    &quot;bnb_sync_height&quot;: 46215718,
    &quot;other_chain_height&quot;: 6641804,
    &quot;other_chain_sync_height&quot;: 6641804,
    &quot;bnb_chain_last_block_fetched_at&quot;: &quot;2019-10-25T17:18:52+08:00&quot;,
    &quot;other_chain_last_block_fetched_at&quot;: &quot;2019-10-25T17:18:40+08:00&quot;,
    &quot;bnb_status&quot;: {
        &quot;balance&quot;: [
            {
                &quot;symbol&quot;: &quot;BNB&quot;,
                &quot;free&quot;: &quot;18.99812504&quot;,
                &quot;locked&quot;: &quot;0.00000000&quot;,
                &quot;frozen&quot;: &quot;0.00000000&quot;
            }
        ]
    },
    &quot;other_chain_status&quot;: {
        &quot;allowance&quot;: &quot;9.8e+13&quot;,
        &quot;erc20_balance&quot;: &quot;9.999999969e+20&quot;,
        &quot;eth_balance&quot;: &quot;6.982922764&quot;
    }
}
</code></pre><p>可以看到 deputy 上設定的 bnb_addr, eth_addr 的狀態</p><ul><li>other_chain_status.allowance: 9.8e+13</li></ul><hr><h1 id=開始-swap>開始 Swap<a hidden class=anchor aria-hidden=true href=#開始-swap>#</a></h1><p>複習一下流程</p><p><img loading=lazy src=https://docs.binance.org/assets/eth2bnc.png></p><ol start=0><li>部署好 swap contract & deputy，啟動 deputy process</li><li>Wallet Address 在 ERC20 Token (PPToken) approve()，給 Swap Contract 一部分 Token</li><li>初始化 Swap Transaction(tx)</li><li>Deputy 監測到 Ethereum 鏈上的 swap tx，向 Binance Chain 發起一個對應的 HTLT tx，等待 Binance 上的 claim tx</li><li>Wallet Address 向 Binance Chain 執行 HTLT claim()</li><li>Deputy 監測到 Binance Chain 上的 claim tx 與 swap complete，代為向 Ethereum claim ERC-20</li></ol><h3 id=erc20-contract-approve>ERC20 contract Approve()<a hidden class=anchor aria-hidden=true href=#erc20-contract-approve>#</a></h3><p>到 ERC20 contract 的頁面，選擇 approve</p><p>spender: swap contract address
value: 10000 PPToken (乘上 10^18)</p><p><a href=https://ropsten.etherscan.io/address/0xdec348688b060fb44144971461b3baac8bd1e571#events>到 etherscan 上查看</a></p><h3 id=call-htlt-function>Call HTLT function<a hidden class=anchor aria-hidden=true href=#call-htlt-function>#</a></h3><p>Go to swap contract，call htlt()</p><p>用 etherscan 送上去，然後就壞掉了，<a href=https://ropsten.etherscan.io/tx/0xbd0c829ad2466fcd6e49a12bbac1849827fb9e7a251271816401ed4c9bfe2fa8>Etherscan 上壞掉的 tx</a> 不知為什麼 QAQ</p><p><figure><img loading=lazy src=bep3-atomic-swap-failure-01.jpg width=70% height=70%></figure><figure><img loading=lazy src=bep3-atomic-swap-failure-02.jpg width=70% height=70%></figure></p><p>開 remix IDE，重新嘗試參數</p><ul><li>randomNumberHash:<ul><li>SHA256(randomNumber||timestamp), randomNumber is 32-length random byte array.</li><li>0x0000000000000000000000000000000000000000000000000000000000000000</li></ul></li><li>timestamp:<ul><li>it should be about 10 mins span around current timestamp. <a href=https://www.unixtimestamp.com/>unix timestamp</a></li><li>1572250902 (now + 60 sec * 10 min)</li></ul></li><li>heightSpan:<ul><li>it&rsquo;s a customized filed for deputy operator. it should be more than 200 for this deputy.</li><li>10000</li></ul></li><li>recipientAddr:<ul><li>deputy address on Ethereum.</li><li>0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b</li></ul></li><li>bep2SenderAddr:<ul><li>omit this field with 0x0</li><li>0x0000000000000000000000000000000000000000</li></ul></li><li>bep2RecipientAddr:<ul><li>Decode your testnet address from bech32 encoded to hex</li><li>0xee82ca237387495e9603f4d8d7efed128bdd59a6</li></ul></li><li>outAmount:<ul><li>approved amount, should be bumped by e^10.</li><li>10 0000000000</li></ul></li><li>bep2Amount:<ul><li>outAmount * exchange rate, the default rate is 1.</li><li>10 0000000000</li></ul></li></ul><h3 id=deputy-call-htlt-on-binance-chain>Deputy Call HTLT on Binance Chain<a hidden class=anchor aria-hidden=true href=#deputy-call-htlt-on-binance-chain>#</a></h3><p>Deputy 監測 Ethereum 上的 block 狀態，特別是會取得 Swap contract address 的 swap tx，並在 Binance Chain 上產生對應的 HTLT。</p><h3 id=claim-htlt-on-binance-chain>Claim HTLT on Binance Chain<a hidden class=anchor aria-hidden=true href=#claim-htlt-on-binance-chain>#</a></h3><p>Binance Chain 上產生 HTLT 後，客戶端這邊可以使用 tbnb 以 recipient addr 查詢 Binance Chain 上的 Swap ID</p><pre><code class=language-bash>tbnbcli token query-swapIDs-by-recipient  \
  --recipient-addr tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>獲得過去產生的 swap list</p><pre><code class=language-json>[
  &quot;c2be98ac3b9ee7153e5ba84edfefca1917b6e2ec72d2576bf6cce584cbd6095e&quot;,
  &quot;18c938b994c62bcce9e8cedcb426a603863d95565a246c323a1df89d5c4226c1&quot;,
  &quot;5c4fdd60ce44fa4be6de70e65df3f8295df88178fd381b4242a8c2d047663a1b&quot;,
  &quot;a47c89dfca910cbb34dec92acebebb59d2c62e7f90bf216a87c2c23c84e48d4f&quot;
]
</code></pre><p>都是過去使用的 swap id，如果都沒有新的 swap 出來，可能是 height span 太高，導致一直都爬不到</p><pre><code>SWAP_ID=c2be98ac3b9ee7153e5ba84edfefca1917b6e2ec72d2576bf6cce584cbd6095e
tbnbcli token query-swap \
  --swap-id ${SWAP_ID} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>這邊要對一下 random number, to wallet addr, out amount 等參數，如果 HTLT 符合，客戶就可以執行 Claim HTLT</p><pre><code>tbnbcli token claim \
  --swap-id ${SWAP_ID} \
  --random-number ${RANDOM_NUMBER} \
  --from ${FROM_KEY} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><h3 id=deputy-claim-erc20-token>Deputy Claim ERC20 Token<a hidden class=anchor aria-hidden=true href=#deputy-claim-erc20-token>#</a></h3><p>客戶端在 Binance Chain 上 Claim HTLT，Deputy 在 Ethereuem 上 Claim HTLT，至此完成 Atomic Swap 兩邊的流程。客戶端從 Binance Chain Claim，Deputy 從 Ethereuem 上 Claim。完整流程
如下：</p><ul><li>Client Call HTLT on Ethereum -> Deputy Call HTLT on Binance Chain</li><li>Client Check HTLT Status on Binance Chain</li><li>Client Call Claim HTLT on Binance Chain -> Deputy Call Claim HTLT on Ethereum</li></ul><h3 id=client-app-javascript-demo>Client APP javascript Demo<a hidden class=anchor aria-hidden=true href=#client-app-javascript-demo>#</a></h3><p><a href=https://docs.binance.org/atomic-swap.html#6-demo-for-client-app-swap-erc20-to-bep2>希望直接寫成 javascript app 可以參考這篇</a></p><hr><h1 id=from-binance-chaing-to-ethereum>Swap Tokens from Binance Chain to Ethereum<a hidden class=anchor aria-hidden=true href=#from-binance-chaing-to-ethereum>#</a></h1><p>這邊進行反向操作，客戶發起從 Binance Chain 換到 Ethereum 上的請求，Deputy 做對應的處理，把 Token Swap 到 Ethereum。我們依樣依照<a href=https://docs.binance.org/atomic-swap.html#swap-tokens-from-binance-chain-to-ethereum>這份文件</a>操作。</p><ol><li>客戶端在 Binance Chain 上 Call HTLT()</li><li>Deputy 在 Ethereum 上 Init Swap tx</li><li>Deputy Call Approve() 到 ethereum swap contract</li><li>客戶端取得 swap 資訊</li><li>客戶端在 Ethereum 上 Call Claim()，取得 ERC-20 Token</li><li>Deputy 在 Binance 上 Call Claim()，取得 Binance Chain Token</li></ol><h3 id=在-binance-chain-上-htlt>在 Binance Chain 上 HTLT<a hidden class=anchor aria-hidden=true href=#在-binance-chain-上-htlt>#</a></h3><p>客戶端發起 HTLT 請求，需要從客戶端 Wallet 送出（但因為我們這邊只使用一個 Binance Address，所以發起的 Addr 跟 Deputy Binance addr 是一樣的。</p><p>這邊鎖進 10:BNB，等待 100:PPT 從 ethereum 近來</p><pre><code>DEPUTY_BNB_WALLET_ADDR=tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce
CLIENT_BNB_WALLET_ADDR=${DEPUTY_BNB_WALLET_ADDR}
CLIENT_ETHEREUM_ADDR=0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b

tbnbcli token HTLT \
  --from ${CLIENT_BNB_WALLET_ADDR} \
  --recipient-addr ${DEPUTY_BNB_WALLET_ADDR}  \
  --chain-id Binance-Chain-Nile  \
  --height-span 500 \
  --amount  10:BNB  \
  --expected-income 100:PPT  \
  --recipient-other-chain ${CLIENT_ETHEREUM_ADDR}  \
  --cross-chain \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>HTLT 回復的結果如下，可以在<a href=https://testnet-explorer.binance.org/tx/D653FC7B5D2048A2A165F49426CDCAD733703CF534367133819091892E3A1F14>Binance Testnet Explorer</a></p><pre><code>Random number: 75267ba4cc4f2d9ddbf9f90dc1ea813ae2a4d2114eb2ef2cb7ff0a5d285c7396
Timestamp: 1572337686
Random number hash: dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b
Password to sign with 'tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce':
Committed at block 46889130 (tx hash: D653FC7B5D2048A2A165F49426CDCAD733703CF534367133819091892E3A1F14, response: {Code:0 Data:[119 24 196 176 181 1 29 177 60 107 100 166 55 16 253 136 159 3 204 56 109 46 63 87 93 9 239 158 138 172 21 129] Log:Msg 0: swapID: 7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 Info: GasWanted:0 GasUsed:0 Tags:[{Key:[115 101 110 100 101 114] Value:[116 98 110 98 49 97 54 112 118 53 103 109 110 115 97 121 52 97 57 115 114 55 110 118 100 48 109 108 100 122 50 57 97 54 107 100 120 121 101 51 55 99 101] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[114 101 99 105 112 105 101 110 116] Value:[116 98 110 98 49 119 120 101 112 108 121 119 55 120 56 97 97 104 121 57 51 119 57 54 121 104 119 109 55 120 99 113 51 107 101 52 102 102 97 115 112 51 100] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0} {Key:[97 99 116 105 111 110] Value:[72 84 76 84] XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0}] Codespace: XXX_NoUnkeyedLiteral:{} XXX_unrecognized:[] XXX_sizecache:0})
</code></pre><p>取得 swap id 與 random number，使用 swap ip 查詢</p><pre><code>SWAP_ID=7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581
tbnbcli token query-swap \
  --swap-id ${SWAP_ID} \
  --chain-id Binance-Chain-Nile \
  --trust-node \
  --node http://data-seed-pre-0-s3.binance.org:80
</code></pre><p>回復當前的狀態</p><pre><code class=language-json>{
   &quot;from&quot;:&quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce&quot;,
   &quot;to&quot;:&quot;tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce&quot;,
   &quot;out_amount&quot;:[
      {
         &quot;denom&quot;:&quot;BNB&quot;,
         &quot;amount&quot;:&quot;10&quot;
      }
   ],
   &quot;in_amount&quot;:null,
   &quot;expected_income&quot;:&quot;100:PPT&quot;,
   &quot;recipient_other_chain&quot;:&quot;0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b&quot;,
   &quot;random_number_hash&quot;:&quot;dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b&quot;,
   &quot;random_number&quot;:&quot;&quot;,
   &quot;timestamp&quot;:&quot;1572337686&quot;,
   &quot;cross_chain&quot;:true,
   &quot;expire_height&quot;:&quot;46889630&quot;,
   &quot;index&quot;:&quot;2245&quot;,
   &quot;closed_time&quot;:&quot;0&quot;,
   &quot;status&quot;:&quot;Open&quot;
}
</code></pre><h3 id=deputy-appove-token>Deputy Appove Token<a hidden class=anchor aria-hidden=true href=#deputy-appove-token>#</a></h3><p>Deputy 已經抓到 Binance Chain 上的 tx，會記錄在 Mysql 內</p><pre><code>use deputy;

select * from tx_log limit 10;

| id | chain | swap_id                                                          | tx_type   | tx_hash                                                          | contract_addr | sender_addr                                 | receiver_addr                               | sender_other_chain                         | other_chain_addr                           | in_amount | out_amount | out_coin | random_number_hash                                               | expire_height | timestamp  | random_number | block_hash                                                       | height   | status    | confirmed_num | create_time | update_time |
|  2 | BNB   | 7718c4b0b5011db13c6b64a63710fd889f03cc386d2e3f575d09ef9e8aac1581 | BEP2_HTLT | d653fc7b5d2048a2a165f49426cdcad733703cf534367133819091892e3a1f14 |               | tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce | tbnb1a6pv5gmnsay4a9sr7nvd0mldz29a6kdxye37ce |                                            | 0x938a452d293c23C2CDEae0Bf01760D8ECC4F826b | 100:PPT   | 10         | BNB      | dabd990af86582969d47218012ecdb09899b9ad2b069c05be94ef82bea889a1b |      46889630 | 1572337686 |               | 6948f34e4013da29c9922306b60b2c12f174925c63ff2a46d6b2fc3acd7a3774 | 46889130 | CONFIRMED |             6 |  1572337694 |  1572337695 |
</code></pre><h3 id=deputy-send-htlt-on-ethereum>Deputy Send HTLT on Ethereum<a hidden class=anchor aria-hidden=true href=#deputy-send-htlt-on-ethereum>#</a></h3><p>查詢 Ethereum 上的 HTLT</p><h3 id=客戶端-call-claim-取得-erc-20-token>客戶端 Call Claim 取得 ERC-20 Token<a hidden class=anchor aria-hidden=true href=#客戶端-call-claim-取得-erc-20-token>#</a></h3><p>客戶端取得 100:PPT</p><h3 id=deputy-call-htlt-claim-取得-binance-token>Deputy Call HTLT Claim 取得 Binance Token<a hidden class=anchor aria-hidden=true href=#deputy-call-htlt-claim-取得-binance-token>#</a></h3><p>Deputy 取得 10:BNB</p><hr><h3 id=gce>GCE<a hidden class=anchor aria-hidden=true href=#gce>#</a></h3><pre><code>gcloud compute ssh dep3-deputy

sudo apt-get update
sudo apt-get install mysql-server
sudo cat /etc/mysql/debian.cnf

wget https://dl.google.com/go/go1.13.3.linux-amd64.tar.gz
tar -C /usr/local -xzf go1.13.3.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin

go get github.com/binance-chain/bep3-deputy
go mod tidy
go build  -o build/deputy main.go
</code></pre><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://docs.binance.org/atomic-swap.html>Binace Chain Doc</a></li><li><a href=https://github.com/binance-chain/BEPs/blob/master/BEP3.md>Binance BEP3 spec</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chechia.net/tags/blockchain/>Blockchain</a></li><li><a href=https://chechia.net/tags/bep3/>Bep3</a></li><li><a href=https://chechia.net/tags/binance/>Binance</a></li><li><a href=https://chechia.net/tags/ethereum/>Ethereum</a></li><li><a href=https://chechia.net/tags/erc-20/>Erc-20</a></li></ul><nav class=paginav><a class=prev href=https://chechia.net/posts/2019-11-08-blockchain-atomic-swap/><span class=title>« Prev</span><br><span>Ablockchain Atomic Swap</span>
</a><a class=next href=https://chechia.net/posts/2019-10-15-kubernetes-custom-resource-with-operator-sdk/><span class=title>Next »</span><br><span>Kubernetes Custom Resources with Operator SDK</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on x" href="https://x.com/intent/tweet/?text=Blockchain%20Bep3%20Atomic%20Swap&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f&amp;hashtags=blockchain%2cbep3%2cbinance%2cethereum%2cerc-20"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f&amp;title=Blockchain%20Bep3%20Atomic%20Swap&amp;summary=Blockchain%20Bep3%20Atomic%20Swap&amp;source=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f&title=Blockchain%20Bep3%20Atomic%20Swap"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on whatsapp" href="https://api.whatsapp.com/send?text=Blockchain%20Bep3%20Atomic%20Swap%20-%20https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on telegram" href="https://telegram.me/share/url?text=Blockchain%20Bep3%20Atomic%20Swap&amp;url=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Blockchain Bep3 Atomic Swap on ycombinator" href="https://news.ycombinator.com/submitlink?t=Blockchain%20Bep3%20Atomic%20Swap&u=https%3a%2f%2fchechia.net%2fposts%2f2019-10-22-blockchain-bep3-atomic-swap%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chechia.net/>Che-Chia Chang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>