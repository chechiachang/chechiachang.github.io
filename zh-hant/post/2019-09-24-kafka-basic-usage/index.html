<!DOCTYPE html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: 2024年7月1日 --><html lang="zh-Hant" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Hugo Blox Builder 5.9.7" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.f6689966c0a10712f95f034011917db0.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  






<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYR8JCDGM9"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'G-QYR8JCDGM9', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>




<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NSBJFRS');
</script>





















  
  
  






  <meta name="author" content="張哲嘉" />





  

<meta name="description" content="2020 It邦幫忙鐵人賽 系列文章
ELK Stack Self-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka 基本使用 kafka operation scripts 集群內部的 HA topology 集群內部的 HA 細節 Prometheus Metrics Exporter 很重要 效能調校 由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。" />



  <link rel="alternate" hreflang="en" href="https://chechia.net/en/post/2019-09-24-kafka-basic-usage/" />

<link rel="alternate" hreflang="zh-Hant" href="https://chechia.net/zh-hant/post/2019-09-24-kafka-basic-usage/" />
<link rel="canonical" href="https://chechia.net/zh-hant/post/2019-09-24-kafka-basic-usage/" />



  <link rel="manifest" href="/zh-hant/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png" />

<meta name="theme-color" content="#1565c0" />










  
  






<meta property="twitter:card" content="summary" />

  <meta property="twitter:site" content="@chechiachang" />
  <meta property="twitter:creator" content="@chechiachang" />
<meta property="twitter:image" content="https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" />



  

<meta property="og:type" content="article" />
<meta property="og:site_name" content="Che-Chia Chang" />
<meta property="og:url" content="https://chechia.net/zh-hant/post/2019-09-24-kafka-basic-usage/" />
<meta property="og:title" content="Kafka-basic-usage | Che-Chia Chang" />
<meta property="og:description" content="2020 It邦幫忙鐵人賽 系列文章
ELK Stack Self-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka 基本使用 kafka operation scripts 集群內部的 HA topology 集群內部的 HA 細節 Prometheus Metrics Exporter 很重要 效能調校 由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。" /><meta property="og:image" content="https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="zh-Hant" />

  
    <meta
      property="article:published_time"
      content="2019-09-24T21:59:49&#43;08:00"
    />
  
  
    <meta property="article:modified_time" content="2023-09-11T22:33:54&#43;08:00">
  






    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chechia.net/zh-hant/post/2019-09-24-kafka-basic-usage/"
  },
  "headline": "Kafka-basic-usage",
  
  "datePublished": "2019-09-24T21:59:49+08:00",
  "dateModified": "2023-09-11T22:33:54+08:00",
  
  "author": {
    "@type": "Person",
    "name": "張哲嘉"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "chechia-net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chechia.net/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "2020 It邦幫忙鐵人賽 系列文章\nELK Stack Self-host ELK stack on GCP Secure ELK Stask 監測 Google Compute Engine 上服務的各項數據 監測 Google Kubernetes Engine 的各項數據 是否選擇 ELK 作為解決方案 使用 logstash pipeline 做數據前處理 Elasticsearch 日常維護：數據清理，效能調校，永久儲存 Debug ELK stack on GCP Kafka HA on Kubernetes(6) Deploy kafka-ha Kafka Introduction kafka 基本使用 kafka operation scripts 集群內部的 HA topology 集群內部的 HA 細節 Prometheus Metrics Exporter 很重要 效能調校 由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。"
}
</script>

  

  




  
  
  

  
  

  


  
  <title>Kafka-basic-usage | Che-Chia Chang</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="51c2041a8a32cbc46e22519634c523f9" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.9e4214442a7711d35691acd58f6f6361.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>搜尋</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="關閉"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜尋..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜尋...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header header--fixed">
  
  
  
  
  












<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/zh-hant/">Che-Chia Chang</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切換導航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/zh-hant/">Che-Chia Chang</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#talks"><span>演講</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#posts"><span>發文</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/zh-hant/#projects"><span>專案</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://www.instagram.com/c.c.leather/" target="_blank" rel="noopener"><span>皮件</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://www.instagram.com/dive.with.cat.coach/" target="_blank" rel="noopener"><span>水肺</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://mvp.microsoft.com/zh-TW/mvp/profile/e407d0b9-5c01-eb11-a815-000d3a8ccaf5" target="_blank" rel="noopener"><span>微軟MVP</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/chechiachang" data-toggle="tooltip" data-placement="bottom" title="查看我的Github" target="_blank" rel="noopener" aria-label="查看我的Github">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.facebook.com/engineer.from.scratch" data-toggle="tooltip" data-placement="bottom" title="追蹤我的Facebook粉絲專頁" target="_blank" rel="noopener" aria-label="追蹤我的Facebook粉絲專頁">
                <i class="fab fa-facebook" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="搜尋"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="顯示選項">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>明亮</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>暗黑</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>自動</span>
            </a>
          </div>
        </li>
        

        
        
        <li class="nav-item dropdown i18n-dropdown">
          <a href="#" class="nav-link " data-toggle="dropdown"
             aria-haspopup="true" aria-label="語言">
            <i class="fas fa-globe mr-1" aria-hidden="true"></i></a>
          <div class="dropdown-menu">
            <div class="dropdown-item dropdown-item-active">
              <span>中文 (繁體)</span>
            </div>
            
            <a class="dropdown-item" href="https://chechia.net/en/post/2019-09-24-kafka-basic-usage/">
              <span>English</span>
            </a>
            
          </div>
        </li>
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  













  

  
  
  
<div class="article-container pt-3">
  <h1>Kafka-basic-usage</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
          最近更新於
      
    
    9月 11, 2023
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 閱讀時間（分鐘）
  </span>
  

  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/zh-hant/category/kubernetes/">kubernetes</a>, <a href="/zh-hant/category/kafka/">kafka</a></span>
  

</div>

    





  
</div>



  <div class="article-container">

    <div class="article-style">
      <p><a href="https://ithelp.ithome.com.tw/2020ironman" target="_blank" rel="noopener">2020 It邦幫忙鐵人賽</a> 系列文章</p>
<ul>
<li>ELK Stack
<ul>
<li><a href="https://chechia.net/zh-hant/post/2019-09-15-self-host-elk-stack-on-gcp/">Self-host ELK stack on GCP</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-15-secure-elk-stack/">Secure ELK Stask</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-18-monitoring-gce-with-elk/">監測 Google Compute Engine 上服務的各項數據</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-19-monitoring-gke-with-elk/">監測 Google Kubernetes Engine 的各項數據</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-18-elastic-or-not-elastic/">是否選擇 ELK 作為解決方案</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-21-logstash-on-gke/">使用 logstash pipeline 做數據前處理</a></li>
<li>Elasticsearch 日常維護：數據清理，效能調校，永久儲存</li>
<li>Debug ELK stack on GCP</li>
</ul>
</li>
<li>Kafka HA on Kubernetes(6)
<ul>
<li><a href="https://chechia.net/zh-hant/post/2019-09-22-kafka-deployment-on-kubernetes/">Deploy kafka-ha</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-23-kafka-introduction/">Kafka Introduction</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-24-kafka-basic-usage/">kafka 基本使用</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-25-kafka-operation-scripts/">kafka operation scripts</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-25-kafka-ha-topology/">集群內部的 HA topology</a></li>
<li><a href="https://chechia.net/zh-hant/post/2019-09-26-kafka-ha-continued/">集群內部的 HA 細節</a></li>
<li>Prometheus Metrics Exporter 很重要</li>
<li>效能調校</li>
</ul>
</li>
</ul>
<p>由於我比較熟悉 GCP / GKE 的服務，這篇的操作過程都會以 GCP 平台作為範例，不過操作過程大體上是跨平台通用的。</p>
<p>寫文章真的是體力活，覺得我的文章還有參考價值，請左邊幫我點讚按個喜歡，右上角幫我按個追縱，底下歡迎留言討論。給我一點繼續走下去的動力。</p>
<p>對我的文章有興趣，歡迎到我的網站上 <a href="https://chechia.net" target="_blank" rel="noopener">https://chechia.net</a> 閱讀其他技術文章，有任何謬誤也請各方大德直接聯繫我，感激不盡。</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="https://d32l83enj9u8rg.cloudfront.net/wp-content/uploads/iStock-966846550-cat-overheating-simonkr-1-940x470.jpg" alt="Exausted Cat Face" loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<hr>
<h1 id="摘要">摘要</h1>
<ul>
<li>在 Kubernetes 中連線 kafka</li>
<li>使用 golang library 連線到 Kafka</li>
<li>透過 kafka script 操作 kafka</li>
</ul>
<h1 id="kubernetes-中連線-kafka">kubernetes 中連線 kafka</h1>
<p>先看一看 kafka pods</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">selector</span><span class="o">=</span><span class="s1">&#39;app=kafka&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NAME</span>        <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">1</span>          <span class="mi">26</span><span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">d</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">l</span> <span class="s1">&#39;app=zookeeper&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NAME</span>                  <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">zookeeper</span><span class="o">-</span><span class="mi">0</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">zookeeper</span><span class="o">-</span><span class="mi">1</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">zookeeper</span><span class="o">-</span><span class="mi">2</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">d</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">l</span> <span class="s1">&#39;app=kafka-exporter&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NAME</span>                               <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
</span></span><span class="line"><span class="cl"><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">exporter</span><span class="o">-</span><span class="mi">88786</span><span class="n">d84b</span><span class="o">-</span><span class="n">z954z</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">5</span>          <span class="mi">26</span><span class="n">d</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pods</span> <span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span>           <span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Namespace</span><span class="p">:</span>      <span class="n">default</span>
</span></span><span class="line"><span class="cl"><span class="n">Priority</span><span class="p">:</span>       <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="ne">Node</span><span class="p">:</span>           <span class="n">gke</span><span class="o">-</span><span class="n">chechiachang</span><span class="o">-</span><span class="n">pool</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">e4622744</span><span class="o">-</span><span class="n">wcq0</span><span class="o">/</span><span class="mf">10.140</span><span class="o">.</span><span class="mf">15.212</span>
</span></span><span class="line"><span class="cl"><span class="n">Labels</span><span class="p">:</span>         <span class="n">app</span><span class="o">=</span><span class="n">kafka</span>
</span></span><span class="line"><span class="cl">                <span class="n">controller</span><span class="o">-</span><span class="n">revision</span><span class="o">-</span><span class="nb">hash</span><span class="o">=</span><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">69986</span><span class="n">d7477</span>
</span></span><span class="line"><span class="cl">                <span class="n">release</span><span class="o">=</span><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">statefulset</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pod</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Annotations</span><span class="p">:</span>    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">limit</span><span class="o">-</span><span class="n">ranger</span><span class="p">:</span> <span class="n">LimitRanger</span> <span class="n">plugin</span> <span class="n">set</span><span class="p">:</span> <span class="n">cpu</span> <span class="n">request</span> <span class="k">for</span> <span class="n">container</span> <span class="n">kafka</span><span class="o">-</span><span class="n">broker</span>
</span></span><span class="line"><span class="cl"><span class="n">Status</span><span class="p">:</span>         <span class="n">Running</span>
</span></span><span class="line"><span class="cl"><span class="ne">IP</span><span class="p">:</span>             <span class="mf">10.12</span><span class="o">.</span><span class="mf">6.178</span>
</span></span><span class="line"><span class="cl"><span class="n">Controlled</span> <span class="n">By</span><span class="p">:</span>  <span class="n">StatefulSet</span><span class="o">/</span><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Containers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">kafka</span><span class="o">-</span><span class="n">broker</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="ne">Image</span><span class="p">:</span>         <span class="n">confluentinc</span><span class="o">/</span><span class="n">cp</span><span class="o">-</span><span class="n">kafka</span><span class="p">:</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Port</span><span class="p">:</span>          <span class="mi">9092</span><span class="o">/</span><span class="n">TCP</span>
</span></span><span class="line"><span class="cl">    <span class="n">Host</span> <span class="n">Port</span><span class="p">:</span>     <span class="mi">0</span><span class="o">/</span><span class="n">TCP</span>
</span></span><span class="line"><span class="cl">    <span class="n">Command</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">sh</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span><span class="n">exc</span>
</span></span><span class="line"><span class="cl">      <span class="n">unset</span> <span class="n">KAFKA_PORT</span> <span class="o">&amp;&amp;</span> \
</span></span><span class="line"><span class="cl">      <span class="k">export</span> <span class="n">KAFKA_BROKER_ID</span><span class="o">=$</span><span class="p">{</span><span class="n">POD_NAME</span><span class="c1">##*-} &amp;&amp; \</span>
</span></span><span class="line"><span class="cl">      <span class="k">export</span> <span class="n">KAFKA_ADVERTISED_LISTENERS</span><span class="o">=</span><span class="n">PLAINTEXT</span><span class="p">:</span><span class="o">//$</span><span class="p">{</span><span class="n">POD_IP</span><span class="p">}:</span><span class="mi">9092</span> <span class="o">&amp;&amp;</span> \
</span></span><span class="line"><span class="cl">      <span class="n">exec</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">confluent</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">run</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Requests</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">cpu</span><span class="p">:</span>      <span class="mi">100</span><span class="n">m</span>
</span></span><span class="line"><span class="cl">    <span class="n">Liveness</span><span class="p">:</span>   <span class="n">exec</span> <span class="p">[</span><span class="n">sh</span> <span class="o">-</span><span class="n">ec</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">jps</span> <span class="o">|</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">grep</span> <span class="o">-</span><span class="n">q</span> <span class="n">SupportedKafka</span><span class="p">]</span> <span class="n">delay</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span> <span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="n">s</span> <span class="c1">#success=1 #failure=3</span>
</span></span><span class="line"><span class="cl">    <span class="n">Readiness</span><span class="p">:</span>  <span class="n">tcp</span><span class="o">-</span><span class="n">socket</span> <span class="p">:</span><span class="n">kafka</span> <span class="n">delay</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span> <span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="n">s</span> <span class="c1">#success=1 #failure=3</span>
</span></span><span class="line"><span class="cl">    <span class="ne">Environment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">POD_IP</span><span class="p">:</span>                                   <span class="p">(</span><span class="n">v1</span><span class="p">:</span><span class="n">status</span><span class="o">.</span><span class="n">podIP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">POD_NAME</span><span class="p">:</span>                                <span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span> <span class="p">(</span><span class="n">v1</span><span class="p">:</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">POD_NAMESPACE</span><span class="p">:</span>                           <span class="n">default</span> <span class="p">(</span><span class="n">v1</span><span class="p">:</span><span class="n">metadata</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_HEAP_OPTS</span><span class="p">:</span>                         <span class="o">-</span><span class="n">Xmx4G</span> <span class="o">-</span><span class="n">Xms1G</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_ZOOKEEPER_CONNECT</span><span class="p">:</span>                 <span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">zookeeper</span><span class="p">:</span><span class="mi">2181</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_LOG_DIRS</span><span class="p">:</span>                          <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">kafka</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">logs</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_CONFLUENT_SUPPORT_METRICS_ENABLE</span><span class="p">:</span>  <span class="bp">false</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_DEFAULT_REPLICATION_FACTOR</span><span class="p">:</span>        <span class="mi">3</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_MESSAGE_MAX_BYTES</span><span class="p">:</span>                 <span class="mi">16000000</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class="p">:</span>  <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="n">KAFKA_JMX_PORT</span><span class="p">:</span>                          <span class="mi">5555</span>
</span></span><span class="line"><span class="cl">    <span class="n">Mounts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">kafka</span><span class="o">/</span><span class="n">data</span> <span class="n">from</span> <span class="n">datadir</span> <span class="p">(</span><span class="n">rw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span> <span class="n">from</span> <span class="n">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="mi">2</span><span class="n">tm8c</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Conditions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">Volumes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">datadir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Type</span><span class="p">:</span>       <span class="n">PersistentVolumeClaim</span> <span class="p">(</span><span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">a</span> <span class="n">PersistentVolumeClaim</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ClaimName</span><span class="p">:</span>  <span class="n">datadir</span><span class="o">-</span><span class="n">kafka</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">ReadOnly</span><span class="p">:</span>   <span class="bp">false</span>
</span></span><span class="line"><span class="cl">  <span class="n">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="mi">2</span><span class="n">tm8c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Type</span><span class="p">:</span>        <span class="n">Secret</span> <span class="p">(</span><span class="n">a</span> <span class="n">volume</span> <span class="n">populated</span> <span class="n">by</span> <span class="n">a</span> <span class="n">Secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecretName</span><span class="p">:</span>  <span class="n">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="mi">2</span><span class="n">tm8c</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="p">:</span>    <span class="bp">false</span>
</span></span></code></pre></div><p>講幾個重點：</p>
<ul>
<li>這邊跑起來的是 kafka-broker，接收 producer 與 consumer 來的 request</li>
<li>這邊用的是 statefulsets，不是完全無狀態的 kafka broker，而把 message 記在 datadir 上，降低故障重啟時可能遺失資料的風險。</li>
<li>啟動時，把 kubernetes 指定的 pod name 塞進環境變數，然後作為當前 broker 的 ID</li>
<li>沒有設定 Pod antiAffinity，所以有可能會啟三個 kafka 結果三個跑在同一台 node 上，這樣 node 故障就全死，沒有HA</li>
</ul>
<h3 id="service--endpoints">Service &amp; Endpoints</h3>
<p>看一下 service 與 endpoints
zookeeper 與 exporter 我們這邊先掠過不談，到專章講高可用性與服務監測時，再來討論。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get service -l &#39;app=kafka&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
</span></span><span class="line"><span class="cl">kafka-1            ClusterIP   10.15.242.178   &lt;none&gt;        9092/TCP   26d
</span></span><span class="line"><span class="cl">kafka-1-headless   ClusterIP   None            &lt;none&gt;        9092/TCP   26d
</span></span></code></pre></div><p>兩個 services</p>
<ul>
<li>一個是 cluster-ip service，有 single cluster IP 與 load-balance，DNS 會過 kube-proxy。</li>
<li>一個是 headless service，DNS 沒有過 kube-proxy，而是由 endpoint controller 直接 address record，指向把符合 service selector 的 pod。適合做 service discovery，不會依賴於 kubernetes 的實現。</li>
</ul>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" target="_blank" rel="noopener">詳細說明在官方文件</a></p>
<p>簡單來說，kafka broker 會做 auto service discovery，我們可以使用 headless service。</p>
<p>客戶端(consumer &amp; producer) 連入時，則使用 cluster-ip service，做 load balancing。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl get endpoints -l &#39;app=kafka&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                            ENDPOINTS                                                          AGE
</span></span><span class="line"><span class="cl">kafka-1                         10.12.1.14:9092,10.12.5.133:9092,10.12.6.178:9092                  26d
</span></span><span class="line"><span class="cl">kafka-1-headless                10.12.1.14:9092,10.12.5.133:9092,10.12.6.178:9092                  26d
</span></span></code></pre></div><h1 id="golang-example">Golang Example</h1>
<p>附上簡單的 Golang 客戶端，<a href="https://github.com/chechiachang/kafka-on-kubernetes" target="_blank" rel="noopener">完整 Github Repository 在這邊</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/segmentio/kafka-go&#34;</span> <span class="c1">// 使用的套件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">topic</span> <span class="o">:=</span> <span class="s">&#34;ticker&#34;</span> <span class="c1">// 指定 message 要使用的 topic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">partition</span> <span class="o">:=</span> <span class="mi">0</span> <span class="c1">// 指定 partition，由於底下連線指定連線到 partition 的 leader，所以需要指定 partition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kafkaURL</span> <span class="o">:=</span> <span class="s">&#34;kafka-0:9092&#34;</span> <span class="c1">// 指定 kafkaURL，也可以透過 os.GetEnv() 從環境變數裡拿到。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// producer 對指定 topic, partition 的 leader 產生連線
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">producerConn</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">kafka</span><span class="p">.</span><span class="nf">DialLeader</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">kafkaURL</span><span class="p">,</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">partition</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 程式結束最後把 connection 關掉。不關會造成 broker 累積大量 connection，需要等待 broker 端 timeout 才會釋放。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">defer</span> <span class="nx">producerConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//producerConn.SetWriteDeadline(time.Now().Add(10 * time.Second))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 使用 go routine 跑一個 subprocess for loop，一直產生 message 到 kafka topic，這邊的範例是每秒推一個秒數。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">producerConn</span><span class="p">.</span><span class="nf">WriteMessages</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="nx">kafka</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Second</span><span class="p">())),</span>
</span></span><span class="line"><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// make a new reader that consumes from topic-A, partition 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">kafka</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">ReaderConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Brokers</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">kafkaURL</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Topic</span><span class="p">:</span>     <span class="nx">topic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Partition</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MinBytes</span><span class="p">:</span>  <span class="mf">10e2</span><span class="p">,</span> <span class="c1">// 1KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">MaxBytes</span><span class="p">:</span>  <span class="mf">10e3</span><span class="p">,</span> <span class="c1">// 10KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//r.SetOffset(42)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 印出 reader 收到的 message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">ReadMessage</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v message at offset %d: %s = %s\n&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Offset</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Key</span><span class="p">),</span> <span class="nb">string</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>這邊可以使用 Dockerfile 包成一個 container image，然後丟上 kubernetes</p>
<p>我稍晚補一下 docker image 跟 deployment 方便大家操作好了。</p>
<p>或是攋人測試，直接 kubectl run 一個 golang base image 讓它 sleep，然後在連進去</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl run DEPLOYMENT_NAME --image=golang:1.13.0-alpine3.10 sleep 3600
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl exec -it POD_NAME sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 裡面沒有 Git 跟 vim 裝一下
</span></span><span class="line"><span class="cl">apk add git vim
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">go get github.com/chechiachang/kafka-on-kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cd src/github.com/chechiachang/kafka-on-kubernetes/
</span></span><span class="line"><span class="cl">vim main.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">go build .
</span></span><span class="line"><span class="cl">./kafka-on-kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2019-09-24 14:20:46.872554693 +0000 UTC m=+9.154112787 message at offset 1:  = 46
</span></span><span class="line"><span class="cl">2019-09-24 14:20:47.872563087 +0000 UTC m=+9.154121166 message at offset 2:  = 47
</span></span><span class="line"><span class="cl">2019-09-24 14:20:48.872568848 +0000 UTC m=+9.154126926 message at offset 3:  = 48
</span></span><span class="line"><span class="cl">2019-09-24 14:20:49.872574499 +0000 UTC m=+9.154132576 message at offset 4:  = 49
</span></span><span class="line"><span class="cl">2019-09-24 14:20:50.872579957 +0000 UTC m=+9.154138032 message at offset 5:  = 50
</span></span><span class="line"><span class="cl">2019-09-24 14:20:51.872588823 +0000 UTC m=+9.154146892 message at offset 6:  = 51
</span></span><span class="line"><span class="cl">2019-09-24 14:20:52.872594672 +0000 UTC m=+9.154152748 message at offset 7:  = 52
</span></span><span class="line"><span class="cl">2019-09-24 14:20:53.872599986 +0000 UTC m=+9.154158060 message at offset 8:  = 53
</span></span></code></pre></div><p>這樣就連上了，完成一個最簡單的使用範例。</p>
<p>這個例子太過簡單，上一篇講的 consumer group, partitions, offset 什麼設定全都沒用上。實務上這些都需要好好思考，並且依據需求做調整設定。</p>
<h3 id="clean-up">Clean up</h3>
<p>把測試用的 deployment 幹掉</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl delete deployment DEPLOYMENT_NAME
</span></span></code></pre></div><h1 id="小結">小結</h1>
<ul>
<li>簡述 kafka 在 kubernetes 上運行的狀況，連線方法</li>
<li>Demo 一個小程式</li>
</ul>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/zh-hant/tag/%E9%90%B5%E4%BA%BA%E8%B3%BD2019/">鐵人賽2019</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/kafka/">kafka</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/kubernetes/">kubernetes</a>
  
  <a class="badge badge-light" href="/zh-hant/tag/ithome/">ithome</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-24-kafka-basic-usage%2F&amp;text=Kafka-basic-usage" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-24-kafka-basic-usage%2F&amp;t=Kafka-basic-usage" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=Kafka-basic-usage&amp;body=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-24-kafka-basic-usage%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-24-kafka-basic-usage%2F&amp;title=Kafka-basic-usage" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=Kafka-basic-usage%20https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-24-kafka-basic-usage%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fchechia.net%2Fzh-hant%2Fpost%2F2019-09-24-kafka-basic-usage%2F&amp;title=Kafka-basic-usage" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      <a href="https://chechia.net/"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/e56eaaf62e2112055827c197b938d620?s=200" alt="張哲嘉"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://chechia.net/">張哲嘉</a></h5>
      <h6 class="card-subtitle">Site Reliability Engineer</h6>
      <p class="card-text">我的研究領域包括網站可靠性工程、DevOps、Container和Kubernetes。</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/zh-hant/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/chechiachang" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/chechiachang" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.facebook.com/engineer.from.scratch" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/che-chia-chang-92194a4a/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2024 Me. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      由<a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a>支持發布——免費<a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">開源</a>網站，為創作者賦能。
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.938a3a7554cd9f6602290411f64d2617.js"></script>




  

  
  

  













  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  

















<script id="page-data" type="application/json">{"use_headroom":true}</script>


  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>









  
  


<script src="/zh-hant/js/wowchemy.min.c1296fcfda1f6e2549c8cd4fe453ac58.js"></script>







  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">引用</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> 複製
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> 下載
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.9137013a66774049159934c29c3f0205.js" type="module"></script>


















</body>
</html>
